const resolveScoreModeOverride = (value) => {
  if (value == null) return null;
  const mode = String(value).trim();
  if (!mode) return null;
  if (mode === 'sparse' || mode === 'dense' || mode === 'hybrid') return mode;
  throw new Error(`Invalid score mode "${mode}". Use sparse|dense|hybrid.`);
};

export const resolveRunConfig = ({ normalized, scoreModeOverride }) => {
  const {
    query,
    searchType,
    searchAuthor,
    searchImport,
    chunkAuthorFilter,
    searchMode,
    runCode,
    runProse,
    runRecords,
    runExtractedProse,
    commentsEnabled,
    embeddingProvider,
    embeddingOnnx,
    hnswConfig,
    sqliteAutoChunkThreshold,
    sqliteAutoArtifactBytes,
    postingsConfig,
    filePrefilterEnabled,
    searchRegexConfig,
    fileChargramN,
    vectorExtension,
    annBackend,
    bm25K1,
    bm25B,
    branchesMin,
    loopsMin,
    breaksMin,
    continuesMin,
    churnMin,
    modifiedAfter,
    modifiedSinceDays,
    fileFilter,
    caseFile,
    caseTokens,
    branchFilter,
    extFilter,
    langFilter,
    extImpossible,
    langImpossible,
    metaFilters,
    annEnabled: annEnabledRaw,
    annFlagPresent,
    allowSparseFallback,
    allowUnsafeMix,
    scoreBlendEnabled: scoreBlendEnabledRaw,
    scoreBlendSparseWeight: scoreBlendSparseWeightRaw,
    scoreBlendAnnWeight: scoreBlendAnnWeightRaw,
    symbolBoostEnabled,
    symbolBoostDefinitionWeight,
    symbolBoostExportWeight,
    relationBoostEnabled,
    relationBoostPerCall,
    relationBoostPerUse,
    relationBoostMaxBoost,
    annCandidateCap,
    annCandidateMinDocCount,
    annCandidateMaxDocCount,
    minhashMaxDocs,
    maxCandidates,
    storageTier,
    queryCacheEnabled,
    queryCacheMaxEntries,
    queryCacheTtlMs,
    queryCacheStrategy,
    queryCachePrewarm,
    queryCachePrewarmMaxEntries,
    queryCacheMemoryFreshMs,
    rrfEnabled: rrfEnabledRaw,
    rrfK,
    graphRankingConfig,
    contextExpansionEnabled,
    contextExpansionOptions,
    contextExpansionRespectFilters,
    sqliteFtsNormalize,
    sqliteFtsProfile,
    sqliteFtsWeights,
    sqliteFtsTrigram,
    sqliteFtsStemming,
    sqliteTailLatencyTuning,
    sqliteFtsOverfetch,
    preferMemoryBackendOnCacheHit,
    sqliteReadPragmas,
    fieldWeightsConfig,
    explain,
    denseVectorMode,
    strict,
    backendArg,
    lancedbConfig,
    tantivyConfig,
    sparseBackend
  } = normalized;

  const scoreMode = resolveScoreModeOverride(scoreModeOverride);
  const annEnabled = scoreMode ? scoreMode !== 'sparse' : annEnabledRaw;
  const scoreBlendEnabled = scoreMode ? scoreMode !== 'sparse' : scoreBlendEnabledRaw;
  const scoreBlendSparseWeight = scoreMode === 'dense'
    ? 0
    : scoreMode === 'hybrid'
      ? 0.5
      : scoreBlendSparseWeightRaw;
  const scoreBlendAnnWeight = scoreMode === 'dense'
    ? 1
    : scoreMode === 'hybrid'
      ? 0.5
      : scoreBlendAnnWeightRaw;
  const rrfEnabled = scoreMode ? false : rrfEnabledRaw;

  return {
    query,
    searchType,
    searchAuthor,
    searchImport,
    chunkAuthorFilter,
    searchMode,
    runCode,
    runProse,
    runRecords,
    runExtractedProse,
    commentsEnabled,
    embeddingProvider,
    embeddingOnnx,
    hnswConfig,
    sqliteAutoChunkThreshold,
    sqliteAutoArtifactBytes,
    postingsConfig,
    filePrefilterEnabled,
    searchRegexConfig,
    fileChargramN,
    vectorExtension,
    annBackend,
    bm25K1,
    bm25B,
    branchesMin,
    loopsMin,
    breaksMin,
    continuesMin,
    churnMin,
    modifiedAfter,
    modifiedSinceDays,
    fileFilter,
    caseFile,
    caseTokens,
    branchFilter,
    extFilter,
    langFilter,
    extImpossible,
    langImpossible,
    metaFilters,
    annEnabled,
    annFlagPresent,
    allowSparseFallback,
    allowUnsafeMix,
    scoreBlendEnabled,
    scoreBlendSparseWeight,
    scoreBlendAnnWeight,
    symbolBoostEnabled,
    symbolBoostDefinitionWeight,
    symbolBoostExportWeight,
    relationBoostEnabled,
    relationBoostPerCall,
    relationBoostPerUse,
    relationBoostMaxBoost,
    annCandidateCap,
    annCandidateMinDocCount,
    annCandidateMaxDocCount,
    minhashMaxDocs,
    maxCandidates,
    storageTier,
    queryCacheEnabled,
    queryCacheMaxEntries,
    queryCacheTtlMs,
    queryCacheStrategy,
    queryCachePrewarm,
    queryCachePrewarmMaxEntries,
    queryCacheMemoryFreshMs,
    rrfEnabled,
    rrfK,
    graphRankingConfig,
    contextExpansionEnabled,
    contextExpansionOptions,
    contextExpansionRespectFilters,
    sqliteFtsNormalize,
    sqliteFtsProfile,
    sqliteFtsWeights,
    sqliteFtsTrigram,
    sqliteFtsStemming,
    sqliteTailLatencyTuning,
    sqliteFtsOverfetch,
    preferMemoryBackendOnCacheHit,
    sqliteReadPragmas,
    fieldWeightsConfig,
    explain,
    denseVectorMode,
    strict,
    backendArg,
    lancedbConfig,
    tantivyConfig,
    sparseBackend,
    scoreMode
  };
};
