# PairOfCleats -- Configuration Hard-Cut Specification (End-State)

**Intent:** Reduce configuration complexity by deleting most knobs, eliminating overlapping control planes (config file vs profiles vs env vs CLI), and automatically deriving operational parameters from **available resources** and **repo characteristics**.

**Non-goals:** Backwards compatibility, deprecation periods, migration tooling, or preserving legacy flags/env vars.

---

## 1) Baseline (current state)

The repository includes a machine-generated inventory:

- `docs/config/inventory.md` (generated by `node tools/config/inventory.js`)
- `docs/config/inventory.json`
- `docs/config/inventory-notes.md`

Current surface area (from `docs/config/inventory.md`):

- **Config keys:** 180  
- **Env vars:** 58  
- **CLI flags:** 252  

Config keys are concentrated in `indexing.*` (**65 keys**) and `search.*` (**15 keys**), and many concepts have multiple overlapping control surfaces (profile vs config vs env vs CLI).

---

## 2) End-state philosophy

### 2.1 Configuration is a contract
If a setting is user-configurable, it is part of the product API. The API must be:

- **Small** (few knobs)
- **Predictable** (no surprising precedence)
- **Safe** (no easy footguns)
- **Explainable** (deterministic behavior)

### 2.2 Single control plane per concept
After the cut, each concept has exactly one mechanism:

- Persistent intent: **repo config file**
- Per-invocation intent: **CLI flags**
- Secrets and deployment-only values: **environment variables**
- Everything else: **derived automatically**

### 2.3 Prefer automatic policies over tunables
If a value can be derived reliably based on:
- CPU count / memory
- repo size / file count
- capability detection (existing `src/shared/capabilities.js` and runtime checks)

...then it should not be user-configurable.

---

## 3) New public contract (whitelist)

### 3.1 Repo config file: `.pairofcleats.json` (minimal)
Replace the schema with **only two** keys.

```jsonc
{
  "cache": {
    "root": "/path/to/cache" // optional
  },
  "quality": "auto" // optional: "auto" | "fast" | "balanced" | "max"
}
```

Rules:
- Unknown keys are **errors** (fail fast).
- Do not add removed keys such as `output.logPath` or `indexing.skipImportResolution`.
- No profile support.
- No hidden env overrides for normal behavior.

### 3.2 CLI flags (public whitelist)

#### Core commands to keep "public"
Keep the existing command names, but collapse the flag surface to a small whitelist.

##### `pairofcleats index build`
- `--repo <path>` (default: current working directory resolved to a repo root)
- `--mode <code|prose|both>` (default: `both`)
- `--quality <auto|fast|balanced|max>` (default: from config or `auto`)
- `--watch` (optional convenience; or keep separate `index watch` command)

##### `pairofcleats index watch`
- `--repo <path>`
- `--mode <code|prose|both>`
- `--quality <auto|fast|balanced|max>`

##### `pairofcleats search "<query>"`
- `--repo <path>`
- `--mode <code|prose|both>`
- `--top <N>` (default: 5)
- `--json` (default: false)
- `--explain` (default: false)

##### `pairofcleats service api`
- `--host <host>` (default: 127.0.0.1)
- `--port <port>` (default: 7345)
- (optional) `--repo <path>` only if you require pinning a repo root

Everything else becomes either:
- internal-only developer tooling, or
- deleted.

### 3.3 Environment variables (public whitelist)
Keep **secrets only**:

- `PAIROFCLEATS_API_TOKEN`

Everything else under `PAIROFCLEATS_*` is removed.

Notes:
- Standard Node/OS env vars remain available (e.g., `NODE_OPTIONS`, `UV_THREADPOOL_SIZE`), but PairOfCleats does not add a shadow layer for them.

---

## 4) AutoPolicy (replacement for tunables)

Introduce an internal policy resolver that replaces most config keys.

### 4.1 New module: `src/shared/auto-policy.js` (or equivalent)
Inputs:
- CPU count (`os.cpus().length`)
- total memory (`os.totalmem()`)
- repo metrics (file count, bytes; quick scan)
- capability detection (native xxhash/re2/sqlite extensions, etc.)

Output:
- `policy.quality`: resolved effective quality
- `policy.indexing`: concurrency, feature enablement, chunking limits
- `policy.search`: backend selection (SQLite only), ANN enablement auto
- `policy.runtime`: worker pool sizing, memory guardrails

### 4.2 Resource-derived quality resolution
Quality modes are the *only* high-level user knob.

Recommended mapping (example; tune as you like):
- Start with machine resources:
  - `fast` if `mem < 16GB` or `cpu <= 4`
  - `balanced` if `mem < 48GB` or `cpu < 12`
  - `max` otherwise
- Downgrade one level if repo is "huge" (e.g., >200k files or >5GB scanned bytes)

### 4.3 Concurrency policy (no user knobs)
- file processing concurrency: `clamp(cpu, 1, 16)`
- I/O concurrency: derived from file concurrency (bounded)
- embeddings concurrency: derived by quality:
  - `fast`: 1
  - `balanced`: 2 (cap at cpu/4)
  - `max`: 4 (cap at cpu/2)

Delete all user overrides:
- `--threads`
- `PAIROFCLEATS_THREADS`
- `indexing.concurrency` and per-feature concurrency keys
- worker pool max workers keys

### 4.4 Embeddings policy
Replace all overlapping embedding toggles with:
- embeddings enabled only when resources/capabilities allow (per policy)
- no user-visible `stub`/`real` switches; tests can inject stubs internally

Delete:
- `PAIROFCLEATS_EMBEDDINGS`
- `--stub-embeddings`, `--real-embeddings`
- `indexing.embeddings.*` (as user config)

### 4.5 Backend policy
Make **SQLite** the only user-visible backend.

- Index build always generates SQLite artifacts.
- Search always queries SQLite.
- ANN usage is internal auto-detection:
  - if SQLite vector extension present: enable ANN
  - else: lexical-only fallback (SQLite FTS)

Delete user selection for:
- LMDB
- explicit backend flags in user CLI
- explicit `sqlite.vectorExtension.*` config

---

## 5) Explicit cuts (what is removed)

### 5.1 Delete profiles entirely
Remove:
- `profiles/`
- `profile` config key
- `PAIROFCLEATS_PROFILE`
- `--profile`
- any "experimental commands require profile=full" behavior

Primary references to remove/update:
- `tools/dict-utils.js` (`PROFILES_DIR`, `loadProfileConfig`, `applyProfileConfig`)
- `src/shared/cli.js` (profile injection)
- docs: `docs/guides/commands.md` and any profile gating notes

### 5.2 Delete env override system (keep API token only)
Remove all reads of env vars that affect non-secret behavior, including:
- cache roots (`PAIROFCLEATS_CACHE_ROOT`, `PAIROFCLEATS_HOME`)
- threads / worker pool (`PAIROFCLEATS_THREADS`, `PAIROFCLEATS_WORKER_POOL`, etc.)
- embeddings / models / dirs
- logging controls
- watcher backends / regex / xxhash / compression toggles
- MCP transports and buffer knobs

Rewrite:
- `src/shared/env.js` → secrets-only (or delete entirely)

Update all call-sites currently using `getEnvConfig()`.

### 5.3 Reduce config schema to minimal
Replace:
- `docs/config/schema.json` → minimal schema (cache.root, quality)
- `tools/config/validate.js` → validate minimal config only
- `tools/config/dump.js` → only dump minimal config + derived policy (optional)
- `tools/config-reset.js` → emit minimal config only

Delete:
- `docs/config/deprecations.md` (irrelevant)
- `docs/config/env-overrides.md` (rewrite to "secrets only")

### 5.4 Remove search filter flags explosion
Delete almost all flags defined in `src/retrieval/cli-args.js` (keep only whitelist flags).
Eliminate `src/retrieval/cli/normalize-options.js` complexity correspondingly.

Optional, recommended (to preserve expressive filtering without flags):
- embed filters in the query language (e.g., `lang:ts path:src type:function`), or
- introduce a single `--filter "<expr>"` flag (still one knob)

### 5.5 Remove LMDB as a supported backend
Delete:
- `pairofcleats lmdb build` (and underlying `tools/build/lmdb-index.js`)
- `lmdb.*` config namespace
- docs referencing LMDB

Keep (optional): a dev-only experimental branch if you still want it internally, but not shipped.

---

## 6) Expected end-state metrics (hard targets)

The goal is a **measurable** reduction. Hard targets:

- **Config keys:** 2-5 (depending on whether you add `service.*` keys)
- **Env vars:** 1 (API token)
- **Public CLI flags:** 15-25 total across core commands

Enforcement:
- update `tools/config/inventory.js` to distinguish **public** vs **internal** CLI flags (or maintain a manual allowlist), then make CI fail if budgets are exceeded.

---

## 7) Concrete file-level change map (high-level)

### Core deletion targets
- `profiles/` (delete)
- `docs/config/deprecations.md` (delete)
- Large portions of `docs/config/env-overrides.md` (rewrite)
- `tools/config/generate-demo-config.js` (likely delete)
- Any scripts that exist solely to support removed knobs/backends

### Core rewrite targets
- `tools/dict-utils.js` (config load + cache root + remove profile/env override behavior)
- `src/shared/env.js` (secrets only or delete)
- `src/shared/cli.js` (remove profile; strict flag parsing)
- `bin/pairofcleats.js` (tight command surface; remove flag sprawl)
- `src/index/build/runtime/*` and `src/index/build/indexer/*` (consume AutoPolicy, not config key soup)
- `src/retrieval/cli-args.js` + `src/retrieval/cli.js` (flag reduction; consume AutoPolicy)
- `tools/build-sqlite-index/*` (remove backend choice; simplify)

---

## 8) Operational behavior changes (explicit decisions)

### 8.1 Ignore behavior (fixed)
- Always respect `.gitignore`
- Always respect `.pairofcleatsignore` if present
- Remove config keys:
  - `useGitignore`, `usePairofcleatsIgnore`, `useDefaultSkips`, `ignoreFiles`, `extraIgnore`

### 8.2 Logging (fixed)
- Default log level: `info`
- Only per-invocation overrides via `--json`/`--explain` (avoid env/config logging knobs)
- Remove `logging.*` config namespace and env logging controls

### 8.3 Watcher backend (fixed)
- Default to `chokidar` (or auto, but internal)
- Remove `PAIROFCLEATS_WATCHER_BACKEND` and any config keys controlling it

### 8.4 Compression / hashing / regex engines (internal auto)
- Use best available (native if present) automatically
- Remove user knobs for selecting engines

---

## 9) Risks and mitigations

**Risk:** Big-bang deletion breaks internal scripts/tests.  
**Mitigation:** Execute via phased PRs with CI gates (see the companion execution plan).

**Risk:** Loss of rare-but-needed expert overrides.  
**Mitigation:** Keep *internal-only* debug switches behind a single `--explain` or `--debug` flag and do not allow them to affect correctness or stored artifacts.

**Risk:** AutoPolicy makes "why did it do that?" harder.  
**Mitigation:** Add `pairofcleats search --explain` (and/or `pairofcleats config dump`) to print the derived policy values.

---

## 10) "If it's not on the whitelist, it does not exist"
This is the governing rule for the hard cut.

- If a setting is not explicitly listed in **Section 3**, it is removed.
- If a value can be derived from resources, it is not configurable.
- If a feature requires 5+ knobs, it is refactored into a single policy decision or removed.

