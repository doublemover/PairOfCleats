DEPRECATED: Replaced by docs/specs/risk-summaries.md Reason: Consolidated into canonical Phase 10 specs Date: 2026-01-31 Commit: (this move)

**Status:** Improved spec for PairOfCleats (Phase 10).

This document defines:
- `risk_summaries.jsonl` (JSONL artifact)
- the compact per-chunk summary stored at `chunk_meta.docmeta.risk.summary`

It is compatible with the existing detector output shape produced by `src/index/risk.js` (`docmeta.risk.sources|sinks|sanitizers|flows`).

---

## 1. Goals
- Provide a *compact, bounded, deterministic* summary of local risk signals per chunk.
- Provide enough information for the interprocedural engine to:
  - seed roots (sources)
  - score confidence/severity
  - record evidence references via `snippetHash`
- Avoid copying large evidence blobs into artifacts.

---

## 2. Primary identifiers

### 2.1 chunkUid (required)
All rows are keyed by **`chunkUid`**.
- `chunkUid` is generated by MetaV2 and is the canonical identity contract across the repo.

`chunkId` (range-derived) may appear as an *optional* debugging field, but must not be used for joins.

---

## 3. Artifact: risk_summaries.jsonl

### 3.1 Record type (minimum contract)

```ts
export type RiskSummariesRowV1_1 = {
  schemaVersion: 1,

  // identity
  chunkUid: string,
  file: string,
  languageId: string,

  // summary counts
  totals: {
    sources: number,
    sinks: number,
    sanitizers: number,
    flows: number,
  },

  // bounded signal lists
  sources: RiskSignalSummaryV1_1[],
  sinks: RiskSignalSummaryV1_1[],
  sanitizers: RiskSignalSummaryV1_1[],

  // local flows (bounded)
  flows: RiskLocalFlowSummaryV1_1[],

  // any truncation/cap info
  truncated: {
    sources?: boolean,
    sinks?: boolean,
    sanitizers?: boolean,
    flows?: boolean,
    evidence?: boolean,
  },
}

export type RiskSignalSummaryV1_1 = {
  kind: "source" | "sink" | "sanitizer",
  ruleId: string,
  ruleName?: string,
  category?: string,
  severity?: "low" | "medium" | "high" | "critical",

  // evidence references
  evidence: RiskEvidenceRefV1_1[],
}

export type RiskLocalFlowSummaryV1_1 = {
  ruleId: string,
  sourceId?: string,
  sinkId?: string,
  // evidence references
  evidence: RiskEvidenceRefV1_1[],
}

export type RiskEvidenceRefV1_1 = {
  file: string,
  startLine: number,
  startCol: number,
  endLine: number,
  endCol: number,
  snippetHash: string, // "sha1:<hex>"
}
```

### 3.2 Deterministic ordering
Within a row:
- Sort signals by `(ruleId, minEvidenceLocation)`.
- Sort evidence arrays by `(file,startLine,startCol,endLine,endCol,snippetHash)`.

This matches the repo’s existing ordering requirements in `docs/specs/risk-summaries.md`.

---

## 4. Compact chunk_meta summary

### 4.1 Storage
If and only if a chunk has local risk (any of sources/sinks/sanitizers/flows non-empty), attach:

```ts
chunk.docmeta.risk.summary = {
  schemaVersion: 1,
  totals: { ... },
  topSources: [...],
  topSinks: [...],
  topSanitizers: [...],
  truncated: { ... },
}
```

### 4.2 Purpose
- Used for quick UI/CLI summaries.
- Used by explainers without loading `risk_summaries.jsonl`.

---

## 5. Mapping from detector output

Detector output (`src/index/risk.js`) yields entries with:
- a `rule` object (`id`, `name`, `category`, `severity`)
- evidence fields containing source snippet/excerpt, location, etc.

The summary builder must:
- map `rule.id` → `ruleId`
- compute `snippetHash = sha1(normalizeSnippet(excerpt))` (prefixed `sha1:`)
- drop large excerpt strings from the artifact

---

## 6. Implementation mapping

### 6.1 Builder
New module (Phase 10):
- `src/index/risk-interprocedural/summaries.js`
  - `buildRiskSummaries({ chunks, runtime, caps, ... })`

### 6.2 Integration points
- Build step: `src/index/build/indexer/steps/relations.js`
  - after `applyCrossFileInference(...)`
  - before `buildRelationGraphs(...)` / before write step

- Meta rebuild: `src/index/build/indexer/steps/write.js`
  - `finalizeMetaV2(...)` already rebuilds MetaV2 from mutated `docmeta`

### 6.3 Artifact writing
New writer (Phase 10):
- `src/index/build/artifacts/writers/risk-interprocedural.js`
  - emit `risk_summaries.jsonl`

---

## 7. Open items
- Confirm whether non-risk chunks should also get an explicit `{ totals:0 }` compact summary.
  - Current recommendation: **only attach** `docmeta.risk.summary` when there is local risk.





