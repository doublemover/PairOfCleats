> **DEPRECATED**
> Replacement: `LEXI.md`
> Reason: Absorbed into LEXI roadmap.
> Date: 2026-02-03
> Commit: 75d70209
# Spec -- Chargram Enrichment and ANN Candidate Safety  Status: **Proposed**   Owner: Index Build + Retrieval   Last Updated: 2026-01-30  ---  ## Summary  This spec adds:  1. **Optional chargram enrichment** at index-time by allowing chargrams to be generated from additional chunk fields (e.g. `signature`, `comment`) instead of only `name` + `doc`. 2. A **candidate safety policy** for ANN retrieval so that candidate sets derived from chargrams/phrase-ngrams:    - are capped/disabled when too large,    - fall back when too small/restrictive,    - cannot reduce recall (candidate sets become a *hint*, not a hard filter).  This spec is designed to work with the current architecture:  - Index-time postings are built in `src/index/build/state.js`. - Query-time candidate sets are built by `src/retrieval/pipeline/candidates.js`. - ANN is executed in `src/retrieval/pipeline.js` via providers.  ---  ## Part A: Chargram Enrichment  ### Current behavior  When `postingsConfig.chargramSource === 'fields'`, `src/index/build/state.js` currently adds chargrams from:  - `fieldTokens.name` - `fieldTokens.doc`  ### New behavior  Allow configuring which fields contribute chargrams:  - `postingsConfig.chargramFields: string[]`  Allowed values:  - `name` - `signature` - `doc` - `comment` - `body`  Default (backward compatible):  - `['name', 'doc']`  ### Optional stopword filtering  Add:  - `postingsConfig.chargramStopwords: boolean` (default `false`)  When enabled, tokens are filtered using the lexicon stopwords domain `chargrams` for the chunk language.  Rationale:  - If we include `signature` or `comment`, we will otherwise ingest many low-value tokens (e.g. `public`, `static`, `string`, `throws`) that balloon postings. - Stopword filtering is a performance safeguard and quality improvement.  ---  ## Part B: ANN Candidate Safety Policy  ### Problem  Candidate sets from phrase ngrams + chargrams are currently:  - built as a union of postings lists (`buildCandidateSet`) - not bounded/capped before being passed into ANN providers - used as the primary candidate restriction even when BM25 hits exist  This can cause:  - performance issues (candidate sets too large) - recall issues for ANN if candidate sets are too small/restrictive in contexts where full ANN search would have found results  ### Policy: treat candidate set as a hint  We define a `resolveAnnCandidateSet(...)` function that enforces:  - disable candidate filtering when it is unhelpful - fallback when too restrictive  Inputs:  - `candidates: Set<number> | null` (from chargrams/phrases) - `bmHits: Array<{id:number,...}>` (BM25 hits) - `allowedIdx: Set<number> | null` (active filters intersection) - `filtersActive: boolean` - retrieval config:   - `annCandidateCap` (existing)   - `annCandidateMinDocCount` (existing)   - `annCandidateMaxDocCount` (existing)  Outputs:  - `Set<number> | null`   - `null` means “no candidate restriction” (full ANN)   - `Set()` means “no candidates” (ANN returns no results)  ### Rules  Given `candidates`:  1. If `candidates == null` -> return `null` 2. If `candidates.size == 0` -> return `new Set()` 3. If `candidates.size > annCandidateCap` -> return `null` 4. If `annCandidateMaxDocCount` is set and `candidates.size > annCandidateMaxDocCount` -> return `null` 5. If `candidates.size < annCandidateMinDocCount` and `filtersActive === false` -> return `null` 6. If `filtersActive === true` and `allowedIdx` exists -> return `allowedIdx` 7. Else return `candidates`  ### Notes  - This policy is **recall-safe** because the only time it changes candidate restriction is by widening it to `null` (full ANN) or to `allowedIdx` (which preserves user-intended filtering). - It also improves stability for backends that cannot accept huge candidate sets (e.g. SQL parameter limits, LanceDB filter expression sizes).  ---  ## Configuration Surface  ### Index-time (`postingsConfig`)  Add fields to `src/shared/postings-config.js`:  ```js {   chargramFields: ['name','doc'], // default   chargramStopwords: false // default } ```  ### Query-time (retrieval options)  Use the existing options already parsed in:  - `src/retrieval/cli/normalize-options.js`  Fields:  - `annCandidateCap` (default 50_000) - `annCandidateMinDocCount` (default 200) - `annCandidateMaxDocCount` (default 50_000)  This spec requires wiring them into `src/retrieval/pipeline.js`.  ---  ## Explain / Observability  When `--explain` is enabled, attach:  ```json {   "annCandidatePolicy": {     "source": "chargrams+phrases",     "inputSize": 1234,     "output": "null",     "reason": "tooLarge"   } } ```  Reasons:  - `noCandidates` (size 0) - `tooLarge` - `tooSmallNoFilters` - `filtersActiveAllowedIdx` - `ok`  ---  ## Test Plan  ### Index-time tests  File: `tests/postings/chargram-fields.test.js`  - Default config generates chargrams from `name` + `doc` only. - Custom config `chargramFields=['name','signature']` includes signature tokens. - With stopwords enabled, tokens in stopword set do not generate chargrams.  ### Retrieval-time tests  File: `tests/retrieval/ann-candidate-policy.test.js`  Test matrix:  - `candidates=null` -> output null - `candidates.size=0` -> output empty set - `size > cap` -> output null - `size < min` with no filters -> output null - filtersActive + allowedIdx -> output allowedIdx - normal size -> output candidates  ### Determinism  - Ensure explain output is deterministic (reasons + sizes).  ---  ## Rollout Guidance  - Keep chargram enrichment disabled by default (or only enable under `quality=max`) until candidate policy is in place. - Once policy is in place, enable signature inclusion as a safe incremental improvement:   - `chargramFields=['name','doc','signature']`   - `chargramStopwords=true`  ---  ## Compatibility  - Default behavior (`chargramFields=['name','doc']` and candidate policy disabled) matches current behavior. - Candidate policy should be enabled whenever chargram enrichment is enabled. 
