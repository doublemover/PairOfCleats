# Artifact Schemas (0.0.2)

This document is the canonical contract for on-disk index artifacts. Schema validation is enforced by `src/index/validate` against the registry in `src/contracts/schemas/artifacts.js`.

> Phase 11 adds an optional new artifact (`api_contracts`) if artifact emission is enabled for cross-file API contract reports.

## General expectations

- Strict readers resolve artifacts via `pieces/manifest.json` (manifest-first).
- Non-strict readers may fall back to file-system discovery with warnings when manifest entries are missing.
- Paths are **relative** and **posix-normalized**; `..` and absolute paths are invalid.
- Unknown top-level fields are errors when a schema sets `additionalProperties: false`.
- Most artifact schemas allow `additionalProperties`; use `extensions` for namespaced data but it is not the only permitted location.
- Columnar artifacts use `{ format: "columnar", columns, arrays, length, tables? }` and inflate to the same row schema as JSON/JSONL.

## Sharded JSONL meta schema

Artifacts written as `*.jsonl.parts/` must include `*.meta.json` with:
- `schemaVersion` (SemVer), `artifact` (const), `format: jsonl-sharded`, `generatedAt`, `compression`
- `totalRecords`, `totalBytes`, `maxPartRecords`, `maxPartBytes`, `targetMaxBytes`
- `parts`: `{ path, records, bytes, checksum? }[]`

Sharded meta is defined for: `chunk_meta_meta`, `chunk_uid_map_meta`, `vfs_manifest_meta`, `vfs_path_map_meta`, `file_relations_meta`, `symbols_meta`, `symbol_occurrences_meta`, `symbol_edges_meta`, `call_sites_meta`, `risk_summaries_meta`, `risk_flows_meta`, `repo_map_meta`, and `graph_relations_meta`.

## Artifact registry

All artifacts below are JSON unless noted. Required fields are listed.

Machine-readable index:
- `docs/contracts/artifact-schema-index.json` (generated by `node tools/docs/export-artifact-schema-index.js`).

- `chunk_meta` (array/JSONL/columnar): entries require `id`, `start`, `end` (ints). Optional: `fileId`, `startLine`, `endLine`, `kind`, `name`, `ext`, `metaV2`. Additional properties allowed.
- `chunk_meta_cold` (array/JSONL/columnar): cold-path chunk metadata mirror used by staged writers.
- `chunk_meta_cold_meta` (object): sharded JSONL metadata for `chunk_meta_cold`.
- `chunk_uid_map` (array): entries require `docId`, `chunkUid`, `chunkId`, `file`, `start`, `end`. Optional: `segmentUid`, `segmentId`.
- `vfs_manifest` (array): entries require `schemaVersion`, `virtualPath`, `docHash`, `containerPath`, `containerExt`, `containerLanguageId`, `languageId`, `effectiveExt`, `segmentUid`, `segmentStart`, `segmentEnd`. Optional: `segmentId`, `lineStart`, `lineEnd`.
- `vfs_path_map` (array): entries require `schemaVersion`, `virtualPath`, `hashVirtualPath`, `containerPath`, `segmentUid`, `segmentStart`, `segmentEnd`, `effectiveExt`, `languageId`, `docHash`.
- `vfs_manifest_index` (array): entries require `schemaVersion`, `virtualPath`, `offset`, `bytes`.
- `vfs_manifest_bloom` (object): requires `schemaVersion`, `pathPolicy`, `encoding`, `hashSeed`, `bits`, `hashesPerKey`.
- `file_meta` (array): entries require `id`, `file` (string). Optional: `ext`, `encoding`, `encodingFallback`, `encodingConfidence`.
- `file_meta_meta` (object): sharded JSONL metadata for `file_meta`.
- `repo_map` (array): entries require `file`, `name`. Optional: `kind`, `signature`, `exported`.
- `file_relations` (array): entries require `file`, `relations` (object). Optional: `importBindings` (object).
- `symbols` (array/JSONL): entries require `v`, `symbolId`, `scopedId`, `symbolKey`, `qualifiedName`, `kindGroup`, `file`, `virtualPath`, `chunkUid`. Optional: `scheme`, `signatureKey`, `segmentUid`, `lang`, `kind`, `name`, `signature`, `extensions`.
- `symbol_occurrences` (array/JSONL/columnar): entries require `v`, `host` (`file`, `chunkUid`), `role`, `ref`. Optional: `range`.
- `symbol_edges` (array/JSONL/columnar): entries require `v`, `type`, `from` (`file`, `chunkUid`), `to`. Optional: `confidence`, `reason`.
- `call_sites` (array/JSONL): entries require
  `callSiteId`, `callerChunkUid`, `file`, `languageId`, `start`, `end`,
  `startLine`, `startCol`, `endLine`, `endCol`, `calleeRaw`,
  `calleeNormalized`, `args`. Optional: `receiver`, `kwargs`, `confidence`,
  `evidence`, `segmentId`, `callerDocId`, `targetChunkUid`, `targetDocId`,
  `targetCandidates`, `snippetHash`.
- `risk_summaries` (array/JSONL): entries require `schemaVersion`, `chunkUid`, `file`, `signals`, `totals`, `truncated`. Optional: `languageId`, `symbol`, `taintHints`.
- `risk_flows` (array/JSONL): entries require `schemaVersion`, `flowId`, `source`, `sink`, `path`, `confidence`, `notes`.
- `risk_interprocedural_stats` (object): requires `schemaVersion`, `generatedAt`, `mode`, `status`, `effectiveConfig`, `counts`, `callSiteSampling`, `capsHit`, `timingMs`. Optional: `reason`, `artifacts`, `droppedRecords`.
- `token_postings` (object): requires `vocab`, `postings`, `docLengths`. Optional: `avgDocLen`, `totalDocs`.
- `token_postings_meta` (object): requires `format`, `shardSize`, `vocabCount`, `parts`. Optional: `avgDocLen`, `totalDocs`, `compression`, `docLengths`, `extensions`.
- `vocab_order` (array): deterministic vocabulary ordering rows used by packed postings writers.
- `field_postings` (object): requires `fields` map; each field requires `vocab`, `postings`, `docLengths`.
- `field_tokens` (array): entries may include `name`, `signature`, `doc`, `comment`, `body` token arrays.
- `field_tokens_meta` (object): sharded JSONL metadata for `field_tokens`.
- `minhash_signatures` (object): requires `signatures` (array of int arrays).
- `dense_vectors`, `dense_vectors_doc`, `dense_vectors_code` (object): requires `dims`, `vectors`. Optional: `model`, `scale`, `minVal`, `maxVal`, `levels`.
- `dense_vectors_hnsw_meta`, `dense_vectors_doc_hnsw_meta`, `dense_vectors_code_hnsw_meta` (object): requires `dims`, `count`, `space`, `m`, `efConstruction`, `efSearch`. Optional: `scale`, `minVal`, `maxVal`, `levels`.
- `dense_vectors_lancedb_meta`, `dense_vectors_doc_lancedb_meta`, `dense_vectors_code_lancedb_meta` (object): requires `dims`, `count`, `metric`, `table`, `embeddingColumn`, `idColumn`. Optional: `scale`, `minVal`, `maxVal`, `levels`.
- `dense_vectors_sqlite_vec_meta` (object): requires `dims`, `count`, `table`. Optional: `embeddingColumn`, `idColumn`, `scale`, `minVal`, `maxVal`, `levels`.
- `phrase_ngrams` (object): requires `vocab`, `postings`.
- `chargram_postings` (object): requires `vocab`, `postings`.
- `filter_index` (object): requires `fileById`, `fileChunksById`. Optional: `fileChargramN`, `byExt`, `byKind`, `byAuthor`, `byChunkAuthor`, `byVisibility`, `fileChargrams`.
- `filelists` (object): requires `generatedAt`, `scanned`, `skipped` (each has `count`, `sample`).
- `lexicon_relation_filter_report` (object): requires `schemaVersion`, `mode`, `totals`, `files`; `totals` requires dropped counter fields and `files`; each file row requires per-file dropped counters plus categorized drop maps.
- `pieces_manifest` (object): requires `version`, `artifactSurfaceVersion`, `pieces`. Optional: `compatibilityKey`, `generatedAt`, `updatedAt`, `mode`, `stage`, `repoId`, `buildId`, `extensions`.
- `index_state` (object): requires `generatedAt`, `mode`, `artifactSurfaceVersion`. Optional: `profile` (requires `id`, `schemaVersion=1`), `compatibilityKey`, `cohortKey`, `repoId`, `buildId`, `stage`, `assembled`, `embeddings`, `features`, `shards`, `enrichment`, `filterIndex`, `sqlite`, `lmdb`, `artifacts` (requires `schemaVersion=1`, `present`, `omitted`, `requiredForSearch`), `riskInterprocedural` (requires `enabled`, `summaryOnly`, `emitArtifacts`), `riskRules`, `extensions`.
- `determinism_report` (object): requires `schemaVersion`, `generatedAt`, `normalizedStateHash`, `metrics`; optional run-variant fields are excluded from stable hash computation.
- `extraction_report` (object): requires `schemaVersion`, `generatedAt`, `mode`, `counts`, `timings`.
- `boilerplate_catalog` (array): extracted boilerplate signature rows for reuse/skip heuristics.
- `builds_current` (object): requires `buildId`, `buildRoot`, `promotedAt`, `artifactSurfaceVersion`. Optional: `buildRoots`, `buildRootsByMode`, `buildRootsByStage`, `stage`, `modes`, `configHash`, `compatibilityKey`, `tool`, `repo`, `extensions`.
  - When `repo.head` is present, supported keys include `commitId`, `changeId`, `operationId`, `branch`, `bookmarks`, `author`, and `timestamp`.
- `snapshots_manifest` (object): requires `version`, `updatedAt`, `snapshots`, `tags`.
- `snapshot_record` (object): requires `version`, `snapshotId`, `createdAt`, `kind`, `tags`, `pointer`.
- `snapshot_frozen` (object): requires `version`, `snapshotId`, `frozenAt`, `method`, `frozenRoot`, `included`, `verification`.
- `diffs_manifest` (object): requires `version`, `updatedAt`, `diffs`.
- `diff_inputs` (object): requires `id`, `createdAt`, `from`, `to`, `modes`, `allowMismatch`, `identityHash`.
- `diff_summary` (object): requires `id`, `createdAt`, `from`, `to`, `modes`.
- `graph_relations` (object): requires `version`, `generatedAt`, `callGraph`, `usageGraph`, `importGraph`. Each graph requires `nodeCount`, `edgeCount`, `nodes[]` (node requires `id`, `out`, `in`; optional `file`, `name`, `kind`, `chunkId`).
- `import_resolution_graph` (object): requires `generatedAt`, `nodes`, `edges`, `stats`. Nodes require `id`, `type`. Edges require `from`, `to`, `rawSpecifier`, `resolvedType`. Optional edge fields include `kind`, `resolvedPath`, `packageName`, `tsconfigPath`, `tsPathPattern`. Optional top-level `warnings[]`.

### Phase 11 optional: `api_contracts` (JSONL)
If Phase 11 enables artifact emission for API contracts, a new JSONL artifact MAY be produced.

- `api_contracts` (array/JSONL): one record per symbol.
  - Required fields:
    - `symbol` (object):
      - `symbolId` (string)
    - `signature` (object; `declared`, `tooling` optional)
    - `observedCalls[]` (bounded)
  - Optional fields:
    - `symbol.chunkUid` (string|null)
    - `symbol.file` (string|null)
    - `symbol.name` (string|null)
    - `symbol.kind` (string|null)
    - `warnings[]` (bounded)
    - `truncation[]` (bounded)
  - The artifact MUST be bounded (caps) and deterministic in ordering when emitted.

Canonical contract for the report surface:
- `docs/specs/graph-product-surfaces.md` (`ApiContractsReportV1`)

## Additions and phase notes

- `filter_index` may include an optional `byLang` map keyed by effective language id (Phase 5).
  - Phase 5 also requires chunk records to expose effective language via `metaV2.lang`.
- `call_sites` (jsonl or sharded jsonl) contains bounded callsite evidence records (Phase 6).
  - Canonical spec: `docs/specs/risk-flows-and-call-sites.md`.
  - `call_sites_meta` follows the sharded JSONL meta schema (artifact name `call_sites`).
- `index_state.embeddings` includes identity and backend availability signals when embeddings are present (Phase 7).

## Notes

- Schema definitions are authoritative in `src/contracts/schemas/artifacts.js`.
- `metaV2` uses the metadata schema defined in `docs/specs/metadata-schema-v2.md` (see analysis schemas).
- SQLite stores canonical `metaV2` per chunk in `chunks.metaV2_json` for parity with JSONL artifacts.


