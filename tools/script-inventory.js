#!/usr/bin/env node
import fsPromises from 'node:fs/promises';
import path from 'node:path';
import yargs from 'yargs/yargs';
import { hideBin } from 'yargs/helpers';

const parseArgs = () => {
  const parser = yargs(hideBin(process.argv))
    .scriptName('pairofcleats script-inventory')
    .option('json', { type: 'string', default: 'docs/script-inventory.json' })
    .option('markdown', { type: 'string', default: 'docs/commands.md' })
    .help()
    .alias('h', 'help')
    .strictOptions();
  return parser.parse();
};

const categoryFor = (name) => {
  if (name === 'lint' || name === 'format') return 'lint';
  if (name.startsWith('test')) return 'test';
  if (name.startsWith('bench')) return 'bench';
  if (name.startsWith('config')) return 'config';
  if (name.startsWith('ci-') || name.startsWith('release')) return 'release';
  if (name.includes('install') || name.includes('download')) return 'tooling';
  if (name.includes('index') || name.includes('search')) return 'indexing';
  return 'tooling';
};

const ciAllowlist = new Set([
  'lint',
  'format',
  'config:budget',
  'env:check',
  'test',
  'test:pr',
  'test:nightly',
  'test:ci',
  'verify'
]);

const main = async () => {
  const argv = parseArgs();
  const root = process.cwd();
  const pkg = JSON.parse(await fsPromises.readFile(path.join(root, 'package.json'), 'utf8'));
  const scripts = pkg.scripts || {};
  const inventory = Object.keys(scripts).sort().map((name) => ({
    name,
    category: categoryFor(name),
    ciAllowed: ciAllowlist.has(name) || name.startsWith('test:'),
    replacement: null
  }));

  const jsonPath = path.resolve(root, argv.json);
  await fsPromises.mkdir(path.dirname(jsonPath), { recursive: true });
  await fsPromises.writeFile(jsonPath, `${JSON.stringify({ generatedAt: new Date().toISOString(), scripts: inventory }, null, 2)}\n`);

  const markdownPath = path.resolve(root, argv.markdown);
  const lines = [
    '# Script Inventory',
    '',
    'This file is generated by `node tools/script-inventory.js`.',
    '',
    '## Stable entrypoints',
    '- `npm test` (runs `tests/run.js`)',
    '- `npm run test:pr` (PR suite)',
    '- `npm run lint`',
    '- `npm run config:budget`',
    '- `npm run env:check`',
    '- `pairofcleats search|index build|index watch`',
    '',
    '| Script | Category | CI Allowed | Replacement |',
    '| --- | --- | --- | --- |',
    ...inventory.map((entry) => `| \`${entry.name}\` | ${entry.category} | ${entry.ciAllowed ? 'yes' : 'no'} | ${entry.replacement || ''} |`),
    ''
  ];
  await fsPromises.mkdir(path.dirname(markdownPath), { recursive: true });
  await fsPromises.writeFile(markdownPath, `${lines.join('\n')}\n`);
};

main().catch((error) => {
  console.error(error?.message || String(error));
  process.exit(1);
});
