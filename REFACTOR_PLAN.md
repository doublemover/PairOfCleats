# Plan

We will execute every remaining Phase R item (including all optional follow-ups), using per-area test runs to catch regressions early, then finish with a deep duplication audit to centralize shared logic created by the refactors. This plan is exhaustive across Phase R tasks/subtasks and names targeted files/modules/tests explicitly.

## Scope
- In: All unchecked Phase R tasks (R.1–R.8), optional follow-ups, and an explicit duplication/consolidation review after refactors.
- Out: New features or behavior changes beyond the Phase R "no behavior change" rule.

## Action items
[x] Baseline evaluation sweep: re-read `GIGAROADMAP.md` and inspect every targeted file for size/ownership/entrypoints; build a per-area checklist for R.1–R.9 so each subtask maps to concrete file edits and tests.
[x] R.1/R.2 docs + policy enforcement: update `tools/script-inventory.js` to fully emit the "Phase specs" section into `docs/guides/commands.md`; add `tests/policy/script-inventory-docs.test.js`; tighten stable entrypoints contract with a new test; update docs/error messages to prefer CLI/`node` scripts; add AGENTS pointer to `docs/tooling/script-inventory.json`, `docs/guides/commands.md`, `tests/policy/script-surface-policy.test.js`; run policy tests.
[x] R.2.3 repo inventory: implement `tools/repo-inventory.js`, generate `docs/tooling/repo-inventory.json`, add a lightweight schema-sanity policy test; run just the new policy test(s).
[x] R.3 shared primitives tests: add `tests/retry-with-backoff.js` and `tests/ignore-matcher.js` for `src/shared/retry.js` and `src/shared/fs/ignore.js`; run those tests plus any referenced watch/ignore tests to validate semantics.
[.] R.4 core indexing refactors: split `src/integrations/core/build-index.js` into `src/integrations/core/build-index/*`; split `src/index/build/file-processor/cpu.js` helpers (`cpu/tokenizer.js`, `cpu/analyze.js`, `cpu/meta.js`) and `process-chunks.js` into `file-processor/process-chunks/*`; split `src/index/build/piece-assembly.js` into `piece-assembly/load.js` + `piece-assembly/merge.js`; include optional `runtime/normalize.js` if needed; run indexing tests (`node tests/run.js --match build-index --match index-lock --match watch-atomicity --match segment-pipeline --match chunking-limits --match metadata-v2 --match compact-pieces --match index-compatibility-key-federation-block`) and at least one full build smoke.
[ ] R.5 retrieval refactors: fix `src/retrieval/output/filters.js` formatting drift then extract `predicates.js`, `structural.js`, `meta.js`, `file.js`, `file-prefilter.js`, keep `filterChunks` entrypoint stable; split `src/retrieval/cli.js` helpers into `cli/runner.js` and `cli/resolve-run-config.js`; split `src/retrieval/pipeline.js` into `pipeline/query-ast.js`, `pipeline/ann-backends.js`, `pipeline/fusion.js`; run retrieval tests (all `filter-*` tests, `tests/structural-filters.js`, `tests/file-case-sensitive.js`, `tests/lang-filter.js`, `node tests/run.js --match search-cli --match sqlite-fts-eligibility --match search-symbol-boost` plus any pipeline tests listed in the roadmap).
[ ] R.6 tooling + R.7 UI refactors: split `tools/mcp/tools.js` into handler modules and replace switch with a handler map; update `tests/mcp/tools-registry.test.js` accordingly; split `src/map/isometric/client/edges.js` into `aggregate.js`, `endpoints.js`, `style.js`, and add `tests/map/edges.test.js`; run MCP tests and new UI tests per area.
[ ] R.8 post-refactor docs/configs: update `docs/guides/architecture.md` for new module boundaries, `docs/contracts/artifact-contract.md` and `src/contracts/schemas/artifacts.js` if needed, and re-evaluate `eslint.config.js` max-lines threshold; run `npm run lint` after all refactors.
[ ] Duplication audit and consolidation: review all newly created modules for duplicated helpers (especially filter/pipeline/build-index/process-chunks) and extract to `src/shared/**` or targeted utility files; update imports and re-run the affected per-area tests plus `node tests/run.js --lane pr` as the final validation pass.

## Problems / Conflicts
- `tests/policy/script-inventory-docs.test.js` initially failed due to stale `docs/guides/commands.md`; resolved by running `node tools/script-inventory.js` before re-running policy tests.
- `tests/ignore-matcher.js` initially failed because ignore patterns matched child paths; adjusted to assert unrelated file allowance instead of file-child behavior.
