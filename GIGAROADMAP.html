<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>@font-face { 
  font-family: "fontawesome-mini";
  src: url(data:application/octet-stream;base64,d09GMgABAAAAABAAAA8AAAAAIIQAAA+nAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHFQGYACDfggOCZwMEQgKknyQRwsYAAE2AiQDLAQgBYYtB4ElDIEcGy4eRUWwcQBQ8OnJ/j8ccGMIvmn4RKttUBuoGdqn/Wo0V1nlpkC/YoxFf7EPPW8Mb8dxsKfR1DnTvl/z5Vb39K5hi6BYjj0qQus6GvxOFCpysY312mqKOEX62AhJZuG/Wvv33O6emX0QZE/kiT6hCiHIVGSEBRIyFaOAVj7/aS57/2cCvBuYtJwFupRhCgzy9BnRc6a27py44d/TXuFBbTZ3IqtBHZUOTu6cHtR28xegA/0JKBi52eMz6wYYLYHnUZfyMLWswld/geQCBVA+aDlhqSjlnBvmDLO36cnBgjc8sR4UsM0/cpJQ8Jk5Vvtyfn3AV32bc5TWLFnOEL9l4lFaSf5x2mEZ8f+b68u+W0nNzwALhSgcSnaufuXnT16lmwfS+ZweAlKAFhh7aIFQrnB0/MqVbv1KtWflPmRTGEYF9R9js8fpogLEPuhVvPvIT4IATcYEIG6OiOMDlRNiSRXQRaatSWvMFtaJ0mIxoJeKCASClTJoX+onCAdIwK4RN4EXo99eP6yKCAzdaf/pfYfCC8CJWsek4GXSfZLXQD7YEAmOpRRjdKnKZ5iASm1JOK3JbEYVVpgl6tK54+G7pAZAbytxahntgFjEwo7jH16m3aRNsyemN0FNxUGydjBZO7isHULWDknWDlnWDkXWDlWzzg6NZh07oFn4z1VuGBJwFfpR5MsFgtsvGPc/A1NbtF/TWNqrF9jzf0vGpT/SA2MtuAMb2utAwuQdBPI6djDUqnVokOZYW74y4WtiSkq+8HLtS2NoA+bOkeAZzDo3iJujjnu8kTyVwS0Ls+6Clcn1WwJTfRenuE5ewWk4jJ1MnBiJObQgZSDlJ+lhP6yRRvjnIvLPrp38jf6oj3EYLJrHrV/BOKdpb5XTmyerMsfcZPrca5SCGnJDO3gLShNjZoyK/s0mY2m/2kEOp5fJNxtnImZoJkwx2p4DOx5H4DyAgxLbu2+CGJh74DxflGREfMWFLl2MTY5QxAie4teIpPro0CF9QXhuBJMbAdM8lnljbYSqwxC1Ioqpxey8YDSrCZN1PQjBa96AXqzw4Slt/v+dooyNNBB5M6QNk7di0GijoO4DGSMTLxuPcpjA5rMOrGKyZrfNq4Cqnwx3Y6i/FGZx2BCgSwUcXQjpJHSMqhGfTz3naQ46exbs+6fWaMhd04gSXgyvplCwgfAk/bbWpBF0Dr3KmEW+hRJWiOZqohf99vhBs9T/ANbpUqCZ+cqO/WkMHW4Ea9TGp9YRonBvi8/Wc5QAVRFCfg5cvk01Hykt4BylBkcZpSuQknIhpN/WGmUmaV+1UiJpyQhfdkIRP714H3+gRy+Kx2+GL9uVrLG5FXedoCCqd/1ofj7UPOWIYAN2X0IXpdLQqgqab4RCwoTAqP3SJBcuFatQmyUMibh8dOuTIyGHmcJyZi2KWh/1vbAAl7QHEax0lKj2laWYKPDhTiAyL30C8/gGXr2k8671SSxMXJrw3nNPyRuGWknGC/7G1r3okChInzmyVRB1CaZuoVGPENQrdOoTBvULkwaERYPCri2gsn8gRv2yE1Qq6HNH2dcxhCmT9m//w2VN+++S5ZhgUvA4HmqnFY3W4A0V5KhCUYOiDkUDiiYULSjaUHSg+AUtjkCWjJVG50x0Van1GtTqjKkyYq+ZMSh+5LemOMYhMhRNxprndK++/kRjOKeJinJcgtEta3sY46XoKe2Hl5HDxKRo1p9cnIK8A10zjQm0jcP0IihgrHtTDHmC9lK9FZ0rUynl85LMQJZkCD0EG+kfyDGL6tqSY85fA8SRdfF5FJbVB1IlEajtKF/jp/br2IaaJRwYGyHz3Vyi9PJTxwKAJDOPcIT7KV082cfls8N2xESW2rloIIt5qUozBcM8ZSS8Hk4WV7fhWOhsbuYX5Nme6L0KDqWtUYc6SOmBCAPXB7qKE9J9BFOj6MxNsZRgNuhM5bXSF7KK88VZB3nOKA4HsOMwhZ0mcY0iVpbT2oDueVyrjwiRMyCctdk7iK6WzsToWJJDLyKCnkNdmvsuW87jkPwB6AQ5l41WXEYqpPxUcBkqWVJr4DVGICUFNmv4bYtPly0VClynpXuaMmbuqdWWK3mvrqoD5nXsVao3VFCPlqAaS2cMG2YrBlmKVRlLyTNlwLWRt8zGttfDrTf1KW+AhUhs9k2wGG1eavvaxXbO3xwYrBhz01Ye0jYTWerTM555trVx+mqfIJXOxV2/jeL42ONGN+e/xdCCNT/6EHbsks4ZaytjbIRIO7VYeCYR3r2pcoxVT3OyBvvYS6TbfK7Dzu1f4pyZMjj7kw9QQJcss9RwCOYXOnoSZF+lkkFba5LKHcOYsxwdcwA76GQ7gSsirwngi0xAxo4INaKoCVAQzVnEsWAjRsmKyk2BihVV2wihZkX1pkDDyjTTw5ZoaYfaTYCOyHTJ2BU9jajfBBiIgiEkbIqRW6NxU2BiFUyRRphZ0bwpsLCatUTRr7xgtZDFzOw1LLMRuOvA9refCcgOO4m1l9BhnHaMONobJ3snzlPYdAEwcfWwdJPQfZxOXHjYB0/74GUfvD1EHwl9JfyDsovYvkjsi9S+yDxEuYSEDJOEotRunnVR+95nqXrzZCIpPNXUWM84LS3EdpZeOEsyS2o6Uj/AHggIx4Wg3YQFHI4puiAa5zTrIjY78Z9JJdTBQQB/M2akplzS0GCz1ayUTRUKy8DI+P5AdchNuV1NQOVMJqm1KnYEAETGYoFJJFWk41YvzCZG7tzB7nXnvH9fevduNQbsWJiBcpZ8rZgEgD58dvOUXdeqmRq2zpl2bO3dkK61FhzBOEVyFBIppOzC4ikWyBC4BWG6eKOCreUnm8lAM3XN8o+Y1e2x0MyGdA0go2aLdwxI10NnLC0VExODguwtLuAJk0ALHEf/aqdVcAQgX2qxQigoYBJaESu+UDQhtRaMtaIcoRzTtpbJ2Gxk1AyTyzk2owhbIJO2QRGmSot/ZCm0tZF3UwjohLnUV56/YKIQ8eNvYgHCY2hiyonRgwJFx6X+gqNIXPLpl0mt0rt3wSSz+NmGlrQoDazFy5EjmBxCLzHnjEJx/9IuHhWg967dw+5cuaOP+Ftb3xWw7osUE9BxEZI0unlHewggWjKAmFUlVpldq2fWdbF1PRQaJkQkn82y59S0za2V73d0982KUSZ2zAjFAHLTU5qPbDKZyB3sHuGjQJg4LWdE6KAZm7wyBRAta1aA+Bc/6ZOcRu+meRhOWfo8Ia3GfcF9MvX3dkf8cbkcvdEHKXheX3v6LPzyPFx5mvKq+fQG/HUNbj8d7ZNSJmRoFW6mI+X+QL3g3oEcWkhrodaH0un/u5JbTF+iqeqe1nAJQdTV0jU094e46N7WQDQtNH185vb39/UY9mRTxg3HMjN2tuwmj+uvZ2Tg7DqlJf0DY/qcn3lG45ZWyB8HTTlXf48+9CUZ2Oq9T7yvw9mfl2HvvCuiYc+laA9Xqh1xN8arX4OdNuHgG0zWcn5jjVrd47KHviv3knl5i1GXqBpbtpj4RUVmU5SUKK4O9q5UT3n0Rk0Nal68uH7j5Su3mz0GbpmZL15mZrj58o1fqPsOlxsT0H8Yxh0+CUyOUwyhf0n02w9dBVyH/3Xwe/v/yUn4rgHOh7o63O6sT/5vh1dv8r0DOGTS78+Qz3MZtwtGXJp61L7UhlD4bOfzRE1TVEEnfV9kdrwzL/xux/s6+Omu5V9pWPc2S3IWrj39GnruxIoWuHxU0Hott/ye5y6NlhJGb6WHpdCOkKpgwL+MIqxHjf6j9BDS2TCg/Rg1M/ST10T6VuahT2OhuFjoqXkozTuDQIzkU5M6aUkRfEEaPyPCS7QP0zEKthkw0rp2jW2wv01Z11dn9LE6nuj6MvyK/QbsZ8+0jAb0jP7sHhB5Ouck+hebFhOKLeO93fOFf3PoDGNctgaj013DODdq0G3w25fHa+DxfH+X/6NWbjryTLPUdxLi+FsPlqhGs6B/c59S1l6pKnoQ8BLY241zHJO/+OtwAQDgL2aZaA3AT1hCCgPg66QuUjQAL/Oo+U+wfrudM2liNtNscuBdfFKu0mFAlnUYuwjjKCklRkmUvWyU/hmy2WyWm7WazaJCzfaWeawhE9ZFLT1kbg85kHMYRWgUKXYTRe+suVarWTOYXyjpC6nLEHoI/JmeRRpzCpXYa1O4k+dHzGyaudWheiIfKeYWfocn83SLxaLYUQqUUmya873zXlDunzFQxLKZtrJY+FdnA+S0QAYbbnM0Oy6J6Nr1Hbm3qgU/6w/zaeJMxqMcKfZ4B+mbp5pUO+Gh+zOMqwhUtCsrhVeRydNNZhWqZ4EujW5jxTTXKt41UvBtzUaxXY/lvno1g+SNSOdQMXSOj6fKj3JgNjhKKIpyDOds49jYJIvmqblAsafGHe+IFNkd73njKiiPZVlfO+vq6Uoczf4wa+0BbsxMg3GzrgyIRBymmCc7zEg+yrj2Ile/tLTUKvUvIyqZ0Fa75JmFutBlqHvH1szEiNGwLh6FiDsiKdKtQspK+RbkByrcKj+KpWyR3pBM/WM3a2pleXGhJ6snkc08UkfkW2aqLSFG+WHi1Q+/tECcYeQGp/guY9G/qBrVanFksqCAAAT/Izo6VY6q37ev6jXg75tm8eil+LdXNl/iAUAFA2r3lYsC8Fqhb2trRNCKI/Zx/B9Rz8bY90VOWxNvHWf56s1uyA4tniC/xEh42AsuTFSiXTfVs/hpnTfrJErcOxkmW+ycjOMAmdkp4fKbM8jGTk0KO1/dIjbPoWgAjnEWdSLyHDsxgXpZA5nFAmR7Jx1ZPxsgFzo5XOv2MS7NZf3/9KMNa+7fua58tc571tgEfbhH5zfrfDiNInFjYR6bsX9t1PsZjrVW17roPZNzQOeRsfVrvNV6brih2EUiKXrCJhmRZuU3sHnPNawB5UODUKqpoZk6SimmBAlcVkKxxuXCaZzigStPreGqplD4oirEVMAlph4JJRsZDhyEXHTjKoYLA1ecBQf5VbpyU0FMIx/Aq2pl+1nHpSpOuXExnlYFYuooN6wOoYYTlNJcPi5nDpxCIDKoChWIwacL+C7ANCQFFxIMijgM6tCBuCJ4reKq2cxlgfMxcJAoS5hT8+HIUTajibSHoMlbb8nkCiVlFVVqqKmW2nh5tUn7n9QfV8DIXTWMV0+N/U+puhbqTo3Sa62VdEx9KMxVkHOD0+phRsViKupT8+or8ui56+/IXlwhAYBdX/FtIMwR4dX4LD34Wf7MHMrGObB4NGDz2DVAq/TcNTjY/K7erv7UWbXrdpE+RTtatYCnsfG43lyrNNu6haDwjP3gr9Xte89h4uJVwmOy953fc3/QC6hgczMAAA==);
}

@media (prefers-color-scheme: dark) {
  body,
  [data-theme="dark"] {
    color-scheme: dark;
    --color-bg: #0d1117;
    --color-bg-subtle: #161b22;
    --color-fg:  #e6edf3;
    --color-link-fg: #2f81f7;
    --color-border: #30363d;
    --color-border-muted: #21262d;
    --color-fg-muted: #848d97;
    --color-note-fg: #2f81f7;
    --color-note-emphasis: #1f6feb;
    --color-tip-fg: #3fb950;
    --color-tip-emphasis: #238636;
    --color-warning-fg: #d29922;
    --color-warning-emphasis: #9e6a03;
    --color-attention-subtle: rgba(187,128,9,0.15);
    --color-caution-fg: #f85149;
    --color-caution-emphasis: #da3633;
    --color-important-fg: #a371f7;
    --color-important-emphasis: #8957e5;
    --color-neutral-muted: rgba(110,118,129,0.4);
    --color-progress-shadow:  #010101;
    --color-progress-shadow2: rgba(0, 0, 0, .5);
    --color-progress-bg: #363c43;
  }
}

@media (prefers-color-scheme: light) {
  body,
  [data-theme="light"] {
    color-scheme: light;
    --color-bg:  #ffffff;
    --color-bg-subtle: #f6f8fa;
    --color-fg:  #333333;
    --color-link-fg: #0969da;
    --color-border: #d0d7de;
    --color-border-muted: #d8dee4;
    --color-fg-muted: #656d76;
    --color-note-fg: #0969da;
    --color-note-emphasis: #0969da;
    --color-tip-fg: #1a7f37;
    --color-tip-emphasis: #1f883d;
    --color-warning-fg: #9a6700;
    --color-warning-emphasis: #9a6700;
    --color-attention-subtle: #fff8c5;
    --color-caution-fg: #d1242f;
    --color-caution-emphasis: #cf222e;
    --color-important-fg: #8250df;
    --color-important-emphasis: #8250df;
    --color-neutral-muted: rgba(175,184,193,0.2);
    --color-progress-shadow:  #fefefe;
    --color-progress-shadow2: rgba(0, 0, 0, .1);
    --color-progress-bg:  #efefef;
  }
}

body {
  max-width: 980px;
  margin: 16px auto;
  background-color: var(--color-bg);
}

body .markdown-body
{
  padding: 45px;
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: var(--color-fg);
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable,
.markdown-body .highlighttable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr,
.markdown-body .highlighttable {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite,
.markdown-body .highlighttable pre,
.markdown-body .highlighttable div.highlight {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td,
.markdown-body .highlighttable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: var(--color-link-fg);
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid var(--color-border);
}

.markdown-body hr::before,
.markdown-body hr::after {
  display: table;
  content: " ";
}

.markdown-body hr::after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  color: var(--color-fg-default);
  vertical-align: middle;
  background-color: var(--color-bg-subtle);
  border: solid 1px var(--color-neutral-muted);
  border-bottom-color: var(--color-neutral-muted);
  border-radius: 6px;
  box-shadow: inset 0 -1px 0 var(--color-neutral-muted);
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headerlink {
  font: normal normal 16px fontawesome-mini;
  vertical-align: middle;
  margin-left: -20px;
  float: left;
  display: inline-block;
  text-decoration: none;
  opacity: 0;
  color: var(--color-fg);
}

.markdown-body .headerlink:focus {
  outline: none;
}

.markdown-body h1 .headerlink {
  margin-top: 0.8rem;
}

.markdown-body h2 .headerlink,
.markdown-body h3 .headerlink {
  margin-top: 0.6rem;
}

.markdown-body h4 .headerlink {
  margin-top: 0.2rem;
}

.markdown-body h5 .headerlink,
.markdown-body h6 .headerlink {
  margin-top: 0;
}

.markdown-body .headerlink:hover,
.markdown-body h1:hover .headerlink,
.markdown-body h2:hover .headerlink,
.markdown-body h3:hover .headerlink,
.markdown-body h4:hover .headerlink,
.markdown-body h5:hover .headerlink,
.markdown-body h6:hover .headerlink {
  opacity: 1;
  text-decoration: none;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid var(--color-border-muted);
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid var(--color-border-muted);
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: var(--color-fg-muted);
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition,
.markdown-body details {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: var(--color-border);
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: var(--color-fg-muted);
  border-left: 4px solid var(--color-border);
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid var(--color-border-muted);
}

.markdown-body table tr {
  border-top: 1px solid var(--color-border-muted);
}

.markdown-body table tr:nth-child(2n) {
  background-color: var(--color-bg-subtle);
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  border-radius: 3px;
}

.markdown-body :not(pre) > code:not(.highlight):not(.codehilite), .markdown-body samp {
  background-color: var(--color-bg-subtle);
}

.markdown-body code::before,
.markdown-body code::after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite,
.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
}

.markdown-body .codehilite,
.markdown-body .highlight,
.markdown-body pre {
  border-radius: 3px;
}

.markdown-body :not(.highlight) > pre {
  background-color: var(--color-bg-subtle);
}

.markdown-body .codehilite pre,
.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code::before,
.markdown-body pre code::after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition,
.markdown-body details[class] {
  position: relative;
  border-left: 4px solid var(--color-fg);
  padding: 10px 10px 10px 10px;
}

.markdown-body details[class] > summary {
  list-style: none;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition > .admonition-title,
.markdown-body details[class] > summary {
  position: relative;
  font-weight: bold;
  margin: 0;
  padding-left: 20px;
}

.markdown-body .admonition-title::before,
.markdown-body details[class]> summary::before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: var(--color-fg);
  position: absolute;
  left: 0;
  top: 0;
}

.markdown-body details[class]> summary::after {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: var(--color-fg);
  position: absolute;
  right: 0;
  top: 0;
}

.markdown-body details[class] > summary::after {
  content:  "\e803";
}

.markdown-body details[class][open] > summary::after {
  content:  "\e802";
}

.markdown-body details[class] > summary::after {
  color: var(--color-fg);
}

.markdown-body details.question > summary::after,
.markdown-body details.important > summary::after,
.markdown-body details.attention > summary::after {
  color: var(--color-important-emphasis);
}

.markdown-body details.warning > summary::after {
  color: var(--color-warning-emphasis);
}

.markdown-body details.tip > summary::after,
.markdown-body details.hint > summary::after {
  color: var(--color-tip-emphasis);
}

.markdown-body details.caution > summary::after,
.markdown-body details.danger > summary::after {
  color: var(--color-caution-emphasis);
}

.markdown-body details.note > summary::after {
  color: var(--color-note-emphasis);
}

.markdown-body .admonition-title::before,
.markdown-body details[class] summary::before {
  content: "\e800\00a0";
  color: var(--color-fg);
}

.markdown-body .important > :is(.admonition-title, summary)::before,
.markdown-body .attention > :is(.admonition-title, summary)::before {
  content: "\f0f3\00a0";
  color: var(--color-important-emphasis);
}

.markdown-body .question > :is(.admonition-title, summary)::before {
  content: "\e804\00a0";
  color: var(--color-important-emphasis);
}

.markdown-body .warning > :is(.admonition-title, summary)::before {
  content: "\e801\00a0";
  color: var(--color-warning-emphasis);
}

.markdown-body .tip > :is(.admonition-title, summary)::before,
.markdown-body .hint > :is(.admonition-title, summary)::before {
  content: "\f0eb\00a0";
  color: var(--color-tip-emphasis);
}

.markdown-body .caution > :is(.admonition-title, summary)::before,
.markdown-body .danger > :is(.admonition-title, summary)::before {
  content: "\e807\00a0";
  color: var(--color-caution-emphasis);
}

.markdown-body .note > :is(.admonition-title, summary)::before {
  content: "\e800\00a0";
  color: var(--color-note-emphasis);
}

.markdown-body .admonition > :is(.admonition-title, summary)::after,
.markdown-body details::after {
  content: normal;
}

.markdown-body .question:is(.admonition, details[class]),
.markdown-body .important:is(.admonition, details[class]),
.markdown-body .attention:is(.admonition, details[class]) {
  border-left-color: var(--color-important-emphasis);
}

.markdown-body .warning:is(.admonition, details[class]) {
  border-left-color: var(--color-warning-emphasis);
}

.markdown-body .tip:is(.admonition, details[class]),
.markdown-body .hint:is(.admonition, details[class]) {
  border-left-color: var(--color-tip-emphasis);
}

.markdown-body .caution:is(.admonition, details[class]),
.markdown-body .danger:is(.admonition, details[class]) {
  border-left-color: var(--color-caution-emphasis);
}

.markdown-body .note:is(.admonition, details[class]) {
  border-left-color: var(--color-note-emphasis);
}

.markdown-body .admonition>*:first-child,
.markdown-body details[class]>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child,
.markdown-body details[class]>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: var(--color-progress-bg);
  position: relative;
  box-shadow: inset -1px 1px 3px var(--color-progress-shadow2);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: var(--color-fg);
  text-shadow: 1px 1px 0 var(--color-progress-shadow), -1px -1px 0 var(--color-progress-shadow), -1px 1px 0 var(--color-progress-shadow),
               1px -1px 0 var(--color-progress-shadow), 0 1px 0 var(--color-progress-shadow), 0 -1px 0 var(--color-progress-shadow),
               1px 0 0 var(--color-progress-shadow), -1px 0 0 var(--color-progress-shadow), 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* MultiMarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: var(--color-caution-emphasis);
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: var(--color-tip-emphasis) ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: var(--color-fg-muted);
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px fontawesome-mini;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

.markdown-body diagram-div, .markdown-body div.uml-sequence-diagram, .markdown-body, div.uml-flowchart {
  overflow: auto;
}

.markdown-body diagram-div, .markdown-body div.uml-sequence-diagram, div.uml-flowchart {
  background-color: #ffffff;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]::after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]::after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a::after,
  .markdown-body a[href^="javascript:"]::after,
  .markdown-body a[href^="#"]::after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><style>/* GitHub Dark from Pygments with igher background */
@media (prefers-color-scheme: dark) {
  body,
  [data-theme="dark"] {
  	.highlight {background-color:#161b22; color:#F8F8F2;}
		.highlight .hll { background-color: #6e7681 }
		.highlight .c { color: #8B949E; font-style: italic } /* Comment */
		.highlight .err { color: #F85149 } /* Error */
		.highlight .esc { color: #E6EDF3 } /* Escape */
		.highlight .g { color: #E6EDF3 } /* Generic */
		.highlight .k { color: #FF7B72 } /* Keyword */
		.highlight .l { color: #A5D6FF } /* Literal */
		.highlight .n { color: #E6EDF3 } /* Name */
		.highlight .o { color: #FF7B72; font-weight: bold } /* Operator */
		.highlight .x { color: #E6EDF3 } /* Other */
		.highlight .p { color: #E6EDF3 } /* Punctuation */
		.highlight .ch { color: #8B949E; font-style: italic } /* Comment.Hashbang */
		.highlight .cm { color: #8B949E; font-style: italic } /* Comment.Multiline */
		.highlight .cp { color: #8B949E; font-weight: bold; font-style: italic } /* Comment.Preproc */
		.highlight .cpf { color: #8B949E; font-style: italic } /* Comment.PreprocFile */
		.highlight .c1 { color: #8B949E; font-style: italic } /* Comment.Single */
		.highlight .cs { color: #8B949E; font-weight: bold; font-style: italic } /* Comment.Special */
		.highlight .gd { color: #FFA198; background-color: #490202 } /* Generic.Deleted */
		.highlight .ge { color: #E6EDF3; font-style: italic } /* Generic.Emph */
		.highlight .ges { color: #E6EDF3; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
		.highlight .gr { color: #FFA198 } /* Generic.Error */
		.highlight .gh { color: #79C0FF; font-weight: bold } /* Generic.Heading */
		.highlight .gi { color: #56D364; background-color: #0F5323 } /* Generic.Inserted */
		.highlight .go { color: #8B949E } /* Generic.Output */
		.highlight .gp { color: #8B949E } /* Generic.Prompt */
		.highlight .gs { color: #E6EDF3; font-weight: bold } /* Generic.Strong */
		.highlight .gu { color: #79C0FF } /* Generic.Subheading */
		.highlight .gt { color: #FF7B72 } /* Generic.Traceback */
		.highlight .g-Underline { color: #E6EDF3; text-decoration: underline } /* Generic.Underline */
		.highlight .kc { color: #79C0FF } /* Keyword.Constant */
		.highlight .kd { color: #FF7B72 } /* Keyword.Declaration */
		.highlight .kn { color: #FF7B72 } /* Keyword.Namespace */
		.highlight .kp { color: #79C0FF } /* Keyword.Pseudo */
		.highlight .kr { color: #FF7B72 } /* Keyword.Reserved */
		.highlight .kt { color: #FF7B72 } /* Keyword.Type */
		.highlight .ld { color: #79C0FF } /* Literal.Date */
		.highlight .m { color: #A5D6FF } /* Literal.Number */
		.highlight .s { color: #A5D6FF } /* Literal.String */
		.highlight .na { color: #E6EDF3 } /* Name.Attribute */
		.highlight .nb { color: #E6EDF3 } /* Name.Builtin */
		.highlight .nc { color: #F0883E; font-weight: bold } /* Name.Class */
		.highlight .no { color: #79C0FF; font-weight: bold } /* Name.Constant */
		.highlight .nd { color: #D2A8FF; font-weight: bold } /* Name.Decorator */
		.highlight .ni { color: #FFA657 } /* Name.Entity */
		.highlight .ne { color: #F0883E; font-weight: bold } /* Name.Exception */
		.highlight .nf { color: #D2A8FF; font-weight: bold } /* Name.Function */
		.highlight .nl { color: #79C0FF; font-weight: bold } /* Name.Label */
		.highlight .nn { color: #FF7B72 } /* Name.Namespace */
		.highlight .nx { color: #E6EDF3 } /* Name.Other */
		.highlight .py { color: #79C0FF } /* Name.Property */
		.highlight .nt { color: #7EE787 } /* Name.Tag */
		.highlight .nv { color: #79C0FF } /* Name.Variable */
		.highlight .ow { color: #FF7B72; font-weight: bold } /* Operator.Word */
		.highlight .pm { color: #E6EDF3 } /* Punctuation.Marker */
		.highlight .w { color: #6E7681 } /* Text.Whitespace */
		.highlight .mb { color: #A5D6FF } /* Literal.Number.Bin */
		.highlight .mf { color: #A5D6FF } /* Literal.Number.Float */
		.highlight .mh { color: #A5D6FF } /* Literal.Number.Hex */
		.highlight .mi { color: #A5D6FF } /* Literal.Number.Integer */
		.highlight .mo { color: #A5D6FF } /* Literal.Number.Oct */
		.highlight .sa { color: #79C0FF } /* Literal.String.Affix */
		.highlight .sb { color: #A5D6FF } /* Literal.String.Backtick */
		.highlight .sc { color: #A5D6FF } /* Literal.String.Char */
		.highlight .dl { color: #79C0FF } /* Literal.String.Delimiter */
		.highlight .sd { color: #A5D6FF } /* Literal.String.Doc */
		.highlight .s2 { color: #A5D6FF } /* Literal.String.Double */
		.highlight .se { color: #79C0FF } /* Literal.String.Escape */
		.highlight .sh { color: #79C0FF } /* Literal.String.Heredoc */
		.highlight .si { color: #A5D6FF } /* Literal.String.Interpol */
		.highlight .sx { color: #A5D6FF } /* Literal.String.Other */
		.highlight .sr { color: #79C0FF } /* Literal.String.Regex */
		.highlight .s1 { color: #A5D6FF } /* Literal.String.Single */
		.highlight .ss { color: #A5D6FF } /* Literal.String.Symbol */
		.highlight .bp { color: #E6EDF3 } /* Name.Builtin.Pseudo */
		.highlight .fm { color: #D2A8FF; font-weight: bold } /* Name.Function.Magic */
		.highlight .vc { color: #79C0FF } /* Name.Variable.Class */
		.highlight .vg { color: #79C0FF } /* Name.Variable.Global */
		.highlight .vi { color: #79C0FF } /* Name.Variable.Instance */
		.highlight .vm { color: #79C0FF } /* Name.Variable.Magic */
		.highlight .il { color: #A5D6FF } /* Literal.Number.Integer.Long */
  }
}

/* Taken from github.css */
@media (prefers-color-scheme: light) {
  body,
  [data-theme="light"] {
  	.highlight {background-color:#f7f7f7;color:#333333;}
		.highlight .hll {background-color:#ffffcc;}
		.highlight .c{color:#999988;font-style:italic}
		.highlight .err{color:#a61717;background-color:#e3d2d2}
		.highlight .k{font-weight:bold}
		.highlight .o{font-weight:bold}
		.highlight .cm{color:#999988;font-style:italic}
		.highlight .cp{color:#999999;font-weight:bold}
		.highlight .c1{color:#999988;font-style:italic}
		.highlight .cs{color:#999999;font-weight:bold;font-style:italic}
		.highlight .gd{color:#000000;background-color:#ffdddd}
		.highlight .ge{font-style:italic}
		.highlight .gr{color:#aa0000}
		.highlight .gh{color:#999999}
		.highlight .gi{color:#000000;background-color:#ddffdd}
		.highlight .go{color:#888888}
		.highlight .gp{color:#555555}
		.highlight .gs{font-weight:bold}
		.highlight .gu{color:#800080;font-weight:bold}
		.highlight .gt{color:#aa0000}
		.highlight .kc{font-weight:bold}
		.highlight .kd{font-weight:bold}
		.highlight .kn{font-weight:bold}
		.highlight .kp{font-weight:bold}
		.highlight .kr{font-weight:bold}
		.highlight .kt{color:#445588;font-weight:bold}
		.highlight .m{color:#009999}
		.highlight .s{color:#dd1144}
		.highlight .n{color:#333333}
		.highlight .na{color:teal}
		.highlight .nb{color:#0086b3}
		.highlight .nc{color:#445588;font-weight:bold}
		.highlight .no{color:teal}
		.highlight .ni{color:purple}
		.highlight .ne{color:#990000;font-weight:bold}
		.highlight .nf{color:#990000;font-weight:bold}
		.highlight .nn{color:#555555}
		.highlight .nt{color:navy}
		.highlight .nv{color:teal}
		.highlight .ow{font-weight:bold}
		.highlight .w{color:#bbbbbb}
		.highlight .mf{color:#009999}
		.highlight .mh{color:#009999}
		.highlight .mi{color:#009999}
		.highlight .mo{color:#009999}
		.highlight .sb{color:#dd1144}
		.highlight .sc{color:#dd1144}
		.highlight .sd{color:#dd1144}
		.highlight .s2{color:#dd1144}
		.highlight .se{color:#dd1144}
		.highlight .sh{color:#dd1144}
		.highlight .si{color:#dd1144}
		.highlight .sx{color:#dd1144}
		.highlight .sr{color:#009926}
		.highlight .s1{color:#dd1144}
		.highlight .ss{color:#990073}
		.highlight .bp{color:#999999}
		.highlight .vc{color:teal}
		.highlight .vg{color:teal}
		.highlight .vi{color:teal}
		.highlight .il{color:#009999}
		.highlight .gc{color:#999;background-color:#EAF2F5}
  }
}
</style><title>GIGAROADMAP</title></head><body><article class="markdown-body"><h1 id="pairofcleats-gigaroadmap">PairOfCleats GigaRoadmap<a class="headerlink" href="#pairofcleats-gigaroadmap" title="Permanent link"></a></h1>
<pre><code>## Status legend

Checkboxes represent the state of the work, update them to reflect the state of work as its being done:
- [x] Implemented and appears complete/correct based on code inspection and existing test coverage
- [@] In Progress, this work has been started
- [.] Work has been completed but has Not been tested
- [?] There is a correctness gap **or** there is missing/insufficient test proving behavior
- [ ] Not complete

Completed Phases: `COMPLETED_PHASES.md`
</code></pre>
<h2 id="roadmap-list">Roadmap List<a class="headerlink" href="#roadmap-list" title="Permanent link"></a></h2>
<h3 id="foundational">Foundational<a class="headerlink" href="#foundational" title="Permanent link"></a></h3>
<ul>
<li>Phase R &ndash; Make Monoliths Modular, My Man</li>
<li>Phase 6 &ndash; Finalization of Past Work</li>
<li>Phase 7 &ndash; Embeddings + ANN: Determinism, Policy, and Backend Parity<ul>
<li>7.1 - Build-scoped embeddings jobs and Best-Effort Enqueue Semantics</li>
<li>7.2 - Embeddings Artifact Contract and Explicit Capability Signaling</li>
<li>7.3 - Quantization Invariants</li>
<li>7.4 - Normalization Policy Consistency Across Build Paths and Query-Time ANN</li>
<li>7.5 - LanceDB ANN correctness and resilience</li>
<li>7.6 - HNSW ANN correctness, compatibility, and failure observability</li>
<li>7.7 - ANN Backend Policy and Parity </li>
<li>7.8 - Backend Storage Resilience Required by Embeddings/ANN Workflows</li>
</ul>
</li>
<li>Phase 9 &ndash; Symbol Identity + Cross-File Linking<ul>
<li>9.1 - Verify Identity Primitives </li>
<li>9.2 - Symbol Identity <ul>
<li>9.2.1 Implement Symbol Identity Helpers</li>
<li>9.2.2 Attach <code>metaV2.symbol</code></li>
</ul>
</li>
<li>9.3 - Import Bindings + resolver<ul>
<li>9.3.1 Emit <code>importBindings</code> in <code>file_relations</code></li>
<li>9.3.2 Relative Import Resolver Helper</li>
<li>9.3.3 SymbolRef Resolver</li>
<li>9.3.4 Tests</li>
</ul>
</li>
<li>9.4 - Cross-file Linking Pipeline <ul>
<li>9.4.1 Replace <code>file::name</code> Join Logic with SymbolRef resolution</li>
<li>9.4.2 Emit new-format <code>callLinks</code> and <code>usageLinks</code></li>
<li>9.4.3 Keep <code>callSummaries</code>, but add resolved IDs where possible</li>
<li>9.4.4 Tooling Provider Audit</li>
<li>9.4.5 Pipeline Tests</li>
</ul>
</li>
<li>9.5 - Symbol Graph Artifacts<ul>
<li>9.5.1 Writers</li>
<li>9.5.2 Artifact Integration</li>
</ul>
</li>
<li>9.6 - Graph Building<ul>
<li>9.6.1 Update Graph Builder to ingest SymbolRef links</li>
<li>9.6.2 Version Bump</li>
</ul>
</li>
<li>9.7 - Map Build (stop using <code>file::name</code> as member identity)<ul>
<li>9.7.1 Member ID Strategy</li>
<li>9.7.2 Backward Compatibility</li>
</ul>
</li>
<li>9.8 - Determinism + throughput<ul>
<li>9.8.2 Throughput Checks</li>
</ul>
</li>
</ul>
</li>
<li>Phase 10 &ndash; Interprocedural Risk Flows<ul>
<li>10.1 - Configuration + Runtime Wiring</li>
<li>10.2 - Contract Hardening Prerequisites</li>
<li>10.3 - Risk Summaries</li>
<li>10.4 - Call-Site Sampling + <code>call_sites.jsonl</code></li>
<li>10.5 - Propagation engine + <code>risk_flows.jsonl</code></li>
<li>10.6 - Artifact writing, Sharding, Validation, &amp; determinism (E2E)</li>
<li>10.7 - Explainability Tooling (CLI)</li>
<li>10.8 - End-to-End Test Matrix &amp; Performance Guardrails</li>
<li>10.A - Risk Interprocedural Config Spec </li>
<li>10.B - <code>risk_summaries.jsonl</code> Spec </li>
<li>10.C - <code>risk_flows.jsonl</code> + <code>call_sites.jsonl</code> Spec </li>
<li>10.D - <code>risk_interprocedural_stats.json</code> Spec </li>
<li>10.E &ndash; Implementation Notes </li>
</ul>
</li>
</ul>
<h3 id="features">Features<a class="headerlink" href="#features" title="Permanent link"></a></h3>
<ul>
<li>Phase 11 &ndash; Graph-Powered Product Features (context packs, impact, explainability, ranking)<ul>
<li>11.1 - Graph Context Packs (bounded neighborhood extraction) + retrieval context-expansion hardening</li>
<li>11.2 - Impact Analysis (callers/callees + k-hop impact radius) with witness paths</li>
<li>11.3 - Context Pack Assembly for Tooling/LLM (chunk text + graph + types + risk) + explainability rendering</li>
<li>11.4 - Graph-Aware Ranking Hooks (opt-in) + Explainability</li>
<li>11.5 - Graph Expansion Caps as a Config Surface + Calibration Harness (language × size tier)</li>
<li>11.6 - Cross-file API Contracts (report + optional artifact)</li>
<li>11.7 - Architecture Slicing &amp; Boundary Enforcement </li>
<li>11.8 - Test Selection Heuristics </li>
</ul>
</li>
<li>Phase 12 &ndash; MCP Migration + API/Tooling Contract Formalization<ul>
<li>12.1 - Dependency strategy and Capability Pating for the Official MCP SDK</li>
<li>12.2 - SDK-backed MCP server (Parallel Mode with Explicit Cutover Flag)</li>
<li>12.3 - Tool Schema Versioning, Conformance, and Drift Guards</li>
<li>12.4 - Error codes, Protocol Negotiation, and Response-Shape Consistency</li>
<li>12.5 - Cancellation, Timeouts, and Process Hygiene</li>
<li>12.6 - Documentation and Migration Notes</li>
</ul>
</li>
<li>Phase 13 &ndash; JJ Support (via Provider API)<ul>
<li>13.1 - Introduce <code>ScmProvider</code> Interface + Registry + Config/State Schema Wiring</li>
<li>13.2 - Migrate Git onto the Provider Interface</li>
<li>13.3 - Implement JJ Provider (read-only default, robust parsing)</li>
<li>13.4 - CLI + Tooling Visibility (make SCM selection obvious)</li>
<li>13.5 - Non-Repo Environments (explicitly supported)</li>
</ul>
</li>
<li>Phase 14 &ndash; Incremental Diffing &amp; Snapshots (Time Travel, Regression Debugging)<ul>
<li>14.1 - Snapshot &amp; Diff Artifact Surface (contracts, retention, safety)</li>
<li>14.2 - Pointer Snapshots (creation, validation gating, CLI/API)</li>
<li>14.3 - Frozen Snapshots (immutable copies + integrity verification)</li>
<li>14.4 - Deterministic Diff Computation (bounded, machine-readable)</li>
<li>14.5 - Retrieval + Tooling Integration: “as-of” snapshots and “what changed” surfaces</li>
</ul>
</li>
<li>Phase 15 &ndash; Federation &amp; Multi-Repo (Workspaces, Catalog, Federated Search)</li>
<li>Phase 16 &ndash; Prose Ingestion + Retrieval Routing Correctness (PDF/DOCX + FTS policy)</li>
<li>Phase 17 &ndash; Vector-Only Profile (Embeddings-First, Build + Search w/o Sparse Postings)</li>
<li>Phase 20 &ndash; Distribution &amp; Platform Hardening (Release Matrix, Packaging, &amp; Optional Python)</li>
</ul>
<h4 id="recommended-parallel-implementation-lanes">Recommended Parallel Implementation Lanes<a class="headerlink" href="#recommended-parallel-implementation-lanes" title="Permanent link"></a></h4>
<ul>
<li>Lane A: Phase R (refactoring monoliths)</li>
<li>Lane B: Phase 6 Finalization (tests and cleanup, should be quick)</li>
<li>Lane C: Phase 7 (shotgun)</li>
<li>Lane D: Phase 9.1 → 9.2 + 9.3 → 9.4 → 9.5/9.6 → 9.7 → 9.8 (heavily sequential)</li>
<li>Lane E: Phase 10.1 early; 10.2+ only after we have call_sites + chunkUid + chunkUid graph</li>
</ul>
<hr />
<h2 id="phase-r-make-monoliths-modular-my-man">Phase R &ndash; Make Monoliths Modular, My Man<a class="headerlink" href="#phase-r-make-monoliths-modular-my-man" title="Permanent link"></a></h2>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>REFACT.md</code> Has a list of refactor targets and almost-finished work</li>
<li class="task-list-item"><input type="checkbox" disabled/> There are ~5-6 Monoliths left to refactor down into modules</li>
<li class="task-list-item"><input type="checkbox" disabled/> Once complete, scan for other refactoring candidates</li>
<li class="task-list-item"><input type="checkbox" disabled/> After everything has been split up, closely evaluate splits of all module systems<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> See if similar-enough components or functionality can be lifted up and merged into more central components to eliminate repetition </li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Keep track of call sites being changed, they all must be converted and fixed/working to be able to continue!!</li>
</ul>
<h3 id="phase-r1-pakedge">Phase R.1 &ndash; Pakedge<a class="headerlink" href="#phase-r1-pakedge" title="Permanent link"></a></h3>
<p><code>package.json</code> is gross dude.
- We don&rsquo;t need to be surfacing tools like this anymore
- It&rsquo;s fine to just call <code>node thescript</code>
- Determine List of Kept Commands
- Delete The Rest, Lint, Run All Tests, Fix any broken shit
- Write new policy gating what can be added to package json</p>
<h3 id="phase-r2-cleanup">Phase R.2 &ndash; Cleanup<a class="headerlink" href="#phase-r2-cleanup" title="Permanent link"></a></h3>
<ul>
<li>Agents.md should be updated with more comprehensive information about docs subfolders</li>
<li>We should some sort of lightweight script that maps documentation to tags</li>
<li>And create a set of tests that will not pass until documents have been updated to reflect changes so that drift can be avoided</li>
<li>Let&rsquo;s go through the repo and look at the files that have gone the longest without being modified</li>
<li>And the files that have changed the least since they&rsquo;ve been added</li>
<li>And then probably remove them</li>
</ul>
<h2 id="phase-6-finalization">Phase 6  &ndash; Finalization<a class="headerlink" href="#phase-6-finalization" title="Permanent link"></a></h2>
<p>This work may already be done! Look around for it a little before you implement it yourself. </p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/vfs/virtual-path-stability.test.js</code> </li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/vfs/vfs-manifest-roundtrip.test.js</code> </li>
<li class="task-list-item"><input type="checkbox" disabled/> Verify that validation runs in CI lanes that already validate artifact schemas.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a determinism test<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Rebuilds twice</li>
<li class="task-list-item"><input type="checkbox" disabled/> Asserts the <code>call_sites</code> content is at least line-identical for a fixed fixture repo</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>metaV2</code> consistency after post-processing that mutates docmeta/relations.<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Sweep integration: cross-file inference mutates <code>docmeta</code>/<code>codeRelations</code> after <code>metaV2</code> is built.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Evaluate how metav2 is handled, is there a finalization pass or is it gathered lazy at write time? Explain this</li>
<li>If this is already solved by an earlier contract phase, add a verification test to prevent regressions.</li>
</ul>
</li>
</ul>
<h2 id="phase-7-embeddings-ann-determinism-policy-parity">Phase 7 &ndash; Embeddings + ANN: Determinism, Policy, Parity<a class="headerlink" href="#phase-7-embeddings-ann-determinism-policy-parity" title="Permanent link"></a></h2>
<h3 id="objective">Objective<a class="headerlink" href="#objective" title="Permanent link"></a></h3>
<ul>
<li>Make embeddings generation &amp; ANN retrieval:<ul>
<li><strong>Deterministic</strong> </li>
<li><strong>Build-scoped</strong></li>
<li><strong>Policy-driven</strong> across all supported backends:<ul>
<li>HNSW</li>
<li>LanceDB</li>
<li>SQLite dense</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This phase hardens the end-to-end lifecycle:</p>
<ul>
<li>Embeddings are <strong>optional</strong>, but when enabled they are <strong>contracted</strong>, discoverable, and validated.</li>
<li>Embeddings jobs are <strong>bound to a specific build output</strong> (no implicit &ldquo;current build&rdquo; writes).</li>
<li>Quantization/normalization rules are <strong>consistent</strong> across tools, caches, and query-time ANN.</li>
<li>ANN backends behave predictably under real-world constraints (candidate filtering, partial failure, missing deps).</li>
</ul>
<h3 id="exit-criteria">Exit Criteria<a class="headerlink" href="#exit-criteria" title="Permanent link"></a></h3>
<ul>
<li>Embeddings can be <strong>disabled</strong> without breaking builds, validation, or CI.</li>
<li>When embeddings are enabled, artifacts are <strong>consistent, validated, and build-scoped</strong> (no cross-build contamination).</li>
<li>HNSW and LanceDB ANN results are <strong>stable and correctly ranked</strong>, with clear selection/availability signaling.</li>
<li>CI can run without optional native deps (e.g., LanceDB) using an explicit <strong>skip protocol</strong>, while still providing meaningful ANN coverage where possible.</li>
</ul>
<hr />
<h3 id="phase-71-build-scoped-embeddings-jobs-and-best-effort-enqueue-semantics">Phase 7.1 &ndash; Build-scoped embeddings jobs and best-effort enqueue semantics<a class="headerlink" href="#phase-71-build-scoped-embeddings-jobs-and-best-effort-enqueue-semantics" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Bind embeddings jobs to an explicit build output target (no &ldquo;current build&rdquo; inference).</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend the embedding job payload to include an immutable provenance tuple and target paths:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>buildId</code> and <code>buildRoot</code> (or an explicit <code>indexRoot</code>) for the build being augmented.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>mode</code> (<code>code</code> / <code>prose</code>) and the exact <code>indexDir</code> (the per-mode output directory) the job must write into.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>configHash</code> (or equivalent) used to build the base index.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repoProvenance</code> snapshot (at minimum: repo path + commit/branch if available).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>embeddingIdentity</code> + <code>embeddingIdentityKey</code> (already present in queue schema; ensure always populated).</li>
<li class="task-list-item"><input type="checkbox" disabled/> A monotonically increasing <code>embeddingPayloadFormatVersion</code> that gates behavior.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>src/index/build/indexer/pipeline.js</code> to pass build-scoped paths into <code>enqueueEmbeddingJob(...)</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>src/index/build/indexer/embedding-queue.js</code> to accept and forward these fields.</li>
<li>Touchpoints:<ul>
<li><code>src/index/build/indexer/pipeline.js</code></li>
<li><code>src/index/build/indexer/embedding-queue.js</code></li>
<li><code>tools/service/queue.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Make embedding job enqueue best-effort when embeddings are configured as a service.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Wrap queue-dir creation and <code>enqueueJob(...)</code> in a non-fatal path when <code>runtime.embeddingService === true</code>.<ul>
<li>If enqueue fails, log a clear warning and continue indexing.</li>
<li>Ensure indexing does <strong>not</strong> fail due solely to queue I/O failures.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Record &ldquo;embeddings pending/unavailable&rdquo; state in <code>index_state.json</code> when enqueue fails.</li>
<li>Touchpoints:<ul>
<li><code>src/index/build/indexer/embedding-queue.js</code></li>
<li><code>src/index/build/indexer/steps/write.js</code> (state recording)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Ensure the embeddings worker/runner honors build scoping.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Update the embeddings job runner (currently <code>tools/indexer-service.js</code>) so <code>build-embeddings</code> is executed with an explicit <code>--index-root</code> (or equivalent) derived from the job payload.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add defensive checks: if job payload references a missing buildRoot/indexDir, the job must fail without writing output.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add backwards compatibility behavior for old jobs:<ul>
<li>If <code>embeddingPayloadFormatVersion</code> is missing/old, either refuse the job with a clear error <strong>or</strong> run in legacy mode but emit a warning.</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>tools/indexer-service.js</code></li>
<li><code>tools/build-embeddings/cli.js</code> (ensuring <code>--index-root</code> is usable everywhere)</li>
</ul>
</li>
</ul>
<p>#### Tests / Verification</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/embeddings/job-payload-includes-buildroot.test.js</code><ul>
<li>Verify queue job JSON includes <code>buildId</code>, <code>buildRoot</code>/<code>indexRoot</code>, <code>indexDir</code>, <code>configHash</code>, and embedding identity fields.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/embeddings/optional-no-service.test.js</code><ul>
<li>Simulate missing/unwritable queue dir and assert indexing still succeeds with embeddings marked pending/unavailable.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/embeddings/worker-refuses-mismatched-buildroot.test.js</code><ul>
<li>Provide a job with an invalid/nonexistent target path and assert the runner fails without producing/altering embeddings artifacts.</li>
</ul>
</li>
</ul>
<hr />
<h3 id="phase-72-embeddings-artifact-contract-and-explicit-capability-signaling">Phase 7.2 &ndash; Embeddings artifact contract and explicit capability signaling<a class="headerlink" href="#phase-72-embeddings-artifact-contract-and-explicit-capability-signaling" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Define the canonical &ldquo;embeddings artifacts&rdquo; contract and make it discoverable.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Treat the existing dense-vector outputs as the formal embeddings artifact surface:<ul>
<li><code>dense_vectors_uint8.json</code> (+ any per-mode variants)</li>
<li><code>dense_vectors_hnsw.bin</code> + <code>dense_vectors_hnsw.meta.json</code></li>
<li><code>dense_vectors_lancedb/</code> + <code>dense_vectors_lancedb.meta.json</code></li>
<li>Optional SQLite dense tables when enabled (<code>dense_vectors</code>, <code>dense_meta</code>, and ANN table)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure embeddings artifacts are present in <code>pieces/manifest.json</code> when available and absent when not.</li>
<li>Touchpoints:<ul>
<li><code>tools/build-embeddings/manifest.js</code></li>
<li><code>src/index/build/artifacts.js</code> (piece emission rules)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Emit embedding identity and quantization policy into state and metadata, regardless of build path.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>index_state.json.embeddings</code> always includes:<ul>
<li><code>enabled</code>, <code>ready/present</code>, <code>mode</code> (inline/service), and a clear <code>reason</code> when not ready.</li>
<li><code>embeddingIdentity</code> and <code>embeddingIdentityKey</code>.</li>
<li>Backend availability summary for this build (HNSW/LanceDB/SQLite dense), including dims + metric/space where applicable.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Align <code>src/index/build/indexer/steps/write.js</code> with <code>tools/build-embeddings/run.js</code> so inline embeddings builds also include identity/key.</li>
<li>Touchpoints:<ul>
<li><code>src/index/build/indexer/steps/write.js</code></li>
<li><code>tools/build-embeddings/run.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Harden validation for embeddings presence and consistency.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend strict validation to enforce, when embeddings are present:<ul>
<li>Dense vector count matches chunk count for the mode.</li>
<li>Dimensions match across dense vectors and any ANN index metadata.</li>
<li>Model/identity metadata is internally consistent (identity key stable for that build).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> When embeddings are absent, validation should still pass but surface a clear &ldquo;embeddings not present&rdquo; indicator.</li>
<li>Touchpoints:<ul>
<li><code>src/index/validate.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Add missing-embeddings reporting (and optional gating).</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Track missing vectors during embedding build (code/doc/merged) instead of silently treating them as equivalent to an all-zero vector.<ul>
<li>Preserve existing &ldquo;fill missing with zeros&rdquo; behavior only as an internal representation, but record missing counts explicitly.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add configurable thresholds (e.g., maximum allowed missing rate) that can mark embeddings as failed/unusable for ANN.<ul>
<li>If threshold exceeded: do not publish ANN index availability and record reason in state.</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>tools/build-embeddings/embed.js</code></li>
<li><code>tools/build-embeddings/run.js</code></li>
<li><code>src/index/build/indexer/file-processor/embeddings.js</code> (if inline embeddings path participates)</li>
</ul>
</li>
</ul>
<h4 id="tests-verification">Tests / Verification<a class="headerlink" href="#tests-verification" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/validate/embeddings-referential-integrity.test.js</code></li>
<li>Corrupt dense vector count or dims and assert strict validation fails with a clear error.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/validate/embeddings-optional-absence.test.js</code></li>
<li>Validate an index without embeddings artifacts and assert validation passes with a &ldquo;not present&rdquo; signal.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/embeddings/missing-rate-gating.test.js</code></li>
<li>Force a controlled missing-vector rate and assert state/reporting reflects the gating outcome.</li>
</ul>
<hr />
<h3 id="phase-73-quantization-invariants-levels-clamp-safe-dequantization-no-uint8-wrap">Phase 7.3 &ndash; Quantization invariants (levels clamp, safe dequantization, no uint8 wrap)<a class="headerlink" href="#phase-73-quantization-invariants-levels-clamp-safe-dequantization-no-uint8-wrap" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Enforce <code>levels ∈ [2, 256]</code> everywhere for uint8 embeddings.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Clamp in quantization parameter resolution:<ul>
<li>Update <code>src/storage/sqlite/vector.js: resolveQuantizationParams()</code> to clamp levels into <code>[2, 256]</code>.</li>
<li>Emit a warning when user config requests <code>levels &gt; 256</code> (explicitly noting coercion).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Clamp at the quantizer:<ul>
<li>Update <code>src/shared/embedding-utils.js: quantizeEmbeddingVector()</code> to mirror clamping (or route callers to <code>quantizeEmbeddingVectorUint8</code>).</li>
<li>Ensure no code path can produce values outside <code>[0, 255]</code> for &ldquo;uint8&rdquo; vectors.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Fix call sites that currently risk wrap:<ul>
<li><code>src/index/embedding.js</code> (<code>quantizeVec</code>) and its downstream usage in incremental updates.</li>
<li><code>src/storage/sqlite/build/incremental-update.js</code> packing paths.</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>src/shared/embedding-utils.js</code></li>
<li><code>src/storage/sqlite/vector.js</code></li>
<li><code>src/index/embedding.js</code></li>
<li><code>src/storage/sqlite/build/incremental-update.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Fix dequantization safety and parameter propagation.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>dequantizeUint8ToFloat32(...)</code> to avoid division-by-zero when <code>levels &lt;= 1</code> and to use clamped params.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Thread quantization params into LanceDB writer:<ul>
<li>Update <code>tools/build-embeddings/lancedb.js: writeLanceDbIndex({ ..., quantization })</code>.</li>
<li>Call <code>dequantizeUint8ToFloat32(vec, minVal, maxVal, levels)</code> (no defaults).</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>src/storage/sqlite/vector.js</code></li>
<li><code>tools/build-embeddings/lancedb.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Regression protection for embedding vector merges.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>mergeEmbeddingVectors(code, doc)</code> does not incorrectly dampen single-source vectors.<ul>
<li>If this is already fixed earlier, add/keep a regression test here (this phase modifies embedding utilities heavily).</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>src/shared/embedding-utils.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Decide and document endianness portability for packed integer buffers.</strong></li>
<li>Current pack/unpack helpers rely on platform endianness.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Either:<ul>
<li>Implement fixed-endian encoding/decoding with backward compatibility, <strong>or</strong></li>
<li>Explicitly record endianness in metadata and defer full portability to a named follow-on phase.</li>
</ul>
</li>
<li>Deferred (if not fully addressed here): <strong>Phase 11 &ndash; Index Portability &amp; Migration Tooling</strong>.</li>
</ul>
<h4 id="tests-verification_1">Tests / Verification<a class="headerlink" href="#tests-verification_1" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/unit/quantization-levels-clamp.test.js</code></li>
<li>Pass <code>levels: 512</code> and assert it clamps to <code>256</code> (and logs a warning).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/unit/dequantize-levels-safe.test.js</code></li>
<li>Call dequantization with <code>levels: 1</code> and assert no crash and sane output.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/regression/incremental-update-quantize-no-wrap.test.js</code></li>
<li>Ensure packed uint8 values never wrap for large <code>levels</code> inputs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend <code>tests/lancedb-ann.js</code> to run with non-default quantization params and verify ANN still functions.</li>
</ul>
<hr />
<h3 id="phase-74-normalization-policy-consistency-across-build-paths-and-query-time-ann">Phase 7.4 &ndash; Normalization policy consistency across build paths and query-time ANN<a class="headerlink" href="#phase-74-normalization-policy-consistency-across-build-paths-and-query-time-ann" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Centralize normalization policy and apply it everywhere vectors enter ANN.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Create a shared helper that defines normalization expectations for embeddings (index-time and query-time).<ul>
<li>Prefer deriving this from <code>embeddingIdentity.normalize</code> to ensure build outputs and query behavior remain compatible.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Apply consistently:<ul>
<li>Fresh build path (<code>tools/build-embeddings/embed.js</code>).</li>
<li>Cached build path (<code>tools/build-embeddings/run.js</code>).</li>
<li>Query-time ANN (HNSW provider via <code>src/shared/hnsw.js</code> and/or the embedder).</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>src/shared/embedding-utils.js</code> (or a new shared policy module)</li>
<li><code>tools/build-embeddings/embed.js</code></li>
<li><code>tools/build-embeddings/run.js</code></li>
<li><code>src/shared/hnsw.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Normalize persisted per-component vectors when they are intended for retrieval.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>embed_code_u8</code> and <code>embed_doc_u8</code> are quantized from normalized vectors (or explicitly mark them as non-retrieval/debug-only and keep them out of ANN pathways).</li>
<li>Touchpoints:<ul>
<li><code>tools/build-embeddings/embed.js</code></li>
</ul>
</li>
</ul>
<h4 id="tests-verification_2">Tests / Verification<a class="headerlink" href="#tests-verification_2" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/unit/normalization-policy-consistency.test.js</code></li>
<li>Assert fresh vs cached paths produce equivalent normalized vectors for the same input.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/integration/hnsw-rebuild-idempotent.test.js</code></li>
<li>Build embeddings twice (cache hit vs miss) and assert stable ANN outputs for a fixed query set.</li>
</ul>
<hr />
<h3 id="phase-75-lancedb-ann-correctness-and-resilience">Phase 7.5 &ndash; LanceDB ANN correctness and resilience<a class="headerlink" href="#phase-75-lancedb-ann-correctness-and-resilience" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Promise-cache LanceDB connections and tables to prevent redundant concurrent opens.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Change <code>src/retrieval/lancedb.js</code> connection/table caching to store promises, not only resolved objects.</li>
<li>Touchpoints:<ul>
<li><code>src/retrieval/lancedb.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Fix candidate-set filtering under-return so <code>topN</code> is honored.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> When candidate filtering cannot be pushed down (or is chunked), ensure the query strategy returns at least <code>topN</code> results after filtering (unless the candidate set is smaller).<ul>
<li>Options include iterative limit growth, chunked <code>IN (...)</code> pushdown + merge, or multi-pass querying.</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>src/retrieval/lancedb.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Harden <code>idColumn</code> handling and query safety.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Quote/escape <code>idColumn</code> (and any identifiers) rather than interpolating raw strings into filters.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure candidate IDs are handled safely for numeric and string identifiers.</li>
<li>Touchpoints:<ul>
<li><code>src/retrieval/lancedb.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Replace global <code>warnOnce</code> suppression with structured/rate-limited warnings.</strong></li>
<li>Avoid hiding repeated failures after the first warning.</li>
<li>Touchpoints:<ul>
<li><code>src/retrieval/lancedb.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Keep quantization parameters consistent (writer + retrieval expectations).</strong></li>
<li>This is primarily implemented via Phase 7.3, but ensure LanceDB metadata emitted from the writer is sufficient for later verification.</li>
<li>Touchpoints:<ul>
<li><code>tools/build-embeddings/lancedb.js</code></li>
<li><code>src/retrieval/cli/load-indexes.js</code> (metadata loading expectations)</li>
</ul>
</li>
</ul>
<h4 id="tests-verification_3">Tests / Verification<a class="headerlink" href="#tests-verification_3" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>tests/lancedb-ann.js</code>:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Pass <code>--ann-backend lancedb</code> explicitly.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Use skip exit code 77 when LanceDB dependency is missing.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a candidate-set test that exercises the &ldquo;pushdown disabled&rdquo; path and asserts <code>topN</code> is still achieved.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a focused unit test (or harness test) that ensures concurrent queries do not open multiple LanceDB connections.</li>
</ul>
<hr />
<h3 id="phase-76-hnsw-ann-correctness-compatibility-and-failure-observability">Phase 7.6 &ndash; HNSW ANN correctness, compatibility, and failure observability<a class="headerlink" href="#phase-76-hnsw-ann-correctness-compatibility-and-failure-observability" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Make HNSW index loading compatible with pinned <code>hnswlib-node</code> signatures.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>src/shared/hnsw.js: loadHnswIndex()</code> to call <code>readIndexSync</code> with the correct signature.<ul>
<li>If the signature differs across versions, detect via function arity and/or guarded calls.</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>src/shared/hnsw.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Verify and correct similarity mapping for <code>ip</code> and <code>cosine</code> spaces.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a small correctness harness that confirms returned distances map to expected similarity ordering.</li>
<li>Touchpoints:<ul>
<li><code>src/shared/hnsw.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Improve insertion failure observability while preserving safe build semantics.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Keep all-or-nothing index generation as the default policy.</li>
<li class="task-list-item"><input type="checkbox" disabled/> In <code>tools/build-embeddings/hnsw.js</code>:<ul>
<li>Capture insertion failures with <code>{ chunkIndex, errorMessage }</code>.</li>
<li>Throw an error that includes a concise failure summary (capped list + counts).</li>
<li>Optionally emit <code>dense_vectors_hnsw.failures.json</code> next to the index for debugging.</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>tools/build-embeddings/hnsw.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Preserve atomicity for index + metadata publication.</strong></li>
<li>Ensure meta updates remain consistent with <code>.bin</code> publication; avoid partially updated states.</li>
</ul>
<h4 id="tests-verification_4">Tests / Verification<a class="headerlink" href="#tests-verification_4" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/hnsw-insertion-failures-report.test.js</code></li>
<li>Force deterministic insertion failures and assert:<ul>
<li>Failures are reported.</li>
<li>The index is not marked available.</li>
<li>Atomic write behavior is preserved.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/hnsw-ip-similarity.test.js</code></li>
<li>Verify similarity ranking is correct for known vectors under <code>ip</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure existing <code>tests/hnsw-atomic.js</code> and <code>tests/hnsw-ann.js</code> remain stable after signature/policy updates.</li>
</ul>
<hr />
<h3 id="phase-77-ann-backend-policy-and-parity-selection-availability-explicit-tests">Phase 7.7 &ndash; ANN backend policy and parity (selection, availability, explicit tests)<a class="headerlink" href="#phase-77-ann-backend-policy-and-parity-selection-availability-explicit-tests" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Provide an explicit policy contract for ANN backend selection.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Confirm or introduce a single canonical config/CLI surface (e.g., <code>--ann-backend</code> and <code>retrieval.annBackend</code> or <code>retrieval.vectorBackend</code>).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>auto</code> selection is deterministic and based on:<ul>
<li>Backend availability for the mode (artifacts present + loadable).</li>
<li>Compatibility with the embedding identity (dims, normalize policy, metric/space).</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li>Retrieval CLI option normalization (<code>src/retrieval/cli/normalize-options.js</code>)</li>
<li>ANN provider selection (<code>src/retrieval/ann/index.js</code> and providers)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Record backend availability and the selected backend in observable state.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>index_state.json</code> captures availability for HNSW/LanceDB/SQLite dense per mode.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure query stats include the selected backend (already present as <code>annBackend</code> in several paths; make it consistent).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Make tests explicit about backend choice.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>tests/lancedb-ann.js</code> (see Phase 7.5).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure any other ANN tests pass an explicit backend flag to prevent policy drift from breaking intent.</li>
</ul>
<h4 id="tests-verification_5">Tests / Verification<a class="headerlink" href="#tests-verification_5" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/ann-backend-selection-fallback.test.js</code></li>
<li>Validate <code>auto</code> chooses the expected backend when one is missing/unavailable.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/ann-backend-selection-explicit.test.js</code></li>
<li>Validate explicit selection fails clearly (or falls back if policy allows) when requested backend is unavailable.</li>
</ul>
<hr />
<h3 id="phase-78-backend-storage-resilience-required-by-embeddingsann-workflows">Phase 7.8 &ndash; Backend storage resilience required by embeddings/ANN workflows<a class="headerlink" href="#phase-78-backend-storage-resilience-required-by-embeddingsann-workflows" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>LMDB map size planning for predictable index builds.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Add config support and defaults:<ul>
<li><code>indexing.lmdb.mapSizeBytes</code> with a sane default and override.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Estimate required map size from corpus characteristics (with headroom), and log the chosen size + inputs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Pass <code>mapSize</code> to LMDB <code>open()</code> in <code>tools/build-lmdb-index.js</code>.</li>
<li>Touchpoints:<ul>
<li><code>tools/build-lmdb-index.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>SQLite dense writer safety: avoid cross-mode ANN table deletion when DBs are shared.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Confirm whether SQLite dense DBs are per-mode (separate DB files) in all supported configurations.</li>
<li class="task-list-item"><input type="checkbox" disabled/> If shared DBs are possible, ensure ANN table deletes are mode-scoped:<ul>
<li>Either add a mode discriminator column and filter deletes, or use mode-specific ANN table names.</li>
</ul>
</li>
<li>Touchpoints:<ul>
<li><code>tools/build-embeddings/sqlite-dense.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Avoid O(N) cache scans during embeddings preflight.</strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Replace full-directory scans in <code>tools/build-embeddings/run.js</code> with a lightweight cache metadata file (e.g., <code>cache/index.json</code>) that records:<ul>
<li>dims, identity keys, and a small index of available cached chunks.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Keep backward compatibility by falling back to scan only when metadata is missing.</li>
<li>Touchpoints:<ul>
<li><code>tools/build-embeddings/run.js</code></li>
<li><code>tools/build-embeddings/cache.js</code></li>
</ul>
</li>
</ul>
<h4 id="tests-verification_6">Tests / Verification<a class="headerlink" href="#tests-verification_6" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/lmdb-map-size-planning.test.js</code></li>
<li>Build an LMDB index of moderate size and verify it does not fail due to map size.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/sqlite-dense-cross-mode-safety.test.js</code></li>
<li>Build both modes and rebuild one mode; verify the other mode&rsquo;s ANN data remains intact.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/embeddings/cache-preflight-metadata.test.js</code></li>
<li>Ensure preflight uses metadata without scanning when the meta file exists, and remains correct.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Unskip phase-tagged LMDB tests once Phase 7/8 deliverables land:</li>
<li>Remove <code>DelayedUntilPhase7_8</code> from <code>tests/run.config.jsonc</code>.</li>
<li>Ensure these tests pass: <code>lmdb-backend</code>, <code>lmdb-corruption</code>, <code>lmdb-report-artifacts</code>.</li>
</ul>
<hr />
<h2 id="added-detail-phase-7-task-mapping">Added detail (Phase 7 task mapping)<a class="headerlink" href="#added-detail-phase-7-task-mapping" title="Permanent link"></a></h2>
<h3 id="71-build-scoped-embeddings-jobs-best-effort-enqueue">7.1 Build-scoped embeddings jobs + best-effort enqueue<a class="headerlink" href="#71-build-scoped-embeddings-jobs-best-effort-enqueue" title="Permanent link"></a></h3>
<ul>
<li>Task: Bind embedding jobs to explicit build output target</li>
<li>Files to change/create:<ul>
<li><code>src/index/build/indexer/pipeline.js</code> (enqueueEmbeddingJob call at ~323 already passes indexRoot; extend with configHash/repoProvenance)</li>
<li><code>src/index/build/indexer/embedding-queue.js</code> (payload fields at ~8-33)</li>
<li><code>tools/service/queue.js</code> (job schema validation if any)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/index/build/indexer/pipeline.js:323</code></li>
<li><code>src/index/build/indexer/embedding-queue.js:8-33</code></li>
</ul>
</li>
<li>Gaps/conflicts:<ul>
<li>embedding job payload currently lacks configHash/repo provenance; Phase 7 requires it for determinism.</li>
</ul>
</li>
<li>Task: Best-effort enqueue when embeddingService is enabled</li>
<li>Files to change/create:<ul>
<li><code>src/index/build/indexer/embedding-queue.js</code> (wrap ensureQueueDir/enqueueJob, set pending state on failure)</li>
<li><code>src/index/build/indexer/steps/write.js</code> (index_state.embeddings fields at ~52-98)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/index/build/indexer/embedding-queue.js:8-46</code></li>
<li><code>src/index/build/indexer/steps/write.js:52-98</code></li>
</ul>
</li>
<li>Task: Worker honors build scoping</li>
<li>Files to change/create:<ul>
<li><code>tools/indexer-service.js</code> (runBuildEmbeddings uses &ndash;repo only at ~260-284; add &ndash;index-root/indexDir)</li>
<li><code>tools/build-embeddings/cli.js</code> + <code>tools/build-embeddings/args.js</code> (ensure &ndash;index-root is parsed)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>tools/indexer-service.js:260-284</code></li>
<li><code>tools/build-embeddings/cli.js</code> (args wiring)</li>
</ul>
</li>
</ul>
<h3 id="72-embeddings-artifact-contract-capability-signaling">7.2 Embeddings artifact contract + capability signaling<a class="headerlink" href="#72-embeddings-artifact-contract-capability-signaling" title="Permanent link"></a></h3>
<ul>
<li>Task: Manifest + artifact discovery</li>
<li>Files to change/create:<ul>
<li><code>tools/build-embeddings/manifest.js</code> (embeddingPieces list at ~52-70; currently filtered by ARTIFACT_SCHEMA_DEFS)</li>
<li><code>src/index/build/artifacts.js</code> (dense_vectors pieces at ~255-300)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>tools/build-embeddings/manifest.js:52-90</code></li>
<li><code>src/index/build/artifacts.js:255-300</code></li>
</ul>
</li>
<li>Gaps/conflicts:<ul>
<li><code>tools/build-embeddings/manifest.js</code> drops entries whose name is not in ARTIFACT_SCHEMA_DEFS</li>
<li>dense_vectors_hnsw.bin and lancedb dirs are silently omitted </li>
<li>Reconcile with &ldquo;discoverable&rdquo; requirement.</li>
</ul>
</li>
<li>Task: Emit embedding identity + backend availability in index_state</li>
<li>Files to change/create:<ul>
<li><code>src/index/build/indexer/steps/write.js</code> (index_state.embeddings at ~52-90)</li>
<li><code>tools/build-embeddings/runner.js</code> (index_state updates at ~175-191 and ~692-704)</li>
<li><code>src/retrieval/cli-index.js</code> (embeddingsState read at ~101-107)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/index/build/indexer/steps/write.js:52-90</code></li>
<li><code>tools/build-embeddings/runner.js:175-191, 692-704</code></li>
<li><code>src/retrieval/cli-index.js:101-107</code></li>
</ul>
</li>
<li>Task: Harden validation for embeddings presence/consistency</li>
<li>Files to change/create:<ul>
<li><code>src/index/validate.js</code> (dense vector validation at ~413-491)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/index/validate.js:413-491</code></li>
</ul>
</li>
<li>Task: Missing-vector reporting + gating</li>
<li>Files to change/create:<ul>
<li><code>tools/build-embeddings/embed.js</code> (fillMissingVectors at ~120-150; add missing counters)</li>
<li><code>tools/build-embeddings/runner.js</code> (propagate missing stats into index_state)</li>
<li><code>src/index/build/file-processor/embeddings.js</code> (inline embeddings path)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>tools/build-embeddings/embed.js:108-145</code></li>
</ul>
</li>
</ul>
<h3 id="73-quantization-invariants">7.3 Quantization invariants<a class="headerlink" href="#73-quantization-invariants" title="Permanent link"></a></h3>
<ul>
<li>Task: Clamp levels to [2,256] everywhere</li>
<li>Files to change/create:<ul>
<li><code>src/storage/sqlite/vector.js</code> (resolveQuantizationParams at ~10-20)</li>
<li><code>src/shared/embedding-utils.js</code> (quantizeEmbeddingVector at ~56-74)</li>
<li><code>src/index/embedding.js</code> (quantizeVec export at ~8-12)</li>
<li><code>src/storage/sqlite/build/incremental-update.js</code> (quantize/pack paths at ~15-40)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/storage/sqlite/vector.js:10-20</code></li>
<li><code>src/shared/embedding-utils.js:56-86</code></li>
<li><code>src/index/embedding.js:8-12</code></li>
<li><code>src/storage/sqlite/build/incremental-update.js:15-40</code></li>
</ul>
</li>
<li>Task: Safe dequantization + param propagation</li>
<li>Files to change/create:<ul>
<li><code>src/storage/sqlite/vector.js</code> (dequantizeUint8ToFloat32 at ~22-40)</li>
<li><code>tools/build-embeddings/lancedb.js</code> (buildBatch uses dequantize with defaults at ~28-45)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/storage/sqlite/vector.js:22-40</code></li>
<li><code>tools/build-embeddings/lancedb.js:28-45</code></li>
</ul>
</li>
<li>Task: MergeEmbeddingVectors regression guard</li>
<li>Files to change/create:<ul>
<li><code>src/shared/embedding-utils.js</code> (mergeEmbeddingVectors at ~6-32)</li>
</ul>
</li>
</ul>
<h3 id="74-normalization-policy-consistency">7.4 Normalization policy consistency<a class="headerlink" href="#74-normalization-policy-consistency" title="Permanent link"></a></h3>
<ul>
<li>Task: Centralize normalization policy</li>
<li>Files to change/create:<ul>
<li><code>src/shared/embedding-utils.js</code> (normalizeEmbeddingVector* at ~36-55) or new policy module</li>
<li><code>tools/build-embeddings/embed.js</code> (normalizeEmbeddingVector call at ~4-10, ~108-121)</li>
<li><code>src/index/build/file-processor/embeddings.js</code> (normalizeVec calls at ~238-240)</li>
<li>src/retrieval/embedding.js (query-time embeddings)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>tools/build-embeddings/embed.js:1-15, 108-121</code></li>
<li><code>src/index/build/file-processor/embeddings.js:238-240</code></li>
</ul>
</li>
</ul>
<h3 id="75-lancedb-ann-correctness">7.5 LanceDB ANN correctness<a class="headerlink" href="#75-lancedb-ann-correctness" title="Permanent link"></a></h3>
<ul>
<li>Task: Promise-cache connections + candidate filtering</li>
<li>Files to change/create:<ul>
<li><code>src/retrieval/lancedb.js</code> (connection caching and candidate filtering paths)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/retrieval/lancedb.js</code> (connection map + rankLanceDb usage)</li>
</ul>
</li>
<li>Task: idColumn handling + warning policy</li>
<li>Files to change/create:<ul>
<li><code>src/retrieval/lancedb.js</code> (filter construction and warnOnce)</li>
</ul>
</li>
<li>Gaps/conflicts:<ul>
<li><code>tools/build-embeddings/lancedb.js</code> meta lacks quantization params; add for later verification.</li>
</ul>
</li>
</ul>
<h3 id="76-hnsw-ann-correctness">7.6 HNSW ANN correctness<a class="headerlink" href="#76-hnsw-ann-correctness" title="Permanent link"></a></h3>
<ul>
<li>Task: Load signature compatibility + similarity mapping</li>
<li>Files to change/create:<ul>
<li><code>src/shared/hnsw.js</code> (loadHnswIndex + rankHnswIndex at ~40-120)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/shared/hnsw.js:40-120</code></li>
</ul>
</li>
<li>Task: Insertion failure observability</li>
<li>Files to change/create:<ul>
<li><code>tools/build-embeddings/hnsw.js</code> (writeIndex at ~52-110)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>tools/build-embeddings/hnsw.js:52-110</code></li>
</ul>
</li>
</ul>
<h3 id="77-ann-backend-policy-parity">7.7 ANN backend policy + parity<a class="headerlink" href="#77-ann-backend-policy-parity" title="Permanent link"></a></h3>
<ul>
<li>Task: Canonical ann-backend selection</li>
<li>Files to change/create:<ul>
<li><code>src/retrieval/cli/normalize-options.js</code> (backend choice)</li>
<li><code>src/retrieval/ann/index.js</code> (provider selection)</li>
<li><code>src/retrieval/ann/providers/*.js</code> (availability rules)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/retrieval/ann/providers/hnsw.js:9-22</code></li>
<li><code>src/retrieval/ann/providers/lancedb.js:9-27</code></li>
<li><code>src/retrieval/ann/providers/sqlite-vec.js:8-23</code></li>
</ul>
</li>
<li>Task: Record backend availability in state</li>
<li>Files to change/create:<ul>
<li><code>src/index/build/indexer/steps/write.js</code> (index_state.features detail)</li>
<li><code>src/retrieval/cli/run-search-session.js</code> (annBackendUsed at ~483-487)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>src/retrieval/cli/run-search-session.js:483-487</code></li>
</ul>
</li>
</ul>
<h3 id="78-backend-storage-resilience">7.8 Backend storage resilience<a class="headerlink" href="#78-backend-storage-resilience" title="Permanent link"></a></h3>
<ul>
<li>Task: LMDB map size planning</li>
<li>Files to change/create:<ul>
<li><code>tools/build-lmdb-index.js</code> (lmdb open config; currently no map size config)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>tools/build-lmdb-index.js:1-90</code> (open import and options)</li>
</ul>
</li>
<li>Task: SQLite dense cross-mode safety</li>
<li>Files to change/create:<ul>
<li><code>tools/build-embeddings/sqlite-dense.js</code> (deleteDense/deleteAnn at ~130-150; uses global table name)</li>
</ul>
</li>
<li>Call sites/line refs:<ul>
<li><code>tools/build-embeddings/sqlite-dense.js:118-150</code></li>
</ul>
</li>
<li>Task: Embedding cache preflight metadata</li>
<li>Files to change/create:<ul>
<li><code>tools/build-embeddings/run.js</code> (preflight; see runner invocation)</li>
<li>tools/build-embeddings/cache.js (cache scan logic)</li>
</ul>
</li>
<li>Gaps/conflicts:<ul>
<li>Current <code>run.js</code> is minimal; cache scanning appears in <code>runner.js</code>; add metadata file to avoid full directory scan.</li>
</ul>
</li>
</ul>
<h2 id="phase-7-addendum-dependencies-ordering-artifacts-tests-edge-cases">Phase 7 addendum: dependencies, ordering, artifacts, tests, edge cases<a class="headerlink" href="#phase-7-addendum-dependencies-ordering-artifacts-tests-edge-cases" title="Permanent link"></a></h2>
<h3 id="71-dependencies-and-order-of-operations">7.1 Dependencies and order of operations<a class="headerlink" href="#71-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:<ul>
<li>Build-scoped job payload schema must land before worker changes.</li>
<li>Queue enqueue changes must land before state recording.</li>
</ul>
</li>
<li>Order of operations:
    1) Extend payload schema (buildId/buildRoot/indexDir/configHash).
    2) Update enqueue call sites to populate payload.
    3) Update worker to enforce buildRoot and reject mismatches.
    4) Update index_state embeddings.pending/ready logic.
    5) Add tests for payload and failure modes.</li>
</ul>
<h3 id="71-acceptance-criteria-tests-lane">7.1 Acceptance criteria + tests (lane)<a class="headerlink" href="#71-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li><code>tests/embeddings/job-payload-includes-buildroot.test.js</code> (test:integration)</li>
<li><code>tests/embeddings/optional-no-service.test.js</code> (test:integration)</li>
<li><code>tests/embeddings/worker-refuses-mismatched-buildroot.test.js</code> (test:integration)</li>
</ul>
<h3 id="71-edge-cases-and-fallback-behavior">7.1 Edge cases and fallback behavior<a class="headerlink" href="#71-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Unwritable queue dir in service mode: </li>
<li>log warning</li>
<li>set embeddings.pending=true</li>
<li>continue build</li>
<li>Missing buildRoot/indexDir in job: </li>
<li>Refuse job</li>
<li>Do NOT write artifacts</li>
</ul>
<h3 id="72-artifact-row-fields-embeddings-artifacts">7.2 Artifact row fields (embeddings artifacts)<a class="headerlink" href="#72-artifact-row-fields-embeddings-artifacts" title="Permanent link"></a></h3>
<ul>
<li>dense_vectors_uint8.json (and dense_vectors_doc_uint8.json, dense_vectors_code_uint8.json):</li>
<li>required keys: dims, vectors</li>
<li>optional keys: model, scale</li>
<li>vectors: array of uint8 arrays, length == chunk count for the mode</li>
<li>caps: dims &gt;= 1; each vector length == dims; values in [0,255]</li>
<li>dense_vectors_hnsw.meta.json:</li>
<li>required keys: dims, count, space, m, efConstruction, efSearch</li>
<li>optional keys: version, generatedAt, model</li>
<li>caps: count &lt;= vectors length; dims &gt;= 1</li>
<li>dense_vectors_lancedb.meta.json:</li>
<li>required keys: dims, count, metric, table, embeddingColumn, idColumn</li>
<li>optional keys: version, generatedAt, model</li>
<li>caps: count &lt;= vectors length; dims &gt;= 1</li>
<li>pieces/manifest.json entries (for each embedding artifact):</li>
<li>required keys: type=&rdquo;embeddings&rdquo;, name, format, path</li>
<li>recommended keys: count, dims, checksum, bytes</li>
</ul>
<h3 id="72-dependencies-and-order-of-operations">7.2 Dependencies and order of operations<a class="headerlink" href="#72-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>7.1 payload scoping before artifact publication in service mode.</li>
<li>Validation rules must align with manifest entries.</li>
<li>Order of operations:
  1) Define artifact contract + manifest entries.
  2) Emit index_state.embeddings capability summary.
  3) Harden validator for counts/dims.
  4) Add missing-vectors reporting + gating.</li>
</ul>
<h3 id="72-acceptance-criteria-tests-lane">7.2 Acceptance criteria + tests (lane)<a class="headerlink" href="#72-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/validate/embeddings-referential-integrity.test.js (test:services)</li>
<li>tests/validate/embeddings-optional-absence.test.js (test:services)</li>
<li>tests/embeddings/missing-rate-gating.test.js (test:integration)</li>
</ul>
<h3 id="72-edge-cases-and-fallback-behavior">7.2 Edge cases and fallback behavior<a class="headerlink" href="#72-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Embeddings absent: validation passes, index_state.embeddings.ready=false with reason.</li>
<li>Dims mismatch: validation fails in strict mode; non-strict logs warning.</li>
</ul>
<h3 id="73-dependencies-and-order-of-operations">7.3 Dependencies and order of operations<a class="headerlink" href="#73-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>Quantization utils updated before any backend writes (HNSW/LanceDB).</li>
<li>Order of operations:
  1) Clamp levels in config resolution.
  2) Clamp levels at quantizer/dequantizer.
  3) Thread quantization params through writers.</li>
</ul>
<h3 id="73-acceptance-criteria-tests-lane">7.3 Acceptance criteria + tests (lane)<a class="headerlink" href="#73-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li><code>tests/unit/quantization-levels-clamp.test.js</code> (test:unit)</li>
<li><code>tests/unit/dequantize-levels-safe.test.js</code> (test:unit)</li>
<li><code>tests/regression/incremental-update-quantize-no-wrap.test.js</code> (test:integration)</li>
</ul>
<h3 id="73-edge-cases-and-fallback-behavior">7.3 Edge cases and fallback behavior<a class="headerlink" href="#73-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>levels &lt;= 1: dequantize safely (no divide by zero) and clamp to 2.</li>
<li>levels &gt; 256: clamp to 256 with warning.</li>
</ul>
<h3 id="74-dependencies-and-order-of-operations">7.4 Dependencies and order of operations<a class="headerlink" href="#74-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>Normalization policy must be defined before ANN query-time use.</li>
<li>Order of operations:
  1) Centralize normalization policy.
  2) Apply to build-time embedding vectors.
  3) Apply to query-time embedding vectors.</li>
</ul>
<h3 id="74-acceptance-criteria-tests-lane">7.4 Acceptance criteria + tests (lane)<a class="headerlink" href="#74-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li><code>tests/unit/normalization-policy-consistency.test.js</code> (test:unit)</li>
<li><code>tests/integration/hnsw-rebuild-idempotent.test.js</code> (test:integration)</li>
</ul>
<h3 id="74-edge-cases-and-fallback-behavior">7.4 Edge cases and fallback behavior<a class="headerlink" href="#74-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Policy mismatch detected between build/query: mark ANN unavailable and fall back to lexical search.</li>
</ul>
<h3 id="75-dependencies-and-order-of-operations">7.5 Dependencies and order of operations<a class="headerlink" href="#75-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>7.3 quantization invariants</li>
<li>7.4 normalization before LanceDB query fixes.</li>
<li>Order of operations:
  1) Promise-cache LanceDB connections.
  2) Fix candidate filtering to honor topN.
  3) Escape identifiers and sanitize filters.
  4) Replace warnOnce suppression with rate-limited warnings.</li>
</ul>
<h3 id="75-acceptance-criteria-tests-lane">7.5 Acceptance criteria + tests (lane)<a class="headerlink" href="#75-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li><code>tests/lancedb-ann.js</code> (test:services, skip 77 if missing deps)</li>
<li><code>tests/unit/lancedb-connection-caching.test.js</code> (test:unit)</li>
</ul>
<h3 id="75-edge-cases-and-fallback-behavior">7.5 Edge cases and fallback behavior<a class="headerlink" href="#75-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>LanceDB missing: </li>
<li>Skip backend</li>
<li>Mark availability false</li>
<li>Cntinue with other backends.</li>
<li>Candidate set too small:</li>
<li>Return fewer results</li>
<li>Log cap hit</li>
<li>Never crash.</li>
</ul>
<h3 id="76-dependencies-and-order-of-operations">7.6 Dependencies and order of operations<a class="headerlink" href="#76-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>7.3 quantization invariants before HNSW build.</li>
<li>Order of operations:
  1) Fix load signature.
  2) Verify similarity mapping (ip/cosine).
  3) Capture insertion failures with summary.</li>
</ul>
<h3 id="76-acceptance-criteria-tests-lane">7.6 Acceptance criteria + tests (lane)<a class="headerlink" href="#76-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li><code>tests/unit/hnsw-signature-compat.test.js</code> (test:unit)</li>
<li><code>tests/unit/hnsw-similarity-mapping.test.js</code> (test:unit)</li>
<li><code>tests/integration/hnsw-insert-failure-reporting.test.js</code> (test:integration)</li>
</ul>
<h3 id="76-edge-cases-and-fallback-behavior">7.6 Edge cases and fallback behavior<a class="headerlink" href="#76-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Insert failure: </li>
<li>Fail build with error summary</li>
<li>Do not write partial index.</li>
<li>Missing HNSW index: </li>
<li>Mark availability false </li>
<li>Fall back to other backends.</li>
</ul>
<h3 id="77-dependencies-and-order-of-operations">7.7 Dependencies and order of operations<a class="headerlink" href="#77-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>7.5 &amp; 7.6 must land before backend selection parity.</li>
<li>Order of operations:
  1) Enumerate backend availability in index_state.
  2) Apply selection policy (config + availability).
  3) Add explicit backend tests with skip semantics.</li>
</ul>
<h3 id="77-acceptance-criteria-tests-lane">7.7 Acceptance criteria + tests (lane)<a class="headerlink" href="#77-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li><code>tests/services/ann-backend-selection.test.js</code> (test:services)</li>
<li><code>tests/services/ann-backend-availability-reporting.test.js</code> (test:services)</li>
</ul>
<h3 id="77-edge-cases-and-fallback-behavior">7.7 Edge cases and fallback behavior<a class="headerlink" href="#77-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Preferred backend unavailable: </li>
<li>Select next available backend</li>
<li>Record reason in state.</li>
</ul>
<h3 id="78-dependencies-and-order-of-operations">7.8 Dependencies and order of operations<a class="headerlink" href="#78-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>Storage backend guardrails must land before embeddings/ANN rely on them.</li>
<li>Order of operations:
  1) Harden storage open/create paths.
  2) Add explicit error reporting (no silent partial writes).
  3) Add resilience tests.</li>
</ul>
<h3 id="78-acceptance-criteria-tests-lane">7.8 Acceptance criteria + tests (lane)<a class="headerlink" href="#78-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li><code>tests/storage/embeddings-backend-resilience.test.js</code> (test:storage)</li>
</ul>
<h3 id="78-edge-cases-and-fallback-behavior">7.8 Edge cases and fallback behavior<a class="headerlink" href="#78-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Partial storage failure: mark embeddings unavailable, do not expose ANN indexes.</li>
</ul>
<h2 id="fixtures-list-phase-7">Fixtures list (Phase 7)<a class="headerlink" href="#fixtures-list-phase-7" title="Permanent link"></a></h2>
<ul>
<li><code>tests/fixtures/embeddings/basic-repo</code></li>
<li><code>tests/fixtures/embeddings/missing-vectors</code></li>
<li><code>tests/fixtures/embeddings/quantization-caps</code></li>
</ul>
<h2 id="compatmigration-checklist-phase-7">Compat/migration checklist (Phase 7)<a class="headerlink" href="#compatmigration-checklist-phase-7" title="Permanent link"></a></h2>
<ul>
<li>Keep existing <code>dense_vectors_* filenames</code></li>
<li>Do not rename artifacts.</li>
<li>Accept legacy embedding jobs with a warning or explicit refusal (no silent mutation).</li>
<li>Preserve current zero-fill behavior for missing vectors but record missing counts/gating.</li>
<li>Keep ANN backends optional</li>
<li>Missing deps must skip, not fail builds.</li>
</ul>
<h2 id="artifacts-contract-appendix-phase-7">Artifacts contract appendix (Phase 7)<a class="headerlink" href="#artifacts-contract-appendix-phase-7" title="Permanent link"></a></h2>
<ul>
<li><code>dense_vectors_uint8.json</code> (and <code>dense_vectors_doc_uint8.json</code>, <code>dense_vectors_code_uint8.json</code>)</li>
<li>Required keys: <ul>
<li>Dims</li>
<li>Vectors</li>
</ul>
</li>
<li>Optional keys: <ul>
<li>Model </li>
<li>Scale</li>
</ul>
</li>
<li>Caps: <code>Dims &gt;= 1</code> </li>
<li>Vectors <code>length == chunk count</code>; </li>
<li>Values in <code>[0,255]</code></li>
<li><code>dense_vectors_hnsw.meta.json</code></li>
<li>Required keys: <ul>
<li>Dims</li>
<li>Count </li>
<li>Space</li>
<li>M </li>
<li>EfConstruction </li>
<li>EfSearch</li>
</ul>
</li>
<li>Optional keys: <ul>
<li>Version </li>
<li>GeneratedAt </li>
<li>Model</li>
</ul>
</li>
<li><code>dense_vectors_lancedb.meta.json</code></li>
<li>Required keys: <ul>
<li>Dims </li>
<li>Count</li>
<li>Metric</li>
<li>Table</li>
<li>EmbeddingColumn</li>
<li>IdColumn</li>
</ul>
</li>
<li>Optional keys: <ul>
<li>Version </li>
<li>GeneratedAt </li>
<li>Model</li>
</ul>
</li>
<li><code>pieces/manifest.json</code> entries for embeddings</li>
<li>Required keys: <ul>
<li>Type=&rdquo;embeddings&rdquo; </li>
<li>Name</li>
<li>Format </li>
<li>Path</li>
</ul>
</li>
<li>Recommended keys: <ul>
<li>Count </li>
<li>Dims</li>
<li>Checksum </li>
<li>Bytes</li>
</ul>
</li>
</ul>
<hr />
<h1 id="phase-9-symbol-identity-collision-safe-ids-cross-file-linking">Phase 9 &ndash; Symbol identity (collision-safe IDs) + cross-file linking<a class="headerlink" href="#phase-9-symbol-identity-collision-safe-ids-cross-file-linking" title="Permanent link"></a></h1>
<h2 id="objective_1">Objective<a class="headerlink" href="#objective_1" title="Permanent link"></a></h2>
<p>Eliminate correctness hazards caused by non-unique, name-based joins (notably <code>file::name</code> and legacy <code>chunkId</code> usage) and replace them with a collision-safe identity layer. Use that identity to produce:</p>
<p>1) <strong>Stable, segment-aware node identity</strong> (<code>chunkUid</code>, <code>segmentUid</code>, <code>virtualPath</code>) that survives minor line shifts and prevents collisions across:
   - same-name declarations in different files,
   - same-name declarations inside different segments of the same container file,
   - repeated definitions (overloads, nested scopes, generated code patterns).</p>
<p>2) <strong>A canonical symbol identity and reference contract</strong> (<code>symbolKey</code>, <code>signatureKey</code>, <code>scopedId</code>, <code>symbolId</code>, <code>SymbolRef</code>) that:
   - is deterministic,
   - is language-agnostic at the storage boundary,
   - preserves ambiguity instead of forcing wrong links.</p>
<p>3) <strong>Cross-file resolution that is import-aware and ambiguity-preserving</strong>, using bounded heuristics and explicit <code>state</code> / <code>confidence</code> fields.</p>
<p>4) <strong>First-class symbol graph artifacts</strong> (<code>symbols</code>, <code>symbol_occurrences</code>, <code>symbol_edges</code>) that enable downstream graph analytics and product features without re-parsing code.</p>
<p>5) <strong>Fail-closed identity and symbol joins:</strong> no <code>file::name</code> fallback in strict mode; ambiguous resolutions are preserved, not guessed.</p>
<hr />
<h1 id="phase-9-symbol-identity-collision-safe-ids-cross-file-linking-detailed-execution-plan">Phase 9 &ndash; Symbol identity (collision-safe IDs) + cross-file linking (detailed execution plan)<a class="headerlink" href="#phase-9-symbol-identity-collision-safe-ids-cross-file-linking-detailed-execution-plan" title="Permanent link"></a></h1>
<h2 id="phase-9-objective-what-done-means">Phase 9 objective (what &ldquo;done&rdquo; means)<a class="headerlink" href="#phase-9-objective-what-done-means" title="Permanent link"></a></h2>
<p>Eliminate all correctness hazards caused by non-unique, name-based joins (notably <code>file::name</code> and legacy <code>chunkId</code> usage) and replace them with a collision-safe, stability-oriented identity layer. Use that identity to produce:</p>
<p>1) <strong>Stable, segment-aware node identity</strong> (<code>chunkUid</code>, <code>segmentUid</code>, <code>virtualPath</code>) that survives minor line shifts and prevents collisions across:
   - same-name declarations in different files,
   - same-name declarations inside different segments of the same container file,
   - repeated definitions (overloads, nested scopes, generated code patterns).</p>
<p>2) <strong>A canonical symbol identity and reference contract</strong> (<code>symbolKey</code>, <code>signatureKey</code>, <code>scopedId</code>, <code>symbolId</code>, <code>SymbolRef</code>) that:
   - is deterministic,
   - is language-agnostic at the storage boundary,
   - preserves ambiguity instead of forcing wrong links.</p>
<p>3) <strong>Cross-file resolution that is import-aware and ambiguity-preserving</strong>, using bounded heuristics and explicit confidence/status fields.</p>
<p>4) <strong>First-class symbol graph artifacts</strong> (<code>symbols.jsonl</code>, <code>symbol_occurrences.jsonl</code>, <code>symbol_edges.jsonl</code>) that enable downstream graph analytics and product features without re-parsing code.</p>
<p>5) <strong>Fail-closed identity and symbol joins:</strong> no file::name fallback in strict mode; ambiguous resolutions are preserved, not guessed.</p>
<p>This phase directly targets the Phase 9 intent in the roadmap (&ldquo;Symbol identity (collision-safe IDs) + cross-file linking&rdquo;) and depends on the canonical <code>chunkUid</code> contract delivered in Phase 8. In particular, the <code>chunkUid</code> construction approach and &ldquo;fail closed&rdquo; requirement are consistent with the canonical identity contract described in the planning materials.</p>
<hr />
<h2 id="phase-9-non-goals-explicitly-out-of-scope-for-phase-9-acceptance">Phase 9 non-goals (explicitly out of scope for Phase 9 acceptance)<a class="headerlink" href="#phase-9-non-goals-explicitly-out-of-scope-for-phase-9-acceptance" title="Permanent link"></a></h2>
<p>These may be separate follow-on phases or optional extensions:</p>
<ul>
<li>Full <strong>SCIP/LSIF/ctags hybrid symbol source registry</strong> (runtime selection/merging) beyond ensuring the contracts can represent those IDs.</li>
<li>Full module-resolution parity with Node/TS (tsconfig paths, package exports/imports, Yarn PnP, etc). Phase 9 supports <strong>relative import resolution</strong> only.</li>
<li>Whole-program correctness for dynamic languages; Phase 9 focuses on <strong>correctness under ambiguity</strong> (never wrong-link) rather than &ldquo;resolve everything&rdquo;.</li>
<li>Cross-repo symbol federation.</li>
</ul>
<hr />
<h2 id="phase-9-key-decisions-locked">Phase 9 key decisions (locked)<a class="headerlink" href="#phase-9-key-decisions-locked" title="Permanent link"></a></h2>
<p>These choices remove ambiguity and prevent future &ldquo;forks&rdquo; in implementation.</p>
<h3 id="d1-graph-node-identity-uses-chunkuid-not-filename-not-legacy-chunkid">D1) Graph node identity uses <code>chunkUid</code>, not <code>file::name</code>, not legacy <code>chunkId</code><a class="headerlink" href="#d1-graph-node-identity-uses-chunkuid-not-filename-not-legacy-chunkid" title="Permanent link"></a></h3>
<ul>
<li><strong>Chosen:</strong> <code>chunkUid</code> is the canonical node identifier for graphs and cross-file joins.</li>
<li><strong>Why:</strong> <code>file::name</code> is not unique; <code>chunkId</code> is range-based and churns with line shifts. The roadmap&rsquo;s canonical identity guidance explicitly calls for a <code>chunkUid</code> that is stable under line shifts and includes segment disambiguation.</li>
</ul>
<h3 id="d2-symbol-identity-is-a-two-layer-model-symbolkey-humandebug-symbolid-portable-token">D2) Symbol identity is a two-layer model: <code>symbolKey</code> (human/debug) + <code>symbolId</code> (portable token)<a class="headerlink" href="#d2-symbol-identity-is-a-two-layer-model-symbolkey-humandebug-symbolid-portable-token" title="Permanent link"></a></h3>
<ul>
<li><strong>Chosen:</strong> Persist both.</li>
<li><strong>Why:</strong> <code>symbolKey</code> is explainable and supports deterministic &ldquo;rebuild equivalence&rdquo; reasoning. <code>symbolId</code> is compact and future-proofs external sources (SCIP/LSIF) without schema churn.</li>
</ul>
<h3 id="d3-cross-file-resolution-is-ambiguity-preserving">D3) Cross-file resolution is ambiguity-preserving<a class="headerlink" href="#d3-cross-file-resolution-is-ambiguity-preserving" title="Permanent link"></a></h3>
<ul>
<li><strong>Chosen:</strong> When multiple plausible targets exist, record candidates and mark the ref <strong>ambiguous</strong>; do not pick arbitrarily.</li>
<li><strong>Why:</strong> Wrong links destroy trust and cascade into graph features, risk flows, and context packs. Ambiguity can be resolved later by better signals.</li>
</ul>
<h3 id="d4-artifact-emission-is-streaming-first-and-deterministically-ordered">D4) Artifact emission is streaming-first and deterministically ordered<a class="headerlink" href="#d4-artifact-emission-is-streaming-first-and-deterministically-ordered" title="Permanent link"></a></h3>
<ul>
<li><strong>Chosen:</strong> JSONL for symbol artifacts; deterministic sharding and sorting.</li>
<li><strong>Why:</strong> Large repos must not require in-memory materialization of symbol graphs; deterministic ordering is required for reproducible builds and regression testing.</li>
</ul>
<hr />
<h2 id="phase-9-contracts-normative-implementation-ready">Phase 9 contracts (normative, implementation-ready)<a class="headerlink" href="#phase-9-contracts-normative-implementation-ready" title="Permanent link"></a></h2>
<blockquote>
<p>These contracts must be implemented exactly as specified to avoid drift.</p>
</blockquote>
<h3 id="9c1-identity-contract-v1">9.C1 Identity contract (v1)<a class="headerlink" href="#9c1-identity-contract-v1" title="Permanent link"></a></h3>
<h4 id="9c11-segmentuid-string-null">9.C1.1 <code>segmentUid</code> (string | null)<a class="headerlink" href="#9c11-segmentuid-string-null" title="Permanent link"></a></h4>
<ul>
<li><strong>Definition:</strong> A stable identifier for a segment inside a container file (Vue SFC blocks, fenced Markdown blocks, etc).</li>
<li><strong>Scope:</strong> Unique within the repo (i.e., global uniqueness is acceptable and preferred).</li>
<li><strong>Stability:</strong> Must remain stable under <em>minor line shifts</em> outside the segment content.</li>
</ul>
<p><strong>Algorithm (v1):</strong></p>
<div class="highlight"><pre>segmentUid = &quot;seg1:&quot; + xxhash64(
  containerRelPath + &quot;\0&quot;
  + segmentType + &quot;\0&quot;
  + effectiveLanguageId + &quot;\0&quot;
  + normalizeText(segmentText)
  + &quot;\0&quot;
  + (parentSegmentUid ?? &quot;&quot;)
)
</pre></div>

<ul>
<li><code>normalizeText</code>:</li>
<li>normalize line endings to <code>\n</code></li>
<li>preserve all non-whitespace characters</li>
<li>do not strip trailing whitespace by default (correctness-first)</li>
</ul>
<h4 id="9c12-virtualpath-string">9.C1.2 <code>virtualPath</code> (string)<a class="headerlink" href="#9c12-virtualpath-string" title="Permanent link"></a></h4>
<p>A deterministic &ldquo;as-if file path&rdquo; that disambiguates segments:</p>
<ul>
<li>If no segment: <code>virtualPath = fileRelPath</code></li>
<li>If segment: <code>virtualPath = fileRelPath + "#seg:" + segmentUid</code></li>
</ul>
<h4 id="9c13-chunkuid-string">9.C1.3 <code>chunkUid</code> (string)<a class="headerlink" href="#9c13-chunkuid-string" title="Permanent link"></a></h4>
<ul>
<li><strong>Definition:</strong> Stable-ish identifier for a chunk, used for graphs and join keys.</li>
<li><strong>Stability:</strong> Must remain stable when only lines outside the chunk&rsquo;s span shift (i.e., chunk text unchanged).</li>
<li><strong>Collision handling:</strong> If a collision is detected within <code>{virtualPath, segmentUid}</code>, deterministically disambiguate and record <code>collisionOf</code>.</li>
</ul>
<p><strong>Algorithm (v1) &ndash; consistent with the canonical contract described in the planning docs:</strong></p>
<div class="highlight"><pre>span = normalizeForUid(chunkText)
pre  = normalizeForUid(text.slice(max(0, start-128), start))
post = normalizeForUid(text.slice(end, min(len, end+128)))

spanHash = xxhash64(&quot;span\0&quot; + span)
preHash  = xxhash64(&quot;pre\0&quot; + pre)   (only if pre.length &gt; 0)
postHash = xxhash64(&quot;post\0&quot; + post) (only if post.length &gt; 0)

base = &quot;ck64:v1:&quot; + namespaceKey + &quot;:&quot; + virtualPath + &quot;:&quot; + spanHash
if (segment.languageId) base = &quot;ck64:v1:&quot; + namespaceKey + &quot;:&quot; + virtualPath + &quot;:&quot; + segment.languageId + &quot;:&quot; + spanHash
if (preHash)  base += &quot;:&quot; + preHash
if (postHash) base += &quot;:&quot; + postHash

chunkUid = base
</pre></div>

<p>This follows the canonical identity contract exactly (see <code>docs/specs/identity-contract.md</code> §4).</p>
<p><strong>Collision disambiguation (required):</strong></p>
<p>If <code>chunkUid</code> already exists for a different chunk under the same <code>virtualPath</code> scope:</p>
<ul>
<li>set <code>collisionOf = originalChunkUid</code></li>
<li>follow the canonical disambiguation steps: escalate context windows once, then assign deterministic ordinals and append <code>:ord&lt;index&gt;</code>.</li>
</ul>
<blockquote>
<p>Note: the ordinal must be deterministic across runs given identical inputs.</p>
</blockquote>
<h4 id="9c14-metav2-additions">9.C1.4 metaV2 additions<a class="headerlink" href="#9c14-metav2-additions" title="Permanent link"></a></h4>
<p><code>metaV2</code> MUST include:</p>
<ul>
<li><code>chunkUid: string</code></li>
<li><code>segmentUid: string | null</code></li>
<li><code>virtualPath: string</code></li>
</ul>
<p>And SHOULD include (for diagnostics and future hardening):</p>
<ul>
<li><code>identity: { v: 1, spanHash: string, preHash: string, postHash: string, collisionOf?: string }</code></li>
</ul>
<h3 id="9c2-symbol-identity-contract-v1">9.C2 Symbol identity contract (v1)<a class="headerlink" href="#9c2-symbol-identity-contract-v1" title="Permanent link"></a></h3>
<h4 id="9c21-kindgroup">9.C2.1 <code>kindGroup</code><a class="headerlink" href="#9c21-kindgroup" title="Permanent link"></a></h4>
<p>Normalize &ldquo;kind&rdquo; strings into a stable group set:</p>
<ul>
<li><code>function</code>, <code>arrow_function</code>, <code>generator</code> → <code>function</code></li>
<li><code>class</code> → <code>class</code></li>
<li><code>method</code>, <code>constructor</code> → <code>method</code></li>
<li><code>interface</code>, <code>type</code>, <code>enum</code> → <code>type</code></li>
<li><code>variable</code>, <code>const</code>, <code>let</code> → <code>value</code></li>
<li><code>module</code>, <code>namespace</code>, <code>file</code> → <code>module</code></li>
<li>unknown/other → <code>other</code></li>
</ul>
<h4 id="9c22-symbolkey">9.C2.2 <code>symbolKey</code><a class="headerlink" href="#9c22-symbolkey" title="Permanent link"></a></h4>
<div class="highlight"><pre>symbolKey = virtualPath + &quot;::&quot; + qualifiedName + &quot;::&quot; + kindGroup
</pre></div>

<ul>
<li><code>qualifiedName</code> defaults to <code>chunk.name</code>.</li>
<li>When available, prefer container-aware names like <code>Class.method</code>.</li>
</ul>
<h4 id="9c23-signaturekey-optional">9.C2.3 <code>signatureKey</code> (optional)<a class="headerlink" href="#9c23-signaturekey-optional" title="Permanent link"></a></h4>
<div class="highlight"><pre>signatureKey = qualifiedName + &quot;::&quot; + normalizeSignature(signature)
</pre></div>

<p><code>normalizeSignature</code> must:
- collapse runs of whitespace to a single space
- preserve punctuation, generics, and parameter ordering</p>
<h4 id="9c24-scopedid">9.C2.4 <code>scopedId</code><a class="headerlink" href="#9c24-scopedid" title="Permanent link"></a></h4>
<div class="highlight"><pre>scopedId = kindGroup + &quot;|&quot; + symbolKey + &quot;|&quot; + (signatureKey ?? &quot;&quot;) + &quot;|&quot; + chunkUid
</pre></div>

<h4 id="9c25-symbolid">9.C2.5 <code>symbolId</code><a class="headerlink" href="#9c25-symbolid" title="Permanent link"></a></h4>
<ul>
<li>Deterministic, compact token:</li>
<li><code>symbolId = schemePrefix + sha1(scopedId)</code></li>
</ul>
<p>Where <code>schemePrefix</code> depends on source:</p>
<ul>
<li>Native/chunk-based: <code>sym1:heur:</code> (heuristic/native)</li>
<li>SCIP: <code>sym1:scip:</code></li>
<li>LSIF: <code>sym1:lsif:</code></li>
<li>CTAGS: <code>sym1:ctags:</code></li>
</ul>
<blockquote>
<p>Phase 9 implements only <code>heur</code> generation but must preserve the scheme field in schemas.</p>
</blockquote>
<h4 id="9c26-symbolref-reference-envelope">9.C2.6 <code>SymbolRef</code> (reference envelope)<a class="headerlink" href="#9c26-symbolref-reference-envelope" title="Permanent link"></a></h4>
<p>A reference to a symbol, which may be resolved, ambiguous, or unresolved.</p>
<div class="highlight"><pre>SymbolRefV1 = {
  v: 1,
  targetName: string,          // observed identifier, e.g. &quot;foo&quot; or &quot;Foo.bar&quot;
  kindHint: string | null,      // optional hint, e.g. &quot;function&quot;
  importHint: {
    moduleSpecifier: string | null,
    resolvedFile: string | null
  } | null,
  candidates: Array&lt;{
    symbolId: string,
    chunkUid: string,
    symbolKey: string,
    signatureKey: string | null,
    kindGroup: string
  }&gt;,
  status: &quot;resolved&quot; | &quot;ambiguous&quot; | &quot;unresolved&quot;,
  resolved: {
    symbolId: string,
    chunkUid: string
  } | null
}
</pre></div>

<ul>
<li><code>candidates</code> MUST be capped (see resolver caps in Phase 9.4).</li>
<li><code>resolved</code> is non-null only when <code>status === "resolved"</code>.</li>
</ul>
<h3 id="9c3-symbol-graph-artifacts-v1">9.C3 Symbol graph artifacts (v1)<a class="headerlink" href="#9c3-symbol-graph-artifacts-v1" title="Permanent link"></a></h3>
<p>All symbol artifacts are emitted in <code>index-code/</code>:</p>
<ul>
<li><code>symbols.jsonl</code></li>
<li><code>symbol_occurrences.jsonl</code></li>
<li><code>symbol_edges.jsonl</code></li>
</ul>
<p>Each line is one JSON object. Deterministic order and deterministic sharding are required.</p>
<h4 id="9c31-symbolsjsonl">9.C3.1 <code>symbols.jsonl</code><a class="headerlink" href="#9c31-symbolsjsonl" title="Permanent link"></a></h4>
<p>One record per symbol definition (i.e., per chunk with <code>metaV2.symbol</code>):</p>
<div class="highlight"><pre>{
  &quot;v&quot;: 1,
  &quot;symbolId&quot;: &quot;...&quot;,
  &quot;scopedId&quot;: &quot;...&quot;,
  &quot;scheme&quot;: &quot;heur&quot;,
  &quot;symbolKey&quot;: &quot;...&quot;,
  &quot;signatureKey&quot;: null | &quot;...&quot;,
  &quot;chunkUid&quot;: &quot;...&quot;,
  &quot;virtualPath&quot;: &quot;...&quot;,
  &quot;segmentUid&quot;: null | &quot;...&quot;,
  &quot;file&quot;: &quot;...&quot;,
  &quot;lang&quot;: &quot;...&quot;,
  &quot;kind&quot;: &quot;...&quot;,
  &quot;kindGroup&quot;: &quot;...&quot;,
  &quot;name&quot;: &quot;...&quot;,
  &quot;qualifiedName&quot;: &quot;...&quot;,
  &quot;signature&quot;: null | &quot;...&quot;
}
</pre></div>

<h4 id="9c32-symbol_occurrencesjsonl">9.C3.2 <code>symbol_occurrences.jsonl</code><a class="headerlink" href="#9c32-symbol_occurrencesjsonl" title="Permanent link"></a></h4>
<p>One record per observed reference occurrence (calls, usages). At minimum:</p>
<div class="highlight"><pre>{
  &quot;v&quot;: 1,
  &quot;fromChunkUid&quot;: &quot;...&quot;,
  &quot;fromFile&quot;: &quot;...&quot;,
  &quot;fromVirtualPath&quot;: &quot;...&quot;,
  &quot;occurrenceKind&quot;: &quot;call&quot; | &quot;usage&quot;,
  &quot;targetName&quot;: &quot;...&quot;,
  &quot;range&quot;: { &quot;start&quot;: number, &quot;end&quot;: number } | null,
  &quot;ref&quot;: SymbolRefV1
}
</pre></div>

<h4 id="9c33-symbol_edgesjsonl">9.C3.3 <code>symbol_edges.jsonl</code><a class="headerlink" href="#9c33-symbol_edgesjsonl" title="Permanent link"></a></h4>
<p>One record per reference edge (call, usage) emitted from chunk relations:</p>
<div class="highlight"><pre>{
  &quot;v&quot;: 1,
  &quot;edgeKind&quot;: &quot;call&quot; | &quot;usage&quot;,
  &quot;fromChunkUid&quot;: &quot;...&quot;,
  &quot;fromSymbolId&quot;: null | &quot;...&quot;,
  &quot;to&quot;: SymbolRefV1,
  &quot;confidence&quot;: number,         // 0..1
  &quot;evidence&quot;: {
    &quot;importNarrowed&quot;: boolean,
    &quot;matchedExport&quot;: boolean,
    &quot;matchedSignature&quot;: boolean
  }
}
</pre></div>

<h3 id="9c4-graph-relations-artifact-migration-v2">9.C4 Graph relations artifact migration (v2)<a class="headerlink" href="#9c4-graph-relations-artifact-migration-v2" title="Permanent link"></a></h3>
<p><code>graph_relations.json</code> MUST be updated such that:</p>
<ul>
<li>Node <code>id</code> is <code>chunkUid</code> (not legacy chunkId and not <code>file::name</code>)</li>
<li>Node <code>attrs</code> include:</li>
<li><code>chunkUid</code>, <code>chunkId</code> (legacy), <code>legacyKey</code> (for diagnostics only)</li>
<li><code>symbolId</code> (when available)</li>
<li>Edges are emitted <strong>only</strong> for resolved symbol edges (status=resolved)</li>
</ul>
<hr />
<h2 id="phase-9-implementation-plan-phasessubphasestaskstests">Phase 9 implementation plan (phases/subphases/tasks/tests)<a class="headerlink" href="#phase-9-implementation-plan-phasessubphasestaskstests" title="Permanent link"></a></h2>
<h3 id="91-verify-identity-primitives-segmentuid-chunkuid-virtualpath-delivered-in-phase-8">9.1 Verify identity primitives (<code>segmentUid</code>, <code>chunkUid</code>, <code>virtualPath</code>) &ndash; delivered in Phase 8<a class="headerlink" href="#91-verify-identity-primitives-segmentuid-chunkuid-virtualpath-delivered-in-phase-8" title="Permanent link"></a></h3>
<blockquote>
<p>If any identity primitive is missing or diverges from the canonical spec, stop Phase 9 and complete the work in Phase 8 before continuing.</p>
</blockquote>
<p><strong>Verification checklist (no new algorithm changes in Phase 9)</strong>
- Code presence:
  - <code>src/index/identity/*</code> helpers exist and match <code>docs/specs/identity-contract.md</code>.
  - <code>segmentUid</code>, <code>virtualPath</code>, and <code>chunkUid</code> are populated in <code>metaV2</code> for every code chunk.
- Behavior:
  - <code>segmentUid</code> stable under line shifts outside the segment.
  - <code>chunkUid</code> stable under line shifts outside the chunk span; changes when span text changes.
  - Collision handling uses canonical escalation + <code>:ord&lt;N&gt;</code> suffixes.
- Fail-closed identity rules:
  - Strict validation rejects any chunk missing <code>chunkUid</code>/<code>segmentUid</code>/<code>virtualPath</code>.
  - No file::name fallback for joins in strict mode.
- Tests (already required in Phase 8; rerun only if identity code changes):
  - tests/unit/segment-uid-stability.test.js (test:unit)
  - tests/unit/chunk-uid-stability.test.js (test:unit)
  - tests/validate/chunk-uid-required.test.js (test:services)
  - tests/graph-chunk-id.js (updated to chunkUid)</p>
<hr />
<h3 id="92-implement-symbol-identity-metav2symbol-symbolref-and-helpers">9.2 Implement symbol identity (<code>metaV2.symbol</code>, <code>SymbolRef</code>) and helpers<a class="headerlink" href="#92-implement-symbol-identity-metav2symbol-symbolref-and-helpers" title="Permanent link"></a></h3>
<p><strong>Primary touchpoints</strong>
- <code>src/index/metadata-v2.js</code>
- New: <code>src/index/identity/symbol.js</code>
- Update callsites: graph builder, cross-file resolver, map builder</p>
<h4 id="921-implement-symbol-identity-builder">9.2.1 Implement symbol identity builder<a class="headerlink" href="#921-implement-symbol-identity-builder" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Add <code>src/index/identity/kind-group.js</code></strong></li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement <code>toKindGroup(kind: string | null): string</code></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Add <code>src/index/identity/symbol.js</code></strong></p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>buildSymbolIdentity({ metaV2 }): { scheme, kindGroup, qualifiedName, symbolKey, signatureKey, scopedId, symbolId } | null</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Return null when chunk is not a &ldquo;definition chunk&rdquo; (policy below).</li>
</ul>
<p><strong>Definition chunk policy (v1):</strong></p>
<ul>
<li>A chunk is a definition chunk if:</li>
<li><code>chunk.name</code> is truthy AND not equal to <code>"(module)"</code> unless kindGroup is <code>module</code>, AND</li>
<li><code>chunk.kind</code> is truthy OR <code>chunk.name === "(module)"</code>, AND</li>
<li><code>metaV2.lang</code> is truthy (code mode).</li>
</ul>
<blockquote>
<p>This policy is intentionally permissive; it can be tightened later, but Phase 9 prioritizes completeness with ambiguity-safe linking.</p>
</blockquote>
<h4 id="922-populate-metav2symbol">9.2.2 Populate <code>metaV2.symbol</code><a class="headerlink" href="#922-populate-metav2symbol" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Modify <code>src/index/metadata-v2.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> After identity fields are set, compute <code>metaV2.symbol</code> via <code>buildSymbolIdentity</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>symbolKey</code> is based on <code>virtualPath</code>, not <code>file</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>symbolId</code> is deterministic.</li>
</ul>
<h4 id="923-tests-for-symbol-identity">9.2.3 Tests for symbol identity<a class="headerlink" href="#923-tests-for-symbol-identity" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Add <code>tests/identity/symbol-identity.test.js</code></strong></li>
<li>Given a fake <code>metaV2</code> with chunkUid/virtualPath/kind/name/signature:<ul>
<li>assert <code>symbolKey</code>, <code>signatureKey</code>, <code>scopedId</code> are correct.</li>
<li>assert <code>symbolId</code> is stable across runs.</li>
<li>assert <code>kindGroup</code> normalization.</li>
</ul>
</li>
</ul>
<hr />
<h3 id="93-implement-import-aware-cross-file-resolution-ambiguity-preserving">9.3 Implement import-aware cross-file resolution (ambiguity-preserving)<a class="headerlink" href="#93-implement-import-aware-cross-file-resolution-ambiguity-preserving" title="Permanent link"></a></h3>
<p><strong>Primary touchpoints</strong>
- <code>src/index/type-inference-crossfile/pipeline.js</code>
- New: <code>src/index/type-inference-crossfile/resolver.js</code>
- Update language relations to supply import bindings:
  - <code>src/lang/javascript/relations.js</code> (and optionally TS)</p>
<h4 id="931-extend-language-relations-to-capture-import-bindings-jsts">9.3.1 Extend language relations to capture import bindings (JS/TS)<a class="headerlink" href="#931-extend-language-relations-to-capture-import-bindings-jsts" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Modify <code>src/lang/javascript/relations.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> During AST walk, build <code>importBindings</code>:<ul>
<li><code>import { foo as bar } from "./x"</code> ⇒ <code>bar -&gt; { imported: "foo", module: "./x" }</code></li>
<li><code>import foo from "./x"</code> ⇒ <code>foo -&gt; { imported: "default", module: "./x" }</code></li>
<li><code>import * as ns from "./x"</code> ⇒ <code>ns -&gt; { imported: "*", module: "./x" }</code></li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Store in the returned relations object as <code>importBindings</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Modify <code>src/index/build/file-processor/relations.js</code></strong></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Include <code>importBindings</code> in fileRelations entries.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Update file_relations schema</strong> (<code>src/shared/artifact-schemas.js</code>)</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Allow optional <code>importBindings</code> field.</li>
</ul>
<h4 id="932-add-relative-import-resolver-helper">9.3.2 Add relative import resolver helper<a class="headerlink" href="#932-add-relative-import-resolver-helper" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Add <code>src/index/type-inference-crossfile/resolve-relative-import.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Implement <code>resolveRelativeImport(importerFile: string, spec: string, fileSet: Set&lt;string&gt;): string | null</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Constraints:<ul>
<li>only handle <code>./</code> and <code>../</code> specifiers</li>
<li>resolve with extension probing:</li>
<li><code>.ts</code>, <code>.tsx</code>, <code>.js</code>, <code>.jsx</code>, <code>.mjs</code>, <code>.cjs</code></li>
<li>directory index: <code>spec + "/index" + ext</code></li>
<li>normalize to repo-relative POSIX paths (match existing <code>chunk.file</code> conventions)</li>
</ul>
</li>
</ul>
<h4 id="933-implement-resolver-symbolref-builder">9.3.3 Implement resolver (SymbolRef builder)<a class="headerlink" href="#933-implement-resolver-symbolref-builder" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Add <code>src/index/type-inference-crossfile/resolver.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build a <code>NativeSymbolIndex</code> from <code>chunks</code>:<ul>
<li><code>byVirtualPath: Map&lt;string, { byExportName: Map&lt;string, SymbolDef[]&gt; }&gt;</code></li>
<li><code>byNameGlobal: Map&lt;string, SymbolDef[]&gt;</code></li>
<li>index both full qualifiedName and leaf name (<code>foo.bar</code> ⇒ also index <code>bar</code>) but record <code>matchKind</code>.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Implement <code>resolveRef({ fromChunk, targetName, kindHint, fileRelations, fileSet }): SymbolRefV1</code><ul>
<li>Bounded candidate collection + scoring (see caps below)</li>
<li>Import narrowing:</li>
<li>If <code>importBindings</code> provides a binding for the target&rsquo;s root identifier, resolve that module to a file.</li>
<li>Restrict candidate search to those files; then apply export filtering:<ul>
<li>if imported name is known, prefer matching exports.</li>
</ul>
</li>
<li>If exactly one best candidate above threshold ⇒ <code>status=resolved</code></li>
<li>Else if &gt;=2 candidates above threshold ⇒ <code>status=ambiguous</code> with top-K candidates</li>
<li>Else ⇒ <code>status=unresolved</code> with empty candidates</li>
</ul>
</li>
</ul>
<p><strong>Caps / guardrails (must be implemented):</strong></p>
<ul>
<li><code>MAX_CANDIDATES_PER_REF = 25</code></li>
<li><code>MAX_CANDIDATES_GLOBAL_SCAN = 200</code> (if exceeded, downgrade to ambiguous with &ldquo;too many&rdquo; signal)</li>
<li>Deterministic sorting of candidates:</li>
<li>primary: score desc</li>
<li>secondary: <code>symbolKey</code> asc</li>
</ul>
<h4 id="934-resolver-tests">9.3.4 Resolver tests<a class="headerlink" href="#934-resolver-tests" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Add <code>tests/crossfile/resolve-relative-import.test.js</code></strong></li>
<li>
<p>table-driven tests for extension probing and index resolution.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Add <code>tests/crossfile/symbolref-resolution.test.js</code></strong></p>
</li>
<li>Build synthetic chunks with metaV2.symbol identities across:<ul>
<li>two files exporting same name <code>foo</code> ⇒ ambiguous</li>
<li>importer with <code>import { foo } from "./a"</code> ⇒ resolved to <code>a</code></li>
<li>alias import <code>import { foo as bar }</code> and call <code>bar()</code> ⇒ resolved</li>
<li>unresolved case: no exports match</li>
</ul>
</li>
</ul>
<hr />
<h3 id="94-update-cross-file-inference-pipeline-to-emit-symbolref-based-links">9.4 Update cross-file inference pipeline to emit SymbolRef-based links<a class="headerlink" href="#94-update-cross-file-inference-pipeline-to-emit-symbolref-based-links" title="Permanent link"></a></h3>
<p><strong>Primary touchpoints</strong>
- <code>src/index/type-inference-crossfile/pipeline.js</code>
- <code>src/index/type-inference-crossfile/symbols.js</code> (deprecate or repurpose)
- Tooling providers that key by <code>file::name</code></p>
<h4 id="941-replace-filename-joins-with-chunkuidsymbol-identity-joins">9.4.1 Replace <code>file::name</code> joins with chunkUid/symbol identity joins<a class="headerlink" href="#941-replace-filename-joins-with-chunkuidsymbol-identity-joins" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Modify <code>src/index/type-inference-crossfile/pipeline.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Replace <code>chunkByKey</code> (<code>file::name</code>) map with:<ul>
<li><code>chunkByUid: Map&lt;chunkUid, chunk&gt;</code></li>
<li><code>defsBySymbolId: Map&lt;symbolId, chunkUid&gt;</code> (for quick reverse lookup)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Replace legacy <code>calleeKey = file::target</code> logic with resolved SymbolRef:<ul>
<li>call summary includes <code>resolvedCalleeChunkUid</code> when available.</li>
</ul>
</li>
</ul>
<h4 id="942-emit-new-format-calllinks-and-usagelinks">9.4.2 Emit new-format <code>callLinks</code> and <code>usageLinks</code><a class="headerlink" href="#942-emit-new-format-calllinks-and-usagelinks" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> In pipeline, for each call relation:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Build <code>SymbolRefV1</code> via resolver.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Append <code>codeRelations.callLinks</code> entry in <strong>new format</strong>:
    <div class="highlight"><pre>{
  v: 1,
  edgeKind: &quot;call&quot;,
  fromChunkUid: &lt;caller chunkUid&gt;,
  to: &lt;SymbolRefV1&gt;,
  confidence: &lt;0..1&gt;,
  evidence: {...}
}
</pre></div></li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Preserve legacy fields only if necessary for backward compatibility:</p>
<ul>
<li>if retained, ensure they are explicitly marked <code>legacy: true</code> and never used for joins.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Same for <code>usageLinks</code> with <code>edgeKind: "usage"</code>.</p>
</li>
</ul>
<h4 id="943-keep-callsummaries-but-add-chunkuid-resolution">9.4.3 Keep <code>callSummaries</code> but add chunkUid resolution<a class="headerlink" href="#943-keep-callsummaries-but-add-chunkuid-resolution" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Extend each <code>callSummaries[]</code> record to include:</li>
<li><code>calleeRef: SymbolRefV1</code></li>
<li><code>resolvedCalleeChunkUid: string | null</code></li>
<li>Keep <code>target/file/kind</code> for display backward compatibility.</li>
</ul>
<h4 id="944-update-tooling-providers-to-key-by-chunkuid-no-silent-overwrites">9.4.4 Update tooling providers to key by chunkUid (no silent overwrites)<a class="headerlink" href="#944-update-tooling-providers-to-key-by-chunkuid-no-silent-overwrites" title="Permanent link"></a></h4>
<p>These providers currently map results by <code>file::name</code>:</p>
<ul class="task-list">
<li><code>src/index/tooling/clangd-provider.js</code></li>
<li><code>src/index/tooling/pyright-provider.js</code></li>
<li><code>src/index/tooling/sourcekit-provider.js</code></li>
<li>
<p><code>src/index/tooling/typescript-provider.js</code></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> For each provider:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Replace Maps keyed by <code>file::name</code> with Maps keyed by <code>chunkUid</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Where tool outputs are only name-addressable (TS map), apply the resolved entry to all matching chunks but do not overwrite unrelated chunks.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add defensive warnings if multiple chunks match same name within a file (for diagnostics only; do not pick arbitrarily).</li>
</ul>
<h4 id="945-pipeline-tests">9.4.5 Pipeline tests<a class="headerlink" href="#945-pipeline-tests" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Update / add tests under <code>tests/type-inference-crossfile/*</code>:</li>
<li>Assert pipeline outputs <code>callLinks[].to.status</code> values are correct for fixtures.</li>
<li>Assert callSummaries contains <code>calleeRef</code> and <code>resolvedCalleeChunkUid</code> when resolvable.</li>
<li>Assert no <code>Map</code> join uses <code>file::name</code> in the pipeline (lint-like test via grep in CI is acceptable).</li>
</ul>
<hr />
<h3 id="95-emit-symbol-artifacts-symbols-symbol_occurrences-symbol_edges">9.5 Emit symbol artifacts (<code>symbols</code>, <code>symbol_occurrences</code>, <code>symbol_edges</code>)<a class="headerlink" href="#95-emit-symbol-artifacts-symbols-symbol_occurrences-symbol_edges" title="Permanent link"></a></h3>
<p><strong>Primary touchpoints</strong>
- <code>src/index/build/artifacts.js</code>
- New writer modules in <code>src/index/build/artifacts/writers/</code>
- <code>src/shared/artifact-io.js</code>
- <code>src/shared/artifact-schemas.js</code>
- <code>src/index/validate.js</code></p>
<h4 id="951-add-writer-modules">9.5.1 Add writer modules<a class="headerlink" href="#951-add-writer-modules" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Add <code>src/index/build/artifacts/writers/symbols.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Iterator over <code>state.chunks</code> yielding <code>symbols.jsonl</code> records.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Deterministic order: sort by <code>symbolId</code> (or by <code>(virtualPath, qualifiedName, kindGroup, chunkUid)</code> if streaming constraints require per-shard sort).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Use JSONL sharding logic similar to <code>file-relations.js</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Add <code>src/index/build/artifacts/writers/symbol-occurrences.js</code></strong></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Iterate chunks; for each call/usage relation occurrence emit occurrence record with <code>ref</code> included.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Add <code>src/index/build/artifacts/writers/symbol-edges.js</code></strong></p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Iterate chunks; for each callLinks/usageLinks edge emit edge record.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Emit unresolved/ambiguous edges as well (they&rsquo;re valuable for metrics and later resolution).</li>
</ul>
<h4 id="952-integrate-into-artifact-build">9.5.2 Integrate into artifact build<a class="headerlink" href="#952-integrate-into-artifact-build" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Modify <code>src/index/build/artifacts.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Write the three symbol artifacts into <code>index-code/</code>.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure pieces manifest includes them.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Modify <code>src/shared/artifact-io.js</code></strong></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add JSONL required keys entries for:</p>
<ul>
<li><code>symbols</code> (e.g., require <code>v</code>, <code>symbolId</code>, <code>chunkUid</code>)</li>
<li><code>symbol_edges</code> (require <code>v</code>, <code>edgeKind</code>, <code>fromChunkUid</code>, <code>to</code>)</li>
<li><code>symbol_occurrences</code> (require <code>v</code>, <code>fromChunkUid</code>, <code>occurrenceKind</code>)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <strong>Modify <code>src/shared/artifact-schemas.js</code></strong></p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add schemas for the new artifacts.</li>
</ul>
<h4 id="953-add-validation-and-metrics-hooks">9.5.3 Add validation and metrics hooks<a class="headerlink" href="#953-add-validation-and-metrics-hooks" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Modify <code>src/index/validate.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> When symbol artifacts are present:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> validate schema</li>
<li class="task-list-item"><input type="checkbox" disabled/> cross-check referential integrity:</li>
<li>every <code>symbols.chunkUid</code> exists in chunk_meta</li>
<li>every resolved edge <code>to.resolved.chunkUid</code> exists</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Compute and print metrics (non-fatal unless strict flag is enabled):<ul>
<li><code>resolvedRate</code>, <code>ambiguousRate</code>, <code>unresolvedRate</code></li>
</ul>
</li>
</ul>
<h4 id="954-tests-for-artifacts">9.5.4 Tests for artifacts<a class="headerlink" href="#954-tests-for-artifacts" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/artifacts/symbol-artifacts-smoke.test.js</code></li>
<li>Build a small in-memory &ldquo;fake state&rdquo; with 2 chunks and resolved/ambiguous links.</li>
<li>Run iterators and ensure JSONL output lines validate and include required keys.</li>
</ul>
<hr />
<h3 id="96-migrate-relation-graphs-to-use-chunkuid-and-resolved-edges-only">9.6 Migrate relation graphs to use <code>chunkUid</code> and resolved edges only<a class="headerlink" href="#96-migrate-relation-graphs-to-use-chunkuid-and-resolved-edges-only" title="Permanent link"></a></h3>
<p><strong>Primary touchpoints</strong>
- <code>src/index/build/graphs.js</code>
- <code>tests/graph-chunk-id.js</code>
- <code>src/map/build-map.js</code> (consumes graph_relations)</p>
<h4 id="961-update-graph-builder">9.6.1 Update graph builder<a class="headerlink" href="#961-update-graph-builder" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Modify <code>src/index/build/graphs.js</code></strong></li>
<li class="task-list-item"><input type="checkbox" disabled/> Node identity:<ul>
<li><code>nodeId = chunk.metaV2.chunkUid</code></li>
<li>Store legacy fields as attributes only.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Edges:<ul>
<li>For each <code>callLinks</code>/<code>usageLinks</code> edge record:</li>
<li>if <code>to.status !== "resolved"</code> ⇒ skip for graph_relations edges</li>
<li>else edge target is <code>to.resolved.chunkUid</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Remove <code>chunkIdByKey</code> (<code>file::name</code>) join logic entirely.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Keep guardrails and sampling; update samples to include <code>chunkUid</code>.</li>
</ul>
<h4 id="962-graph-schemaversion-bump">9.6.2 Graph schema/version bump<a class="headerlink" href="#962-graph-schemaversion-bump" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Bump <code>graph_relations.version</code> to <code>2</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure consumers handle version 1 and 2:</li>
<li>v1: id may be chunkId or legacyKey</li>
<li>v2: id is chunkUid</li>
<li>Map builder should accept both (backward compatibility).</li>
</ul>
<h4 id="963-tests">9.6.3 Tests<a class="headerlink" href="#963-tests" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>tests/graph-chunk-id.js</code></li>
<li>Ensure:<ul>
<li>nodes keyed by chunkUid</li>
<li>collision scenario produces distinct node ids</li>
<li>legacyKey remains in attrs for diagnostics</li>
</ul>
</li>
<li>Add regression: ambiguous edges are not included in graph edges.</li>
</ul>
<hr />
<h3 id="97-update-map-build-to-use-new-identities-and-avoid-collisions">9.7 Update map build to use new identities (and avoid collisions)<a class="headerlink" href="#97-update-map-build-to-use-new-identities-and-avoid-collisions" title="Permanent link"></a></h3>
<p><strong>Primary touchpoints</strong>
- <code>src/map/build-map.js</code>
- <code>src/map/isometric/client/map-data.js</code> (only if assumptions change)</p>
<h4 id="971-update-symbol-keying-inside-map-build">9.7.1 Update symbol keying inside map build<a class="headerlink" href="#971-update-symbol-keying-inside-map-build" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <strong>Modify <code>src/map/build-map.js</code></strong></li>
<li>Replace <code>buildSymbolId(file::name)</code> with:<ul>
<li>prefer <code>chunk.metaV2.symbol.symbolId</code></li>
<li>else use <code>chunk.metaV2.chunkUid</code></li>
</ul>
</li>
<li>Maintain a mapping:<ul>
<li><code>memberId -&gt; chunkUid</code></li>
</ul>
</li>
<li>Use graph_relations v2 node ids (<code>chunkUid</code>) to join to chunk_meta.</li>
</ul>
<h4 id="972-backward-compatibility">9.7.2 Backward compatibility<a class="headerlink" href="#972-backward-compatibility" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> If graph_relations.version === 1:</li>
<li>maintain existing behavior (best-effort)</li>
<li class="task-list-item"><input type="checkbox" disabled/> If version === 2:</li>
<li>require chunkUid mapping; fail with explicit error if missing (do not silently mis-join).</li>
</ul>
<h4 id="973-map-tests">9.7.3 Map tests<a class="headerlink" href="#973-map-tests" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>tests/map/map-build-symbol-identity.test.js</code></li>
<li>Build minimal graph_relations v2 + chunk_meta fixture.</li>
<li>Assert map members are distinct for same-name collisions.</li>
</ul>
<hr />
<h3 id="98-performance-determinism-and-regression-guardrails">9.8 Performance, determinism, and regression guardrails<a class="headerlink" href="#98-performance-determinism-and-regression-guardrails" title="Permanent link"></a></h3>
<h4 id="981-determinism-requirements">9.8.1 Determinism requirements<a class="headerlink" href="#981-determinism-requirements" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>chunkUid</code> deterministic for identical inputs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Symbol artifacts emitted in deterministic line order.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Graph builder output deterministic ordering (<code>serializeGraph</code> already sorts).</li>
</ul>
<p>Add tests:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/determinism/symbol-artifact-order.test.js</code></li>
<li>Run iterator twice and assert identical output.</li>
</ul>
<h4 id="982-throughput-requirements">9.8.2 Throughput requirements<a class="headerlink" href="#982-throughput-requirements" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Avoid O(N^2) scans over all symbols per reference:</li>
<li>use name-indexed maps and import-narrowing.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Avoid per-reference filesystem operations:</li>
<li>precompute <code>fileSet</code> in resolver.</li>
</ul>
<p>Add tests/benchmarks (optional but recommended):</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/bench/symbol-resolution-bench.js</code></li>
<li>synthetic repo with 100k symbols and 200k refs; ensure runtime is bounded.</li>
</ul>
<hr />
<h2 id="phase-9-exit-criteria-must-all-be-true">Phase 9 exit criteria (must all be true)<a class="headerlink" href="#phase-9-exit-criteria-must-all-be-true" title="Permanent link"></a></h2>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> No graph or cross-file linking code performs <code>Map.set()</code> keyed solely by <code>file::name</code> in a way that can silently overwrite distinct entities.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>metaV2.chunkUid</code> is present and non-empty for every code chunk (&ldquo;fail closed&rdquo;).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>graph_relations.version === 2</code> and node ids are <code>chunkUid</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Pipeline emits SymbolRef-based call/usage links; ambiguous/unresolved are preserved explicitly.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Symbol artifacts are written and validate successfully on the small fixture suite.</li>
<li class="task-list-item"><input type="checkbox" disabled/> New tests for chunkUid stability and resolver correctness are green.</li>
</ul>
<hr />
<h2 id="appendix-a-concrete-file-by-file-change-list-for-codex">Appendix A &ndash; Concrete file-by-file change list (for Codex)<a class="headerlink" href="#appendix-a-concrete-file-by-file-change-list-for-codex" title="Permanent link"></a></h2>
<p>This appendix is purely to reduce &ldquo;search time&rdquo; during implementation. Each file lists the exact intent.</p>
<h3 id="a1-new-files-to-add">A.1 New files to add<a class="headerlink" href="#a1-new-files-to-add" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/identity/normalize.js</code></li>
<li><code>src/index/identity/virtual-path.js</code></li>
<li><code>src/index/identity/segment-uid.js</code></li>
<li><code>src/index/identity/chunk-uid.js</code></li>
<li><code>src/index/identity/kind-group.js</code></li>
<li><code>src/index/identity/symbol.js</code></li>
<li><code>src/index/type-inference-crossfile/resolve-relative-import.js</code></li>
<li><code>src/index/type-inference-crossfile/resolver.js</code></li>
<li><code>src/index/build/artifacts/writers/symbols.js</code></li>
<li><code>src/index/build/artifacts/writers/symbol-occurrences.js</code></li>
<li><code>src/index/build/artifacts/writers/symbol-edges.js</code></li>
<li>Tests:</li>
<li><code>tests/identity/chunk-uid-stability.test.js</code></li>
<li><code>tests/identity/segment-uid-stability.test.js</code></li>
<li><code>tests/identity/symbol-identity.test.js</code></li>
<li><code>tests/crossfile/resolve-relative-import.test.js</code></li>
<li><code>tests/crossfile/symbolref-resolution.test.js</code></li>
<li><code>tests/artifacts/symbol-artifacts-smoke.test.js</code></li>
<li><code>tests/map/map-build-symbol-identity.test.js</code></li>
<li><code>tests/determinism/symbol-artifact-order.test.js</code></li>
</ul>
<h3 id="a2-existing-files-to-modify">A.2 Existing files to modify<a class="headerlink" href="#a2-existing-files-to-modify" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/segments.js</code> &ndash; compute and propagate <code>segmentUid</code></li>
<li><code>src/index/build/file-processor.js</code> &ndash; compute <code>chunkUid</code></li>
<li><code>src/index/build/file-processor/assemble.js</code> &ndash; pass through chunkUid fields</li>
<li><code>src/index/metadata-v2.js</code> &ndash; include identity + symbol identity</li>
<li><code>src/lang/javascript/relations.js</code> &ndash; emit <code>importBindings</code></li>
<li><code>src/index/build/file-processor/relations.js</code> &ndash; include importBindings</li>
<li><code>src/shared/artifact-schemas.js</code> &ndash; add schemas, extend file_relations</li>
<li><code>src/shared/artifact-io.js</code> &ndash; required keys for new JSONL artifacts</li>
<li><code>src/index/type-inference-crossfile/pipeline.js</code> &ndash; emit SymbolRef edges and avoid file::name joins</li>
<li><code>src/index/tooling/{typescript,pyright,clangd,sourcekit}-provider.js</code> &ndash; key by chunkUid</li>
<li><code>src/index/build/artifacts.js</code> &ndash; write symbol artifacts</li>
<li><code>src/index/validate.js</code> &ndash; validate symbol artifacts (optional strict)</li>
<li><code>src/index/build/graphs.js</code> &ndash; graph_relations v2 using chunkUid</li>
<li><code>src/map/build-map.js</code> &ndash; join graph nodes to chunk meta via chunkUid</li>
<li><code>tests/graph-chunk-id.js</code> &ndash; update</li>
</ul>
<hr />
<h2 id="appendix-b-metrics-to-report-recommended">Appendix B &ndash; Metrics to report (recommended)<a class="headerlink" href="#appendix-b-metrics-to-report-recommended" title="Permanent link"></a></h2>
<ul>
<li><code>symbol_resolution.resolved_rate</code></li>
<li><code>symbol_resolution.ambiguous_rate</code></li>
<li><code>symbol_resolution.unresolved_rate</code></li>
<li><code>symbol_resolution.max_candidates_hit_rate</code></li>
<li><code>symbol_resolution.import_narrowed_rate</code></li>
</ul>
<p>In strict CI mode, optionally enforce:</p>
<ul>
<li><code>wrong_link_rate == 0</code> on fixtures with gold truth</li>
<li><code>resolved_rate &gt;= threshold</code> on fixtures (threshold set per fixture)</li>
</ul>
<hr />
<h2 id="added-detail-phase-9-task-mapping">Added detail (Phase 9 task mapping)<a class="headerlink" href="#added-detail-phase-9-task-mapping" title="Permanent link"></a></h2>
<h3 id="91-identity-primitives-segmentuid-chunkuid-virtualpath">9.1 Identity primitives (segmentUid, chunkUid, virtualPath)<a class="headerlink" href="#91-identity-primitives-segmentuid-chunkuid-virtualpath" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>New: src/index/identity/normalize.js, virtual-path.js, segment-uid.js, chunk-uid.js</li>
<li>Existing: src/index/segments.js (assignSegmentUids / buildSegmentUid at ~17-50)</li>
<li>Existing: src/index/build/file-processor/assemble.js (buildChunkPayload at ~52-105)</li>
<li>Existing: src/index/metadata-v2.js (buildMetaV2 uses chunk/meta fields at ~214-260)</li>
<li>Existing: src/index/chunk-id.js (legacy chunkId; used by resolveChunkId)</li>
<li>Call sites/line refs:</li>
<li>src/index/segments.js:17-50 (buildSegmentUid, assignSegmentUids)</li>
<li>src/index/build/file-processor/assemble.js:52-105</li>
<li>src/index/chunk-id.js:1-18</li>
<li>Gaps/conflicts:</li>
<li>Resolved: docs/phases/phase-9/identity-contracts.md now matches docs/specs/identity-contract.md for chunkUid (span/pre/post hashes + virtualPath + segmentUid).</li>
<li>Phase 8 spec updated to align; Phase 9 remains the implementation target.</li>
</ul>
<h3 id="92-symbol-identity-metav2symbol-symbolref">9.2 Symbol identity (metaV2.symbol + SymbolRef)<a class="headerlink" href="#92-symbol-identity-metav2symbol-symbolref" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>New: src/index/identity/kind-group.js, src/index/identity/symbol.js</li>
<li>Existing: src/index/metadata-v2.js (add symbol object after identity fields)</li>
<li>Existing: src/index/type-inference-crossfile/symbols.js (leafName/isTypeDeclaration; may be replaced by identity helpers)</li>
<li>Call sites/line refs:</li>
<li>src/index/metadata-v2.js:214-260 (current metaV2 fields)</li>
<li>src/index/type-inference-crossfile/symbols.js:1-30</li>
<li>Gaps/conflicts:</li>
<li>Resolved: symbolKey inputs now use <code>virtualPath</code> (segmentUid-based), not segmentId.</li>
</ul>
<h3 id="93-import-aware-cross-file-resolver">9.3 Import-aware cross-file resolver<a class="headerlink" href="#93-import-aware-cross-file-resolver" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>New: src/index/type-inference-crossfile/resolve-relative-import.js, resolver.js</li>
<li>Existing: src/lang/javascript/relations.js (add importBindings during AST walk; call site around 360-420)</li>
<li>Existing: src/index/build/file-processor/relations.js (persist importBindings into fileRelations)</li>
<li>Existing: src/contracts/schemas/artifacts.js (extend file_relations schema)</li>
<li>Call sites/line refs:</li>
<li>src/lang/javascript/relations.js:360-418 (AST traversal + callDetails)</li>
<li>src/index/build/file-processor/relations.js:27-50</li>
<li>src/contracts/schemas/artifacts.js:318-334</li>
</ul>
<h3 id="94-pipeline-emits-symbolref-based-links">9.4 Pipeline emits SymbolRef-based links<a class="headerlink" href="#94-pipeline-emits-symbolref-based-links" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>src/index/type-inference-crossfile/pipeline.js (replace chunkByKey <code>${file}::${name}</code> at ~58-70; update callLinks at ~201-280)</li>
<li>src/index/type-inference-crossfile/symbols.js (or new resolver helpers)</li>
<li>src/index/tooling/* providers (clangd/pyright/sourcekit/typescript) keyed by file::name</li>
<li>Call sites/line refs:</li>
<li>src/index/type-inference-crossfile/pipeline.js:58-70, 201-280, 286, 340</li>
<li>src/index/tooling/typescript-provider.js:308</li>
<li>src/index/tooling/clangd-provider.js:230</li>
<li>src/index/tooling/pyright-provider.js:281, 328</li>
<li>src/index/tooling/sourcekit-provider.js:198</li>
<li>Gaps/conflicts:</li>
<li>Multiple providers split names by /::|./ (see src/index/type-inference-crossfile/symbols.js:4-9); switching to SymbolRef requires consistent qualifiedName handling.</li>
</ul>
<h3 id="95-symbol-artifacts-symbols-symbol_occurrences-symbol_edges">9.5 Symbol artifacts (symbols, symbol_occurrences, symbol_edges)<a class="headerlink" href="#95-symbol-artifacts-symbols-symbol_occurrences-symbol_edges" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>New writers: src/index/build/artifacts/writers/symbols.js, symbol-occurrences.js, symbol-edges.js</li>
<li>src/index/build/artifacts.js (enqueue writers near file_relations at ~380)</li>
<li>src/shared/artifact-io/jsonl.js (required keys list)</li>
<li>src/contracts/schemas/artifacts.js (add schemas)</li>
<li>src/index/validate.js (strict validation + referential checks)</li>
<li>Call sites/line refs:</li>
<li>src/index/build/artifacts.js:380-401</li>
<li>src/shared/artifact-io/jsonl.js:11-17</li>
<li>src/index/validate.js:76-95, 301-347</li>
</ul>
<h3 id="96-graph-relations-migrate-to-chunkuid">9.6 Graph relations migrate to chunkUid<a class="headerlink" href="#96-graph-relations-migrate-to-chunkuid" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>src/index/build/graphs.js (legacyKey + resolveChunkId at ~9-149)</li>
<li>tests/graph-chunk-id.js (update expectations)</li>
<li>Call sites/line refs:</li>
<li>src/index/build/graphs.js:9, 91-149</li>
<li>Gaps/conflicts:</li>
<li>resolveChunkId currently uses chunkId fallback; Phase 8 must ensure metaV2.chunkUid is populated to avoid legacyKey reuse.</li>
</ul>
<h3 id="97-map-build-identity-updates">9.7 Map build identity updates<a class="headerlink" href="#97-map-build-identity-updates" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>src/map/build-map.js (consume chunkUid + symbolId)</li>
<li>src/map/build-map/symbols.js (buildSymbolId uses file::name at ~11-16)</li>
<li>src/map/build-map/edges.js (edge member keys at ~104)</li>
<li>src/map/build-map/filters.js (file::name parsing at ~30-31, 115-116, 189-192, 216-217)</li>
<li>Call sites/line refs:</li>
<li>src/map/build-map/symbols.js:11-16</li>
<li>src/map/build-map/edges.js:104</li>
<li>src/map/build-map/filters.js:30-31, 115-116, 189-192, 216-217</li>
</ul>
<h3 id="98-performance-determinism-guardrails">9.8 Performance + determinism guardrails<a class="headerlink" href="#98-performance-determinism-guardrails" title="Permanent link"></a></h3>
<ul>
<li>Files to change/create:</li>
<li>src/index/build/graphs.js (serializeGraph already sorts; keep stable ordering)</li>
<li>new tests under tests/determinism/ and tools/bench/</li>
<li>Call sites/line refs:</li>
<li>src/index/build/graphs.js:45-68 (serializeGraph ordering)</li>
</ul>
<h3 id="associated-specs-reviewed-phase-9">Associated specs reviewed (Phase 9)<a class="headerlink" href="#associated-specs-reviewed-phase-9" title="Permanent link"></a></h3>
<ul>
<li>docs/phases/phase-9/identity-contracts.md</li>
<li>docs/phases/phase-9/symbol-artifacts-and-pipeline.md</li>
<li>docs/phases/phase-9/migration-and-backcompat.md</li>
<li>docs/specs/identity-contract.md</li>
<li>docs/specs/symbol-identity-and-symbolref.md</li>
<li>docs/specs/symbol-artifacts.md</li>
</ul>
<h2 id="phase-9-addendum-dependencies-ordering-artifacts-tests-edge-cases">Phase 9 addendum: dependencies, ordering, artifacts, tests, edge cases<a class="headerlink" href="#phase-9-addendum-dependencies-ordering-artifacts-tests-edge-cases" title="Permanent link"></a></h2>
<h3 id="cross-phase-ordering-phase-8-phase-9">Cross-phase ordering (Phase 8 ↔ Phase 9)<a class="headerlink" href="#cross-phase-ordering-phase-8-phase-9" title="Permanent link"></a></h3>
<ul>
<li>Identity primitives (<code>segmentUid</code>, <code>virtualPath</code>, <code>chunkUid</code>) <strong>must already be complete from Phase 8</strong> before any Phase 9 symbol/graph work starts.</li>
<li>Phase 9.1 is verification-only: if identity primitives are missing or drifted, stop Phase 9 and complete Phase 8 identity tasks first.</li>
<li>Identity tests (segmentUid/chunkUid/strict validation) must already be green from Phase 8; rerun only if identity code changes.</li>
</ul>
<h3 id="91-dependencies-and-order-of-operations">9.1 Dependencies and order of operations<a class="headerlink" href="#91-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>segmentUid algorithm must land before chunkUid (needs segment text).</li>
<li>virtualPath and chunkUid helpers must exist before any graph/tooling joins.</li>
<li>Order of operations:
  1) Compute segmentUid during segmentation (container text available).
  2) Build virtualPath and chunkUid during chunk assembly.
  3) Persist into metaV2 + chunk payload.
  4) Add strict validation for missing chunkUid.</li>
</ul>
<h3 id="91-acceptance-criteria-tests-lane">9.1 Acceptance criteria + tests (lane)<a class="headerlink" href="#91-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>Identity tests run in Phase 8 (see Phase 8 addendum). Rerun only if identity code changes.</li>
</ul>
<h3 id="91-edge-cases-and-fallback-behavior">9.1 Edge cases and fallback behavior<a class="headerlink" href="#91-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Missing segment text in cache hydrate: treat as cache miss and reprocess file.</li>
<li>chunkUid collision: escalate context once, then append :ord<N> deterministically.</li>
<li>Fail-closed: strict mode rejects any chunk missing chunkUid/segmentUid/virtualPath (no file::name fallback).</li>
</ul>
<h3 id="92-dependencies-and-order-of-operations">9.2 Dependencies and order of operations<a class="headerlink" href="#92-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>9.1 identity helpers must land before symbol identity helpers.</li>
<li>Order of operations:
  1) Implement kindGroup normalization.
  2) Implement symbolKey/signatureKey/scopedId builders.
  3) Add SymbolRef envelope helpers.</li>
</ul>
<h3 id="92-acceptance-criteria-tests-lane">9.2 Acceptance criteria + tests (lane)<a class="headerlink" href="#92-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/unit/identity-symbolkey-scopedid.test.js (test:unit)</li>
<li>tests/unit/symbolref-envelope.test.js (test:unit)</li>
</ul>
<h3 id="92-edge-cases-and-fallback-behavior">9.2 Edge cases and fallback behavior<a class="headerlink" href="#92-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Missing qualifiedName: fall back to chunk.name; mark symbolKey as low confidence.</li>
<li>Duplicate scopedId: deterministic ordinal suffix or strict-mode error (choose and document).</li>
</ul>
<h3 id="93-dependencies-and-order-of-operations">9.3 Dependencies and order of operations<a class="headerlink" href="#93-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>import bindings must be extracted before resolver runs.</li>
<li>Order of operations:
  1) Collect import bindings in relations extraction.
  2) Resolve relative imports to candidate files.
  3) Emit SymbolRef candidates with status=ambiguous when &gt;1.</li>
</ul>
<h3 id="93-acceptance-criteria-tests-lane">9.3 Acceptance criteria + tests (lane)<a class="headerlink" href="#93-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/integration/import-resolver-relative.test.js (test:integration)</li>
<li>tests/services/symbol-edges-ambiguous.test.js (test:services)</li>
</ul>
<h3 id="93-edge-cases-and-fallback-behavior">9.3 Edge cases and fallback behavior<a class="headerlink" href="#93-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Unresolved import: emit unresolved SymbolRef with candidates empty; keep edge.</li>
<li>Multiple matches: status=ambiguous; do not pick winner.</li>
<li>Fail-closed: if resolver cannot map to chunkUid candidates, mark unresolved; do not guess by name.</li>
</ul>
<h3 id="94-dependencies-and-order-of-operations">9.4 Dependencies and order of operations<a class="headerlink" href="#94-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>9.1 chunkUid and 9.2 symbol helpers must be present.</li>
<li>Order of operations:
  1) Build chunkUid map.
  2) Replace file::name joins with chunkUid joins.
  3) Attach SymbolRef info to call/usage links.</li>
</ul>
<h3 id="94-acceptance-criteria-tests-lane">9.4 Acceptance criteria + tests (lane)<a class="headerlink" href="#94-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/integration/file-name-collision-no-wrong-join.test.js (test:integration)</li>
<li>tests/services/symbol-links-by-chunkuid.test.js (test:services)</li>
</ul>
<h3 id="94-edge-cases-and-fallback-behavior">9.4 Edge cases and fallback behavior<a class="headerlink" href="#94-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Missing chunkUid: strict mode fails; non-strict logs and skips the link.</li>
<li>Multiple candidates: preserve ambiguity in SymbolRef.</li>
<li>Fail-closed: never backfill chunkUid joins from file::name; emit ambiguous/unresolved instead.</li>
</ul>
<h3 id="95-artifact-row-fields-symbolsjsonl-symbol_occurrencesjsonl-symbol_edgesjsonl">9.5 Artifact row fields (symbols.jsonl, symbol_occurrences.jsonl, symbol_edges.jsonl)<a class="headerlink" href="#95-artifact-row-fields-symbolsjsonl-symbol_occurrencesjsonl-symbol_edgesjsonl" title="Permanent link"></a></h3>
<ul>
<li>symbols.jsonl required keys (SymbolRecordV1):</li>
<li>v, symbolKey, scopedId, symbolId, qualifiedName, kindGroup, file, virtualPath, chunkUid</li>
<li>optional: signatureKey, languageId, chunkId, containerName, source</li>
<li>symbol_occurrences.jsonl required keys (SymbolOccurrenceV1):</li>
<li>v, host.file, host.chunkUid, role, ref (SymbolRefV1)</li>
<li>optional: meta.callerScopedId, meta.argMap</li>
<li>symbol_edges.jsonl required keys (SymbolEdgeV1):</li>
<li>v, type, from.file, from.chunkUid, to (SymbolRefV1)</li>
<li>optional: confidence, reason, call.argMap</li>
<li>Caps (set explicit defaults in schema/tests):</li>
<li>maxCandidates in SymbolRef (recommended: 25)</li>
<li>maxEvidence/snippet size (no raw snippets; use hashes)</li>
<li>maxRowBytes (recommended: 32768)</li>
</ul>
<h3 id="95-acceptance-criteria-tests-lane">9.5 Acceptance criteria + tests (lane)<a class="headerlink" href="#95-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/services/symbol-artifacts-emission.test.js (test:services)</li>
<li>tests/validate/symbol-integrity-strict.test.js (test:services)</li>
<li>tests/services/symbol-edges-ambiguous.test.js (test:services)</li>
</ul>
<h3 id="95-edge-cases-and-fallback-behavior">9.5 Edge cases and fallback behavior<a class="headerlink" href="#95-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Duplicate scopedId: strict validation fails; non-strict appends deterministic ordinal.</li>
<li>SymbolRef resolved but missing chunkUid: treat as unresolved and log.</li>
<li>Fail-closed: if SymbolRef is resolved but missing chunkUid/scopedId, drop edge in strict mode.</li>
</ul>
<h3 id="96-dependencies-and-order-of-operations">9.6 Dependencies and order of operations<a class="headerlink" href="#96-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>9.1 chunkUid must land before graph_relations v2.</li>
<li>Order of operations:
  1) Update graph node ids to chunkUid.
  2) Update edge targets to resolved chunkUid only.
  3) Keep legacyKey for diagnostics only.</li>
</ul>
<h3 id="96-acceptance-criteria-tests-lane">9.6 Acceptance criteria + tests (lane)<a class="headerlink" href="#96-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/integration/graph-relations-v2-chunkuid.test.js (test:integration)</li>
</ul>
<h3 id="96-edge-cases-and-fallback-behavior">9.6 Edge cases and fallback behavior<a class="headerlink" href="#96-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Missing chunkUid in chunk_meta: strict mode fails; non-strict skips node.</li>
</ul>
<h3 id="97-dependencies-and-order-of-operations">9.7 Dependencies and order of operations<a class="headerlink" href="#97-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>Graph relations v2 must be complete before map build joins.</li>
<li>Order of operations:
  1) Join map entries by chunkUid.
  2) Fallback to chunkId only for diagnostics.</li>
</ul>
<h3 id="97-acceptance-criteria-tests-lane">9.7 Acceptance criteria + tests (lane)<a class="headerlink" href="#97-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/integration/map-chunkuid-join.test.js (test:integration)</li>
</ul>
<h3 id="97-edge-cases-and-fallback-behavior">9.7 Edge cases and fallback behavior<a class="headerlink" href="#97-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Multiple map entries for same chunkUid: keep deterministic ordering, dedupe by chunkUid.</li>
</ul>
<h3 id="98-dependencies-and-order-of-operations">9.8 Dependencies and order of operations<a class="headerlink" href="#98-dependencies-and-order-of-operations" title="Permanent link"></a></h3>
<ul>
<li>Dependencies:</li>
<li>Determinism checks after all artifact emission.</li>
<li>Order of operations:
  1) Run determinism tests (two builds).
  2) Verify collision handling is stable.</li>
</ul>
<h3 id="98-acceptance-criteria-tests-lane">9.8 Acceptance criteria + tests (lane)<a class="headerlink" href="#98-acceptance-criteria-tests-lane" title="Permanent link"></a></h3>
<ul>
<li>tests/integration/chunkuid-determinism.test.js (test:integration)</li>
<li>tests/integration/symbol-artifact-determinism.test.js (test:integration)</li>
</ul>
<h3 id="98-edge-cases-and-fallback-behavior">9.8 Edge cases and fallback behavior<a class="headerlink" href="#98-edge-cases-and-fallback-behavior" title="Permanent link"></a></h3>
<ul>
<li>Large repos: enforce sharded emission; fail if memory cap exceeded.</li>
</ul>
<h2 id="fixtures-list-phase-9">Fixtures list (Phase 9)<a class="headerlink" href="#fixtures-list-phase-9" title="Permanent link"></a></h2>
<ul>
<li>tests/fixtures/identity/chunkuid-collision</li>
<li>tests/fixtures/symbols/ambiguous-defs</li>
<li>tests/fixtures/imports/relative-ambiguous</li>
<li>tests/fixtures/graph/chunkuid-join</li>
</ul>
<h2 id="compatmigration-checklist-phase-9">Compat/migration checklist (Phase 9)<a class="headerlink" href="#compatmigration-checklist-phase-9" title="Permanent link"></a></h2>
<ul>
<li>Keep chunkId and segmentId in metaV2 for debug/back-compat only.</li>
<li>Emit graph_relations v2 with chunkUid node ids; keep legacyKey for diagnostics only.</li>
<li>Symbol artifacts are additive; do not remove legacy repo_map outputs.</li>
</ul>
<h2 id="artifacts-contract-appendix-phase-9">Artifacts contract appendix (Phase 9)<a class="headerlink" href="#artifacts-contract-appendix-phase-9" title="Permanent link"></a></h2>
<ul>
<li>symbols.jsonl</li>
<li>required keys: v, symbolKey, scopedId, symbolId, qualifiedName, kindGroup, file, virtualPath, chunkUid</li>
<li>optional keys: signatureKey, languageId, chunkId, containerName, source</li>
<li>caps: maxRowBytes 32768</li>
<li>symbol_occurrences.jsonl</li>
<li>required keys: v, host.file, host.chunkUid, role, ref (SymbolRefV1)</li>
<li>optional keys: meta.callerScopedId, meta.argMap</li>
<li>symbol_edges.jsonl</li>
<li>required keys: v, type, from.file, from.chunkUid, to (SymbolRefV1)</li>
<li>optional keys: confidence, reason, call.argMap</li>
<li>graph_relations.json (v2)</li>
<li>required node ids: chunkUid</li>
<li>legacyKey allowed for diagnostics only</li>
</ul>
<hr />
<h2 id="phase-10-interprocedural-risk-flows-taint-summaries-propagation">Phase 10 &ndash; Interprocedural Risk Flows (taint summaries + propagation)<a class="headerlink" href="#phase-10-interprocedural-risk-flows-taint-summaries-propagation" title="Permanent link"></a></h2>
<ul>
<li>There are new or additional versions of specs referenced in this work at <code>docs\new_docs</code></li>
<li>Please carefully review each one</li>
<li>Underneath this list, make a checkbox list items for each document this phase mentions that has relevant new_docs</li>
<li>Underneath each actual document, list the new documents as sub items</li>
<li>Once you have gathered them all, comprehensively merge any useful improvements or changes they offer into our documents</li>
<li>
<p>If there are conflicting choices, make the best choice. Document the chocies made in the list. We want to leave no ambiguity</p>
</li>
<li>
<p>Phase 10 introduces a non-artifact interface (<code>state.riskInterprocedural</code>) that is not fully specified in the existing Phase 10 docs.</p>
</li>
<li>Draft spec: <code>spec_risk-interprocedural-state-and-pipeline_DRAFT.md</code> (<strong>needs another pass after first implementation</strong>)</li>
</ul>
<h3 id="canonical-specs-to-implement">Canonical specs to implement<a class="headerlink" href="#canonical-specs-to-implement" title="Permanent link"></a></h3>
<p>Use these specs as the normative contracts:</p>
<ul>
<li>Config: <code>docs/specs/risk-interprocedural-config.md</code></li>
<li>Summaries: <code>docs/specs/risk-summaries.md</code> </li>
<li>Flows: <code>docs/specs/risk-flows-and-call-sites.md</code></li>
<li>CallSiteId + stats: <code>docs/specs/risk-callsite-id-and-stats.md</code></li>
</ul>
<hr />
<h2 id="global-decisions-apply-everywhere">Global decisions (apply everywhere)<a class="headerlink" href="#global-decisions-apply-everywhere" title="Permanent link"></a></h2>
<h3 id="d1-use-chunkuid-as-the-canonical-identity">D1. Use <code>chunkUid</code> as the canonical identity<a class="headerlink" href="#d1-use-chunkuid-as-the-canonical-identity" title="Permanent link"></a></h3>
<p>The repo already treats <code>chunkUid</code> as the stable chunk identifier (<code>metaV2.chunkUid</code> and <code>chunk.chunkUid</code>).
- <strong>All new maps/keys must be keyed by <code>chunkUid</code></strong>.
- <code>chunkId</code> (range-derived) may be emitted only as an optional debugging field.</p>
<h3 id="d2-call_sitesjsonl-is-a-shared-artifact-with-an-existing-contract">D2. <code>call_sites.jsonl</code> is a shared artifact with an existing contract<a class="headerlink" href="#d2-call_sitesjsonl-is-a-shared-artifact-with-an-existing-contract" title="Permanent link"></a></h3>
<p>The repo already writes <code>call_sites.jsonl</code> via:
- Writer: <code>src/index/build/artifacts/writers/call-sites.js</code>
- Schema: <code>src/contracts/schemas/artifacts.js</code> (<code>callSiteEntry</code>)
- Required keys: <code>src/shared/artifact-io/jsonl.js</code> (<code>call_sites</code>)</p>
<p>Phase 10 must <strong>not</strong> introduce a divergent call-sites schema. Instead:
- Ensure prerequisites (location/offsets) for all languages.
- Optionally add deterministic sampling/filtering <strong>without removing required fields</strong>.</p>
<h3 id="d3-respect-analysispolicy-overrides">D3. Respect <code>analysisPolicy</code> overrides<a class="headerlink" href="#d3-respect-analysispolicy-overrides" title="Permanent link"></a></h3>
<p>Runtime config is not the only authority: per-chunk and cross-file behavior can be overridden by <code>analysisPolicy</code>.
Phase 10 gating must treat <code>analysisPolicy.risk.enabled === false</code> as disabling interprocedural work.</p>
<hr />
<h2 id="101-config-wiring-runtime-gating">10.1 Config wiring + runtime gating<a class="headerlink" href="#101-config-wiring-runtime-gating" title="Permanent link"></a></h2>
<h3 id="files">Files<a class="headerlink" href="#files" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/build/runtime/runtime.js</code> — runtime config parsing and feature flags.</li>
<li><code>src/index/build/indexer/steps/relations.js</code> — cross-file inference gating.</li>
<li><code>src/index/build/indexer/steps/write.js</code> — <code>index_state.json</code> feature recording.</li>
<li><code>src/index/build/indexer/signatures.js</code> — incremental signature payload </li>
</ul>
<h3 id="new-files">New Files<a class="headerlink" href="#new-files" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/risk-interprocedural/config.js</code> — normalization per spec.</li>
</ul>
<h3 id="anchors">Anchors<a class="headerlink" href="#anchors" title="Permanent link"></a></h3>
<ul>
<li><code>runtime.js</code>:</li>
<li><code>createBuildRuntime()</code> begins at <strong>L38</strong>.</li>
<li><code>const riskAnalysisEnabled = …</code> at <strong>L163</strong>.</li>
<li>main return object begins at <strong>L592</strong> (<code>return { … }</code>).</li>
<li><code>relations.js</code>:</li>
<li><code>runCrossFileInference()</code> begins at <strong>L133</strong>.</li>
<li><code>const crossFileEnabled = …</code> at <strong>L139</strong>.</li>
<li><code>write.js</code>:</li>
<li><code>writeIndexArtifactsForMode()</code> begins at <strong>L41</strong>.</li>
<li><code>const indexState = { … }</code> at <strong>L52</strong>.</li>
<li><code>signatures.js</code>:</li>
<li><code>buildIncrementalSignaturePayload()</code> begins at <strong>L13</strong>.</li>
</ul>
<h3 id="tasks">Tasks<a class="headerlink" href="#tasks" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement config normalization in <code>src/index/risk-interprocedural/config.js</code>.</li>
<li>Output: <code>{ enabled, strictness, summaryOnly, emitArtifacts, sanitizerPolicy, maxDepth, maxFlows, maxCallSitesPerEdge, maxWorkMs, maxNodesVisited, maxEvidencePerChunk, maxSignalsPerChunk, maxArgsPerCallSite, maxSnippetBytesPerEvidence }</code></li>
<li>
<p>Must follow defaults and validation rules in <code>risk-interprocedural-config.md</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Wire normalized config into runtime.</p>
</li>
<li>File: <code>src/index/build/runtime/runtime.js</code></li>
<li>Change point: after <code>riskConfig</code> normalization (~L166) and before the return object (L592+).</li>
<li>Add:<ul>
<li><code>runtime.riskInterproceduralConfig</code> (normalized)</li>
<li><code>runtime.riskInterproceduralEnabled</code> (gated)</li>
<li><code>runtime.riskInterproceduralEffectiveEmit</code> (resolved emit policy)</li>
</ul>
</li>
<li>
<p><strong>Gating rule:</strong> if resolved risk is disabled (<code>analysisPolicy.risk.enabled === false</code>) OR <code>runtime.mode !== "code"</code> =&gt; disable.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure cross-file inference runs when interprocedural risk is enabled.</p>
</li>
<li>File: <code>src/index/build/indexer/steps/relations.js</code></li>
<li>Change point: <code>crossFileEnabled</code> at L139.</li>
<li>Update to include <code>runtime.riskInterproceduralEnabled</code>.</li>
<li>
<p>Ensure <code>applyCrossFileInference()</code> is invoked with:</p>
<ul>
<li><code>enableTypeInference = runtime.typeInferenceCrossFileEnabled</code></li>
<li><code>enableRiskCorrelation = runtime.riskAnalysisCrossFileEnabled</code></li>
<li><strong>Do not implicitly enable either</strong> just because interprocedural risk is on.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Record feature enablement into the build signature.</p>
</li>
<li>File: <code>src/index/build/indexer/signatures.js</code></li>
<li>Change point: <code>features</code> object at L47.</li>
<li>
<p>Add booleans/config summary fields so incremental builds don’t reuse an incompatible signature.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Record feature enablement into <code>index_state.json</code>.</p>
</li>
<li>File: <code>src/index/build/indexer/steps/write.js</code></li>
<li>Change point: <code>indexState.features</code> around L86.</li>
<li>Add <code>riskInterprocedural: &lt;boolean&gt;</code>.</li>
<li>If you need to persist a config summary, use <code>indexState.extensions.riskInterprocedural</code> (schema-safe) rather than adding a new top-level property.</li>
</ul>
<h3 id="tests-to-addadjust">Tests to add/adjust<a class="headerlink" href="#tests-to-addadjust" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Unit: config normalization (defaults + invalid values).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Unit: runtime gating respects <code>analysisPolicy.risk.enabled</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Unit: build signature changes when feature toggled.</li>
</ul>
<hr />
<h2 id="102-prerequisites-stable-params-call-site-locations">10.2 Prerequisites: stable params + call-site locations<a class="headerlink" href="#102-prerequisites-stable-params-call-site-locations" title="Permanent link"></a></h2>
<h3 id="files_1">Files<a class="headerlink" href="#files_1" title="Permanent link"></a></h3>
<ul>
<li>JS:</li>
<li><code>src/lang/javascript/relations.js</code> (function param extraction; callDetails)</li>
<li><code>src/lang/javascript/docmeta.js</code> (docmeta param population)</li>
<li>Python:</li>
<li><code>src/lang/python/ast-script.js</code> (call_details payload)</li>
<li>Cross-file type inference:</li>
<li><code>src/index/type-inference-crossfile/extract.js</code> (return-type extraction)</li>
<li><code>src/index/metadata-v2.js</code> (declared return typing)</li>
</ul>
<h3 id="anchors_1">Anchors<a class="headerlink" href="#anchors_1" title="Permanent link"></a></h3>
<ul>
<li>JS params:</li>
<li><code>collectParamMeta()</code> at <code>src/lang/javascript/relations.js</code> <strong>L193-L243</strong>.</li>
<li><code>extractDocMeta()</code> at <code>src/lang/javascript/docmeta.js</code> <strong>L9+</strong>.</li>
<li>JS call details:</li>
<li><code>resolveCallLocation()</code> at <code>src/lang/javascript/relations.js</code> <strong>L344-L399</strong>.</li>
<li>call details push loop at <strong>L481-L520</strong>.</li>
<li>Python call details:</li>
<li><code>call_details.append({...})</code> at <code>src/lang/python/ast-script.js</code> <strong>~L435</strong>.</li>
</ul>
<h3 id="tasks_1">Tasks<a class="headerlink" href="#tasks_1" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Enforce deterministic param naming for destructured params (JS).</li>
<li>Problem: current <code>collectPatternNames()</code> explodes destructuring into many names.</li>
<li>Fix: for each parameter index <code>i</code>, emit a single positional name (<code>arg0</code>, <code>arg1</code>, …) when the param is not an Identifier.</li>
<li>
<p>Optional: separately capture destructured binding names into a non-signature field (do not feed into <code>docmeta.params</code>).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure <code>docmeta.params</code> uses the stable signature param list.</p>
</li>
<li>File: <code>src/lang/javascript/docmeta.js</code></li>
<li>
<p>Change point: where it prefers <code>astMeta.functionMeta.params</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure callDetails include <strong>line+col and offsets</strong> for all languages.</p>
</li>
<li>JS already provides offsets/loc; make <code>resolveCallLocation()</code> tolerant (if needed) rather than dropping location.</li>
<li>
<p>Python must add:</p>
<ul>
<li><code>startLine</code>, <code>startCol</code>, <code>endLine</code>, <code>endCol</code></li>
<li><code>start</code>, <code>end</code> (character offsets) <strong>because the repo’s <code>call_sites</code> schema requires them</strong>.</li>
<li>Suggestion: compute offsets from the <code>source</code> string via a <code>lineStartOffsets[]</code> table.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> (Verify-only) return types never emit boolean values.</p>
</li>
<li><code>collectDeclaredReturnTypes()</code> already ignores non-string/object return types.</li>
<li>Add regression tests to prevent future reintroduction.</li>
</ul>
<h3 id="tests-to-add">Tests to add<a class="headerlink" href="#tests-to-add" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> JS: destructured params produce <code>argN</code> signature params (no exploded names).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Python: call details now include location+offsets, enabling <code>call_sites.jsonl</code> rows.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Cross-file: declared returns never include boolean-derived strings.</li>
</ul>
<hr />
<h2 id="103-local-risk-summaries">10.3 Local risk summaries<a class="headerlink" href="#103-local-risk-summaries" title="Permanent link"></a></h2>
<h3 id="files-new">Files (new)<a class="headerlink" href="#files-new" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/risk-interprocedural/summaries.js</code></li>
</ul>
<h3 id="files-existing-integration">Files (existing, integration)<a class="headerlink" href="#files-existing-integration" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/build/indexer/steps/relations.js</code> (run summaries before propagation)</li>
<li><code>src/index/metadata-v2.js</code> (already rebuilds metaV2 late; ensure summary attached before write)</li>
</ul>
<h3 id="anchors_2">Anchors<a class="headerlink" href="#anchors_2" title="Permanent link"></a></h3>
<ul>
<li><code>relations.js</code>: insert after <code>applyCrossFileInference()</code> (around L170) and before the step returns.</li>
<li><code>write.js</code>: <code>finalizeMetaV2()</code> is already called before writing artifacts (L35+).</li>
</ul>
<h3 id="tasks_2">Tasks<a class="headerlink" href="#tasks_2" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement <code>buildRiskSummaries(chunks, runtime, riskRules)</code>.</li>
<li>Outputs:<ul>
<li><code>summariesByChunkUid: Map&lt;chunkUid, RiskSummaryRow&gt;</code></li>
<li><code>compactByChunkUid: Map&lt;chunkUid, RiskCompactSummary&gt;</code></li>
<li><code>statsDelta</code> (for Phase 10 stats)</li>
</ul>
</li>
<li>
<p>Ordering + capping must follow <code>spec_risk-summaries_IMPROVED.md</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Attach <code>docmeta.risk.summary</code> for chunks with local risk.</p>
</li>
<li>
<p>Store the compact summary on <code>chunk.docmeta.risk.summary</code> so <code>metaV2</code> includes it.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Persist results in <code>state.riskInterprocedural</code> for later artifact writing.</p>
</li>
<li>Structure per <code>spec_risk-interprocedural-state-and-pipeline_DRAFT.md</code>.</li>
</ul>
<h3 id="tests-to-add_1">Tests to add<a class="headerlink" href="#tests-to-add_1" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Determinism: summary JSON lines stable across runs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Caps: evidence and signals capped per spec; stats reflect truncations.</li>
</ul>
<hr />
<h2 id="104-call-site-evidence-for-propagation-paths">10.4 Call-site evidence for propagation paths<a class="headerlink" href="#104-call-site-evidence-for-propagation-paths" title="Permanent link"></a></h2>
<p><strong>Important:</strong> The repo already has a call-sites writer. Phase 10 should extend it rather than invent a second <code>call_sites.jsonl</code>.</p>
<h3 id="files-existing">Files (existing)<a class="headerlink" href="#files-existing" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/build/artifacts/writers/call-sites.js</code></li>
<li><code>src/shared/artifact-io/jsonl.js</code> (required keys already include <code>call_sites</code>)</li>
<li><code>src/contracts/schemas/artifacts.js</code> (call site schema)</li>
</ul>
<h3 id="anchors_3">Anchors<a class="headerlink" href="#anchors_3" title="Permanent link"></a></h3>
<ul>
<li><code>call-sites.js</code>:</li>
<li><code>createCallSites()</code> begins around <strong>L151</strong>.</li>
<li><code>createCallSiteId()</code> around <strong>L43</strong>.</li>
</ul>
<h3 id="tasks_3">Tasks<a class="headerlink" href="#tasks_3" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Make call-sites selection bounded and deterministic.</li>
<li>Minimum: cap <strong>per edge</strong> at <code>maxCallSitesPerEdge</code>.</li>
<li>
<p>Deterministic strategy: group by edge, sort by <code>callSiteId</code>, take first N.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure referential integrity for <code>risk_flows.callSiteIdsByStep</code>.</p>
</li>
<li>If Phase 10 chooses to emit only call-sites “used by flows”, add an optional filter input (<code>allowedCallSiteIds</code> or <code>allowedEdges</code>) to the writer.</li>
<li>If Phase 10 keeps emitting broader call-sites, ensure <code>explain-risk</code> can stream-filter.</li>
</ul>
<h3 id="tests-to-add_2">Tests to add<a class="headerlink" href="#tests-to-add_2" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Deterministic sampling per edge.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Writer honors caps and still produces schema-valid rows.</li>
</ul>
<hr />
<h2 id="105-interprocedural-propagation">10.5 Interprocedural propagation<a class="headerlink" href="#105-interprocedural-propagation" title="Permanent link"></a></h2>
<h3 id="files-new_1">Files (new)<a class="headerlink" href="#files-new_1" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/risk-interprocedural/engine.js</code></li>
<li><code>src/index/risk-interprocedural/propagate.js</code></li>
</ul>
<h3 id="files-existing_1">Files (existing)<a class="headerlink" href="#files-existing_1" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/build/indexer/steps/relations.js</code> (invoke propagation)</li>
<li><code>src/index/type-inference-crossfile/pipeline.js</code> (callLinks contain <code>targetChunkUid</code>)</li>
</ul>
<h3 id="anchors_4">Anchors<a class="headerlink" href="#anchors_4" title="Permanent link"></a></h3>
<ul>
<li><code>pipeline.js</code>: resolved call links include <code>targetChunkUid</code> (see <code>linksFromDocs()</code> around <strong>L249+</strong>).</li>
</ul>
<h3 id="tasks_4">Tasks<a class="headerlink" href="#tasks_4" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Propagate using <code>chunkUid</code> edges only.</li>
<li>Build a graph from <code>chunk.codeRelations.callLinks</code> where each link includes <code>targetChunkUid</code>.</li>
<li>
<p>Ignore unresolved edges (no <code>targetChunkUid</code>).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement strictness modes per config.</p>
</li>
<li><code>conservative</code>: treat any argument flow as tainted.</li>
<li>
<p><code>argAware</code>: respect argument index, parameter mapping, and sanitizers.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Determinism + guardrails.</p>
</li>
<li><code>maxWorkMs</code>, <code>maxNodesVisited</code>, <code>maxDepth</code>, <code>maxFlows</code>.</li>
<li>
<p>Stable ordering of queue operations.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Produce <code>risk_flows</code> rows per <code>spec_risk-flows-and-call-sites_RECONCILED.md</code>.</p>
</li>
<li>Use <code>callSiteIdsByStep</code> to reference sampled call-sites.</li>
</ul>
<h3 id="tests-to-add_3">Tests to add<a class="headerlink" href="#tests-to-add_3" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Multi-hop propagation across JS/Python fixtures.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Strictness mode differences.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Guardrail-triggered <code>timed_out</code> / <code>truncated</code> statuses.</li>
</ul>
<hr />
<h2 id="106-artifact-writing-validation">10.6 Artifact writing + validation<a class="headerlink" href="#106-artifact-writing-validation" title="Permanent link"></a></h2>
<h3 id="files-existing_2">Files (existing)<a class="headerlink" href="#files-existing_2" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/build/artifacts.js</code> (enqueue artifacts)</li>
<li><code>src/shared/artifact-io/jsonl.js</code> (required keys for new JSONL artifacts)</li>
<li><code>src/contracts/schemas/artifacts.js</code> (schemas)</li>
<li><code>src/index/validate.js</code> (validator)</li>
</ul>
<h3 id="files-new_2">Files (new)<a class="headerlink" href="#files-new_2" title="Permanent link"></a></h3>
<ul>
<li><code>src/index/build/artifacts/writers/risk-interprocedural.js</code> writes:</li>
<li><code>risk_summaries.jsonl</code></li>
<li><code>risk_flows.jsonl</code></li>
<li><code>risk_interprocedural_stats.json</code>)</li>
</ul>
<h3 id="anchors_5">Anchors<a class="headerlink" href="#anchors_5" title="Permanent link"></a></h3>
<ul>
<li><code>build/artifacts.js</code>: add new enqueue near other JSONL writers.</li>
<li><code>validate.js</code>: add loaders and referential-integrity checks.</li>
</ul>
<h3 id="tasks_5">Tasks<a class="headerlink" href="#tasks_5" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add artifact schemas to contracts.</li>
<li><code>risk_summaries</code> and <code>risk_flows</code> JSONL rows.</li>
<li>
<p><code>risk_interprocedural_stats</code> JSON.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add JSONL required-key lists.</p>
</li>
<li>File: <code>src/shared/artifact-io/jsonl.js</code></li>
<li>
<p>Add keys for <code>risk_summaries</code> + <code>risk_flows</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add validator coverage.</p>
</li>
<li>Structural schema validation.</li>
<li>Referential integrity:<ul>
<li>every <code>risk_flows.callSiteId</code> referenced must exist in <code>call_sites</code>.</li>
</ul>
</li>
</ul>
<h3 id="tests-to-add_4">Tests to add<a class="headerlink" href="#tests-to-add_4" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Schema/required-key enforcement.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Referential-integrity failures produce actionable errors.</li>
</ul>
<hr />
<h2 id="107-cli-explain-risk">10.7 CLI: explain-risk<a class="headerlink" href="#107-cli-explain-risk" title="Permanent link"></a></h2>
<h3 id="files-new_3">Files (new)<a class="headerlink" href="#files-new_3" title="Permanent link"></a></h3>
<ul>
<li><code>tools/explain-risk.js</code></li>
</ul>
<h3 id="files-existing_3">Files (existing)<a class="headerlink" href="#files-existing_3" title="Permanent link"></a></h3>
<ul>
<li><code>bin/pairofcleats.js</code> (wire command)</li>
<li><code>src/shared/artifact-io/*</code> (read JSONL / sharded JSONL)</li>
</ul>
<h3 id="tasks_6">Tasks<a class="headerlink" href="#tasks_6" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement CLI that can:</li>
<li>Filter by <code>--chunk-uid</code>, <code>--rule-id</code>, <code>--flow-id</code>.</li>
<li>
<p>Print local risk summary and the interprocedural flows that originate from a chunk.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure it is memory-safe for large JSONL.</p>
</li>
<li>Prefer streaming iteration over loading entire arrays.</li>
</ul>
<h3 id="tests-to-add_5">Tests to add<a class="headerlink" href="#tests-to-add_5" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Golden output tests with small fixtures.</li>
</ul>
<hr />
<h2 id="108-end-to-end-tests">10.8 End-to-end tests<a class="headerlink" href="#108-end-to-end-tests" title="Permanent link"></a></h2>
<h3 id="tests-to-add_6">Tests to add<a class="headerlink" href="#tests-to-add_6" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Small repo fixture with:</li>
<li>source → helper → sink (multi-hop)</li>
<li>sanitizer on one path</li>
<li>
<p>both JS + Python call edges</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Validate artifacts:</p>
</li>
<li><code>risk_summaries.jsonl</code> present when enabled</li>
<li><code>risk_flows.jsonl</code> present when <code>summaryOnly=false</code></li>
<li><code>call_sites.jsonl</code> contains all referenced callSiteIds</li>
<li><code>risk_interprocedural_stats.json</code> status reflects guardrails</li>
</ul>
<hr />
<h2 id="phase-11-graph-powered-product-features-context-packs-impact-explainability-ranking">Phase 11 — Graph-powered product features (context packs, impact, explainability, ranking)<a class="headerlink" href="#phase-11-graph-powered-product-features-context-packs-impact-explainability-ranking" title="Permanent link"></a></h2>
<h3 id="objective_2">Objective<a class="headerlink" href="#objective_2" title="Permanent link"></a></h3>
<p>Turn graph and identity primitives into <strong>safe, bounded, deterministic</strong> product surfaces: graph context packs, impact analysis, explainable graph-aware ranking (opt-in), and structured outputs suitable for both CLI use and future API/MCP consumers.</p>
<ul>
<li>Assumes canonical identities exist (e.g., chunkUid/SymbolId and a canonical reference envelope for unresolved/ambiguous links).</li>
<li>Any graph expansion MUST be bounded and MUST return truncation metadata when caps trigger (depth/fanout/paths/nodes/edges/time).</li>
<li>The default search contract must remain stable: graph features can change ordering when enabled, but must not change membership/correctness.</li>
</ul>
<hr />
<h3 id="111-graph-context-packs-bounded-neighborhood-extraction-retrieval-context-expansion-hardening">11.1 Graph context packs (bounded neighborhood extraction) + retrieval context-expansion hardening<a class="headerlink" href="#111-graph-context-packs-bounded-neighborhood-extraction-retrieval-context-expansion-hardening" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Define a graph context pack contract (JSON-first; Markdown render optional).</li>
<li>Output shape (minimum):<ul>
<li><code>seed</code> (canonical id + type)</li>
<li><code>nodes[]</code> (bounded; stable ordering)</li>
<li><code>edges[]</code> (bounded; stable ordering; include direction and edge type)</li>
<li><code>paths[]</code> (optional; bounded witness paths when requested)</li>
<li><code>truncation[]</code> (one or more truncation records; absent only when no caps trigger)</li>
<li><code>warnings[]</code> (e.g., missing artifacts, partial/unresolved edges)</li>
</ul>
</li>
<li>Link safety:<ul>
<li>Any edge endpoint that fails to resolve MUST use a reference envelope (resolved/ambiguous/unresolved + candidates + reason + confidence).</li>
</ul>
</li>
<li>
<p>Cap surface (configurable):</p>
<ul>
<li><code>maxDepth</code>, <code>maxFanoutPerNode</code>, <code>maxNodes</code>, <code>maxEdges</code>, <code>maxPaths</code>, <code>maxWallClockMs</code>.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement deterministic neighborhood extraction for a seed id (k-hop).</p>
</li>
<li>Prefer graph source artifacts when present:<ul>
<li><code>graph_relations</code> for call/usage/import graphs (baseline).</li>
<li><code>symbol_edges</code> / callsite artifacts (when available) for evidence and SymbolId identity.</li>
</ul>
</li>
<li>Deterministic traversal:<ul>
<li>Stable adjacency ordering (lexicographic by canonical id, then edge type).</li>
<li>Deterministic tie-breaking when budgets are hit (e.g., keep lowest id first, or keep highest confidence first, but make it explicit and stable).</li>
</ul>
</li>
<li>
<p>Strict bounding:</p>
<ul>
<li>Enforce caps during traversal (no “collect everything then slice”).</li>
<li>Record truncation metadata with which cap triggered and how much was omitted.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Refactor <code>src/retrieval/context-expansion.js</code> so it is safe to reuse as the neighborhood engine (or provide a thin wrapper).</p>
</li>
<li>Touchpoints:<ul>
<li><code>src/retrieval/context-expansion.js</code></li>
<li><code>src/shared/artifact-io.js</code> (artifact presence checks via manifest)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Eliminate eager <code>{id, reason}</code> candidate explosion.<ul>
<li>Convert candidate generation to a streaming/short-circuit loop that stops as soon as <code>maxPerHit</code> / <code>maxTotal</code> is satisfied.</li>
<li>Add per-source caps (e.g., max call edges examined, max import links examined) so worst-case repos cannot allocate unbounded candidate sets.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Remove duplicate scanning and make reason selection intentional.<ul>
<li>Track candidates in a <code>Map&lt;id, { bestReason, bestPriority, reasons? }&gt;</code> rather than pushing duplicates into arrays.</li>
<li>Define a fixed reason priority order (example: call &gt; usage &gt; export &gt; import &gt; nameFallback) and document it.</li>
<li>When <code>--explain</code> is enabled, optionally retain the top-N reasons per id (bounded).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Stop assuming <code>chunkMeta[id]</code> is a valid dereference forever.<ul>
<li>Build a <code>byDocId</code> (and/or <code>byChunkUid</code>) lookup once and use it for dereferencing.</li>
<li>If a dense array invariant is still desired for performance, validate it explicitly and fall back to map deref when violated.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Prefer identity-first joins.<ul>
<li>When graph artifacts exist, resolve neighbors via canonical ids rather than <code>byName</code> joins.</li>
<li>Keep name-based joins only as an explicit fallback mode with low-confidence markers.</li>
</ul>
</li>
</ul>
<h4 id="tests">Tests<a class="headerlink" href="#tests" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graph/context-pack-basic.test.js</code></li>
<li>Build a small fixture graph; request a context pack for a known seed; assert expected caller/callee/import/usage neighbors are present.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graph/context-pack-caps.test.js</code></li>
<li>Use a large synthetic graph fixture; assert truncation metadata is present and stable when caps trigger.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/context-expansion-no-candidate-explosion.test.js</code></li>
<li>Stress fixture with many relations; assert expansion completes within a time/memory budget and does not allocate unbounded candidate arrays.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/context-expansion-reason-precedence.test.js</code></li>
<li>A chunk reachable via multiple relation types records the highest-priority reason deterministically.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/context-expansion-shuffled-chunkmeta.test.js</code></li>
<li>Provide a shuffled <code>chunkMeta</code> where array index != docId; assert expansion still resolves correct chunks via a map-based dereference.</li>
</ul>
<p>Touchpoints (consolidated):
- <code>src/retrieval/context-expansion.js</code> (refactor to become the bounded neighborhood engine)
- <code>src/shared/artifact-io.js</code> (manifest/presence checks)
- <code>src/graph/neighborhood.js</code> (new; deterministic bounded traversal)
- <code>src/graph/context-pack.js</code> (new; pack construction + truncation metadata)
- <code>src/retrieval/pipeline.js</code> (wire expansion hooks)
- <code>src/retrieval/output/context.js</code> (render context packs; harden sanitization)
- <code>src/retrieval/cli/options.js</code> + <code>src/retrieval/cli/normalize-options.js</code> (CLI flags)
- <code>bin/pairofcleats.js</code> (CLI wiring: <code>search --graph-context/--context-pack</code>)
- <code>docs/contracts/search-cli.md</code> (document CLI + JSON output contract)</p>
<hr />
<h3 id="112-impact-analysis-callerscallees-k-hop-impact-radius-with-witness-paths">11.2 Impact analysis (callers/callees + k-hop impact radius) with witness paths<a class="headerlink" href="#112-impact-analysis-callerscallees-k-hop-impact-radius-with-witness-paths" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement bounded impact analysis on top of the same neighborhood extraction primitives.</li>
<li>Provide <code>impactAnalysis(seed, { direction, depth, caps, edgeFilters })</code> returning:<ul>
<li>impacted nodes (bounded; stable ordering)</li>
<li>at least one witness path per impacted node when available (bounded; do not enumerate all paths)</li>
<li>explicit unresolved/partial path markers when edges cannot be resolved.</li>
</ul>
</li>
<li>
<p>Deterministic ordering:</p>
<ul>
<li>stable sort by <code>(distance, confidence desc, name/id asc)</code> (or equivalent stable rule), and document it.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> CLI surface (API-ready internal design).</p>
</li>
<li>Add <code>pairofcleats impact --repo … --seed &lt;id&gt; --direction upstream|downstream --depth 2 --format json|md</code>.</li>
<li>
<p>Ensure the implementation is factored so an API/MCP handler can call the same core function with the same caps and output schema.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Optional “changed-set” impact mode (non-blocking in this phase).</p>
</li>
<li>Accept <code>--changed &lt;file&gt;</code> repeated (or a file containing paths) and compute:<ul>
<li>impacted symbols in and around changed files, then traverse upstream/downstream bounded.</li>
</ul>
</li>
<li>If SCM integration is unavailable, degrade gracefully (explicit warning; still supports explicit <code>--changed</code> lists).</li>
</ul>
<h4 id="tests_1">Tests<a class="headerlink" href="#tests_1" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graph/impact-analysis-downstream.test.js</code></li>
<li>Seed a function; assert downstream impacted nodes include an expected callee and a witness path is returned.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graph/impact-analysis-upstream.test.js</code></li>
<li>Seed a function; assert upstream impacted nodes include an expected caller and a witness path is returned.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graph/impact-analysis-caps-and-truncation.test.js</code></li>
<li>Trigger caps deterministically; assert truncation metadata identifies which cap fired and results remain stable.</li>
</ul>
<p>Touchpoints (consolidated):
- <code>src/graph/impact.js</code> (new; bounded impact analysis)
- <code>src/graph/witness-paths.js</code> (new; witness path reconstruction)
- <code>src/graph/neighborhood.js</code> (shared traversal primitives)
- <code>src/retrieval/cli/impact.js</code> (new; CLI command implementation)
- <code>src/retrieval/output/impact.js</code> (new; stable human + JSON renderers)
- <code>bin/pairofcleats.js</code> (CLI wiring: <code>impact</code>, <code>impact:explain</code>)
- <code>docs/contracts/search-cli.md</code> (document new surfaces + JSON schema)</p>
<hr />
<h3 id="113-context-pack-assembly-for-toolingllm-chunk-text-graph-types-risk-explainability-rendering">11.3 Context pack assembly for tooling/LLM (chunk text + graph + types + risk) + explainability rendering<a class="headerlink" href="#113-context-pack-assembly-for-toolingllm-chunk-text-graph-types-risk-explainability-rendering" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement a “context pack assembler” that composes multiple bounded slices into a single package.</li>
<li>Inputs:<ul>
<li><code>seed</code> (chunkUid/SymbolId)</li>
<li>budgets (<code>maxTokens</code> and/or <code>maxBytes</code>, plus graph caps)</li>
<li>toggles (includeTypes, includeRisk, includeImports, includeUsages, includeCallersCallees)</li>
</ul>
</li>
<li>Output (recommended minimum):<ul>
<li><code>primary</code> (chunk excerpt + stable identifiers + file/segment provenance)</li>
<li><code>graph</code> (from 11.1; bounded neighborhood)</li>
<li><code>types</code> (bounded: referenced/declared/inferred/tooling-backed summaries when available)</li>
<li><code>risk</code> (bounded: top-N flows/summaries crossing the seed, with callsite evidence when present)</li>
<li><code>truncation[]</code> (aggregate truncation across slices)</li>
<li><code>warnings[]</code> (missing artifacts, partial resolution, disabled features)</li>
</ul>
</li>
<li>
<p>Notes:</p>
<ul>
<li>Do not embed large raw code blobs; prefer bounded excerpts and (when needed) snippet hashes + location coordinates.</li>
<li>Use stable ordering inside each slice so context packs are deterministic across runs.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add CLI surface:</p>
</li>
<li><code>pairofcleats context-pack --repo … --seed &lt;id&gt; --hops 2 --maxTokens 4000 --format json|md</code></li>
<li>
<p>For Markdown output, use consistent sections and a deterministic ordering (primary first, then callers/callees, then imports/usages, then risk).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add explain-risk rendering for flows when risk artifacts exist.</p>
</li>
<li>Provide an output mode (flag or subcommand) that prints:<ul>
<li>the path of symbols/chunks</li>
<li>file/line evidence (callsites) when present</li>
<li>rule ids/categories and confidence</li>
<li>bounded snippets or snippet hashes (never unbounded)</li>
</ul>
</li>
<li>
<p>Ensure output is stable, capped, and does not assume optional color helpers exist.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Harden retrieval output helpers used by these features (integrate known bugs in touched files).</p>
</li>
<li>Touchpoints:<ul>
<li><code>src/retrieval/output/context.js</code></li>
<li><code>src/retrieval/output/explain.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>cleanContext()</code> must remove fence lines that include language tags.<ul>
<li>Treat any line whose trimmed form starts with ``` as a fence line.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>cleanContext()</code> must not throw on non-string items.<ul>
<li>Guard/coerce before calling <code>.trim()</code>.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Explain formatting must not assume <code>color.gray()</code> exists.<ul>
<li>Provide a no-color fallback when <code>color?.gray</code> is not a function.</li>
</ul>
</li>
</ul>
<h4 id="tests_2">Tests<a class="headerlink" href="#tests_2" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graph-features/context-pack-assembly.test.js</code></li>
<li>Build fixture; assemble a context pack; assert it contains primary + at least one neighbor + deterministic truncation structure.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graph-features/risk-explain-render.test.js</code></li>
<li>Use a risk-flow fixture; assert output includes a call path and evidence coordinates and remains bounded.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/output/clean-context-fences.test.js</code></li>
<li>Ensure <code>ts /</code>json fences are removed (not just bare ```).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/output/clean-context-nonstring-guard.test.js</code></li>
<li>Feed non-string items; assert no crash and only string lines survive.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/output/explain-color-fallback.test.js</code></li>
<li>Provide a partial color impl; assert explain rendering does not throw.</li>
</ul>
<p>Touchpoints (consolidated):
- <code>src/retrieval/output/context.js</code> (hardening: fence stripping, type guards, truncation reporting)
- <code>src/retrieval/output/explain.js</code> (null-safe + color fallback; stable explain schema)
- <code>src/retrieval/output/format.js</code> (structured output plumbing; context-pack JSON integration)
- <code>src/retrieval/cli/render-output.js</code> + <code>src/retrieval/cli/render.js</code> (output modes + JSON formatting)
- <code>src/retrieval/cli/options.js</code> (flags: <code>--context-pack</code>, <code>--explain-json</code>, etc.)
- <code>bin/pairofcleats.js</code> (CLI wiring for new output modes)
- <code>docs/contracts/search-cli.md</code> (update contract + examples)</p>
<hr />
<h3 id="114-graph-aware-ranking-hooks-opt-in-explainability">11.4 Graph-aware ranking hooks (opt-in) + explainability<a class="headerlink" href="#114-graph-aware-ranking-hooks-opt-in-explainability" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Introduce optional graph-aware ranking features that can be enabled without changing result membership.</li>
<li>Candidate feature families (bounded, deterministic):<ul>
<li>node degree / in-degree / out-degree (prefer precomputed analytics artifacts when available)</li>
<li>proximity to the query-hit seed within the graph neighborhood (bounded k-hop)</li>
<li>proximity to risk hotspots (if risk summaries/flows exist)</li>
<li>same-cluster bonus (if clustering artifacts exist; deterministic cluster id remapping is assumed)</li>
</ul>
</li>
<li>
<p>Guardrails:</p>
<ul>
<li>Never compute expensive global graph metrics per query unless explicitly cached and bounded.</li>
<li>Default behavior remains unchanged unless explicitly enabled.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Integrate into retrieval ranking with an explicit feature-hook layer.</p>
</li>
<li>Touchpoints (expected):<ul>
<li><code>src/retrieval/pipeline.js</code> (scoring assembly + explain output)</li>
<li><code>src/retrieval/cli/run-search-session.js</code> / options normalization (flag plumbing)</li>
</ul>
</li>
<li>Configuration:<ul>
<li><code>retrieval.graphRanking.enabled</code> (default false)</li>
<li><code>retrieval.graphRanking.weights</code> (explicit; versioned defaults)</li>
<li><code>retrieval.graphRanking.maxGraphWorkMs</code> (time budget)</li>
</ul>
</li>
<li>Explainability:<ul>
<li>When <code>--explain</code> (or a dedicated <code>--explain-ranking</code>) is enabled, include a <code>graph</code> section in the score breakdown:</li>
<li>feature contributions and the final blended delta.</li>
</ul>
</li>
</ul>
<h4 id="tests_3">Tests<a class="headerlink" href="#tests_3" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/graph-ranking-toggle.test.js</code></li>
<li>Run the same query with graph ranking off/on; assert result sets are identical but ordering may differ.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/graph-ranking-explain.test.js</code></li>
<li>With explain enabled, assert output includes named graph feature contributions.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/graph-ranking-determinism.test.js</code></li>
<li>Re-run the same query twice with graph ranking enabled; assert ordering and explain payload are stable.</li>
</ul>
<hr />
<h3 id="115-graph-expansion-caps-as-a-config-surface-calibration-harness-language-size-tier">11.5 Graph expansion caps as a config surface + calibration harness (language × size tier)<a class="headerlink" href="#115-graph-expansion-caps-as-a-config-surface-calibration-harness-language-size-tier" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Make graph expansion caps first-class, shared configuration rather than hard-coded constants.</li>
<li>Touchpoints (expected):<ul>
<li><code>src/index/build/graphs.js</code> (replace <code>GRAPH_MAX_NODES/EDGES</code> constants with config-driven caps; record which cap triggered)</li>
<li>Also enforce identity-first graph node IDs for new writes (no <code>file::name</code> fallbacks); legacy keys, if still needed, are read-compat only and must not overwrite collisions.</li>
<li><code>src/retrieval/context-expansion.js</code> (use the same cap vocabulary; always emit truncation metadata when caps trigger)</li>
<li><code>docs/perf/graph-caps.md</code> (document defaults and tuning)</li>
</ul>
</li>
<li>
<p>Required behavior:</p>
<ul>
<li>Every expansion returns truncation metadata when it truncates.</li>
<li>Truncation metadata must indicate which cap fired and provide counts (omitted nodes/edges/paths) when measurable.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement a metrics-harvesting harness to justify default caps.</p>
</li>
<li>Inputs:<ul>
<li>Use/extend <code>benchmarks/repos.json</code> to define repos.</li>
<li>Normalize into tiers: small / typical / large / huge / problematic(massive).</li>
</ul>
</li>
<li>For each repo/tier (outside CI for huge/problematic):<ul>
<li>run indexing with graphs enabled</li>
<li>compute graph distributions (node/edge counts, degree stats, SCC size)</li>
<li>run bounded neighborhood expansions for representative seeds (random, top-degree, entrypoints)</li>
<li>record timing and output sizes</li>
</ul>
</li>
<li>Outputs:<ul>
<li>versioned bundle under <code>benchmarks/results/&lt;date&gt;/graph-caps/</code></li>
<li>machine-readable defaults: <code>defaults/graph-caps.json</code> keyed by language (and optionally tier)</li>
<li>documentation: <code>docs/perf/graph-caps.md</code> (p95 behavior for typical tier + presets for huge/problematic)</li>
</ul>
</li>
</ul>
<h4 id="tests_4">Tests<a class="headerlink" href="#tests_4" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/graphs/caps-enforced-and-reported.test.js</code></li>
<li>Build a small fixture; request deep expansion; assert caps trigger deterministically and truncation metadata is present.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/bench/graph-caps-harness-smoke.test.js</code></li>
<li>Run the harness on a tiny in-tree fixture; assert it writes a results JSON file with required fields and deterministic ordering.</li>
</ul>
<hr />
<h3 id="116-cross-file-api-contracts-report-optional-artifact">11.6 Cross-file API contracts (report + optional artifact)<a class="headerlink" href="#116-cross-file-api-contracts-report-optional-artifact" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Provide an API-contract extraction/report surface based on existing artifacts (do not require new parsing).</li>
<li>For each exported symbol (as available via symbol artifacts):<ul>
<li>canonical signature (declared + tooling-backed when available)</li>
<li>observed call signatures (from bounded callsite evidence / callDetails summaries)</li>
<li>compatibility warnings (arity mismatches, incompatible argument kinds, unresolved targets)</li>
</ul>
</li>
<li>Output formats:<ul>
<li>JSON (machine; versioned schema)</li>
<li>Markdown (human; deterministic ordering)</li>
</ul>
</li>
<li>
<p>Strict caps:</p>
<ul>
<li>max symbols analyzed per run</li>
<li>max calls sampled per symbol</li>
<li>max warnings emitted (with truncation metadata)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> CLI surface:</p>
</li>
<li>
<p><code>pairofcleats api-contracts --repo … [--only-exports] [--fail-on-warn] --format json|md</code></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Optional: enable an artifact emitter for downstream automation.</p>
</li>
<li><code>api_contracts.jsonl</code> (one record per symbol) with strict schema validation and caps.</li>
</ul>
<h4 id="tests_5">Tests<a class="headerlink" href="#tests_5" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/contracts/api-contracts-basic.test.js</code></li>
<li>Fixture with an exported function called with multiple shapes; assert contract report includes observed calls and a mismatch warning.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/contracts/api-contracts-caps.test.js</code></li>
<li>Trigger caps; assert truncation metadata is present and stable.</li>
</ul>
<hr />
<h3 id="117-architecture-slicing-and-boundary-enforcement-rules-ci-friendly-output">11.7 Architecture slicing and boundary enforcement (rules + CI-friendly output)<a class="headerlink" href="#117-architecture-slicing-and-boundary-enforcement-rules-ci-friendly-output" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add a rules format for architectural constraints over graphs.</li>
<li>Rule types (minimum viable):<ul>
<li>forbidden edges by path glob/module group (importGraph)</li>
<li>forbidden call edges by symbol tags or file globs (callGraph)</li>
<li>layering rules (optional; best-effort) that detect edges going “up-layer”</li>
</ul>
</li>
<li>
<p>Outputs:</p>
<ul>
<li>bounded report with counts, top offending edges, and a deterministic ordering</li>
<li>CI-friendly JSON (versioned schema)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> CLI surface:</p>
</li>
<li><code>pairofcleats architecture-check --repo … --rules &lt;path&gt; --format json|md [--fail-on-violation]</code></li>
</ul>
<h4 id="tests_6">Tests<a class="headerlink" href="#tests_6" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/architecture/forbidden-import-edge.test.js</code></li>
<li>Fixture with a forbidden import; assert violation is reported deterministically.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/architecture/report-is-bounded.test.js</code></li>
<li>Large fixture triggers caps; assert truncation metadata exists and report remains parseable.</li>
</ul>
<hr />
<h3 id="118-test-selection-heuristics-suggest-tests-impacted-by-a-change-set">11.8 Test selection heuristics (suggest tests impacted by a change set)<a class="headerlink" href="#118-test-selection-heuristics-suggest-tests-impacted-by-a-change-set" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement a bounded, deterministic test suggestion tool that uses graphs when available.</li>
<li>Identify tests using path conventions and language-aware patterns:<ul>
<li><code>*.test.*</code>, <code>*_test.*</code>, <code>/tests/</code>, <code>__tests__/</code>, etc.</li>
</ul>
</li>
<li>Given a changed set (<code>--changed &lt;file&gt;</code> repeated or a file list):<ul>
<li>map changed files/symbols to seed nodes</li>
<li>traverse upstream/downstream within caps</li>
<li>rank candidate tests based on witness paths, proximity, and (optional) centrality</li>
</ul>
</li>
<li>
<p>Output:</p>
<ul>
<li>top-K suggested tests + brief rationale (witness path summary), bounded and deterministic</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> CLI surface:</p>
</li>
<li><code>pairofcleats suggest-tests --repo … --changed &lt;...&gt; --max 50 --format json|md</code></li>
</ul>
<h4 id="tests_7">Tests<a class="headerlink" href="#tests_7" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/tests-selection/suggest-tests-basic.test.js</code></li>
<li>Fixture where a changed function is called by a test; assert the test is suggested.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/tests-selection/suggest-tests-bounded.test.js</code></li>
<li>Trigger caps; assert truncation metadata is present and ordering is stable.</li>
</ul>
<p>Touchpoints (consolidated):
- <code>src/retrieval/rankers.js</code> (add graph-aware ranker; keep it opt-in)
- <code>src/retrieval/pipeline.js</code> (ranker selection + scoring integration)
- <code>src/retrieval/query-intent.js</code> (intent signals used by ranker)
- <code>src/graph/*</code> (re-use context pack + neighborhood metadata for ranking features)
- <code>src/retrieval/cli/options.js</code> + <code>bin/pairofcleats.js</code> (flags: <code>--rank graph</code>, <code>--rank-default &lt;...&gt;</code>)
- <code>src/retrieval/output/explain.js</code> (surface ranker contributions in explain)
- <code>docs/contracts/search-cli.md</code> (document ranker options + explain additions)</p>
<hr />
<h2 id="phase-12-mcp-migration-apitooling-contract-formalization">Phase 12 — MCP Migration + API/Tooling Contract Formalization<a class="headerlink" href="#phase-12-mcp-migration-apitooling-contract-formalization" title="Permanent link"></a></h2>
<h3 id="objective_3">Objective<a class="headerlink" href="#objective_3" title="Permanent link"></a></h3>
<p>Modernize and stabilize PairOfCleats’ integration surface by (1) migrating MCP serving to the <strong>official MCP SDK</strong> (with a safe compatibility window), (2) formalizing MCP tool schemas, version negotiation, and error codes across legacy and SDK transports, and (3) hardening cancellation/timeouts so MCP requests cannot leak work or hang.</p>
<ul>
<li>Current grounding: MCP entrypoint is <code>tools/mcp-server.js</code> (custom JSON-RPC framing via <code>tools/mcp/transport.js</code>), with tool defs in <code>src/integrations/mcp/defs.js</code> and protocol helpers in <code>src/integrations/mcp/protocol.js</code>.</li>
<li>This phase must keep existing tools functioning while adding SDK mode, and it must not silently accept inputs that do nothing.</li>
</ul>
<hr />
<h3 id="121-dependency-strategy-and-capability-gating-for-the-official-mcp-sdk">12.1 Dependency strategy and capability gating for the official MCP SDK<a class="headerlink" href="#121-dependency-strategy-and-capability-gating-for-the-official-mcp-sdk" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Decide how the MCP SDK is provided and make the decision explicit in code + docs.</li>
<li>Options:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Dependency (always installed)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Optional dependency (install attempted; failures tolerated)</li>
<li class="task-list-item"><input type="checkbox" disabled/> External optional peer (default; capability-probed)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement the chosen strategy consistently:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>package.json</code> (if dependency/optionalDependency is chosen)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/shared/capabilities.js</code> (probe <code>@modelcontextprotocol/sdk</code> and report clearly)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/shared/optional-deps.js</code> (ensure <code>tryImport()</code> handles ESM correctly for the SDK)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure MCP server mode selection is observable and capability-gated.</p>
</li>
<li>Touchpoints:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp-server.js</code> — entrypoint dispatch</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/config-dump.js</code> (or MCP status tool) — report effective MCP mode + SDK availability</li>
</ul>
</li>
</ul>
<h4 id="tests-verification_7">Tests / Verification<a class="headerlink" href="#tests-verification_7" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Unit: capabilities probe reports <code>mcp.sdk=true/false</code> deterministically.</li>
<li class="task-list-item"><input type="checkbox" disabled/> CI verification: when SDK is absent, SDK-mode tests are skipped cleanly with a structured reason.</li>
</ul>
<hr />
<h3 id="122-sdk-backed-mcp-server-parallel-mode-with-explicit-cutover-flag">12.2 SDK-backed MCP server (parallel mode with explicit cutover flag)<a class="headerlink" href="#122-sdk-backed-mcp-server-parallel-mode-with-explicit-cutover-flag" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement an SDK-backed server alongside the legacy transport.</li>
<li>Touchpoints:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp-server-sdk.js</code> (new) — SDK-backed server implementation</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp-server.js</code> — dispatch <code>--mcp-mode legacy|sdk</code> (or env var), defaulting to legacy until parity is proven</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Requirements for SDK server:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Register tools from <code>src/integrations/mcp/defs.js</code> as the source of truth.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Route tool calls to the existing implementations in <code>tools/mcp/tools.js</code> (no behavior fork).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Support stdio transport as the baseline.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Emit a capabilities payload that allows clients to adapt (e.g., doc extraction disabled, SDK missing, etc.).</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add a deprecation window for the legacy transport.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Document the cutover plan and timeline in <code>docs/mcp.md</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Keep legacy transport only until SDK parity tests are green, then remove or hard-deprecate with warnings.</li>
</ul>
<h4 id="tests-verification_8">Tests / Verification<a class="headerlink" href="#tests-verification_8" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Services: <code>tests/services/mcp/sdk-mode.services.js</code> (new)</li>
<li>Skip if SDK is not installed.</li>
<li>Start <code>tools/mcp-server-sdk.js</code> and run at least:<ul>
<li><code>tools/list</code></li>
<li>one representative <code>tools/call</code> (e.g., <code>index_status</code>)</li>
</ul>
</li>
<li>Assert: response shape is valid, errors have stable codes, and server exits cleanly.</li>
</ul>
<hr />
<h3 id="123-tool-schema-versioning-conformance-and-drift-guards">12.3 Tool schema versioning, conformance, and drift guards<a class="headerlink" href="#123-tool-schema-versioning-conformance-and-drift-guards" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Make tool schemas explicitly versioned and enforce bump discipline.</li>
<li>
<p>Touchpoints:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/integrations/mcp/defs.js</code> — add <code>schemaVersion</code> (semver or monotonic integer) and <code>toolingVersion</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>docs/mcp.md</code> — document compatibility rules for schema changes</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Consolidate MCP argument → execution mapping to one audited path.</p>
</li>
<li>Touchpoints:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp/tools.js</code> (search/build tools)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/integrations/core/index.js</code> (shared arg builder, if used)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Create a single mapping function per tool (or a shared builder) so schema additions cannot be “accepted but ignored”.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Conformance requirement for the <code>search</code> tool:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Every field in the MCP <code>search</code> schema must either:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> affect emitted CLI args / search execution, or</li>
<li class="task-list-item"><input type="checkbox" disabled/> be removed from schema, or</li>
<li class="task-list-item"><input type="checkbox" disabled/> be explicitly marked “reserved” and rejected if set.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Avoid duplicative builders (do not maintain two separate lists of flags).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Fix known MCP tool wiring correctness hazards in modified files:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> In <code>tools/mcp/tools.js</code>, remove variable shadowing that breaks cancellation/AbortSignal handling (numeric arg is now <code>contextLines</code>; <code>context</code> remains the <code>{ signal }</code> object).</li>
</ul>
<h4 id="tests-verification_9">Tests / Verification<a class="headerlink" href="#tests-verification_9" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Unit: <code>tests/unit/mcp-schema-version.unit.js</code> (new)</li>
<li>Assert <code>schemaVersion</code> exists.</li>
<li>
<p>Assert changes to tool defs require bumping <code>schemaVersion</code> (enforced by snapshot contract or explicit check).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Unit: <code>tests/unit/mcp-search-arg-mapping.unit.js</code> (new)</p>
</li>
<li>For each supported schema field, assert mapping produces the expected CLI flag(s).</li>
<li>
<p>Include a negative test: unknown fields are rejected (or ignored only if policy says so, with an explicit warning).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Update existing: <code>tests/mcp-schema.js</code></p>
</li>
<li>Keep snapshotting tool property sets.</li>
<li>Add schemaVersion presence check.</li>
</ul>
<hr />
<h3 id="124-error-codes-protocol-negotiation-and-response-shape-consistency">12.4 Error codes, protocol negotiation, and response-shape consistency<a class="headerlink" href="#124-error-codes-protocol-negotiation-and-response-shape-consistency" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Standardize tool error payloads and map internal errors to stable MCP error codes.</li>
<li>Touchpoints:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/integrations/mcp/protocol.js</code> — legacy transport formatting helpers</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp/transport.js</code> — legacy transport handler</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp-server-sdk.js</code> — SDK error mapping</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/shared/error-codes.js</code> — canonical internal codes</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Define stable, client-facing codes (examples):<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> invalid args</li>
<li class="task-list-item"><input type="checkbox" disabled/> index missing</li>
<li class="task-list-item"><input type="checkbox" disabled/> tool timeout</li>
<li class="task-list-item"><input type="checkbox" disabled/> not supported / capability missing</li>
<li class="task-list-item"><input type="checkbox" disabled/> cancelled</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure both transports emit the same logical error payload shape (even if wrapper envelopes differ).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement protocol/version negotiation and expose capabilities.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> On <code>initialize</code>, echo supported protocol versions, the tool schema version, and effective capabilities.</li>
</ul>
<h4 id="tests-verification_10">Tests / Verification<a class="headerlink" href="#tests-verification_10" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Unit: protocol negotiation returns consistent <code>protocolVersion</code> + <code>schemaVersion</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Regression: error payload includes stable <code>code</code> and <code>message</code> across both transports for representative failures.</li>
</ul>
<hr />
<h3 id="125-cancellation-timeouts-and-process-hygiene-no-leaked-work">12.5 Cancellation, timeouts, and process hygiene (no leaked work)<a class="headerlink" href="#125-cancellation-timeouts-and-process-hygiene-no-leaked-work" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Ensure cancellation/timeout terminates underlying work within a bounded time.</li>
<li>Touchpoints:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp/transport.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp/runner.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tools/mcp/tools.js</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Cancellation correctness:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Canonicalize JSON-RPC IDs for in-flight tracking (<code>String(id)</code>), so numeric vs string IDs do not break cancellation.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>$/cancelRequest</code> cancels the correct in-flight request and that cancellation is observable (result marked cancelled, no “success” payload).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Timeout correctness:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Extend <code>runNodeAsync()</code> to accept an <code>AbortSignal</code> and kill the child process (and its process tree) on abort/timeout.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Thread AbortSignal through <code>runToolWithProgress()</code> and any spawned-node tool helpers.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>withTimeout()</code> triggers abort and does not merely reject while leaving work running.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Progress notification hygiene:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled checked/> Throttle/coalesce progress notifications (max ~1 per 250ms per tool call, coalesced) to avoid overwhelming clients.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Tighten MCP test process cleanup.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> After sending <code>shutdown</code>/<code>exit</code>, explicitly await server process termination (bounded deadline, then kill) to prevent leaked subprocesses during tests.</li>
</ul>
<h4 id="tests-verification_11">Tests / Verification<a class="headerlink" href="#tests-verification_11" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Update existing: <code>tests/mcp-robustness.js</code></li>
<li>Add “wait for exit” after <code>exit</code> (bounded).</li>
<li>Add cancellation test:<ul>
<li>Start a long-ish operation, send <code>$/cancelRequest</code>, assert the tool response is cancelled and that work stops (no continuing progress after cancellation).</li>
</ul>
</li>
<li>
<p>Add progress-throttle assertion (if practical): bursty progress is coalesced.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Unit: <code>tests/unit/mcp-runner-abort-kills-child.unit.js</code> (new)</p>
</li>
<li>Spawn a child that would otherwise run long; abort; assert child exit occurs quickly and no orphan remains.</li>
</ul>
<hr />
<h3 id="126-documentation-and-migration-notes">12.6 Documentation and migration notes<a class="headerlink" href="#126-documentation-and-migration-notes" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>docs/mcp.md</code> (new) describing:</li>
<li class="task-list-item"><input type="checkbox" disabled/> how to run legacy vs SDK server modes</li>
<li class="task-list-item"><input type="checkbox" disabled/> how to install/enable the SDK (per the chosen dependency strategy)</li>
<li class="task-list-item"><input type="checkbox" disabled/> tool schemas and <code>schemaVersion</code> policy</li>
<li class="task-list-item"><input type="checkbox" disabled/> stable error codes and cancellation/timeout semantics</li>
<li class="task-list-item"><input type="checkbox" disabled/> capability reporting and expected client behaviors</li>
</ul>
<p><strong>Mapping (source docs, minimal):</strong> <code>GIGAMAP_FINAL_UPDATED.md</code> (M12), <code>GIGAMAP_ULTRA_2026-01-22_FULL_COVERAGE_v3.md</code> (M12 overlap notes), <code>CODEBASE_STATIC_REVIEW.md</code> (MCP schema mapping), <code>GIGASWEEP.md</code> (MCP timeout/cancellation/progress/test cleanup)</p>
<hr />
<h2 id="phase-13-scm-provider-abstraction-git-migration-jj-provider">Phase 13 — SCM Provider Abstraction (Git Migration) + JJ Provider<a class="headerlink" href="#phase-13-scm-provider-abstraction-git-migration-jj-provider" title="Permanent link"></a></h2>
<h3 id="objective_4">Objective<a class="headerlink" href="#objective_4" title="Permanent link"></a></h3>
<p>Make SCM integration <strong>pluggable and explicit</strong> so indexing and incremental workflows can run against:</p>
<ul>
<li>Git repos (current default)</li>
<li>Jujutsu (<code>jj</code>) repos (Phase 13 deliverable)</li>
<li>Non-SCM directories (filesystem-only; reduced provenance but still indexable)</li>
</ul>
<p>This phase introduces an <strong>SCM provider interface</strong>, migrates all Git behavior onto that interface, then implements a JJ provider using the same contract. The result is a single, coherent place to reason about: tracked file discovery, repo provenance, per-file metadata (churn / blame), and “changed files” queries used by incremental reuse.</p>
<p>Authoritative specs to align with (existing in repo):
- <code>docs/specs/scm-provider-config-and-state-schema.md</code>
- <code>docs/specs/jj-provider-commands-and-parsing.md</code></p>
<hr />
<h3 id="exit-criteria-must-all-be-true">Exit criteria (must all be true)<a class="headerlink" href="#exit-criteria-must-all-be-true" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> There is a single SCM provider interface used everywhere (no direct <code>git</code>/<code>jj</code> shelling from random modules).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.scm.provider</code> is supported: <code>auto | git | jj | none</code> (default: <code>auto</code>).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Git provider is fully migrated onto the interface and remains the default when <code>.git/</code> exists.</li>
<li class="task-list-item"><input type="checkbox" disabled/> JJ provider supports (at minimum): repo detection, tracked-file enumeration, and repo “head” provenance recorded in <code>build_state.json</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> When no SCM is present (or <code>provider=none</code>), indexing still works using filesystem discovery, but provenance fields are explicitly <code>null</code> / unavailable (no silent lies).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Build signatures and cache keys include SCM provenance in a <strong>stable</strong> and <strong>portable</strong> way (no locale-dependent sorting).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Tests cover provider selection + the most failure-prone parsing paths; CI can run without <code>jj</code> installed.</li>
</ul>
<hr />
<h3 id="phase-131-introduce-scmprovider-interface-registry-configstate-schema-wiring">Phase 13.1 — Introduce <code>ScmProvider</code> interface + registry + config/state schema wiring<a class="headerlink" href="#phase-131-introduce-scmprovider-interface-registry-configstate-schema-wiring" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Create a new module boundary for SCM operations:</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/scm/types.js</code> (new) — shared types and normalized shapes</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/scm/provider.js</code> (new) — interface contract + docs-in-code</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/scm/registry.js</code> (new) — provider selection (<code>auto|git|jj|none</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/scm/providers/none.js</code> (new) — filesystem-only provider (no provenance; uses existing fdir fallback)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/scm/providers/git.js</code> (new) — migrated in 13.2</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>src/index/scm/providers/jj.js</code> (new) — implemented in 13.3</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Define the <strong>canonical provider contract</strong> (minimal required surface):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>detect({ startPath }) -&gt; { ok:true, repoRoot, provider } | { ok:false }</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>listTrackedFiles({ repoRoot, subdir? }) -&gt; { filesPosix: string[] }</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>getRepoProvenance({ repoRoot }) -&gt; { provider, root, head, dirty, branch/bookmarks?, detectedBy? }</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>getChangedFiles({ repoRoot, fromRef, toRef, subdir? }) -&gt; { filesPosix: string[] }</code> (may be “not supported” for <code>none</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>getFileMeta({ repoRoot, filePosix }) -&gt; { churn?, lastCommitId?, lastAuthor?, lastModifiedAt? }</code> (best-effort; may be disabled)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Optional (capability-gated): <code>annotate({ repoRoot, filePosix, timeoutMs }) -&gt; { lines:[{ line, author, commitId, ... }] }</code></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Config keys (align to <code>docs/specs/scm-provider-config-and-state-schema.md</code>):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.scm.provider: auto|git|jj|none</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.scm.timeoutMs</code>, <code>indexing.scm.maxConcurrentProcesses</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.scm.annotate.enabled</code>, <code>maxFileSizeBytes</code>, <code>timeoutMs</code></li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>indexing.scm.jj.snapshotWorkingCopy</code> safety default (read-only by default)</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Build-state schema updates:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend <code>build_state.json</code> <code>repo</code> field to include:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>repo.provider</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> normalized <code>repo.head</code> object (provider-specific fields nested, but stable keys)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repo.dirty</code> boolean (best-effort)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Keep Git back-compat fields where feasible (<code>repo.commit</code>, <code>repo.branch</code>) but treat <code>repo.provider</code> + <code>repo.head.*</code> as authoritative.</li>
</ul>
<p>Touchpoints:
- <code>docs/specs/scm-provider-config-and-state-schema.md</code> (align / correct examples if needed)
- <code>src/index/build/build-state.js</code> (repo provenance shape)
- <code>src/index/build/indexer/signatures.js</code> (include SCM provenance in build signatures)
- <code>src/index/build/runtime/runtime.js</code> (thread config into runtime)
- <code>docs/config/schema.json</code> (document <code>indexing.scm.*</code> keys)</p>
<h4 id="tests-verification_12">Tests / verification<a class="headerlink" href="#tests-verification_12" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/scm-provider-selection.unit.js</code> (new)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>auto</code> selects <code>git</code> when <code>.git/</code> exists and git is runnable.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>auto</code> selects <code>jj</code> when <code>.jj/</code> exists and <code>jj</code> is runnable.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>auto</code> falls back to <code>none</code> when neither exists (or binaries missing).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/build-state-repo-provenance.unit.js</code> (new)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>build_state.json</code> includes <code>repo.provider</code> and normalized <code>repo.head</code>.</li>
</ul>
<hr />
<h3 id="phase-132-migrate-git-onto-the-provider-interface">Phase 13.2 — Migrate Git onto the provider interface<a class="headerlink" href="#phase-132-migrate-git-onto-the-provider-interface" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement <code>GitProvider</code> by <strong>wrapping and consolidating</strong> existing Git logic:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Move/merge logic from:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/git.js</code> (provenance + meta helpers)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/build/discover.js</code> (<code>git ls-files</code> discovery)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure there is exactly one “source of truth” for:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> repo root resolution</li>
<li class="task-list-item"><input type="checkbox" disabled/> tracked file enumeration (<code>git ls-files -z</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled/> dirty check</li>
<li class="task-list-item"><input type="checkbox" disabled/> head SHA + branch name</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Remove direct Git shelling from non-provider modules:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/build/discover.js</code> should call <code>ScmProvider.listTrackedFiles()</code> when an SCM provider is active, else use filesystem crawl (current behavior).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Any provenance used for metrics/signatures must route through <code>ScmProvider.getRepoProvenance()</code>.</li>
</ul>
<p>Touchpoints:
- <code>src/index/build/discover.js</code>
- <code>src/index/git.js</code> (migrate or reduce to GitProvider internals)
- <code>src/index/scm/providers/git.js</code> (new)
- <code>src/index/scm/registry.js</code></p>
<h4 id="tests-verification_13">Tests / verification<a class="headerlink" href="#tests-verification_13" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/index-build-git-provider.services.js</code> (new)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Build index inside a git repo and assert:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>build_state.json.repo.provider === "git"</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> tracked file discovery returns only git-tracked files (plus explicit records-dir behavior if enabled)</li>
</ul>
</li>
</ul>
<hr />
<h3 id="phase-133-implement-jj-provider-read-only-default-robust-parsing">Phase 13.3 — Implement JJ provider (read-only default, robust parsing)<a class="headerlink" href="#phase-133-implement-jj-provider-read-only-default-robust-parsing" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement <code>JjProvider</code> using <code>jj</code> CLI (no library dependency):</li>
<li class="task-list-item"><input type="checkbox" disabled/> Detection:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> find <code>.jj/</code> root</li>
<li class="task-list-item"><input type="checkbox" disabled/> validate <code>jj --version</code> runnable (capability gating)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Tracked files:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>jj file list --tracked -0</code> (prefer NUL delim where available)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Repo provenance:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> resolve a stable head reference (commitId + changeId where available)</li>
<li class="task-list-item"><input type="checkbox" disabled/> record bookmarks (best-effort)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>dirty</code> best-effort (explicitly document semantics)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Safety default: read-only by default</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> When <code>indexing.scm.jj.snapshotWorkingCopy=false</code>:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> run JJ commands with <code>--ignore-working-copy</code> and <code>--at-op=@</code> (per spec)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> If enabled:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> allow exactly one controlled snapshot at start (and pin subsequent commands to that op)</li>
<li class="task-list-item"><input type="checkbox" disabled/> record the pinned op id in build state (so provenance is reproducible)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement changed-files support (for incremental reuse):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Provide <code>getChangedFiles()</code> based on the spec in <code>docs/specs/jj-provider-commands-and-parsing.md</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Normalize to <strong>repo-root-relative POSIX paths</strong>.</li>
</ul>
<p>Touchpoints:
- <code>docs/specs/jj-provider-commands-and-parsing.md</code> (align with implementation)
- <code>src/index/scm/providers/jj.js</code> (new)
- <code>src/index/scm/providers/jj-parse.js</code> (new: isolated parsing helpers)
- <code>src/index/build/indexer/signatures.js</code> (include JJ head/changeId + op pin when used)</p>
<h4 id="tests-verification_14">Tests / verification<a class="headerlink" href="#tests-verification_14" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Unit: parsing helpers</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/jj-changed-files-parse.unit.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/jj-head-parse.unit.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> CI behavior:</li>
<li class="task-list-item"><input type="checkbox" disabled/> if <code>jj</code> missing, JJ tests skip (exit code 77) with a clear message.</li>
</ul>
<hr />
<h3 id="phase-134-cli-tooling-visibility-make-scm-selection-obvious">Phase 13.4 — CLI + tooling visibility (make SCM selection obvious)<a class="headerlink" href="#phase-134-cli-tooling-visibility-make-scm-selection-obvious" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> CLI flags (override config, optional but recommended):</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index build --scm-provider &lt;auto|git|jj|none&gt;</code></li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>pairofcleats index build --scm-annotate / --no-scm-annotate</code></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Surface effective provider + provenance in diagnostics:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats tooling doctor --json</code> should include:<ul>
<li>provider selected</li>
<li>repo root</li>
<li>head id(s)</li>
<li>whether annotate is enabled</li>
</ul>
</li>
</ul>
<p>Touchpoints:
- <code>bin/pairofcleats.js</code> (flag plumbing)
- <code>src/shared/cli-options.js</code> (new flags)
- <code>tools/tooling-doctor.js</code> (report SCM provider)</p>
<hr />
<h3 id="phase-135-non-repo-environments-explicitly-supported">Phase 13.5 — Non-repo environments (explicitly supported)<a class="headerlink" href="#phase-135-non-repo-environments-explicitly-supported" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Make filesystem-only behavior first-class:</li>
<li class="task-list-item"><input type="checkbox" disabled/> If <code>provider=none</code> (or auto selects none):<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> file discovery uses filesystem crawl (current fallback)</li>
<li class="task-list-item"><input type="checkbox" disabled/> build state records <code>repo.provider="none"</code> and <code>repo.head=null</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> incremental reuse features that require SCM provenance must be disabled with an explicit reason (no silent partial behavior)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Document this mode as “try it anywhere” for non-code/non-repo folders.</li>
</ul>
<p>Touchpoints:
- <code>src/index/scm/providers/none.js</code> (new)
- <code>docs/</code> (add a short section in <code>docs/indexing.md</code> or <code>docs/scm.md</code>)</p>
<h4 id="tests-verification_15">Tests / verification<a class="headerlink" href="#tests-verification_15" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/index-build-no-scm.services.js</code> (new)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Build index in a temp folder without <code>.git/</code> and assert build succeeds and provenance is explicitly null.</li>
</ul>
<h2 id="phase-14-incremental-diffing-snapshots-time-travel-regression-debugging">Phase 14 — Incremental Diffing &amp; Snapshots (Time Travel, Regression Debugging)<a class="headerlink" href="#phase-14-incremental-diffing-snapshots-time-travel-regression-debugging" title="Permanent link"></a></h2>
<h3 id="objective_5">Objective<a class="headerlink" href="#objective_5" title="Permanent link"></a></h3>
<p>Introduce <strong>first-class snapshot and diff artifacts</strong> so we can:</p>
<ul>
<li>Query indexes <strong>“as-of” a prior build</strong> (time-travel).</li>
<li>Generate deterministic <strong>“what changed”</strong> artifacts between two index states.</li>
<li>Support regression debugging, release auditing, and safe incremental reuse.</li>
</ul>
<p>This phase establishes:</p>
<blockquote>
<p><strong>Authoritative spec</strong>: the on-disk layout, ID conventions, and resolution rules for this phase are already refined in:
- <code>docs/phases/phase-14/index-refs-and-snapshots.md</code> (snapshot registry + IndexRef)
- <code>docs/phases/phase-14/index-diffs.md</code> (diff schemas + deterministic event stream)</p>
<p>This roadmap section must stay aligned with those specs (notably: snapshot IDs are <code>snap-*</code> and diff IDs are <code>diff_*</code>).</p>
</blockquote>
<ul>
<li><strong>Pointer snapshots</strong> (cheap metadata references to validated builds).</li>
<li><strong>Frozen snapshots</strong> (immutable, self-contained archival copies).</li>
<li><strong>Diff artifacts</strong> (bounded, deterministic change sets + summaries).</li>
</ul>
<h3 id="141-snapshot-diff-artifact-surface-contracts-retention-safety">14.1 Snapshot &amp; diff artifact surface (contracts, retention, safety)<a class="headerlink" href="#141-snapshot-diff-artifact-surface-contracts-retention-safety" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Define the on-disk <strong>public artifact surface</strong> under each repo cache root:</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>snapshots/manifest.json</code> — snapshot registry (authoritative index of snapshots)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>snapshots/&lt;snapshotId&gt;/snapshot.json</code> — immutable per-snapshot metadata record (optional but recommended)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>snapshots/&lt;snapshotId&gt;/frozen/index-&lt;mode&gt;/...</code> — frozen snapshot index roots (immutable copies)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>diffs/manifest.json</code> — diff registry (authoritative index of diffs)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>diffs/&lt;diffId&gt;/summary.json</code> — bounded diff summary (always present)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>diffs/&lt;diffId&gt;/index_diff.jsonl</code> — optional, bounded event stream (may be truncated)</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Standardize <strong>ID + naming rules</strong>:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Snapshot IDs: <code>snap-YYYYMMDD-HHMMSS-&lt;shortid&gt;</code> (default) plus optional user <code>label</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Diff IDs: <code>diff_&lt;sha256&gt;&lt;shortid&gt;</code> (default)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure IDs are filesystem-safe.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure deterministic ordering for registry output (sort by <code>createdAt</code>, then <code>id</code>).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Define snapshot registry entry schema (minimum fields):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>id</code>, <code>type</code> (<code>pointer</code> | <code>frozen</code>), <code>createdAt</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>label</code> (nullable), <code>tags</code> (string[])</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>buildId</code> (from <code>build_state.json</code>), <code>configHash</code>, <code>toolVersion</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>buildRoot</code> (repo-cache-relative path), plus <code>modeBuildRoots</code> map (<code>mode -&gt; repo-cache-relative index root</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repoProvenance</code> (best-effort: SCM provider + revision/branch if available)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>integritySummary</code> (best-effort counts + size estimates + <code>validatedAt</code> timestamp)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Optional future-proof fields (schema allows but does not require): <code>workspaceId</code>, <code>namespaceKey</code></p>
<ul>
<li>Defer multi-repo/workspace orchestration to <strong>Phase 15 — Federation &amp; Multi-Repo</strong>.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Define diff registry entry schema (minimum fields):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>id</code>, <code>createdAt</code>, <code>from</code> + <code>to</code> refs (snapshotId/buildId/indexRootRef), <code>modes</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>summaryPath</code> and optional <code>eventsPath</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>truncated</code> flag + truncation metadata (<code>maxEvents</code>, <code>maxBytes</code>)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>compat</code> block capturing <code>from.configHash</code> vs <code>to.configHash</code> and <code>toolVersion</code> mismatches.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Make registries <strong>atomic and crash-safe</strong>:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Use atomic write (temp + rename) and stable JSON output.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Avoid partial registry writes leaving corrupt JSON (registry must always be readable or rolled back).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> If using per-snapshot <code>snapshots/&lt;id&gt;/snapshot.json</code>, write it first, then append to <code>snapshots/manifest.json</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add <strong>retention policy knobs</strong> (defaults tuned for safety):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.snapshots.maxPointerSnapshots</code> (default: 25)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.snapshots.maxFrozenSnapshots</code> (default: 10)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.snapshots.retainDays</code> (default: 30)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.diffs.maxDiffs</code> (default: 50)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.diffs.retainDays</code> (default: 30)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.diffs.maxEvents</code> / <code>indexing.diffs.maxBytes</code> (bounded output)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Retention must respect tags (e.g., <code>release</code> is never deleted automatically).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Enforce <strong>path safety</strong> for all snapshot/diff paths:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Treat all registry paths as repo-cache-relative.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Refuse any <code>buildRoot</code> / <code>modeBuildRoots</code> values that escape the repo cache root (no <code>..</code>, no absolute paths).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Refuse snapshot/diff output dirs if they escape the repo cache root.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Integrate <strong>validation gating semantics</strong> into the contract:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Pointer snapshots may only reference builds that passed index validation (see Phase 14.2).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Frozen snapshots must be self-contained and re-validatable.</li>
</ul>
<p>Touchpoints:
- <code>src/index/snapshots/**</code> (new)
- <code>src/index/diffs/**</code> (new)
- <code>src/shared/artifact-schemas.js</code> (add AJV validators for <code>snapshots/manifest.json</code>, <code>diffs/manifest.json</code>, <code>diffs/*/summary.json</code>)
- <code>docs/</code> (new: <code>docs/snapshots-and-diffs.md</code>; update public artifact surface docs if present)</p>
<h4 id="tests_8">Tests<a class="headerlink" href="#tests_8" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/snapshots-registry.unit.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Registry schema validation (valid/invalid cases)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Atomic update behavior (simulate interrupted write; registry remains readable)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Path safety (reject absolute paths and <code>..</code> traversal)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/diffs-registry.unit.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Schema validation + bounded/truncation metadata correctness</li>
</ul>
<h3 id="142-pointer-snapshots-creation-validation-gating-cliapi">14.2 Pointer snapshots (creation, validation gating, CLI/API)<a class="headerlink" href="#142-pointer-snapshots-creation-validation-gating-cliapi" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement pointer snapshot creation:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Resolve repo cache root and current build roots from <code>builds/current.json</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Load <code>build_state.json</code> from the current build root (for <code>buildId</code>, <code>configHash</code>, <code>toolVersion</code>, and provenance).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Require a successful artifact validation signal before snapshotting:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Preferred: consume a persisted validation report if present.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Otherwise: run validation on-demand against each mode index root.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Refuse snapshot creation when builds are incomplete:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> If an index mode is missing required artifacts, fail.</li>
<li class="task-list-item"><input type="checkbox" disabled/> If embeddings/risk passes are still pending for a mode, fail unless explicitly overridden (<code>--allow-incomplete</code>, default false).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Materialize snapshot entry with:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>buildRoot</code> + <code>modeBuildRoots</code> captured as <strong>repo-cache-relative</strong> paths.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>integritySummary</code> populated from validation output + minimal artifact counts.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Write immutable per-snapshot metadata (optional but recommended):<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>snapshots/&lt;snapshotId&gt;/snapshot.json</code> (write atomically).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Keep the registry entry minimal and link to the per-snapshot record if desired.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Append entry to <code>snapshots/manifest.json</code> atomically.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Apply retention after creation (delete oldest pointer snapshots unless tagged).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add CLI surface:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index snapshot create [--label &lt;label&gt;] [--tags &lt;csv&gt;] [--modes &lt;csv&gt;] [--allow-incomplete]</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index snapshot list [--json]</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index snapshot show &lt;snapshotId&gt; [--json]</code></li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>pairofcleats index snapshot rm &lt;snapshotId&gt; [--force]</code></p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add API surface (optional but recommended for UI/MCP parity):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>GET /index/snapshots</code> (list)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>GET /index/snapshots/:id</code> (show)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>POST /index/snapshots</code> (create)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure endpoints never expose absolute filesystem paths.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Sweep-driven hardening for snapshot creation:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> When reading <code>builds/current.json</code>, treat any buildRoot that escapes repo cache root as <strong>invalid</strong> and refuse snapshotting.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure snapshot manifest writes are atomic and do not corrupt on crash.</li>
</ul>
<p>Touchpoints:
- <code>bin/pairofcleats.js</code> (new subcommands)
- <code>tools/index-snapshot.js</code> (new CLI implementation)
- <code>src/index/snapshots/registry.js</code> (new)
- <code>src/index/snapshots/validate-source.js</code> (new: shared logic to validate a build root before snapshotting)
- <code>tools/api/**</code> (if API endpoints added)</p>
<h4 id="tests_9">Tests<a class="headerlink" href="#tests_9" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/snapshot-create.services.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build an index; create a pointer snapshot; assert registry entry exists and references current build.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Fail creation when artifacts are missing or validation fails.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>--modes</code> subset only snapshots those modes.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Retention deletes oldest untagged pointer snapshots.</li>
</ul>
<h3 id="143-frozen-snapshots-immutable-copies-integrity-verification">14.3 Frozen snapshots (immutable copies + integrity verification)<a class="headerlink" href="#143-frozen-snapshots-immutable-copies-integrity-verification" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement snapshot freeze operation:</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index snapshot freeze &lt;snapshotId&gt;</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Preconditions:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Snapshot exists and is <code>pointer</code> (or already <code>frozen</code> → no-op / error depending on flags).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Referenced build roots exist and are readable.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Copy the snapshot’s index artifacts into:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>snapshots/&lt;snapshotId&gt;/frozen/index-&lt;mode&gt;/...</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Copy strategy:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Use <code>pieces/manifest.json</code> from each mode’s index root as the authoritative list of files to copy.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Prefer hardlinking (same filesystem) when safe; otherwise copy bytes.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Always copy metadata (<code>index_state.json</code>, <code>pieces/manifest.json</code>, and any required build metadata files).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Integrity verification:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Verify copied pieces against <code>pieces/manifest.json</code> checksums.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Re-run index validation against the frozen index roots.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Atomicity:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Freeze into a temp directory and rename into place only after verification.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Update <code>snapshots/manifest.json</code>:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Flip <code>type</code> to <code>frozen</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>buildRoot</code> / <code>modeBuildRoots</code> to point at the frozen roots.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Preserve the original <code>buildId</code> / provenance; record <code>frozenFromBuildId</code> if useful.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add supporting maintenance commands:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index snapshot gc [--dry-run]</code> (enforce retention; never delete <code>release</code>-tagged snapshots)</li>
</ul>
<p>Touchpoints:
- <code>tools/index-snapshot.js</code> (freeze + gc)
- <code>src/index/snapshots/freeze.js</code> (new)
- <code>src/index/snapshots/copy-pieces.js</code> (new; copy/hardlink logic)</p>
<h4 id="tests_10">Tests<a class="headerlink" href="#tests_10" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/snapshot-freeze.services.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Create pointer snapshot → freeze → validate frozen index roots succeed.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure freeze is atomic (simulate failure mid-copy → no partial frozen dir is considered valid).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure frozen snapshot remains usable after deleting the original build root.</li>
</ul>
<h3 id="144-deterministic-diff-computation-bounded-machine-readable">14.4 Deterministic diff computation (bounded, machine-readable)<a class="headerlink" href="#144-deterministic-diff-computation-bounded-machine-readable" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement diff computation between two index states:</li>
<li class="task-list-item"><input type="checkbox" disabled/> CLI: <code>pairofcleats index diff --from &lt;snapshotId|buildId|path&gt; --to &lt;snapshotId|buildId|path&gt; [--modes &lt;csv&gt;]</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Resolve <code>from</code> and <code>to</code> to per-mode index roots (snapshot pointer, snapshot frozen, or explicit indexRoot).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Refuse or annotate mismatches:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> If <code>configHash</code> differs, require <code>--allow-mismatch</code> or mark output as “non-comparable”.</li>
<li class="task-list-item"><input type="checkbox" disabled/> If <code>toolVersion</code> differs, annotate (diff still possible but less trustworthy).</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Define diff output formats:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Always write <code>diffs/&lt;diffId&gt;/summary.json</code> (bounded):<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> counts of adds/removes/changes by category</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>truncated</code> boolean + reason</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>from</code>/<code>to</code> metadata (snapshot IDs, build IDs, createdAt)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Optionally write <code>diffs/&lt;diffId&gt;/index_diff.jsonl</code> (bounded stream):</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>file_added | file_removed | file_changed</code> (path + old/new hash)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>chunk_added | chunk_removed | chunk_changed</code>:</li>
<li class="task-list-item"><input type="checkbox" disabled/> stable <code>chunkId</code> from <code>metaV2.chunkId</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> minimal before/after summary (<code>file</code>, <code>segment</code>, <code>kind</code>, <code>name</code>, <code>start/end</code>), plus optional <code>semanticSig</code> (hash of normalized docmeta/metaV2 subset)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>graph_edge_added | graph_edge_removed</code> (graph name + from/to node IDs)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Allow future event types (symbols/contracts/risk) without breaking old readers.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement deterministic diffing rules:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Stable identity:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Files keyed by repo-relative path.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Chunks keyed by <code>metaV2.chunkId</code> (do <strong>not</strong> rely on numeric <code>chunk_meta.id</code>).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Graph edges keyed by <code>(graph, fromId, toId)</code>.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Stable ordering:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Sort events by <code>(type, key)</code> so repeated runs produce byte-identical outputs.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Boundedness:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Enforce <code>indexing.diffs.maxEvents</code> and <code>indexing.diffs.maxBytes</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> If exceeded, stop emitting events and mark summary as truncated; include category counts.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Integrate diff generation into incremental build (optional but recommended):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> After a successful build+promotion, compute a diff vs the previous “latest” snapshot/build.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Use incremental state (manifest) to compute file-level changes in O(changed) where possible.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Emit diffs only after strict validation passes (so diffs don’t encode broken builds).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Store the diff under <code>diffs/&lt;diffId&gt;/...</code> and append to <code>diffs/manifest.json</code> (do <strong>not</strong> mix diffs into buildRoot without a strong reason).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Sweep-driven hardening for incremental reuse/diff correctness (because this phase touches incremental state):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Before reusing an “unchanged” incremental build, verify required artifacts exist (use <code>pieces/manifest.json</code> as the authoritative inventory).<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> If any required piece is missing/corrupt, disable reuse and force rebuild.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure incremental cache invalidation is tied to a complete signature:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Include artifact schema hash + tool version + key feature flags in the incremental signature.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Include diff/snapshot emission toggles so changing these settings invalidates reuse.</li>
</ul>
</li>
</ul>
<p>Touchpoints:
- <code>tools/index-diff.js</code> (new CLI implementation)
- <code>src/index/diffs/compute.js</code> (new)
- <code>src/index/diffs/events.js</code> (new; event schema helpers + deterministic ordering)
- <code>src/index/diffs/registry.js</code> (new)
- <code>src/index/build/incremental.js</code> (reuse validation + signature binding improvements)
- <code>src/index/build/indexer/steps/incremental.js</code> (optional: emit diffs post-build)</p>
<h4 id="tests_11">Tests<a class="headerlink" href="#tests_11" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/index-diff.services.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build snapshot A; modify repo; build snapshot B; compute diff A→B.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert file_changed appears for modified file.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert chunk changes use <code>metaV2.chunkId</code> and are stable across runs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert ordering is deterministic (byte-identical <code>index_diff.jsonl</code>).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert truncation behavior when <code>maxEvents</code> is set low.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/storage/sqlite/incremental/index-reuse-validation.services.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Corrupt/remove a required artifact and verify incremental reuse is refused.</li>
</ul>
<h3 id="145-retrieval-tooling-integration-as-of-snapshots-and-what-changed-surfaces">14.5 Retrieval + tooling integration: “as-of” snapshots and “what changed” surfaces<a class="headerlink" href="#145-retrieval-tooling-integration-as-of-snapshots-and-what-changed-surfaces" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add snapshot targeting to retrieval/search:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend search CLI args with <code>--snapshot &lt;snapshotId&gt;</code> / <code>--as-of &lt;snapshotId&gt;</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Resolve snapshot → per-mode index roots via <code>snapshots/manifest.json</code>.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure <code>--snapshot</code> never leaks absolute paths (logs + JSON output must stay repo-relative).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add diff surfacing commands for humans and tools:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index diff list [--json]</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>pairofcleats index diff show &lt;diffId&gt; [--format summary|jsonl]</code></li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>pairofcleats index diff explain &lt;diffId&gt;</code> (human-oriented summary + top changed files)</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Extend “secondary index builders” to support snapshots:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> SQLite build: accept <code>--snapshot &lt;snapshotId&gt;</code> / <code>--as-of &lt;snapshotId&gt;</code> and resolve it to <code>--index-root</code>.<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Ensure the SQLite build can target frozen snapshots as well as pointer snapshots (as long as artifacts still exist).</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Validate tool: document <code>pairofcleats index validate --index-root &lt;frozenSnapshotIndexRoot&gt;</code> workflow (no new code required if <code>--index-root</code> already supported).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add API surface (optional but recommended):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>GET /index/diffs</code> (list)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>GET /index/diffs/:id</code> (summary)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>GET /index/diffs/:id/events</code> (JSONL stream; bounded)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>GET /search?snapshotId=...</code> (search “as-of” a snapshot)</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Sweep-driven hardening for retrieval caching (because this phase touches retrieval index selection):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure query cache keys include the snapshotId (or resolved buildId) so results cannot bleed across snapshots.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Fix retrieval index signature calculation to account for sharded artifacts (see tests below).</li>
</ul>
<p>Touchpoints:
- <code>src/retrieval/cli-args.js</code> (add <code>--snapshot/--as-of</code>)
- <code>src/retrieval/cli.js</code> (thread snapshot option through)
- <code>src/retrieval/cli-index.js</code> (resolve index dir via snapshot; update query cache signature)
- <code>src/shared/artifact-io.js</code> (add signature helpers for sharded artifacts)
- <code>bin/pairofcleats.js</code> (CLI wiring)
- <code>tools/build-sqlite-index/cli.js</code> + <code>tools/build-sqlite-index/run.js</code> (add <code>--snapshot/--as-of</code>)
- <code>tools/api/**</code> (if API endpoints added)</p>
<h4 id="tests_12">Tests<a class="headerlink" href="#tests_12" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/snapshot-query.services.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build snapshot A; modify repo; build snapshot B.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Run the same query against <code>--snapshot A</code> and <code>--snapshot B</code>; assert results differ as expected.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert “latest” continues to resolve to the current build when no snapshot is provided.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/retrieval-index-signature-shards.unit.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Create a fake index dir with <code>chunk_meta.meta.json</code> + <code>chunk_meta.parts/*</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert the index signature changes when any shard changes.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/sqlite-build-snapshot.services.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build snapshot A.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Run <code>pairofcleats lmdb build</code> / <code>pairofcleats sqlite build</code> equivalents with <code>--snapshot A</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert output DB is produced and corresponds to that snapshot’s artifacts.</li>
</ul>
<h3 id="phase-14-source-mapping-minimal">Phase 14 — Source mapping (minimal)<a class="headerlink" href="#phase-14-source-mapping-minimal" title="Permanent link"></a></h3>
<ul>
<li><code>PAIR_OF_CLEATS_ROADMAP_PH01_TO_PH19_MASTER_UPDATED.md</code> — PH-11 tasks T01–T05 (snapshot registry, pointer snapshots, freeze, deterministic diffs, retrieval integration).</li>
<li><code>PAIR_OF_CLEATS_FUN_EXTRA_IDEAS_MASTER_UPDATED.md</code> — concrete <code>index_diff.jsonl</code> and <code>diff_summary.json</code> format + CLI/API examples.</li>
<li><code>MULTIREPO_FED.md</code> — snapshot/diff/time-travel as a core primitive; workspace-aware future-proof fields (deferred orchestration).</li>
<li><code>GIGAMAP_FINAL_UPDATED.md</code> — milestone M10 snapshotting/diffing file touchpoints (incremental integration, loader <code>--snapshot</code>, snapshot selection for secondary builders like SQLite).</li>
<li><code>GIGASWEEP.md</code> — required hardening when touching incremental reuse + retrieval query-cache signatures (sharded <code>chunk_meta</code> coverage, reuse validation).</li>
</ul>
<hr />
<h2 id="phase-15-federation-multi-repo-workspaces-catalog-federated-search">Phase 15 — Federation &amp; Multi-Repo (Workspaces, Catalog, Federated Search)<a class="headerlink" href="#phase-15-federation-multi-repo-workspaces-catalog-federated-search" title="Permanent link"></a></h2>
<h3 id="objective_6">Objective<a class="headerlink" href="#objective_6" title="Permanent link"></a></h3>
<p>Enable first-class <em>workspace</em> workflows: index and query across <strong>multiple repositories</strong> in a single operation (CLI/API/MCP), with correct cache keying, compatibility gating, deterministic result merging, and shared cache reuse. The system must be explicit about repo identity and index compatibility so multi-repo results are reproducible, debuggable, and safe by default.</p>
<h3 id="151-workspace-configuration-repo-identity-and-repo-set-ids">15.1 Workspace configuration, repo identity, and repo-set IDs<a class="headerlink" href="#151-workspace-configuration-repo-identity-and-repo-set-ids" title="Permanent link"></a></h3>
<blockquote>
<p><strong>Authoritative spec</strong>: Workspace config format is already defined in <code>docs/specs/workspace-config.md</code> (file name: <code>.pairofcleats-workspace.jsonc</code>, <code>schemaVersion: 1</code>, strict keys, and normalization rules).<br />
This roadmap section is aligned to that spec; if the spec changes, update this phase doc (not the other way around).</p>
</blockquote>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Define a <strong>workspace configuration file</strong> (JSONC-first) that enumerates repos (selection + labels) and is strict/portable. Per-repo build overrides are <strong>explicitly out of scope</strong> for <code>schemaVersion: 1</code> (defer to a future schemaVersion).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Recommended default name/location: <code>.pairofcleats-workspace.jsonc</code> at a chosen “workspace root” (not necessarily a repo root).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Include minimally:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>schemaVersion</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>name</code> (human-friendly)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repos: [{ root, alias?, tags?, enabled?, priority? }]</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Optional: <code>cacheRoot</code> (shared cache root override)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Optional: <code>defaults</code> (applied to all repos unless overridden)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Document that <strong>repo roots</strong> may be specified as:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> absolute paths</li>
<li class="task-list-item"><input type="checkbox" disabled/> paths relative to the workspace file directory</li>
<li class="task-list-item"><input type="checkbox" disabled/> (optional) known repo IDs / aliases (resolved via registry/catalog)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement a workspace loader/validator that resolves workspace config into a canonical runtime structure.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Canonicalize each repo entry:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Resolve <code>root</code> to a <strong>repo root</strong> (not a subdirectory), using existing repo-root detection (<code>resolveRepoRoot</code> behavior) even when the user points at a subdir.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Canonicalize to <strong>realpath</strong> (symlink-resolved) where possible; normalize Windows casing consistently.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Compute <code>repoId</code> using the canonicalized root (and keep <code>repoRoot</code> as canonical path).</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Enforce deterministic ordering for all “identity-bearing” operations:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Sort by <code>repoId</code> for hashing and cache keys.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Preserve <code>alias</code> (and original list position) only for display ordering when desired.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Introduce a stable <strong>repo-set identity</strong> (<code>repoSetId</code>) for federation.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Compute as a stable hash over:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> normalized workspace config (minus non-semantic fields like <code>name</code>)</li>
<li class="task-list-item"><input type="checkbox" disabled/> sorted list of <code>{ repoId, repoRoot }</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Use stable JSON serialization (no non-deterministic key ordering).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Store <code>repoSetId</code> in:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> the workspace manifest (see 15.2)</li>
<li class="task-list-item"><input type="checkbox" disabled/> federated query cache keys (see 15.4)</li>
<li class="task-list-item"><input type="checkbox" disabled/> any “workspace-level” directory naming under cacheRoot.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Harden repo identity helpers so multi-repo identity is stable across callers.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>repoId</code> generation uses <strong>canonical root semantics</strong> consistently across:<ul>
<li>API server routing (<code>tools/api/router.js</code>)</li>
<li>MCP repo resolution (<code>tools/mcp/repo.js</code>)</li>
<li>CLI build/search entrypoints</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure the repo cache root naming stays stable even when users provide different-but-equivalent paths.</li>
</ul>
<p><strong>Touchpoints:</strong>
- <code>tools/dict-utils.js</code> (repo root resolution, <code>getRepoId</code>, cacheRoot overrides)
- <code>src/shared/stable-json.js</code> (stable serialization for hashing)
- New: <code>src/workspace/config.js</code> (or <code>src/retrieval/federation/workspace.js</code>) — loader + validator + <code>repoSetId</code></p>
<h4 id="tests_13">Tests<a class="headerlink" href="#tests_13" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Workspace config parsing accepts absolute and relative repo roots and produces canonical <code>repoRoot</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repoSetId</code> is deterministic:</li>
<li class="task-list-item"><input type="checkbox" disabled/> independent of repo list order in the workspace file</li>
<li class="task-list-item"><input type="checkbox" disabled/> stable across runs/platforms for the same canonical set (Windows casing normalized)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Canonicalization prevents duplicate repo entries that differ only by symlink/subdir pathing.</li>
</ul>
<hr />
<h3 id="152-workspace-index-catalog-discovery-and-manifest">15.2 Workspace index catalog, discovery, and manifest<a class="headerlink" href="#152-workspace-index-catalog-discovery-and-manifest" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement an <strong>index catalog</strong> that can discover “what is indexed” across a cacheRoot.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Scan <code>&lt;cacheRoot&gt;/repos/*/builds/current.json</code> (and/or current build pointers) to enumerate:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> repoId</li>
<li class="task-list-item"><input type="checkbox" disabled/> current buildId</li>
<li class="task-list-item"><input type="checkbox" disabled/> available modes (code/prose/extracted-prose/records)</li>
<li class="task-list-item"><input type="checkbox" disabled/> index directories and SQLite artifact paths</li>
<li class="task-list-item"><input type="checkbox" disabled/> (when available) index compatibility metadata (compatibilityKey; see 15.3)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Treat invalid or unreadable <code>current.json</code> as <strong>missing pointer</strong>, not “keep stale state”.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Define and generate a <strong>workspace manifest</strong> (<code>workspace_manifest.json</code>).</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Write under <code>&lt;cacheRoot&gt;/federation/&lt;repoSetId&gt;/workspace_manifest.json</code> (or equivalent) so all federation artifacts are colocated.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Include:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>schemaVersion</code>, <code>generatedAt</code>, <code>repoSetId</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repos[]</code> with <code>repoId</code>, <code>repoRoot</code>, <code>alias?</code>, <code>tags?</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> For each repo: <code>buildId</code>, per-mode <code>indexDir</code>, per-mode <code>indexSignature</code> (or a compact signature hash), <code>sqlitePaths</code>, and <code>compatibilityKey</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Diagnostics: missing indexes, excluded modes, policy overrides applied</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure manifest generation is deterministic (stable ordering, stable serialization).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add workspace-aware build orchestration (multi-repo indexing) that can produce/refresh the workspace manifest.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>--workspace &lt;path&gt;</code> support to the build entrypoint (or add a dedicated <code>workspace build</code> command):<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Build indexes per repo independently.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure per-repo configs apply (each repo’s own <code>.pairofcleats.jsonc</code>), but workspace config v1 does <strong>not</strong> supply per-repo build overrides; mode selection remains a CLI concern.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Concurrency-limited execution (avoid N repos × M threads exploding resource usage).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure workspace build uses a shared cacheRoot when configured, to maximize reuse of:<ul>
<li>dictionaries/wordlists</li>
<li>model downloads</li>
<li>tooling assets</li>
<li>(future) content-addressed bundles (see 15.5)</li>
</ul>
</li>
</ul>
<p><strong>Touchpoints:</strong>
- <code>tools/dict-utils.js</code> (cache root resolution, build pointer paths)
- <code>build_index.js</code> (add <code>--workspace</code> or create <code>workspace_build.js</code>)
- New: <code>src/workspace/catalog.js</code> (cacheRoot scanning)
- New: <code>src/workspace/manifest.js</code> (manifest writer/reader)</p>
<h4 id="tests_14">Tests<a class="headerlink" href="#tests_14" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Catalog discovery returns the same repo list regardless of filesystem directory enumeration order.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Workspace manifest generation:</li>
<li class="task-list-item"><input type="checkbox" disabled/> records accurate per-repo buildId and per-mode index paths</li>
<li class="task-list-item"><input type="checkbox" disabled/> records compatibilityKey for each indexed mode (when present)</li>
<li class="task-list-item"><input type="checkbox" disabled/> is stable/deterministic for the same underlying catalog state</li>
<li class="task-list-item"><input type="checkbox" disabled/> Invalid <code>builds/current.json</code> does not preserve stale build IDs in memory caches (treated as “pointer invalid”).</li>
</ul>
<hr />
<h3 id="153-federated-search-orchestration-cli-api-server-mcp">15.3 Federated search orchestration (CLI, API server, MCP)<a class="headerlink" href="#153-federated-search-orchestration-cli-api-server-mcp" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <strong>federated search</strong> capability that can query multiple repos in a single request.</li>
<li class="task-list-item"><input type="checkbox" disabled/> CLI:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add <code>pairofcleats search --workspace &lt;path&gt;</code> to query all repos in a workspace.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Support repeated <code>--repo &lt;id|alias|path&gt;</code> to target a subset.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Support <code>--repo-filter &lt;glob|regex&gt;</code> and/or <code>--tag &lt;tag&gt;</code> to select repos by metadata.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> API server:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add a federated endpoint or extend the existing search endpoint to accept:</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>workspace</code> (workspace file path or logical id)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repos</code> selection (ids/aliases/roots)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Apply the same repo-root allowlist enforcement as single-repo mode.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> MCP:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add workspace-aware search inputs (workspace + repo selection).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure MCP search results include repo attribution (see below).</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement a federation coordinator (single orchestration layer) used by CLI/API/MCP.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Input: resolved workspace manifest + normalized search request (query, modes, filters, backend selection, scoring config).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Execution:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Fan out to per-repo search sessions with concurrency limits.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Enforce consistent “per-repo topK” before merging to keep cost bounded.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Collect structured warnings/errors per repo without losing overall response.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Output:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> A single merged result list plus per-repo diagnostics.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Enforce <strong>multi-repo invariants</strong> in federated output:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Every hit must include:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>repoId</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repoRoot</code> (or a stable, display-safe alias)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>repoAlias</code> (if configured)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> When paths collide across repos (same <code>relPath</code>), results must remain unambiguous.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Define and implement deterministic merge semantics for federated results.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Prefer rank-based merging (RRF) at federation layer to reduce cross-index score comparability risk.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Deterministic tie-breakers (in order):<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> higher merged score / better rank</li>
<li class="task-list-item"><input type="checkbox" disabled/> stable repo ordering (e.g., workspace display order or repoId order; choose one and document)</li>
<li class="task-list-item"><input type="checkbox" disabled/> stable document identity (e.g., <code>chunkId</code> / stable doc key)</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Explicitly document the merge policy in the output <code>meta</code> (so debugging is possible).</li>
</ul>
<p><strong>Touchpoints:</strong>
- <code>bin/pairofcleats.js</code> (CLI command surfaces)
- <code>src/integrations/core/index.js</code> (add <code>searchFederated()</code>; reuse <code>runSearchCli</code> per repo)
- <code>src/retrieval/cli.js</code>, <code>src/retrieval/cli-args.js</code> (workspace/repo selection flags and normalization)
- <code>tools/api/router.js</code> (federated endpoint plumbing)
- <code>tools/mcp/repo.js</code> / <code>tools/mcp-server.js</code> (workspace-aware tool inputs)
- New: <code>src/retrieval/federation/coordinator.js</code>
- New: <code>src/retrieval/federation/merge.js</code> (RRF + deterministic tie-breakers)</p>
<h4 id="tests_15">Tests<a class="headerlink" href="#tests_15" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Multi-repo fixture (two tiny repos) proves:</li>
<li class="task-list-item"><input type="checkbox" disabled/> federated search returns results from both repos</li>
<li class="task-list-item"><input type="checkbox" disabled/> results include repo attribution fields</li>
<li class="task-list-item"><input type="checkbox" disabled/> collisions in <code>relPath</code> do not cause ambiguity</li>
<li class="task-list-item"><input type="checkbox" disabled/> Determinism test: same workspace + query yields byte-identical JSON output across repeated runs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Repo selection tests:</li>
<li class="task-list-item"><input type="checkbox" disabled/> repeated <code>--repo</code> works</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>--repo-filter</code> / <code>--tag</code> selection works and is deterministic</li>
</ul>
<hr />
<h3 id="154-compatibility-gating-cohorts-and-safe-federation-defaults">15.4 Compatibility gating, cohorts, and safe federation defaults<a class="headerlink" href="#154-compatibility-gating-cohorts-and-safe-federation-defaults" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement an <strong>index compatibility key</strong> (<code>compatibilityKey</code>) and surface it end-to-end.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Compute from materially relevant index invariants (examples):<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> embedding model id + embedding dimensionality</li>
<li class="task-list-item"><input type="checkbox" disabled/> tokenizer/tokenization key + dictionary version/key</li>
<li class="task-list-item"><input type="checkbox" disabled/> retrieval contract version / feature contract version</li>
<li class="task-list-item"><input type="checkbox" disabled/> ANN backend choice when it changes index semantics (where relevant)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Persist the key into index artifacts:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>index_state.json</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> index manifest metadata (where applicable)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Teach federation to <strong>partition indexes into cohorts</strong> by <code>compatibilityKey</code>.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Default behavior:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Search only within a single cohort (or return per-cohort result sets explicitly).</li>
<li class="task-list-item"><input type="checkbox" disabled/> If multiple cohorts exist, return a warning explaining the mismatch and how to resolve (rebuild or select a cohort).</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Provide an explicit override (CLI/API) to allow “unsafe mixing” if ever required, but keep it opt-in and loud.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure compatibility gating also applies at the single-repo boundary when multiple modes/backends are requested.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Avoid mixing incompatible code/prose/records indexes when the query expects unified ranking.</li>
</ul>
<p><strong>Touchpoints:</strong>
- New: <code>src/contracts/compat/index-compat.js</code> (key builder + comparator)
- <code>src/index/build/indexer/signatures.js</code> (source of some inputs; do not duplicate logic)
- <code>src/retrieval/cli-index.js</code> (read compatibilityKey from index_state / manifest)
- <code>src/workspace/manifest.js</code> (persist compatibilityKey per repo/mode)
- <code>src/retrieval/federation/coordinator.js</code> (cohort partitioning)</p>
<h4 id="tests_16">Tests<a class="headerlink" href="#tests_16" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> CompatibilityKey is stable for the same index inputs and changes when any compatibility input changes.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Federated search with two repos in different cohorts:</li>
<li class="task-list-item"><input type="checkbox" disabled/> returns warning + does not silently mix results by default</li>
<li class="task-list-item"><input type="checkbox" disabled/> succeeds when restricted to a cohort explicitly</li>
<li class="task-list-item"><input type="checkbox" disabled/> Cohort partition ordering is deterministic (no “random cohort chosen”).</li>
</ul>
<hr />
<h3 id="155-federation-caching-cache-key-correctness-and-multi-repo-bug-fixes">15.5 Federation caching, cache-key correctness, and multi-repo bug fixes<a class="headerlink" href="#155-federation-caching-cache-key-correctness-and-multi-repo-bug-fixes" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Introduce a federated query cache location and policy.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Store at <code>&lt;cacheRoot&gt;/federation/&lt;repoSetId&gt;/queryCache.json</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add TTL and size controls (evict old entries deterministically).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure the cache is safe to share across tools (CLI/API/MCP) by using the same keying rules.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Make federated query cache keys <strong>complete</strong> and <strong>stable</strong>.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Must include at least:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>repoSetId</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> per-repo (or per-cohort) <code>indexSignature</code> (or a combined signature hash)</li>
<li class="task-list-item"><input type="checkbox" disabled/> query string + search type (tokens/regex/import/author/etc)</li>
<li class="task-list-item"><input type="checkbox" disabled/> all relevant filters (path/file/ext/lang/meta filters)</li>
<li class="task-list-item"><input type="checkbox" disabled/> retrieval knobs that change ranking/results (e.g., fileChargramN, ANN backend, RRF/blend config, BM25 params, sqlite thresholds, context window settings)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Use stable JSON serialization to avoid key drift from object insertion order.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Fix query-cache invalidation correctness for sharded/variant artifact formats.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure index signatures reflect changes to:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>chunk_meta.json</code> <em>and</em> sharded variants (<code>chunk_meta.jsonl</code> + <code>chunk_meta.meta.json</code> + shard parts)</li>
<li class="task-list-item"><input type="checkbox" disabled/> token postings / file relations / embeddings artifacts when present</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Avoid “partial signature” logic that misses sharded formats.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Normalize repo-path based caches to canonical repo roots everywhere federation will touch.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> API server repo cache keys must use canonical repo root (realpath + repo root), not caller-provided path strings.</li>
<li class="task-list-item"><input type="checkbox" disabled/> MCP repo cache keys must use canonical repo root even when the caller provides a subdirectory.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Fix MCP build pointer parse behavior: if <code>builds/current.json</code> is invalid JSON, clear build id and caches rather than keeping stale state.</li>
</ul>
<p><strong>Touchpoints:</strong>
- <code>src/retrieval/cli-index.js</code> (index signature computation; sharded meta awareness)
- <code>src/retrieval/cli/run-search-session.js</code> (query cache key builder must include all ranking knobs like <code>fileChargramN</code>)
- <code>src/retrieval/index-cache.js</code> and <code>src/shared/artifact-io.js</code> (canonical signature logic; avoid duplicating parsers)
- <code>src/retrieval/query-cache.js</code> (federation namespace support and eviction policy if implemented here)
- <code>tools/api/router.js</code> (repo cache key normalization; federation cache integration)
- <code>tools/mcp/repo.js</code> (repo root canonicalization; build pointer parse error handling)
- <code>tools/dict-utils.js</code> (repoId generation stability across realpath/subdir)</p>
<h4 id="tests_17">Tests<a class="headerlink" href="#tests_17" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Federated query cache key changes when:</li>
<li class="task-list-item"><input type="checkbox" disabled/> any repo’s indexSignature changes</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>fileChargramN</code> (or other ranking knobs) changes</li>
<li class="task-list-item"><input type="checkbox" disabled/> repo selection changes (subset vs full workspace)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Sharded chunk_meta invalidation test:</li>
<li class="task-list-item"><input type="checkbox" disabled/> updating a shard or <code>chunk_meta.meta.json</code> invalidates cached queries</li>
<li class="task-list-item"><input type="checkbox" disabled/> MCP repo path canonicalization test:</li>
<li class="task-list-item"><input type="checkbox" disabled/> passing a subdirectory path resolves to repo root and shares the same caches as passing the repo root</li>
<li class="task-list-item"><input type="checkbox" disabled/> Build-pointer parse failure test:</li>
<li class="task-list-item"><input type="checkbox" disabled/> invalid <code>builds/current.json</code> clears buildId and closes/clears caches (no stale serving)</li>
</ul>
<hr />
<h3 id="156-shared-caches-centralized-caching-and-scale-out-ergonomics">15.6 Shared caches, centralized caching, and scale-out ergonomics<a class="headerlink" href="#156-shared-caches-centralized-caching-and-scale-out-ergonomics" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Make cache layers explicit and shareable across repos/workspaces.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Identify and document which caches are:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> global (models, tooling assets, dictionaries/wordlists)</li>
<li class="task-list-item"><input type="checkbox" disabled/> repo-scoped (index builds, sqlite artifacts)</li>
<li class="task-list-item"><input type="checkbox" disabled/> workspace-scoped (federation query caches, workspace manifests)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure cache keys include all required invariants (repoId/buildId/indexSignature/compatibilityKey) to prevent stale reuse.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Introduce (or extend) a content-addressed store for expensive derived artifacts to maximize reuse across repos.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Candidates:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> cached bundles from file processing</li>
<li class="task-list-item"><input type="checkbox" disabled/> extracted prose artifacts (where applicable)</li>
<li class="task-list-item"><input type="checkbox" disabled/> tool outputs that are content-addressable</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add a cache GC command (<code>pairofcleats cache gc</code>) driven by manifests/snapshots.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Scale-out and throughput controls for workspace operations.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Concurrency limits for:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> multi-repo indexing</li>
<li class="task-list-item"><input type="checkbox" disabled/> federated search fan-out</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Memory caps remain bounded under “N repos × large query” workloads.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Optional future: a centralized cache service mode (daemon) for eviction/orchestration.</p>
<ul>
<li>Defer the daemon itself to a follow-on phase if it would delay shipping first federated search.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Wordlists + dictionary strategy improvements to support multi-repo consistency.</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Auto-download wordlists when missing.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Allow better lists and document how to pin versions for reproducibility.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Evaluate repo-specific dictionaries without breaking workspace determinism (pin by dictionary key/version).</li>
</ul>
<p><strong>Touchpoints:</strong>
- <code>tools/dict-utils.js</code> (global cache dirs: models/tooling/dictionaries; cacheRoot override)
- <code>src/shared/cache.js</code> (cache stats, eviction, size tracking; potential reuse)
- <code>src/index/build/file-processor/cached-bundle.js</code> (bundle caching)
- <code>src/index/build/file-processor/embeddings.js</code> (embedding caching/service integration)
- New: <code>src/shared/cas.js</code> (content-addressed storage helpers) and <code>tools/cache-gc.js</code></p>
<h4 id="tests_18">Tests<a class="headerlink" href="#tests_18" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Two-repo workspace build proves global caches are reused (no duplicate downloads; stable cache paths).</li>
<li class="task-list-item"><input type="checkbox" disabled/> CAS reuse test: identical input across repos yields identical object keys and avoids recomputation.</li>
<li class="task-list-item"><input type="checkbox" disabled/> GC test: removes unreferenced objects while preserving those referenced by workspace/snapshot manifests.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Concurrency test: workspace indexing/search honors configured limits (does not exceed).</li>
</ul>
<hr />
<h2 id="phase-16-prose-ingestion-retrieval-routing-correctness-pdfdocx-fts-policy">Phase 16 — Prose ingestion + retrieval routing correctness (PDF/DOCX + FTS policy)<a class="headerlink" href="#phase-16-prose-ingestion-retrieval-routing-correctness-pdfdocx-fts-policy" title="Permanent link"></a></h2>
<h3 id="objective_7">Objective<a class="headerlink" href="#objective_7" title="Permanent link"></a></h3>
<p>Deliver first-class document ingestion (PDF + DOCX) and prose retrieval correctness:</p>
<ul>
<li>PDF/DOCX can be ingested (when optional deps exist) into deterministic, segment-aware prose chunks.</li>
<li>When deps are missing or extraction fails, the index build remains green and reports explicit, per-file skip reasons.</li>
<li>Prose/extracted-prose routes deterministically to SQLite FTS with safe, explainable query compilation; code routes to sparse/postings.</li>
<li>Retrieval helpers are hardened so constraints (<code>allowedIds</code>), weighting, and table availability cannot silently produce wrong or under-filled results.</li>
</ul>
<p>Note: vector-only indexing profile work is handled in <strong>Phase 17 — Vector-Only Index Profile (Embeddings-First)</strong>.</p>
<h3 id="161-optional-dependency-document-extractors-pdfdocx-with-deterministic-structured-output">16.1 Optional-dependency document extractors (PDF/DOCX) with deterministic structured output<a class="headerlink" href="#161-optional-dependency-document-extractors-pdfdocx-with-deterministic-structured-output" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add extractor modules that return structured units (do not pre-join into one giant string):</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/extractors/pdf.js</code> (new)<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>extractPdf({ filePath, buffer }) -&gt; { ok:true, pages:[{ pageNumber, text }], warnings:[] } | { ok:false, reason, warnings:[] }</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/extractors/docx.js</code> (new)<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>extractDocx({ filePath, buffer }) -&gt; { ok:true, paragraphs:[{ index, text, style? }], warnings:[] } | { ok:false, reason, warnings:[] }</code></li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Normalize extracted text units:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> normalize newlines to <code>\n</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> collapse excessive whitespace but preserve paragraph boundaries</li>
<li class="task-list-item"><input type="checkbox" disabled/> preserve deterministic ordering (page order, paragraph order)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Implement optional-dep loading via <code>tryImport</code> (preferred) with conservative fallbacks:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> PDF: try <code>pdfjs-dist/legacy/build/pdf.js|pdf.mjs</code>, then <code>pdfjs-dist/build/pdf.js</code>, then <code>pdfjs-dist</code>.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> DOCX: <code>mammoth</code> preferred, <code>docx</code> as a documented fallback.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Capability gating must match real loadability:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend <code>src/shared/capabilities.js</code> so <code>capabilities.extractors.pdf/docx</code> reflects whether the extractor modules can successfully load a working implementation (including ESM/subpath cases).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure capability checks do not treat “package installed but unusable entrypoint” as available.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Failure behavior must be per-file and non-fatal:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extractor failures must be caught and converted into a typed <code>{ ok:false, reason }</code> result.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Record per-file extraction failures into build state (see 16.3) with actionable messaging.</li>
</ul>
<p>Touchpoints:
- <code>src/index/extractors/pdf.js</code> (new)
- <code>src/index/extractors/docx.js</code> (new)
- <code>src/shared/capabilities.js</code>
- Refactor/reuse logic from <code>tools/bench/micro/extractors.js</code> into the runtime extractors (bench remains a consumer).</p>
<h4 id="tests_19">Tests<a class="headerlink" href="#tests_19" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/extractors/pdf-missing-dep-skips.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> When PDF capability is false, extraction path is skipped cleanly and build remains green.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/extractors/docx-missing-dep-skips.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> When DOCX capability is false, extraction path is skipped cleanly and build remains green.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/extractors/pdf-smoke.test.js</code> (conditional; only when deps available)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extract a fixture PDF and assert known phrase is present.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/extractors/docx-smoke.test.js</code> (conditional; only when deps available)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extract a fixture DOCX and assert known phrase is present.</li>
</ul>
<h3 id="162-deterministic-doc-chunking-pageparagraph-aware-doc-mode-limits-that-scale-to-large-files">16.2 Deterministic doc chunking (page/paragraph aware) + doc-mode limits that scale to large files<a class="headerlink" href="#162-deterministic-doc-chunking-pageparagraph-aware-doc-mode-limits-that-scale-to-large-files" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add deterministic chunkers for extracted documents:</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>src/index/chunking/formats/pdf.js</code> (new)<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Default: one chunk per page.</li>
<li class="task-list-item"><input type="checkbox" disabled/> If a page is tiny, allow deterministic grouping (e.g., group adjacent pages up to a budget).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Each chunk carries provenance: <code>{ type:'pdf', pageStart, pageEnd, anchor }</code>.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> <code>src/index/chunking/formats/docx.js</code> (new)</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Group paragraphs into chunks by max character/token budget.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Preserve heading boundaries when style information is available.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Each chunk carries provenance: <code>{ type:'docx', paragraphStart, paragraphEnd, headingPath?, anchor }</code>.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Support adaptive splitting for “hot” or unexpectedly large segments without breaking stability:</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> If a page/section/window exceeds caps, split into deterministic subsegments with stable sub-anchors (no run-to-run drift).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Sweep-driven performance hardening for chunking limits (because PDF/DOCX can create very large blobs):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>src/index/chunking/limits.js</code> so byte-boundary resolution is not quadratic on large inputs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Avoid building full <code>lineIndex</code> unless line-based truncation is requested.</li>
</ul>
<p>Touchpoints:
- <code>src/index/chunking/formats/pdf.js</code> (new)
- <code>src/index/chunking/formats/docx.js</code> (new)
- <code>src/index/chunking/limits.js</code></p>
<h4 id="tests_20">Tests<a class="headerlink" href="#tests_20" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/prose/pdf-chunking-deterministic.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Two-page fixture; assert stable chunk count, anchors, and page ranges across repeated runs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/prose/docx-chunking-deterministic.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Multi-paragraph fixture; assert stable chunk grouping and heading boundary behavior.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/perf/chunking-limits-large-input.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Regression guard: chunking limits on a large string must complete within a bounded time.</li>
</ul>
<h3 id="163-integrate-extraction-into-indexing-build-discovery-skip-logic-file-processing-state">16.3 Integrate extraction into indexing build (discovery, skip logic, file processing, state)<a class="headerlink" href="#163-integrate-extraction-into-indexing-build-discovery-skip-logic-file-processing-state" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Discovery gating:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>src/index/build/discover.js</code> so <code>.pdf</code>/<code>.docx</code> are only considered when <code>indexing.documentExtraction.enabled === true</code>.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> If enabled but deps missing: record explicit “skipped due to capability” diagnostics (do not silently ignore).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Binary skip exceptions:</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Update <code>src/index/build/file-processor/skip.js</code> to treat <code>.pdf</code>/<code>.docx</code> as extractable binaries when extraction is enabled, routing them to extractors instead of skipping.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> File processing routing:</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Update <code>src/index/build/file-processor.js</code> (and <code>src/index/build/file-processor/assemble.js</code> as needed) to:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> hash on raw bytes (caching correctness even if extraction changes)</li>
<li class="task-list-item"><input type="checkbox" disabled/> extract structured units</li>
<li class="task-list-item"><input type="checkbox" disabled/> build a deterministic joined text representation with a stable offset mapping</li>
<li class="task-list-item"><input type="checkbox" disabled/> chunk via the dedicated pdf/docx chunkers</li>
<li class="task-list-item"><input type="checkbox" disabled/> emit chunks with <code>segment</code> provenance and <code>lang:'prose'</code> (or a dedicated document language marker)</li>
<li class="task-list-item"><input type="checkbox" disabled/> ensure chunk identity cannot collide with code chunks (segment markers must be part of identity)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Record per-file extraction outcomes:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Success: record page/paragraph counts and warnings.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Failure/skip: record reason (<code>missing_dependency</code>, <code>extract_failed</code>, <code>oversize</code>, etc.) and include actionable guidance.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Chunking dispatch registration:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Update <code>src/index/chunking/dispatch.js</code> to route <code>.pdf</code>/<code>.docx</code> through the document chunkers under the same gating.</li>
</ul>
<p>Touchpoints:
- <code>src/index/build/discover.js</code>
- <code>src/index/build/file-processor/skip.js</code>
- <code>src/index/build/file-processor.js</code>
- <code>src/index/build/file-processor/assemble.js</code>
- <code>src/index/chunking/dispatch.js</code></p>
<h4 id="tests_21">Tests<a class="headerlink" href="#tests_21" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/indexing/documents-included-when-available.test.js</code> (conditional; when deps available)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Build fixture containing a sample PDF and DOCX; assert chunks exist with <code>segment.type:'pdf'|'docx'</code> and searchable text is present.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/indexing/documents-skipped-when-unavailable.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Force capabilities off; build succeeds; skipped docs are reported deterministically with reasons.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/indexing/document-bytes-hash-stable.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure caching identity remains tied to bytes + extractor version/config.</li>
</ul>
<h3 id="164-metav2-and-chunk_meta-contract-extensions-for-extracted-documents">16.4 metaV2 and chunk_meta contract extensions for extracted documents<a class="headerlink" href="#164-metav2-and-chunk_meta-contract-extensions-for-extracted-documents" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Extend metaV2 for extracted docs in <code>src/index/metadata-v2.js</code>:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a <code>document</code> (or <code>segment</code>) block with provenance fields:<ul>
<li><code>sourceType: 'pdf'|'docx'</code></li>
<li><code>pageStart/pageEnd</code> (PDF)</li>
<li><code>paragraphStart/paragraphEnd</code> (DOCX)</li>
<li>optional <code>headingPath</code>, <code>windowIndex</code>, and a stable <code>anchor</code> for citation.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>chunk_meta.jsonl</code> includes these fields and that output is backend-independent (artifact vs SQLite).</li>
<li class="task-list-item"><input type="checkbox" disabled/> If metaV2 is versioned, bump schema version (or add one) and provide backward-compatible normalization.</li>
</ul>
<p>Touchpoints:
- <code>src/index/metadata-v2.js</code>
- <code>src/index/build/file-processor/assemble.js</code>
- Retrieval loaders that depend on metaV2 (for parity checks)</p>
<h4 id="tests_22">Tests<a class="headerlink" href="#tests_22" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/unit/metaV2-extracted-doc.unit.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Verify extracted-doc schema fields are present, typed, and deterministic.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/services/sqlite-hydration-metaV2-parity.services.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build an index; load hits via artifact-backed and SQLite-backed paths; assert canonical metaV2 fields match for extracted docs.</li>
</ul>
<h3 id="165-prose-retrieval-routing-defaults-fts-query-compilation-correctness-explainable-deterministic">16.5 Prose retrieval routing defaults + FTS query compilation correctness (explainable, deterministic)<a class="headerlink" href="#165-prose-retrieval-routing-defaults-fts-query-compilation-correctness-explainable-deterministic" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Enforce routing defaults:</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>prose</code> / <code>extracted-prose</code> → SQLite FTS by default.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>code</code> → sparse/postings by default.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Overrides select requested providers and are reflected in <code>--explain</code> output.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Make FTS query compilation AST-driven for prose routes:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Generate the FTS5 <code>MATCH</code> string from the raw query (or parsed boolean AST).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Quote/escape terms so punctuation (<code>-</code>, <code>:</code>, <code>\"</code>, <code>*</code>) and keywords (<code>NEAR</code>, etc.) are not interpreted as operators unintentionally.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Include the final compiled <code>MATCH</code> string and provider choice in <code>--explain</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Provider variants and deterministic selection (conditional and explicit):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Default: <code>unicode61 remove_diacritics 2</code> variant.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Conditional: porter variant for Latin-script stemming use-cases.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Conditional: trigram variant for substring/CJK/emoji fallback behind <code>--fts-trigram</code> until benchmarks are complete.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Conditional: NFKC-normalized variant when normalization changes the query.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Merge provider result sets deterministically by <code>chunkUid</code> with stable tie-breaking.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Enforce capability gating at provider boundaries (never throw):</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> If FTS tables are missing, providers return “unavailable” results and the router selects an alternative or returns a deterministic warning.</li>
</ul>
<p>Touchpoints:
- <code>src/retrieval/pipeline.js</code>
- <code>src/retrieval/query.js</code> / <code>src/retrieval/query-parse.js</code>
- <code>src/retrieval/sqlite-helpers.js</code>
- <code>src/retrieval/sqlite-cache.js</code></p>
<h4 id="tests_23">Tests<a class="headerlink" href="#tests_23" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/search-routing-policy.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Prose defaults to FTS; code defaults to postings; overrides behave deterministically and are explained.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/sqlite-fts-query-escape.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Punctuation cannot inject operators; the compiled <code>MATCH</code> string is stable and safe.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/fts-tokenizer-config.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert baseline tokenizer uses diacritic-insensitive configuration; include a diacritic recall fixture.</li>
</ul>
<h3 id="166-sweep-driven-correctness-fixes-in-retrieval-helpers-touched-by-prose-fts-routing">16.6 Sweep-driven correctness fixes in retrieval helpers touched by prose FTS routing<a class="headerlink" href="#166-sweep-driven-correctness-fixes-in-retrieval-helpers-touched-by-prose-fts-routing" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Fix <code>rankSqliteFts()</code> correctness for <code>allowedIds</code>:</li>
<li class="task-list-item"><input type="checkbox" disabled/> When <code>allowedIds</code> is too large for a single <code>IN (...)</code>, implement adaptive overfetch (or chunked pushdown) until:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>topN</code> hits remain after filtering, or</li>
<li class="task-list-item"><input type="checkbox" disabled/> a hard cap/time budget is hit.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure results are the true “top-N among allowed IDs” (do not allow disallowed IDs to occupy limited slots).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Fix weighting and LIMIT-order correctness in FTS ranking:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> If <code>chunks.weight</code> is part of ranking, incorporate it into ordering before applying <code>LIMIT</code> (or fetch enough rows to make post-weighting safe).</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add stable tie-breaking rules and make them part of the contract.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Fix <code>unpackUint32()</code> alignment safety:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Avoid constructing a <code>Uint32Array</code> view on an unaligned Buffer slice.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> When needed, copy to an aligned <code>ArrayBuffer</code> (or decode via <code>DataView</code>) before reading.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure helper-level capability guards are enforced:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> If <code>chunks_fts</code> is missing, <code>rankSqliteFts</code> returns <code>[]</code> or a controlled “unavailable” result (not throw).</li>
</ul>
<p>Touchpoints:
- <code>src/retrieval/sqlite-helpers.js</code></p>
<h4 id="tests_24">Tests<a class="headerlink" href="#tests_24" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/rankSqliteFts-allowedIds-correctness.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/rankSqliteFts-weight-before-limit.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/unpackUint32-buffer-alignment.test.js</code></li>
</ul>
<h3 id="167-query-intent-classification-boolean-parsing-semantics-route-aware-non-regressing">16.7 Query intent classification + boolean parsing semantics (route-aware, non-regressing)<a class="headerlink" href="#167-query-intent-classification-boolean-parsing-semantics-route-aware-non-regressing" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Fix path-intent misclassification so routing is reliable:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Replace the “any slash/backslash implies path” heuristic with more discriminating signals:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> require path-like segments (multiple separators, dot-extensions, <code>./</code> / <code>../</code>, drive roots), and</li>
<li class="task-list-item"><input type="checkbox" disabled/> treat URLs separately so prose queries containing <code>https://...</code> do not get path-biased.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Keep intent scoring explainable and stable.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Harden boolean parsing semantics to support FTS compilation and future strict evaluation:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Treat unary <code>-</code> as NOT even with whitespace (e.g., <code>- foo</code>, <code>- "phrase"</code>), or reject standalone <code>-</code> with a parse error.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure phrase parsing behavior is explicit (either implement minimal escaping or formally document “no escaping”).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Prevent flattened token inventories from being mistaken for semantic constraints:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> rename inventory lists (or attach an explicit <code>inventoryOnly</code> marker) so downstream code cannot accidentally erase boolean semantics.</li>
</ul>
</li>
</ul>
<p>Touchpoints:
- <code>src/retrieval/query-intent.js</code>
- <code>src/retrieval/query.js</code></p>
<h4 id="tests_25">Tests<a class="headerlink" href="#tests_25" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/query-intent-path-heuristics.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/boolean-unary-not-whitespace.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/boolean-inventory-vs-semantics.test.js</code></li>
</ul>
<h3 id="168-retrieval-output-shaping-scorebreakdown-consistency-explain-fidelity-plus-harness-drift-repair">16.8 Retrieval output shaping: <code>scoreBreakdown</code> consistency + explain fidelity, plus harness drift repair<a class="headerlink" href="#168-retrieval-output-shaping-scorebreakdown-consistency-explain-fidelity-plus-harness-drift-repair" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Resolve <code>scoreBreakdown</code> contract inconsistencies:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Standardize field names and nesting across providers (SQLite FTS, postings, vector) so consumers do not need provider-specific logic.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure verbosity/output size is governed by a single budget policy (max bytes/fields/explain items).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure <code>--explain</code> is complete and deterministic:</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Explain must include:</p>
<ul>
<li>routing decision</li>
<li>compiled FTS <code>MATCH</code> string for prose routes</li>
<li>provider variants used and thresholds</li>
<li>capability gating decisions when features are unavailable</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Repair script-coverage harness drift affecting CI signal quality:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Align <code>tests/script-coverage/actions.js</code> <code>covers</code> entries with actual <code>package.json</code> scripts.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure <code>tests/script-coverage/report.js</code> does not fail with <code>unknownCovers</code> for legitimate cases.</li>
</ul>
<p>Touchpoints:
- <code>src/retrieval/output/*</code>
- <code>tests/script-coverage/*</code>
- <code>package.json</code></p>
<h4 id="tests_26">Tests<a class="headerlink" href="#tests_26" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/scoreBreakdown-contract-parity.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/explain-output-includes-routing-and-fts-match.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/script-coverage/harness-parity.test.js</code></li>
</ul>
<hr />
<h2 id="phase-17-vector-only-profile-build-search-without-sparse-postings">Phase 17 — Vector-Only Profile (Build + Search Without Sparse Postings)<a class="headerlink" href="#phase-17-vector-only-profile-build-search-without-sparse-postings" title="Permanent link"></a></h2>
<blockquote>
<p>This is the <strong>canonical merged phase</strong> for the previously overlapping “Phase 17” and “Phase 18” drafts.<br />
Goal: a <em>vector-only</em> index that can be built and queried <strong>without</strong> sparse/token/postings artifacts.</p>
</blockquote>
<h3 id="objective_8">Objective<a class="headerlink" href="#objective_8" title="Permanent link"></a></h3>
<p>Enable an indexing profile that is:</p>
<ul>
<li><strong>Embeddings-first</strong>: dense vectors are the primary (and optionally only) retrieval substrate.</li>
<li><strong>Sparse-free</strong>: skips generation and storage of sparse token postings (and any derived sparse artifacts).</li>
<li><strong>Strict and explicit</strong>: search refuses to “pretend” sparse exists; mismatched modes are hard errors with actionable messages.</li>
<li><strong>Artifact-consistent</strong>: switching profiles cannot leave stale sparse artifacts that accidentally affect search.</li>
</ul>
<p>This is especially valuable for:
- huge corpora where sparse artifacts dominate disk/time,
- doc-heavy or mixed corpora where ANN is the primary workflow,
- environments where you want fast/cheap rebuilds and can accept ANN-only recall.</p>
<hr />
<h3 id="exit-criteria-must-all-be-true_1">Exit criteria (must all be true)<a class="headerlink" href="#exit-criteria-must-all-be-true_1" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Config supports <code>indexing.profile: "default" | "vector_only"</code> (default: <code>"default"</code>).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>vector_only</code> builds succeed end-to-end and <strong>do not emit</strong> sparse artifacts (tokens/postings/minhash/etc).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Search against a <code>vector_only</code> index:</li>
<li class="task-list-item"><input type="checkbox" disabled/> requires an ANN-capable provider (or explicit <code>--ann</code>), and</li>
<li class="task-list-item"><input type="checkbox" disabled/> rejects token/sparse-dependent features with a clear error (not silent degradation).</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>index_state.json</code> records the profile and a machine-readable “artifact presence” manifest with a schema version.</li>
<li class="task-list-item"><input type="checkbox" disabled/> SQLite-backed retrieval cannot crash on missing sparse tables; it either:</li>
<li class="task-list-item"><input type="checkbox" disabled/> uses a vector-only schema, or</li>
<li class="task-list-item"><input type="checkbox" disabled/> detects missing tables and returns a controlled “profile mismatch / artifact missing” error.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Tests cover: profile switching cleanup, ANN-only search, and “mismatch is an error” behavior.</li>
</ul>
<hr />
<h3 id="phase-171-profile-contract-build-state-index-state-schema">Phase 17.1 — Profile contract + build-state / index-state schema<a class="headerlink" href="#phase-171-profile-contract-build-state-index-state-schema" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add and normalize config:</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>indexing.profile</code> (string enum): <code>default | vector_only</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Default behavior: absent ⇒ <code>default</code></li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Reject unknown values (fail-fast in config normalization)</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Define the canonical on-disk contract in <code>index_state.json</code>:</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add a <code>profile</code> block (versioned):</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>profile.id: "default" | "vector_only"</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>profile.schemaVersion: 1</code></li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add an <code>artifacts</code> presence block (versioned) so loaders can reason about what exists:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>artifacts.schemaVersion: 1</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>artifacts.present: { [artifactName]: true }</code> (only list artifacts that exist)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>artifacts.omitted: string[]</code> (explicit omissions for the selected profile)</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>artifacts.requiredForSearch: string[]</code> (profile-specific minimum set)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Add a build-time invariant:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> If <code>profile.id === "vector_only"</code>, then <code>token_postings*</code>, <code>token_vocab</code>, <code>token_stats</code>, <code>minhash*</code>, and any sparse-only artifacts MUST NOT be present.</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure build signatures include profile:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> signature/caching keys must incorporate <code>profile.id</code> so switching profiles forces a rebuild.</li>
</ul>
<p>Touchpoints:
- <code>docs/config/schema.json</code>
- <code>src/index/build/runtime/runtime.js</code> (read + normalize <code>indexing.profile</code>)
- <code>src/index/build/indexer/signatures.js</code> (include profile in signature)
- <code>src/index/build/state.js</code> / <code>src/index/build/artifacts.js</code> (index_state emission)
- <code>src/retrieval/cli/index-state.js</code> (surface profile + artifacts in <code>index_status</code>)</p>
<h4 id="tests_27">Tests<a class="headerlink" href="#tests_27" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/index/profile-index-state-contract.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build tiny index with each profile and assert <code>index_state.json.profile</code> + <code>index_state.json.artifacts</code> satisfy schema invariants.</li>
</ul>
<hr />
<h3 id="phase-172-build-pipeline-gating-skip-sparse-generation-cleanly">Phase 17.2 — Build pipeline gating (skip sparse generation cleanly)<a class="headerlink" href="#phase-172-build-pipeline-gating-skip-sparse-generation-cleanly" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Thread <code>profile.id</code> into the indexer pipeline and feature settings:</li>
<li class="task-list-item"><input type="checkbox" disabled/> In <code>vector_only</code>, set <code>featureSettings.tokenize = false</code> (and ensure all downstream steps respect it)</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure embeddings remain enabled/allowed (vector-only without vectors should be rejected at build time unless explicitly configured to “index without vectors”)</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Skip sparse stages when <code>vector_only</code>:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Do not run <code>buildIndexPostings()</code> (or make it a no-op) when tokenize=false.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Do not write sparse artifacts in <code>writeIndexArtifactsForMode()</code> / <code>src/index/build/artifacts.js</code>.</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Cleanup/consistency when switching profiles:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> When building <code>vector_only</code>, proactively remove any prior sparse artifacts in the target output dir so stale files cannot be accidentally loaded.</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> When building <code>default</code>, ensure sparse artifacts are emitted normally (and any vector-only-only special casing does not regress).</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Ensure “missing doc embedding” representation stays stable:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Continue using the existing <strong>zero-length typed array</strong> convention for missing vectors.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a regression test so future refactors don’t reintroduce <code>null</code>/NaN drift.</li>
</ul>
<p>Touchpoints:
- <code>src/index/build/indexer/pipeline.js</code> (profile → feature gating)
- <code>src/index/build/indexer/steps/postings.js</code> (skip when tokenize=false)
- <code>src/index/build/indexer/steps/write.js</code> + <code>src/index/build/artifacts.js</code> (omit sparse artifacts)
- <code>src/index/build/file-processor/embeddings.js</code> (missing-doc marker regression)</p>
<h4 id="tests_28">Tests<a class="headerlink" href="#tests_28" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/index/vector-only-does-not-emit-sparse.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Assert absence of <code>token_postings*</code>, <code>token_vocab*</code>, <code>token_stats*</code>, <code>minhash*</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/index/vector-only-switching-cleans-stale-sparse.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> Build default, then vector_only into same outDir; assert sparse artifacts removed.</li>
</ul>
<hr />
<h3 id="phase-173-search-routing-strict-profile-compatibility">Phase 17.3 — Search routing + strict profile compatibility<a class="headerlink" href="#phase-173-search-routing-strict-profile-compatibility" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Load and enforce <code>index_state.json.profile</code> at query time:</li>
<li class="task-list-item"><input type="checkbox" disabled/> If the index is <code>vector_only</code>:<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> default router must choose ANN/vector provider(s)</li>
<li class="task-list-item"><input type="checkbox" disabled/> sparse/postings providers must be disabled/unavailable</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> If a caller explicitly requests sparse-only behavior against vector_only:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> return a controlled error with guidance (“rebuild with indexing.profile=default”)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> Token-dependent query features must be explicit:</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> If a query requests phrase/boolean constraints that require token inventory:</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> either (a) reject with error, or (b) degrade with a warning and set <code>explain.warnings[]</code> (pick one policy and make it part of the contract)</li>
</ul>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled/> SQLite helper hardening for profile-aware operation:</p>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a lightweight <code>requireTables(db, names[])</code> helper used at provider boundaries.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Providers must check required tables for their mode and return an actionable “tables missing” error (not throw).</li>
</ul>
<p>Touchpoints:
- <code>src/retrieval/pipeline.js</code> (router)
- <code>src/retrieval/index-load.js</code> (ensure index_state loaded early)
- <code>src/retrieval/sqlite-helpers.js</code> (table guards)
- <code>src/retrieval/providers/*</code> (respect profile + missing-table outcomes)
- <code>src/retrieval/output/explain.js</code> (surface profile + warnings)</p>
<h4 id="tests_29">Tests<a class="headerlink" href="#tests_29" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/vector-only-search-requires-ann.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/vector-only-rejects-sparse-mode.test.js</code></li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/retrieval/sqlite-missing-sparse-tables-is-controlled-error.test.js</code></li>
</ul>
<hr />
<h3 id="phase-174-optional-analysis-policy-shortcuts-for-vector-only-builds-stretch">Phase 17.4 — Optional: “analysis policy shortcuts” for vector-only builds (stretch)<a class="headerlink" href="#phase-174-optional-analysis-policy-shortcuts-for-vector-only-builds-stretch" title="Permanent link"></a></h3>
<p>This is explicitly optional, but worth considering because it is where most build time goes for code-heavy repos.</p>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add a documented policy switch: when <code>indexing.profile=vector_only</code>, default <code>analysisPolicy</code> can disable:</li>
<li class="task-list-item"><input type="checkbox" disabled/> type inference</li>
<li class="task-list-item"><input type="checkbox" disabled/> risk analysis</li>
<li class="task-list-item"><input type="checkbox" disabled/> expensive cross-file passes</li>
<li class="task-list-item"><input type="checkbox" disabled/> (optionally) lint/complexity stages</li>
<li class="task-list-item"><input type="checkbox" disabled/> Make these <em>opt-outable</em> (users can re-enable per setting).</li>
</ul>
<p>Touchpoints:
- <code>src/index/build/indexer/pipeline.js</code> (feature flags)
- <code>docs/config/</code> (document defaults and overrides)</p>
<h2 id="phase-20-distribution-platform-hardening-release-matrix-packaging-and-optional-python">Phase 20 — Distribution &amp; Platform Hardening (Release Matrix, Packaging, and Optional Python)<a class="headerlink" href="#phase-20-distribution-platform-hardening-release-matrix-packaging-and-optional-python" title="Permanent link"></a></h2>
<h3 id="objective_9">Objective<a class="headerlink" href="#objective_9" title="Permanent link"></a></h3>
<p>Make PairOfCleats releasable and operable across supported platforms by defining a <strong>release target matrix</strong>, adding a <strong>deterministic release smoke-check</strong>, hardening <strong>cross-platform path handling</strong>, and producing <strong>reproducible editor/plugin packages</strong> (Sublime + VS Code) with CI gates.</p>
<p>This phase also standardizes how Python-dependent tests and tooling behave when Python is missing: they must <strong>skip cleanly</strong> (without producing “false red” CI failures), while still failing when Python is present but the test is genuinely broken.</p>
<h3 id="exit-criteria_1">Exit Criteria<a class="headerlink" href="#exit-criteria_1" title="Permanent link"></a></h3>
<ul>
<li>A documented release target matrix exists (platform × Node version × optional dependencies policy).</li>
<li>A deterministic <code>release-check</code> smoke run exists and is runnable locally and in CI, and it validates:</li>
<li><code>pairofcleats --version</code></li>
<li><code>pairofcleats index build</code> + <code>index validate</code></li>
<li>a basic <code>search</code> against a fixture repo</li>
<li>presence/packaging sanity of editor integrations (when enabled)</li>
<li>Cross-platform “paths with spaces” (and Windows path semantics) have regression tests, and the audited commands pass.</li>
<li>Sublime packaging is reproducible and validated by tests (structure + version stamping).</li>
<li>VS Code extension packaging is reproducible and validated by tests (or explicitly gated as non-blocking if the packaging toolchain is absent).</li>
<li>Python-dependent tests pass on machines without Python (skipped) and still enforce Python syntax correctness when Python is present.</li>
</ul>
<hr />
<h3 id="phase-201-release-target-matrix-deterministic-release-smoke-check">Phase 20.1 — Release target matrix + deterministic release smoke-check<a class="headerlink" href="#phase-201-release-target-matrix-deterministic-release-smoke-check" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Define and publish the <strong>release target matrix</strong> and optional-dependency policy.</li>
<li>Primary output:<ul>
<li><code>docs/release-matrix.md</code> (or <code>docs/release/targets.md</code>)</li>
</ul>
</li>
<li>Include:<ul>
<li>Supported OSes and runners (Linux/macOS/Windows) and architectures (x64/arm64 where supported).</li>
<li>Supported Node versions (minimum + tested versions).</li>
<li>Optional dependency behavior policy (required vs optional features), including:</li>
<li>Python (for Sublime lint/compile tests)</li>
<li>Editor integrations (Sublime + VS Code)</li>
<li>Any “bring-your-own” optional deps used elsewhere (e.g., extraction/SDK/tooling)</li>
<li>“Fail vs degrade” posture for each optional capability (what is allowed to skip, and what must hard-fail).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Expand the existing <code>tools/release-check.js</code> from “changelog-only” into a <strong>deterministic release smoke-check runner</strong>.</li>
<li>Touchpoints:<ul>
<li><code>tools/release-check.js</code> (extend; keep it dependency-light)</li>
<li><code>bin/pairofcleats.js</code> (invoked by the smoke check; no behavioral changes expected here)</li>
</ul>
</li>
<li>Requirements:<ul>
<li>Must not depend on shell string concatenation; use spawn with args arrays.</li>
<li>Must set explicit <code>cwd</code> and avoid fragile <code>process.cwd()</code> assumptions (derive repo root from <code>import.meta.url</code> or accept <code>--repo-root</code>).</li>
<li>Must support bounded timeouts and produce actionable failures (which step failed, stdout/stderr excerpt).</li>
<li>Should support <code>--json</code> output with a stable envelope for CI automation (step list + pass/fail + durations).</li>
</ul>
</li>
<li>Smoke steps (minimum):<ul>
<li>Verify Node version compatibility (per the target matrix).</li>
<li>Run <code>pairofcleats --version</code>.</li>
<li>Run <code>pairofcleats index build</code> on a small fixture repo into a temp cacheRoot.</li>
<li>Run <code>pairofcleats index validate --strict</code> against the produced build.</li>
<li>Run a basic <code>pairofcleats search</code> against the build and assert non-empty or expected shape.</li>
<li>Verify editor integration assets exist when present:</li>
<li>Sublime: <code>sublime/PairOfCleats/**</code></li>
<li>VS Code: <code>extensions/vscode/**</code></li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add CI wiring for the smoke check.</li>
<li>Touchpoints:<ul>
<li><code>.github/workflows/ci.yml</code></li>
<li><code>package.json</code> scripts (optional, if CI should call a stable npm script)</li>
</ul>
</li>
<li>Requirements:<ul>
<li>Add a release-gate lane that runs <code>npm run release-check</code> plus the new smoke steps.</li>
<li>Add OS coverage beyond Linux (at minimum: Windows already exists; add macOS for the smoke check).</li>
<li>Align CI Node version(s) with the release target matrix, and ensure the matrix is explicitly documented.</li>
</ul>
</li>
</ul>
<h4 id="tests-verification_16">Tests / Verification<a class="headerlink" href="#tests-verification_16" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/release/release-check-smoke.test.js</code></li>
<li>Runs <code>node tools/release-check.js</code> in a temp environment and asserts it succeeds on a healthy checkout.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/release/release-check-json.test.js</code></li>
<li>Runs <code>release-check --json</code> and asserts stable JSON envelope fields (schemaVersion, steps[], status).</li>
<li class="task-list-item"><input type="checkbox" disabled/> CI verification:</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a job that runs the smoke check on at least Linux/macOS/Windows with pinned Node versions per the matrix.</li>
</ul>
<hr />
<h3 id="phase-202-cross-platform-path-safety-audit-regression-tests-including-spaces">Phase 20.2 — Cross-platform path safety audit + regression tests (including spaces)<a class="headerlink" href="#phase-202-cross-platform-path-safety-audit-regression-tests-including-spaces" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Audit filesystem path construction and CLI spawning for correctness on:</li>
<li>paths with spaces</li>
<li>Windows separators and drive roots</li>
<li>consistent repo-relative path normalization for public artifacts (canonical <code>/</code> separators)</li>
<li class="task-list-item"><input type="checkbox" disabled/> Fix issues discovered during the audit in the “release-critical surface”.</li>
<li>Minimum scope for this phase:<ul>
<li><code>tools/release-check.js</code> (must behave correctly on all supported OSes)</li>
<li>packaging scripts added in Phase 20.3/20.5</li>
<li>tests added by this phase (must be runnable on CI runners and locally)</li>
</ul>
</li>
<li>Broader issues discovered outside this scope should either:<ul>
<li>be fixed here if the touched files are already being modified, or</li>
<li>be explicitly deferred to a named follow-on phase (with a concrete subsection placeholder).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add regression tests for path safety and quoting.</li>
<li>Touchpoints:<ul>
<li><code>tests/platform/paths-with-spaces.test.js</code> (new)</li>
<li><code>tests/platform/windows-paths-smoke.test.js</code> (new; conditional when not on Windows)</li>
</ul>
</li>
<li>Requirements:<ul>
<li>Create a temp repo directory whose absolute path includes spaces.</li>
<li>Run build + validate + search using explicit <code>cwd</code> and temp cacheRoot.</li>
<li>Ensure the artifacts still store repo-relative paths with <code>/</code> separators.</li>
</ul>
</li>
</ul>
<h4 id="tests-verification_17">Tests / Verification<a class="headerlink" href="#tests-verification_17" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/platform/paths-with-spaces.test.js</code></li>
<li>Creates <code>repo with spaces/</code> under a temp dir; runs build + search; asserts success.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/platform/windows-paths-smoke.test.js</code></li>
<li>On Windows CI, verifies key commands succeed and produce valid outputs.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend <code>tools/release-check.js</code> to include a <code>--paths</code> step that runs the above regression checks in quick mode.</li>
</ul>
<hr />
<h3 id="phase-203-sublime-plugin-packaging-pipeline-bundled-reproducible">Phase 20.3 — Sublime plugin packaging pipeline (bundled, reproducible)<a class="headerlink" href="#phase-203-sublime-plugin-packaging-pipeline-bundled-reproducible" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Implement a reproducible packaging step for the Sublime plugin.</li>
<li>Touchpoints:<ul>
<li><code>sublime/PairOfCleats/**</code> (source)</li>
<li><code>tools/package-sublime.js</code> (new; Node-only)</li>
<li><code>package.json</code> scripts (optional: <code>npm run package:sublime</code>)</li>
</ul>
</li>
<li>Requirements:<ul>
<li>Package <code>sublime/PairOfCleats/</code> into a distributable artifact (<code>.sublime-package</code> zip or Package Control–compatible format).</li>
<li>Determinism requirements:</li>
<li>Stable file ordering in the archive.</li>
<li>Normalized timestamps/permissions where feasible.</li>
<li>Version-stamp the output using root <code>package.json</code> version.</li>
<li>Packaging must be Node-only (must not assume Python is present).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add installation and distribution documentation.</li>
<li>Touchpoints (choose one canonical location):<ul>
<li><code>docs/editor-integration.md</code> (add Sublime section), and/or</li>
<li><code>sublime/PairOfCleats/README.md</code> (distribution instructions)</li>
</ul>
</li>
<li>Include:<ul>
<li>Manual install steps and Package Control posture.</li>
<li>Compatibility notes (service-mode requirements, supported CLI flags, cacheRoot expectations).</li>
</ul>
</li>
</ul>
<h4 id="tests-verification_18">Tests / Verification<a class="headerlink" href="#tests-verification_18" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/sublime/package-structure.test.js</code></li>
<li>Runs the packaging script; asserts expected files exist in the output and that version metadata matches root <code>package.json</code>.</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/sublime/package-determinism.test.js</code> (if feasible)</li>
<li>Packages twice; asserts the archive is byte-identical (or semantically identical with a stable file list + checksums).</li>
</ul>
<hr />
<h3 id="phase-204-make-python-tests-and-tooling-optional-skip-cleanly-when-python-is-missing">Phase 20.4 — Make Python tests and tooling optional (skip cleanly when Python is missing)<a class="headerlink" href="#phase-204-make-python-tests-and-tooling-optional-skip-cleanly-when-python-is-missing" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Update Python-related tests to detect absence of Python and <strong>skip with a clear message</strong> (not fail).</li>
<li>Touchpoints:<ul>
<li><code>tests/sublime-pycompile.js</code> (must be guarded)</li>
<li><code>tests/sublime/test_*.py</code> (only if these are invoked by CI or tooling; otherwise keep as optional)</li>
</ul>
</li>
<li>Requirements:<ul>
<li>Prefer <code>spawnSync(python, ['--version'])</code> and treat ENOENT as “Python unavailable”.</li>
<li>When Python is unavailable:</li>
<li>print a single-line skip reason to stderr</li>
<li>exit using the project’s standard “skip” mechanism (see below)</li>
<li>When Python is available:</li>
<li>the test must still fail for real syntax errors (no silent skips).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled checked/> JS test harness recognizes “skipped” tests via exit code 77.</li>
<li>Touchpoints:<ul>
<li><code>tests/run.js</code> (treat a dedicated exit code, e.g. <code>77</code>, as <code>skipped</code>)</li>
</ul>
</li>
<li>Requirements:<ul>
<li><code>SKIP</code> must appear in console output (like PASS/FAIL).</li>
<li>JUnit output must mark skipped tests as skipped.</li>
<li>JSON output must include <code>status: 'skipped'</code>.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a small unit test that proves the “Python missing → skipped” path is wired correctly.</li>
<li>Touchpoints:<ul>
<li><code>tests/python/python-availability-skip.test.js</code> (new)</li>
</ul>
</li>
<li>Approach:<ul>
<li>mock or simulate ENOENT from spawnSync and assert the test exits with the “skip” code and emits the expected message.</li>
</ul>
</li>
</ul>
<h4 id="tests-verification_19">Tests / Verification<a class="headerlink" href="#tests-verification_19" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/sublime-pycompile.js</code></li>
<li>Verified behavior:<ul>
<li>Without Python: skips (non-failing) with a clear message.</li>
<li>With Python: compiles all <code>.py</code> files under <code>sublime/PairOfCleats/**</code> and fails on syntax errors.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/python/python-availability-skip.test.js</code></li>
<li>Asserts skip-path correctness and ensures we do not “skip on real failures”.</li>
</ul>
<hr />
<h3 id="phase-205-vs-code-extension-packaging-compatibility-extension-exists">Phase 20.5 — VS Code extension packaging + compatibility (extension exists)<a class="headerlink" href="#phase-205-vs-code-extension-packaging-compatibility-extension-exists" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Add a reproducible VS Code extension packaging pipeline (VSIX).</li>
<li>Touchpoints:<ul>
<li><code>extensions/vscode/**</code> (source)</li>
<li><code>package.json</code> scripts (new: <code>package:vscode</code>), and/or <code>tools/package-vscode.js</code> (new)</li>
</ul>
</li>
<li>Requirements:<ul>
<li>Use a pinned packaging toolchain (recommended: <code>@vscode/vsce</code> as a devDependency).</li>
<li>Output path must be deterministic and placed under a temp/artifacts directory suitable for CI.</li>
<li>Packaging must not depend on repo-root <code>process.cwd()</code> assumptions; set explicit cwd.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Ensure the extension consumes the <strong>public artifact surface</strong> via manifest discovery and respects user-configured <code>cacheRoot</code>.</li>
<li>Touchpoints:<ul>
<li><code>extensions/vscode/extension.js</code></li>
<li><code>extensions/vscode/package.json</code></li>
</ul>
</li>
<li>Requirements:<ul>
<li>No hard-coded internal cache paths; use configuration + CLI contracts.</li>
<li>Any default behaviors must be documented and overridable via settings.</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add a conditional CI gate for VSIX packaging.</li>
<li>If the VSIX toolchain is present, packaging must pass.</li>
<li>If the toolchain is intentionally absent in some environments, the test must skip (not fail) with an explicit message.</li>
</ul>
<h4 id="tests-verification_20">Tests / Verification<a class="headerlink" href="#tests-verification_20" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/vscode/extension-packaging.test.js</code></li>
<li>Packages a VSIX and asserts the output exists (skips if packaging toolchain is unavailable).</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend <code>tests/vscode-extension.js</code></li>
<li>Validate required activation events/commands and required configuration keys (and add any cacheRoot-related keys if the contract requires them).</li>
</ul>
<hr />
<h3 id="phase-206-service-mode-bundle-distribution-documentation-api-server-embedding-worker">Phase 20.6 — Service-mode bundle + distribution documentation (API server + embedding worker)<a class="headerlink" href="#phase-206-service-mode-bundle-distribution-documentation-api-server-embedding-worker" title="Permanent link"></a></h3>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> Ship a service-mode “bundle” (one-command entrypoint) and documentation.</li>
<li>Touchpoints:<ul>
<li><code>tools/api-server.js</code></li>
<li><code>tools/indexer-service.js</code></li>
<li><code>tools/service/**</code> (queue + worker)</li>
<li><code>docs/service-mode.md</code> (new) or a section in <code>docs/commands.md</code></li>
</ul>
</li>
<li>Requirements:<ul>
<li>Define canonical startup commands, required environment variables, and queue storage paths.</li>
<li>Document security posture and safe defaults:</li>
<li>local-only binding by default</li>
<li>explicit opt-in for public binding</li>
<li>guidance for auth/CORS if exposed</li>
<li>Ensure the bundle uses explicit args and deterministic logging conventions (stdout vs stderr).</li>
</ul>
</li>
<li class="task-list-item"><input type="checkbox" disabled/> Add an end-to-end smoke test for the service-mode bundle wiring.</li>
<li>Use stub embeddings or other deterministic modes where possible; do not require external services.</li>
</ul>
<h4 id="tests-verification_21">Tests / Verification<a class="headerlink" href="#tests-verification_21" title="Permanent link"></a></h4>
<ul class="task-list">
<li class="task-list-item"><input type="checkbox" disabled/> <code>tests/service/service-mode-smoke.test.js</code></li>
<li>Starts API server + worker in a temp environment; enqueues a small job; asserts it is processed and the API responds.</li>
<li class="task-list-item"><input type="checkbox" disabled/> Extend <code>tools/release-check.js</code> to optionally run a bounded-time service-mode smoke step (<code>--service-mode</code>).</li>
</ul>
<hr /></article></body></html>