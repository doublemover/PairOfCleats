From 2ec69cc3772402d5b6529a8e3081afab33ad3af4 Mon Sep 17 00:00:00 2001
From: AI <you@example.com>
Date: Fri, 16 Jan 2026 16:41:15 +0000
Subject: [PATCH] Fix tree-sitter crashes by avoiding default global preloading
 and enabling on-demand loading

---
 src/index/build/runtime/tree-sitter.js |  9 ++++++--
 src/lang/tree-sitter/chunking.js       | 19 +++++++++++----
 src/lang/tree-sitter/runtime.js        |  4 +---
 src/lang/workers/tree-sitter-worker.js | 32 +++++++++++++++++++++++---
 4 files changed, 51 insertions(+), 13 deletions(-)

diff --git a/src/index/build/runtime/tree-sitter.js b/src/index/build/runtime/tree-sitter.js
index 82b1c37..e5b099d 100644
--- a/src/index/build/runtime/tree-sitter.js
+++ b/src/index/build/runtime/tree-sitter.js
@@ -19,10 +19,14 @@ export const resolveTreeSitterRuntime = (indexingConfig) => {
     treeSitterConfig.byLanguage || {}
   );
   const treeSitterConfigChunking = treeSitterConfig.configChunking === true;
+  // Preloading many grammars can consume a lot of native/WASM memory.
+  // Default to *no* preloading unless explicitly requested via config.
   const treeSitterPreloadRaw = typeof treeSitterConfig.preload === 'string'
     ? treeSitterConfig.preload.trim().toLowerCase()
-    : (treeSitterConfig.preload === true ? 'parallel' : '');
-  const treeSitterPreload = treeSitterPreloadRaw === 'parallel' ? 'parallel' : 'serial';
+    : (treeSitterConfig.preload === true ? 'parallel' : 'none');
+  const treeSitterPreload = treeSitterPreloadRaw === 'parallel'
+    ? 'parallel'
+    : (treeSitterPreloadRaw === 'serial' ? 'serial' : 'none');
   const treeSitterPreloadConcurrency = normalizeOptionalLimit(
     treeSitterConfig.preloadConcurrency
   );
@@ -48,6 +52,7 @@ export const preloadTreeSitterRuntimeLanguages = async ({
   log
 }) => {
   if (!treeSitterEnabled) return;
+  if (treeSitterPreload === 'none') return;
   const enabledTreeSitterLanguages = resolveEnabledTreeSitterLanguages({
     enabled: treeSitterEnabled,
     languages: treeSitterLanguages
diff --git a/src/lang/tree-sitter/chunking.js b/src/lang/tree-sitter/chunking.js
index 2bc6209..080ddfd 100644
--- a/src/lang/tree-sitter/chunking.js
+++ b/src/lang/tree-sitter/chunking.js
@@ -8,7 +8,7 @@ import {
 } from './ast.js';
 import { LANG_CONFIG } from './config.js';
 import { isTreeSitterEnabled } from './options.js';
-import { getTreeSitterParser } from './runtime.js';
+import { getTreeSitterParser, preloadTreeSitterLanguages } from './runtime.js';
 import { treeSitterState } from './state.js';
 import { getTreeSitterWorkerPool, sanitizeTreeSitterOptions } from './worker.js';
 
@@ -342,18 +342,26 @@ export async function buildTreeSitterChunksAsync({ text, languageId, ext, option
   if (!options?.treeSitter || options.treeSitter.enabled === false) {
     return buildTreeSitterChunks({ text, languageId, ext, options });
   }
+
+  const resolvedId = resolveLanguageForExt(languageId, ext);
+  if (!resolvedId) return null;
+  if (!isTreeSitterEnabled(options, resolvedId)) return null;
+  if (exceedsTreeSitterLimits(text, options, resolvedId)) return null;
+
   const pool = await getTreeSitterWorkerPool(options?.treeSitter?.worker, options);
   if (!pool) {
-    return buildTreeSitterChunks({ text, languageId, ext, options });
+    // Runtime may be configured to skip global preloading; ensure the grammar for this language is loaded.
+    await preloadTreeSitterLanguages([resolvedId], { log: options?.log });
+    return buildTreeSitterChunks({ text, languageId: resolvedId, ext, options });
   }
-  const resolvedId = resolveLanguageForExt(languageId, ext) || languageId || 'unknown';
+
   const metricsCollector = options?.metricsCollector;
   const shouldRecordMetrics = metricsCollector && typeof metricsCollector.add === 'function';
   const lineCount = shouldRecordMetrics ? countLines(text) : 0;
   const metricsStart = shouldRecordMetrics ? Date.now() : 0;
   const payload = {
     text,
-    languageId,
+    languageId: resolvedId,
     ext,
     treeSitter: sanitizeTreeSitterOptions(options?.treeSitter)
   };
@@ -365,7 +373,8 @@ export async function buildTreeSitterChunksAsync({ text, languageId, ext, option
       options.log(`[tree-sitter] Worker parse failed; falling back to main thread (${err?.message || err}).`);
       treeSitterState.loggedWorkerFailures.add('run');
     }
-    return buildTreeSitterChunks({ text, languageId, ext, options });
+    await preloadTreeSitterLanguages([resolvedId], { log: options?.log });
+    return buildTreeSitterChunks({ text, languageId: resolvedId, ext, options });
   } finally {
     if (shouldRecordMetrics) {
       const durationMs = Date.now() - metricsStart;
diff --git a/src/lang/tree-sitter/runtime.js b/src/lang/tree-sitter/runtime.js
index d7c97b4..e5d5dd4 100644
--- a/src/lang/tree-sitter/runtime.js
+++ b/src/lang/tree-sitter/runtime.js
@@ -1,4 +1,3 @@
-import fs from 'node:fs/promises';
 import os from 'node:os';
 import path from 'node:path';
 import { createRequire } from 'node:module';
@@ -105,8 +104,7 @@ async function loadWasmLanguage(languageId, options = {}) {
     }
     try {
       const wasmPath = path.join(resolveWasmRoot(), wasmFile);
-      const wasmBytes = await fs.readFile(wasmPath);
-      const language = await treeSitterState.TreeSitterLanguage.load(wasmBytes);
+      const language = await treeSitterState.TreeSitterLanguage.load(wasmPath);
       const entry = { language, error: null };
       treeSitterState.languageCache.set(resolvedId, entry);
       return entry;
diff --git a/src/lang/workers/tree-sitter-worker.js b/src/lang/workers/tree-sitter-worker.js
index 0382cc4..f3b6d31 100644
--- a/src/lang/workers/tree-sitter-worker.js
+++ b/src/lang/workers/tree-sitter-worker.js
@@ -1,11 +1,37 @@
-import { buildTreeSitterChunks } from '../tree-sitter.js';
+import { buildTreeSitterChunks, preloadTreeSitterLanguages } from '../tree-sitter.js';
 
-export function parseTreeSitter(payload = {}) {
+function resolveLanguageForExt(languageId, ext) {
+  const normalizedExt = typeof ext === 'string' ? ext.toLowerCase() : '';
+  if (normalizedExt === '.tsx') return 'tsx';
+  if (normalizedExt === '.jsx') return 'jsx';
+  if (normalizedExt === '.ts' || normalizedExt === '.cts' || normalizedExt === '.mts') return 'typescript';
+  if (normalizedExt === '.js' || normalizedExt === '.mjs' || normalizedExt === '.cjs' || normalizedExt === '.jsm') {
+    return 'javascript';
+  }
+  if (normalizedExt === '.py') return 'python';
+  if (normalizedExt === '.json') return 'json';
+  if (normalizedExt === '.yaml' || normalizedExt === '.yml') return 'yaml';
+  if (normalizedExt === '.toml') return 'toml';
+  if (normalizedExt === '.md' || normalizedExt === '.mdx') return 'markdown';
+  if (languageId) return languageId;
+  if (!normalizedExt) return null;
+  if (normalizedExt === '.m' || normalizedExt === '.mm') return 'objc';
+  if (normalizedExt === '.cpp' || normalizedExt === '.cc' || normalizedExt === '.cxx'
+    || normalizedExt === '.hpp' || normalizedExt === '.hh') return 'cpp';
+  if (normalizedExt === '.c' || normalizedExt === '.h') return 'clike';
+  return null;
+}
+
+export async function parseTreeSitter(payload = {}) {
   const { text = '', languageId = null, ext = null, treeSitter = null } = payload;
   try {
+    const resolvedId = resolveLanguageForExt(languageId, ext);
+    if (resolvedId) {
+      await preloadTreeSitterLanguages([resolvedId]);
+    }
     return buildTreeSitterChunks({
       text,
-      languageId,
+      languageId: resolvedId || languageId,
       ext,
       options: { treeSitter }
     });
-- 
2.39.5

