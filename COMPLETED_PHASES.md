# Completed Phases

Any time a phase is fully completed, AFTER it has been merged into main:
  - The numbering and ordering of phases does not matter whatsoever
  - Remove the phase from the current roadmap
  - Append the Title and a brief, single item summary 
  - Some phase numbers are reused 
  - Nothing in this document should be treated as authoritative, refer to code for truth

Completed phase snapshots are archived here after being removed from GIGAROADMAP.md. 

---

- Phase R -- Make Monoliths Modular, My Man

## Phase R -- Refactor MegaCut

---

### R.0 Refactor playbook (applies to every subtask)

**Goal:** Split “fat” modules into cohesive, testable, side-effect-minimized modules **without changing behavior**.

**Hard rules**
- **No behavior changes** unless explicitly called out in the task’s “Behavior deltas” section.
- **Preserve public entrypoints.** If you move code, keep a tiny compatibility shim at the old path that re-exports the same names.
- **Keep ESM import style** (repo is `"type": "module"`; keep `.js` extensions on relative imports).
- **No new global state**; prefer pure helpers and dependency injection (pass `log`, `signal`, configs, caches).
- **Avoid circular imports** by extracting shared primitives to `src/shared/**` and keeping “leaf” modules free of imports from high-level orchestrators.

**PR checklist**
- [x] New modules have a single responsibility and minimal export surface.
- [x] All call sites updated (or compatibility re-export added).
- [x] All relevant tests pass:
  - `node tests/run.js --lane pr` (preferred) or `npm run test:pr`
  - plus any targeted tests called out per task.
- [x] `npm run lint` passes.
- [x] File sizes: prefer < ~500 LOC for “leaf” modules; orchestrators may be larger but should be mostly glue.

---

### R.1 Script surface policy + docs (package.json sprawl)

**Spec conflict (resolved):** The original Phase R.1 demanded `package.json` scripts be reduced to <10.  
The current repo has already adopted a **policy-based approach** instead:
- `tools/docs/script-inventory.js` generates `docs/tooling/script-inventory.json` and `docs/guides/commands.md`.
- `tests/indexing/policy/script-surface-policy.test.js` enforces that the inventory matches `package.json`.

This is a better trade-off than “<10 scripts” because:
- Many scripts are intentionally “debuggable entrypoints” for specific tests/tools.
- The repo has explicit policy + inventory tooling already; rewriting the entire script surface would be noisy and high-churn.

#### R.1.1 Script inventory + policy enforcement
- [x] Keep `tools/docs/script-inventory.js` as the single generator for:
  - `docs/tooling/script-inventory.json`
  - `docs/guides/commands.md`
- [x] Keep `tests/indexing/policy/script-surface-policy.test.js` enforcing inventory ↔ package parity.

**Callouts**
- Generator: `tools/docs/script-inventory.js`
- Inventory: `docs/tooling/script-inventory.json`
- Policy test: `tests/indexing/policy/script-surface-policy.test.js`

#### R.1.2 Fix doc drift: commands.md must be reproducible
- [x] Resolve the current mismatch where `docs/guides/commands.md` contains a “Phase 3 specs” section that **is not emitted** by `tools/docs/script-inventory.js`.
  - **Best choice:** make `commands.md` purely generated; either:
    1) Update generator to also emit a “Phase specs” section (recommended), or  
    2) Remove the non-generated section from `commands.md` and move it to a separate doc (less ideal; increases doc surface).
- [x] Add a policy test to prevent future drift:
  - New test file: `tests/indexing/policy/script-inventory-docs.test.js`
  - It should run the generator in-memory and compare against `docs/guides/commands.md` OR at minimum assert:
    - the “generated by” header is present
    - the “Stable entrypoints” block matches the generator’s output
    - the script table contains the same script names as inventory

**Why option (1) is recommended:**  
The repo already treats `commands.md` as generated. Making the generator responsible for *all* its sections is the only way to keep it deterministic and enforceable.

#### R.1.3 Tighten the “stable entrypoints” contract
- [x] Document (and keep stable) the following script entrypoints:
  - `test`, `test:pr`, `test:nightly`, `lint`, `format`, `config:budget`, `env:check`, `verify`
- [x] Update any user-facing docs / error messages that reference non-stable scripts to prefer:
  - `pairofcleats ...` CLI entrypoints (preferred for users)
  - or `node <script>` for internal tools
- [x] Add a lightweight test that fails if “stable entrypoints” are removed/renamed without updating docs/tooling/script-inventory.json.

---

### R.2 Repo hygiene + drift-proofing

#### R.2.1 AGENTS.md coverage
- [x] Ensure `AGENTS.md` lists the primary docs to read and how to run tests/lint.
- [x] Add an explicit pointer to the script policy docs:
  - `docs/tooling/script-inventory.json`
  - `docs/guides/commands.md`
  - The enforcement test: `tests/indexing/policy/script-surface-policy.test.js`

#### R.2.2 Drift-proofing for docs ↔ code contracts
- [x] Keep the existing “policy tests” approach (see `tests/policy/**`) for anything that otherwise drifts silently.

#### R.2.3 Optional: sweep stale files (low-risk cleanup)
- [x] Add a non-destructive report script (no deletions) that inventories:
  - orphan docs (not referenced by any “Docs to read” list)
  - orphan tools (not referenced by any script/CLI)
  - orphan scripts (not referenced by docs/CI/tests)
- Suggested location: `tools/docs/repo-inventory.js`
- Output: `docs/tooling/repo-inventory.json`
- [x] Add a policy test that only checks the file exists + JSON schema sanity (don’t gate PRs on the contents yet).

---

### R.3 Shared primitives (extract early, reuse everywhere)

These have landed and should be used as the canonical helpers.

#### R.3.1 Backoff/retry helper
- [x] `src/shared/retry.js` exports `retryWithBackoff({ attempts, minDelayMs, maxDelayMs, factor, jitter, shouldRetry, operation, signal })`
- [x] Used by `src/index/build/watch/lock.js` to implement `acquireIndexLockWithBackoff(...)`.
- Tests (existing): `tests/indexing/watch/watch-lock-backoff.test.js`

**Follow-up**
- [x] Add a small direct unit test for `retryWithBackoff` itself (optional but improves locality):
  - New: `tests/shared/concurrency/retry-with-backoff.test.js`
  - Cover: abort signal, shouldRetry false, jitter bounds, attempts=1 behavior.

#### R.3.2 Debounce scheduler
- [x] `src/shared/scheduler/debounce.js` exports `createDebouncedScheduler({ delayMs, maxDelayMs, onFlush })`
- [x] Used by watch pipeline (via `src/index/build/watch.js`).
- Tests (existing): `tests/indexing/watch/watch-debounce.test.js`

#### R.3.3 Ignore matcher helper (path + chokidar semantics)
- [x] `src/shared/fs/ignore.js` exports `buildIgnoredMatcher({ root, ignoreMatcher })` for chokidar-compatible ignores.
- [x] Add a dedicated test for “directory ignore vs file ignore” semantics:
  - New: `tests/indexing/ignore/ignore-matcher.test.js`
  - Cases:
    - ignoreMatcher matches a directory: should ignore descendants (simulate `stats.isDirectory()` true)
    - ignoreMatcher matches a file path: should ignore only that path
    - Windows path normalization (`\` → `/`) must not break matching
  - Import the helper directly from `src/shared/fs/ignore.js`.

#### R.3.4 Filter list merge helper
- [x] `src/shared/filter/merge.js` exports `mergeFilterLists(a, b)`
- [x] Used by `src/retrieval/filters.js` (`mergeExtFilters`, `mergeLangFilters`) and tested via:
  - `tests/retrieval/filters/lang-filter.test.js`

---

### R.4 Core indexing + build pipeline refactors

#### R.4.1 Watch pipeline split
- [x] `src/index/build/watch.js` is now an orchestrator that delegates to:
  - `src/index/build/watch/args.js` (args normalization)
  - `src/index/build/watch/chokidar-backend.js` / `polling-backend.js`
  - `src/index/build/watch/watch-event-queue.js`
  - `src/index/build/watch/stability.js` (stability guard)
  - `src/index/build/watch/lock.js` (index lock + backoff)
  - `src/index/build/watch/rebuild.js` (rebuild trigger)
- Tests (existing):
  - `tests/indexing/watch/watch-backend-selection.test.js`
  - `tests/indexing/watch/watch-debounce.test.js`
  - `tests/indexing/watch/watch-lock-backoff.test.js`
  - `tests/indexing/watch/watch-stability-guard.test.js`
  - (plus several watch E2E/atomicity tests)

**Remaining (optional)**
- [x] If `watch.js` grows again, prefer extracting additional “pure helpers” to `src/index/build/watch/*.js` rather than re-introducing large inline blocks. Note this in the docs for watch/build

#### R.4.2 Integrations/core split (spec drift fix)

**Spec drift:** The old roadmap targeted `src/integrations/core/index.js` as a 700+ LOC monolith.  
In the current codebase, `src/integrations/core/index.js` is a tiny re-export facade, and the largest module is now:

- **Current monolith target:** `src/integrations/core/build-index.js` (~735 LOC)

##### R.4.2.1 Keep the facade pattern
- [x] `src/integrations/core/index.js` should remain a small re-export surface for:
  - `buildIndex`, `buildSqliteIndex` (from `build-index.js`)
  - `search` (from `search.js`)
  - `status` (from `status.js`)
- [x] Other integration helpers already live in `src/integrations/core/*.js`

##### R.4.2.2 Split build-index integration logic
- [x] Refactor `src/integrations/core/build-index.js` into a folder:
  - `src/integrations/core/build-index/index.js` (orchestrator; exports `buildIndex`, `buildSqliteIndex`)
  - `src/integrations/core/build-index/progress.js` (overall progress aggregation; current inline “overallProgress” logic)
  - `src/integrations/core/build-index/compatibility.js` (compat key computation)
  - `src/integrations/core/build-index/runtime.js` (runtime bootstrap/teardown helpers)
  - `src/integrations/core/build-index/stages.js` (stage1/stage2 planning + dispatch)
  - `src/integrations/core/build-index/sqlite.js` (the `buildSqliteIndex` implementation)

**Compatibility requirements**
- Keep exports stable from `src/integrations/core/index.js`.
- Keep the existing `buildIndex(repoRoot, options)` and `buildSqliteIndex(repoRoot, options)` signatures intact.

**Callers**
- `bin/pairofcleats.js` (via integration layer)
- `tools/mcp/tools.js` uses `coreBuildIndex` / `coreBuildSqliteIndex`
- Tests that invoke `build_index.js` script (various E2E tests)

**Tests to run**
- `node tests/run.js --match build-index --match index-lock --match watch-atomicity` (minimum)
- `node tests/run.js --lane pr` (recommended)

#### R.4.3 Runtime refactor
- [x] Runtime has been split into:
  - `src/index/build/runtime/config.js`, `policy.js`, `stage.js`, `workers.js`, `hash.js`, etc.
- [x] `src/index/build/runtime/runtime.js` remains large (~680 LOC) but is primarily orchestrator + normalization.

**Optional follow-up**
- [x] Extract “option normalization” helpers from `runtime.js` into `runtime/normalize.js` if `runtime.js` continues to grow.
- [x] Add a unit test for “caps/policy merges” if regressions occu.

#### R.4.4 Validate split
- [x] `src/index/validate.js` delegates to `src/index/validate/*` modules (`manifest`, `sqlite`, `lmdb`, etc.)
- Tests (existing): search for `validate` lane/scripts in `tests/script-coverage` actions.

#### R.4.5 Artifacts build split
- [x] `src/index/build/artifacts.js` delegates into `src/index/build/artifacts/*` (filter-index, postings, bundles, etc.)
- Ensure any new artifact type also updates:
  - `docs/contracts/artifact-contract.md`
  - `src/contracts/schemas/artifacts.js` (if schema is used)
  - relevant validation in `src/index/validate/*`

#### R.4.6 Worker pool split
- [x] Worker pool logic is now under `src/index/build/workers/*`
- `src/index/build/worker-pool.js` is a facade.

#### R.4.7 File processor split (CPU + chunk processing)

**Current state**
- [x] `src/index/build/file-processor/cpu.js` is ~586 LOC and already delegates chunking to:
  - `src/index/build/file-processor/cpu/chunking.js`
- **New monolith candidate:** `src/index/build/file-processor/process-chunks.js` (~650 LOC)

**Plan**
- [x] Keep `cpu.js` as the “single-file CPU orchestration” entrypoint (export `processFileCpu(...)`), but extract:
  - tokenization setup / caching → `cpu/tokenizer.js`
  - AST/tree-sitter analysis pass wrappers → `cpu/analyze.js`
  - metadata v2 enrichment steps → `cpu/meta.js`
  - keep `cpu/chunking.js` as-is

- [x] Split `process-chunks.js` into:
  - `file-processor/process-chunks/index.js` (orchestrator)
  - `file-processor/process-chunks/enrichment.js` (enrich + merge docmeta)
  - `file-processor/process-chunks/dedupe.js` (dedupe + normalization)
  - `file-processor/process-chunks/limits.js` (chunk limits + truncation policy)
  - `file-processor/process-chunks/ids.js` (chunk id assignment + stability rules)

**Callers**
- `src/index/build/indexer/steps/process-files.js`
- any tests building indexes (`tests/smoke/e2e-smoke.test.js`, etc.)

**Tests to run**
- `node tests/run.js --match segment-pipeline --match chunking-limits --match metadata-v2`
- plus at least one full index build smoke (`tests/smoke/e2e-smoke.test.js` or `tests/cli/build-index/build-index-all.test.js` if present)

#### R.4.8 Piece assembly split
- [x] `src/index/build/piece-assembly.js` is still ~500 LOC; helpers exist at `src/index/build/piece-assembly/helpers.js`.

**Remaining extraction (recommended)**
- [x] Extract the IO-heavy loader to `src/index/build/piece-assembly/load.js`
  - Move `loadIndexArtifacts(...)` and any “find pieces / read manifest / read artifacts” logic.
- [x] Extract merge logic to `src/index/build/piece-assembly/merge.js`
  - “merge postings / merge bundles / merge filter index / merge relations” helpers
- [x] Keep `assembleIndexPieces(...)` in `piece-assembly.js` as orchestrator (or move to `piece-assembly/index.js` with a facade).

**Callers**
- `tools/index/assemble-pieces.js` (CLI tool)
- `tests/indexing/contracts/index-compatibility-key-federation-block.test.js`

**Tests to run**
- `node tests/run.js --match compact-pieces --match index-compatibility-key-federation-block`

---

### R.5 Retrieval refactors

#### R.5.1 `filterChunks` split (`src/retrieval/output/filters.js`)

**Current state**
- [x] `src/retrieval/output/filters.js` now delegates to `src/retrieval/output/filters/*` helpers; `filterChunks` remains the orchestrator.
- [x] Candidate selection helpers already extracted:
  - `src/retrieval/output/filters/candidates.js` exports `createCandidateHelpers(...)`
- The file implements:
  - meta filters (`meta.*`, risk fields, etc.)
  - structural filters (`structPack`, `structRule`, `structTag`)
  - file/path/ext/lang prefiltering using `filterIndex` chargrams + roaring bitmaps
  - relation filters (`uses`, `imports`, `calls`) via `fileRelations`

**Specs to follow**
- File prefilter semantics: `docs/guides/search.md` (“File Filter Prefilter (Substring/Regex)”)
- Search filter contract: `docs/contracts/search-contract.md` + `docs/contracts/search-cli.md`
- Structural filter doc: `docs/guides/structural-search.md`

**Public entrypoint**
- Keep: `export function filterChunks(meta, filters = {}, filterIndex = null, fileRelations = null)`

**Callers**
- `src/retrieval/output.js` re-exports it
- `src/retrieval/pipeline.js` calls it
- Many tests import from `src/retrieval/output.js`

**Refactor plan (safe + incremental)**
- [x] **Step 1: fix formatting drift** in `filters.js` (indentation currently broken in destructuring blocks).
- [x] **Step 2: extract pure predicates** to `src/retrieval/output/filters/predicates.js`
  - `matchList`, `matchAny`, `truthy`, and any “normalize list” helpers.
- [x] **Step 3: extract structural matching** to `src/retrieval/output/filters/structural.js`
  - `matchStructural(chunk, { structPack, structRule, structTag })`
  - Must match semantics verified by `tests/tooling/structural/structural-filters.test.js`.
- [x] **Step 4: extract meta matching** to `src/retrieval/output/filters/meta.js`
  - `matchMetaFilters(chunk, metaFilters, riskFilters, options)`
  - Preserve support for:
    - `meta` (k/v string or regex) and `caseMeta`
    - risk selectors: `risk`, `riskTag`, `riskCategory`, `riskSource`, `riskSink`, `riskFlow`
    - inferred types: `inferredType`, `returnType`, `param`
- [x] **Step 5: extract file/path filter evaluation** to `src/retrieval/output/filters/file.js`
  - Build final exact predicate for:
    - `file`/`caseFile` (substring or regex; supports list)
    - `ext`, `lang`
  - Keep **final exact match** always enforced even when prefilter narrows candidates.
- [x] **Step 6: extract file prefilter (chargram/roaring)** to `src/retrieval/output/filters/file-prefilter.js`
  - `collectFilePrefilterMatches({ filterIndex, fileMatchers, caseFile, fileChargramN, roaring })`
  - Must implement doc semantics:
    - longest stable literal from regex; skip if none
    - case-insensitive prefilter; exact match still checks case when `caseFile` is true
- [x] **Step 7: keep filterChunks orchestrator** in `filters.js` (or move to `filters/index.js` and re-export from `filters.js`)
  - It should:
    - normalize filters once
    - construct candidate sets using `createCandidateHelpers`
    - loop candidates and apply exact predicates
    - handle `fileRelations` expansion for `uses/imports/calls` filters

**Tests to run (existing, must pass unchanged)**
- `tests/retrieval/filters/filter-index.test.js`
- `tests/retrieval/filters/filter-strictness.test.js`
- `tests/filter-structural.js` / `tests/tooling/structural/structural-filters.test.js`
- `tests/file-case-sensitive.js`
- `tests/filters-file.js`
- `tests/retrieval/filters/lang-filter.test.js`

*(Search for additional filter tests in `/tests` prefixed with `filter-` and run them too.)*

#### R.5.2 Search CLI split (`src/retrieval/cli.js`)
- [x] `runSearchCli(...)` now delegates inline helpers and run-config normalization to `src/retrieval/cli/*`; `cli.js` is orchestration glue.

**Refactor goal**
- Keep `runSearchCli(...)` export stable (callers: `src/integrations/core/search.js`).
- Reduce `cli.js` to “parse → normalize → run session → render/persist” glue.

**Plan**
- [x] Extract inline helpers inside `runSearchCli` to `src/retrieval/cli/runner.js`:
  - `inferJsonOutputFromArgs`
  - `emitError` / `bail`
  - `throwIfAborted`
- [x] Extract the giant `normalized` destructuring + derived flags into:
  - `src/retrieval/cli/resolve-run-config.js`
  - Return a single `runConfig` object (typed by convention / JSDoc) consumed by `runSearchSession`.
- [x] Keep `src/retrieval/cli.js` as the orchestrator that wires modules together.

**Tests to run**
- `node tests/run.js --match search-cli --match sqlite-fts-eligibility --match search-symbol-boost`

#### R.5.3 Language registry split
- [x] `src/index/language-registry/registry.js` is now small; data lives in `registry-data.js`.
- Ensure any future registry edits update:
  - `src/index/language-registry/registry-data.js`
  - tests that validate language ids / aliases (search for `language-registry` in tests)

#### R.5.4 Search pipeline split (`src/retrieval/pipeline.js`)

**Current state**
- [x] `src/retrieval/pipeline.js` now delegates query-AST, ANN backend normalization, and fusion helpers to `src/retrieval/pipeline/*`.
- `src/retrieval/pipeline.js` still mixes:
  - query-AST phrase checks
  - backend selection (ANN, sqlite FTS, etc.)
  - scoring logic (RRF, blend, symbol boosts, phrase boosts)
  - context-expansion

**Specs to follow**
- `docs/contracts/search-contract.md`
- `docs/guides/search.md`
- `docs/contracts/search-cli.md`

**Public entrypoint**
- Keep: `export function createSearchPipeline(context = {})`

**Callers**
- `src/retrieval/cli/run-search-session.js`
- tests: `tests/cli/search/search-symbol-boost.test.js`, `tests/retrieval/backend/sqlite-fts-eligibility.test.js`, and others

**Refactor plan**
- [x] Extract query-AST helpers to `src/retrieval/pipeline/query-ast.js`
  - move `matchesQueryAst(...)`
  - move `getPhraseMatchInfo(...)`
  - keep the exact signatures to avoid churn
- [x] Extract ANN backend normalization to `src/retrieval/pipeline/ann-backends.js`
  - move `normalizeAnnBackend(...)`, `resolveAnnOrder(...)`
- [x] Extract score fusion to `src/retrieval/pipeline/fusion.js`
  - a pure function that takes ranked sparse list, ranked dense list, config → fused list + breakdowns
  - keep existing behavior: default RRF, optional normalized blending via `search.scoreBlend.*`
- [x] Keep `pipeline.js` as orchestrator:
  - loads providers (BM25, sqlite fts, ann, minhash)
  - delegates to extracted helpers
  - keeps `createSearchPipeline` signature stable

**Tests to run**
- `tests/cli/search/search-symbol-boost.test.js`
- `tests/retrieval/backend/sqlite-fts-eligibility.test.js`
- `tests/search-rrf-parity.js` (if present)
- `tests/search-explain-schema.js` (if present)
- plus `node tests/run.js --lane pr`

#### R.5.5 JSON stream split
- [x] `src/shared/json-stream.js` is a facade over `src/shared/json-stream/*`

#### R.5.6 Filter merge module
- [x] `src/retrieval/filters.js` uses `src/shared/filter/merge.js`

---

### R.6 Tooling & services refactors

#### R.6.1 MCP tool dispatcher split (`tools/mcp/tools.js`)

**Current state**
- [x] `tools/mcp/tools.js` now delegates to `tools/mcp/tools/handlers/*` with a handler map.
- Helpers already extracted to: `tools/mcp/tools/helpers.js`

**Specs to follow**
- Tool defs + schemas are the source of truth:
  - `src/integrations/mcp/defs.js`
- Tests that enforce handler coverage:
  - `tests/services/mcp/tools-registry.test.js`
  - `tests/services/mcp/tools-normalize-meta.test.js`

**Public entrypoints (must remain exported)**
- `buildIndex`
- `runSearch`
- `downloadModels`, `downloadDictionaries`, `downloadExtensions`, `verifyExtensions`
- `buildSqliteIndex`, `compactSqliteIndex`
- `cacheGc`, `cleanArtifacts`, `runBootstrap`, `reportArtifacts`
- `triageIngest`, `triageDecision`, `triageContextPack`
- `handleToolCall`
- `normalizeMetaFilters` (re-export)

**Refactor plan**
- [x] Create folder: `tools/mcp/tools/handlers/`
  - `index-status.js` → `indexStatus`, `configStatus` (or keep in `tools/mcp/repo.js` if already there)
  - `indexing.js` → `buildIndex`, `buildSqliteIndex`, `compactSqliteIndex`
  - `search.js` → `runSearch`
  - `downloads.js` → `downloadModels`, `downloadDictionaries`, `downloadExtensions`, `verifyExtensions`
  - `artifacts.js` → `cleanArtifacts`, `reportArtifacts`, `cacheGc`
  - `bootstrap.js` → `runBootstrap`
  - `triage.js` → `triageIngest`, `triageDecision`, `triageContextPack`
- [x] Replace the `handleToolCall` switch with a map:
  - `const TOOL_HANDLERS = new Map([ ['search', runSearch], ... ])`
  - `handleToolCall(name, args, ctx)` looks up handler and throws unknown tool error if missing.
- [x] Update `tests/services/mcp/tools-registry.test.js` accordingly:
  - Instead of parsing switch cases, assert:
    - every tool name in `getToolDefs({ ... })` has a handler in the map
    - no extra handlers exist for undefined tools

**Compatibility requirements**
- Preserve handler behavior (progress callbacks, env resolution, JSON parsing errors).
- Keep error messages stable enough for tests (if tests assert substrings, keep them).

#### R.6.2 API router split
- [x] `tools/api/router.js` already delegates to `tools/api/router/*`

#### R.6.3 build-embeddings split
- [x] `tools/build/embeddings/run.js` delegates to `tools/build/embeddings/*`

#### R.6.4 build-sqlite-index split
- [x] `tools/build/sqlite/run.js` delegates to `tools/build/sqlite/*`

#### R.6.5 config-inventory split
- [x] `tools/config/inventory.js` delegates to `tools/config/inventory/*`

#### R.6.6 dict-utils split
- [x] `tools/shared/dict-utils.js` is the public facade; internal helpers live in `tools/dict-utils/*`

---

### R.7 UI refactors

#### R.7.1 Map isometric edge assembly split (`src/map/isometric/client/edges.js`)

**Current state**
- [x] `edges.js` now delegates to `edges/aggregate.js`, `edges/endpoints.js`, `edges/style.js` plus existing helpers.
  - `src/map/isometric/client/edges/resolvers.js` (`createEdgeResolvers`)
  - `src/map/isometric/client/edges/routing.js` (`createRoutingHelpers`)
- Remaining in `edges.js`: aggregation + rendering shape logic.

**Public entrypoint**
- Keep: `export function buildEdges({...})`

**Refactor plan**
- [x] Extract edge aggregation to `src/map/isometric/client/edges/aggregate.js`
  - logic that builds per-edge segments + dedupes
- [x] Extract “endpoint dots” to `src/map/isometric/client/edges/endpoints.js`
- [x] Extract styling/resolution to `src/map/isometric/client/edges/style.js`
  - color/opacity decisions based on selection, hover, depth, etc.
- [x] Keep `edges.js` as orchestrator that wires:
  - resolvers + routing + aggregation + endpoints + style

**Tests (missing today)**
- [x] Add a small unit test suite under `tests/indexing/map/edges.test.js`:
  - route helper produces deterministic paths given fixed nodes
  - edge resolver consistently assigns inbound/outbound per node orientation
  - aggregation is stable (same input → same output ordering)

---

### R.8 Post-refactor follow-ups

- [x] Update `docs/guides/architecture.md` if module boundaries materially change (filters/pipeline/tools).
- [x] Update `docs/guides/commands.md` and `docs/tooling/script-inventory.json` if any script entrypoints changed.

---

### R.9 Current monolith snapshot (2026-01-30)

Top refactor candidates by size/complexity (non-generated, behavior-heavy):
1. `src/integrations/core/build-index.js` (~735 LOC) → split per **R.4.2.2**
2. `src/retrieval/cli.js` (~719 LOC) → reduce glue per **R.5.2**
3. `src/index/build/watch.js` (~703 LOC, but already modular) → optional further extraction
4. `src/index/build/runtime/runtime.js` (~683 LOC, mostly orchestrator) → optional normalize split
5. `src/index/build/file-processor/process-chunks.js` (~650 LOC) → split per **R.4.7**
6. `tools/mcp/tools.js` (~650 LOC) → split per **R.6.1**
7. `src/retrieval/pipeline.js` (~638 LOC) → split per **R.5.4**
8. `src/retrieval/output/filters.js` (~570 LOC) → split per **R.5.1**
9. `src/index/build/piece-assembly.js` (~500 LOC) → split per **R.4.8**
10. `src/map/isometric/client/edges.js` (~500 LOC) → split per **R.7.1**

---


## Phase 6 -- Finalization

> **Important:** A meaningful portion of this phase may already be implemented in this repo.  
> Before writing new code, **audit the referenced files/tests** and only add/modify what’s missing or incorrect.

### Goals

1. **Determinism & portability:** VFS virtual paths and “call_sites” output must be stable across runs/OSes.
2. **Artifact correctness:** VFS manifest and metaV2 must be correct, schema-valid, and consistent with post-processing.
3. **Noise reduction:** Improve call/usage heuristics and tokenization so keyword noise is controlled without losing queryability.
4. **CI completeness:** CI lanes must always run schema/validator coverage; long tests must be runnable in a dedicated lane.

---

## 6.0 Audit checklist (do this first)

- [x] Confirm these Phase 6 tests already exist and are green:
  - `tests/indexing/vfs/virtual-path-stability.test.js`
  - `tests/indexing/vfs/vfs-manifest-roundtrip.test.js`
  - `tests/indexer/call-sites/call-sites-determinism.test.js`
  - `tests/indexer/metav2/metav2-recompute-equivalence.test.js`
- [x] Confirm VFS manifest is actually produced during an index build:
  - Collection: `src/index/build/file-processor/process-chunks.js` → `buildVfsManifestRowsForFile()`
  - State aggregation: `src/index/build/indexer/steps/process-files.js` → `state.vfsManifestRows`
  - Emission: `src/index/build/artifacts/writers/vfs-manifest.js` → `enqueueVfsManifestArtifacts()`
  - Manifest wiring: `src/index/build/artifacts.js` adds piece `vfs_manifest`
- [x] Confirm metaV2 finalization happens *after* any mutation steps:
  - Cross-file inference: `src/index/build/indexer/steps/relations.js` → `runCrossFileInference()` mutates `chunk.docmeta` / `chunk.codeRelations`
  - Finalization: `src/index/build/indexer/steps/write.js` → `finalizeMetaV2({ chunks })` **before** writing artifacts
- [x] Confirm GitHub Actions PR CI runs `ci-lite` (and thus includes contracts + validate coverage):
  - Workflow: `.github/workflows/ci.yml`
  - Test command: `npm run test:ci-lite`
  - Source of truth list: `tests/ci-lite/ci-lite.order.txt`

If any item above is missing, fix it as part of Phase 6 (details below).

---

## 6.1 VFS hardening: stable virtual paths + manifest roundtrip

### 6.1.1 VFS Virtual Path specification (source of truth)

**Primary implementation:** `src/index/tooling/vfs.js`

- `VFS_PREFIX` is `".poc-vfs"`.
- `buildVfsVirtualPath({ containerPath, segmentUid, ext, effectiveExt })` must be:
  - **Pure & deterministic** (same inputs → same output across runs/OS).
  - **Path-safe for LSP/tooling** (no OS separators except `/`).
  - **Stable across host paths**: uses `normalizeRelPath()` and `encodeContainerPath()`:
    - `encodeContainerPath()` percent-encodes reserved characters (`#`, `%`) in the normalized relative path.
    - `decodeContainerPath()` reverses it.
  - **Segment addressing is explicit**:
    - If `segmentUid` is present: suffix is `"#seg:<segmentUid>"`.
    - Otherwise, no segment suffix.
  - **Extension selection rules**:
    - `effectiveExt` (if non-empty) takes precedence over `ext`.
    - Both are normalized to include a leading dot when present.
    - If neither exists, no extension suffix is added.

**Disk path mapping for tooling (not “virtual path”):**
- `resolveVfsDiskPath({ baseDir, virtualPath })`:
  - Splits the virtual path on `/` into components.
  - Encodes Windows-illegal characters in each component via `encodeURIComponent()` for `[:*?"<>|]`.
  - Joins using `path.sep` and roots at `baseDir`.

The **stable spec** is: *virtual paths are posix-style with `/`, disk paths are OS-safe via escaping.*

---

### 6.1.2 Task: Virtual path stability test

**Test file (must exist and pass):** `tests/indexing/vfs/virtual-path-stability.test.js`

**Must validate:**
- [x] Determinism: multiple invocations with identical inputs are string-equal.
- [x] Segment switching: changing `segmentUid` changes output only in the `#seg:` suffix.
- [x] Effective extension: `effectiveExt` overrides `ext`.
- [x] Cross-platform invariants:
  - The returned string always starts with `".poc-vfs/"`.
  - It never contains `\` (backslash), even on Windows.
  - It does not include raw absolute paths.

**Key implementation references:**
- `src/index/tooling/vfs.js`:
  - `buildVfsVirtualPath()`
  - `encodeContainerPath()`, `decodeContainerPath()`
  - `normalizeRelPath()` (imported from `../../shared/paths.js`)

If the existing test doesn’t cover the invariants above, extend it.

---

### 6.1.3 Task: VFS manifest roundtrip test (unsharded + sharded)

**Test file (must exist and pass):** `tests/indexing/vfs/vfs-manifest-roundtrip.test.js`

**Manifest schema reference (authoritative):**
- `src/contracts/schemas/artifacts.js` → `vfsManifestRow` schema
- Manifest writer uses:
  - `src/index/build/artifacts/writers/vfs-manifest.js`
  - `VFS_MANIFEST_SCHEMA_VERSION` from `src/index/tooling/vfs.js`

**Roundtrip requirements:**
- [x] **Unsharded mode**: writing `vfs_manifest.jsonl` and reading it back returns identical rows.
- [x] **Sharded mode**: forcing shard split via `maxJsonBytes` writes:
  - `vfs_manifest.meta.json`
  - `vfs_manifest.parts/…`
  - reading back yields the same rows.
- [x] Ordering:
  - Writer sorts rows with `sortVfsManifestRows()` so output is deterministic.
- [x] Row trimming:
  - Writer enforces `MAX_ROW_BYTES` (32 KB). Oversized rows must be trimmed in a deterministic way (`maybeTrimRow()`).

**Key implementation references:**
- Writer: `src/index/build/artifacts/writers/vfs-manifest.js`
  - `createVfsManifestRows()`
  - `sortVfsManifestRows()`
  - `buildManifestRow()` / `maybeTrimRow()`
  - `enqueueVfsManifestArtifacts()`
- Reader: `src/index/tooling/vfs.js`
  - `readVfsManifestRowsFromDisk()`
  - `readVfsManifestFromIndexRoot()`

---

### 6.1.4 Task: Add a minimal VFS disk-path safety test (recommended)

**Why:** `resolveVfsDiskPath()` is used on Windows, macOS, Linux. It must not create illegal filename components.

**New test (add):**
- `tests/indexing/vfs/vfs-disk-path-safety.test.js`

**Test cases:**
- [x] A virtual path containing illegal Windows characters in a component (e.g. `":"`, `"*"`, `"?"`, `"|"`) is converted to a disk path where those characters are percent-encoded.
- [x] Returned disk path is under `baseDir` (no traversal).
- [x] `virtualPath` containing `..` as a segment is treated as a literal component (still joined under baseDir), not as traversal.
  - If you consider `..` unsafe, then explicitly encode it or reject it; document the decision and test accordingly.

**Key implementation reference:** `src/index/tooling/vfs.js` → `resolveVfsDiskPath()`.

---

## 6.2 CI coverage: schema validation + clearer CI OS lanes

### 6.2.1 Task: Ensure schema & index validation always run in PR CI

**Goal:** If artifact schemas or validators break, PR CI must fail.

**What must be covered by the PR CI lane (`ci-lite`):**
- [x] **Contract/schema tests** (minimum):
  - `tests/indexing/contracts/schema-registry-single-source.test.js`
  - `tests/indexing/contracts/public-artifact-surface-doc.test.js`
  - `tests/indexing/contracts/artifact-surface-version.test.js`
- [x] **Index validator tests** (minimum):
  - `tests/indexing/validate/index-validate-strict.test.js`
  - `tests/indexing/validate/index-validate-load-manifest.test.js`
  - `tests/indexing/validate/index-validate-missing-pieces.test.js`
  - `tests/indexing/validate/index-validate-unknown-piece.test.js`

**Source of truth for what runs in `ci-lite`:**
- `tests/ci-lite/ci-lite.order.txt`  
  CI-lite is special-cased in `tests/run.js` and uses this order file verbatim.

**Acceptance criteria:**
- The list above is present in `ci-lite.order.txt`.
- `npm run test:ci-lite` fails when you intentionally break a schema or validator check.

**Implementation references:**
- Workflow: `.github/workflows/ci.yml`
- Test runner: `tests/run.js` (ci-lite order-file logic)

---

### 6.2.2 Task: Refine GitHub Actions CI job naming and OS coverage

**Workflow file:** `.github/workflows/ci.yml`

**Problems to address:**
- Job name `test` is ambiguous (it is really **Ubuntu**).
- Windows job is named `test-windows` but uses different OS runner (`windows-2022`) than nightly (`windows-latest`).
- macOS is covered in nightly, but not PR CI.

**Required changes:**
- [x] Rename job ids + display names:
  - `test` → `ubuntu`
  - `test-windows` → `windows`
- [x] Add a `macos` job running `npm run test:ci-lite`:
  - Runner: `macos-latest`
  - Keep it blocking if it’s fast enough; otherwise make it non-blocking but visible.
- [x] Align Windows runner choice with nightly unless you have a reason:
  - Prefer `windows-latest` unless a specific toolchain requires `windows-2022`.

**Acceptance criteria:**
- PR CI UI clearly shows `ubuntu`, `windows`, and `macos`.
- All jobs run the same Node version and `npm run test:ci-lite`.

**Related workflow:** `.github/workflows/nightly.yml` (already includes macOS).

---

## 6.3 Determinism + metaV2 correctness after post-processing

### 6.3.1 Task: call_sites determinism test

**Test file (must exist and pass):** `tests/indexer/call-sites/call-sites-determinism.test.js`

**What the test must guarantee:**
- [x] Two consecutive builds of the same fixture repository produce `call_sites.jsonl` output that is **line-identical**.
- [x] The fixture repo must be stable and self-contained (no network).
- [x] The test must not depend on wall-clock timestamps:
  - Compare content files, not meta `generatedAt` timestamps.

**Key implementation references:**
- Writer: `src/index/build/artifacts/writers/call-sites.js`
  - Determinism is primarily controlled by `sortCallSites(rows)`.
- Call detail production:
  - Call details are stored on `chunk.codeRelations.callDetails`.
  - Cross-file inference may add `targetChunkUid`/`targetDocId`/`targetCandidates`.

If determinism fails on Windows, inspect any path normalization differences and ensure ordering sort keys use normalized file paths (posix style `src/...`) rather than OS paths.

---

### 6.3.2 Task: Ensure metaV2 is finalized after cross-file inference mutations

**Why:** `metaV2` is a “flattened” structure derived from `chunk` + `chunk.docmeta` + `chunk.codeRelations`.  
Cross-file inference **mutates** those, so stale metaV2 would be a correctness bug.

**How it currently must work:**
- First metaV2 build (per-chunk) happens during assembly:
  - `src/index/build/file-processor/assemble.js` → `buildMetaV2(chunk)`
- Mutations happen later:
  - `src/index/build/indexer/steps/relations.js` → `runCrossFileInference()` (calls `applyCrossFileInference()`)
- Final metaV2 rebuild must happen at the end:
  - `src/index/build/indexer/steps/write.js` → `finalizeMetaV2({ chunks })`

**Acceptance criteria:**
- `finalizeMetaV2()` is invoked for every write mode (`code`, `prose`) **after** all mutation steps.
- Any artifact that includes `chunk.metaV2` is written after this finalization.

**Add/extend an integration assertion (recommended):**
- Update `tests/indexing/type-inference/crossfile/crossfile-output.integration.test.js` to also assert:
  - `buildWidget.metaV2.docmeta.inferredTypes.returns` includes `{ type: "Widget", source: "flow" }`
  - `buildWidget.metaV2.codeRelations.callLinks` includes the link to `createWidget`
  - `buildWidget.metaV2.codeRelations.usageLinks` includes the link to `Widget`
- This specifically catches stale metaV2 after inference.

---

## 6.4 Heuristic noise reduction: reserved words + code dictionaries + token classification

This subsection affects:
- Call/usage extraction in heuristic parsers (C-like, Go, Java, Kotlin, C#, Lua, Perl, PHP, Ruby, Shell, TypeScript).
- Tokenization quality (identifier splitting / keyword noise).

### 6.4.1 Task: Promote per-language reserved word sets to “complete” keyword lists

**Current problem:** the existing `*_CALL_KEYWORDS` and `*_USAGE_SKIP` sets are partial.  
This causes false-positive calls/usages for keywords and builtin type names.

**Primary implementation locations to update:**
- C-like:
  - `src/index/constants.js` → `CLIKE_CALL_KEYWORDS`, `CLIKE_USAGE_SKIP`
- TypeScript:
  - `src/lang/typescript/constants.js` → `TS_CALL_KEYWORDS`, `TS_USAGE_SKIP`, `TS_FLOW_SKIP`
- Others (inline in file):
  - `src/lang/csharp.js` → `CSHARP_CALL_KEYWORDS`, `CSHARP_USAGE_SKIP`
  - `src/lang/go.js` → `GO_CALL_KEYWORDS`, `GO_USAGE_SKIP`
  - `src/lang/java.js` → `JAVA_CALL_KEYWORDS`, `JAVA_USAGE_SKIP`
  - `src/lang/kotlin.js` → `KOTLIN_CALL_KEYWORDS`, `KOTLIN_USAGE_SKIP`
  - `src/lang/lua.js` → `LUA_CALL_KEYWORDS`, `LUA_USAGE_SKIP`
  - `src/lang/perl.js` → `PERL_CALL_KEYWORDS`, `PERL_USAGE_SKIP`
  - `src/lang/php.js` → `PHP_CALL_KEYWORDS`, `PHP_USAGE_SKIP`
  - `src/lang/ruby.js` → `RUBY_CALL_KEYWORDS`, `RUBY_USAGE_SKIP`
  - `src/lang/shell.js` → `SHELL_CALL_KEYWORDS`, `SHELL_USAGE_SKIP`
  - Rust (flow/dataflow only):
    - `src/lang/rust.js` → `RUST_USAGE_SKIP`

**Missing comprehensive reserved-word sets (add these):**
- Objective-C (`src/lang/clike.js` / `src/lang/tree-sitter` usage; no `*_RESERVED_WORDS` yet)
- Swift (`src/lang/swift.js` only has `SWIFT_DECL_KEYWORDS` + tiny skip set)
- C++ (currently only covered implicitly by `CLIKE_RESERVED_WORDS`)
- JavaScript (`src/lang/javascript.js` has no reserved-word set)
- Python (`src/lang/python.js` has no reserved-word set)
- Rust (has `RUST_USAGE_SKIP` only; no full reserved list)
- SQL dialects: Postgres / MySQL / SQLite (`src/lang/sql.js` has no reserved-word sets)
- CSS (`src/lang/css.js` has no reserved-word set)
- HTML (`src/lang/html.js` has no reserved-word set)

**Required refactor (recommended for maintainability):**
- [x] For each language module above, introduce a single exported `*_RESERVED_WORDS` (or `*_KEYWORDS`) set that is the **superset**.
- [x] Define:
  - `*_CALL_KEYWORDS = RESERVED_WORDS ∩ {things that can appear before “(” in syntax but are not calls}`
  - `*_USAGE_SKIP = RESERVED_WORDS ∪ {primitive types, literals, ultra-common words}`  
    (keep it *strictly* a superset to reduce false positives)
- [x] Ensure all sets are:
  - lowercased where language is case-sensitive (except where language semantics require case, e.g., Rust `Self`)
  - sorted in source for readability (alphabetical)
  - have no duplicates

**Acceptance criteria:**
- Fewer false positives in `calls`/`usages` for the targeted languages.
- No existing tests regress.

**Add regression tests (must add):**
- `tests/indexing/relations/keyword-skip-heuristics.test.js` (new)

Design:
- For each language that uses regex `\bNAME\s*\(` call extraction, feed a snippet that contains:
  - control structures that look like calls: `if(...)`, `for(...)`, `while(...)`, etc
  - real calls: `foo(...)`, `obj.foo(...)`
- Assert that:
  - control structure keywords are **not** included in `calls`
  - `foo`/`obj.foo` **are** included

Implementation hint:
- Use the existing relation entrypoints:
  - C-like: `src/lang/clike.js` exports `buildCLikeRelations` (or equivalent; see file exports)
  - Go: `buildGoRelations(...)` or the module export that returns `{ calls, usages }`
  - etc.

If you don’t have a clean exported function, test the internal `collect*CallsAndUsages()` functions directly.

---

### 6.4.2 Task: Per-language “code dictionaries” for identifier segmentation

**Goal:** Improve identifier splitting (e.g., `HTTPRequest` → `http` + `request`, `userID` → `user` + `id`)  
**without changing core scoring/ranking logic** (only segmentation quality).

**Current segmentation engine:** `src/shared/tokenize.js`
- `splitWordsWithDict(token, dictWords, config)` is already used by:
  - index-time tokenization: `src/index/build/tokenization.js`
  - query-time tokenization: `src/retrieval/query.js`

**Proposed design:**
- [x] Add a second dictionary source: **code dictionaries**, separate from natural-language dictionaries.
- [x] Code dictionaries are loaded, and applied only when tokenizing code (index mode `code`).
- [x] Provide:
  - `common-code.txt` (shared abbreviations): `http`, `url`, `uuid`, `json`, `yaml`, `html`, `css`, `sql`, `api`, `cli`, `ui`, `db`, `rpc`, `grpc`, `tls`, `ssl`, `jwt`, `oauth`, etc.
  - Per-language additions: `go.txt`, `java.txt`, `typescript.txt`, etc.

**Where to implement:**
- Dictionary path discovery:
  - Extend `tools/dict-utils/paths/dictionaries.js` (or add sibling `code-dictionaries.js`)
  - Add config shape to `tools/dict-utils/config/schema` (if present) or document it in roadmap.
- Runtime load:
  - `src/index/build/runtime/runtime.js` → `loadDictionaryWords(...)` currently loads `dictWords`
  - Add `codeDictWords` and/or `codeDictWordsByLanguage`
- Tokenization:
  - `src/index/build/tokenization.js`:
    - When `mode === "code"`, pass a dictionary set that unions:
      - natural dict words (`dictWords`)
      - common code dict
      - effective-language-specific code dict (if any)
  - Ensure worker tokenization has access too:
    - `src/index/build/workers/indexer-worker.js` uses `createTokenizationContext()`

**Acceptance criteria:**
- Turning on code dictionaries improves segmentation for representative identifiers.
- Prose segmentation is unaffected unless explicitly configured.

**Add tests (must add):**
- `tests/indexing/tokenization/tokenize-code-dictionaries.test.js` (new)
  - Verify that with a code dictionary containing `http` and `request`, `HTTPRequest` splits to include `http` and `request`.
  - Verify that with code dictionaries disabled, splitting falls back to existing behavior.

---

### 6.4.3 Task: Token classification (keyword vs identifier vs operator) + weighting

**Goal:** Keep keywords/operators searchable but reduce their ranking impact (keyword-noise control).

**Core requirements:**
- [x] Add classification for code tokens into at least:
  - `identifier`
  - `keyword`
  - `operator`
  - `literal` (numbers/strings)
- [x] Use Tree-sitter token/node types when available, **fallback** to keyword lists only when necessary.
  - Tree-sitter config: `src/lang/tree-sitter/config.js` lists supported `TREE_SITTER_LANGUAGE_IDS`.
- [x] Keep keywords indexable but **down-weight** them relative to identifiers.

#### Proposed implementation strategy (fits current architecture)

**A) Extend tokenization output to carry typed token buckets**
- Modify `src/index/build/tokenization.js`:
  - Currently returns `{ tokens, frequencies, positions, totalTokens }`
  - Extend to also return:
    - `identifierTokens` (array)
    - `keywordTokens` (array)
    - `operatorTokens` (array)
  - `tokens` should continue to exist for backward compatibility (initially keep it as the union).

**B) Feed typed buckets into `fieldTokens`**
- Modify `src/index/build/file-processor/assemble.js` `buildChunkPayload()`:
  - Currently sets `fieldTokens = { name, signature, doc, comment, body }`
  - Add new fields:
    - `fieldTokens.keyword = keywordTokens`
    - `fieldTokens.operator = operatorTokens`
  - Decide what `body` should contain:
    - **Recommended final shape:** `body = identifierTokens` only
    - But do this behind a config flag for compatibility (see below).

**C) Build field postings for new token fields**
- Modify `src/index/build/state.js`:
  - `fieldPostings` currently has `name`, `signature`, `doc`, `comment`, `body`.
  - Add `keyword` and `operator` maps (or make this dynamic by iterating keys from `chunk.fieldTokens`).
- Ensure `src/index/build/postings.js` writes `field_postings.json` with the additional fields.

**D) Retrieval: add default weights for new fields**
- Modify `src/retrieval/query-intent.js`:
  - Extend `DEFAULT_FIELD_WEIGHTS` to include:
    - `keyword`: small weight (e.g., 0.15–0.35)
    - `operator`: tiny weight (e.g., 0.05) or 0 (indexable but not scoring)
- Ensure `src/retrieval/pipeline.js` still operates if these fields are missing (older index).

**E) Compatibility plan**
- Add config flag (suggested):
  - `indexing.postings.tokenClassification.enabled` (default: `false` initially)
- When disabled:
  - Keep current behavior: `body = tokens` (union), no new fields required.
- When enabled:
  - `body = identifierTokens`
  - `keyword`/`operator` fields populated and weighted.

**Acceptance criteria:**
- Queries with only identifiers behave the same or better.
- Queries that are mostly keywords (e.g., `async await`) still return results, but keyword-only matches don’t dominate ranking.

**New tests (must add):**
1. `tests/indexing/tokenization/token-classification-tree-sitter.test.js`
   - Feed a small snippet in a Tree-sitter-supported language (e.g., JS or Go).
   - Assert that tokens are classified as expected:
     - identifiers go to `identifierTokens`
     - `if`, `for`, `return` go to `keywordTokens`
     - `=>`, `.`, `::`, `(`, `)` go to `operatorTokens` (depending on which operators you choose to index)
2. `tests/retrieval/ranking/keyword-downweighting.test.js`
   - Build a tiny synthetic index with two chunks:
     - Chunk A: many keyword tokens, few identifiers
     - Chunk B: fewer keywords, matching identifiers
   - Query for identifiers + keyword; assert chunk B ranks above A when classification is enabled.

---

## 6.5 CI-Long lane: isolate long-running tests

### 6.5.1 Task: Create a “CI-Long” lane that runs only tests tagged `long`

**Why:** Long tests slow PR feedback; they belong in scheduled/nightly lanes.

**Source of truth for “long”:**
- Tag rules in `tests/run.rules.jsonc` under `"tagRules"` include tag `"long"`.

**Required changes (recommended design: lane alias)**
- [x] Update `tests/run.rules.jsonc`:
  - Add `"ci-long"` to `"knownLanes"`.
- [x] Update `tests/runner/run-discovery.js` `resolveLanes()`:
  - Treat `ci-long` the same as `ci` (expand to `unit`, `integration`, `services`).
- [x] Update `tests/run.js`:
  - When lane `ci-long` is requested, automatically add `--tag long` (as if user passed it).
  - Ensure `--exclude-tag` still works as expected.
- [x] Add npm script in `package.json`:
  - `"test:ci-long": "node tests/run.js --lane ci-long"`
- [x] Add a GitHub Actions workflow lane/job (choose one):
  - **Option A:** Add to `.github/workflows/nightly.yml` (best): run `npm run test:ci-long` on all OSes.
  - **Option B:** Add a separate scheduled workflow `.github/workflows/ci-long.yml`.

**Acceptance criteria:**
- `npm run test:ci-long` runs **only** tests tagged `long`.
- PR CI remains fast (ci-lite).
- Nightly (or scheduled) runs include ci-long.

**Implementation references:**
- Tags/lane system:
  - `tests/run.rules.jsonc`
  - `tests/runner/run-discovery.js`
  - `tests/run.js`

---

## Appendix: Suggested “complete” reserved word lists (copy/paste seeds)

> These are intended as **seed lists** to prevent having to web-search during implementation.  
> Prefer Tree-sitter classification where possible, but keep these sets for heuristic parsers.

### JavaScript / TypeScript (seed keywords)
```
await break case catch class const continue debugger default delete do else enum export extends false finally for function if import in instanceof new null return super switch this throw true try typeof var void while with yield let
as implements interface package private protected public static
any boolean bigint number object string symbol unknown never
keyof readonly infer satisfies asserts is require namespace module type from of get set constructor declare abstract override
```

### C / C++ (seed keywords)
```
auto break case char const continue default do double else enum extern float for goto if inline int long register restrict return short signed sizeof static struct switch typedef union unsigned void volatile while
_Alignas _Alignof _Atomic _Bool _Complex _Generic _Imaginary _Noreturn _Static_assert _Thread_local
alignas alignof and and_eq asm bitand bitor bool catch char8_t char16_t char32_t class compl concept const_cast consteval constexpr constinit co_await co_return co_yield decltype delete dynamic_cast explicit export false friend import module mutable namespace new noexcept not not_eq nullptr operator or or_eq private protected public reinterpret_cast requires static_assert static_cast template this thread_local throw true try typeid typename using virtual wchar_t xor xor_eq final override
```

### Go (seed keywords + predeclared)
```
break default func interface select case defer go map struct chan else goto package switch const fallthrough if range type continue for import return var
nil true false iota
append cap close complex copy delete imag len make new panic print println real recover
bool byte complex64 complex128 error float32 float64 int int8 int16 int32 int64 rune string uint uint8 uint16 uint32 uint64 uintptr any
```

### Java (seed)
```
abstract assert boolean break byte case catch char class const continue default do double else enum extends final finally float for goto if implements import instanceof int interface long native new package private protected public return short static strictfp super switch synchronized this throw throws transient try void volatile while
true false null
var record yield sealed permits non-sealed
module open requires exports opens to uses provides with transitive
```

### Kotlin (seed)
```
as as? break class continue do else false for fun if in !in interface is !is null object package return super this throw true try typealias val var when while
by catch constructor delegate dynamic field file finally get import init param property receiver set setparam where
actual abstract annotation companion const crossinline data enum expect external final infix inline inner internal lateinit noinline open operator out override private protected public reified sealed suspend tailrec vararg value
```

### C# (seed)
```
abstract as base bool break byte case catch char checked class const continue decimal default delegate do double else enum event explicit extern false finally fixed float for foreach goto if implicit in int interface internal is lock long namespace new null object operator out override params private protected public readonly ref return sbyte sealed short sizeof stackalloc static string struct switch this throw true try typeof uint ulong unchecked unsafe ushort using virtual void volatile while
add alias ascending async await by descending dynamic equals from get global group into join let nameof on orderby partial remove select set value var when where yield record init with
```

### Lua (seed)
```
and break do else elseif end false for function goto if in local nil not or repeat return then true until while
```

### PHP (seed)
```
__halt_compiler abstract and array as break callable case catch class clone const continue declare default die do echo else elseif empty enddeclare endfor endforeach endif endswitch endwhile eval exit extends final finally fn for foreach function global goto if implements include include_once instanceof insteadof interface isset list match namespace new or print private protected public readonly require require_once return static switch throw trait try unset use var while xor yield yield from
true false null
```

### Ruby (seed)
```
BEGIN END alias and begin break case class def defined? do else elsif end ensure false for if in module next nil not or redo rescue retry return self super then true undef unless until when while yield
__FILE__ __LINE__ __ENCODING__
```

### Shell (bash/sh seed)
```
if then else elif fi for while until do done case esac in select function time coproc
break continue return exit shift eval exec trap wait local declare typeset readonly export set unset source
true false
```

### Perl (seed)
```
my our use sub package if elsif else unless while until for foreach continue do given when default
next last redo goto return
BEGIN END INIT CHECK UNITCHECK
die warn print say
```

---



## Phase 7 — Embeddings + ANN unification

This section is a **fully expanded, implementation-ready** rewrite of the Phase 7 roadmap. 

**Primary goals:**
- Make embedding generation **build-scoped, deterministic, and resumable** (service queue or inline).
- Make ANN backends **consistent** (same target vectors, same candidate filtering semantics, same readiness signals).
- Make the artifact surface **manifest-first** and contract-compliant (no “guessing” filenames in strict mode).
- Remove quantization/normalization ambiguity so that outputs are **correct, stable, and comparable**.

---

### Objective

Unify embeddings and ANN artifacts across all build paths (inline indexing, build-embeddings, and service queue) so that:

1. **Index build outputs are deterministic**
   - Embedding jobs always target an explicit build root and index directory.
   - Cached embeddings are keyed by an explicit identity key that includes model and quantization settings.
   - Incremental updates and full builds produce the same embedding artifacts.

2. **ANN backends behave consistently**
   - Candidate filtering behaves the same across HNSW and LanceDB.
   - ANN target selection aligns with `denseVectorMode` (merged/doc/code/auto).
   - “ANN-ready” state is clearly signaled in `index_state.json` and the manifest.

3. **Artifact discovery is contract-compliant**
   - Strict discovery uses `pieces/manifest.json` (no directory scanning / filename guessing).
   - Embeddings/ANN artifacts are included in the manifest when present, absent when not.

---

### Exit criteria

All items must be satisfied:

- ✅ **Embedding jobs are build-scoped**
  - `tools/service/indexer-service.js` uses the job payload to run build-embeddings **against the correct build root** even if builds/current.json changes.
  - Queue payload format is versioned and validated (`embeddingPayloadFormatVersion`).

- ✅ **No quantization overflow / wrap**
  - Quantization levels are clamped to `[2, 256]` in every path that quantizes vectors.
  - No path writes >255 values into a `Uint8Array` or “uint8 JSON” vector artifact.

- ✅ **Normalization is consistent**
  - If `embeddingIdentity.normalize === true`, all stored vectors used for ANN and exact ranking are normalized (or explicitly documented and tested otherwise).

- ✅ **Manifest completeness**
  - If an ANN backend artifact exists (HNSW bin, LanceDB directory, SQLite-vec table marker), the manifest includes a corresponding entry (and any required meta entry).
  - If it does not exist, the manifest does not list it.

- ✅ **Strict mode compliance**
  - Retrieval and validation do not guess filenames in strict mode; they locate artifacts through the manifest.

- ✅ **Parity tests pass**
  - Ranking parity tests demonstrate that Dense vs HNSW vs LanceDB are consistent on deterministic fixtures (within acceptable error bounds for ANN).

---

## 7.0 Foundation: contracts, terminology, and execution order

### 7.0.1 Source-of-truth hierarchy and conflict resolution rules

Phase 7 touches multiple “spec surfaces”. Use this hierarchy when conflicts arise:

1. **docs/contracts/public-artifact-surface.md**  
   - Canonical rule: strict tooling must discover artifacts via the manifest (no guessing).  
2. **src/contracts/** (runtime validators + schema defs)  
   - Canonical for what the code *currently* enforces.
3. **docs/guides/embeddings.md** and **docs/guides/search.md**  
   - Operational guidance. If it conflicts with (1), update the guide.
4. **Current implementation**  
   - If code is *ahead* of docs (e.g., it already writes an artifact but docs omit it), update docs/contracts to match the intended public surface.
   - If code is *behind* docs/contracts, update code to match contracts.

**Explicit Phase 7 conflicts discovered and resolution choices:**
- **Conflict A:** Embedding queue `indexRoot` meaning is inconsistent (pipeline passes per-mode index dir; build-embeddings `--index-root` expects base build root).  
  ✅ Resolution: **Rename/clarify fields** in the job payload (`buildRoot` as base; `indexDir` as per-mode). Update tests + worker accordingly. This removes ambiguity and matches build-embeddings behavior.
- **Conflict B:** `tools/build/embeddings/manifest.js` currently filters entries by `ARTIFACT_SCHEMA_DEFS`, which omits non-JSON artifacts like HNSW `.bin` and LanceDB directories.  
  ✅ Resolution: **Manifest must include these artifacts**. Update manifest writer to include them via an allowlist even if they are not JSON-schema-validated, and update docs/contracts to explicitly list them as part of the public surface.
- **Conflict C:** Retrieval loaders read many JSON artifacts via direct filesystem reads (bypassing manifest), contradicting “manifest-first”.  
  ✅ Resolution: In strict mode, retrieval must use `src/shared/artifact-io.js` manifest-based resolvers for all artifacts it loads (JSON and non-JSON).

### 7.0.2 Terminology

To prevent recurring confusion, Phase 7 standardizes these terms:

- **repoRoot**: The repository being indexed/searched.
- **buildRoot**: A single build output root (e.g., `<repo>/builds/<buildId>`). This is the root that contains `index-code`, `index-prose`, etc.
- **indexDir**: A per-mode directory inside buildRoot, e.g.:
  - `<buildRoot>/index-code`
  - `<buildRoot>/index-prose`
- **mode**: One of `code | prose | extracted-prose | records` (Phase 7 primarily targets code + prose).
- **vector variant / target**:
  - `merged`: merged embedding vector for a chunk
  - `code`: code-only vector
  - `doc`: doc-only vector
- **denseVectorMode**: How to select the vector variant for ranking:
  - `merged | code | doc | auto`
  - `auto` is resolved per query intent (and/or mode-specific fallback).
- **ANN backend**: `lancedb | hnsw | sqlite-vec | dense | none` (exact list depends on optional deps and configuration).

### 7.0.3 Capability matrix (post-Phase 7 required behavior)

After Phase 7, these capabilities must hold:

- Dense exact ranking: supports `merged/doc/code` (already possible via `resolveDenseVector()` once `denseVectorMode` is wired through).
- LanceDB ANN: supports `merged/doc/code` (already built and selectable via `resolveLanceDbTarget()`).
- HNSW ANN: **must have an explicit, documented target mapping**:
  - Build and load HNSW indices for `merged/doc/code` so it can match LanceDB behavior.


### 7.0.4 Recommended execution order

Order tasks so that cross-cutting foundational changes land first:

1. **7.2 Artifact contract + manifest completeness** (must exist before strict loaders can be updated)
2. **7.3 Quantization invariants** (prevents corrupt outputs and invalid caches)
3. **7.4 Normalization policy consistency** (required before parity tests)
4. **7.1 Embedding job scoping + worker behavior** (service correctness)
5. **7.5 LanceDB robustness**
6. **7.6 HNSW compatibility + observability**
7. **7.7 Backend policy + ranking equivalence**
8. **7.8 Storage resilience**

---

### 7.0.5 Test lane classification (mandatory)

All new Phase 7 tests must land in the intended CI lane.

- Update `tests/run.rules.jsonc` to map any new test files (do not rely on ambiguous filenames alone).
- If a test is intentionally placed to match an existing lane rule, verify it in `npm test -- --list-lanes` and note it in the test section.
- Add a shared optional-deps test helper (e.g., `tests/helpers/optional-deps.js`) so skip behavior is consistent across tests.

## 7.1 Embedding jobs are build-scoped, deterministic, idempotent

### Why this exists

Current embedding service flow is not fully build-scoped:
- `src/index/build/indexer/pipeline.js` enqueues an embedding job, but the worker (`tools/service/indexer-service.js`) ignores job buildRoot/indexRoot and calls `tools/build/embeddings.js` without `--index-root`.
- Queue tests currently allow inconsistent `buildRoot` vs `indexRoot` values, which hides real scoping bugs.

### 7.1.1 Define the embedding job payload schema (versioned)

**Touchpoints**
- `src/index/build/indexer/embedding-queue.js` (~L1–L49)
- `tools/service/queue.js` (~L1–L270)
- `tools/service/indexer-service.js` (~L1–L441)
- Tests: `tests/indexing/embeddings/embedding-queue.test.js` (~L1–L51), `tests/indexing/embeddings/embedding-queue-defaults.test.js` (~L1–L37)

**New canonical job payload fields** (JSON):
```json
{
  "type": "embeddings",
  "embeddingPayloadFormatVersion": 2,
  "repoRoot": "/abs/path/to/repo",
  "buildId": "b123",
  "buildRoot": "/abs/path/to/repo/builds/b123",
  "mode": "code",
  "indexDir": "/abs/path/to/repo/builds/b123/index-code",
  "embeddingIdentity": { "...": "..." },
  "embeddingIdentityKey": "sha1-or-similar",
  "configHash": "sha1-of-effective-config",
  "repoProvenance": {
    "gitSha": "optional",
    "dirty": false,
    "toolVersion": "optional"
  },
  "createdAt": "2026-01-30T12:34:56.000Z",
  "updatedAt": "2026-01-30T12:34:56.000Z",
  "attemptCount": 0,
  "lastError": null
}
```

**Hard requirements**
- `buildRoot` MUST be an absolute path.
- `indexDir` MUST be an absolute path AND MUST be inside `buildRoot` (validate via `path.relative()`; reject `..` escape).
- `mode` MUST be one of the supported modes.
- `embeddingIdentityKey` MUST match `buildEmbeddingIdentityKey(embeddingIdentity)` exactly.
- `configHash` MUST be stable for the effective embedding config.
- `embeddingPayloadFormatVersion` MUST be set (defaulted, but not omitted).

**Compatibility behavior**
- If a job is missing `embeddingPayloadFormatVersion`, treat it as version 1 and:
  - If it has `indexRoot` (legacy), interpret:
    - If `indexRoot` ends with `/index-code` or `/index-prose`, treat it as `indexDir`.
    - Else treat it as `buildRoot`.
  - Populate missing fields where safely derivable.
  - Emit a warning once per worker run that legacy payloads are being upgraded.

### 7.1.2 Fix the enqueue site to emit correct fields

**Touchpoints**
- `src/index/build/indexer/pipeline.js` (~L1–L326) (search: `enqueueEmbeddingJob({`)
- `src/index/build/indexer/embedding-queue.js` (~L1–L49)

**Current bug**
- Pipeline passes `indexRoot: outDir` where `outDir` is already the per-mode index directory. This is incompatible with build-embeddings `--index-root` semantics and breaks any future “join index dir” logic.

**Required changes**
- In `pipeline.js` when calling `enqueueEmbeddingJob`, pass:
  - `buildRoot: runtime.buildRoot` (already exists on runtime)
  - `indexDir: outDir` (rename from indexRoot)
- In `embedding-queue.js`, accept `indexDir` (new) and either:
  - Disallow legacy `indexRoot` input, OR
  - Support both but normalize to canonical `indexDir`.

**Also update**
- Validate `indexDir` exists (or at least that its parent buildRoot exists) before enqueueing. If missing, treat as programmer error and throw (this prevents silent jobs that can never run).

### 7.1.3 Worker must run build-embeddings against the correct build root

**Touchpoints**
- `tools/service/indexer-service.js` (~L1–L441) (function `runBuildEmbeddings`)
- `tools/build/embeddings/cli.js` (~L1–L95) (already supports `--index-root`)
- `tools/build/embeddings/runner.js` (~L1–L763) (already expects indexRoot base)

**Required changes**
- Update `runBuildEmbeddings({ job })` to include:
  - `--index-root <job.buildRoot>`  
    (NOT `job.indexDir`; build-embeddings runner will derive per-mode indexDir.)
- If job includes `indexDir`, pass it only for validation/logging; do not use as the base index root.
- Ensure the worker runs `--mode <job.mode>` and uses the job’s `repoRoot` (or `repo`).
- If `job.repoRoot` and the worker’s `--repo` mismatch, the worker should:
  - prefer `job.repoRoot` if present
  - warn if `--repo` differs (avoid “wrong repo” processing)

**Safety requirement**
- If `job.buildRoot` does not exist, mark job failed with `lastError` explaining missing build root and do not retry indefinitely (cap attempts).

### 7.1.4 Index state should clearly represent “pending embeddings”

**Touchpoints**
- `src/index/build/indexer/steps/write.js` (~L1–L101) (writes initial index_state during stage2)
- `tools/build/embeddings/runner.js` (~L1–L763) (updates index_state during stage3)

**Required state machine**
- Stage2 build when embeddings are configured to run later via service:
  - `index_state.embeddings.enabled = true`
  - `index_state.embeddings.ready = false`
  - `index_state.embeddings.pending = true`  ✅ add this
  - `index_state.embeddings.service = true`
  - `index_state.embeddings.mode = <mode>`
  - `index_state.embeddings.embeddingIdentity` and `.embeddingIdentityKey` SHOULD be present if known at stage2.
- Stage3 success:
  - `enabled = true`
  - `ready = true`
  - `pending = false`
  - `updatedAt` set (already)
- Stage3 failure:
  - `enabled = true`
  - `ready = false`
  - `pending = false` (job completed but failed) OR keep `pending=true` only if the job will be retried.
  - `lastError` set (new)

**Note:** Retrieval currently uses `embeddingsReady = embeddingsState?.ready !== false && embeddingsState?.pending !== true`. That logic assumes `pending` exists; Phase 7 makes it real.

### 7.1.5 Tests for build scoping and worker correctness

**Update existing tests**
- `tests/indexing/embeddings/embedding-queue.test.js`
  - Must require that when `enqueueEmbeddingJob({ runtime, mode, indexDir })` is called:
    - job.buildRoot equals runtime.buildRoot
    - job.indexDir equals resolved indexDir
    - job.indexDir is within job.buildRoot
  - Remove the current test behavior that allows buildRoot/indexRoot mismatch.
- `tests/indexing/embeddings/embedding-queue-defaults.test.js`
  - Assert that missing optional fields are filled:
    - `embeddingPayloadFormatVersion` is set
    - `attemptCount` default 0
    - `createdAt` and `updatedAt` are ISO strings

**Add new tests**
- `tests/services/indexer/indexer-service-embedding-job-uses-build-root.test.js` (new)
  - Create two builds (b1 and b2) under a temp repo
  - Create a job targeting buildRoot=b1
  - Simulate builds/current.json pointing at b2
  - Run `tools/service/indexer-service.js --once --queue embeddings` (or equivalent)
  - Assert embeddings artifacts were written under build b1 (not b2)
  - Assert job is marked completed and `index_state.json` under b1 indicates `ready=true`.

---

## 7.2 Artifact contract parity for embeddings + ANN

### Why this exists

Contracts require manifest-first discovery. Today:
- `tools/build/embeddings/manifest.js` tries to add embedding pieces but filters them by `ARTIFACT_SCHEMA_DEFS`, excluding important non-JSON artifacts.
- Retrieval/validation still open some artifacts by guessed filenames.

Phase 7 makes embeddings and ANN artifacts fully discoverable via the manifest.

### 7.2.1 Define the canonical public artifact names for embeddings + ANN

**Specs to update**
- `docs/contracts/artifact-schemas.md`
- `docs/contracts/public-artifact-surface.md`

**Code to update**
- `src/contracts/registry.js` and/or `src/contracts/schemas/artifacts.js` (if adding names)
- `tools/build/embeddings/manifest.js`
- `src/shared/artifact-io/manifest.js` (if adding helpers for binary/dir artifacts)
- `src/retrieval/cli-index.js`, `src/retrieval/cli/load-indexes.js`, `src/index/validate.js`

**Canonical names (Phase 7)**
These names are used as `manifestEntry.name` and in code when resolving artifacts:

Dense vectors (quantized uint8 JSON, with vectors embedded):
- `dense_vectors` → `dense_vectors_uint8.json`
- `dense_vectors_doc` → `dense_vectors_doc_uint8.json`
- `dense_vectors_code` → `dense_vectors_code_uint8.json`

HNSW (non-JSON + JSON meta):
- `dense_vectors_hnsw` → `dense_vectors_hnsw.bin`
- `dense_vectors_hnsw_meta` → `dense_vectors_hnsw.meta.json`
- `dense_vectors_doc_hnsw` → `dense_vectors_doc_hnsw.bin`
- `dense_vectors_doc_hnsw_meta` → `dense_vectors_doc_hnsw.meta.json`
- `dense_vectors_code_hnsw` → `dense_vectors_code_hnsw.bin`
- `dense_vectors_code_hnsw_meta` → `dense_vectors_code_hnsw.meta.json`

LanceDB (directories + JSON meta):
- `dense_vectors_lancedb` → `dense_vectors.lancedb/`
- `dense_vectors_lancedb_meta` → `dense_vectors.lancedb.meta.json`
- `dense_vectors_doc_lancedb` → `dense_vectors_doc.lancedb/`
- `dense_vectors_doc_lancedb_meta` → `dense_vectors_doc.lancedb.meta.json`
- `dense_vectors_code_lancedb` → `dense_vectors_code.lancedb/`
- `dense_vectors_code_lancedb_meta` → `dense_vectors_code.lancedb.meta.json`

SQLite vector extension ANN presence:
- This is DB state, not a file artifact. Represent it in `index_state.embeddings.backends.sqliteVec` and optionally as a manifest “marker”:
  - `dense_vectors_sqlite_vec_meta` → `dense_vectors_sqlite_vec.meta.json` (new optional)  
    (If added, it documents dims/count and table name; it is optional because it depends on build options and sqlite configuration.)

**Important:** Even if you do not add JSON schemas for binary/dir artifacts, their NAMES must be part of the public artifact surface and must appear in the manifest when present.

### 7.2.2 Update the embeddings manifest writer to include non-JSON artifacts

**Touchpoints**
- `tools/build/embeddings/manifest.js` (~L1–L111)

**Current behavior**
- Builds `embeddingPieces`, then filters by `ARTIFACT_SCHEMA_DEFS` names, which excludes:
  - `dense_vectors_hnsw` (bin)
  - `dense_vectors_lancedb` (dir)
  - and doc/code variants.

**Required behavior**
- Remove or relax the schema-name filter. Replace with a clear allowlist:
  - `const allowed = new Set([...Object.keys(ARTIFACT_SCHEMA_DEFS), ...NON_JSON_PUBLIC_ARTIFACTS]);`
  - where `NON_JSON_PUBLIC_ARTIFACTS` includes the bin/dir names listed above.
- For `format: 'bin'`, add manifest entry if the file exists.
- For `format: 'dir'`, add manifest entry if the directory exists.
- Ensure manifest entries record:
  - `format` as `json|jsonl|bin|dir` (already)
  - `bytes` and `sha256` for files (`bin` and `json`) where feasible
  - For directories, record `entries` count and/or omit bytes (bytes optional); if bytes is recorded, compute deterministically (walk directory sorted).

**Edge cases**
- If `.bak` exists for HNSW, do not add it to manifest as a separate artifact. The `.bak` is an implementation detail. Only the canonical `.bin` path is listed.

### 7.2.3 Update readers to use manifest in strict mode

**Touchpoints**
- `src/retrieval/cli-index.js` (~L1–L416) (file-backed load)
- `src/retrieval/cli/load-indexes.js` (~L1–L368) (LanceDB attach)
- `src/index/validate.js` (~L1–L581)
- `src/shared/artifact-io.js` (~L1–L12) and `src/shared/artifact-io/manifest.js` (~L1–L291)

**Required behavior**
- In strict mode:
  - JSON artifacts are loaded via `loadJsonArrayArtifact`, `loadJsonObjectArtifact`, `loadChunkMeta`, etc.
  - Non-JSON artifacts are *located* via manifest (resolve path), then opened.

**Concrete implementation steps**
1. Add helper(s) in `src/shared/artifact-io.js`:
   - `resolveBinaryArtifactPath(dir, name, { strict })`
   - `resolveDirArtifactPath(dir, name, { strict })`
   These should:
   - in strict mode: require manifest entry and return absolute path
   - in non-strict mode: fall back to legacy filename guessing (only for backward compatibility)
2. Update `src/retrieval/cli-index.js`:
   - Replace `readJsonFile(path.join(dir, 'dense_vectors_uint8.json'))` with `loadJsonObjectArtifact(dir, 'dense_vectors', { strict: true })`
   - Replace HNSW meta load with `loadJsonObjectArtifact(dir, 'dense_vectors_hnsw_meta', { strict: true })`
   - Resolve HNSW bin with `resolveBinaryArtifactPath(dir, 'dense_vectors_hnsw', { strict: true })`
3. Update `src/retrieval/cli/load-indexes.js` attachLanceDb:
   - Resolve `dense_vectors_*_lancedb_meta` through manifest, not direct path join.
   - Resolve the lancedb directory through manifest entry `dense_vectors_*_lancedb`.
4. Update `src/index/validate.js`:
   - For strict validation, require manifest presence for embedding artifacts and use it to locate them.
   - Validation should fail if an artifact exists on disk but is missing from manifest (strict mode).

### 7.2.4 Index state should include embedding identity and backend presence

**Touchpoints**
- `src/index/build/indexer/steps/write.js` (~L1–L101) (stage2)
- `tools/build/embeddings/runner.js` (~L1–L763) (stage3)
- Tests: `tests/indexing/embeddings/embeddings-validate.test.js` (~L1–L82), `tools/index/validate.js` (~L1–L130) output

**Required new fields**
- `index_state.embeddings.embeddingIdentity` (object)
- `index_state.embeddings.embeddingIdentityKey` (string)
- `index_state.embeddings.backends` (object, example):
```json
{
  "hnsw": { "enabled": true, "available": true, "target": "merged", "dims": 384, "count": 1234 },
  "lancedb": { "enabled": true, "available": true, "target": "code", "dims": 384, "count": 1234 },
  "sqliteVec": { "enabled": true, "available": false }
}
```

**Rules**
- `available` means the artifact is present and loadable.
- `enabled` means config requested it.
- `target` is only required if the backend depends on vector variant selection.

### 7.2.5 Tests for manifest completeness and strict discovery

**Add new tests**
- `tests/indexing/embeddings/manifest-embeddings-pieces.test.js`
  - Build stage2 index for fixture repo (stub embeddings).
  - Run build-embeddings stage3.
  - Load `<indexDir>/pieces/manifest.json`.
  - Assert it includes entries for:
    - `dense_vectors`
    - `dense_vectors_hnsw` and `dense_vectors_hnsw_meta` (if hnswlib is installed; if not installed, assert they are absent)
    - `dense_vectors_lancedb` and `dense_vectors_lancedb_meta` (if lancedb is installed; else absent)
  - Assert that if `dense_vectors_hnsw.bin` exists, manifest includes it.
  - Assert that if manifest lists it, file exists.

- `tests/retrieval/backend/retrieval-strict-manifest-embeddings.test.js`
  - Create an indexDir with embeddings artifacts present but remove `pieces/manifest.json`.
  - Run `search.js` in strict mode (default) and assert it fails with `ERR_MANIFEST_MISSING` (or equivalent).
  - Run `search.js --non-strict` (if supported) and assert it can still run (legacy fallback), but logs a warning.

**Update existing tests**
- `tests/indexing/artifacts/artifact-io-manifest-discovery.test.js`
  - Extend to also verify `dense_vectors` and `dense_vectors_hnsw_meta` cannot be loaded without manifest in strict mode once the loader changes land.

---

## 7.3 Quantization invariants end-to-end

### Why this exists

There are multiple quantization entry points:
- `src/shared/embedding-utils.js` has both `quantizeEmbeddingVector()` (unclamped levels) and `quantizeEmbeddingVectorUint8()` (clamped).
- Several call sites use the unclamped path and then pack into a Uint8Array, which can wrap values.

This phase enforces correct quantization everywhere.

### 7.3.1 Clamp quantization levels globally to [2, 256]

**Touchpoints**
- `src/storage/sqlite/vector.js` (~L1–L71) (function `resolveQuantizationParams`)
- `src/shared/embedding-utils.js` (~L1–L176) (`quantizeEmbeddingVector`, `quantizeEmbeddingVectorUint8`, `dequantizeUint8ToFloat32`)
- `src/index/embedding.js` (~L1–L56) (`quantizeVec`, `quantizeVecUint8`)
- `tools/build/embeddings/embed.js` (~L1–L119)
- `src/storage/sqlite/build/incremental-update.js` (~L1–L567)
- `src/index/build/file-processor/embeddings.js` (~L1–L260)

**Required changes**
1. In `resolveQuantizationParams()`:
   - Clamp `levels` to integer in `[2, 256]`.
   - Rationale: prevents overflow **and** avoids divide-by-zero in `scale = (maxVal - minVal) / (levels - 1)` when `levels <= 1`.
   - If invalid, default to 256.
2. In `quantizeEmbeddingVector()`:
   - Either:
     - clamp internally (same as Uint8 version), OR
     - mark as internal-only and ensure no production path uses it.
   - Phase 7 requirement: **production quantization must not be able to output values >255**.
3. Update `src/index/embedding.js`:
   - Make `quantizeVec()` call the clamped implementation OR remove it in favor of `quantizeVecUint8()` and update call sites.

### 7.3.2 Ensure all stored “uint8 artifacts” are actually uint8-safe

**Artifacts affected**
- `dense_vectors_uint8.json` (`dense_vectors`)
- `dense_vectors_doc_uint8.json` (`dense_vectors_doc`)
- `dense_vectors_code_uint8.json` (`dense_vectors_code`)
- SQLite dense tables written by `tools/build/embeddings/sqlite-dense.js`
- HNSW/LanceDB build paths that dequantize from uint8

**Required changes**
- Update `tools/build/embeddings/embed.js` to quantize using the clamped path.
  - Prefer storing vectors as plain arrays of integers 0..255 in JSON.
- Update `src/storage/sqlite/build/incremental-update.js` to use a clamped quantizer before packing into Uint8Array.

### 7.3.3 Persist quantization metadata where it is needed

Current code often assumes `minVal=-1` and `levels=256`, which breaks if config differs.

**Phase 7 rule**
- Any component that needs to dequantize MUST have access to the exact `(minVal, maxVal, levels)` used (or an equivalent representation).

**Implementation choice**
- Add optional fields to the dense vector artifacts and backend meta files:
  - For `dense_vectors*` artifacts: add `minVal`, `maxVal`, `levels`, and optionally `quantization` object.
  - For HNSW meta and LanceDB meta: add the same quantization fields.
  - This is safe because JSON schemas allow additionalProperties.

**Touchpoints**
- Writers:
  - `tools/build/embeddings/runner.js` (~L1–L763) (when writing dense_vectors*.json and meta)
  - `tools/build/embeddings/hnsw.js` (~L1–L115) (meta output)
  - `tools/build/embeddings/lancedb.js` (~L1–L143) (meta output)
- Readers:
  - `src/retrieval/rankers.js` (~L1–L292) (rankDenseVectors: stop hardcoding `minVal=-1`)
  - `src/retrieval/sqlite-helpers.js` (~L1–L544) (dense meta: stop hardcoding minVal)
  - `tools/build/embeddings/lancedb.js` (~L1–L143) (dequantizeUint8ToFloat32 must use correct quantization)

### 7.3.4 Update LanceDB build to dequantize correctly

**Touchpoints**
- `tools/build/embeddings/lancedb.js` (~L1–L143)

**Required changes**
- `buildBatch()` currently calls `dequantizeUint8ToFloat32(row.vec)` without passing params (defaults to -1..1, 256).
- Update `writeLanceDbIndex()` signature to accept quantization params (or `scale + minVal`), and pass through from `runner.js`.

**Correctness tests**
- A dedicated test should:
  - Configure quantization levels != 256 (e.g., 128) in a temporary repo config
  - Build embeddings and LanceDB index
  - Query LanceDB directly (or via search) and assert results are stable and not obviously degraded vs Dense

### 7.3.5 Tests for quantization invariants

**Update existing tests**
- `tests/quantize-embedding-utils.js` (if exists) or add new:
  - Assert clamping:
    - levels < 2 => 2
    - levels > 256 => 256
  - Assert no value in output exceeds 255.

**Add new test**
- `tests/embedding-quantization-no-wrap.js`
  - Construct an embedding vector with values near 1.0
  - Use quantization levels 512 in config (intentionally invalid)
  - Run the embedding build path that writes JSON and SQLite
  - Assert:
    - dense vectors JSON only contains integers 0..255
    - sqlite dense table values match expected quantization (no modulo wrap)
    - `index_state.embeddings.embeddingIdentity.quantization.levels` shows the clamped value.

---

## 7.4 Normalization policy consistency

### Why this exists

Normalization affects:
- exact dense ranking (dot product expects normalized vectors for cosine equivalence)
- ANN backends (HNSW metric, LanceDB metric)
- caching (embedding identity includes normalize)

### 7.4.1 Define and enforce normalization rules

**Rule 1**
- If `embeddingIdentity.normalize === true`, then:
  - code, doc, and merged vectors MUST be L2 normalized before storage.
  - Any dequantized float vectors used for ANN MUST be normalized (or equivalent).

**Rule 2**
- If `embeddingIdentity.normalize === false`, then:
  - storage may contain raw vectors, but ANN backend selection must respect configured metric.

**Touchpoints**
- `src/shared/embedding-adapter.js` (~L1–L158) (ensures embedding providers normalize)
- `tools/build/embeddings/embed.js` (~L1–L119) (mergeEmbeddingVectors + normalizeEmbeddingVector)
- `src/index/build/file-processor/embeddings.js` (~L1–L260) (inline embeddings path)
- `tools/build/embeddings/runner.js` (~L1–L763) (cache load path where HNSW vectors are dequantized)

**Required changes**
- Ensure build-embeddings cache load path normalizes HNSW float vectors whenever identity.normalize is true, not only when `hnswConfig.space === 'cosine'`.
- Ensure `mergeEmbeddingVectors()` behavior is explicitly specified:
  - If doc vector is missing (zeros), merged should still normalize correctly and not bias scale.
  - Add test coverage.

### 7.4.2 Tests for normalization consistency

**Add test**
- `tests/indexing/embeddings/embedding-normalization-consistency.test.js`
  - Use stub embeddings that produce a known non-normalized vector.
  - Ensure the pipeline normalizes it before storage when normalize=true.
  - Ensure merged vector equals normalized(mean(code, doc)) within tolerance.

**Update ANN tests**
- `tests/retrieval/ann/hnsw-ann.test.js` and `tests/retrieval/ann/lancedb-ann.test.js` should assert:
  - embeddings meta includes normalize=true
  - ANN meta metric/space matches expected
  - Query-time similarity ordering matches Dense within tolerance.

---

## 7.5 LanceDB robustness improvements

### Why this exists

Candidate filtering semantics and robustness issues:
- When candidateSet is large and pushdown is disabled, a single fixed-limit query may return fewer than topN matches after filtering.
- Connection caching is not concurrency-safe (race opens).
- Filter clause construction must be safe and correct.

### 7.5.1 Implement iterative overfetch for candidateSet filtering

**Touchpoints**
- `src/retrieval/lancedb.js` (~L1–L180) (function `searchLanceDbCandidates`)

**Required behavior**
- When `candidateSet` is provided:
  - Try pushdown if candidateSet is numeric and <= `LANCE_CANDIDATE_PUSH_LIMIT`.
  - Else run iterative overfetch:
    1. Start with `limit = max(topN*4, topN+10)`.
    2. Execute query with that limit.
    3. Filter results by candidateSet.
    4. If filtered count < topN AND raw results length == limit:
       - increase limit (e.g., x2) up to a cap (candidateCount or a global max).
       - repeat.
     5. Stop when enough results or when limit reaches cap.

**Correctness requirement**
- Deterministic: same inputs yield same outputs (stable sort tie-breakers).
- Efficient: cap iterations (e.g., max 4 passes).

### 7.5.2 Make connection caching concurrency-safe

**Touchpoints**
- `src/retrieval/lancedb.js` (~L1–L180) (`connectionCache`)

**Required changes**
- Store a Promise in the cache while connecting:
  - If concurrent calls happen, they await the same Promise.
- If connection fails, delete cache entry so later attempts can retry.

### 7.5.3 Harden filter construction

**Touchpoints**
- `src/retrieval/lancedb.js` (~L1–L180)

**Required changes**
- Validate `idColumn` is a safe identifier (e.g., `/^[A-Za-z_][A-Za-z0-9_]*$/`).
- Ensure `candidateSet` values are integers, not floats.

### 7.5.4 Tests for LanceDB candidate filtering

**Add new test**
- `tests/lancedb-candidate-filtering.js`
  - Use a stub dataset large enough that candidateSet > push limit.
  - Use a candidateSet that excludes most top hits.
  - Assert:
    - The function still returns topN results within candidateSet (iterative overfetch works).
    - Stats indicate multiple passes were executed (optional metric in logs).

---

### 7.5.5 Acceptance criteria

- Candidate-set filtering works for both small and large candidate sets:
  - If `candidateSet.size >= topN`, the function returns **at least** `topN` results whenever the underlying dataset contains enough matches.
  - If the dataset (or candidateSet) cannot produce `topN` matches, it returns as many as possible without throwing.
- Connection caching is concurrency-safe:
  - Concurrent queries to the same LanceDB directory do not trigger multiple `connect()` calls.
- Pushdown filtering is used when safe:
  - When `candidateSet` is numeric and `candidateSet.size <= LANCE_CANDIDATE_PUSH_LIMIT`, the query uses a `where` clause pushdown.

### 7.5.6 Tests

Add/Update the following tests (names are prescriptive; adjust location if the repo’s test layout requires flat files):

- `tests/retrieval/ann/lancedb-candidate-filtering.test.js` (new)
  - Exercises iterative overfetch when candidateSet is large.
- `tests/retrieval/ann/lancedb-connection-cache.test.js` (new)
  - Verifies promise-cached connections prevent double-open under concurrency.
- `tests/retrieval/ann/lancedb-filter-pushdown.test.js` (new)
  - Verifies pushdown is used only for safe numeric candidate sets.
- `tests/retrieval/ann/lancedb-ann.test.js` (existing)
  - Extend assertions if needed to confirm ANN backend is LanceDB and returns stable results.



## 7.6 HNSW signature compatibility and observability

### Why this exists

- `hnswlib-node` API signatures differ across versions; current code may pass the wrong second argument to `readIndexSync`.
- Insert failures are not sufficiently observable.
- Variant selection must align with denseVectorMode if Phase 7 supports doc/code/merged.

### 7.6.1 Make loadHnswIndex tolerant to signature differences

**Touchpoints**
- `src/shared/hnsw.js` (~L1–L160) (function `loadHnswIndex`)
- `src/shared/hnsw.js` (~L1–L160) (function `resolveHnswPaths` if extended to support variants)

**Required changes**
- Detect `readIndexSync` signature:
  - If it expects `(path, maxElements)` then pass maxElements (number).
  - If it expects `(path, allowReplaceDeleted)` then pass boolean.
  - If unknown, try safe fallbacks with try/catch:
    1. call with just `(path)`
    2. call with `(path, maxElements)`
    3. call with `(path, allowReplaceDeleted)`
  - Use meta/config to choose expected dims/count.

**Observability**
- When fallback path is used, log a warning once with:
  - detected arity
  - attempted signatures
  - final chosen signature

### 7.6.2 Build and load HNSW indices for merged/doc/code variants

**Touchpoints**
- Writer:
  - `tools/build/embeddings/runner.js` (~L1–L763)
  - `tools/build/embeddings/hnsw.js` (~L1–L115)
- Reader:
  - `src/retrieval/cli-index.js` (~L1–L416) (HNSW load)
  - `src/retrieval/ann/providers/hnsw.js` (~L1–L27) (already uses idx.hnsw)
  - `src/shared/hnsw.js` (~L1–L160) path resolver

**Required behavior**
- For each mode, if embeddings are ready and HNSW is enabled and available:
  - Build HNSW for:
    - merged vectors (`dense_vectors_hnsw.*`)
    - doc vectors (`dense_vectors_doc_hnsw.*`)
    - code vectors (`dense_vectors_code_hnsw.*`)
- At query-time, select which HNSW index to use based on `resolvedDenseVectorMode`.
  - This mirrors LanceDB behavior and ensures parity.
- Meta files MUST include:
  - dims, count
  - space/metric
  - efSearch/efConstruction/m
  - embeddingIdentityKey (or at least model id)
  - quantization parameters (or scale + minVal)
  - createdAt timestamp

### 7.6.3 Improve insert failure observability

**Touchpoints**
- `tools/build/embeddings/hnsw.js` (~L1–L115)

**Required changes**
- Preserve and rely on the existing atomic write pattern:
  - write to a temp path
  - atomically replace the target `.bin`
  - keep a `.bak` via `replaceFile({ keepBackup: true })`
  - never delete `.bak` unless a subsequent successful load of the new `.bin` is confirmed (and even then, deletion is optional).
- In `writeIndex()`:
  - Collect insertion failures:
    - `{ idx, label, errorMessage }` (label is the chunk id)
  - If count mismatch:
    - write a JSON file alongside meta (e.g., `dense_vectors_hnsw.failures.json`) or include failure summary in meta
    - include top N failures in error message for debugging
- Ensure build fails loudly if insertion failures occur (unless explicitly configured to allow partial indexes).

### 7.6.4 Tests for HNSW variant selection and signature fallback

**Update existing tests**
- `tests/retrieval/ann/hnsw-ann.test.js`
  - Once doc/code variants are built, assert those files exist too.
- `tests/retrieval/ann/hnsw-atomic.test.js`
  - Ensure .bak fallback still works with new load logic.

**Add new test**
- `tests/retrieval/ann/hnsw-target-selection.test.js`
  - Build embeddings with stub embeddings.
  - Force `denseVectorMode=code` and ensure HNSW provider loads the code variant.
  - Force `denseVectorMode=doc` and ensure doc variant loads.

---

### 7.6.5 Acceptance criteria

- HNSW loading is compatible across supported `hnswlib-node` versions:
  - `loadHnswIndex()` successfully loads a valid index regardless of the `readIndexSync` signature variant.
  - If a signature mismatch occurs, fallback logic selects a working call shape and logs a single diagnostic warning.
- Insert failures are observable and actionable:
  - If HNSW insertion fails for any vector, the build either:
    - fails with a clear error including a failure summary, OR
    - (only if explicitly configured) produces a partial index and writes a failures report.
- Atomicity behavior remains correct:
  - If `.bak` exists and the main `.bin` is corrupt, load falls back to `.bak` and still serves results.

### 7.6.6 Tests

Add/Update the following tests:

- `tests/retrieval/ann/hnsw-load-signature.test.js` (new)
  - Mocks multiple `readIndexSync` signatures and verifies fallback behavior.
- `tests/retrieval/ann/hnsw-insert-failures.test.js` (new)
  - Forces insertion failures and asserts a failures report (or error) is emitted.
- `tests/retrieval/ann/hnsw-ann.test.js` (existing)
  - Extend to verify doc/code variant selection if Phase 7 builds those indices.
- `tests/retrieval/ann/hnsw-atomic.test.js` (existing)
  - Must continue to pass; ensures `.bak` fallback behavior remains intact.
- `tests/retrieval/ann/hnsw-candidate-set.test.js` (existing)
  - Must continue to pass; candidate-set filtering for HNSW remains correct.



## 7.7 Backend policy and ranking equivalence

### Why this exists

We need a single coherent way to:
- select which dense vectors are used for ranking (`denseVectorMode`)
- select which ANN target is used (must align with denseVectorMode)
- compare backends on a stable fixture (parity)

### 7.7.1 Wire denseVectorMode from config/CLI into retrieval

**Touchpoints**
- `docs/guides/search.md` (~L1–L74) (already references denseVectorMode)
- `docs/guides/embeddings.md` (update to reflect denseVectorMode + strict manifest behavior)
- `docs/config/schema.json` and/or `docs/config/inventory.md` (add `search.denseVectorMode` + CLI flag documentation)
- `src/retrieval/cli/normalize-options.js` (~L1–L273) (currently hardcodes denseVectorMode='merged')
- `src/retrieval/cli/options.js` (~L1–L141) (CLI option definitions)
- `src/retrieval/cli/query-plan.js` (~L1–L205) (already passes denseVectorMode into plan)
- `src/retrieval/query-intent.js` (~L1–L84) (resolveIntentVectorMode)

**Required changes**
- Add CLI option: `--dense-vector-mode merged|doc|code|auto`
  - default should match existing behavior (`merged`) to avoid breaking changes.
- Config key is `search.denseVectorMode` (aligns with existing defaults + docs).
- Ensure `resolvedDenseVectorMode` is computed once and passed into `loadSearchIndexes()` (already).
- Ensure `resolveIntentVectorMode()` never returns `'auto'` when intent provided and valid; else allow 'auto' as fallback.
- Configuration precedence is explicit: **CLI > user config > defaults**, and log when CLI overrides a config value.

### 7.7.2 Ensure ANN backend target selection matches denseVectorMode

**Touchpoints**
- LanceDB:
  - `src/shared/lancedb.js` (~L1–L65) (`resolveLanceDbTarget`) ✅ already supports.
- HNSW:
  - `src/shared/hnsw.js` (~L1–L160) path resolver must support variants.
- SQLite-vec:
  - `tools/build/embeddings/sqlite-dense.js` (~L1–L209) and `tools/sqlite/vector-extension.js` (~L1–L393)
  - If SQLite-vec is kept as merged-only, it must be documented and enforced.

**Required behavior**
- For each mode, the ANN provider uses the same vector variant as `idx.denseVec` uses.
- If a backend cannot support the selected variant, it must:
  - either fail with a clear error (if explicitly requested), or
  - fall back with an explicit warning (if auto-selected).

### 7.7.3 Parity tests: dense vs ANN backends

**Add new integration test**
- `tests/ann-parity.js`
  - Build index + embeddings for fixture repo with stub embeddings.
  - Run search with:
    - `--ann-backend dense`
    - `--ann-backend lancedb`
    - `--ann-backend hnsw`
  - For each, capture topK doc ids and scores.
  - Assert:
    - Dense is the reference.
    - ANN results contain the same top results in the same order for a deterministic stub embedding (or within a small tolerance / allow ties).
  - Run for multiple `denseVectorMode` values:
    - merged
    - code
    - doc

**Note**
- ANN parity can be relaxed for real embeddings, but for stub embeddings it should be exact or nearly exact.

---

### 7.7.4 Acceptance criteria

- `denseVectorMode` is end-to-end functional:
  - CLI/config can set `merged|doc|code|auto`.
  - The resolved mode is applied consistently to:
    - exact dense ranking
    - ANN target selection (LanceDB + HNSW; SQLite-vec if supported)
- Backend selection is explicit and explainable:
  - If a requested backend cannot satisfy the resolved vector mode, the system either errors clearly or falls back with an explicit warning (depending on selection policy).
- ANN parity tests pass on deterministic fixtures:
  - With stub embeddings, Dense vs ANN results match (or are within the defined tolerance window).

### 7.7.5 Tests

Add/Update tests:

- `tests/retrieval/ann/ann-parity.test.js` (new; can be implemented as a Node script in this repo’s style)
  - Compares Dense vs LanceDB vs HNSW across vector modes.
- `tests/retrieval/ann/dense-vector-mode.test.js` (new)
  - Verifies `resolveIntentVectorMode()` and `resolveDenseVector()` behaviors.
- `tests/retrieval/ann/ann-backend-selection.test.js` (new)
  - Verifies the capability matrix and fallback/error behaviors.
- Existing backend smoke tests:
  - `tests/retrieval/ann/lancedb-ann.test.js`
  - `tests/retrieval/ann/hnsw-ann.test.js`



## 7.8 Storage resilience (LMDB/SQLite/cache)

### 7.8.1 LMDB mapSize planning

**Touchpoints**
- `tools/build/lmdb-index.js` (~L1–L311)
- `src/storage/lmdb/schema.js` (~L1–L49) (meta keys)
- Tests: `tests/storage/lmdb/lmdb-backend.test.js` (~L1–L122), `tests/storage/lmdb/lmdb-corruption.test.js` (~L1–L105), `tests/storage/lmdb/lmdb-report-artifacts.test.js` (~L1–L125)

**Required behavior**
- Compute a conservative mapSize before writing:
  - Derive an estimate from artifact sizes (chunk_meta, postings, file_relations, etc.)
  - Add overhead factor (e.g., *2.0) and minimum floor (e.g., 256MB)
  - Cap to a maximum if needed
- Write the chosen mapSize into LMDB meta keys so debugging is easier.

### 7.8.2 SQLite dense writer safety for shared DB paths

**Touchpoints**
- `tools/build/embeddings/sqlite-dense.js` (~L1–L209)
- `tools/dict-utils/paths/db.js` (~L1–L62) (resolveSqlitePaths)

**Current risk**
- `DELETE FROM dense_vectors_ann` is unscoped; if code and prose share the same DB file, one run can delete the other mode’s ANN table.

**Required change**
Choose one (documented) approach:
- Preferred: mode-specific ANN table names:
  - `dense_vectors_ann_code`, `dense_vectors_ann_prose`
- Alternative: add `mode` column to vector table and delete by mode (if supported by extension).

Update all query code accordingly:
- `tools/sqlite/vector-extension.js` query table name must match.

### 7.8.3 Embedding cache preflight metadata

**Touchpoints**
- `tools/build/embeddings/cache.js` (~L1–L26)
- `tools/build/embeddings/runner.js` (~L1–L763)

**Goal**
- Avoid scanning full cache to validate dims/identity each run on huge repos.

**Required change**
- Write a cache meta file per (mode, identityKey), e.g.:
  - `<cacheRoot>/<mode>/cache_meta.json`
  - includes: identityKey, dims, model, normalize, quantization, createdAt
- On startup, runner loads this meta and uses it for fast validation.
- If missing, fall back to current scan and then write meta.

### 7.8.4 Tests for storage resilience

**Update tests**
- LMDB tests should continue to pass; add an assertion that mapSize meta exists (if added).
- Add a new test for shared SQLite DB path configuration:
  - Configure codeDbPath == proseDbPath in a temp user config
  - Build embeddings for code and prose
  - Assert both modes’ ANN tables exist and are not deleted by the other.

---

### 7.8.5 Acceptance criteria

- LMDB build is resilient:
  - `tools/build/lmdb-index.js` chooses a mapSize that prevents MapFull errors on Phase 7 fixtures.
  - The chosen mapSize is recorded in LMDB metadata for debugging.
- SQLite ANN tables are mode-safe:
  - If code and prose share a DB file, running embeddings build for one mode does not delete the other mode’s ANN data.
- Cache preflight avoids full scans in the common case:
  - When cache meta exists, runner does not scan the entire cache to validate dims/identity.

### 7.8.6 Tests

Add/Update tests:

- `tests/storage/lmdb/lmdb-mapsize.test.js` (new)
  - Builds LMDB for a fixture repo and asserts no MapFull and that mapSize meta is present.
- `tests/storage/sqlite/ann/sqlite-ann-mode-scope.test.js` (new)
  - Configures shared DB paths and asserts both modes’ ANN tables remain intact.
- `tests/shared/cache/cache-preflight-meta.test.js` (new)
  - Ensures cache meta is written and later used to avoid scanning.
- Existing LMDB tests (must continue to pass):
  - `tests/storage/lmdb/lmdb-backend.test.js`
  - `tests/storage/lmdb/lmdb-corruption.test.js`
  - `tests/storage/lmdb/lmdb-report-artifacts.test.js`
- Storage resilience integration test:
  - `tests/storage/embeddings/embeddings-backend-resilience.test.js` (new)
    - Simulates partial backend failures (e.g., LanceDB build fails, HNSW succeeds) and asserts:
      - index_state advertises only available backends
      - retrieval does not attempt to use missing backend

### 7.8.7 Edge cases and fallback behavior

- Partial backend build failure:
  - If one backend fails (e.g., LanceDB directory missing/corrupt) but dense vectors exist:
    - `index_state.embeddings.ready` may still be true (dense vectors are usable).
    - `index_state.embeddings.backends.lancedb.available` must be false.
    - Retrieval must either fall back to another backend or Dense, without crashing.
- Manifest mismatch:
  - If an artifact exists on disk but is missing from manifest (strict mode):
    - validation should fail loudly
    - retrieval should treat it as unavailable and surface a clear message rather than guessing.

### 7.8.8 Final Phase 7 audit (mandatory)

- After all Phase 7 tasks land, perform a focused audit of **search** and **embeddings** code/tests:
  - scan for any remaining manifest-by-pass reads in strict mode
  - confirm denseVectorMode and ANN target selection are applied consistently
  - review tests for missing lane assignments or optional-dependency guards
  - update any additional files or tests discovered during the audit



## Mapping: Where this work fits in the repo

### ANN backends
- LanceDB:
  - Build: `tools/build/embeddings/lancedb.js`
  - Runtime: `src/retrieval/lancedb.js`, `src/retrieval/ann/providers/lancedb.js`, `src/shared/lancedb.js`
- HNSW:
  - Build: `tools/build/embeddings/hnsw.js`
  - Runtime: `src/shared/hnsw.js`, `src/retrieval/ann/providers/hnsw.js`, `src/retrieval/cli-index.js`
- SQLite vector extension:
  - Build: `tools/build/embeddings/sqlite-dense.js`
  - Runtime: `tools/sqlite/vector-extension.js`, `src/retrieval/sqlite-helpers.js`

### Artifact contract / manifest
- Contract docs:
  - `docs/contracts/public-artifact-surface.md`
  - `docs/contracts/artifact-schemas.md`
- Schema code:
  - `src/contracts/registry.js`
  - `src/contracts/schemas/artifacts.js`
- Manifest tooling:
  - `tools/build/embeddings/manifest.js`
  - `src/shared/artifact-io/manifest.js`

---

## Addendum: Strict manifest compliance requirements

This addendum is **mandatory** for Phase 7 completeness.

### A. Strict mode must not guess filenames

Any code path that loads artifacts in strict mode MUST NOT:
- `fs.readFile(path.join(dir, 'dense_vectors_uint8.json'))`
- check for `dense_vectors_hnsw.bin` via guessed filename
- scan directories for `.lancedb`

Instead, strict mode MUST:
- load manifest (`pieces/manifest.json`)
- resolve artifact paths through `resolveArtifactPresence()`

### B. Non-strict fallback is allowed only as a temporary compatibility bridge

If non-strict mode is supported:
- It should be explicitly gated by a CLI flag (e.g., `--non-strict`) or an internal option.
- It should emit a warning that strict contract is being bypassed.

---

## Fixtures list

Use these fixtures in tests. Prefer deterministic, small fixtures; do not introduce “random” corpora that make ANN results flaky.

### Existing fixture repos already in-tree
- `tests/fixtures/sample/`  
  - Primary small deterministic fixture repo used broadly in existing tests.

### Phase 7 fixture repos to add (or verify) under `tests/fixtures/embeddings/`

If these directories do not exist yet, Phase 7 must create them exactly as specified.

1. `tests/fixtures/embeddings/basic-repo/`
   - Purpose: baseline end-to-end embeddings + ANN build on a tiny repo.
   - Must include:
     - At least 2 small code files (e.g., `src/a.js`, `src/b.py`)
     - At least 1 prose file (e.g., `README.md`)
   - Expected behavior:
     - Both `index-code` and `index-prose` produce chunk_meta and dense vectors artifacts.
     - ANN backends can be built if optional deps exist.

2. `tests/fixtures/embeddings/missing-vectors/`
   - Purpose: validate that “missing code/doc vectors” are handled deterministically (zero-fill), and merged vectors normalize correctly.
   - Must include:
     - A small code file with no doc/comments (so `docVector` can be missing/empty in some build paths)
     - A prose file that produces doc-only content
   - Expected behavior:
     - `dense_vectors_doc` for some chunks is all-zero.
     - Merged vector is normalized and non-NaN.
     - ANN builders do not crash on many identical doc vectors.

3. `tests/fixtures/embeddings/quantization-caps/`
   - Purpose: validate quantization clamping and “no wrap” invariants.
   - Must include:
     - A repo with enough chunks to exercise vector writing (even 5–10 chunks is fine).
     - A repo-local config that intentionally sets `quantization.levels` out of range (e.g., 9999).
   - Expected behavior:
     - Artifacts contain only 0..255 values.
     - `embeddingIdentity.quantization.levels` reflects the **clamped** effective value.

### Stub embeddings mode
To keep tests deterministic and fast, use stub embeddings wherever possible:
- Environment: `PAIROFCLEATS_EMBEDDINGS=stub` (or the repo’s equivalent stub toggle)
- Requirement:
  - Stub embeddings must produce deterministic vectors based only on input text and requested dims.
  - They must support both code and prose modes.

## Compat migration checklist Phase 7

Phase 7 intentionally adds fields and manifest entries. It must remain safe to run against older builds and older queue payloads.

Checklist:

- [ ] **Do not rename dense vector filenames on disk.**  
  Keep:
  - `dense_vectors_uint8.json`
  - `dense_vectors_doc_uint8.json`
  - `dense_vectors_code_uint8.json`  
  Phase 7 may add optional metadata fields to these JSON objects, but must not change filenames.

- [ ] **Queue payload versioning is explicit and safe.**
  - New jobs must include `embeddingPayloadFormatVersion: 2`.
  - Worker must either:
    - accept v1 payloads and upgrade them with a warning, or
    - refuse v1 payloads with a clear error message that points to remediation.
  - Never “silently reinterpret” ambiguous fields without logging.

- [ ] **index_state fields are additive.**
  - Preserve existing `index_state.embeddings.enabled/ready/service/mode` semantics.
  - Add new fields (`pending`, `embeddingIdentity`, `embeddingIdentityKey`, `backends`) without breaking older readers.

- [ ] **Strict manifest compatibility.**
  - Older builds may not include embedding artifacts in `pieces/manifest.json`.
  - In strict mode, treat missing manifest entries as “artifact unavailable” and surface a clear validation error (do not guess filenames).
  - If non-strict mode is supported, it may fall back to guessed filenames but must warn.

- [ ] **Optional dependencies remain optional.**
  - If `hnswlib-node` is not installed:
    - Build should skip HNSW gracefully.
    - Manifest must not list HNSW artifacts.
    - Retrieval must not advertise HNSW as available.
  - If `lancedb` is not installed:
    - Build should skip LanceDB gracefully.
    - Manifest must not list LanceDB artifacts.
    - Retrieval must not advertise LanceDB as available.
  - If `sqlite-vec` is not available:
    - Build should skip sqlite-vec ANN tables/markers.
    - Manifest must not list sqlite-vec markers.
    - Retrieval must not advertise sqlite-vec as available.
  - **Tests for optional deps must skip (not fail) when deps are missing**, with a clear skip message.
    - Document this rule for all optional-dep tests in `docs/testing/truth-table.md` (or equivalent testing guide).
    - Centralize skip checks in `tests/helpers/optional-deps.js` and reuse across tests.

- [ ] **Quantization clamp is allowed to invalidate caches.**
  - If an out-of-range `levels` value previously produced incorrect artifacts, Phase 7 clamp is a correctness fix.
  - Any resulting cache invalidation is expected; document it and ensure failures are clear (“identityKey changed”).

## Artifacts contract appendix

This appendix consolidates the *minimum* contract required for Phase 7 so implementers do not need to cross-reference multiple docs while coding. It is additive with (and must not contradict) `docs/contracts/public-artifact-surface.md`.

### A. Dense vector artifacts

These artifacts are JSON objects whose `vectors` field contains the quantized vectors.

#### A.1 `dense_vectors`
- Manifest name: `dense_vectors`  
- On-disk file: `dense_vectors_uint8.json`

#### A.2 `dense_vectors_doc`
- Manifest name: `dense_vectors_doc`  
- On-disk file: `dense_vectors_doc_uint8.json`

#### A.3 `dense_vectors_code`
- Manifest name: `dense_vectors_code`  
- On-disk file: `dense_vectors_code_uint8.json`

#### Required keys (all three)
- `dims` (int)  
- `vectors` (array)  
- `scale` (number)

#### Optional keys (recommended in Phase 7)
- `model` (string or null)
- `minVal` (number)
- `maxVal` (number)
- `levels` (int)
- `quantization` (object, if you want a structured form)
- `embeddingIdentityKey` (string)
- `createdAt` (ISO timestamp)

#### Vector invariants
- For every vector `v` in `vectors`:
  - `v.length === dims`
  - every element is an integer in `[0, 255]`
- If a vector is missing upstream (no doc text, etc), zero-fill is allowed but must be deterministic.

---

### B. HNSW artifacts

HNSW consists of a binary index file plus a JSON meta file.

#### Names and paths (merged/doc/code)
- `dense_vectors_hnsw` → `dense_vectors_hnsw.bin`
- `dense_vectors_hnsw_meta` → `dense_vectors_hnsw.meta.json`
- `dense_vectors_doc_hnsw` → `dense_vectors_doc_hnsw.bin`
- `dense_vectors_doc_hnsw_meta` → `dense_vectors_doc_hnsw.meta.json`
- `dense_vectors_code_hnsw` → `dense_vectors_code_hnsw.bin`
- `dense_vectors_code_hnsw_meta` → `dense_vectors_code_hnsw.meta.json`

#### B.1 HNSW meta required keys
- `dims` (int)
- `count` (int)
- `space` (string; e.g. `cosine|l2|ip`)

#### B.2 HNSW meta optional keys (recommended)
- `efSearch` (int)
- `m` (int)
- `efConstruction` (int)
- `expectedModel` (string; legacy, if present)
- `identityKey` or `embeddingIdentityKey` (string)
- `createdAt` (ISO timestamp)
- quantization metadata (`minVal/maxVal/levels` or equivalent)

#### B.3 HNSW binary file invariants
- The `.bin` file is treated as an opaque artifact for the contract.
- It MUST be discoverable via the manifest in strict mode.
- `.bak` files are implementation details and must not be separately listed in the manifest.

---

### C. LanceDB artifacts

LanceDB consists of a directory plus a JSON meta file.

#### Names and paths (merged/doc/code)
- `dense_vectors_lancedb` → `dense_vectors.lancedb/`
- `dense_vectors_lancedb_meta` → `dense_vectors.lancedb.meta.json`
- `dense_vectors_doc_lancedb` → `dense_vectors_doc.lancedb/`
- `dense_vectors_doc_lancedb_meta` → `dense_vectors_doc.lancedb.meta.json`
- `dense_vectors_code_lancedb` → `dense_vectors_code.lancedb/`
- `dense_vectors_code_lancedb_meta` → `dense_vectors_code.lancedb.meta.json`

#### C.1 LanceDB meta required keys
- `dims` (int)
- `count` (int)
- `metric` (string; e.g. `cosine|l2|dot`)

#### C.2 LanceDB meta additional keys (recommended)
- `table` (string; table name)
- `idColumn` (string; must match how IDs are stored, typically `id`)
- `embeddingColumn` (string; column containing vector embedding)
- `identityKey` or `embeddingIdentityKey` (string)
- `createdAt` (ISO timestamp)
- quantization metadata (`minVal/maxVal/levels` or equivalent)

#### C.3 LanceDB directory invariants
- The directory MUST be discoverable via the manifest in strict mode.
- Directory contents are considered backend-specific implementation details, but must remain stable enough for readers to open.

---

### D. Manifest entry invariants

Every manifest entry must include:
- `name` (string; canonical artifact name)
- `path` (string; relative to the indexDir)
- `format` (string; one of `json|jsonl|bin|dir`)
- `bytes` (int)  
  - For `dir` entries, `bytes` may be omitted. If present, it must be deterministic.

Recommended fields:
- `sha256` for file entries (`json`, `jsonl`, `bin`)

---

### E. Cross-artifact invariants

- If `index_state.embeddings.ready === true` then the manifest MUST contain `dense_vectors`.
- If an ANN backend is reported as available in `index_state.embeddings.backends.*.available === true`, then the corresponding artifact entries MUST exist in the manifest.

--- 

# Phase 9 -- Symbol identity (collision-safe IDs) + cross-file linking

## Objective

Eliminate correctness hazards caused by non-unique, name-based joins (notably `file::name` and legacy `chunkId` usage) and replace them with a collision-safe identity layer. Use that identity to produce:

1) **Stable, segment-aware node identity** (`chunkUid`, `segmentUid`, `virtualPath`) that survives minor line shifts and prevents collisions across:
   - same-name declarations in different files,
   - same-name declarations inside different segments of the same container file,
   - repeated definitions (overloads, nested scopes, generated code patterns).

2) **A canonical symbol identity and reference contract** (`symbolKey`, `signatureKey`, `scopedId`, `symbolId`, `SymbolRef`) that:
   - is deterministic,
   - is language-agnostic at the storage boundary,
   - preserves ambiguity instead of forcing wrong links.

3) **Cross-file resolution that is import-aware and ambiguity-preserving**, using bounded heuristics and explicit `state` / `confidence` fields.

4) **First-class symbol graph artifacts** (`symbols`, `symbol_occurrences`, `symbol_edges`) that enable downstream graph analytics and product features without re-parsing code.

5) **Fail-closed identity and symbol joins:** no `file::name` fallback in strict mode; ambiguous resolutions are preserved, not guessed.

---
# Phase 9 -- Symbol identity (collision-safe IDs) + cross-file linking (detailed execution plan)



## Phase 9 objective (what "done" means)

Eliminate all correctness hazards caused by non-unique, name-based joins (notably `file::name` and legacy `chunkId` usage) and replace them with a collision-safe, stability-oriented identity layer. Use that identity to produce:

1) **Stable, segment-aware node identity** (`chunkUid`, `segmentUid`, `virtualPath`) that survives minor line shifts and prevents collisions across:
   - same-name declarations in different files,
   - same-name declarations inside different segments of the same container file,
   - repeated definitions (overloads, nested scopes, generated code patterns).

2) **A canonical symbol identity and reference contract** (`symbolKey`, `signatureKey`, `scopedId`, `symbolId`, `SymbolRef`) that:
   - is deterministic,
   - is language-agnostic at the storage boundary,
   - preserves ambiguity instead of forcing wrong links.

3) **Cross-file resolution that is import-aware and ambiguity-preserving**, using bounded heuristics and explicit confidence/status fields.

4) **First-class symbol graph artifacts** (`symbols.jsonl`, `symbol_occurrences.jsonl`, `symbol_edges.jsonl`) that enable downstream graph analytics and product features without re-parsing code.

5) **Fail-closed identity and symbol joins:** no file::name fallback in strict mode; ambiguous resolutions are preserved, not guessed.

This phase directly targets the Phase 9 intent in the roadmap ("Symbol identity (collision-safe IDs) + cross-file linking") and depends on the canonical `chunkUid` contract delivered in Phase 8. In particular, the `chunkUid` construction approach and "fail closed" requirement are consistent with the canonical identity contract described in the planning materials.

---

## Phase 9 non-goals (explicitly out of scope for Phase 9 acceptance)

These may be separate follow-on phases or optional extensions:

- Full **SCIP/LSIF/ctags hybrid symbol source registry** (runtime selection/merging) beyond ensuring the contracts can represent those IDs.
- Full module-resolution parity with Node/TS (tsconfig paths, package exports/imports, Yarn PnP, etc). Phase 9 supports **relative import resolution** only.
- Whole-program correctness for dynamic languages; Phase 9 focuses on **correctness under ambiguity** (never wrong-link) rather than "resolve everything".
- Cross-repo symbol federation.

---

## Phase 9 key decisions (locked)

These choices remove ambiguity and prevent future "forks" in implementation.

### D1) Graph node identity uses `chunkUid`, not `file::name`, not legacy `chunkId`

- **Chosen:** `chunkUid` is the canonical node identifier for graphs and cross-file joins.
- **Why:** `file::name` is not unique; `chunkId` is range-based and churns with line shifts. The roadmap's canonical identity guidance explicitly calls for a `chunkUid` that is stable under line shifts and includes segment disambiguation.

### D2) Symbol identity is a two-layer model: `symbolKey` (human/debug) + `symbolId` (portable token)

- **Chosen:** Persist both.
- **Why:** `symbolKey` is explainable and supports deterministic "rebuild equivalence" reasoning. `symbolId` is compact and future-proofs external sources (SCIP/LSIF) without schema churn.

### D3) Cross-file resolution is ambiguity-preserving

- **Chosen:** When multiple plausible targets exist, record candidates and mark the ref **ambiguous**; do not pick arbitrarily.
- **Why:** Wrong links destroy trust and cascade into graph features, risk flows, and context packs. Ambiguity can be resolved later by better signals.

### D4) Artifact emission is streaming-first and deterministically ordered

- **Chosen:** JSONL for symbol artifacts; deterministic sharding and sorting.
- **Why:** Large repos must not require in-memory materialization of symbol graphs; deterministic ordering is required for reproducible builds and regression testing.

---

## Phase 9 contracts (normative, implementation-ready)

> These contracts must be implemented exactly as specified to avoid drift.

### 9.C1 Identity contract (v1)

#### 9.C1.1 `segmentUid` (string | null)

- **Definition:** A stable identifier for a segment inside a container file (Vue SFC blocks, fenced Markdown blocks, etc).
- **Scope:** Unique within the repo (i.e., global uniqueness is acceptable and preferred).
- **Stability:** Must remain stable under *minor line shifts* outside the segment content.

**Algorithm (v1):**

```
segmentUid = "seg1:" + xxhash64(
  containerRelPath + "\0"
  + segmentType + "\0"
  + effectiveLanguageId + "\0"
  + normalizeText(segmentText)
  + "\0"
  + (parentSegmentUid ?? "")
)
```

- `normalizeText`:
  - normalize line endings to `\n`
  - preserve all non-whitespace characters
  - do not strip trailing whitespace by default (correctness-first)

#### 9.C1.2 `virtualPath` (string)

A deterministic "as-if file path" that disambiguates segments:

- If no segment: `virtualPath = fileRelPath`
- If segment: `virtualPath = fileRelPath + "#seg:" + segmentUid`

#### 9.C1.3 `chunkUid` (string)

- **Definition:** Stable-ish identifier for a chunk, used for graphs and join keys.
- **Stability:** Must remain stable when only lines outside the chunk's span shift (i.e., chunk text unchanged).
- **Collision handling:** If a collision is detected within `{virtualPath, segmentUid}`, deterministically disambiguate and record `collisionOf`.

**Algorithm (v1) -- consistent with the canonical contract described in the planning docs:**

```
span = normalizeForUid(chunkText)
pre  = normalizeForUid(text.slice(max(0, start-128), start))
post = normalizeForUid(text.slice(end, min(len, end+128)))

spanHash = xxhash64("span\0" + span)
preHash  = xxhash64("pre\0" + pre)   (only if pre.length > 0)
postHash = xxhash64("post\0" + post) (only if post.length > 0)

base = "ck64:v1:" + namespaceKey + ":" + virtualPath + ":" + spanHash
if (segment.languageId) base = "ck64:v1:" + namespaceKey + ":" + virtualPath + ":" + segment.languageId + ":" + spanHash
if (preHash)  base += ":" + preHash
if (postHash) base += ":" + postHash

chunkUid = base
```

This follows the canonical identity contract exactly (see `docs/specs/identity-contract.md` §4).

**Collision disambiguation (required):**

If `chunkUid` already exists for a different chunk under the same `virtualPath` scope:

- set `collisionOf = originalChunkUid`
- follow the canonical disambiguation steps: escalate context windows once, then assign deterministic ordinals and append `:ord<index>`.

> Note: the ordinal must be deterministic across runs given identical inputs.

#### 9.C1.4 metaV2 additions

`metaV2` MUST include:

- `chunkUid: string`
- `segmentUid: string | null`
- `virtualPath: string`

And SHOULD include (for diagnostics and future hardening):

- `identity: { v: 1, spanHash: string, preHash: string, postHash: string, collisionOf?: string }`

### 9.C2 Symbol identity contract (v1)

#### 9.C2.1 `kindGroup`

Normalize "kind" strings into a stable group set:

- `function`, `arrow_function`, `generator` → `function`
- `class` → `class`
- `method`, `constructor` → `method`
- `interface`, `type`, `enum` → `type`
- `variable`, `const`, `let` → `value`
- `module`, `namespace`, `file` → `module`
- unknown/other → `other`

#### 9.C2.2 `symbolKey`

```
symbolKey = virtualPath + "::" + qualifiedName + "::" + kindGroup
```

- `qualifiedName` defaults to `chunk.name`.
- When available, prefer container-aware names like `Class.method`.

#### 9.C2.3 `signatureKey` (optional)

```
signatureKey = qualifiedName + "::" + normalizeSignature(signature)
```

`normalizeSignature` must:
- collapse runs of whitespace to a single space
- preserve punctuation, generics, and parameter ordering

#### 9.C2.4 `scopedId`

```
scopedId = kindGroup + "|" + symbolKey + "|" + (signatureKey ?? "") + "|" + chunkUid
```

#### 9.C2.5 `symbolId`

- Deterministic, compact token:
- `symbolId = schemePrefix + sha1(scopedId)`

Where `schemePrefix` depends on source:

- Native/chunk-based: `sym1:heur:` (heuristic/native)
- SCIP: `sym1:scip:`
- LSIF: `sym1:lsif:`
- CTAGS: `sym1:ctags:`

> Phase 9 implements only `heur` generation but must preserve the scheme field in schemas.

#### 9.C2.6 `SymbolRef` (reference envelope)

A reference to a symbol, which may be resolved, ambiguous, or unresolved.

```
SymbolRefV1 = {
  v: 1,
  targetName: string,          // observed identifier, e.g. "foo" or "Foo.bar"
  kindHint: string | null,      // optional hint, e.g. "function"
  importHint: {
    moduleSpecifier: string | null,
    resolvedFile: string | null
  } | null,
  candidates: Array<{
    symbolId: string,
    chunkUid: string,
    symbolKey: string,
    signatureKey: string | null,
    kindGroup: string
  }>,
  status: "resolved" | "ambiguous" | "unresolved",
  resolved: {
    symbolId: string,
    chunkUid: string
  } | null
}
```

- `candidates` MUST be capped (see resolver caps in Phase 9.4).
- `resolved` is non-null only when `status === "resolved"`.

### 9.C3 Symbol graph artifacts (v1)

All symbol artifacts are emitted in `index-code/`:

- `symbols.jsonl`
- `symbol_occurrences.jsonl`
- `symbol_edges.jsonl`

Each line is one JSON object. Deterministic order and deterministic sharding are required.

#### 9.C3.1 `symbols.jsonl`

One record per symbol definition (i.e., per chunk with `metaV2.symbol`):

```
{
  "v": 1,
  "symbolId": "...",
  "scopedId": "...",
  "scheme": "heur",
  "symbolKey": "...",
  "signatureKey": null | "...",
  "chunkUid": "...",
  "virtualPath": "...",
  "segmentUid": null | "...",
  "file": "...",
  "lang": "...",
  "kind": "...",
  "kindGroup": "...",
  "name": "...",
  "qualifiedName": "...",
  "signature": null | "..."
}
```

#### 9.C3.2 `symbol_occurrences.jsonl`

One record per observed reference occurrence (calls, usages). At minimum:

```
{
  "v": 1,
  "fromChunkUid": "...",
  "fromFile": "...",
  "fromVirtualPath": "...",
  "occurrenceKind": "call" | "usage",
  "targetName": "...",
  "range": { "start": number, "end": number } | null,
  "ref": SymbolRefV1
}
```

#### 9.C3.3 `symbol_edges.jsonl`

One record per reference edge (call, usage) emitted from chunk relations:

```
{
  "v": 1,
  "edgeKind": "call" | "usage",
  "fromChunkUid": "...",
  "fromSymbolId": null | "...",
  "to": SymbolRefV1,
  "confidence": number,         // 0..1
  "evidence": {
    "importNarrowed": boolean,
    "matchedExport": boolean,
    "matchedSignature": boolean
  }
}
```

### 9.C4 Graph relations artifact migration (v2)

`graph_relations.json` MUST be updated such that:

- Node `id` is `chunkUid` (not legacy chunkId and not `file::name`)
- Node `attrs` include:
  - `chunkUid`, `chunkId` (legacy), `legacyKey` (for diagnostics only)
  - `symbolId` (when available)
- Edges are emitted **only** for resolved symbol edges (status=resolved)

---

## Phase 9 implementation plan (phases/subphases/tasks/tests)

### 9.1 Verify identity primitives (`segmentUid`, `chunkUid`, `virtualPath`) -- delivered in Phase 8

> If any identity primitive is missing or diverges from the canonical spec, stop Phase 9 and complete the work in Phase 8 before continuing.

**Verification checklist (no new algorithm changes in Phase 9)**
- Code presence:
  - `src/index/identity/*` helpers exist and match `docs/specs/identity-contract.md`.
  - `segmentUid`, `virtualPath`, and `chunkUid` are populated in `metaV2` for every code chunk.
- Behavior:
  - `segmentUid` stable under line shifts outside the segment.
  - `chunkUid` stable under line shifts outside the chunk span; changes when span text changes.
  - Collision handling uses canonical escalation + `:ord<N>` suffixes.
- Fail-closed identity rules:
  - Strict validation rejects any chunk missing `chunkUid`/`segmentUid`/`virtualPath`.
  - No file::name fallback for joins in strict mode.
- Tests (already required in Phase 8; rerun only if identity code changes):
  - tests/unit/segment-uid-stability.test.js (test:unit)
  - tests/unit/chunk-uid-stability.test.js (test:unit)
  - tests/validate/chunk-uid-required.test.js (test:services)
  - tests/indexing/relations/graph-chunk-id.test.js (updated to chunkUid)

---

### 9.2 Implement symbol identity (`metaV2.symbol`, `SymbolRef`) and helpers

**Primary touchpoints**
- `src/index/metadata-v2.js` — attach `metaV2.symbol` (definition chunks only).
- `src/shared/identity.js` — **already exists** and contains symbol identity primitives. Phase 9 MUST extend/reuse this (do **not** fork identity algorithms).
- New (optional wrapper): `src/index/identity/symbol.js` — if created, keep it as a thin adapter over `src/shared/identity.js` for index-specific policy (definition chunk detection, kind-group mapping, etc).
- Update callsites: graph builder, cross-file resolver, map builder

#### 9.2.1 Implement symbol identity builder

- [x] **Update `src/shared/identity.js` (do this first)**
  - [x] Confirm/export the primitives used by every symbol identity producer:
    - `buildSymbolKey(...)`
    - `buildSignatureKey(...)`
    - `buildScopedSymbolId(...)`
    - `buildSymbolId(...)`
    - `resolveSymbolJoinKey(...)` (used to join calls/usages to symbol definitions)
  - [x] Ensure the primitives accept the Phase 9 canonical inputs (`virtualPath`, `qualifiedName`, `signature`, `kindGroup`, `chunkUid`/`segmentUid` as required by the Phase 9 contracts) and **do not depend on legacy `chunkId`** for uniqueness unless explicitly marked legacy/back-compat.

- [x] **Add `src/index/identity/kind-group.js`**
  - [x] Implement `toKindGroup(kind: string | null): string`

- [x] **Add `src/index/identity/symbol.js`** *(thin adapter over `src/shared/identity.js`)*
  - [x] Export `buildSymbolIdentity({ metaV2 }): { scheme, kindGroup, qualifiedName, symbolKey, signatureKey, scopedId, symbolId } | null`
  - [x] **Hard requirement:** implement hashing/key building by calling helpers from `src/shared/identity.js` (e.g., `buildSymbolKey`, `buildSignatureKey`, `buildScopedSymbolId`, `buildSymbolId`).  
    Do **not** create a second independent SymbolKey/SignatureKey algorithm.
  - [x] Return null when chunk is not a "definition chunk" (policy below).

**Definition chunk policy (v1):**

- A chunk is a definition chunk if:
  - `chunk.name` is truthy AND not equal to `"(module)"` unless kindGroup is `module`, AND
  - `chunk.kind` is truthy OR `chunk.name === "(module)"`, AND
  - `metaV2.lang` is truthy (code mode).

> This policy is intentionally permissive; it can be tightened later, but Phase 9 prioritizes completeness with ambiguity-safe linking.

#### 9.2.2 Populate `metaV2.symbol`

- [x] **Modify `src/index/metadata-v2.js`**
  - [x] After identity fields are set, compute `metaV2.symbol` via `buildSymbolIdentity`.
  - [x] Ensure `symbolKey` is based on `virtualPath`, not `file`.
  - [x] Ensure `symbolId` is deterministic.

#### 9.2.3 Tests for symbol identity

- [x] **Add `tests/indexing/identity/symbol-identity.test.js`**
  - Given a fake `metaV2` with chunkUid/virtualPath/kind/name/signature:
    - assert `symbolKey`, `signatureKey`, `scopedId` are correct.
    - assert `symbolId` is stable across runs.
    - assert `kindGroup` normalization.

---

### 9.3 Implement import-aware cross-file resolution (ambiguity-preserving)

**Primary touchpoints**
- `src/index/type-inference-crossfile/pipeline.js`
- New: `src/index/type-inference-crossfile/resolver.js`
- Update language relations to supply import bindings:
  - `src/lang/javascript/relations.js` (and optionally TS)

#### 9.3.1 Extend language relations to capture import bindings (JS/TS)

- [x] **Modify `src/lang/javascript/relations.js`**
  - [x] During AST walk, build `importBindings`:
    - `import { foo as bar } from "./x"` ⇒ `bar -> { imported: "foo", module: "./x" }`
    - `import foo from "./x"` ⇒ `foo -> { imported: "default", module: "./x" }`
    - `import * as ns from "./x"` ⇒ `ns -> { imported: "*", module: "./x" }`
  - [x] Store in the returned relations object as `importBindings`.

- [x] **Modify `src/index/build/file-processor/relations.js`**
  - [x] Include `importBindings` in fileRelations entries.

- [x] **Update file_relations schema** (`src/shared/artifact-schemas.js`)
  - [x] Allow optional `importBindings` field.

#### 9.3.2 Add relative import resolver helper

- [x] **Add `src/index/type-inference-crossfile/resolve-relative-import.js`**
  - [x] Implement `resolveRelativeImport(importerFile: string, spec: string, fileSet: Set<string>): string | null`
  - [x] Constraints:
    - only handle `./` and `../` specifiers
    - resolve with extension probing:
      - `.ts`, `.tsx`, `.js`, `.jsx`, `.mjs`, `.cjs`
      - directory index: `spec + "/index" + ext`
    - normalize to repo-relative POSIX paths (match existing `chunk.file` conventions)

#### 9.3.3 Implement resolver (SymbolRef builder)

- [x] **Add `src/index/type-inference-crossfile/resolver.js`**
  - [x] Build a `NativeSymbolIndex` from `chunks`:
    - `byVirtualPath: Map<string, { byExportName: Map<string, SymbolDef[]> }>`
    - `byNameGlobal: Map<string, SymbolDef[]>`
    - index both full qualifiedName and leaf name (`foo.bar` ⇒ also index `bar`) but record `matchKind`.
  - [x] Implement `resolveRef({ fromChunk, targetName, kindHint, fileRelations, fileSet }): SymbolRefV1`
    - Bounded candidate collection + scoring (see caps below)
    - Import narrowing:
      - If `importBindings` provides a binding for the target's root identifier, resolve that module to a file.
      - Restrict candidate search to those files; then apply export filtering:
        - if imported name is known, prefer matching exports.
    - If exactly one best candidate above threshold ⇒ `status=resolved`
    - Else if >=2 candidates above threshold ⇒ `status=ambiguous` with top-K candidates
    - Else ⇒ `status=unresolved` with empty candidates

**Caps / guardrails (must be implemented):**

- `MAX_CANDIDATES_PER_REF = 25`
- `MAX_CANDIDATES_GLOBAL_SCAN = 200` (if exceeded, downgrade to ambiguous with "too many" signal)
- Deterministic sorting of candidates:
  - primary: score desc
  - secondary: `symbolKey` asc

#### 9.3.4 Resolver tests

- [x] **Add `tests/indexing/type-inference/crossfile/resolve-relative-import.test.js`**
  - table-driven tests for extension probing and index resolution.

- [x] **Add `tests/indexing/type-inference/crossfile/symbolref-resolution.test.js`**
  - Build synthetic chunks with metaV2.symbol identities across:
    - two files exporting same name `foo` ⇒ ambiguous
    - importer with `import { foo } from "./a"` ⇒ resolved to `a`
    - alias import `import { foo as bar }` and call `bar()` ⇒ resolved
    - unresolved case: no exports match

---

### 9.4 Update cross-file inference pipeline to emit SymbolRef-based links

**Primary touchpoints**
- `src/index/type-inference-crossfile/pipeline.js`
- `src/index/type-inference-crossfile/symbols.js` (deprecate or repurpose)
- Tooling providers that key by `file::name`

#### 9.4.1 Replace `file::name` joins with chunkUid/symbol identity joins

- [x] **Modify `src/index/type-inference-crossfile/pipeline.js`**
  - [x] Replace `chunkByKey` (`file::name`) map with:
    - `chunkByUid: Map<chunkUid, chunk>`
    - `defsBySymbolId: Map<symbolId, chunkUid>` (for quick reverse lookup)
  - [x] Replace legacy `calleeKey = file::target` logic with resolved SymbolRef:
    - call summary includes `resolvedCalleeChunkUid` when available.

#### 9.4.2 Emit new-format `callLinks` and `usageLinks`

- [x] In pipeline, for each call relation:
  - [x] Build `SymbolRefV1` via resolver.
  - [x] Append `codeRelations.callLinks` entry in **new format**:
    ```
    {
      v: 1,
      edgeKind: "call",
      fromChunkUid: <caller chunkUid>,
      to: <SymbolRefV1>,
      confidence: <0..1>,
      evidence: {...}
    }
    ```
  - [x] Preserve legacy fields only if necessary for backward compatibility:
    - if retained, ensure they are explicitly marked `legacy: true` and never used for joins.

- [x] Same for `usageLinks` with `edgeKind: "usage"`.

#### 9.4.3 Keep `callSummaries` but add chunkUid resolution

- [x] Extend each `callSummaries[]` record to include:
  - `calleeRef: SymbolRefV1`
  - `resolvedCalleeChunkUid: string | null`
  - Keep `target/file/kind` for display backward compatibility.

#### 9.4.4 Tooling provider audit (chunkUid-keyed outputs are already implemented)

✅ **Current repo state (verified in code):** all built-in tooling providers already return results keyed by `chunkUid` (no `file::name` Maps).

Providers (current touchpoints):
- `src/index/tooling/clangd-provider.js` — returns `{ byChunkUid }` (capability: `supportsSymbolRef: false`)
- `src/index/tooling/pyright-provider.js` — returns `{ byChunkUid }` (capability: `supportsSymbolRef: false`)
- `src/index/tooling/sourcekit-provider.js` — returns `{ byChunkUid }` (capability: `supportsSymbolRef: false`)
- `src/index/tooling/typescript-provider.js` — returns `{ byChunkUid }` (capability: `supportsSymbolRef: true`)

**Why keep this task anyway?**  
Phase 9 relies on `chunkUid` as the canonical join key, so we need a regression-proof audit + tests that prevent reintroducing `file::name` joins.

- [x] Confirm each provider’s public output surface is `{ provider, byChunkUid }` (not `{ byFile }`).
- [x] Add a targeted regression test per provider that asserts:
  - [x] the top-level key is `byChunkUid`,
  - [x] keys look like `ck64:v1:` / `chunk:`-style UIDs (not `file::name`),
  - [x] duplicate keys are not silently overwritten (throw or log+count, but do not drop).
  - Suggested test files (choose lane explicitly):
    - `tests/tooling/lsp/clangd-provider-output-shape.test.js`
    - `tests/tooling/lsp/pyright-provider-output-shape.test.js`
    - `tests/tooling/lsp/sourcekit-provider-output-shape.test.js`
    - `tests/tooling/lsp/typescript-provider-output-shape.test.js`

**Additional Phase 9 requirement for TS provider**
- [x] Ensure the TS provider’s `symbolRef` emission uses the Phase 9 symbol identity scheme (see 9.2), and does not embed legacy `chunkId` in any join-critical field unless explicitly marked “legacy/back-compat”.

#### 9.4.5 Pipeline tests

- [x] Update / add tests under `tests/type-inference-crossfile/*`:
  - Assert pipeline outputs `callLinks[].to.status` values are correct for fixtures.
  - Assert callSummaries contains `calleeRef` and `resolvedCalleeChunkUid` when resolvable.
  - Assert no `Map` join uses `file::name` in the pipeline (lint-like test via grep in CI is acceptable).

---

### 9.5 Emit symbol artifacts (`symbols`, `symbol_occurrences`, `symbol_edges`)

**Primary touchpoints**
- `src/index/build/artifacts.js`
- New writer modules in `src/index/build/artifacts/writers/`
- `src/shared/artifact-io.js`
- `src/shared/artifact-schemas.js`
- `src/index/validate.js`

#### 9.5.1 Add writer modules

- [x] **Add `src/index/build/artifacts/writers/symbols.js`**
  - [x] Iterator over `state.chunks` yielding `symbols.jsonl` records.
  - [x] Deterministic order: sort by `symbolId` (or by `(virtualPath, qualifiedName, kindGroup, chunkUid)` if streaming constraints require per-shard sort).
  - [x] Use JSONL sharding logic similar to `file-relations.js`.

- [x] **Add `src/index/build/artifacts/writers/symbol-occurrences.js`**
  - [x] Iterate chunks; for each call/usage relation occurrence emit occurrence record with `ref` included.

- [x] **Add `src/index/build/artifacts/writers/symbol-edges.js`**
  - [x] Iterate chunks; for each callLinks/usageLinks edge emit edge record.
  - [x] Emit unresolved/ambiguous edges as well (they're valuable for metrics and later resolution).

#### 9.5.2 Integrate into artifact build

- [x] **Modify `src/index/build/artifacts.js`**
  - [x] Write the three symbol artifacts into `index-code/`.
  - [x] Ensure pieces manifest includes them.

- [x] **Modify `src/shared/artifact-io.js`**
  - [x] Add JSONL required keys entries for:
    - `symbols` (e.g., require `v`, `symbolId`, `chunkUid`)
    - `symbol_edges` (require `v`, `edgeKind`, `fromChunkUid`, `to`)
    - `symbol_occurrences` (require `v`, `fromChunkUid`, `occurrenceKind`)

- [x] **Modify `src/shared/artifact-schemas.js`**
  - [x] Add schemas for the new artifacts.

#### 9.5.3 Add validation and metrics hooks

- [x] **Modify `src/index/validate.js`**
  - [x] When symbol artifacts are present:
    - [x] validate schema
    - [x] cross-check referential integrity:
      - every `symbols.chunkUid` exists in chunk_meta
      - every resolved edge `to.resolved.chunkUid` exists
  - [x] Compute and print metrics (non-fatal unless strict flag is enabled):
    - `resolvedRate`, `ambiguousRate`, `unresolvedRate`

#### 9.5.4 Tests for artifacts

- [x] Add `tests/indexing/artifacts/symbol-artifacts-smoke.test.js`
  - Build a small in-memory "fake state" with 2 chunks and resolved/ambiguous links.
  - Run iterators and ensure JSONL output lines validate and include required keys.

---

### 9.6 Migrate relation graphs to use `chunkUid` and resolved edges only

**Primary touchpoints**
- `src/index/build/graphs.js`
- `tests/indexing/relations/graph-chunk-id.test.js`
- `src/map/build-map.js` (consumes graph_relations)

#### 9.6.1 Update graph builder

- [x] **Modify `src/index/build/graphs.js`**
  - [x] Node identity:
    - `nodeId = chunk.metaV2.chunkUid`
    - Store legacy fields as attributes only.
  - [x] Edges:
    - For each `callLinks`/`usageLinks` edge record:
      - if `to.status !== "resolved"` ⇒ skip for graph_relations edges
      - else edge target is `to.resolved.chunkUid`
  - [x] Remove `chunkIdByKey` (`file::name`) join logic entirely.
  - [x] Keep guardrails and sampling; update samples to include `chunkUid`.

#### 9.6.2 Graph schema/version bump

- [x] Bump `graph_relations.version` to `2`
- [x] Ensure consumers handle version 1 and 2:
  - v1: id may be chunkId or legacyKey
  - v2: id is chunkUid
  - Map builder should accept both (backward compatibility).

#### 9.6.3 Tests

- [x] Update `tests/indexing/relations/graph-chunk-id.test.js`
  - Ensure:
    - nodes keyed by chunkUid
    - collision scenario produces distinct node ids
    - legacyKey remains in attrs for diagnostics
  - Add regression: ambiguous edges are not included in graph edges.

---

### 9.7 Update map build to use new identities (and avoid collisions)

**Primary touchpoints**
- `src/map/build-map.js`
- `src/map/isometric/client/map-data.js` (only if assumptions change)

#### 9.7.1 Update symbol keying inside map build

- [x] **Modify `src/map/build-map.js`**
  - Replace `buildSymbolId(file::name)` with:
    - prefer `chunk.metaV2.symbol.symbolId`
    - else use `chunk.metaV2.chunkUid`
  - Maintain a mapping:
    - `memberId -> chunkUid`
  - Use graph_relations v2 node ids (`chunkUid`) to join to chunk_meta.

#### 9.7.2 Backward compatibility

- [x] If graph_relations.version === 1:
  - maintain existing behavior (best-effort)
- [x] If version === 2:
  - require chunkUid mapping; fail with explicit error if missing (do not silently mis-join).

#### 9.7.3 Map tests

- [x] Add `tests/indexing/map/map-build-symbol-identity.test.js`
  - Build minimal graph_relations v2 + chunk_meta fixture.
  - Assert map members are distinct for same-name collisions.

---

### 9.8 Performance, determinism, and regression guardrails

#### 9.8.1 Determinism requirements

- [x] `chunkUid` deterministic for identical inputs.
- [x] Symbol artifacts emitted in deterministic line order.
- [x] Graph builder output deterministic ordering (`serializeGraph` already sorts).

Add tests:

- [x] `tests/indexing/determinism/symbol-artifact-order.test.js`
  - Run iterator twice and assert identical output.

#### 9.8.2 Throughput requirements

- [x] Avoid O(N^2) scans over all symbols per reference:
  - use name-indexed maps and import-narrowing.
- [x] Avoid per-reference filesystem operations:
  - precompute `fileSet` in resolver.

Add tests/benchmarks (optional but recommended):

- [x] `tools/bench/symbol-resolution-bench.js`
  - synthetic repo with 100k symbols and 200k refs; ensure runtime is bounded.

---

## Phase 9 exit criteria (must all be true)

- [x] No graph or cross-file linking code performs `Map.set()` keyed solely by `file::name` in a way that can silently overwrite distinct entities.
- [x] `metaV2.chunkUid` is present and non-empty for every code chunk ("fail closed").
- [x] `graph_relations.version === 2` and node ids are `chunkUid`.
- [x] Pipeline emits SymbolRef-based call/usage links; ambiguous/unresolved are preserved explicitly.
- [x] Symbol artifacts are written and validate successfully on the small fixture suite.
- [x] New tests for chunkUid stability and resolver correctness are green.

---

## Appendix A -- Concrete file-by-file change list

This appendix is purely to reduce "search time" during implementation. Each file lists the exact intent.

### A.1 New files to add

- `src/index/identity/normalize.js`
- `src/index/identity/virtual-path.js`
- `src/index/identity/segment-uid.js`
- `src/index/identity/chunk-uid.js`
- `src/index/identity/kind-group.js`
- `src/index/identity/symbol.js`
- `src/index/type-inference-crossfile/resolve-relative-import.js`
- `src/index/type-inference-crossfile/resolver.js`
- `src/index/build/artifacts/writers/symbols.js`
- `src/index/build/artifacts/writers/symbol-occurrences.js`
- `src/index/build/artifacts/writers/symbol-edges.js`
- Tests:
  - `tests/identity/chunk-uid-stability.test.js`
  - `tests/identity/segment-uid-stability.test.js`
  - `tests/indexing/identity/symbol-identity.test.js`
  - `tests/indexing/type-inference/crossfile/resolve-relative-import.test.js`
  - `tests/indexing/type-inference/crossfile/symbolref-resolution.test.js`
  - `tests/indexing/artifacts/symbol-artifacts-smoke.test.js`
  - `tests/indexing/map/map-build-symbol-identity.test.js`
  - `tests/indexing/determinism/symbol-artifact-order.test.js`

### A.2 Existing files to modify

- `src/index/segments.js` -- compute and propagate `segmentUid`
- `src/index/build/file-processor.js` -- compute `chunkUid`
- `src/index/build/file-processor/assemble.js` -- pass through chunkUid fields
- `src/index/metadata-v2.js` -- include identity + symbol identity
- `src/lang/javascript/relations.js` -- emit `importBindings`
- `src/index/build/file-processor/relations.js` -- include importBindings
- `src/shared/artifact-schemas.js` -- add schemas, extend file_relations
- `src/shared/artifact-io.js` -- required keys for new JSONL artifacts
- `src/index/type-inference-crossfile/pipeline.js` -- emit SymbolRef edges and avoid file::name joins
- `src/index/tooling/{typescript,pyright,clangd,sourcekit}-provider.js` -- key by chunkUid
- `src/index/build/artifacts.js` -- write symbol artifacts
- `src/index/validate.js` -- validate symbol artifacts (optional strict)
- `src/index/build/graphs.js` -- graph_relations v2 using chunkUid
- `src/map/build-map.js` -- join graph nodes to chunk meta via chunkUid
- `tests/indexing/relations/graph-chunk-id.test.js` -- update

---

## Appendix B -- Metrics to report (recommended)

- `symbol_resolution.resolved_rate`
- `symbol_resolution.ambiguous_rate`
- `symbol_resolution.unresolved_rate`
- `symbol_resolution.max_candidates_hit_rate`
- `symbol_resolution.import_narrowed_rate`

In strict CI mode, optionally enforce:

- `wrong_link_rate == 0` on fixtures with gold truth
- `resolved_rate >= threshold` on fixtures (threshold set per fixture)

---

## Added detail (Phase 9 task mapping)

### 9.1 Identity primitives (segmentUid, chunkUid, virtualPath)
- Files to change/create:
  - New: src/index/identity/normalize.js, virtual-path.js, segment-uid.js, chunk-uid.js
  - Existing: src/index/segments.js (assignSegmentUids / buildSegmentUid at ~17-50)
  - Existing: src/index/build/file-processor/assemble.js (buildChunkPayload at ~52-105)
  - Existing: src/index/metadata-v2.js (buildMetaV2 uses chunk/meta fields at ~214-260)
  - Existing: src/index/chunk-id.js (legacy chunkId; used by resolveChunkId)
- Call sites/line refs:
  - src/index/segments.js:17-50 (buildSegmentUid, assignSegmentUids)
  - src/index/build/file-processor/assemble.js:52-105
  - src/index/chunk-id.js:1-18
- Gaps/conflicts:
  - Resolved: docs/phases/phase-9/identity-contracts.md now matches docs/specs/identity-contract.md for chunkUid (span/pre/post hashes + virtualPath + segmentUid).
  - Phase 8 spec updated to align; Phase 9 remains the implementation target.

### 9.2 Symbol identity (metaV2.symbol + SymbolRef)
- Files to change/create:
  - New: src/index/identity/kind-group.js, src/index/identity/symbol.js
  - Existing: src/index/metadata-v2.js (add symbol object after identity fields)
  - Existing: src/index/type-inference-crossfile/symbols.js (leafName/isTypeDeclaration; may be replaced by identity helpers)
- Call sites/line refs:
  - src/index/metadata-v2.js:214-260 (current metaV2 fields)
  - src/index/type-inference-crossfile/symbols.js:1-30
- Gaps/conflicts:
  - Resolved: symbolKey inputs now use `virtualPath` (segmentUid-based), not segmentId.

### 9.3 Import-aware cross-file resolver
- Files to change/create:
  - New: src/index/type-inference-crossfile/resolve-relative-import.js, resolver.js
  - Existing: src/lang/javascript/relations.js (add importBindings during AST walk; call site around 360-420)
  - Existing: src/index/build/file-processor/relations.js (persist importBindings into fileRelations)
  - Existing: src/contracts/schemas/artifacts.js (extend file_relations schema)
- Call sites/line refs:
  - src/lang/javascript/relations.js:360-418 (AST traversal + callDetails)
  - src/index/build/file-processor/relations.js:27-50
  - src/contracts/schemas/artifacts.js:318-334

### 9.4 Pipeline emits SymbolRef-based links
- Files to change/create:
  - src/index/type-inference-crossfile/pipeline.js (replace chunkByKey `${file}::${name}` at ~58-70; update callLinks at ~201-280)
  - src/index/type-inference-crossfile/symbols.js (or new resolver helpers)
  - src/index/tooling/* providers (clangd/pyright/sourcekit/typescript) keyed by file::name
- Call sites/line refs:
  - src/index/type-inference-crossfile/pipeline.js:58-70, 201-280, 286, 340
  - src/index/tooling/typescript-provider.js:308
  - src/index/tooling/clangd-provider.js:230
  - src/index/tooling/pyright-provider.js:281, 328
  - src/index/tooling/sourcekit-provider.js:198
- Gaps/conflicts:
  - Multiple providers split names by /::|\./ (see src/index/type-inference-crossfile/symbols.js:4-9); switching to SymbolRef requires consistent qualifiedName handling.

### 9.5 Symbol artifacts (symbols, symbol_occurrences, symbol_edges)
- Files to change/create:
  - New writers: src/index/build/artifacts/writers/symbols.js, symbol-occurrences.js, symbol-edges.js
  - src/index/build/artifacts.js (enqueue writers near file_relations at ~380)
  - src/shared/artifact-io/jsonl.js (required keys list)
  - src/contracts/schemas/artifacts.js (add schemas)
  - src/index/validate.js (strict validation + referential checks)
- Call sites/line refs:
  - src/index/build/artifacts.js:380-401
  - src/shared/artifact-io/jsonl.js:11-17
  - src/index/validate.js:76-95, 301-347

### 9.6 Graph relations migrate to chunkUid
- Files to change/create:
  - src/index/build/graphs.js (legacyKey + resolveChunkId at ~9-149)
  - tests/indexing/relations/graph-chunk-id.test.js (update expectations)
- Call sites/line refs:
  - src/index/build/graphs.js:9, 91-149
- Gaps/conflicts:
  - resolveChunkId currently uses chunkId fallback; Phase 8 must ensure metaV2.chunkUid is populated to avoid legacyKey reuse.

### 9.7 Map build identity updates
- Files to change/create:
  - src/map/build-map.js (consume chunkUid + symbolId)
  - src/map/build-map/symbols.js (buildSymbolId uses file::name at ~11-16)
  - src/map/build-map/edges.js (edge member keys at ~104)
  - src/map/build-map/filters.js (file::name parsing at ~30-31, 115-116, 189-192, 216-217)
- Call sites/line refs:
  - src/map/build-map/symbols.js:11-16
  - src/map/build-map/edges.js:104
  - src/map/build-map/filters.js:30-31, 115-116, 189-192, 216-217

### 9.8 Performance + determinism guardrails
- Files to change/create:
  - src/index/build/graphs.js (serializeGraph already sorts; keep stable ordering)
  - new tests under tests/determinism/ and tools/bench/
- Call sites/line refs:
  - src/index/build/graphs.js:45-68 (serializeGraph ordering)

### Associated specs reviewed (Phase 9)
- docs/phases/phase-9/identity-contracts.md
- docs/phases/phase-9/symbol-artifacts-and-pipeline.md
- docs/phases/phase-9/migration-and-backcompat.md
- docs/specs/identity-contract.md
- docs/specs/symbol-identity-and-symbolref.md
- docs/specs/symbol-artifacts.md

## Phase 9 addendum: dependencies, ordering, artifacts, tests, edge cases

### Cross-phase ordering (Phase 8 ↔ Phase 9)
- Identity primitives (`segmentUid`, `virtualPath`, `chunkUid`) **must already be complete from Phase 8** before any Phase 9 symbol/graph work starts.
- Phase 9.1 is verification-only: if identity primitives are missing or drifted, stop Phase 9 and complete Phase 8 identity tasks first.
- Identity tests (segmentUid/chunkUid/strict validation) must already be green from Phase 8; rerun only if identity code changes.

### 9.1 Dependencies and order of operations
- Dependencies:
  - segmentUid algorithm must land before chunkUid (needs segment text).
  - virtualPath and chunkUid helpers must exist before any graph/tooling joins.
- Order of operations:
  1) Compute segmentUid during segmentation (container text available).
  2) Build virtualPath and chunkUid during chunk assembly.
  3) Persist into metaV2 + chunk payload.
  4) Add strict validation for missing chunkUid.

### 9.1 Acceptance criteria + tests (lane)
- Identity tests run in Phase 8 (see Phase 8 addendum). Rerun only if identity code changes.

### 9.1 Edge cases and fallback behavior
- Missing segment text in cache hydrate: treat as cache miss and reprocess file.
- chunkUid collision: escalate context once, then append :ord<N> deterministically.
- Fail-closed: strict mode rejects any chunk missing chunkUid/segmentUid/virtualPath (no file::name fallback).

### 9.2 Dependencies and order of operations
- Dependencies:
  - 9.1 identity helpers must land before symbol identity helpers.
- Order of operations:
  1) Implement kindGroup normalization.
  2) Implement symbolKey/signatureKey/scopedId builders.
  3) Add SymbolRef envelope helpers.

### 9.2 Acceptance criteria + tests (lane)
- tests/indexing/identity/identity-symbolkey-scopedid.test.js (test:unit)
- tests/indexing/type-inference/symbolref-envelope.test.js (test:unit)

### 9.2 Edge cases and fallback behavior
- Missing qualifiedName: fall back to chunk.name; mark symbolKey as low confidence.
- Duplicate scopedId: deterministic ordinal suffix or strict-mode error (choose and document).

### 9.3 Dependencies and order of operations
- Dependencies:
  - import bindings must be extracted before resolver runs.
- Order of operations:
  1) Collect import bindings in relations extraction.
  2) Resolve relative imports to candidate files.
  3) Emit SymbolRef candidates with status=ambiguous when >1.

### 9.3 Acceptance criteria + tests (lane)
- tests/indexing/imports/import-resolver-relative.test.js (test:integration)
- tests/indexing/artifacts/symbols/symbol-edges-ambiguous.test.js (test:services)

### 9.3 Edge cases and fallback behavior
- Unresolved import: emit unresolved SymbolRef with candidates empty; keep edge.
- Multiple matches: status=ambiguous; do not pick winner.
- Fail-closed: if resolver cannot map to chunkUid candidates, mark unresolved; do not guess by name.

### 9.4 Dependencies and order of operations
- Dependencies:
  - 9.1 chunkUid and 9.2 symbol helpers must be present.
- Order of operations:
  1) Build chunkUid map.
  2) Replace file::name joins with chunkUid joins.
  3) Attach SymbolRef info to call/usage links.

### 9.4 Acceptance criteria + tests (lane)
- tests/integration/file-name-collision-no-wrong-join.test.js (test:integration)
- tests/indexing/artifacts/symbols/symbol-links-by-chunkuid.test.js (test:services)

### 9.4 Edge cases and fallback behavior
- Missing chunkUid: strict mode fails; non-strict logs and skips the link.
- Multiple candidates: preserve ambiguity in SymbolRef.
- Fail-closed: never backfill chunkUid joins from file::name; emit ambiguous/unresolved instead.

### 9.5 Artifact row fields (symbols.jsonl, symbol_occurrences.jsonl, symbol_edges.jsonl)
- symbols.jsonl required keys (SymbolRecordV1):
  - v, symbolKey, scopedId, symbolId, qualifiedName, kindGroup, file, virtualPath, chunkUid
  - optional: signatureKey, languageId, chunkId, containerName, source
- symbol_occurrences.jsonl required keys (SymbolOccurrenceV1):
  - v, host.file, host.chunkUid, role, ref (SymbolRefV1)
  - optional: meta.callerScopedId, meta.argMap
- symbol_edges.jsonl required keys (SymbolEdgeV1):
  - v, type, from.file, from.chunkUid, to (SymbolRefV1)
  - optional: confidence, reason, call.argMap
- Caps (set explicit defaults in schema/tests):
  - maxCandidates in SymbolRef (recommended: 25)
  - maxEvidence/snippet size (no raw snippets; use hashes)
  - maxRowBytes (recommended: 32768)

### 9.5 Acceptance criteria + tests (lane)
- tests/indexing/artifacts/symbols/symbol-artifacts-emission.test.js (test:services)
- tests/indexing/validate/symbol-integrity-strict.test.js (test:services)
- tests/indexing/artifacts/symbols/symbol-edges-ambiguous.test.js (test:services)

### 9.5 Edge cases and fallback behavior
- Duplicate scopedId: strict validation fails; non-strict appends deterministic ordinal.
- SymbolRef resolved but missing chunkUid: treat as unresolved and log.
- Fail-closed: if SymbolRef is resolved but missing chunkUid/scopedId, drop edge in strict mode.

### 9.6 Dependencies and order of operations
- Dependencies:
  - 9.1 chunkUid must land before graph_relations v2.
- Order of operations:
  1) Update graph node ids to chunkUid.
  2) Update edge targets to resolved chunkUid only.
  3) Keep legacyKey for diagnostics only.

### 9.6 Acceptance criteria + tests (lane)
- tests/indexing/relations/graph-relations-v2-chunkuid.test.js (test:integration)

### 9.6 Edge cases and fallback behavior
- Missing chunkUid in chunk_meta: strict mode fails; non-strict skips node.

### 9.7 Dependencies and order of operations
- Dependencies:
  - Graph relations v2 must be complete before map build joins.
- Order of operations:
  1) Join map entries by chunkUid.
  2) Fallback to chunkId only for diagnostics.

### 9.7 Acceptance criteria + tests (lane)
- tests/indexing/map/map-chunkuid-join.test.js (test:integration)

### 9.7 Edge cases and fallback behavior
- Multiple map entries for same chunkUid: keep deterministic ordering, dedupe by chunkUid.

### 9.8 Dependencies and order of operations
- Dependencies:
  - Determinism checks after all artifact emission.
- Order of operations:
  1) Run determinism tests (two builds).
  2) Verify collision handling is stable.

### 9.8 Acceptance criteria + tests (lane)
- tests/indexing/determinism/chunkuid-determinism.test.js (test:integration)
- tests/indexing/determinism/symbol-artifact-determinism.test.js (test:integration)

### 9.8 Edge cases and fallback behavior
- Large repos: enforce sharded emission; fail if memory cap exceeded.

## Fixtures list (Phase 9)

- tests/fixtures/identity/chunkuid-collision
- tests/fixtures/symbols/ambiguous-defs
- tests/fixtures/imports/relative-ambiguous
- tests/fixtures/graph/chunkuid-join

## Compat/migration checklist (Phase 9)

- Keep chunkId and segmentId in metaV2 for debug/back-compat only.
- Emit graph_relations v2 with chunkUid node ids; keep legacyKey for diagnostics only.
- Symbol artifacts are additive; do not remove legacy repo_map outputs.

## Artifacts contract appendix (Phase 9)

- symbols.jsonl
  - required keys: v, symbolKey, scopedId, symbolId, qualifiedName, kindGroup, file, virtualPath, chunkUid
  - optional keys: signatureKey, languageId, chunkId, containerName, source
  - caps: maxRowBytes 32768
- symbol_occurrences.jsonl
  - required keys: v, host.file, host.chunkUid, role, ref (SymbolRefV1)
  - optional keys: meta.callerScopedId, meta.argMap
- symbol_edges.jsonl
  - required keys: v, type, from.file, from.chunkUid, to (SymbolRefV1)
  - optional keys: confidence, reason, call.argMap
- graph_relations.json (v2)
  - required node ids: chunkUid
  - legacyKey allowed for diagnostics only

---


## Phase 10 - Interprocedural risk propagation + explainability artifacts

**Goal:** Add a deterministic, capped, explainable *interprocedural* risk propagation system for the **code** index mode that:
- Reuses existing **local** risk signals (`docmeta.risk` from `src/index/risk.js`).
- Reuses existing **cross-file inference** call resolution (`applyCrossFileInference`), specifically `callDetails[].targetChunkUid`.
- Emits **new artifacts**:
  - `risk_summaries*.jsonl` (+ shard meta)
  - `risk_flows*.jsonl` (+ shard meta)
  - `risk_interprocedural_stats.json`
- Adds a compact, low-bytes **`docmeta.risk.summary`** for each risk-relevant chunk (to support fast display/filtering without scanning JSONL).
- Provides a CLI to explain the flows in an index (`pairofcleats risk explain ...`).

---

### Source-of-truth decisions + conflicts resolved

This phase touches multiple "specs" that are currently **not aligned** with the repo's implemented contracts. Implement the *best* functionality **and** remove ambiguity by making these explicit choices.

#### A) `call_sites.jsonl` schema: **CODE contract is authoritative**
- **Authoritative schema:** `src/contracts/schemas/artifacts.js` (`call_sites` entry schema)
- **Writer:** `src/index/build/artifacts/writers/call-sites.js`

The older spec `docs/specs/risk-flows-and-call-sites.md` contains a *different* `call_sites` row shape (e.g., `calleeName`, `argsSummary`, no `start/end offsets`, etc.). That spec is **out of date** for `call_sites`.

**Choice:** Do **not** change the repo's `call_sites` contract to match the spec.  
**Action:** Update the *documents/specs* to match the code contract (see **10.0 Doc merge**).

**Why:** `call_sites` already exists, is validated by contracts/tests, and is used for call graph evidence. The safest and most correct approach is to treat the implemented contract as the single source of truth and bring docs into alignment.

#### B) `callSiteId` algorithm: **keep the existing implementation; update newer docs**
- **Actual implementation:** `buildCallSiteId(...)` in `src/index/build/artifacts/writers/call-sites.js`
- **Doc (currently aligned with code):** `docs/specs/risk-callsite-id-and-stats.md`
- **Doc (currently NOT aligned with code):** `docs/new_docs/risk-callsite-id-and-stats_IMPROVED.md` (it proposes a different string-to-hash recipe)

**Choice:** Keep the current algorithm (colon-separated parts, no `callsite:v1` prefix).  
**Action:** Update the "IMPROVED" doc during merge (or explicitly label it as a future v2) so docs do not contradict working code.

**Why:** Changing `callSiteId` would silently invalidate any stored references and degrade determinism across builds. We can introduce a versioned v2 later **only** if we add an explicit `callSiteIdVersion`/`schemaVersion` surface.

#### C) Config surface conflict: "repo config contract" vs Phase 10 config keys
- `docs/config/contract.md` suggests a narrow public config surface.
- Phase 10's specs and roadmap require `indexing.riskInterprocedural`.

**Choice (best for engineering velocity + testability):** Treat `indexing.riskInterprocedural` as an **internal/advanced** indexing knob and explicitly preserve it through config load/normalization.  
**Action:** Update `tools/dict-utils/config.js` normalization to keep `indexing.riskInterprocedural` (and any prerequisite knobs used by runtime gating), and update docs so the contract vs internal knobs are clearly delineated.

**Why:** Interprocedural risk is *expensive* and must be opt-in. The least invasive, most explicit opt-in is a config knob. If the product wants a narrower public contract later, it can gate exposure without deleting the internal setting.

---

## 10.0 Documentation merge + canonical spec cleanup (FOUNDATION - do first)

> **Objective:** Eliminate spec drift *before* implementation.

### 10.0.1 Merge/replace outdated specs with reconciled versions
Files involved (read all, then produce a merged canonical set):

- Canonical targets (should live under `docs/specs/`):
  - [x] `docs/specs/risk-interprocedural-config.md`
  - [x] `docs/specs/risk-summaries.md`
  - [x] `docs/specs/risk-flows-and-call-sites.md`
  - [x] `docs/specs/risk-callsite-id-and-stats.md`
  - [x] `docs/specs/risk-interprocedural-stats.md` (currently placeholder)

- Sources to merge in (from `docs/new_docs/`):
  - [x] `spec_risk-interprocedural-config_IMPROVED.md`
  - [x] `spec_risk-summaries_IMPROVED.md`
  - [x] `spec_risk-flows-and-call-sites_RECONCILED.md`
  - [x] `risk-callsite-id-and-stats_IMPROVED.md`
  - [x] `interprocedural-state-and-pipeline_DRAFT.md`

**Tasks (required, no ambiguity):**
- [x] Merge canonical specs in `docs/specs/` using the sources above (see Doc merge checklist at end of Phase 10).
- [x] Update the **`call_sites` schema section** in `risk-flows-and-call-sites.md` to explicitly say:
  - [x] Call sites are the existing artifact contract in `src/contracts/schemas/artifacts.js`.
  - [x] For interprocedural risk, we only require a subset of fields (list them), but the artifact may contain superset fields.
- [x] Ensure the **`callSiteId` algorithm** section matches `buildCallSiteId` in `call-sites.js` (use `calleeRaw`, not `calleeName`).
- [x] Reconcile **risk summaries schema**: incorporate stronger evidence shape (start/end line+col) and keep truncation/caps guidance. Resolve any mismatched field names (see 10.3 for the implemented schema).
- [x] Reconcile **risk flows schema**: keep the roadmap's detailed schema (source+sink endpoints, path with `chunkUids` + `callSiteIdsByStep`, confidence, notes). Update any new_docs schema to match.
- [x] Make **stats schema** explicit about what callSitesEmitted means:
  - [x] Define as unique callSiteIds referenced by emitted `risk_flows` (not total rows in call_sites).
- [x] Remove outdated statements (e.g., docs/config/schema.json doesn't include indexing.).

### 10.0.2 Add Spec status table inside Phase 10 docs
Create a small table (in whichever canonical spec is most appropriate, or at the top of this Phase 10 section) showing:

- [x] spec file -> implemented-by code module -> status (implemented / draft / planned)
- [x] version numbers (schemaVersion) and compatibility notes

**Tasks**
- [x] Add the status table to the canonical spec (or Phase 10 header).
- [x] Include schemaVersion and a compatibility note: **no back-compat; old indexes should error with a rebuild instruction**.

### 10.0.3 Archive deprecated specs + codify the process (MANDATORY)

This implements the repo-wide rule:

> Deprecated/replaced spec documents must be moved to `docs/archived/` (never deleted), and the process must be documented in `AGENTS.md`.

**Tasks**
- [x] Create `docs/archived/README.md` explaining:
  - [x] what belongs here,
  - [x] how to name/archive files,
  - [x] how to reference the replacement spec.
- [x] Create `docs/archived/phase-10/` (or `docs/archived/specs/phase-10/`) as the destination for Phase 10 spec deprecations.
- [x] After the merges in **10.0.1** are complete:
  - [x] Move the *staging* source docs from `docs/new_docs/` that are no longer meant to be edited:
    - [x] `docs/new_docs/spec_risk-interprocedural-config_IMPROVED.md`
    - [x] `docs/new_docs/spec_risk-summaries_IMPROVED.md`
    - [x] `docs/new_docs/spec_risk-flows-and-call-sites_RECONCILED.md`
    - [x] `docs/new_docs/risk-callsite-id-and-stats_IMPROVED.md`
    - [x] `docs/new_docs/interprocedural-state-and-pipeline_DRAFT.md`
    - [x] Destination: `docs/archived/phase-10/` (keep filenames intact).
  - [x] Add a short "DEPRECATED" header block to each moved file that points to the canonical replacement(s) in `docs/specs/...`.
- [x] Update **`AGENTS.md`** with a "Spec deprecation + archival process" section:
  - [x] When to archive vs update-in-place.
  - [x] Required metadata to include in the archived file header (replacement link + date/PR).
  - [x] A reminder that contracts (`src/contracts/**`) remain authoritative and specs must track them.

**Why this is required**
- `docs/new_docs/` is a staging area; leaving parallel variants creates drift and confusion.
- `docs/archived/` preserves context without keeping multiple "active" specs.


---

## 10.1 Config wiring + runtime gating (FOUNDATION - do before any propagation code)

### 10.1.0 Authoritative config keys (single source of truth)
**These keys are canonical. Use these exact names everywhere in Phase 10 and specs.**

**Tasks**
- [x] Document the authoritative keys list in Phase 10 and in `docs/specs/risk-interprocedural-config.md`.
- [x] Update any downstream task/test references to use these exact key names (no aliases).

**Authoritative keys**
- `indexing.riskInterprocedural.enabled`
- `indexing.riskInterprocedural.summaryOnly`
- `indexing.riskInterprocedural.strictness`
- `indexing.riskInterprocedural.sanitizerPolicy`
- `indexing.riskInterprocedural.emitArtifacts`
- `indexing.riskInterprocedural.caps.maxDepth`
- `indexing.riskInterprocedural.caps.maxPathsPerPair`
- `indexing.riskInterprocedural.caps.maxTotalFlows`
- `indexing.riskInterprocedural.caps.maxCallSitesPerEdge`
- `indexing.riskInterprocedural.caps.maxEdgeExpansions`
- `indexing.riskInterprocedural.caps.maxMs`

### 10.1.1 Add risk interprocedural config normalizer
**New file:** `src/index/risk-interprocedural/config.js`

Export:
- [x] `normalizeRiskInterproceduralConfig(raw, { mode })`

Inputs:
- [x] `raw` comes from `runtime.indexingConfig.riskInterprocedural` (or `{}`).

Output (**effective config**; use these defaults unless the merged spec dictates otherwise):
```js
{
  enabled: false,                 // hard gate
  summaryOnly: false,             // if true: summaries + compact docmeta only, no propagation, no risk_flows
  strictness: 'conservative',     // 'conservative' | 'argAware'
  sanitizerPolicy: 'terminate',   // 'terminate' | 'weaken'
  emitArtifacts: 'jsonl',         // 'none' | 'jsonl'  (accept legacy aliases: 'off' -> 'none')
  caps: {
    maxDepth: 4,
    maxPathsPerPair: 3,
    maxTotalFlows: 5000,
    maxCallSitesPerEdge: 3,
    maxEdgeExpansions: 200000,    // global cap on edge traversals (prevents explosion even if flows are capped)
    maxMs: 2500                   // wall clock budget; null disables
  }
}
```

**Normalization rules (MUST be deterministic):**
- [x] `emitArtifacts`: accept `off|none` -> `none`, `jsonl` -> `jsonl`. Anything else -> default `jsonl`.
- [x] `strictness`: unknown -> `conservative`
- [x] `sanitizerPolicy`: unknown -> `terminate`
- [x] numeric caps:
  - [x] coerce to integers
  - [x] clamp to sane ranges (define in code):
    - [x] `maxDepth`: 1..20
    - [x] `maxPathsPerPair`: 1..50
    - [x] `maxTotalFlows`: 0..1_000_000
    - [x] `maxCallSitesPerEdge`: 1..50
    - [x] `maxEdgeExpansions`: 10_000..10_000_000
    - [x] `maxMs`: null OR 10..60_000
- [x] `summaryOnly=true` forces "no flows" even if other caps allow.
- [x] If `enabled=false`, downstream code must treat the entire feature as disabled and avoid any heavy compute.

### 10.1.2 Preserve config keys through repo config normalization
**File:** `tools/dict-utils/config.js`  
Function: `normalizeUserConfig(config)`

Today this function intentionally narrows the public config surface. For Phase 10 to be operable and testable, we must preserve:

- `config.indexing.riskInterprocedural` (entire nested object)

**Implementation requirement:**
- [x] Add `riskInterprocedural: indexingConfig.riskInterprocedural || undefined` under the returned `indexing` object.
- [x] Keep it **as-is** (no normalization here); normalization is done in `src/index/risk-interprocedural/config.js`.

Also preserve any prerequisite knobs *already used by runtime* and referenced by specs (only if they are currently being dropped):
- [x] `indexing.riskAnalysis` (if you want it configurable)
- [x] `indexing.riskAnalysisCrossFile`
- [x] `indexing.typeInferenceCrossFile`

If the project intentionally keeps these non-configurable, document that clearly in the merged specs and do not add them.

### 10.1.3 Wire effective config into build runtime
**File:** `src/index/build/runtime/runtime.js`

Tasks:
- [x] Import `normalizeRiskInterproceduralConfig`.
- [x] Compute:
  - [x] `const riskInterproceduralConfig = normalizeRiskInterproceduralConfig(indexingConfig.riskInterprocedural, { mode });`
- [x] Add to returned runtime:
  - [x] `riskInterproceduralConfig`
  - [x] `riskInterproceduralEnabled` (boolean)
    - [x] `true` iff:
      - [x] `mode === 'code'`
      - [x] `riskAnalysisEnabled === true` (Phase 10 depends on local signals)
      - [x] `riskInterproceduralConfig.enabled === true`
- [x] Add gating to `analysisPolicy`:
  - [x] include `analysisPolicy.risk.interprocedural = riskInterproceduralEnabled`
  - [x] include `analysisPolicy.risk.interproceduralSummaryOnly = riskInterproceduralConfig.summaryOnly`

### 10.1.4 Ensure cross-file inference runs when riskInterprocedural is enabled
**File:** `src/index/build/indexer/steps/relations.js`

Current logic:
- `crossFileEnabled = typeInferenceCrossFileEnabled || riskAnalysisCrossFileEnabled`

Update to:
- [x] `crossFileEnabled = typeInferenceCrossFileEnabled || riskAnalysisCrossFileEnabled || runtime.riskInterproceduralEnabled`

**Important constraint:** Enabling cross-file inference does **not** have to enable "type inference output artifacts"; it only needs to run resolution so `callDetails[].targetChunkUid` exists.

So, keep:
- [x] `enableTypeInference: typeInferenceCrossFileEnabled`
- [x] `enableRiskCorrelation: riskAnalysisCrossFileEnabled`
- [x] Do NOT implicitly force these true just because riskInterprocedural is enabled.

### 10.1.5 Incremental build signature must include riskInterprocedural effective config
**File:** `src/index/build/indexer/signatures.js`

Add `riskInterproceduralConfig` (or a stable subset) to the signature components so incremental rebuilds invalidate when this changes.

- [x] Use a stable JSON stringify (or hash) of the *normalized effective config* object.
- [x] Do **not** include transient fields like timers.

### 10.1.6 Index state output must record whether this feature ran
**File:** `src/index/build/indexer/steps/write.js`

In `index_state.json`, add:
```json
"riskInterprocedural": {
  "enabled": true,
  "summaryOnly": false,
  "emitArtifacts": "jsonl"
}
```

- [x] Implement this in `index_state.json` (exact nesting flexible, but must be deterministic and allow tooling to quickly see if risk flows are expected).

### 10.1.7 Tests for config and gating
Add:
- [x] `tests/indexing/risk/interprocedural/config-normalization.test.js`
  - [x] unit test `normalizeRiskInterproceduralConfig`
  - [x] include edge cases: alias values, bad types, clamp behavior
- [x] `tests/indexing/risk/interprocedural/runtime-gating.test.js`
  - [x] create runtime via `createBuildRuntime` with mode=`code` and mode=`prose`
  - [x] assert `riskInterproceduralEnabled` toggles correctly
  - [x] assert crossFileEnabled includes it (mock `runCrossFileInference` decision logic)

---

## 10.2 Param name stabilization for arg-aware mode (FOUNDATION)

> Arg-aware propagation requires stable "callee param names" to map tainted args -> callee identifiers.

### 10.2.0 Map data flow entry points + consumers (required)
**Tasks**
- [x] Identify parsing entry points:
  - [x] `src/lang/javascript/relations.js` (param extraction in `buildCodeRelations`)
  - [x] `src/index/type-inference-crossfile/extract.js` (`extractParamTypes`)
  - [x] `src/index/type-inference-crossfile/pipeline.js` (`applyCrossFileInference`)
  - [x] `src/index/build/indexer/steps/relations.js` (`runCrossFileInference`)
- [x] Identify consumers:
  - [x] `src/index/risk-interprocedural/summaries.js`
  - [x] `src/index/risk-interprocedural/engine.js`
  - [x] `src/index/build/artifacts/writers/risk-interprocedural.js`
  - [x] `src/index/build/piece-assembly.js`
  - [x] `src/index/validate/risk-interprocedural.js`
- [x] Cross-reference these entry points/consumers in 10.5 (engine) and 10.6 (writers/manifest) to keep data flow explicit.

### 10.2.1 Fix JS param extraction to be stable + predictable
**File:** `src/lang/javascript/relations.js` (anchors referenced in original roadmap: around callLinks generation and docmeta param extraction)

Current risk:
- `node.params` can contain patterns (destructuring, defaults) that stringify inconsistently.

Required changes:
- [x] When building `docmeta.params` (or an adjacent structured field), produce **paramNames** array:
  - [x] For `Identifier` param: use name directly.
  - [x] For `AssignmentPattern` (`x=1`): use left identifier name if possible.
  - [x] For `RestElement` (`...rest`): use argument identifier name if possible.
  - [x] For patterns (`ObjectPattern`, `ArrayPattern`), use stable placeholders:
    - [x] `"arg0"`, `"arg1"`, ... (based on param index)
- [x] Ensure `paramNames` is:
  - [x] stable order
  - [x] capped (e.g., 16)
- [x] Preserve the existing `docmeta.signature` format (do not break search behavior).

**Cross-file inference dependency:**  
`applyCrossFileInference` populates `callLinks.paramNames` via `extractParamTypes`. That function must rely on stable `docmeta.params` or a new stable `docmeta.paramNames`. If needed:

- [x] Update `src/index/type-inference-crossfile/extract.js` (function `extractParamTypes`) to prefer:
  - [x] `docmeta.paramNames` if present
  - [x] else fall back to `docmeta.params`

### 10.2.2 Add tests for JS param normalization
Add:
- [x] `tests/lang/javascript/javascript-paramnames.test.js`

- [x] Fixture function:
```js
function f({a,b}, x=1, ...rest) {}
```

Expect:
- [x] `docmeta.paramNames` equals `["arg0","x","rest"]`
- [x] `callLinks.paramNames` for calls to `f` are consistent.

---

## 10.3 Risk summaries (artifact + compact docmeta)

> Summaries are the "input facts" for propagation and the primary explainability artifact even when propagation is disabled or times out.

### 10.3.1 Define the *final* summary row schema (implement exactly)
After doc merge (10.0), Implement this as the actual row contract (`schemaVersion: 1`):
- [x] Implement this schema in `src/contracts/schemas/artifacts.js` and `docs/specs/risk-summaries.md`.

**Artifact:** `risk_summaries.jsonl` (sharded)

**Row (RiskSummaryRowV1):**
```ts
{
  schemaVersion: 1,

  // identity
  chunkUid: string,
  file: string,
  languageId: string|null,

  // optional symbol context (for debugging / UI; must not bloat)
  symbol: {
    name: string|null,
    kind: string|null,
    signature: string|null
  },

  // signals (bounded + deterministic)
  signals: {
    sources: RiskSignalSummary[],
    sinks: RiskSignalSummary[],
    sanitizers: RiskSignalSummary[],
    localFlows: RiskLocalFlowSummary[]
  },

  // optional: local taint hints (helps arg-aware)
  taintHints?: {
    taintedIdentifiers: string[]
  },

  totals: {
    sources: number,
    sinks: number,
    sanitizers: number,
    localFlows: number
  },

  truncated: {
    sources: boolean,
    sinks: boolean,
    sanitizers: boolean,
    localFlows: boolean,
    evidence: boolean
  }
}
```

**RiskSignalSummary:**
```ts
{
  ruleId: string,
  ruleName: string,
  ruleType: "source"|"sink"|"sanitizer",
  category: string|null,
  severity: string|null,        // only meaningful for sinks
  confidence: number|null,      // 0..1
  tags: string[],               // bounded
  evidence: EvidenceRef[]       // bounded
}
```

**EvidenceRef:**
```ts
{
  file: string,
  startLine: number,
  startCol: number,
  endLine: number|null,
  endCol: number|null,
  snippetHash: string|null      // "sha1:<hex>" or null
}
```

**RiskLocalFlowSummary (resolve ambiguity explicitly):**
Because local flows involve a *pair* of rules, store both IDs:
```ts
{
  sourceRuleId: string,
  sinkRuleId: string,
  category: string|null,        // usually from sink
  severity: string|null,        // usually from sink
  confidence: number|null,      // derived from source/sink confidences
  evidence: EvidenceRef[]
}
```

This removes the ambiguity present in `spec_risk-summaries_IMPROVED.md` where flows had a single `ruleId`.

### 10.3.2 Implement summary builder
**New file:** `src/index/risk-interprocedural/summaries.js`

Exports:
- [x] `buildRiskSummaries({ chunks, runtime, mode, log })`

Behavior:
- [x] Only run when:
  - [x] `mode === 'code'`
  - [x] `runtime.riskInterproceduralEnabled === true` OR `runtime.riskInterproceduralConfig.emitArtifacts === 'jsonl'`
  - [x] If disabled entirely, skip.
- [x] For each chunk in `state.chunks`:
  - [x] Read `chunk.docmeta?.risk` (produced by `src/index/risk.js`).
  - [x] If no risk or no signals, skip row emission.
- [x] Convert `docmeta.risk.sources/sinks/sanitizers` into `RiskSignalSummary[]`:
  - [x] Deterministic ordering:
    - [x] primary: `severity` (high->medium->low->null) for sinks only
    - [x] then `ruleId`
    - [x] then earliest evidence location
  - [x] Caps:
    - [x] `maxSignalsPerKind = 50`
    - [x] `maxEvidencePerSignal = 5`
    - [x] `maxTagsPerSignal = 10`
- [x] Convert `docmeta.risk.flows` into `RiskLocalFlowSummary[]`:
  - [x] Derive `sourceRuleId`/`sinkRuleId` from existing detector output:
    - [x] detector: `flow.ruleIds = [sourceRuleId, sinkRuleId]`
  - [x] Deterministic order:
    - [x] `sourceRuleId`, then `sinkRuleId`, then evidence location
  - [x] Caps:
    - [x] `maxLocalFlows = 50`
- [x] Evidence normalization:
  - [x] Input evidence from detector is `{ line, column, excerpt }`
  - [x] Map:
    - [x] `startLine = line`
    - [x] `startCol = column`
    - [x] `endLine = line` (or null if you prefer; pick one and be consistent)
    - [x] `endCol = column`
    - [x] `snippetHash = sha1(normalizeWhitespace(excerpt))` or null if excerpt missing/empty after normalize
  - [x] Use `sha1` from `src/shared/hash.js`
- [x] Produce `totals` and `truncated` flags:
  - [x] `totals.*` counts BEFORE truncation
  - [x] `truncated.*` indicates truncation actually occurred

### 10.3.3 Attach compact summary to `docmeta.risk.summary`
**Output field:** `chunk.docmeta.risk.summary`

Compact schema (must stay small; no evidence arrays):
```ts
{
  sources: { count: number },
  sinks: { count: number, maxSeverity: string|null },
  sanitizers: { count: number },
  localFlows: { count: number },

  topCategories: string[],   // max 5
  topTags: string[],         // max 8

  interprocedural: {
    enabled: boolean,
    summaryOnly: boolean
  }
}
```

Rules:
- [x] Populate only if chunk has at least one local risk signal or local flow.
- [x] Values must be deterministic (sort ties lexicographically).
- [x] This compact summary is what UIs and CLI can read quickly without parsing JSONL.

### 10.3.4 Export `taintHints` from local risk detector
**File:** `src/index/risk.js`

Enhancement:
- [x] The local risk detector already tracks a `taint` map internally for assignment propagation.
- [x] Add a bounded list:
  - [x] `taintHints: { taintedIdentifiers: string[] }`
  - [x] Sort + cap (e.g., 50)
- [x] Attach to `docmeta.risk`.

This improves arg-aware propagation but is not required for correctness if `strictness=conservative`.

### 10.3.5 Per-row size cap enforcement (required)
Both summary rows and compact summary additions must obey size limits.

**Hard limit:** `<= 32 KiB` per JSONL row.

Implement row trimming in `buildRiskSummaries` (or in the writer) with deterministic steps:
- [x] Drop `tags` arrays from all signals.
- [x] Reduce evidence per signal to 1.
- [x] Drop all evidence arrays.
- [x] If still too large: drop the entire summary row and record in stats (`summariesDroppedBySize++`).

### 10.3.6 Tests for summaries
Add:
- [x] `tests/indexing/risk/interprocedural/summaries-schema.test.js`
  - [x] Build a fixture index; load `risk_summaries.jsonl`; schema-validate; verify expected counts.
- [x] `tests/indexing/risk/interprocedural/summaries-determinism.test.js`
  - [x] Run summary build twice on same fixture (same runtime), assert identical JSONL output bytes.
- [x] `tests/indexing/risk/interprocedural/summaries-truncation.test.js`
  - [x] Construct an artificial chunk with huge tags/evidence, assert trimming steps fire and flags/stats reflect.

---

## 10.4 Shared callsite utilities (FOUNDATION)

### 10.4.1 Factor callSiteId algorithm into a shared helper
**Goal:** Risk flows must reference callSiteIds that match the `call_sites` writer exactly.

**New file (recommended):** `src/index/callsite-id.js`

Export:
- [x] `buildCallSiteId({ file, startLine, startCol, endLine, endCol, calleeRaw })`

Implementation:
- [x] Move (or copy exactly) the logic from `src/index/build/artifacts/writers/call-sites.js`.
- [x] Update call-sites writer to import it (so there is only one implementation).

### 10.4.2 Define edge-key and call site sampling helpers
**New file:** `src/index/risk-interprocedural/edges.js`

Exports:
- [x] `edgeKey(callerUid, calleeUid) => string` (format: `"${callerUid}->${calleeUid}"`)
- [x] `sortCallDetailsForSampling(a, b)` (deterministic comparator)
- [x] `sampleCallSitesForEdge(callDetails, { maxCallSitesPerEdge }) => CallSiteSample[]`

Where `CallSiteSample` includes:
```ts
{
  callSiteId: string,
  args: string[]|null
}
```

Sampling requirements:
- [x] Build list from caller chunk's `codeRelations.callDetails`, filtering:
  - [x] `detail.targetChunkUid === calleeUid`
- [x] Sort by:
  - [x] `detail.file` (if present, else caller chunk file)
  - [x] `detail.startLine`, `detail.startCol`, `detail.endLine`, `detail.endCol`
  - [x] `detail.calleeNormalized` then `detail.calleeRaw`
  - [x] `callSiteId` (as tie-breaker)
- [x] Take first `N`.

**Important:** Sampling is used only for *flow evidence*, not for call graph completeness.

### 10.4.3 Add local pointer hash helper (callsite IDs + graph joins)
**File (likely):** `src/index/build/shared/graph/graph-store.js`

**Goal:** Ensure callsite IDs and graph joins use a shared, stable hash for local pointers so tests can target it.

**Tasks**
- [x] Add a helper that takes callsite-local inputs and produces a stable pointer hash (inputs must match callSiteId formation).
- [x] Document how callsite IDs are formed and reused in:
  - [x] 10.5 propagation (`risk-interprocedural/engine.js`)
  - [x] 10.6 writer/manifest plumbing (`risk-interprocedural.js`, piece assembly)
- [x] Expose the helper for tests (so sampling + joins can be verified deterministically).

### 10.4.4 Tests for callsite helpers
Add:
- [x] `tests/indexing/risk/interprocedural/callsite-id.test.js`
  - [x] Ensure the shared helper matches the writer's output on representative inputs.
- [x] `tests/indexing/risk/interprocedural/callsite-sampling.test.js`
  - [x] Given an array of mocked callDetails, assert deterministic ordering and stable sampling.
- [x] Add a focused test for the local pointer hash helper (inputs -> stable hash).

---

## 10.5 Interprocedural propagation -> risk_flows

> Propagation enumerates bounded call paths from source signals to sink signals.

### 10.5.1 Define the *final* flow row schema (implement exactly)
**Artifact:** `risk_flows.jsonl` (sharded)

- [x] Implement this schema in `src/contracts/schemas/artifacts.js` and `docs/specs/risk-flows-and-call-sites.md`.

Row `RiskFlowRowV1`:
```ts
{
  schemaVersion: 1,
  flowId: string,  // "sha1:<hex>"

  source: {
    chunkUid: string,
    ruleId: string,
    ruleName: string,
    ruleType: "source",
    category: string|null,
    severity: null,
    confidence: number|null
  },

  sink: {
    chunkUid: string,
    ruleId: string,
    ruleName: string,
    ruleType: "sink",
    category: string|null,
    severity: string|null,
    confidence: number|null
  },

  path: {
    chunkUids: string[],             // length >= 2
    callSiteIdsByStep: string[][]    // length == chunkUids.length - 1
  },

  confidence: number,                // computed final confidence 0..1

  notes: {
    strictness: "conservative"|"argAware",
    sanitizerPolicy: "terminate"|"weaken",
    hopCount: number,
    sanitizerBarriersHit: number,
    capsHit: string[]                // e.g., ["maxDepth","maxPathsPerPair"]
  }
}
```

**Call sites (existing artifact; do not break)**
- [x] Treat `call_sites` as a superset artifact; risk flows only consume a subset of fields.
- [x] Keep `call_sites` contract aligned to `src/contracts/schemas/artifacts.js` (no schema changes).
- [x] Ensure callSiteIds used here are produced by the shared helper from 10.4.1.
- [x] Document the subset fields consumed by propagation in `docs/specs/risk-flows-and-call-sites.md`.
- [x] Touchpoints:
  - [x] `src/index/build/artifacts/writers/call-sites.js` (writer + callSiteId)
  - [x] `src/contracts/schemas/artifacts.js` (contract authority)

### 10.5.2 Implement propagation engine
**New file:** `src/index/risk-interprocedural/engine.js`

Export:
- [x] `computeInterproceduralRisk({ chunks, summariesByChunkUid, runtime, log })`

Return:
```ts
{
  status: "ok" | "timed_out" | "disabled",
  summaryRows: RiskSummaryRowV1[],
  flowRows: RiskFlowRowV1[],
  stats: RiskInterproceduralStatsV1,
  // for referential checks / writers
  callSiteIdsReferenced: Set<string>
}
```

### 10.5.3 Graph inputs and how to build them (no searching required)
Inputs come from the existing indexing pipeline:

- `chunk.codeRelations.callDetails[]`
  - produced by language relations collectors (e.g., `src/lang/javascript/relations.js`)
  - enriched by cross-file inference (`applyCrossFileInference`) with `detail.targetChunkUid`

- `chunk.docmeta.risk.*`
  - produced by `src/index/risk.js`

The engine must **not** require reading artifacts from disk; it runs during build.
- [x] Enforce in-code: do not read artifacts from disk inside the propagation engine (use in-memory build state only).
- [x] Cross-reference 10.2.0 entry points/consumers for paramNames flow into this section.

### 10.5.4 Deterministic traversal algorithm (BFS)
Implement BFS rooted at each `(sourceChunkUid, sourceRuleId)`:

**Root ordering:**
- [x] Sort roots by:
  - [x] `sourceChunkUid`
  - [x] `sourceRuleId`

**Queue item ("state") shape:**
```ts
{
  chunkUid: string,
  rootSource: { chunkUid: string, ruleId: string },
  pathChunkUids: string[],             // from root to current
  callSiteIdsByStep: string[][],       // parallel to edges in path
  depth: number,                       // edges traversed so far
  sanitizerBarriersHit: number,
  taintSetKey: string|null             // only used for argAware
}
```

**Visited key (per spec; include depth):**
- [x] `visitedKey = `${rootSource.chunkUid}|${rootSource.ruleId}|${chunkUid}|${taintSetKey||""}|${depth}``

This is more permissive than typical BFS; it matches the intended "allow revisiting at deeper depth" behavior.

**Expansion order:**
- [x] When expanding a node:
  - [x] Get outgoing resolved callees from callDetails (or callLinks) and sort `calleeUid` lexicographically.
  - [x] For each callee, sample callSiteIds for the edge deterministically (10.4.2).
  - [x] Enqueue callee states in that sorted order.

### 10.5.5 Traversal strictness modes
#### conservative
- [x] Treat every resolved edge as traversable.
- [x] No taint tracking required.
- [x] `taintSetKey = null` for visited key.

#### argAware
An edge (caller->callee) is traversable only if at least one call-site argument is tainted.

**Taint sources (caller side):**
- [x] `callerSummary.taintHints.taintedIdentifiers` (if present)
- [x] Regex match against source rule patterns:
  - [x] Use compiled regexes for *source rules* from runtime's risk rules (`runtime.riskConfig`)
  - [x] Match per-argument string with identifier boundary rules:
    - [x] `argText` is the string from `callDetails.args[]`
    - [x] Consider an argument tainted if:
      - [x] It contains any tainted identifier as a whole token, OR
      - [x] It matches a source rule regex pattern

**Mapping taint into callee:**
- [x] Determine callee param names:
  - [x] Prefer `callLinks.paramNames` for that callee edge if available
  - [x] Else prefer callee chunk's `docmeta.paramNames` (from 10.2)
  - [x] Else: no mapping possible; treat traversal as conservative for that edge *only if* a tainted arg exists (still require tainted arg)
- [x] If argument index `i` is tainted and `paramNames[i]` exists:
  - [x] add `paramNames[i]` to callee taint set
- [x] Always union in callee's own `taintHints.taintedIdentifiers` (if present).

**Canonical taintSetKey:**
- [x] Sort tainted identifiers, cap to 16, join with `,`
- [x] Use this for visited key and determinism.

### 10.5.6 Sanitizer policy
A "barrier chunk" is any chunk that has `signals.sanitizers.length > 0` in its summary.

- `terminate`:
  - [x] You may still emit flows that *end at this chunk* (if it contains sinks).
  - [x] Do not expand outgoing edges from this chunk.
- `weaken`:
  - [x] Continue expansion.
  - [x] Increment `sanitizerBarriersHit` counter for notes and confidence penalty.

### 10.5.7 Flow emission rules
While BFS is running:
- [x] When visiting a chunk that has sinks (`signals.sinks.length > 0`):
  - [x] For each sink signal (sorted by severity desc then ruleId):
    - [x] Emit a flow row from root source -> this sink **unless**:
      - [x] `sinkChunkUid === sourceChunkUid` (no intra-chunk flows)
      - [x] caps would be exceeded

**Per-(source,sink) path cap:**
- [x] Maintain counter keyed by:
  - [x] `${sourceChunkUid}|${sourceRuleId}|${sinkChunkUid}|${sinkRuleId}`
- [x] Do not emit more than `maxPathsPerPair`.

### 10.5.8 Caps + timeout behavior (must be explicit)
Apply caps in this order (deterministic and reflected in stats):

- [x] **Timeout** (`maxMs`):
  - [x] Start timer before any propagation.
  - [x] If exceeded:
    - [x] set status=`timed_out`
    - [x] emit **zero** flow rows
    - [x] still emit summaries (already built)
- [x] **maxEdgeExpansions**:
  - [x] increment on each edge expansion attempt
  - [x] if exceeded: stop traversal and set `capsHit += ["maxEdgeExpansions"]`
- [x] **maxDepth**:
  - [x] do not expand states with `depth >= maxDepth`
- [x] **maxPathsPerPair**:
  - [x] per key cap described above
- [x] **maxTotalFlows**:
  - [x] stop emitting once reached; set `capsHit += ["maxTotalFlows"]`

### 10.5.9 Confidence scoring (implement exactly)
For each emitted flow:
- [x] `C_source = sourceSignal.confidence ?? 0.5`
- [x] `C_sink = sinkSignal.confidence ?? 0.5`
- [x] `base = 0.1 + 0.9 * C_source * C_sink`
- [x] `hopCount = chunkUids.length - 1`
- [x] `hopDecay = 0.85 ** Math.max(0, hopCount - 1)`
- [x] `sanitizerPenalty = sanitizerPolicy==="weaken" ? (0.5 ** sanitizerBarriersHit) : 1.0`
- [x] `final = clamp(base * hopDecay * sanitizerPenalty, 0, 1)`

### 10.5.10 Per-row size cap enforcement (required)
**Hard limit:** `<= 32 KiB` per JSONL row.

Deterministic trimming for flows:
- [x] Reduce each `callSiteIdsByStep[i]` to at most 1 id.
- [x] If still too large, replace `callSiteIdsByStep` with empty arrays (correct length).
- [x] If still too large, drop the row and record in stats.

### 10.5.11 Tests for propagation
Add fixtures + tests:

- [x] `tests/fixtures/risk-interprocedural/js-simple/`
  - [x] `index.js` contains:
    - [x] `function handle(req){ const cmd=req.body; return run(build(cmd)); }`
    - [x] `function build(x){ return x; }`
    - [x] `function run(cmd){ eval(cmd); }`
  - [x] Ensure:
    - [x] source rule `source.req.body` fires in `handle`
    - [x] sink rule `sink.eval` fires in `run`
    - [x] call chain resolved: handle->build->run

- [x] `tests/indexing/risk/interprocedural/flows-conservative.test.js`
  - [x] enable riskInterprocedural (conservative)
  - [x] assert at least 1 flow:
    - [x] `path.chunkUids.length === 3`
    - [x] `callSiteIdsByStep.length === 2`
    - [x] `notes.hopCount === 2`
    - [x] `sink.ruleId === "sink.eval"` (or the actual rule id)
- [x] `tests/indexing/risk/interprocedural/flows-argaware-negative.test.js`
  - [x] modify fixture so tainted value is NOT passed (e.g., `build("constant")`)
  - [x] argAware should emit 0 flows
- [x] `tests/indexing/risk/interprocedural/flows-sanitizer-policy.test.js`
  - [x] add sanitizer call in middle function (`escape(cmd)`)
  - [x] terminate: no flows beyond sanitizer
  - [x] weaken: flow exists but confidence reduced and `sanitizerBarriersHit>0`
- [x] `tests/indexing/risk/interprocedural/flows-timeout.test.js`
  - [x] set `maxMs=1` and create a fixture with branching call graph
  - [x] expect status `timed_out` and `risk_flows` empty

---

## 10.6 Artifact writing + contracts + manifest integration

### 10.6.1 Add contracts for new artifacts
**File:** `src/contracts/schemas/artifacts.js`

Add schemas for:
- [x] `risk_summaries` (jsonl)
- [x] `risk_flows` (jsonl)
- [x] `risk_interprocedural_stats` (json)

Also add meta schemas:
- [x] `risk_summaries_meta` (shard meta)
- [x] `risk_flows_meta`

Update:
- [x] `src/contracts/registry.js` (schema registry + schema hash)

**Risk interprocedural stats schema (canonical)**
- [x] Update `docs/specs/risk-interprocedural-stats.md` to match this schema (no appendix copy).
- [x] Required counters (explicit semantics):
  - [x] `flowsEmitted`: number of risk flow records written
  - [x] `risksWithFlows`: count of riskIds that emitted >= 1 flow
  - [x] `uniqueCallSitesReferenced`: count of unique callSiteIds referenced by emitted `risk_flows`
  - [x] `callSiteSampling`: { `enabled`, `perCalleeLimit`, `totalLimit`, `seed` }
  - [x] `mode`: propagation mode
  - [x] `timingMs`: { `total`, `propagation`, `io` }
  - [x] `capsHit`: record which caps were hit (depth, fanout, paths, timeout)

### 10.6.2 Add JSONL required keys
**File:** `src/shared/artifact-io/jsonl.js`

Extend `JSONL_REQUIRED_KEYS` with:
- [x] `risk_summaries`: `["schemaVersion","chunkUid","file","signals"]`
- [x] `risk_flows`: `["schemaVersion","flowId","source","sink","path","confidence","notes"]`

(Keep required keys minimal but sufficient.)

### 10.6.3 Add compression defaults for risk JSONL
**File:** `src/index/build/artifacts/compression.js`

Add `risk_summaries` and `risk_flows` to `COMPRESSIBLE_ARTIFACTS`.
- [x] Implement compression defaults update.

### 10.6.4 Implement artifact writers
**New file:** `src/index/build/artifacts/writers/risk-interprocedural.js`

Exports:
- [x] `enqueueRiskInterproceduralArtifacts({ state, runtime, mode, outputDir, manifest, log })`

Responsibilities:
- [x] If `mode !== "code"`: do nothing.
- [x] If `!runtime.riskInterproceduralEnabled`: do nothing.
- [x] Ensure summaries + flows are computed once and stored on state:
  - [x] `state.riskInterprocedural = { summaryRows, flowRows, stats, callSiteIdsReferenced }`
- [x] Write:
  - [x] always write `risk_interprocedural_stats.json` when enabled
  - [x] write `risk_summaries` jsonl only if `emitArtifacts==="jsonl"`
  - [x] write `risk_flows` jsonl only if `emitArtifacts==="jsonl"` and `summaryOnly===false` and `status==="ok"`
- [x] Reference 10.2.0 entry points/consumers to confirm where paramNames and callDetails originate.

**Where to compute:**  
Compute in the indexing pipeline **after** cross-file inference and **before** metaV2 finalization, so compact summaries land in chunk meta.

Recommended location:
- In `src/index/build/indexer/pipeline.js` after `runCrossFileInference(...)` and before postings/writing, OR
- In `src/index/build/indexer/steps/write.js` immediately before `finalizeMetaV2(...)`

Pick one and document it; do not compute twice.
- [x] Document the chosen compute location and ensure it is invoked exactly once.

### 10.6.5 Callsite assembly helper + manifest builder touchpoints
**Files (manifest builders):**
- [x] `src/index/build/incremental.js` (index manifest + pieces manifest)
- [x] `src/index/build/piece-assembly.js` (piece assembly + manifest usage)
- [x] `src/shared/artifact-io/manifest.js` (manifest path/compat helpers)

**Tasks**
- [x] Add/confirm a helper for assembling callsite references used by risk flows.
- [x] Wire the helper into `risk-interprocedural` writer usage so callSiteIds match the manifest.
- [x] Document the manifest builder files above in the callsite assembly helper docstring/comments.

### 10.6.6 Ensure chunk meta includes compact risk summary
No special code is needed if you attach `chunk.docmeta.risk.summary`, because:
- `src/index/metadata-v2.js` already includes `risk: docmeta?.risk`

- [x] Ensure the compact summary is small enough that `chunk-meta` writer does not drop docmeta for size reasons.

### 10.6.7 Add artifacts to piece assembly
**File:** `src/index/build/piece-assembly.js`

Add optional loading for:
- [x] `risk_summaries`
- [x] `risk_flows`
- [x] `risk_interprocedural_stats`

This makes downstream tooling (sqlite build, etc.) able to access these artifacts uniformly.

### 10.6.8 Tests for artifact writing
Add:
- [x] `tests/indexing/risk/interprocedural/artifacts-written.test.js`
  - [x] Build fixture index with `emitArtifacts="jsonl"`
  - [x] Assert files exist:
    - [x] `risk_summaries.jsonl` or sharded variants (+ `.meta.json`)
    - [x] `risk_flows.jsonl` or sharded variants (+ `.meta.json`)
    - [x] `risk_interprocedural_stats.json`
  - [x] Assert shard meta points to shard files.

---

## 10.7 Validation + referential integrity

### 10.7.1 Extend validator to load + schema-validate new artifacts
Files:
- [x] `src/index/validate.js`
- [x] `src/index/validate/artifacts.js`
- [x] `src/index/validate/presence.js`

Tasks:
- [x] Add `risk_summaries`, `risk_flows`, `risk_interprocedural_stats` to optional artifact list.
- [x] If present:
  - [x] schema-validate each using contracts
- [x] Add clear validation errors (include artifact name, failing row index if jsonl).
- [x] Compatibility stance: if artifacts are missing/old schema when expected, error and instruct users to rebuild (no back-compat).

### 10.7.2 Cross-artifact referential checks (must add)
Add new validator module:
- [x] `src/index/validate/risk-interprocedural.js`

Checks:
- [x] For each summary row:
  - [x] `chunkUid` exists in `chunk_meta`
  - [x] `file` matches `chunk_meta.file` (if present)
- [x] For each flow row:
  - [x] `path.chunkUids.length >= 2`
  - [x] `path.chunkUids[0] === source.chunkUid`
  - [x] `path.chunkUids[last] === sink.chunkUid`
  - [x] `path.callSiteIdsByStep.length === path.chunkUids.length - 1`
  - [x] Every `chunkUid` in path exists in `chunk_meta`
  - [x] Every `callSiteId` referenced exists in `call_sites` **if** `call_sites` is present
    - [x] (Note: call_sites is optional; if absent, validation should warn, not fail, unless strict mode demands it.)
- [x] For stats JSON:
  - [x] `effectiveConfig` fields are consistent with normalization
  - [x] If `status==="timed_out"`: flows count is 0
  - [x] If `emitArtifacts==="jsonl"` and `summaryOnly===false` and `status==="ok"`:
    - [x] `risk_flows` artifact must exist

### 10.7.3 Tests for validator checks
Add:
- [x] `tests/indexing/validate/validator/risk-interprocedural.test.js`
  - [x] Build fixture index with riskInterprocedural on
  - [x] Run validator, expect pass
  - [x] Corrupt one `callSiteId` in a flow row, expect validator fail with specific message

---

## 10.8 CLI: explain interprocedural risk flows

### 10.8.1 Add new command wiring
**File:** `bin/pairofcleats.js`

Add command:
- [x] `risk explain`

Map to new tool:
- [x] `tools/analysis/explain-risk.js`

### 10.8.2 Implement explain tool
**New file:** `tools/analysis/explain-risk.js`

Requirements:
- [x] Inputs:
  - [x] `--index <dir>` (required)
  - [x] `--chunk <chunkUid>` (required)
  - [x] `--max <n>` (default 20)
  - [x] optional filters:
    - [x] `--source-rule <ruleId>`
    - [x] `--sink-rule <ruleId>`
    - [x] `--json`
- [x] Loads artifacts from `indexDir`:
  - [x] `chunk_meta`
  - [x] `risk_summaries` (optional)
  - [x] `risk_flows` (optional)
  - [x] `call_sites` (optional; used to print call site context)
  - [x] `risk_interprocedural_stats` (optional)
- [x] Output (human mode):
  - [x] Print chunk identification (file, symbol name, kind)
  - [x] Print compact risk summary if present
  - [x] Print flows where chunk is:
    - [x] source chunk, or sink chunk, or appears in path
    - [x] ordered by descending `confidence`, then `flowId`
  - [x] For each flow:
    - [x] print path as `file::symbol` chain
    - [x] print sampled call sites per step by looking up `callSiteId` in `call_sites` (if present)
- [x] JSON mode: emit structured JSON with same data.

### 10.8.3 Tests for CLI
Add:
- [x] `tests/cli/general/risk-explain.test.js`
  - [x] Build fixture index
  - [x] Run `node bin/pairofcleats.js risk explain --index <dir> --chunk <uid>`
  - [x] Assert output contains flowId and the expected file names

### 10.8.4 Docs update for CLI output changes
**Files:** `docs/guides/commands.md` (and any CLI reference docs that mention `risk` commands)

**Tasks**
- [x] Update CLI usage/output examples if `risk explain` output or flags change.
- [x] Add a note about rebuild requirements for old indexes (align with 10.7 compatibility stance).

---

## 10.9 Cross-cutting robustness improvements (recommended)

### 10.9.1 Call graph edge union (prevents partial call_sites from hiding callLinks)
**File:** `src/index/build/graphs.js`

Current behavior:
- [x] If there is at least one callSiteEdge, it uses callSiteEdges and does NOT fall back to callLinks for missing edges.

Improve:
- [x] Always union edges from:
  - [x] `callSites` (when present)
  - [x] `callLinks` (when present)
- [x] Add a regression test (integration or unit) that proves missing callSiteEdges do not drop callLinks.

**Suggested test file:** `tests/indexing/risk/interprocedural/flows-conservative.test.js` (extend) or add `tests/risk-interprocedural/graph-callsite-union.test.js`.

### 10.9.2 Performance audit checklist
Before marking Phase 10 complete, verify:
- [x] Summaries build is O(#risk signals) and bounded by caps (`src/index/risk-interprocedural/summaries.js`).
- [x] Propagation stops on:
  - [x] timeout
  - [x] maxEdgeExpansions
  - [x] maxDepth
  - [x] maxTotalFlows
- [x] Memory usage:
  - [x] avoid building a global all-edges map if not needed; build per chunk on-demand (`risk-interprocedural/engine.js`).
- [x] No hidden global state:
  - [x] cache keys include buildRoot/buildId where applicable (pipeline + writer helpers).
- [x] Determinism:
  - [x] output stable across runs given same codebase and config (use `tests/indexing/risk/interprocedural/summaries-determinism.test.js` and a flow determinism test).

**Files to review (explicit)**
- [x] `src/index/risk-interprocedural/summaries.js` (summary caps + determinism)
- [x] `src/index/risk-interprocedural/engine.js` (caps, BFS ordering, timeouts, memory usage)
- [x] `src/index/risk-interprocedural/edges.js` (edge ordering + sampling determinism)
- [x] `src/index/build/artifacts/writers/risk-interprocedural.js` (status/emit flags + timing)

**Tests to use**
- [x] `tests/indexing/risk/interprocedural/summaries-determinism.test.js`
- [x] `tests/indexing/risk/interprocedural/flows-conservative.test.js`
- [x] `tests/indexing/risk/interprocedural/flows-argaware-negative.test.js`
- [x] `tests/indexing/risk/interprocedural/flows-timeout.test.js`

---

## Phase 10 completion checklist (must be true)
- [x] Docs are merged; canonical specs in `docs/specs/` match code contracts (especially `call_sites`).
- [x] Deprecated/replaced spec docs have been moved to `docs/archived/` and the process is documented in `AGENTS.md` (see 10.0.3).
- [x] `indexing.riskInterprocedural` survives config load and is normalized deterministically.
- [x] Cross-file inference runs when riskInterprocedural is enabled.
- [x] `docmeta.risk.summary` is present, compact, and deterministic.
- [x] `risk_summaries` artifact rows are schema-valid, capped, and <=32KiB each.
- [x] `risk_flows` artifact rows are deterministic, capped, and <=32KiB each.
- [x] Every callSiteId referenced by flows is resolvable in `call_sites` when present.
- [x] `risk_interprocedural_stats.json` is always written when enabled and accurately reflects status/caps.
- [x] Validator enforces schema + referential integrity for the new artifacts.
- [x] `pairofcleats risk explain` works and is covered by tests.
- [x] Old indexes are not supported; validation errors instruct users to rebuild (no compatibility shim).

---

### Doc merge checklist (explicit, per original roadmap requirement)
- [x] `docs/specs/risk-interprocedural-config.md` <- merge `docs/new_docs/spec_risk-interprocedural-config_IMPROVED.md`
- [x] `docs/specs/risk-summaries.md` <- merge `docs/new_docs/spec_risk-summaries_IMPROVED.md`
- [x] `docs/specs/risk-flows-and-call-sites.md` <- merge `docs/new_docs/spec_risk-flows-and-call-sites_RECONCILED.md`
- [x] `docs/specs/risk-callsite-id-and-stats.md` <- reconcile with code + update/annotate `docs/new_docs/risk-callsite-id-and-stats_IMPROVED.md`
- [x] `docs/specs/risk-interprocedural-stats.md` <- expand from placeholder using merged stats schema
- [x] `docs/new_docs/interprocedural-state-and-pipeline_DRAFT.md` <- either promote to `docs/specs/` or merge key content into the canonical specs

---

# Appendices  -  touchpoint mappings (with line ranges) + test lane hints

These appendices are generated to remove scavenger-hunts:
- Every file path referenced in a phase body appears here.
- Existing files include **approximate** line ranges.
- Planned files/dirs are labeled **NEW**.

## Appendix P0  -  Root-level touchpoints referenced by this roadmap

- `AGENTS.md` (~L1-L63)  -  agent workflow; must include the spec archival policy.
- `COMPLETED_PHASES.md` (~L1-L12)  -  record of completed roadmap phases.
- `GIGAROADMAP.md` (~L1-L4692)  -  prerequisite plan; this roadmap assumes it is complete.
- `package.json` (~L1-L278)  -  test lane scripts (`test:unit`, `test:services`, etc).

## Appendix P7  -  repo touchpoint map

> Line ranges are approximate. Prefer anchor strings (function/export names) over line numbers.

### Existing directories referenced
- `docs/contracts/` (DIR; exists)
- `src/contracts/` (DIR; exists)
- `tests/fixtures/sample/` (DIR; exists)

### Existing src/ files referenced (edit candidates)
- `src/contracts/registry.js` (~L1-L10)  -  exports/anchors: `ARTIFACT_SCHEMA_REGISTRY`, `ARTIFACT_SCHEMA_HASH`, `ARTIFACT_SCHEMA_NAMES`, `getArtifactSchema`
- `src/contracts/schemas/artifacts.js` (~L1-L677)  -  exports/anchors: `ARTIFACT_SCHEMA_DEFS`
- `src/index/build/file-processor/embeddings.js` (~L1-L260)
- `src/index/build/indexer/embedding-queue.js` (~L1-L49)  -  exports/anchors: `enqueueEmbeddingJob`
- `src/index/build/indexer/pipeline.js` (~L1-L326)
- `src/index/build/indexer/steps/write.js` (~L1-L101)  -  exports/anchors: `writeIndexArtifactsForMode`
- `src/index/embedding.js` (~L1-L56)  -  exports/anchors: `quantizeVec`, `quantizeVecUint8`, `normalizeVec`, `createEmbedder`
- `src/index/validate.js` (~L1-L581)
- `src/retrieval/ann/providers/hnsw.js` (~L1-L27)  -  exports/anchors: `createHnswAnnProvider`
- `src/retrieval/ann/providers/lancedb.js` (~L1-L39)  -  exports/anchors: `createLanceDbAnnProvider`
- `src/retrieval/cli-index.js` (~L1-L416)  -  exports/anchors: `resolveIndexDir`, `requireIndexDir`, `buildQueryCacheKey`, `getIndexSignature`
- `src/retrieval/cli/load-indexes.js` (~L1-L368)
- `src/retrieval/cli/normalize-options.js` (~L1-L273)  -  exports/anchors: `normalizeSearchOptions`
- `src/retrieval/cli/options.js` (~L1-L141)  -  exports/anchors: `getMissingFlagMessages`, `estimateIndexBytes`, `resolveIndexedFileCount`, `resolveBm25Defaults`, `loadBranchFromMetrics`
- `src/retrieval/cli/query-plan.js` (~L1-L205)  -  exports/anchors: `buildQueryPlan`
- `src/retrieval/lancedb.js` (~L1-L180)
- `src/retrieval/query-intent.js` (~L1-L84)  -  exports/anchors: `classifyQuery`, `resolveIntentVectorMode`, `resolveIntentFieldWeights`
- `src/retrieval/rankers.js` (~L1-L292)  -  exports/anchors: `rankBM25Legacy`, `getTokenIndex`, `rankBM25`, `rankBM25Fields`, `rankMinhash`
- `src/retrieval/sqlite-helpers.js` (~L1-L544)  -  exports/anchors: `createSqliteHelpers`
- `src/shared/artifact-io.js` (~L1-L12)
- `src/shared/artifact-io/manifest.js` (~L1-L291)  -  exports/anchors: `resolveManifestPath`, `loadPiecesManifest`, `readCompatibilityKey`, `normalizeMetaParts`, `resolveMetaFormat`
- `src/shared/embedding-adapter.js` (~L1-L158)  -  exports/anchors: `getEmbeddingAdapter`
- `src/shared/embedding-utils.js` (~L1-L176)  -  exports/anchors: `DEFAULT_EMBEDDING_POOLING`, `DEFAULT_EMBEDDING_NORMALIZE`, `DEFAULT_EMBEDDING_TRUNCATION`, `isVectorLike`, `mergeEmbeddingVectors`
- `src/shared/hnsw.js` (~L1-L160)  -  exports/anchors: `normalizeHnswConfig`, `resolveHnswPaths`, `loadHnswIndex`, `rankHnswIndex`
- `src/shared/lancedb.js` (~L1-L65)  -  exports/anchors: `normalizeLanceDbConfig`, `resolveLanceDbPaths`, `resolveLanceDbTarget`
- `src/storage/lmdb/schema.js` (~L1-L49)  -  exports/anchors: `LMDB_SCHEMA_VERSION`, `LMDB_META_KEYS`, `LMDB_ARTIFACT_KEYS`, `LMDB_ARTIFACT_LIST`, `LMDB_REQUIRED_ARTIFACT_KEYS`
- `src/storage/sqlite/build/incremental-update.js` (~L1-L567)
- `src/storage/sqlite/vector.js` (~L1-L71)  -  exports/anchors: `quantizeVec`, `resolveQuantizationParams`, `dequantizeUint8ToFloat32`, `toSqliteRowId`, `packUint32`

### Existing tools/ files referenced (edit candidates)
- `tools/build/embeddings.js` (~L1-L12)
- `tools/build/embeddings/cache.js` (~L1-L26)  -  exports/anchors: `buildCacheIdentity`, `resolveCacheRoot`, `resolveCacheDir`, `buildCacheKey`, `isCacheValid`
- `tools/build/embeddings/cli.js` (~L1-L95)  -  exports/anchors: `parseBuildEmbeddingsArgs`
- `tools/build/embeddings/embed.js` (~L1-L119)  -  exports/anchors: `assertVectorArrays`, `runBatched`, `ensureVectorArrays`, `createDimsValidator`, `isDimsMismatch`
- `tools/build/embeddings/hnsw.js` (~L1-L115)  -  exports/anchors: `createHnswBuilder`
- `tools/build/embeddings/lancedb.js` (~L1-L143)
- `tools/build/embeddings/manifest.js` (~L1-L111)  -  exports/anchors: `updatePieceManifest`
- `tools/build/embeddings/runner.js` (~L1-L763)
- `tools/build/embeddings/sqlite-dense.js` (~L1-L209)  -  exports/anchors: `updateSqliteDense`
- `tools/build/lmdb-index.js` (~L1-L311)
- `tools/dict-utils/paths/db.js` (~L1-L62)  -  exports/anchors: `resolveLmdbPaths`, `resolveSqlitePaths`
- `tools/index/validate.js` (~L1-L130)
- `tools/service/indexer-service.js` (~L1-L441)
- `tools/service/queue.js` (~L1-L270)  -  exports/anchors: `resolveQueueName`, `getQueuePaths`
- `tools/sqlite/vector-extension.js` (~L1-L393)  -  exports/anchors: `getBinarySuffix`, `getPlatformKey`, `getVectorExtensionConfig`, `resolveVectorExtensionPath`, `loadVectorExtension`

### Existing docs/ files referenced (edit candidates)
- `docs/contracts/artifact-schemas.md` (~L1-L67)
- `docs/contracts/public-artifact-surface.md` (~L1-L104)
- `docs/guides/embeddings.md` (~L1-L92)
- `docs/guides/search.md` (~L1-L74)

### Existing tests/ files referenced (edit candidates)
- `tests/indexing/artifacts/artifact-io-manifest-discovery.test.js` (~L1-L60)  -  lane: `integration`; run: `npm run test:integration -- --match artifact-io-manifest-discovery.test`
- `tests/indexing/embeddings/embedding-queue-defaults.test.js` (~L1-L37)  -  lane: `integration`; run: `npm run test:integration -- --match embedding-queue-defaults`
- `tests/indexing/embeddings/embedding-queue.test.js` (~L1-L51)  -  lane: `integration`; run: `npm run test:integration -- --match embedding-queue`
- `tests/indexing/embeddings/embeddings-validate.test.js` (~L1-L82)  -  lane: `integration`; run: `npm run test:integration -- --match embeddings-validate`
- `tests/retrieval/ann/hnsw-ann.test.js` (~L1-L124)  -  lane: `integration`; run: `npm run test:integration -- --match hnsw-ann`
- `tests/retrieval/ann/hnsw-atomic.test.js` (~L1-L90)  -  lane: `integration`; run: `npm run test:integration -- --match hnsw-atomic`
- `tests/retrieval/ann/hnsw-candidate-set.test.js` (~L1-L78)  -  lane: `integration`; run: `npm run test:integration -- --match hnsw-candidate-set`
- `tests/retrieval/ann/lancedb-ann.test.js` (~L1-L100)  -  lane: `integration`; run: `npm run test:integration -- --match lancedb-ann`
- `tests/storage/lmdb/lmdb-backend.test.js` (~L1-L122)  -  lane: `integration`; run: `npm run test:integration -- --match lmdb-backend`
- `tests/storage/lmdb/lmdb-corruption.test.js` (~L1-L105)  -  lane: `integration`; run: `npm run test:integration -- --match lmdb-corruption`
- `tests/storage/lmdb/lmdb-report-artifacts.test.js` (~L1-L125)  -  lane: `integration`; run: `npm run test:integration -- --match lmdb-report-artifacts`

### Planned/new paths referenced in this phase (create as needed)
- **tests/**
  - `tests/ann-parity.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match ann-parity`
  - `tests/indexing/embeddings/embedding-normalization-consistency.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match embedding-normalization-consistency`
  - `tests/embedding-quantization-no-wrap.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match embedding-quantization-no-wrap`
  - `tests/fixtures/embeddings` (NEW fixture/dir  -  create as part of this phase)
  - `tests/fixtures/embeddings/basic-repo` (NEW fixture/dir  -  create as part of this phase)
  - `tests/fixtures/embeddings/missing-vectors` (NEW fixture/dir  -  create as part of this phase)
  - `tests/fixtures/embeddings/quantization-caps` (NEW fixture/dir  -  create as part of this phase)
  - `tests/retrieval/ann/hnsw-target-selection.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match hnsw-target-selection`
  - `tests/services/indexer/indexer-service-embedding-job-uses-build-root.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match indexer-service-embedding-job-uses-build-root`
  - `tests/retrieval/ann/ann-parity.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match ann-parity.test`
  - `tests/lancedb-candidate-filtering.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match lancedb-candidate-filtering`
  - `tests/indexing/embeddings/manifest-embeddings-pieces.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match manifest-embeddings-pieces`
  - `tests/quantize-embedding-utils.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match quantize-embedding-utils`
  - `tests/retrieval/backend/retrieval-strict-manifest-embeddings.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match retrieval-strict-manifest-embeddings`
  - `tests/storage/embeddings/embeddings-backend-resilience.test.js` (NEW)  -  intended lane: `storage`; run (once created): `npm run test:storage -- --match embeddings-backend-resilience.test`
  - `tests/retrieval/ann/ann-backend-selection.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match ann-backend-selection.test`
  - `tests/shared/cache/cache-preflight-meta.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match cache-preflight-meta.test`
  - `tests/retrieval/ann/dense-vector-mode.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match dense-vector-mode.test`
  - `tests/retrieval/ann/hnsw-insert-failures.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match hnsw-insert-failures.test`
  - `tests/retrieval/ann/hnsw-load-signature.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match hnsw-load-signature.test`
  - `tests/retrieval/ann/lancedb-candidate-filtering.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match lancedb-candidate-filtering.test`
  - `tests/retrieval/ann/lancedb-connection-cache.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match lancedb-connection-cache.test`
  - `tests/retrieval/ann/lancedb-filter-pushdown.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match lancedb-filter-pushdown.test`
  - `tests/storage/lmdb/lmdb-mapsize.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match lmdb-mapsize.test`
  - `tests/storage/sqlite/ann/sqlite-ann-mode-scope.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match sqlite-ann-mode-scope.test`


## Appendix P9  -  repo touchpoint map

> Line ranges are approximate. Prefer anchor strings (function/export names) over line numbers.

### Existing directories referenced
- `src/index/build/artifacts/writers/` (DIR; exists)
- `src/index/identity/` (DIR; exists)
- `src/index/tooling/` (DIR; exists)
- `tests/type-inference-crossfile/` (DIR; exists)
- `tools/bench/` (DIR; exists)

### Existing src/ files referenced (edit candidates)
- `src/contracts/schemas/artifacts.js` (~L1-L677)  -  exports/anchors: `ARTIFACT_SCHEMA_DEFS`
- `src/index/build/artifacts.js` (~L1-L528)
- `src/index/build/file-processor.js` (~L1-L529)  -  exports/anchors: `createFileProcessor`
- `src/index/build/file-processor/assemble.js` (~L1-L127)  -  exports/anchors: `buildChunkPayload`
- `src/index/build/file-processor/relations.js` (~L1-L71)  -  exports/anchors: `buildCallIndex`, `buildFileRelations`, `stripFileRelations`
- `src/index/build/graphs.js` (~L1-L267)  -  exports/anchors: `buildRelationGraphs`
- `src/index/chunk-id.js` (~L1-L21)  -  exports/anchors: `buildChunkId`, `resolveChunkId`
- `src/index/identity/chunk-uid.js` (~L1-L204)  -  exports/anchors: `PRE_CONTEXT_CHARS`, `POST_CONTEXT_CHARS`, `ESCALATION_CONTEXT_CHARS`, `MAX_COLLISION_PASSES`, `normalizeForUid`
- `src/index/metadata-v2.js` (~L1-L301)  -  exports/anchors: `buildMetaV2`, `finalizeMetaV2`
- `src/index/segments.js` (~L1-L190)  -  exports/anchors: `assignSegmentUids`, `discoverSegments`, `chunkSegments`
- `src/index/tooling/clangd-provider.js` (~L1-L187)  -  exports/anchors: `CLIKE_EXTS`, `createClangdProvider`
- `src/index/tooling/pyright-provider.js` (~L1-L127)  -  exports/anchors: `PYTHON_EXTS`, `createPyrightProvider`
- `src/index/tooling/sourcekit-provider.js` (~L1-L93)  -  exports/anchors: `SWIFT_EXTS`, `createSourcekitProvider`
- `src/index/tooling/typescript-provider.js` (~L1-L467)  -  exports/anchors: `createTypeScriptProvider`
- `src/index/type-inference-crossfile/pipeline.js` (~L1-L438)
- `src/index/type-inference-crossfile/symbols.js` (~L1-L30)  -  exports/anchors: `leafName`, `isTypeDeclaration`, `addSymbol`, `resolveUniqueSymbol`
- `src/index/validate.js` (~L1-L581)
- `src/lang/javascript/relations.js` (~L1-L687)  -  exports/anchors: `buildCodeRelations`
- `src/map/build-map.js` (~L1-L288)  -  exports/anchors: `buildNodeList`, `buildMapCacheKey`
- `src/map/build-map/edges.js` (~L1-L186)  -  exports/anchors: `buildEdgesFromGraph`, `buildEdgesFromCalls`, `buildEdgesFromUsage`, `buildEdgesFromCallSummaries`, `buildImportEdges`
- `src/map/build-map/filters.js` (~L1-L229)  -  exports/anchors: `resolveFocus`, `normalizeIncludeList`, `applyLimits`, `applyScopeFilter`, `applyCollapse`
- `src/map/build-map/symbols.js` (~L1-L95)  -  exports/anchors: `buildSymbolId`, `buildPortId`, `upsertMember`, `buildMemberIndex`, `resolveMemberByName`
- `src/map/isometric/client/map-data.js` (~L1-L47)  -  exports/anchors: `initMapData`
- `src/shared/artifact-io.js` (~L1-L12)
- `src/shared/artifact-io/jsonl.js` (~L1-L79)  -  exports/anchors: `resolveJsonlRequiredKeys`, `parseJsonlLine`
- `src/shared/artifact-schemas.js` (~L1-L2)
- `src/shared/identity.js` (~L1-L104)  -  exports/anchors: `buildChunkRef`, `isSemanticSymbolId`, `resolveSymbolJoinKey`, `resolveChunkJoinKey`, `buildSymbolKey`

### Existing docs/ files referenced (edit candidates)
- `docs/phases/phase-9/identity-contracts.md` (~L1-L132)
- `docs/phases/phase-9/migration-and-backcompat.md` (~L1-L45)
- `docs/phases/phase-9/symbol-artifacts-and-pipeline.md` (~L1-L122)
- `docs/specs/identity-contract.md` (~L1-L313)

### Existing tests/ files referenced (edit candidates)
- `tests/indexing/relations/graph-chunk-id.test.js` (~L1-L43)  -  lane: `integration`; run: `npm run test:integration -- --match graph-chunk-id`

### Planned/new paths referenced in this phase (create as needed)
- **src/**
  - `src/index/build/artifacts/writers/symbol-edges.js` (NEW  -  create as part of this phase)
  - `src/index/build/artifacts/writers/symbol-occurrences.js` (NEW  -  create as part of this phase)
  - `src/index/build/artifacts/writers/symbols.js` (NEW  -  create as part of this phase)
  - `src/index/identity/kind-group.js` (NEW  -  create as part of this phase)
  - `src/index/identity/normalize.js` (NEW  -  create as part of this phase)
  - `src/index/identity/segment-uid.js` (NEW  -  create as part of this phase)
  - `src/index/identity/symbol.js` (NEW  -  create as part of this phase)
  - `src/index/identity/virtual-path.js` (NEW  -  create as part of this phase)
  - `src/index/type-inference-crossfile/resolve-relative-import.js` (NEW  -  create as part of this phase)
  - `src/index/type-inference-crossfile/resolver.js` (NEW  -  create as part of this phase)
- **tools/**
  - `tools/bench/symbol-resolution-bench.js` (NEW  -  create as part of this phase)
- **docs/**
  - `docs/specs/symbol-artifacts.md` (NEW doc/spec  -  create as part of this phase)
  - `docs/specs/symbol-identity-and-symbolref.md` (NEW doc/spec  -  create as part of this phase)
- **tests/**
  - `tests/indexing/artifacts/symbol-artifacts-smoke.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match symbol-artifacts-smoke.test`
  - `tests/benchmarks` (NEW fixture/dir  -  create as part of this phase)
  - `tests/indexing/type-inference/crossfile/resolve-relative-import.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match resolve-relative-import.test`
  - `tests/indexing/type-inference/crossfile/symbolref-resolution.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match symbolref-resolution.test`
  - `tests/determinism` (NEW fixture/dir  -  create as part of this phase)
  - `tests/indexing/determinism/symbol-artifact-order.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match symbol-artifact-order.test`
  - `tests/fixtures/graph/chunkuid-join` (NEW fixture/dir  -  create as part of this phase)
  - `tests/fixtures/identity/chunkuid-collision` (NEW fixture/dir  -  create as part of this phase)
  - `tests/fixtures/imports/relative-ambiguous` (NEW fixture/dir  -  create as part of this phase)
  - `tests/fixtures/symbols/ambiguous-defs` (NEW fixture/dir  -  create as part of this phase)
  - `tests/identity/chunk-uid-stability.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match chunk-uid-stability.test`
  - `tests/identity/segment-uid-stability.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match segment-uid-stability.test`
  - `tests/indexing/identity/symbol-identity.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match symbol-identity.test`
  - `tests/indexing/determinism/chunkuid-determinism.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match chunkuid-determinism.test`
  - `tests/integration/file-name-collision-no-wrong-join.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match file-name-collision-no-wrong-join.test`
  - `tests/indexing/relations/graph-relations-v2-chunkuid.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match graph-relations-v2-chunkuid.test`
  - `tests/indexing/imports/import-resolver-relative.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match import-resolver-relative.test`
  - `tests/indexing/map/map-chunkuid-join.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match map-chunkuid-join.test`
  - `tests/indexing/determinism/symbol-artifact-determinism.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match symbol-artifact-determinism.test`
  - `tests/indexing/map/map-build-symbol-identity.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match map-build-symbol-identity.test`
  - `tests/indexing/artifacts/symbols/symbol-artifacts-emission.test.js` (NEW)  -  intended lane: `services`; run (once created): `npm run test:services -- --match symbol-artifacts-emission.test`
  - `tests/indexing/artifacts/symbols/symbol-edges-ambiguous.test.js` (NEW)  -  intended lane: `services`; run (once created): `npm run test:services -- --match symbol-edges-ambiguous.test`
  - `tests/indexing/artifacts/symbols/symbol-links-by-chunkuid.test.js` (NEW)  -  intended lane: `services`; run (once created): `npm run test:services -- --match symbol-links-by-chunkuid.test`
  - `tests/unit/chunk-uid-stability.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match chunk-uid-stability.test`
  - `tests/indexing/identity/identity-symbolkey-scopedid.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match identity-symbolkey-scopedid.test`
  - `tests/unit/segment-uid-stability.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match segment-uid-stability.test`
  - `tests/indexing/type-inference/symbolref-envelope.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match symbolref-envelope.test`
  - `tests/tooling/lsp/clangd-provider-output-shape.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match clangd-provider-output-shape.test`
  - `tests/tooling/lsp/pyright-provider-output-shape.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match pyright-provider-output-shape.test`
  - `tests/tooling/lsp/sourcekit-provider-output-shape.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match sourcekit-provider-output-shape.test`
  - `tests/tooling/lsp/typescript-provider-output-shape.test.js` (NEW)  -  intended lane: `unit`; run (once created): `npm run test:unit -- --match typescript-provider-output-shape.test`
  - `tests/validate/chunk-uid-required.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match chunk-uid-required.test`
  - `tests/indexing/validate/symbol-integrity-strict.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match symbol-integrity-strict.test`


## Appendix P10  -  repo touchpoint map

> Line ranges are approximate. Prefer anchor strings (function/export names) over line numbers.

### Existing directories referenced
- `docs/new_docs/` (DIR; exists)
- `docs/specs/` (DIR; exists)
- `src/contracts/` (DIR; exists)

### Existing src/ files referenced (edit candidates)
- `src/contracts/registry.js` (~L1-L10)  -  exports/anchors: `ARTIFACT_SCHEMA_REGISTRY`, `ARTIFACT_SCHEMA_HASH`, `ARTIFACT_SCHEMA_NAMES`, `getArtifactSchema`
- `src/contracts/schemas/artifacts.js` (~L1-L677)  -  exports/anchors: `ARTIFACT_SCHEMA_DEFS`
- `src/index/build/artifacts/compression.js` (~L1-L46)  -  exports/anchors: `resolveCompressionConfig`
- `src/index/build/artifacts/writers/call-sites.js` (~L1-L276)  -  exports/anchors: `createCallSites`, `enqueueCallSitesArtifacts`
- `src/index/build/graphs.js` (~L1-L267)  -  exports/anchors: `buildRelationGraphs`
- `src/index/build/indexer/pipeline.js` (~L1-L326)
- `src/index/build/indexer/signatures.js` (~L1-L120)  -  exports/anchors: `SIGNATURE_VERSION`, `buildIncrementalSignatureSummary`, `buildIncrementalSignaturePayload`, `buildTokenizationKey`, `buildIncrementalSignature`
- `src/index/build/indexer/steps/relations.js` (~L1-L205)  -  exports/anchors: `resolveImportScanPlan`, `preScanImports`, `postScanImports`, `runCrossFileInference`
- `src/index/build/indexer/steps/write.js` (~L1-L101)  -  exports/anchors: `writeIndexArtifactsForMode`
- `src/index/build/piece-assembly.js` (~L1-L512)
- `src/index/build/runtime/runtime.js` (~L1-L683)
- `src/index/metadata-v2.js` (~L1-L301)  -  exports/anchors: `buildMetaV2`, `finalizeMetaV2`
- `src/index/risk.js` (~L1-L404)  -  exports/anchors: `normalizeRiskConfig`, `detectRiskSignals`
- `src/index/type-inference-crossfile/extract.js` (~L1-L84)  -  exports/anchors: `extractReturnTypes`, `extractParamTypes`, `extractReturnCalls`, `inferArgType`
- `src/index/validate.js` (~L1-L581)
- `src/index/validate/artifacts.js` (~L1-L38)  -  exports/anchors: `buildArtifactLists`
- `src/index/validate/presence.js` (~L1-L183)  -  exports/anchors: `createArtifactPresenceHelpers`
- `src/lang/javascript/relations.js` (~L1-L687)  -  exports/anchors: `buildCodeRelations`
- `src/shared/artifact-io/jsonl.js` (~L1-L79)  -  exports/anchors: `resolveJsonlRequiredKeys`, `parseJsonlLine`
- `src/shared/hash.js` (~L1-L74)  -  exports/anchors: `sha1`, `sha1File`, `setXxhashBackend`

### Existing tools/ files referenced (edit candidates)
- `tools/dict-utils/config.js` (~L1-L310)  -  exports/anchors: `loadUserConfig`, `getEffectiveConfigHash`, `getCacheRoot`, `getDictConfig`, `applyAdaptiveDictConfig`

### Existing docs/ files referenced (edit candidates)
- `docs/config/contract.md` (~L1-L70)
- `docs/config/schema.json` (~L1-L264)
- `docs/new_docs/interprocedural-state-and-pipeline_DRAFT.md` (~L1-L156)
- `docs/new_docs/risk-callsite-id-and-stats_IMPROVED.md` (~L1-L120)
- `docs/new_docs/spec_risk-flows-and-call-sites_RECONCILED.md` (~L1-L141)
- `docs/new_docs/spec_risk-interprocedural-config_IMPROVED.md` (~L1-L99)
- `docs/new_docs/spec_risk-summaries_IMPROVED.md` (~L1-L169)
- `docs/specs/risk-callsite-id-and-stats.md` (~L1-L162)
- `docs/specs/risk-flows-and-call-sites.md` (~L1-L341)
- `docs/specs/risk-interprocedural-config.md` (~L1-L171)
- `docs/specs/risk-interprocedural-stats.md` (~L1-L9)
- `docs/specs/risk-summaries.md` (~L1-L253)

### Existing bin/ files referenced (edit candidates)
- `bin/pairofcleats.js` (~L1-L279)

### Planned/new paths referenced in this phase (create as needed)
- **src/**
  - `src/index/build/artifacts/writers/risk-interprocedural.js` (NEW  -  create as part of this phase)
  - `src/index/callsite-id.js` (NEW  -  create as part of this phase)
  - `src/index/risk-interprocedural/config.js` (NEW  -  create as part of this phase)
  - `src/index/risk-interprocedural/edges.js` (NEW  -  create as part of this phase)
  - `src/index/risk-interprocedural/engine.js` (NEW  -  create as part of this phase)
  - `src/index/risk-interprocedural/summaries.js` (NEW  -  create as part of this phase)
  - `src/index/validate/risk-interprocedural.js` (NEW  -  create as part of this phase)
- **tools/**
  - `tools/analysis/explain-risk.js` (NEW  -  create as part of this phase)
- **docs/**
  - `docs/archived` (NEW  -  create as part of this phase)
  - `docs/archived/README.md` (NEW doc/spec  -  create as part of this phase)
  - `docs/archived/phase-10` (NEW  -  create as part of this phase)
  - `docs/archived/specs/phase-10` (NEW  -  create as part of this phase)
- **tests/**
  - `tests/cli/general/risk-explain.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match risk-explain.test`
  - `tests/fixtures/risk-interprocedural/js-simple` (NEW fixture/dir  -  create as part of this phase)
  - `tests/lang/javascript/javascript-paramnames.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match javascript-paramnames.test`
  - `tests/indexing/risk/interprocedural/artifacts-written.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match artifacts-written.test`
  - `tests/indexing/risk/interprocedural/callsite-id.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match callsite-id.test`
  - `tests/indexing/risk/interprocedural/callsite-sampling.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match callsite-sampling.test`
  - `tests/indexing/risk/interprocedural/config-normalization.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match config-normalization.test`
  - `tests/indexing/risk/interprocedural/flows-argaware-negative.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match flows-argaware-negative.test`
  - `tests/indexing/risk/interprocedural/flows-conservative.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match flows-conservative.test`
  - `tests/indexing/risk/interprocedural/flows-sanitizer-policy.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match flows-sanitizer-policy.test`
  - `tests/indexing/risk/interprocedural/flows-timeout.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match flows-timeout.test`
  - `tests/indexing/risk/interprocedural/runtime-gating.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match runtime-gating.test`
  - `tests/indexing/risk/interprocedural/summaries-determinism.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match summaries-determinism.test`
  - `tests/indexing/risk/interprocedural/summaries-schema.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match summaries-schema.test`
  - `tests/indexing/risk/interprocedural/summaries-truncation.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match summaries-truncation.test`
  - `tests/unit` (NEW fixture/dir  -  create as part of this phase)
  - `tests/indexing/validate/validator/risk-interprocedural.test.js` (NEW)  -  intended lane: `integration`; run (once created): `npm run test:integration -- --match risk-interprocedural.test`

## Phase 10 — Interprocedural risk propagation + explainability artifacts (Completed)
- Phase 10 completed on quantum-leviathan-protocol; artifacts, validation, CLI explain, and robustness/test updates finished (see QUANTUM_LEVIATHAN_PROTOCOL.md).

## Phase 11 — Graph-powered product features (context packs, impact, explainability, ranking)

### Objective
Turn graph and identity primitives into **safe, bounded, deterministic** product surfaces: graph context packs, impact analysis, explainable graph-aware ranking (opt-in), and structured outputs suitable for both CLI use and future API/MCP consumers.

- Assumes canonical identities exist (e.g., chunkUid/SymbolId and a canonical reference envelope for unresolved/ambiguous links).
- Any graph expansion MUST be bounded and MUST return truncation metadata when caps trigger (depth/fanout/paths/nodes/edges/candidates/work-units/wall-clock).
- The default search contract must remain stable: graph features can change ordering when enabled, but must not change membership/correctness.
- Outputs are JSON-first (schema-validated); Markdown render is optional and deterministic.

---

### 11.0 Shared foundations (contracts, determinism, config)

- [x] Define Phase 11 shared contract types (authoritative spec: `docs/phases/phase-11/spec.md`):
  - `NodeRef` (chunk/symbol/file)
  - `ReferenceEnvelope` (resolved/ambiguous/unresolved + bounded candidates)
  - `WarningRecord`
  - `TruncationRecord`
  - stable ordering rules (nodeKey/edgeKey)
- [x] Add provenance metadata requirements for all Phase 11 JSON outputs:
  - `generatedAt`
  - `indexCompatKey` or `indexSignature`
  - `capsUsed`
  - optional `repo` / `indexDir`
- [x] Add schemas in `src/contracts/schemas/analysis.js`:
  - `GRAPH_CONTEXT_PACK_SCHEMA`
  - `GRAPH_IMPACT_SCHEMA`
  - `COMPOSITE_CONTEXT_PACK_SCHEMA`
  - `API_CONTRACTS_SCHEMA`
  - `ARCHITECTURE_REPORT_SCHEMA`
  - `SUGGEST_TESTS_SCHEMA`
- [x] Add validators in `src/contracts/validators/analysis.js`.

- [x] Determinism helpers + work-budget caps.
  - Add stable comparator utilities for NodeRef/edges/paths.
  - Add deterministic `maxWorkUnits` tracking (recommended for all traversals).
  - Treat `maxWallClockMs` as optional fuse; always record truncation when it triggers.
- [x] Define deterministic `maxWallClockMs` semantics:
  - check cadence (e.g., every N work units)
  - stop only at step boundaries
  - emit truncation metadata with observed/omitted counts

- [x] Config surface.
  - `indexing.graph.caps`
  - `retrieval.graph.caps`
  - `retrieval.graphRanking.*`
  - `retrieval.contextExpansion.*`
  - Touchpoints:
    - `docs/config/schema.json`
    - `tools/dict-utils/config.js`
    - `tools/config/validate.js`
    - `src/config/validate.js`

- [x] Standardize module home for new graph tooling commands.
  - Use `src/integrations/tooling/` for new command handlers and renderers.
  - Keep graph primitives under `src/graph/` and pack assembly under `src/context-pack/`.

- [x] Centralize artifact presence + loading for graph-powered features.
  - Add a single GraphStore + loader path used by all Phase 11 commands.
  - Touchpoints:
    - `src/shared/artifact-io/manifest.js`
    - `src/shared/artifact-io/loaders.js`
    - `src/graph/store.js`
    - `src/index/validate/presence.js` (optional artifacts)

- [x] Move graph build caps + identity-first node IDs earlier (dependency for all consumers).
  - Update `src/index/build/graphs.js` to use config-driven caps and record which cap triggered.
  - Enforce identity-first graph node IDs for new writes (legacy read-compat only).
  - Touchpoints:
    - `src/index/build/graphs.js`
    - `src/index/build/indexer/steps/relations.js`
    - `src/index/build/artifacts/graph-relations.js` (if present) or the current writer location

- [x] Define harness determinism controls:
  - `--outDir`, `--runId`
  - injectable date/time for CI to avoid `<date>` path drift

#### Tests
- [x] `tests/shared/contracts/phase11-schemas-validate.test.js`
  - Validate representative payload fixtures against each Phase 11 schema.

---

### 11.1 Graph context packs (bounded neighborhood extraction) + retrieval context-expansion hardening

- [x] Define a graph context pack contract (JSON-first; Markdown render optional).
  - Output shape (minimum):
    - `seed` (canonical id + type)
    - `nodes[]` (bounded; stable ordering)
    - `edges[]` (bounded; stable ordering; include direction and edge type)
    - `paths[]` (optional; bounded witness paths when requested)
    - `truncation[]` (one or more truncation records; absent only when no caps trigger)
    - `warnings[]` (e.g., missing artifacts, partial/unresolved edges)
  - Link safety:
    - Any edge endpoint that fails to resolve MUST use a reference envelope (resolved/ambiguous/unresolved + candidates + reason + confidence).
  - Graph filters (optional):
    - `graphs` (callGraph/importGraph/usageGraph/symbolEdges)
    - `edgeTypes` (call/usage/import/export/dataflow; `symbol_edges.type` when graph = symbolEdges)
    - `minConfidence` (0..1)
    - `includePaths` (emit witness paths)
  - Cap surface (configurable):
    - `maxDepth`, `maxFanoutPerNode`, `maxNodes`, `maxEdges`, `maxPaths`, `maxCandidates`, `maxWorkUnits`, `maxWallClockMs`.

- [x] Add deterministic Markdown renderer for graph context packs.
  - `src/retrieval/output/graph-context-pack.js` (new; stable section ordering and formatting)

- [x] Implement deterministic neighborhood extraction for a seed id (k-hop).
  - Prefer graph source artifacts when present:
    - `graph_relations` for call/usage/import graphs (baseline).
    - `symbol_edges` / callsite artifacts (when available) for evidence and SymbolId identity.
  - Deterministic traversal:
    - Stable adjacency ordering (lexicographic by canonical id, then edge type).
    - Deterministic tie-breaking when budgets are hit (e.g., keep lowest id first, or keep highest confidence first, but make it explicit and stable).
  - Strict bounding:
    - Enforce caps during traversal (no “collect everything then slice”).
    - Record truncation metadata with which cap triggered and how much was omitted.

- [x] Refactor `src/retrieval/context-expansion.js` to use the shared graph neighborhood utilities (do not make it the engine).
  - Touchpoints:
    - `src/retrieval/context-expansion.js`
    - `src/shared/artifact-io/manifest.js` (artifact presence checks via manifest)
  - [x] Eliminate eager `{id, reason}` candidate explosion.
    - Convert candidate generation to a streaming/short-circuit loop that stops as soon as `maxPerHit` / `maxTotal` / `maxWorkUnits` is satisfied.
    - Add per-source caps (e.g., max call edges examined, max import links examined) so worst-case repos cannot allocate unbounded candidate sets.
  - [x] Remove duplicate scanning and make reason selection intentional.
    - Track candidates in a `Map<id, { bestReason, bestPriority, reasons? }>` rather than pushing duplicates into arrays.
    - Define a fixed reason priority order (example: call > usage > export > import > nameFallback) and document it.
    - When `--explain` is enabled, optionally retain the top-N reasons per id (bounded).
  - [x] Stop assuming `chunkMeta[id]` is a valid dereference forever.
    - Build a `byDocId` (and/or `byChunkUid`) lookup once and use it for dereferencing.
    - If a dense array invariant is still desired for performance, validate it explicitly and fall back to map deref when violated.
  - [x] Prefer identity-first joins.
    - When graph artifacts exist, resolve neighbors via canonical ids rather than `byName` joins.
    - Keep name-based joins only as an explicit fallback mode with low-confidence markers.

#### Tests (path-corrected for current test layout)
- [x] `tests/retrieval/graph/context-pack-basic.test.js`
  - Build a small fixture graph; request a context pack for a known seed; assert expected caller/callee/import/usage neighbors are present.
- [x] `tests/retrieval/graph/context-pack-caps.test.js`
  - Use a large synthetic graph fixture; assert truncation metadata is present and stable when caps trigger.
- [x] `tests/retrieval/graph/context-pack-determinism.test.js`
  - Run the same request twice; assert stable ordering and identical payloads.
- [x] `tests/retrieval/context-expansion/context-expansion-no-candidate-explosion.test.js`
  - Stress fixture with many relations; assert expansion completes within a time/memory budget and does not allocate unbounded candidate arrays.
- [x] `tests/retrieval/context-expansion/context-expansion-reason-precedence.test.js`
  - A chunk reachable via multiple relation types records the highest-priority reason deterministically.
- [x] `tests/retrieval/context-expansion/context-expansion-shuffled-chunkmeta.test.js`
  - Provide a shuffled `chunkMeta` where array index != docId; assert expansion still resolves correct chunks via a map-based dereference.
- [x] `tests/retrieval/context-expansion/context-expansion-determinism.test.js`
  - Run expansion twice on the same fixture; assert stable ordering and identical results.

Fixture sources:
- `tests/fixtures/graph/context-pack/`
- `tests/fixtures/retrieval/context-expansion/`

Touchpoints (consolidated; anchors are approximate):
- `src/retrieval/context-expansion.js` (~L1 `pushIds`, ~L8 `buildContextIndex`, ~L77 `expandContext`)
- `src/shared/artifact-io/manifest.js` (~L254 `resolveArtifactPresence`)
- `src/shared/artifact-io/loaders.js` (~L312 `loadGraphRelations`)
- `src/graph/store.js` (new; manifest-aware graph loader + adjacency access)
- `src/graph/neighborhood.js` (new; deterministic bounded traversal)
- `src/graph/context-pack.js` (new; pack construction + truncation metadata)
- `src/retrieval/output/graph-context-pack.js` (new; deterministic Markdown renderer)
- `src/integrations/tooling/graph-context.js` (new; CLI command implementation)
- `src/retrieval/cli/index-loader.js` (~L73 `loadFileRelations`, ~L89 `loadRepoMap`; add `loadGraphRelations`)
- `src/retrieval/cli/run-search-session.js` (~L86 `contextExpansionEnabled`, ~L486 expansion block)
- `src/retrieval/cli/normalize-options.js` (~L173 `contextExpansionEnabled`)
- `src/retrieval/cli/options.js` + `src/retrieval/cli-args.js` (CLI flags/help)
- `src/retrieval/cli/render.js` (~L4 `renderSearchOutput`)
- `src/retrieval/output/context.js` (~L1 `cleanContext` for context-pack rendering)
- `bin/pairofcleats.js` (CLI wiring: `graph-context`)
- `src/contracts/schemas/analysis.js` (add `GRAPH_CONTEXT_PACK_SCHEMA`)
- `src/contracts/validators/analysis.js` (add `validateGraphContextPack`)
- `docs/contracts/analysis-schemas.md` + `docs/contracts/search-cli.md` (schema + CLI JSON)



---

### 11.2 Impact analysis (callers/callees + k-hop impact radius) with witness paths

- [x] Implement bounded impact analysis on top of the same neighborhood extraction primitives.
  - Provide `impactAnalysis(seed, { direction, depth, caps, edgeFilters })` returning:
    - impacted nodes (bounded; stable ordering)
    - at least one witness path per impacted node when available (bounded; do not enumerate all paths)
    - explicit unresolved/partial path markers when edges cannot be resolved.
  - Deterministic ordering:
    - stable sort by `(distance, confidence desc, name/id asc)` (or equivalent stable rule), and document it.

- [x] CLI surface (API-ready internal design).
  - Add `pairofcleats impact --repo … --seed <id> --direction upstream|downstream --depth 2 --format json|md`.
  - Add graph filters: `--graphs`, `--edgeTypes`, `--minConfidence`.
  - Ensure the implementation is factored so an API/MCP handler can call the same core function with the same caps and output schema.

- [x] Optional “changed-set” impact mode (non-blocking in this phase).
  - Accept `--changed <file>` repeated and `--changed-file <path>` (newline-separated paths) and compute:
    - impacted symbols in and around changed files, then traverse upstream/downstream bounded.
  - If `seed` is omitted, derive candidate seeds deterministically and emit a `ReferenceEnvelope` with bounded candidates.
  - If SCM integration is unavailable, degrade gracefully (explicit warning; still supports explicit `--changed` lists).
  - Specify deterministic changed-set → seed derivation:
    - ordering of derived seeds
    - max seeds cap + truncation behavior

#### Tests (path-corrected for current test layout)
- [x] `tests/retrieval/graph/impact-analysis-downstream.test.js`
  - Seed a function; assert downstream impacted nodes include an expected callee and a witness path is returned.
- [x] `tests/retrieval/graph/impact-analysis-upstream.test.js`
  - Seed a function; assert upstream impacted nodes include an expected caller and a witness path is returned.
- [x] `tests/retrieval/graph/impact-analysis-caps-and-truncation.test.js`
  - Trigger caps deterministically; assert truncation metadata identifies which cap fired and results remain stable.
- [x] `tests/retrieval/graph/impact-analysis-determinism.test.js`
  - Run the same request twice; assert stable ordering and identical payloads.
- [x] `tests/retrieval/graph/impact-analysis-changed-set.test.js`
  - Provide `--changed` inputs; assert deterministic seed derivation and bounded output.

Fixture sources:
- `tests/fixtures/graph/impact/`

Touchpoints (consolidated; anchors are approximate):
- `src/graph/impact.js` (new; bounded impact analysis)
- `src/graph/witness-paths.js` (new; witness path reconstruction)
- `src/graph/neighborhood.js` (shared traversal primitives)
- `src/integrations/tooling/impact.js` (new; CLI command implementation)
- `src/integrations/tooling/render-impact.js` (new; stable human + JSON renderers)
- `bin/pairofcleats.js` (CLI wiring: `impact`)
- `src/contracts/schemas/analysis.js` (add `GRAPH_IMPACT_SCHEMA`)
- `src/contracts/validators/analysis.js` (add `validateGraphImpact`)
- `docs/contracts/analysis-schemas.md` + `docs/contracts/graph-tools-cli.md` (schema + CLI JSON)



---

### 11.3 Context pack assembly for tooling/LLM (chunk text + graph + types + risk) + explainability rendering

- [x] Implement a “context pack assembler” that composes multiple bounded slices into a single package.
  - Inputs:
    - `seed` (chunkUid/SymbolId)
    - budgets (`maxTokens` and/or `maxBytes`, plus graph caps)
    - toggles (includeGraph, includeTypes, includeRisk, includeImports, includeUsages, includeCallersCallees)
    - per-slice caps (`maxTypeEntries`, `maxRiskFlows`, `maxRiskEvidencePerFlow`)
  - Output (recommended minimum):
    - `primary` (chunk excerpt + stable identifiers + file/segment provenance)
    - `graph` (from 11.1; bounded neighborhood)
    - `types` (bounded: referenced/declared/inferred/tooling-backed summaries when available)
    - `risk` (bounded: top-N flows/summaries crossing the seed, with callsite evidence when present)
    - `truncation[]` (aggregate truncation across slices)
    - `warnings[]` (missing artifacts, partial resolution, disabled features)
  - Notes:
    - Do not embed large raw code blobs; prefer bounded excerpts and (when needed) snippet hashes + location coordinates.
    - Use stable ordering inside each slice so context packs are deterministic across runs.

- [x] Add CLI surface:
  - `pairofcleats context-pack --repo … --seed <id> --hops 2 --maxTokens 4000 --format json|md`
  - Add toggles: `--includeGraph`, `--includeTypes`, `--includeRisk`, `--includeImports`, `--includeUsages`, `--includeCallersCallees`
  - Add per-slice caps: `--maxTypeEntries`, `--riskMaxFlows`, `--riskMaxEvidencePerFlow`
  - For Markdown output, use consistent sections and a deterministic ordering (primary first, then callers/callees, then imports/usages, then risk).

- [x] Add explain-risk rendering for flows when risk artifacts exist.
  - Provide an output mode (flag or subcommand) that prints:
    - the path of symbols/chunks
    - file/line evidence (callsites) when present
    - rule ids/categories and confidence
    - bounded snippets or snippet hashes (never unbounded)
  - Ensure output is stable, capped, and does not assume optional color helpers exist.

- [x] Define excerpt whitespace policy:
  - clarify when indentation is preserved (code excerpts) vs normalized (summary/output cleaning)
  - document how `cleanContext()` interacts with excerpt rendering

- [x] Harden retrieval output helpers used by these features (integrate known bugs in touched files).
  - Touchpoints:
    - `src/retrieval/output/context.js`
    - `src/retrieval/output/explain.js`
  - [x] `cleanContext()` must remove fence lines that include language tags.
    - Treat any line whose trimmed form starts with ``` as a fence line.
  - [x] `cleanContext()` must not throw on non-string items.
    - Guard/coerce before calling `.trim()`.
  - [x] Explain formatting must not assume `color.gray()` exists.
    - Provide a no-color fallback when `color?.gray` is not a function.

#### Tests (path-corrected for current test layout)
- [x] `tests/retrieval/context-pack/context-pack-assembly.test.js`
  - Build fixture; assemble a context pack; assert it contains primary + at least one neighbor + deterministic truncation structure.
- [x] `tests/retrieval/output/risk-explain-render.test.js`
  - Use a risk-flow fixture; assert output includes a call path and evidence coordinates and remains bounded.
- [x] `tests/retrieval/output/clean-context-fences.test.js`
  - Ensure ```ts / ```json fences are removed (not just bare ```).
- [x] `tests/retrieval/output/clean-context-nonstring-guard.test.js`
  - Feed non-string items; assert no crash and only string lines survive.
- [x] `tests/retrieval/output/explain-color-fallback.test.js`
  - Provide a partial color impl; assert explain rendering does not throw.

Fixture sources:
- `tests/fixtures/context-pack/`
- `tests/fixtures/risk/`

Touchpoints (consolidated):
- `src/context-pack/assemble.js` (new; bounded pack assembly)
- `src/graph/context-pack.js` + `src/graph/neighborhood.js` (graph slice + traversal)
- `src/retrieval/output/context.js` (~L1 `cleanContext`; hardening: fence stripping, type guards)
- `src/retrieval/output/explain.js` (~L1 `formatExplainLine`; null-safe + color fallback)
- `src/retrieval/output/graph-context-pack.js` (new; deterministic Markdown renderer)
- `src/integrations/tooling/context-pack.js` (new; CLI command implementation)
- `bin/pairofcleats.js` (CLI wiring: `context-pack`)
- `docs/contracts/analysis-schemas.md` + `docs/contracts/graph-tools-cli.md` (schema + CLI JSON)



---

### 11.4 Graph-aware ranking hooks (opt-in) + explainability

- [x] Introduce optional graph-aware ranking features that can be enabled without changing result membership.
  - Candidate feature families (bounded, deterministic):
    - node degree / in-degree / out-degree (prefer precomputed analytics artifacts when available)
    - proximity to the query-hit seed within the graph neighborhood (bounded k-hop)
    - proximity to risk hotspots (if risk summaries/flows exist)
    - same-cluster bonus (only if clustering artifacts exist; otherwise skip and emit a warning)
  - Guardrails:
    - Never compute expensive global graph metrics per query unless explicitly cached and bounded.
    - Default behavior remains unchanged unless explicitly enabled.
  - Define caching/analytics plan:
    - precomputed artifact vs session cache decision
    - schema and loader if artifact-based
  - Define tie-breaker rules for equal graph deltas/features.

- [x] Integrate into retrieval ranking with an explicit feature-hook layer.
  - Touchpoints (expected; anchors are approximate):
    - `src/retrieval/pipeline.js` (~L25 `createSearchPipeline`; scoring assembly + explain output)
    - `src/retrieval/cli/run-search-session.js` (~L86 context options + ~L486 expansion block)
    - `src/retrieval/cli/normalize-options.js` (~L173 context defaults; add graph ranking config)
    - `src/retrieval/cli/options.js` + `src/retrieval/cli-args.js` (flag plumbing + help text)
    - `src/retrieval/output/explain.js` (~L12 `formatScoreBreakdown` for graph section)
  - Configuration:
    - `retrieval.graphRanking.enabled` (default false)
    - `retrieval.graphRanking.weights` (explicit; versioned defaults)
    - `retrieval.graphRanking.maxGraphWorkUnits` (deterministic cap)
    - optional `retrieval.graphRanking.maxWallClockMs` (fuse)
    - optional `retrieval.graphRanking.seedSelection`
    - optional `retrieval.graphRanking.seedK`
    - CLI mapping (must remain in sync with docs):
      - `--graph-ranking-max-work` -> `retrieval.graphRanking.maxGraphWorkUnits`
      - `--graph-ranking-max-ms` -> `retrieval.graphRanking.maxWallClockMs`
      - `--graph-ranking-seeds` -> `retrieval.graphRanking.seedSelection`
      - `--graph-ranking-seed-k` -> `retrieval.graphRanking.seedK`
  - Explainability:
    - When `--explain` (or a dedicated `--explain-ranking`) is enabled, include a `graph` section in the score breakdown:
      - feature contributions and the final blended delta.

#### Tests (path-corrected for current test layout)
- [x] `tests/retrieval/ranking/graph-ranking-toggle.test.js`
  - Run the same query with graph ranking off/on; assert result sets are identical but ordering may differ.
- [x] `tests/retrieval/ranking/graph-ranking-explain.test.js`
  - With explain enabled, assert output includes named graph feature contributions.
- [x] `tests/retrieval/ranking/graph-ranking-determinism.test.js`
  - Re-run the same query twice with graph ranking enabled; assert ordering and explain payload are stable.
- [x] `tests/retrieval/ranking/graph-ranking-membership-invariant.test.js`
  - Run the same query with graph ranking on/off; assert result membership is identical.

---

### 11.5 Graph expansion caps as a config surface + calibration harness (language × size tier)

- [x] Align cap vocabulary across indexing + retrieval (depends on 11.0 graph caps update).
  - Ensure all expansions use the same cap names and truncation metadata semantics.
  - Touchpoints:
    - `src/retrieval/context-expansion.js` (cap naming + truncation records)
    - `src/graph/neighborhood.js`
    - `docs/perf/graph-caps.md`
  - Required behavior:
    - Every expansion returns truncation metadata when it truncates.
    - Truncation metadata indicates which cap fired and provides counts (omitted nodes/edges/paths) when measurable.

- [x] Implement a metrics-harvesting harness to justify default caps.
  - Inputs:
    - Use/extend `benchmarks/repos.json` to define repos.
    - Normalize into tiers: small / typical / large / huge / problematic(massive).
    - Define numeric tier thresholds for `small/typical/large/huge/problematic`.
  - For each repo/tier (outside CI for huge/problematic):
    - run indexing with graphs enabled
    - compute graph distributions (node/edge counts, degree stats, SCC size)
    - run bounded neighborhood expansions for representative seeds (random, top-degree, entrypoints)
    - record timing and output sizes
  - Outputs:
    - versioned bundle under `benchmarks/results/<date>/graph-caps/`
    - machine-readable defaults: `docs/perf/graph-caps-defaults.json` (new; keyed by language and optional tier)
    - documentation: `docs/perf/graph-caps.md` (p95 behavior for typical tier + presets for huge/problematic)
  - Define default-selection logic:
    - explicit rule for converting harness measurements into `graph-caps-defaults.json`

#### Tests (path-corrected for current test layout)
- [x] `tests/indexing/graphs/caps-enforced-and-reported.test.js`
  - Build a small fixture; request deep expansion; assert caps trigger deterministically and truncation metadata is present.
- [x] `tests/perf/bench/graph-caps-harness-smoke.test.js`
  - Run the harness on a tiny in-tree fixture; assert it writes a results JSON file with required fields and deterministic ordering.

---

### 11.6 Cross-file API contracts (report + optional artifact)

- [x] Provide an API-contract extraction/report surface based on existing artifacts (do not require new parsing).
  - For each exported symbol (as available via symbol artifacts):
    - canonical signature (declared + tooling-backed when available)
    - observed call signatures (from bounded callsite evidence / callDetails summaries)
    - compatibility warnings (arity mismatches, incompatible argument kinds, unresolved targets)
  - Output formats:
    - JSON (machine; versioned schema)
    - Markdown (human; deterministic ordering)
  - Strict caps:
    - max symbols analyzed per run
    - max calls sampled per symbol
    - max warnings emitted (with truncation metadata)
  - Define API contract source precedence + sampling rules:
    - exported symbol identification precedence
    - canonical signature source precedence
    - deterministic call sampling rules
    - warning/mismatch criteria (language-aware + confidence)

- [x] CLI surface:
  - `pairofcleats api-contracts --repo … [--only-exports] [--fail-on-warn] --format json|md`

- [x] Optional: enable an artifact emitter for downstream automation.
  - `api_contracts.jsonl` (one record per symbol) with strict schema validation and caps.

#### Tests (path-corrected for current test layout)
- [x] `tests/tooling/api-contracts/api-contracts-basic.test.js`
  - Fixture with an exported function called with multiple shapes; assert contract report includes observed calls and a mismatch warning.
- [x] `tests/tooling/api-contracts/api-contracts-caps.test.js`
  - Trigger caps; assert truncation metadata is present and stable.
- [x] `tests/tooling/api-contracts/api-contracts-fail-on-warn.test.js`
  - Ensure `--fail-on-warn` yields non-zero exit when warnings are present.
- [x] `tests/tooling/api-contracts/api-contracts-schema-validate.test.js`
  - Validate output against `API_CONTRACTS_SCHEMA` (including truncation + warnings).

Fixture sources:
- `tests/fixtures/tooling/api-contracts/`

Touchpoints (consolidated; anchors are approximate):
- `src/integrations/tooling/api-contracts.js` (new; report builder)
- `src/shared/artifact-io/loaders.js` (~L312 `loadGraphRelations`; add loaders for call_sites/symbols as needed)
- `src/contracts/schemas/analysis.js` (add `API_CONTRACTS_SCHEMA`)
- `src/contracts/validators/analysis.js` (add `validateApiContracts`)
- `src/contracts/schemas/artifacts.js` (add `api_contracts` artifact schema if emitted)
- `src/index/validate.js` (strict validation for new artifact)
- `bin/pairofcleats.js` (CLI wiring: `api-contracts`)
- `docs/contracts/analysis-schemas.md` + `docs/contracts/graph-tools-cli.md` (schema + CLI JSON)

---

### 11.7 Architecture slicing and boundary enforcement (rules + CI-friendly output)

- [x] Add a rules format for architectural constraints over graphs.
  - Rule types (minimum viable):
    - forbidden edges by path glob/module group (importGraph)
    - forbidden call edges by symbol tags or file globs (callGraph)
    - layering rules (optional; best-effort) that detect edges going “up-layer”
  - Outputs:
    - bounded report with counts, top offending edges, and a deterministic ordering
    - CI-friendly JSON (versioned schema)
  - Add reusable module groups:
    - named selector sets referenced by rules

- [x] CLI surface:
  - `pairofcleats architecture-check --repo … --rules <path> --format json|md [--fail-on-violation]`

#### Tests (path-corrected for current test layout)
- [x] `tests/tooling/architecture/forbidden-import-edge.test.js`
  - Fixture with a forbidden import; assert violation is reported deterministically.
- [x] `tests/tooling/architecture/forbidden-call-edge.test.js`
  - Fixture with a forbidden call edge; assert violation is reported deterministically.
- [x] `tests/tooling/architecture/report-is-bounded.test.js`
  - Large fixture triggers caps; assert truncation metadata exists and report remains parseable.
- [x] `tests/tooling/architecture/report-determinism.test.js`
  - Run the same rules twice; assert ordering and output are identical.

Fixture sources:
- `tests/fixtures/tooling/architecture/`

Touchpoints (consolidated; anchors are approximate):
- `src/graph/architecture.js` (new; rule evaluation)
- `src/graph/neighborhood.js` (shared traversal primitives)
- `src/integrations/tooling/architecture-check.js` (new; CLI command implementation)
- `src/contracts/schemas/analysis.js` (add `ARCHITECTURE_REPORT_SCHEMA`)
- `src/contracts/validators/analysis.js` (add `validateArchitectureReport`)
- `bin/pairofcleats.js` (CLI wiring: `architecture-check`)
- `docs/contracts/analysis-schemas.md` + `docs/contracts/graph-tools-cli.md` (schema + CLI JSON)

---

### 11.8 Test selection heuristics (suggest tests impacted by a change set)

- [x] Implement a bounded, deterministic test suggestion tool that uses graphs when available.
  - Identify tests using path conventions and language-aware patterns:
    - `*.test.*`, `*_test.*`, `/tests/`, `__tests__/`, etc.
  - Given a changed set (`--changed <file>` repeated or a file list):
    - map changed files/symbols to seed nodes
    - traverse upstream/downstream within caps
    - rank candidate tests based on witness paths, proximity, and (optional) centrality
  - Output:
    - top-K suggested tests + brief rationale (witness path summary), bounded and deterministic
  - Specify deterministic changed-set → seed derivation:
    - ordering of derived seeds
    - max seeds cap + truncation behavior
  - Define fallback behavior when graph artifacts are missing:
    - heuristic fallback (e.g., path-based test discovery)
    - required warning codes

- [x] CLI surface:
  - `pairofcleats suggest-tests --repo … --changed <...> --max 50 --format json|md`

#### Tests (path-corrected for current test layout)
- [x] `tests/tooling/test-selection/suggest-tests-basic.test.js`
  - Fixture where a changed function is called by a test; assert the test is suggested.
- [x] `tests/tooling/test-selection/suggest-tests-bounded.test.js`
  - Trigger caps; assert truncation metadata is present and ordering is stable.
- [x] `tests/tooling/test-selection/suggest-tests-determinism.test.js`
  - Run the same input twice; assert stable ordering and identical output.
- [x] `tests/tooling/test-selection/suggest-tests-witness-path.test.js`
  - Ensure witness path summary is present and bounded when available.

Fixture sources:
- `tests/fixtures/tooling/suggest-tests/`

Touchpoints (test selection):
- `src/integrations/tooling/suggest-tests.js` (new; core suggestion engine)
- `src/graph/store.js` + `src/graph/neighborhood.js` (shared traversal + loading)
- `bin/pairofcleats.js` (CLI wiring: `suggest-tests`)
- `docs/contracts/analysis-schemas.md` + `docs/contracts/graph-tools-cli.md` (schema + CLI JSON)

---

### 11.9 Docs + CLI wiring

#### 11.9.1 CLI wiring
- [x] Update `bin/pairofcleats.js`:
  - add new commands (graph-context, impact, context-pack, api-contracts, architecture-check, suggest-tests)
  - remove/repair stale `search` flag allowlist validation so wrapper accepts all supported search flags
- [x] Implement per-command handlers under `src/integrations/tooling/`:
  - `graph-context.js`, `impact.js`, `context-pack.js`, `api-contracts.js`, `architecture-check.js`, `suggest-tests.js`

#### 11.9.2 Documentation updates
- [x] Update:
  - `docs/contracts/analysis-schemas.md`
  - `docs/contracts/search-cli.md`
  - `docs/contracts/mcp-api.md`
- [x] Add:
  - `docs/contracts/graph-tools-cli.md`
  - `docs/perf/graph-caps.md`
  - `docs/phases/phase-11/spec.md`

---

### Phase 11 schema summary (authoritative spec: `docs/phases/phase-11/spec.md`)

- Shared types:
  - `NodeRef` (chunk/symbol/file)
  - `ReferenceEnvelope` (resolved/ambiguous/unresolved + bounded candidates)
  - `TruncationRecord` + `WarningRecord` (bounded)
- Graph context pack:
  - `{ version, seed, nodes[], edges[], paths?, truncation?, warnings?, stats? }`
- Impact analysis:
  - `{ version, seed, direction, depth, impacted[], truncation?, warnings? }`
- Composite context pack:
  - `{ version, seed, primary, graph?, types?, risk?, truncation?, warnings? }`
- API contracts report:
  - `{ version, generatedAt, options, symbols[], truncation?, warnings? }`
- Architecture report:
  - `{ version, rules[], violations[], truncation?, warnings? }`
- Suggest-tests:
  - `{ version, changed[], suggestions[], truncation?, warnings? }`

---

## Phase 12 — MCP Migration + API/Tooling Contract Formalization

### Objective
Modernize and stabilize PairOfCleats’ integration surface by (1) migrating MCP serving to the **official MCP SDK** (with a safe compatibility window), (2) formalizing MCP tool schemas, version negotiation, and error codes across legacy and SDK transports, and (3) hardening cancellation/timeouts so MCP requests cannot leak work or hang.

- Current grounding: MCP entrypoint is `tools/mcp/server.js` (custom JSON-RPC framing via `tools/mcp/transport.js`), with tool defs in `src/integrations/mcp/defs.js` and protocol helpers in `src/integrations/mcp/protocol.js`.
- This phase must keep existing tools functioning while adding SDK mode, and it must not silently accept inputs that do nothing.

---

### 12.1 Dependency strategy and capability gating for the official MCP SDK

- [x] Decide how the MCP SDK is provided and make the decision explicit in code + docs.
  - Options:
    - [ ] Dependency (always installed)
    - [x] Optional dependency (install attempted; failures tolerated)
    - [ ] External optional peer (default; capability-probed)
  - [x] Implement the chosen strategy consistently:
    - [x] `package.json` (if dependency/optionalDependency is chosen)
    - [x] `src/shared/capabilities.js` (probe `@modelcontextprotocol/sdk` and report clearly)
    - [x] `src/shared/optional-deps.js` (ensure `tryImport()` handles ESM correctly for the SDK)
  - [x] Define the SDK import path and the capability surface it drives (e.g., `@modelcontextprotocol/sdk` + which subpath).

- [x] Ensure MCP server mode selection is observable and capability-gated.
  - Touchpoints:
    - [x] `tools/mcp/server.js` — entrypoint dispatch
    - [x] `tools/config/dump.js` (or MCP status tool) — report effective MCP mode + SDK availability
    - [x] `docs/config/schema.json` — add `mcp.mode` (legacy|sdk|auto) and `mcp.sdk` capability note
  - [x] Define precedence for MCP mode per `docs/config/surface-directives.md` (CLI > config; env vars only if explicitly allowed as exceptions).
    - [x] If an env override is retained (e.g., `MCP_MODE`), document the exception in `docs/config/contract.md` and surface it in config inventory.

Touchpoints (anchors; approximate):
- `tools/mcp/server.js` (~L4 `getToolDefs`, ~L8 `handleToolCall`, ~L31 `mcpConfig`)
- `src/shared/capabilities.js` (~L7 `getCapabilities`, ~L38 `mcp.sdk`)
- `src/shared/optional-deps.js` (~L22 `tryRequire`, ~L33 `tryImport`)
- `tools/mcp/repo.js` (~L7 `parseTimeoutMs`)
- `tools/config/dump.js` (if used; otherwise define a new MCP status tool under `tools/mcp/`)
  - Reference docs: `docs/api/mcp-server.md`, `docs/phases/phase-12/tooling-and-api-contract.md`

#### Tests / Verification

- [x] Unit: capabilities probe reports `mcp.sdk=true/false` deterministically.
- [x] CI verification: when SDK is absent, SDK-mode tests are skipped cleanly with a structured reason.

---

### 12.2 SDK-backed MCP server (parallel mode with explicit cutover flag)

- [x] Implement an SDK-backed server alongside the legacy transport.
  - Touchpoints:
    - [x] `tools/mcp/server-sdk.js` (new) — SDK-backed server implementation
    - [x] `tools/mcp/server.js` — dispatch `--mcp-mode legacy|sdk` (or env var), defaulting to legacy until parity is proven
      - [x] Add `--mcp-mode` (and `MCP_MODE`) parsing here; bind to `mcp.mode` config.
  - [x] Requirements for SDK server:
    - [x] Register tools from `src/integrations/mcp/defs.js` as the source of truth.
    - [x] Route tool calls to the existing implementations in `tools/mcp/tools.js` (no behavior fork).
    - [x] Support stdio transport as the baseline.
    - [x] Emit a capabilities payload that allows clients to adapt (e.g., doc extraction disabled, SDK missing, etc.).
      - [x] Explicitly define whether this is returned via `initialize` or a separate tool response (see 12.4).

- [x] Add a deprecation window for the legacy transport.
  - [x] Document the cutover plan and timeline in `docs/contracts/mcp-api.md`.
  - [x] Keep legacy transport only until SDK parity tests are green, then remove or hard-deprecate with warnings.

Touchpoints (anchors; approximate):
- `tools/mcp/server.js` (~L4 `getToolDefs`, ~L8 `handleToolCall`; add SDK dispatch flag)
- `tools/mcp/server-sdk.js` (new; SDK wiring)
- `tools/mcp/tools.js` (tool execution entrypoint)
- `src/integrations/mcp/defs.js` (tool definitions + schemaVersion)
  - Reference docs: `docs/api/mcp-server.md`, `docs/phases/phase-12/tooling-and-api-contract.md`

#### Tests / Verification

- [x] Services: `tests/services/mcp/sdk-mode.test.js` (new)
  - Skip if SDK is not installed.
  - Start `tools/mcp/server-sdk.js` and run at least:
    - `tools/list`
    - one representative `tools/call` (e.g., `index_status`)
  - Assert: response shape is valid, errors have stable codes, and server exits cleanly.

---

### 12.3 Tool schema versioning, conformance, and drift guards

- [x] Make tool schemas explicitly versioned and enforce bump discipline.
  - Touchpoints:
    - [x] `src/integrations/mcp/defs.js` — add `schemaVersion` (semver or monotonic integer) and `toolVersion` (package.json)
    - [x] `docs/contracts/mcp-api.md` — document compatibility rules for schema changes
    - [x] `docs/contracts/mcp-tools.schema.json` (new) — canonical tool schema snapshot
    - [x] `src/integrations/mcp/validate.js` (new) — validate tool schemas against snapshot
  - [x] Define the canonical initialize response shape (schema + example).
    - [x] `docs/contracts/mcp-api.md` — `initialize` response structure
    - [x] `docs/contracts/mcp-initialize.schema.json` (new) — schema for response payload

- [x] Consolidate MCP argument → execution mapping to one audited path.
  - Touchpoints:
    - [x] `tools/mcp/tools.js` (search/build tools)
    - [x] `src/integrations/core/index.js` (shared arg builder, if used)
  - [x] Create a single mapping function per tool (or a shared builder) so schema additions cannot be “accepted but ignored”.

- [x] Conformance requirement for the `search` tool:
  - [x] Every field in the MCP `search` schema must either:
    - [x] affect emitted CLI args / search execution, or
    - [x] be removed from schema, or
    - [x] be explicitly marked “reserved” and rejected if set.
  - [x] Avoid duplicative builders (do not maintain two separate lists of flags).

- [x] Fix known MCP tool wiring correctness hazards in modified files:
  - [x] In `tools/mcp/tools.js`, remove variable shadowing that breaks cancellation/AbortSignal handling (numeric arg is now `contextLines`; `context` remains the `{ signal }` object).

Touchpoints (anchors; approximate):
- `src/integrations/mcp/defs.js` (~L1 exports; add `schemaVersion`)
- `tools/mcp/tools.js` (~L? `runSearchTool` / arg mapping)
- `src/integrations/mcp/protocol.js` (error + envelope helpers)
- `docs/contracts/mcp-api.md` (schema versioning rules)

#### Tests / Verification

- [x] Unit: `tests/services/mcp/mcp-schema-version.test.js` (new; keep it in services lane for MCP)
  - Assert `schemaVersion` exists.
  - Assert changes to tool defs require bumping `schemaVersion` (enforced by snapshot contract or explicit check).

- [x] Unit: `tests/services/mcp/mcp-search-arg-mapping.test.js` (new; keep it in services lane for MCP)
  - For each supported schema field, assert mapping produces the expected CLI flag(s).
  - Include a negative test: unknown fields are rejected (or ignored only if policy says so, with an explicit warning).

- [x] Update existing: `tests/services/mcp/mcp-schema.test.js`
  - Keep snapshotting tool property sets.
  - Add schemaVersion presence check.
  - Add toolVersion presence check.
  - Update `docs/contracts/coverage-ledger.md` to include new MCP schema tests.

---

### 12.4 Error codes, protocol negotiation, and response-shape consistency

- [x] Standardize tool error payloads and map internal errors to stable MCP error codes.
  - Touchpoints:
    - [x] `src/integrations/mcp/protocol.js` — legacy transport formatting helpers
    - [x] `tools/mcp/transport.js` — legacy transport handler
    - [x] `tools/mcp/server-sdk.js` — SDK error mapping
    - [x] `src/shared/error-codes.js` — canonical internal codes
  - [x] Define stable, client-facing codes (examples):
    - [x] invalid args
    - [x] index missing
    - [x] tool timeout
    - [x] not supported / capability missing
    - [x] cancelled
  - [x] Add `docs/contracts/mcp-error-codes.md` (or a section in `docs/contracts/mcp-api.md`) defining the canonical MCP error registry.
  - [x] Ensure both transports emit the same logical error payload shape (even if wrapper envelopes differ).

- [x] Implement protocol/version negotiation and expose capabilities.
  - [x] On `initialize`, echo supported protocol versions, the tool schema version, toolVersion, and effective capabilities.
  - [x] Define the authoritative initialize response builder in `src/integrations/mcp/protocol.js`.
  - [x] Define a capabilities schema (or a section in `docs/contracts/mcp-api.md`) with required keys and value semantics.

#### Tests / Verification

- [x] Unit: protocol negotiation returns consistent `protocolVersion` + `schemaVersion`.
- [x] Regression: error payload includes stable `code` and `message` across both transports for representative failures.
  - [x] Add `mcp-mode` selection test (legacy vs sdk) based on CLI/config/env.
  - [x] Add capability payload test for both transports (initialize contains capabilities).
  - [x] Align test path references with `docs/phases/phase-12/test-strategy-and-conformance-matrix.md` (services lane vs `tests/mcp/*`).

Touchpoints (anchors; approximate):
- `src/integrations/mcp/protocol.js` (error payload shaping + initialize response)
- `tools/mcp/transport.js` (legacy transport)
- `tools/mcp/server-sdk.js` (SDK error mapping)
- `src/shared/error-codes.js` (canonical internal codes)

---

### 12.5 Cancellation, timeouts, and process hygiene (no leaked work)

- [x] Ensure cancellation/timeout terminates underlying work within a bounded time.
  - Touchpoints:
    - [x] `tools/mcp/transport.js`
    - [x] `tools/mcp/runner.js`
    - [x] `tools/mcp/tools.js`
  - [x] Cancellation correctness:
    - [x] Canonicalize JSON-RPC IDs for in-flight tracking (`String(id)`), so numeric vs string IDs do not break cancellation.
    - [x] Ensure `$/cancelRequest` cancels the correct in-flight request and that cancellation is observable (result marked cancelled, no “success” payload).
  - [x] Timeout correctness:
    - [x] Extend `runNodeAsync()` to accept an `AbortSignal` and kill the child process (and its process tree) on abort/timeout.
    - [x] Thread AbortSignal through `runToolWithProgress()` and any spawned-node tool helpers.
    - [x] Ensure `withTimeout()` triggers abort and does not merely reject while leaving work running.
  - [x] Progress notification hygiene:
    - [x] Throttle/coalesce progress notifications (max ~1 per 250ms per tool call, coalesced) to avoid overwhelming clients.

- [x] Tighten MCP test process cleanup.
  - [x] After sending `shutdown`/`exit`, explicitly await server process termination (bounded deadline, then kill) to prevent leaked subprocesses during tests.

#### Tests / Verification

- [x] Update existing: `tests/services/mcp/mcp-robustness.test.js`
  - Add “wait for exit” after `exit` (bounded).
  - Add cancellation test:
    - Start a long-ish operation, send `$/cancelRequest`, assert the tool response is cancelled and that work stops (no continuing progress after cancellation).
  - [x] Add progress-throttle assertion (if practical): bursty progress is coalesced.

- [x] Unit: `tests/services/mcp/mcp-runner-abort-kills-child.test.js` (new)
  - Spawn a child that would otherwise run long; abort; assert child exit occurs quickly and no orphan remains.
  - [x] Update `docs/testing/truth-table.md` and `docs/testing/test-decomposition-regrouping.md` to reflect new MCP tests.

---

### 12.6 Documentation and migration notes

- [x] Add `docs/guides/mcp.md` (new) describing:
  - [x] how to run legacy vs SDK server modes
  - [x] how to install/enable the SDK (per the chosen dependency strategy)
  - [x] tool schemas and `schemaVersion` policy
  - [x] stable error codes and cancellation/timeout semantics
  - [x] capability reporting and expected client behaviors
  - [x] Link from `docs/guides/commands.md` (or another index doc) so discoverability is maintained.
  - [x] Update `docs/api/mcp-server.md` to describe legacy + SDK modes and capability reporting.
  - [x] Update `docs/contracts/mcp-api.md` for schemaVersion/toolVersion + error code registry.
  - [x] Ensure `docs/phases/phase-12/tooling-and-api-contract.md` and `docs/phases/phase-12/test-strategy-and-conformance-matrix.md` remain in sync.

**Mapping (source docs, minimal):** `GIGAMAP_FINAL_UPDATED.md` (M12), `GIGAMAP_ULTRA_2026-01-22_FULL_COVERAGE_v3.md` (M12 overlap notes), `CODEBASE_STATIC_REVIEW.md` (MCP schema mapping), `GIGASWEEP.md` (MCP timeout/cancellation/progress/test cleanup)


---


# GIGASWEEP 2

## Phase 0 — Hard failures (repo/CI/scripts break *today*)

### Objective
Make sure the repo’s declared entrypoints (npm scripts + CI workflows) actually exist and run.

- [x] Fix missing tooling file referenced by script-coverage/tests.
  - Symptom: script-coverage references `tools/mergeAppendOnly.js` which does not exist.
  - Touchpoints:
    - `tests/tooling/script-coverage/actions.js` — expects `tools/mergeAppendOnly.js`
    - `docs/tooling/repo-inventory.json` — still lists `merge-append`
  - Action:
    - [x] Add `tools/mergeAppendOnly.js` **or** remove/replace the script-coverage action + scrub inventory docs.

- [x] Fix CI workflow referencing a non-existent npm script.
  - Symptom: `.github/workflows/ci-long.yml` runs `npm run test:ci-long`, but `package.json` has no `test:ci-long`.
  - Touchpoints:
    - `.github/workflows/ci-long.yml`
    - `package.json`
  - Action:
    - [x] Add `test:ci-long` script **or** update workflow to use `node tools/ci/run-suite.js ...`.

- [x] Fix release-check script failing in clean checkout.
  - Symptom: `tools/release/check.js` requires `CHANGELOG.md` which is not present.
  - Touchpoints:
    - `tools/release/check.js`
    - `docs/guides/release-discipline.md`
  - Action:
    - [x] Add `CHANGELOG.md` **or** relax/check conditionally.

- [x] Fix critical-deps validator pointing at the wrong docs directory.
  - Symptom: `tools/ci/validate-critical-deps.js` expects `docs/references/dependency-bundle/*` but repo uses `docs/dependency_references/dependency-bundle/*`.
  - Touchpoints:
    - `tools/ci/validate-critical-deps.js`
    - `docs/dependency_references/dependency-coverage.md`
  - Action:
    - [x] Update expected paths or move docs folder (prefer updating script).

---

## Phase 1 — CLI surface vs docs (major drift)

### Objective
Stop shipping docs that describe commands, endpoints, and flags that don’t exist.

- [x] Implement or de-document the `pairofcleats report ...` command family.
  - Docs reference:
    - `docs/guides/code-maps.md` (`pairofcleats report map`)
    - `docs/benchmarks/evaluation.md` (`pairofcleats report eval`)
    - `docs/benchmarks/model-comparison.md` (`pairofcleats report compare-models`)
    - `docs/guides/metrics-dashboard.md` (`pairofcleats report metrics`)
  - Reality:
    - `bin/pairofcleats.js` does **not** implement `report`.
    - Some underlying tools exist (e.g., `tools/reports/report-code-map.js`) but are not routed.
  - Action:
    - [x] Either wire these into `bin/pairofcleats.js` (`report` dispatch) **or**
    - [x] Update docs to use `node tools/...` or `npm run ...`.

- [x] Implement or de-document `pairofcleats sqlite ...`.
  - Docs reference: `docs/sqlite/incremental-updates.md` (`pairofcleats sqlite build --incremental`)
  - Reality: `bin/pairofcleats.js` has no `sqlite` group.
  - Action: wire a `sqlite` command group or change docs to `npm run build-sqlite-index ...`.

- [x] Implement or de-document `pairofcleats service indexer ...`.
  - Docs reference: `docs/guides/service-mode.md` (`service indexer start/status/stop`)
  - Reality: CLI only supports `pairofcleats service api`. `tools/service/indexer-service.js` exists but is not routed.
  - Action: route `service indexer` or change docs to `npm run indexer-service`.

- [x] Fix broken doc links and API surface claims.
  - `docs/guides/code-maps.md` links to `./api-server.md` which does not exist.
  - Map endpoints described in docs don’t appear in the API router.
  - Action: fix link + reconcile endpoints vs router.

- [x] README drift and missing references.
  - Missing/incorrect references:
    - README references `GIGAROADMAP.md` but file is `GIGAROADMAP_2.md`.
    - README implies a license file exists; none found at repo root.
    - README references scripts not present (e.g., `test:pr`).
  - CLI behavior drift:
    - README lists `--mode code|prose|both`; code supports `code|prose|extracted-prose|records|all`.
    - README references env var `PAIROFCLEATS_DOC_EXTRACT` not implemented (behavior appears config-driven).
    - README mentions backends/flags not supported by `bin/pairofcleats.js` (e.g., `sqlite-fts`, `memory`, `--why` vs `--explain`).
  - Action: reconcile README with current CLI and config reality.

---

## Phase 2 — Config correctness (schema, validation, normalization)

### Objective
Ensure the config file (`.pairofcleats.json`) is:
1) validated correctly, and
2) actually applied by runtime.

#### 2.1 Normalization drops supported keys (user config silently ignored)
- [x] Fix `quality` and `threads` being validated/documented but then silently dropped.
  - Symptoms:
    - `docs/config/schema.json` defines top-level `quality` and `threads`.
    - default config template emits `quality: "auto"`.
    - `tools/dict-utils/config.js` normalization does **not** carry `quality` or `threads` through.
    - Runtime reads `config.quality` (`src/shared/auto-policy.js`) and `userConfig.threads` (`src/shared/runtime-envelope.js`) → user settings never take effect.
  - Action:
    - [x] Pass-through `quality` and `threads` in normalization.
    - [x] Add tests proving config changes behavior (not just schema validation).

#### 2.2 Validator vs schema mismatch (schema features ignored / mis-evaluated)
- [x] Align `docs/config/schema.json` with the actual validator (`src/config/validate.js`) *or* adopt a real JSON Schema validator.
  - Issues observed:
    - Schema uses `anyOf` and union types (e.g., `"type": ["number","null"]`) but validator ignores `anyOf` and mishandles array-`type`.
    - Root `additionalProperties:false` rejects many keys the code expects/normalizes (`sqlite`, `lmdb`, etc.) unless schema is expanded.
    - `tools/config/generate-demo-config.js` assumes `anyOf/oneOf` exists, reinforcing that the schema is “real JSON Schema”.
  - Action (recommended):
    - [x] Switch to Ajv (or equivalent) and treat `docs/config/schema.json` as authoritative.
    - [x] Add tests for `anyOf` + union types + unknown top-level keys.
  - Alternative (not chosen; Ajv path implemented):
    - Restrict schema to the validator’s supported subset and adjust doc tooling accordingly.

#### 2.3 Additional normalization/validation defects
- [x] Fix conditional drop: `search.sqliteAutoArtifactBytes` is ignored unless `sqliteAutoChunkThreshold` is set.
  - Touchpoint: `tools/dict-utils/config.js` (`sqliteAutoArtifactBytes` parsing is gated on threshold existence).
- [x] Fix `validateConfig()` “required bypass” under `additionalProperties:false`.
  - Touchpoint: `src/config/validate.js` (unknown property is skipped if the key is also in `required`).

#### 2.4 Generated “inventory” docs drift / contract not enforced
- [x] Keep generated docs in sync:
  - `docs/config/inventory.json` vs `docs/config/inventory.md` public flags list mismatch.
  - `docs/guides/commands.md` appears out of sync with its generator.
  - Action:
    - [x] Add CI test: regenerate artifacts and assert no diff.
    - [x] Document the generator command(s) as the single source of truth.

---

## Phase 3 — Path safety / filesystem hardening (high priority)

### Objective
Manifest-driven and output-driven filesystem reads must be safe **regardless of “strict” mode**.

- [x] Always enforce manifest path containment, even in non-strict mode.
  - Findings:
    - `src/index/validate/manifest.js` only validates entry paths when `strict===true`, but still `existsSync()` / hashes resolved paths when non-strict.
    - `src/shared/artifact-io/manifest.js` similarly only enforces safety when strict.
    - `tools/ci/restore-artifacts.js` joins `piece.path` under indexDir without containment checks.
  - Risk: path traversal (`../`) can read outside indexDir if manifest is corrupted/untrusted.
  - Action:
    - [x] Always enforce: no absolute paths, no `..` segments, and resolved path must remain under root.
    - [x] In non-strict mode: downgrade to warnings + skip unsafe entries (but do not read them).

- [x] Fix path safety predicate false-positives.
  - Current logic uses substring `normalized.includes('..')`, which rejects benign strings like `foo..bar`.
  - Action: check path segments for equality to `'..'`.

- [x] Fix output summarization path traversal.
  - `src/retrieval/output/summary.js` uses `path.join(rootDir, chunk.file)` without containment validation.
  - Action: resolve and ensure resulting path remains under `rootDir` before reading.

---

## Phase 4 — Retrieval/search: backend selection, ranking knobs, and flag surface

### Objective
Make search behavior deterministic, debuggable, and aligned with its public CLI surface.

#### 4.1 SQLite FTS auto-enable inconsistency (backend initialization vs downstream usage)
- [x] Fix divergent booleans for FTS enablement.
  - In `src/retrieval/cli.js`, FTS is derived as:
    - `sqliteFtsEnabled = sqliteFtsRequested || (autoBackendRequested && useSqliteSelection)`
  - But `createBackendContext(...)` receives the **original** `sqliteFtsRequested`, while index-loading receives `sqliteFtsEnabled`.
  - Consequences:
    - backend label and required-table checks can behave as “non-FTS” even while pipeline behaves as “FTS enabled”.
    - can cause unnecessary fallback away from SQLite.
  - Action: compute one canonical “FTS enabled” boolean and pass it everywhere.

#### 4.2 Flag surface is far larger than yargs declarations (types/missing-value hazards)
- [x] Declare every consumed `argv.*` option in yargs (or intentionally mark them as “advanced” but still declare them).
  - Current state:
    - ~70+ `argv.*` keys are read in the search path; ~40+ are not declared in yargs.
    - `.strict(false)` means unknown flags are accepted but are not typed/coerced and are absent from `--help`.
  - High-risk cases (missing value → `true`):
    - `--repo` can cause hard throw (`path.resolve(true)`).
    - string filters can silently become `"true"`.
    - numeric knobs can silently become `1` (`Number(true) === 1`) (e.g., `--bm25-k1`, `--modified-since`).
  - Action:
    - [x] Add yargs declarations for all read flags with correct types and `.requiresArg()` where applicable.
    - [x] Expand `getMissingFlagMessages()` beyond `type/author/import` to include “must-have-value” flags.
    - [x] Add tests for missing-value behavior (`--repo`, `--modified-since`, `--bm25-k1`, `--path`, etc.).

- [x] Fix `--context` dead flag.
  - `contextLines` is computed from `argv.context` but not used downstream.
  - Action: wire it to output context, or remove the flag.

- [x] Fix Windows drive-letter token parsing in `--filter`.
  - `parseFilterExpression()` splits on `:`; `C:\...` becomes key `c`.
  - Action: special-case `/^[A-Za-z]:[\\/]/` as a file path token.

- [x] Fix LMDB chunk hydration overwriting valid zeros.
  - `src/retrieval/lmdb-helpers.js` uses falsy checks (`if (!chunk.churn)`) causing `0` to be overwritten.
  - Action: use nullish checks (`== null`).

#### 4.3 Retrieval pipeline safety and determinism
- [x] Propagate abort/cancellation signals into provider calls.
  - Current pattern checks `signal` at boundaries but providers don’t accept/obey it.
- [x] Validate unknown ANN backend strings rather than silently defaulting.
- [x] Add candidate set caps to prevent “candidate explosion” on pathological tokens.
- [x] Document and/or wire search config knobs.
  - Current normalization hard-codes several behaviors (`contextExpansionEnabled=false`, `scoreBlendEnabled=false`, etc.) while docs imply configurability.
  - Many backend config normalizers are called with `{}` (ignoring `userConfig`), limiting real-world configurability.

---

## Phase 5 — SQLite/Tantivy/index build tooling correctness

### Objective
Remove dead code paths, misleading cleanup, and brittle precondition assumptions.

- [x] Clean up SQLite build runner resource handling.
  - `tools/build/sqlite/runner.js` treats returned stats as a DB handle and calls `.close()` (swallowed).
  - Unused variables like `hasVectorTableBefore` and wording mismatches in warnings.
  - Action: make return types explicit, remove dead cleanup, fix warnings.

- [x] Improve Tantivy build error messaging and prerequisite checks.
  - `tools/build/tantivy-index.js` assumes artifacts exist and can fail with low-signal errors.
  - Action: explicitly detect required artifacts and print remediation steps.

- [x] Optional doc extraction deps are capability-probed but not declared.
  - `src/shared/capabilities.js` checks `pdfjs-dist`/`mammoth`, but `package.json` doesn’t declare them.
  - Action: either document “install to enable” or move them to `optionalDependencies`.

- [x] Fix unused/leftover build-state variable.
  - `build_index.js` defines `buildStatePath` but doesn’t use it.

---

## Phase 6 — MCP robustness

### Objective
No request should hang without a response; cancellation/timeout semantics should be deterministic.

- [x] Fix tool-call cancellation: ensure a response is emitted even if handler resolves after cancellation.
  - Current behavior: if cancelled flag is set, success path returns without sending a reply.
  - Touchpoints:
    - `tools/mcp/transport.js`
    - tool handlers (e.g., `tools/mcp/tools/handlers/search.js`)
  - Action:
    - [x] On cancellation: send a deterministic “cancelled” response for the original request id.
    - [x] Add a `$ /cancelRequest` test asserting a response always arrives.

---

## Phase 7 — Risk analysis & type inference correctness + tests

### Objective
Fix correctness bugs in local risk detection and close test gaps in type inference.

#### 7.1 Local risk detector correctness gaps
- [x] Fix “taint confidence” bug (reads the wrong field).
  - `src/index/risk.js` uses `entry.confidence` where entries are `{ rule, evidence }`.
  - Action: use `entry.rule.confidence` (or remove if unused).
- [x] Fix rule-id aggregation mismatch in `combineSourceEvidence()`.
- [x] Document/expand assignment heuristics:
  - current parsing skips `=>` and misses destructuring/multi-line patterns.
- [x] Sanitizer matching is overly broad (clears taint if variable name appears on any matching line).

#### 7.2 Risk rules diagnostics shape
- [x] `src/index/risk-rules.js` has an `errors` array that is never used.
  - Action: either classify fatal issues into `errors` or remove it for clarity.

#### 7.3 Interprocedural risk behavior clarity
- [x] Document and surface “timeout ⇒ zero flows” behavior (it’s deterministic and tested but surprising).
- [x] Clarify/verify `taintHints` production wiring (appears optional/dormant in some paths).
- [x] Consider artifact metadata clarity for sharded JSONL (entrypoint is `.meta.json` but format labeled `jsonl`).

#### 7.4 Type inference coverage and unused outputs
- [x] Local type inference exports `aliases` but caller ignores it.
  - Action: remove dead output or wire alias propagation.
- [x] Add unit tests for `src/index/type-inference.js` (cross-file tests exist; local inference is largely untested).

#### 7.5 Cross-file pipeline implementation smells
- [x] Avoid attaching private `_keys` Sets to arrays for dedupe.
  - Action: use local Sets/Maps or a `WeakMap`.
- [x] Layering concern: `src/index/*` importing from `tools/*` may complicate packaging boundaries.
  - Action: route shared helpers through `src/shared/*` wrappers to avoid direct `tools/*` imports.

---

## Phase 8 — Test & drift-guard improvements (prevent recurrence)

### Objective
Turn current failures/drifts into permanent guardrails.

- [x] Add workflow contract coverage for **all** workflows.
  - Current workflow-contract tests cover `ci.yml` but not `ci-long.yml` (which is broken).
- [x] Add “npm scripts target exists” test in PR lane.
  - Catch missing `tools/*.js` targets early (e.g., `mergeAppendOnly.js`).
- [x] Add Markdown link checker test.
  - Catch broken doc links (e.g., `docs/guides/code-maps.md -> api-server.md`).
- [x] Add generator sync tests for doc inventories (`commands.md`, `inventory.md/json`).
- [x] Remove brittle cross-test ordering via marker files in summary-report tests.
  - Replace polling loop with a shared helper or a single orchestrated integration test.

---

## Phase 9 — Tooling and docs hygiene (quality-of-life)

### Objective
Reduce “mystery behavior” and make internal tooling more robust.

- [x] Improve `tools/ci/check-env-usage.js` detection patterns.
  - Currently misses bracket access, destructuring, and other env read patterns.
  - Consider AST-based linting.

- [x] Fix `tools/download/extensions.js` chmod contradiction and improve download safety.
  - `chmod 0755` is immediately overwritten by `chmod 0644`.
  - Archive downloads are buffered in memory without size caps.
  - Consider forcing HTTPS or requiring hashes for HTTP.

- [x] Fix `tools/download/models.js` ONNX copy logic.
  - Current logic checks `!existsSync(onnxTarget)` then calls `statSync(onnxTarget)`, making directory handling dead.
  - Also doesn’t copy when target dir already exists.

- [x] Fix `tools/reports/compare-models.js` index existence probe.
  - Checks only for `chunk_meta.json` and may miss valid indexes in other shapes.

- [x] Tool detection should verify executability, not just filename presence.
  - `tools/tooling/detect.js` should run `--version` before claiming “found”.

- [x] Fix `src/integrations/core/status.js` payload naming ambiguity.
  - `repo.root` appears to report cache root, not repository root.

- [x] Compact/shard tooling scalability:
  - `tools/index/compact-pieces.js` now streams gzip + zstd JSONL shards.
  - `tools/ingest/ctags.js` backpressure handled.

---

# Appendix A — Sweep coverage (what was reviewed)

This repo was reviewed in multiple sweeps. Below is a high-level list of the file clusters covered (full per-turn lists were provided in the chat):

1) **Project wiring:** `package.json`, root scripts, bin entrypoints, GitHub workflows, core CLI plumbing.
2) **Docs surface:** README, docs guides/contracts/specs, generated inventories, link integrity.
3) **Config system:** schema docs, validator, normalization, demo/template generators.
4) **Install/build tooling:** extensions/models/dicts downloads, indexing builders, CI artifact restore/build scripts.
5) **MCP integration:** protocol/transport, tool handlers, robustness tests.
6) **Index internals:** manifest/path validation, incremental state, locking, map building.
7) **Risk analysis & type inference:** local detector, interprocedural engine, cross-file inference pipeline.
8) **Retrieval/ranking:** sqlite/lmdb/tantivy providers, rankers/scoring knobs, filters, caching, flag surface.

---

# Appendix B — “Highest ROI” patch set (suggested ordering)

If you want a focused sequence that quickly stabilizes the repo:

1) Fix immediate hard failures: missing `tools/mergeAppendOnly.js`, missing `test:ci-long`, `validate-critical-deps` path, `CHANGELOG.md` gate.
2) Fix config normalization dropping `quality` + `threads`.
3) Fix manifest/output path traversal hazards (always enforce containment).
4) Fix SQLite FTS enablement mismatch (auto path).
5) Declare the full search flag surface in yargs and add missing-value tests.
6) Add drift-guards: workflow/script/link/inventory sync tests.
7) MCP cancellation always responds.
8) Clean up SQLite build runner + downloads tooling (chmod + streaming + onnx copy).

---

# Appendix C — Incorrect Findings

- Phase 0: The symptom “npm run merge-append targets a missing file” is stale. The `merge-append` script no longer exists in `package.json`; the missing file issue now stems from script-coverage/tests still referencing `tools/mergeAppendOnly.js` (and repo-inventory docs listing `merge-append`).

---

# AVISPROVOC

## Action items
[x] Inventory tests at tests/ root and all subfolders; build a mapping table (current path -> new path, rename, helper extraction notes).
[x] Define the target taxonomy: subsystem-first folders with feature subfolders; keep unit/integration only as lanes (not as folders).
[x] Create missing top-level folders (runner, smoke, shared) and subsystem feature subfolders (indexing/watch, indexing/imports, retrieval/ann, storage/lmdb, tooling/reports, etc.).
[x] Move all root-level test files into subsystem/feature folders; leave only run.js, run.rules.jsonc, run.config.jsonc, and README.md at tests/ root.
[x] Move runner-related files (all.js, test-runner.js, discovery/reporting helpers) into tests/runner and update their import paths.
[x] Rehome CLI tests into tests/cli/build-index and tests/cli/search subfolders; update references in docs and runner config.
[x] Rehome indexing tests into tests/indexing/<feature> (chunking, watch, ignore, imports, incremental, promotion, embeddings, relations, etc.).
[x] Rehome indexer tests into tests/indexer/<feature> (metav2, sharded-meta, signatures, artifacts, pipeline, service, etc.).
[x] Rehome retrieval tests into tests/retrieval/<feature> (ann, postings, query, ranking, filters, cache, output, explain, etc.).
[x] Rehome storage tests into tests/storage/<backend> (sqlite, lmdb, vector-extension) and keep other storage-related tests adjacent.
[x] Rehome tooling tests into tests/tooling/<feature> (reports, ingest, script-coverage, structural, vscode, doctor, etc.).
[x] Rehome crossfile/type-inference/identity/map/relations/risk tests into the most natural subsystem folder with feature subfolders.
[x] Rename all test files to \*.test.js and ensure helpers remain \*.js; update any references, lists, and docs that mention old names.
[x] Centralize repeated test setup (fixtures, env sync, spawn wrappers, build_index helpers) into tests/helpers; remove duplicated logic in tests.
[x] Create or update shared helpers for common build-index and fixture operations; refactor tests to consume them.
[x] Update tests/run.rules.jsonc lane and tag rules to match new paths; keep unit/integration lanes as tags only.
[x] Update tests/run.config.jsonc, tests/ci/ci.order.txt, tests/ci-lite/ci-lite.order.txt, and tools/test_times/* for the new paths.
[x] Update any docs referencing test paths or layout (README.md, docs guides, AGENTS.md as needed).
[x] Verify helpers/support folders remain excluded in test discovery (excludedDirs) and that tests/shared contains only src/shared tests.
[x] Run test discovery (node tests/run.js --list) and a small smoke subset to validate moves; stop any test > 1 minute and ask you to run it.
[x] Final sweep: confirm no test files remain at tests/ root and no stale paths remain in repo search.
[x] Update AVISPROVOC.md progress log with each batch move, helper extraction, and any conflicts or ambiguities.

---

## Phase 13 — SCM Provider Abstraction (Git Migration) + JJ Provider

### Objective

Make SCM integration **pluggable and explicit** so indexing and incremental workflows can run against:

- Git repos (current default)
- Jujutsu (`jj`) repos (Phase 13 deliverable)
- Non-SCM directories (filesystem-only; reduced provenance but still indexable)

This phase introduces an **SCM provider interface**, migrates all Git behavior onto that interface, then implements a JJ provider using the same contract. The result is a single, coherent place to reason about: tracked file discovery, repo provenance, per-file metadata (churn / blame), and “changed files” queries used by incremental reuse.

Authoritative specs to align with (existing in repo):
- `docs/specs/scm-provider-config-and-state-schema.md`
- `docs/specs/jj-provider-commands-and-parsing.md`
- `docs/specs/scm-provider-contract.md` (to be added in 13.0, or extend the config/state spec)

---

### Exit criteria (must all be true)

- [x] There is a single SCM provider interface used everywhere (no direct `git`/`jj` shelling from random modules).
- [x] `indexing.scm.provider` is supported: `auto | git | jj | none` (default: `auto`).
- [x] Git provider is fully migrated onto the interface and remains the default when `.git/` exists.
- [x] JJ provider supports (at minimum): repo detection, tracked-file enumeration, and repo “head” provenance recorded in `build_state.json`.
- [x] When no SCM is present (or `provider=none`), indexing still works using filesystem discovery, but provenance fields are explicitly `null` / unavailable (no silent lies).
- [x] Build signatures and cache keys include SCM provenance in a **stable** and **portable** way (no locale-dependent sorting).
- [x] Tests cover provider selection + the most failure-prone parsing paths; CI can run without `jj` installed.
- [x] `build_state.json` contract/validator updated to include SCM provider fields and referenced from docs.

---

### Phase 13.0 — Authoritative docs + provider contract + build state schema alignment

- [x] Update authoritative docs that must change with the SCM provider migration:
  - [x] `docs/contracts/indexing.md` (build_state shape + repo provenance + provider semantics)
  - [x] `docs/specs/identity-contract.md` (build signature inputs and stability; provider head must be included)
  - [x] `docs/specs/workspace-config.md` (if it enumerates indexing config keys, update to include `indexing.scm.*`)
  - [x] `docs/config/schema.json` and `docs/config/contract.md` (official config surface + precedence)
  - [x] `docs/guides/commands.md` (new CLI flags introduced in 13.4)

- [x] Add/extend a **provider contract spec**:
  - [x] New: `docs/specs/scm-provider-contract.md` (or extend `docs/specs/scm-provider-config-and-state-schema.md`)
  - Must define:
    - [x] return shapes for all provider APIs
    - [x] required vs optional fields (esp. `head` shape and `dirty` semantics)
    - [x] path normalization rules (repo-relative POSIX paths)
    - [x] detection precedence and fallback behavior
    - [x] capability/skip semantics when binaries are missing
    - [x] decision table for provider selection (`auto|git|jj|none`), including:
      - [x] explicit provider set
      - [x] `.git/` + `.jj/` both present (hard fail)
      - [x] missing binaries / unreadable repo roots
    - [x] buildId/signature provenance rules (how head fields affect buildId)

- [x] Build-state schema contract must be referenced and updated:
  - [x] Add a formal build_state contract + validator (none exists today):
    - [x] `src/contracts/schemas/build-state.js` (new) — JSON schema for build_state.json
    - [x] `src/contracts/validators/build-state.js` (new) — validator + error formatting
    - [x] `src/contracts/registry.js` — register the build_state contract
  - [x] Schema must be **exhaustive**:
    - [x] `repo.provider`, `repo.head`, `repo.dirty`, `repo.root`
    - [x] buildId + signatureVersion + schemaVersion
    - [x] explicit nullability rules for provider=none
  - [x] Ensure `docs/contracts/indexing.md` references the new contract location and examples.
  - [x] Add a migration checklist section (legacy repo.* fields to deprecate/remove and timeline).

Touchpoints:
- `docs/contracts/indexing.md`
- `docs/specs/identity-contract.md`
- `docs/specs/workspace-config.md`
- `docs/specs/scm-provider-config-and-state-schema.md` (or new `docs/specs/scm-provider-contract.md`)
- `docs/config/schema.json`
- `docs/config/contract.md`
- `docs/guides/commands.md`
- `src/contracts/**` (build_state schema + validators)

Touchpoints (anchors; approximate):
- `src/index/build/build-state.js` (~L5 `STATE_FILE`, ~L104 `repoRoot`, ~L133 `repo`)
- `src/index/build/runtime/runtime.js` (~L170 `repoProvenance`, ~L174 `buildId`)
- `src/contracts/registry.js` (~L1 `registry`)

---

### Phase 13.1 — Introduce `ScmProvider` interface + registry + config/state schema wiring

- [x] Create a new module boundary for SCM operations:
  - [x] `src/index/scm/types.js` (new) — shared types and normalized shapes
  - [x] `src/index/scm/provider.js` (new) — interface contract + docs-in-code
  - [x] `src/index/scm/registry.js` (new) — provider selection (`auto|git|jj|none`)
  - [x] `src/index/scm/providers/none.js` (new) — filesystem-only provider (no provenance; uses existing fdir fallback)
  - [x] `src/index/scm/providers/git.js` (new) — migrated in 13.2
  - [x] `src/index/scm/providers/jj.js` (new) — implemented in 13.3

- [x] Add a shared path normalization helper (single source of truth):
  - [x] `src/index/scm/paths.js` (new) — `toRepoPosixPath(filePath, repoRoot)`
  - [x] All providers + tests must use this helper.

- [x] Define the **canonical provider contract** (minimal required surface):
  - [x] `detect({ startPath }) -> { ok:true, repoRoot, provider } | { ok:false }`
  - [x] `listTrackedFiles({ repoRoot, subdir? }) -> { filesPosix: string[] }`
  - [x] `getRepoProvenance({ repoRoot }) -> { provider, root, head, dirty, branch/bookmarks?, detectedBy? }`
  - [x] `getChangedFiles({ repoRoot, fromRef, toRef, subdir? }) -> { filesPosix: string[] }` (may be “not supported” for `none`)
  - [x] `getFileMeta({ repoRoot, filePosix }) -> { churn?, lastCommitId?, lastAuthor?, lastModifiedAt? }` (best-effort; may be disabled)
  - [x] Optional (capability-gated): `annotate({ repoRoot, filePosix, timeoutMs }) -> { lines:[{ line, author, commitId, ... }] }`
  - [x] Define conflict policy:
    - [x] If both `.git/` and `.jj/` exist and no explicit provider is set, **hard fail** with a clear message to choose `--scm-provider`.

- [x] Config keys (align to `docs/specs/scm-provider-config-and-state-schema.md`):
  - [x] `indexing.scm.provider: auto|git|jj|none`
  - [x] `indexing.scm.timeoutMs`, `indexing.scm.maxConcurrentProcesses`
  - [x] `indexing.scm.annotate.enabled`, `maxFileSizeBytes`, `timeoutMs`
  - [x] `indexing.scm.jj.snapshotWorkingCopy` safety default (read-only by default)
  - [x] Define compatibility mapping for legacy git flags:
    - [x] `indexing.gitBlame` / `analysisPolicy.git.blame` -> `indexing.scm.annotate.enabled`
    - [x] document deprecation/precedence and avoid divergent settings
    - [x] No legacy mode: treat the SCM provider contract as authoritative

- [x] Add a mockable SCM command runner:
  - [x] `src/index/scm/runner.js` (new) — wraps spawn/exec with injectable fakes for tests
  - [x] Use it in Git/JJ providers to avoid shelling in unit tests.

- [x] Build-state schema updates:
  - [x] Extend `build_state.json` `repo` field to include:
    - [x] `repo.provider`
    - [x] normalized `repo.head` object (provider-specific fields nested, but stable keys)
    - [x] `repo.dirty` boolean (best-effort)
- [x] Keep Git back-compat fields where feasible (`repo.commit`, `repo.branch`) but treat `repo.provider` + `repo.head.*` as authoritative.
  - [x] Define deterministic buildId/signature rules:
    - [x] buildId uses `<timestamp>_<scmHeadShort>_<configHash8>`
    - [x] `scmHeadShort` comes from provider head primary id:
      - [x] git: commit SHA (short)
      - [x] jj: **changeId** when available, else commitId
    - [x] provider=none uses `noscm` marker (no git/jj fields leaked)

Touchpoints:
- `docs/specs/scm-provider-config-and-state-schema.md` (align / correct examples if needed)
- `src/index/build/build-state.js` (repo provenance shape)
- `src/index/build/indexer/signatures.js` (include SCM provenance in build signatures)
- `src/index/build/runtime/runtime.js` (thread config into runtime)
- `docs/config/schema.json` (document `indexing.scm.*` keys)
- `docs/config/contract.md` (document precedence + deprecations)

Touchpoints (anchors; approximate):
- `src/index/git.js` (~L63 `getGitMetaForFile`, ~L157 `getGitBranch`)
- `src/index/build/preprocess.js` (~L10 `discoverEntries`)
- `src/index/build/indexer/steps/discover.js` (~L34 `discoverFiles`)
- `src/index/build/discover.js` (~L138 `discoverRepoRoots`, ~L176 `listGitFiles`)
- `src/index/build/build-state.js` (~L1 `buildState`)
- `src/index/build/indexer/signatures.js` (~L46 `gitBlameEnabled`)
- `src/index/build/runtime/runtime.js` (~L172 `buildId`, ~L209 `gitBlameEnabled`)

#### Tests / verification (path-corrected for current test layout)
- [x] `tests/indexing/scm/scm-provider-selection.test.js` (new)
  - [x] `auto` selects `git` when `.git/` exists and git is runnable.
  - [x] `auto` selects `jj` when `.jj/` exists and `jj` is runnable.
  - [x] `auto` falls back to `none` when neither exists (or binaries missing).
  - [x] `auto` hard-fails when both `.git/` + `.jj/` exist and no provider is set.
  - [x] use fixture repo roots (`tests/fixtures/scm/git`, `tests/fixtures/scm/jj`, `tests/fixtures/scm/both`) rather than real repos.
- [x] `tests/indexing/scm/build-state-repo-provenance.test.js` (new)
  - [x] `build_state.json` includes `repo.provider` and normalized `repo.head`.
- [x] `tests/indexing/scm/signature-provenance-stability.test.js` (new)
  - [x] build signatures remain stable across locales and include provider head fields.

---

### Phase 13.2 — Migrate Git onto the provider interface

- [x] Implement `GitProvider` by **wrapping and consolidating** existing Git logic:
  - [x] Move/merge logic from:
    - [x] `src/index/git.js` (provenance + meta helpers)
    - [x] `src/index/build/discover.js` (`git ls-files` discovery)
  - [x] Ensure there is exactly one “source of truth” for:
    - [x] repo root resolution
    - [x] tracked file enumeration (`git ls-files -z`)
    - [x] dirty check
    - [x] head SHA + branch name

- [x] Remove direct Git shelling from non-provider modules:
  - [x] `src/index/build/discover.js` should call `ScmProvider.listTrackedFiles()` when an SCM provider is active, else use filesystem crawl (current behavior).
  - [x] Any provenance used for metrics/signatures must route through `ScmProvider.getRepoProvenance()`.
  - [x] Git metadata in file processing must use provider APIs (no direct `getGitMetaForFile` in CPU path).
  - [x] Chunk author attribution must use provider annotate (or explicit disable path when annotate is off).

Touchpoints:
- `src/index/build/discover.js`
- `src/index/git.js` (migrate or reduce to GitProvider internals)
- `src/index/scm/providers/git.js` (new)
- `src/index/scm/registry.js`
- `src/index/build/file-processor/cpu.js` (git meta)
- `src/index/build/file-processor/process-chunks/index.js` (chunk authors)
- `src/index/build/artifacts/metrics.js` (repo provenance)
- `src/index/build/runtime/runtime.js` (buildId uses provider head)
- `src/index/build/indexer/steps/incremental.js` (git meta cache -> provider cache config)

Touchpoints (anchors; approximate):
- `src/index/git.js` (~L69 `getGitMetaForFile`, ~L177 `getRepoProvenance`, ~L216 `computeNumstatChurn`)
- `src/index/build/discover.js` (~L136 `listGitFiles`, ~L176 `gitResult`)
- `src/index/build/preprocess.js` (~L90 `discoverEntries`)
- `src/index/build/indexer/steps/discover.js` (~L34 `discoverFiles`)
- `src/index/build/file-processor/cpu.js` (~L280 `getGitMetaForFile`)
- `src/index/build/file-processor/process-chunks/index.js` (~L411 `getChunkAuthorsFromLines`)
- `src/index/build/artifacts/metrics.js` (~L47 `repoProvenance`)
- `src/index/build/runtime/runtime.js` (~L170 `repoProvenance`, ~L174 `buildId`)
- `src/index/build/indexer/steps/incremental.js` (~L25 `configureGitMetaCache`)
- `src/index/build/runtime/policy.js` (~L18 `git` policy)
- `src/index/build/file-processor.js` (~L440 `gitBlameEnabled` plumbing)

#### Tests / verification (path-corrected for current test layout)
- [x] `tests/indexing/scm/index-build-git-provider.test.js` (new)
  - [x] Build index inside a git repo and assert:
    - [x] `build_state.json.repo.provider === "git"`
    - [x] tracked file discovery returns only git-tracked files (plus explicit records-dir behavior if enabled)
  - [x] annotate metadata is present only when enabled; otherwise explicitly absent with a reason
- [x] `tests/indexing/scm/git-provider-parse.test.js` (new)
  - [x] uses mockable SCM runner for unit coverage of git parsing without requiring git

---

### Phase 13.3 — Implement JJ provider (read-only default, robust parsing)

- [x] Implement `JjProvider` using `jj` CLI (no library dependency):
  - [x] Detection:
    - [x] find `.jj/` root
    - [x] validate `jj --version` runnable (capability gating)
  - [x] Tracked files:
    - [x] `jj file list --tracked -0` (prefer NUL delim where available)
  - [x] Repo provenance:
    - [x] resolve a stable head reference (commitId + changeId where available)
    - [x] record bookmarks (best-effort)
    - [x] `dirty` best-effort (explicitly document semantics)

- [x] Safety default: read-only by default
  - [x] When `indexing.scm.jj.snapshotWorkingCopy=false`:
    - [x] run JJ commands with `--ignore-working-copy` and `--at-op=@` (per spec)
  - [x] If enabled:
    - [x] allow exactly one controlled snapshot at start (and pin subsequent commands to that op)
    - [x] record the pinned op id in build state (so provenance is reproducible)

- [x] Implement changed-files support (for incremental reuse):
  - [x] Provide `getChangedFiles()` based on the spec in `docs/specs/jj-provider-commands-and-parsing.md`.
  - [x] Normalize to **repo-root-relative POSIX paths**.
  - [x] Define deterministic ordering and truncation caps for changed-file outputs.

Touchpoints:
- `docs/specs/jj-provider-commands-and-parsing.md` (align with implementation)
- `src/index/scm/providers/jj.js` (new)
- `src/index/scm/providers/jj-parse.js` (new: isolated parsing helpers)
- `src/index/build/indexer/signatures.js` (include JJ head/changeId + op pin when used)

Touchpoints (anchors; approximate):
- `docs/specs/jj-provider-commands-and-parsing.md` (definitions for `jj file list`, `jj log`, `jj status`)
- `src/index/build/indexer/signatures.js` (~L46 `gitBlameEnabled` placeholder to replace with provider head)

#### Tests / verification (path-corrected for current test layout)
- [x] Unit: parsing helpers
  - [x] `tests/indexing/scm/jj-changed-files-parse.test.js`
  - [x] `tests/indexing/scm/jj-head-parse.test.js`
- [x] `tests/indexing/scm/jj-changed-files-normalization.test.js` (new)
  - [x] ensure paths are POSIX, repo-root-relative, and sorted deterministically.
- [x] CI behavior:
  - [x] JJ parsing tests are self-contained and run without `jj` installed.
  - [x] add explicit lane/tag so JJ tests can be isolated if needed.

---

### Phase 13.4 — CLI + tooling visibility (make SCM selection obvious)

- [x] CLI flags (override config, optional but recommended):
  - [x] `pairofcleats index build --scm-provider <auto|git|jj|none>`
  - [x] `pairofcleats index build --scm-annotate / --no-scm-annotate`

- [x] Surface effective provider + provenance in diagnostics:
  - [x] `pairofcleats tooling doctor --json` should include:
    - provider selected
    - repo root
    - head id(s)
    - whether annotate is enabled

Touchpoints:
- `bin/pairofcleats.js` (flag plumbing)
- `src/shared/cli-options.js` (new flags)
- `tools/tooling/doctor.js` (report SCM provider)

Touchpoints (anchors; approximate):
- `bin/pairofcleats.js` (~L509 `tooling doctor` dispatch, ~L692 `index build` help)
- `src/shared/cli-options.js` (~L4 `INDEX_BUILD_OPTIONS`)
- `tools/tooling/doctor.js` (~L33 `runToolingDoctor`)
- `src/index/tooling/doctor.js` (~L139 `runToolingDoctor`)

---

### Phase 13.5 — Non-repo environments (explicitly supported)

- [x] Make filesystem-only behavior first-class:
  - [x] If `provider=none` (or auto selects none):
    - [x] file discovery uses filesystem crawl (current fallback)
    - [x] build state records `repo.provider="none"` and `repo.head=null`
    - [x] incremental reuse features that require SCM provenance must be disabled with an explicit reason (no silent partial behavior)
    - [x] buildId/signatures use a deterministic "no-scm" marker (do not leak git-specific fields)
- [x] Document this mode as “try it anywhere” for non-code/non-repo folders.

Touchpoints:
- `src/index/scm/providers/none.js` (new)
- `docs/contracts/indexing.md` (document provider="none" behavior)
- `docs/guides/commands.md` (CLI flags and behavior notes)

Touchpoints (anchors; approximate):
- `src/index/build/build-state.js` (~L104 `repoRoot`, ~L133 `repo`)
- `src/index/build/runtime/runtime.js` (~L170 `repoProvenance`, ~L174 `buildId`)
- `src/index/build/discover.js` (~L26 `discoverFiles`, ~L92 `discoverEntries`)

#### Tests / verification
  - [x] `tests/indexing/scm/index-build-no-scm.test.js` (new)
  - [x] Build index in a temp folder without `.git/` and assert build succeeds and provenance is explicitly null.
  - [x] `tests/indexing/scm/no-scm-build-id.test.js` (new)
    - [x] buildId/signatures do not include git/jj fields and remain stable across runs.

---

# SWEEPSWEEP

## From CRITICAL_SWEEP.md (confirmed)

- [x] **Fix tree-sitter deferral crash path**: `process-files.js` calls `normalizeTreeSitterLanguages(...)` without import/export. Export it from `src/index/build/indexer/steps/process-files/tree-sitter.js` (or replace with an already-exported helper) and import in `src/index/build/indexer/steps/process-files.js` so deferral merges don’t throw `ReferenceError`.
- [x] **Resolve env override gating**: `getEnvConfig()` still returns only `{ apiToken, mcpMode }` unless `PAIROFCLEATS_TESTING` is set. Decide and implement the intended contract:
  - Preferred: allow production overrides by removing the testing gate and keep test-only fields in `getTestEnvConfig()`.
  - If test-only is intended, remove production reads of `envConfig.*` or document them as test-only.
- [x] **Add missing envConfig fields that consumers already read**: `regexEngine`, `compression`, `docExtract`, `mcpTransport`, `modelsDir`, `dictDir` (tools and MCP code read these today). Add them to `getEnvConfig()` with documented env var names and validation.
- [x] **Unconsumed env vars in inventory**: `PAIROFCLEATS_HOME`, `PAIROFCLEATS_MODELS_DIR`, `PAIROFCLEATS_DICT_DIR`, `PAIROFCLEATS_EXTENSIONS_DIR` are still listed but unused in runtime paths. Either wire them into path resolution (preferred if docs promise them) or remove from `docs/config/inventory.*` and related docs.
- [x] **Search wrapper backend restriction**: `bin/pairofcleats.js` still blocks `sqlite-fts` (`--backend` only allows auto/sqlite/lmdb). Either allow `sqlite-fts` or delegate backend validation to the retrieval CLI.
- [x] **Document extraction mismatch**: README/docs still claim PDF/DOCX support, but no extraction pipeline exists and `docExtract` is not wired into env config. Either implement end-to-end extraction or downgrade the docs to “planned” and remove the env var until implemented.
- [x] **Docs reference npm test scripts that don’t exist**: `package.json` has no `test`, `test:pr`, `test:nightly`, `test:ci-lite`, `test:ci-long` scripts. Update docs/AGENTS to use the actual entrypoints (`node tests/run.js`, `node tools/ci/run-suite.js`) or reintroduce thin npm aliases.
- [x] **Metrics backend labels**: `src/shared/metrics.js` still omits `lmdb` from allowed backend labels; add it to prevent “unknown” metrics for LMDB searches.

---

## From OLDER_PHASES_ISSUES.md (confirmed)

- [x] **Phase 6 VFS spec drift vs completed-phase text**: the implemented VFS spec (`docs/specs/vfs-manifest-artifact.md`) uses percent-escaping and `.poc-vfs/` prefix. Confirm `COMPLETED_PHASES.md` still claims base64url + `.poc-vfs` and reconcile to the canonical spec (prefer the current spec + implementation).
- [x] **Phase 6/Phase R script references**: AGENTS/README still refer to npm scripts that do not exist. Align docs to current entrypoints or restore the scripts.
- [x] **Windows CI marked non-blocking**: `.github/workflows/ci.yml` still sets `continue-on-error: true` for Windows. Decide whether this should be blocking and update accordingly.

---

## From PHASE10_PATCHLIST.md (confirmed)

### 10.1 Config + runtime gating
- [x] **Mode-aware interprocedural gating**: `runtime.riskInterproceduralEnabled` is still global. Implement mode-scoped gating (code-only) in the indexer pipeline and ensure downstream steps use the mode-effective config.
- [x] **Incremental signatures use mode-effective risk interprocedural config**: update `src/index/build/indexer/signatures.js` to use mode-scoped config.
- [x] **index_state.json mode-effective values**: ensure `riskInterprocedural.{enabled,summaryOnly,emitArtifacts}` reflect mode-effective values in `src/index/build/indexer/steps/write.js`.
- [x] **Tests**: extend runtime gating tests to assert code vs non-code behavior.

### 10.3 Risk summaries + compact chunk meta
- [x] **Update `buildRiskSummaries` signature + gating**: still `({ chunks, interprocedural, log })` and only runs when `riskInterproceduralEnabled` is true. Align signature to `({ chunks, runtime, mode, log })` and allow summaries when `emitArtifacts === "jsonl"` even if interprocedural is off (per roadmap).
- [x] **Deterministic sink ordering**: include severity → ruleId → evidence location ordering and update tests.
- [x] **Taint hints**: add `taintHints.taintedIdentifiers` to local risk output and cap/sort deterministically.

### 10.5 Propagation confidence scoring
- [x] **Implement exact confidence formula** in `flowConfidence()` (currently average + 0.85**hopCount + 0.9**barriers and floor 0.05). Update to roadmap formula and add tests.

### 10.6 Artifacts + contracts + required keys
- [x] **risk_interprocedural_stats schema + payload**: add canonical fields (`callSiteSampling`, `mode`, `timingMs.io`, `counts.risksWithFlows` = riskId count). Update `src/index/risk-interprocedural/engine.js`, `src/contracts/schemas/artifacts.js`, and docs spec.
- [x] **JSONL required keys**: `risk_summaries` required keys still include `totals`/`truncated`. Reduce to minimal set in `src/shared/artifact-io/jsonl.js`.
- [x] **enqueueRiskInterproceduralArtifacts signature + gating**: align writer signature and gating to roadmap; ensure mode/code-only + enabled logic matches, and document the single invocation location.

---

## From TRICKY_BUGS_SWEEP.md (confirmed)

- [x] **API search flag mapping is wrong**: `tools/api/router/search.js` emits `--*-filter` flags and `--output`, but CLI expects `--type`, `--author`, `--risk-tag`, `--full/--json/--compact`, etc. Replace with an explicit field→flag map and include `meta`/`metaJson` support.
- [x] **Duplicate `--repo`**: API builds `--repo`, and core search injects repo via `runSearchCli` root. Remove `--repo` from API args (preferred) or dedupe before invocation.
- [x] **Option injection via query**: `src/integrations/core/search.js` appends query without `--`. Insert `--` before the query (or at least when it starts with `-`) so yargs doesn’t treat it as flags. Consider also setting `.exitProcess(false)` in the CLI parser for server usage.
- [x] **Default output not applied**: `createApiRouter()` doesn’t pass `defaultOutput` to `buildSearchParams()`. Thread the value through so server defaults work.
- [x] **VSCode query parsing**: `extensions/vscode/extension.js` passes `query` directly as argv without `--`. Insert `--` before the query to avoid `--help`/flag interpretation.
- [x] **MCP transport shadowing**: `tools/mcp/transport.js` shadows `inFlight` inside `enqueueMessage()`. Rename the inner variable to avoid confusion.

---

# DOXFIX Roadmap (Subsystem Checklists)

Purpose: reconcile documentation vs code behavior across `docs/**` using `COSMIC_DOCS_LEDGER.md`. This roadmap is organized by subsystem with granular checklists, decisions, and touchpoints (line numbers where known).

Legend:
- [DOC] update documentation only
- [CODE] change implementation to match canonical docs/specs
- [DECISION] pick the canonical behavior first, then update doc/code
- Touchpoints include file paths, symbols, and line numbers when helpful

---

## Decision register (choose canonical behavior up front)

Defaults below are recommendations to keep scope controlled. If you prefer different choices, call them out and I’ll update the register.

1) **`api_contracts_meta` existence**  
   - Options: add schema + writer vs remove from docs  
   - **Chosen:** remove from docs (no schema in `ARTIFACT_SCHEMA_DEFS`).

2) **N‑1 major support for 0.x artifact surfaces**  
   - Options: change code to support N‑1 vs document current behavior  
   - **Chosen:** document current behavior (0.x supports current major only).

3) **`extensions`-only vs extra top‑level fields**  
   - Options: tighten schemas vs relax docs  
   - **Chosen:** relax docs to allow additionalProperties (current schema behavior).

4) **Graph explain shape** (`scoreBreakdown.graph`)  
   - Options: change output to match docs vs update docs  
   - **Chosen:** update docs to match current output (`score`, `degree`, `proximity`, `weights`, `seedSelection`, `seedK`).

5) **Impact input requirement** (seed/changed)  
   - Options: enforce non‑empty requirement vs document warning+empty result  
   - **Chosen:** document warning+empty result unless you want stricter enforcement.

6) **Graph product surfaces doc** (`docs/specs/graph-product-surfaces.md`)  
   - Options: keep authoritative and update vs archive  
   - **Chosen:** keep authoritative and update (still referenced by search-contract).

7) **Risk specs trimming/ordering vs implementation**  
   - Options: enforce spec in code vs update spec to current behavior  
   - **Chosen:** update specs to current behavior unless you want to tighten runtime behavior.

8) **Tooling IO `fileTextByFile` cache**  
   - Options: implement cache in providers vs update spec to VFS approach  
   - **Chosen:** update spec to VFS approach.

9) **TypeScript provider JS parity** (heuristic SymbolRef IDs)  
   - Options: remove heuristic IDs in code vs update spec to allow them  
   - **Chosen:** update spec to allow heuristics (document rationale).

10) **VFS manifest trimming vs row drop**  
   - Options: enforce deterministic trimming before drop vs update spec  
   - **Chosen:** update spec to current drop behavior unless you want stricter output.

11) **`docs/new_docs/*` promotion**  
   - Options: promote into `docs/specs/*` vs archive/remove  
   - **Chosen:** promote into `docs/specs/*` if still relevant to current plans.

---

## 0) Canonical source decisions (must do first)

[x] [DECISION] Confirm canonical source per domain:
    - Contracts: `docs/contracts/*` + `src/contracts/**`
    - Specs: `docs/specs/*` only where referenced as canonical
    - Guides: `docs/guides/*` should match `bin/pairofcleats.js` and tool entrypoints
    - Testing: `docs/testing/*` should match `tests/run.js` + `tests/run.rules.jsonc`

[x] [DECISION] For each mismatch below, choose "doc fix" vs "code fix" and log it inline (default to doc fixes unless explicitly marked [CODE]).

---

## 1) Contracts subsystem (docs/contracts)

### 1.1 docs/contracts/analysis-schemas.md
- Issue: API contracts doc omits required `options` object.

[x] [DOC] Add `options` to API contracts section (onlyExports, failOnWarn, caps).
    - Touchpoints:
      - `src/contracts/schemas/analysis.js` ~L684 (`API_CONTRACTS_SCHEMA`)
      - `src/contracts/validators/analysis.js` ~L77 (`validateApiContracts`)
    - Fields to list explicitly:
      - `options.onlyExports`, `options.failOnWarn`, `options.caps.maxSymbols`, `options.caps.maxCallsPerSymbol`, `options.caps.maxWarnings`
[x] [DOC] Add `diagnostics` to risk rule bundles (`warnings`, `errors`) to match schema.
    - Touchpoints:
      - `src/contracts/schemas/analysis.js` ~L220 (risk rules diagnostics)

### 1.2 docs/contracts/artifact-contract.md
- Issues: legacy sharded meta format; compressed sidecar precedence described incorrectly.

[x] [DOC] Replace sharded JSONL meta description with jsonl-sharded schema.
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L317 (`baseShardedJsonlMeta`)
    - Required fields to document:
      - `schemaVersion`, `format=jsonl-sharded`, `compression`, `totalRecords`, `totalBytes`, `maxPartBytes`, `targetMaxBytes`, `parts[]`
[x] [DOC] Fix loader precedence: raw `.json` first, compressed sidecars only when raw missing.
    - Touchpoints:
      - `src/shared/artifact-io/json.js` ~L16 (`readJsonFile`)
      - `src/shared/artifact-io/loaders.js` ~L20 (`resolveJsonlArtifactSources`)
    - Note:
      - `readJsonFile` does **not** prefer `.json.zst` when `.json` exists.

### 1.3 docs/contracts/artifact-schemas.md
- Issues: missing artifacts; `api_contracts_meta` mismatch; missing required fields.

[x] [DOC] Add missing artifacts: `chunk_uid_map`, `vfs_manifest`, `risk_summaries`, `risk_flows`, `risk_interprocedural_stats`, and their `*_meta` if present.
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L810 (`ARTIFACT_SCHEMA_DEFS`)
[x] [DECISION] `api_contracts_meta`: add schema or remove from doc.
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L810
[x] [DOC] Document required `kind` field for `import_resolution_graph` edges.
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L1151 (`import_resolution_graph`)
[x] [DOC] Document `index_state.riskInterprocedural` object and required fields.
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L1085 (`updatedAt`)
      - `src/contracts/schemas/artifacts.js` ~L1101 (`riskInterprocedural`)
[x] [CODE] Export `docs/contracts/artifact-schema-index.json` (schema registry → required fields + version).
    - Touchpoints:
      - `tools/docs/export-artifact-schema-index.js` (new)
      - `src/contracts/schemas/artifacts.js`
    - Tests:
      - `tests/tooling/docs/artifact-schema-index.test.js` (new)
    - Suggested output schema:
      - `{ artifact, schemaVersion, requiredFields[], optionalFields[] }` for each entry.

### 1.4 docs/contracts/compatibility-key.md
- Issue: wrong callsite path.

[x] [DOC] Fix reference to `src/integrations/core/build-index/compatibility.js`.
    - Touchpoints:
      - `src/integrations/core/build-index/compatibility.js` (search `buildCompatibilityKey`)

### 1.5 docs/contracts/graph-tools-cli.md
- Issue: doc requires seed/changed; CLI allows empty with warning.

[x] [DECISION] Enforce seed/changed in CLI or update doc to match warning behavior.
    - Touchpoints:
      - `src/graph/impact.js` (`buildImpactAnalysis` warning)
      - `src/integrations/tooling/impact.js`

### 1.6 docs/contracts/indexing.md
- Issues: sharded meta format + compression precedence outdated.

[x] [DOC] Update sharded JSONL meta section (jsonl-sharded schema).
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L317
[x] [DOC] Update compression precedence (raw-first).
    - Touchpoints:
      - `src/shared/artifact-io/json.js` ~L16

### 1.7 docs/contracts/public-artifact-surface.md
- Issues: N-1 major support for 0.x; extensions-only rule mismatch.

[x] [DECISION] Choose: support N-1 majors for 0.x in code or update doc to state 0.x is current-only.
    - Touchpoints:
      - `src/contracts/versioning.js` ~L19 (`resolveSupportedMajors`)
[x] [DECISION] Choose: tighten schema to require `extensions` only or update doc to allow additional top-level fields.
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` (additionalProperties in schema defs)

### 1.8 docs/contracts/retrieval-ranking.md
- Issue: graph explain shape mismatch.

[x] [DECISION] Align doc with current `scoreBreakdown.graph` (score, degree, proximity, weights, seedSelection, seedK) or change output to match doc.
    - Touchpoints:
      - `src/retrieval/output/explain.js` ~L57
      - `src/retrieval/pipeline/graph-ranking.js` ~L125

### 1.9 docs/contracts/search-cli.md
- Issues: missing flags; context expansion flags not present; `--filter` described as substring.

[x] [DOC] Update flags list to current CLI.
    - Touchpoints:
      - `src/retrieval/cli-args.js` ~L98-149
[x] [DOC] Clarify `--filter` as filter expression.
    - Touchpoints:
      - `src/retrieval/cli/normalize-options.js` ~L82 (`parseFilterExpression`)

### 1.10 docs/contracts/search-contract.md
- Issue: `--kind` vs `--type`.

[x] [DOC] Update flag name to `--type`.
    - Touchpoints:
      - `src/retrieval/cli-args.js`

### 1.11 docs/contracts/sqlite.md
- Issue: required tables list incomplete.

[x] [DOC] Update required tables list to include `doc_lengths`, `token_stats`, `phrase_vocab`, `phrase_postings`, `chargram_vocab`, `chargram_postings`, `file_manifest`.
    - Touchpoints:
      - `src/storage/sqlite/schema.js` ~L3 (`REQUIRED_TABLES`)

---

## 2) Guides subsystem (docs/guides)

### 2.1 docs/guides/editor-integration.md
[x] [DOC] Update JSON output fields list (add `extractedProse`).
    - Touchpoints:
      - `src/retrieval/cli/render.js` L51‑75 (extractedProse output)
      - `src/retrieval/cli/render.js` L100‑125 (availability flags)
[x] [DOC] Tie "Compact hit fields" to `--compact` (or `--json --compact`), not plain `--json`.
    - Touchpoints:
      - `src/retrieval/cli-args.js` L32 (compact flag)
      - `src/retrieval/cli/render.js` L73‑75 (compact mapping)

### 2.2 docs/guides/external-backends.md
[x] [DOC] Note `pairofcleats search` accepts `--backend memory` (wrapper passes flags through).
[x] [DOC] Document forced backend behavior (no fallback if required indexes missing).
    - Touchpoints:
      - `bin/pairofcleats.js` L64‑70 (search wrapper)
      - `src/storage/backend-policy.js` L8‑138 (forced backend selection + errors)
      - `src/retrieval/cli-args.js` L22‑60 (full CLI supports memory)
[x] [DOC] Correct default backend (sqlite, not sqlite-fts).
    - Touchpoints:
      - `src/storage/backend-policy.js` L8‑138

### 2.3 docs/guides/mcp.md
[x] [DOC] Replace `pairofcleats service mcp` with `node tools/mcp/server.js`.
    - Touchpoints:
      - `bin/pairofcleats.js` L266‑285 (service subcommands exclude mcp)
      - `tools/mcp/server.js` L10‑41 (actual entrypoint + mode selection)

### 2.4 docs/guides/metrics-dashboard.md
[x] [DOC] Remove unsupported fields or implement them (cache hit rate, BM25 params, timings).
[x] [DOC] Add `--top` flag to usage.
    - Touchpoints:
      - `tools/reports/metrics-dashboard.js` L9‑118 (current output fields)
      - `tools/dict-utils/paths/cache.js` L178‑184 (metrics dir)

### 2.5 docs/guides/rule-packs.md
[x] [DOC] Replace `pairofcleats structural search` with `node tools/analysis/structural-search.js`.
    - Touchpoints:
      - `tools/analysis/structural-search.js` L6‑13
      - `bin/pairofcleats.js` L684 (no structural command)

### 2.6 docs/guides/structural-search.md
[x] [DOC] Replace `pairofcleats structural search` with `node tools/analysis/structural-search.js`.
    - Touchpoints:
      - `tools/analysis/structural-search.js` L6‑13
      - `bin/pairofcleats.js` L684 (no structural command)

### 2.7 docs/guides/triage-records.md
[x] [DOC] Replace `pairofcleats triage ...` with tool scripts:
    - `node tools/triage/ingest.js`
    - `node tools/triage/decision.js`
    - `node tools/triage/context-pack.js`
    - Touchpoints:
      - `tools/triage/ingest.js` L13 (scriptName)
      - `tools/triage/decision.js` L11 (scriptName)
      - `tools/triage/context-pack.js` L9 (scriptName)
      - `bin/pairofcleats.js` L684 (no triage command)

### 2.8 docs/guides/search.md
[x] [DOC] Document new output modes (compact/symbol-first/context-only) when implemented.
[x] [DOC] Document JSON output exclusions by default vs `--explain` inclusion.
    - Touchpoints:
      - `src/retrieval/output/format.js` (render pipeline)
      - `src/retrieval/output/context.js` (context/pre/post handling)
      - `src/retrieval/output/summary.js` (summary layout)

### 2.9 docs/guides/commands.md
[x] [DOC] Add missing CLI commands to the command list (graph-context, context-pack, impact, suggest-tests, api-contracts, architecture-check, report eval/compare-models, tooling doctor, risk explain, lmdb build, sqlite build).
    - Touchpoints:
      - `bin/pairofcleats.js` L289‑551 (command routing)
      - `bin/pairofcleats.js` L704‑727 (help list)
[x] [DOC] Add short “how to run” sections or per-command mini guides for the same tools (or add new guide pages and link from commands).
    - Touchpoints:
      - `tools/analysis/graph-context.js` L1‑4
      - `tools/analysis/context-pack.js` L1‑4
      - `tools/analysis/impact.js` L1‑4
      - `tools/analysis/suggest-tests.js` L1‑4
      - `tools/api/contracts.js` L1‑4
      - `tools/analysis/architecture-check.js` L1‑4
      - `tools/analysis/explain-risk.js` L1‑4
      - `tools/tooling/doctor.js` L14
      - `tools/reports/compare-models.js` L28
      - `tools/eval/run.js` L11

### 2.10 docs/guides/service-mode.md
[x] [DOC] Remove or correct `indexModes` example; indexer service ignores repo-level indexModes.
    - Touchpoints:
      - `tools/service/indexer-service.js` L19‑44 (argv → mode)
      - `tools/service/indexer-service.js` L297‑381 (job mode handling)

---

## 3) Testing subsystem (docs/testing)

### 3.1 docs/testing/ci-capability-policy.md
[x] [DOC] Update PR suite default to `ci-lite`; note `services/api` exclusion.
[x] [DOC] Note Tantivy probing happens only in non-PR runs.
    - Touchpoints:
      - `tools/ci/run-suite.js`
      - `tools/ci/capability-gate.js`

### 3.2 docs/testing/failing-tests.md
[x] [DOC] Update log path to `.testLogs/**` and cache path to `.testCache/**`.
    - Touchpoints:
      - `tests/run.js`
      - `tests/tooling/script-coverage/paths.js`

### 3.3 docs/testing/test-decomposition-regrouping.md
[x] [DOC] Add lanes `ci-lite`, `ci-long`, `api`, `mcp`.
[x] [DOC] Clarify indexing/retrieval/tooling/runner are tags/paths, not lanes.
    - Touchpoints:
      - `tests/run.rules.jsonc`
[x] [DOC] Update services lane description to exclude api/mcp (they are separate lanes).
    - Touchpoints:
      - `tests/run.rules.jsonc` L19‑21
[x] [DOC] Replace proposed tag set with actual tag catalog (avoid tags not present in rules).
    - Touchpoints:
      - `tests/run.rules.jsonc` L31‑116 (tagRules)

### 3.4 docs/testing/test-runner-interface.md
[x] [DOC] Update defaults: timeouts, jobs, cache root behavior, test id format.
    - Touchpoints:
      - `tests/run.js` (defaults)
      - `tests/run.rules.jsonc` (lane list)
    - Explicit defaults to document:
      - Timeouts: `ci-lite=15000`, `ci=90000`, `ci-long=240000`, default `30000`
      - Jobs: physical core count (see `resolvePhysicalCores`)
      - Cache root: defaults to `.testCache` unless overridden
[x] [DOC] Document `--list-lanes` and `--list-tags`.
    - Touchpoints:
      - `tests/run.js` L97‑100
[x] [DOC] Document lane order files (`tests/<lane>/<lane>.order.txt`) and failure semantics.
    - Touchpoints:
      - `tests/run.js` L62, L173‑210
[x] [DOC] Document runner env overrides (`PAIROFCLEATS_TEST_*`, npm_config fallbacks).
    - Touchpoints:
      - `tests/run.js` L274‑288
[x] [DOC] Document tag catalog + meanings (bench, harness, watch, embeddings, sqlite, lmdb, jj, api/mcp, etc.).
    - Touchpoints:
      - `tests/run.rules.jsonc` L31‑116
Note: timing ledger/watchdog and coverage-merge documentation is tracked in `NIKE_SB_CHUNK_ROADMAP.md` (Phase 5).

---

## 4) Tooling docs (docs/tooling)

### 4.1 docs/tooling/ctags.md
[x] [DOC] Update CLI examples to `node tools/ingest/ctags.js` or npm script.
    - Source of truth: `tools/ingest/ctags.js`, `package.json` scripts
[x] [DOC] Document options and defaults: `--out`, `--json`, `--ctags`, `--args`, stdin behavior, and default `--run` when no input.
    - Touchpoints:
      - `tools/ingest/ctags.js` L12‑22 (options)
      - `tools/ingest/ctags.js` L150‑163 (stdin/run behavior)

### 4.2 docs/tooling/gtags.md
[x] [DOC] Update CLI examples to `node tools/ingest/gtags.js` or npm script.
    - Source of truth: `tools/ingest/gtags.js`, `package.json` scripts
[x] [DOC] Document options and defaults: `--out`, `--json`, `--global`, `--args`, stdin behavior, and default stdin when no input.
    - Touchpoints:
      - `tools/ingest/gtags.js` L13‑20 (options)
      - `tools/ingest/gtags.js` L110‑115 (stdin/run behavior)

### 4.3 docs/tooling/lsif.md
[x] [DOC] Update CLI examples to `node tools/ingest/lsif.js` or npm script.
    - Source of truth: `tools/ingest/lsif.js`, `package.json` scripts
[x] [DOC] Document options and defaults: `--out`, `--json`, stdin behavior when `--input -`.
    - Touchpoints:
      - `tools/ingest/lsif.js` L12‑16 (options)
      - `tools/ingest/lsif.js` L165‑168 (stdin behavior)

### 4.4 docs/tooling/scip.md
[x] [DOC] Update CLI examples to `node tools/ingest/scip.js` or npm script.
    - Source of truth: `tools/ingest/scip.js`, `package.json` scripts
[x] [DOC] Document options and defaults: `--out`, `--json`, `--scip`, `--args`, stdin behavior, and JSON (non‑JSONL) file parsing path.
    - Touchpoints:
      - `tools/ingest/scip.js` L13‑20 (options)
      - `tools/ingest/scip.js` L214‑218 (JSON file handling)

### 4.5 docs/tooling/repo-inventory.json
[x] [DOC] Ensure `tools/mcp/server-sdk.js` appears in `tools.entrypoints`.
    - Touchpoints:
      - `tools/mcp/server-sdk.js` (shebang)
      - `tools/docs/repo-inventory.js` (generator)
Note: ingest CLI wrapper documentation is tracked in `NIKE_SB_CHUNK_ROADMAP.md` (Phase 5).

### 4.6 docs/tooling/repo-inventory.md (new)
[x] [DOC] Add a short guide for `pairofcleats repo-inventory` and the JSON output format.
    - Touchpoints:
      - `tools/docs/repo-inventory.js` L9‑232

---

## 5) API docs (docs/api)

### 5.1 docs/api/core-api.md
[x] [DOC] Update buildIndex options list (stage/quality/modes/rawArgv/log/etc).
[x] [DOC] Update search params (`--compact` vs jsonCompact; ann-backend/context/filter params).
[x] [DOC] Update status params (`includeAll` vs `all`).
    - Touchpoints:
      - `src/integrations/core/build-index/index.js` L39 (buildIndex options)
      - `src/integrations/core/args.js` L12‑64 (buildRawArgs/buildSearchArgs)
      - `src/integrations/core/build-index/sqlite.js` L10‑20 (buildSqliteIndex options)
      - `src/integrations/core/search.js` L11 (search handler)
      - `src/integrations/core/status.js` L258 (status handler)

### 5.2 docs/api/mcp-server.md
[x] [DOC] Note default MCP mode is legacy unless `auto` explicitly requested.
    - Source of truth:
      - `tools/mcp/server-config.js` (default mode)
      - `tools/mcp/server.js` (arg handling)

### 5.3 docs/api/server.md
[x] [DOC] Confirm auth behavior note (localhost auth optional unless token set).
    - Touchpoints:
      - `tools/api/server.js` L47‑59 (authRequired logic)
[x] [DOC] Document that API server runs in-process (no CLI shell-out).
    - Touchpoints:
      - `tools/api/router.js` L1 (imports core search/status)
[x] [DOC] Tighten `/search` payload description to match Ajv schema (strict keys, meta/metaJson formats).
    - Touchpoints:
      - `tools/api/validation.js` L29 (search schema)
      - `tools/api/router/search.js` L85‑140 (payload mapping)
[x] [DOC] Publish canonical `/search` schema (embed in docs or link to Ajv source).
    - Touchpoints:
      - `tools/api/validation.js` L29‑136
    - Note:
      - Treat `tools/api/validation.js` as the canonical field list for `/search`.
[x] [DOC] Fix `/status` reference to nonexistent CLI (use core status output instead).
    - Touchpoints:
      - `src/integrations/core/status.js` L258
[x] [DOC] Document error codes + troubleshooting hints shared across API/MCP/CLI.
    - Touchpoints:
      - `docs/contracts/mcp-error-codes.md`
      - `docs/api/server.md`
      - `docs/api/mcp-server.md`

---

## 6) Config docs (docs/config)

### 6.1 docs/config/contract.md
[x] [DOC] Sync public config key list with `docs/config/schema.json`.
[x] [DOC] Update CLI flags list to current CLI options.
[x] [CODE] Generate `docs/config/contract.md` from `docs/config/schema.json` + `src/shared/env.js` (deterministic output).
    - Touchpoints:
      - `tools/config/contract-doc.js` (new)
      - `docs/config/contract.md`
    - Tests:
      - `tests/tooling/docs/config-contract-doc.test.js` (new)
    - Implementation details:
      - Parse schema at `docs/config/schema.json` (include descriptions, defaults, enums).
      - Pull env var metadata from `src/shared/env.js` (source of truth).
      - Emit sections: Overview, Schema keys, Defaults, Env overrides, CLI flags (if applicable).
      - Preserve line endings/BOM on regeneration (match `tools/config/inventory.js` behavior).
    - Source line anchors:
      - `docs/config/schema.json` L18‑396 (namespace keys)
      - `src/shared/env.js` L32‑58 (env surface)

### 6.2 docs/config/deprecations.md
[x] [DOC] Align deprecations with `docs/config/schema.json`.

### 6.3 docs/config/env-overrides.md
[x] [DOC] Update env var list to match `src/shared/env.js` and inventory.
[x] [DOC] Clarify non-secret env behavior vs secrets-only claim.
    - Touchpoints:
      - `src/shared/env.js` L32‑58 (`getEnvConfig`)
      - `src/shared/env.js` L79‑98 (`getTestEnvConfig`)

### 6.4 docs/config/execution-plan.md
[x] [DOC] Replace `metadata-only` with `records` / `extracted-prose` modes.
[x] [DOC] Update provider policy examples (tooling providers vs vscode/sublime).

### 6.5 docs/config/hard-cut.md
[x] [DOC] Remove `output.logPath` if not in schema.
[x] [DOC] Remove `indexing.skipImportResolution` if not in schema.

### 6.6 docs/config/budgets.md
[x] [DOC] Expand allowlist to match schema namespaces (threads/runtime/tooling/mcp/indexing/retrieval/search).
    - Touchpoints:
      - `docs/config/schema.json` L18‑396 (namespace list)
      - `docs/config/budgets.md` (current allowlist)

### 6.7 docs/config/surface-directives.md
[x] [DOC] Update unknown-key policy to reflect schema `additionalProperties` in indexing/embeddings.
    - Touchpoints:
      - `docs/config/schema.json` L172‑303 (indexing + embeddings)

---

## 7) Perf docs (docs/perf)

### 7.1 docs/perf/graph-caps.md
[x] [DOC] Document graph caps harness CLI usage (required `--outDir`, `--graphFixture` or `--index`, optional `--depth`).
    - Touchpoints:
      - `tools/bench/graph-caps-harness.js` L80‑107 (CLI args + validation)
      - `tools/bench/graph-caps-harness.js` L34‑70 (output file)
[x] [DOC] Document how `graph-caps-defaults.json` is produced and what each field means.
    - Touchpoints:
      - `docs/perf/graph-caps-defaults.json` (output structure)

### 7.2 docs/perf/graph-caps-defaults.json
[x] [DOC] Add provenance note (generator + inputs), and link back to `graph-caps.md`.

---

## 8) Benchmark docs (docs/benchmarks)

### 8.1 docs/benchmarks/overview.md
[x] [DOC] Fix microbench backend list (memory/sqlite/sqlite-fts only; no lmdb).
    - Touchpoints:
      - `tools/bench/micro/run.js` L39‑45 (backend list)
[x] [DOC] Document microbench CLI flags: `--repo-current`, `--query`, `--threads`, `--sqlite`, `--components`, `--ann-backends`, `--json`.
    - Touchpoints:
      - `tools/bench/micro/run.js` L22‑95
[x] [DOC] Document thread default/override behavior used by microbench (`--threads` and env).
    - Touchpoints:
      - `src/shared/threads.js` L8‑97
[x] [DOC] Document tinybench CLI flags: `--iterations`, `--warmup-iterations`, `--time`, `--warmup-time`, `--components`, and standard repo/query/backend flags.
    - Touchpoints:
      - `tools/bench/micro/tinybench.js` L18‑60
[x] [DOC] Document query generator flags: `--repo`, `--out`, `--json`, `--index-root`, and default JSON output path.
    - Touchpoints:
      - `tools/bench/query-generator.js` L13‑19, L90‑99
[x] [DOC] Document bench harness `--query-concurrency` (and where it applies).
    - Touchpoints:
      - `src/shared/cli-options.js` L50
[x] [DOC] Add bench matrix runner flags (`--ann-modes`, `--backends`, `--out-dir`, `--log-dir`, `--fail-fast`) or link to language benchmarks doc.
    - Touchpoints:
      - `tools/bench/language-matrix.js` L20‑38, L54‑96

### 8.2 docs/benchmarks/evaluation.md
[x] [DOC] Confirm evaluation options + output formats match `tools/eval/run.js` (update if drift is found).
    - Touchpoints:
      - `tools/eval/run.js` L11‑180 (metrics schema + output)

### 8.3 docs/benchmarks/model-comparison.md
[x] [DOC] Confirm model comparison CLI flags and outputs match `tools/reports/compare-models.js`.
    - Touchpoints:
      - `tools/reports/compare-models.js` L28‑120 (CLI args + output)

---

## 9) Language docs (docs/language)

### 9.1 docs/language/benchmarks.md
[x] [DOC] Document that `--stub-embeddings/--real-embeddings` are forwarded to the runner (not ignored).
    - Touchpoints:
      - `tools/bench/language-repos.js` L653‑657
[x] [DOC] Update tier definitions to include `small`/`tiny` (positional filters allowed).
    - Touchpoints:
      - `tools/bench/language-repos.js` L290‑296
[x] [DOC] Document language bench CLI flags (`--dry-run`, `--results`, `--repos`, `--only`, `--languages`, `--queries`, `--heap-mb`, `--cache-run`).
    - Touchpoints:
      - `tools/bench/language/cli.js` L53‑96
      - `tools/bench/language-repos.js` L302‑305, L533‑568, L647‑680

### 9.2 docs/language/lang-sql.md
[x] [DOC] Update default mode to `--mode all` (no lang-sql doc present; no update needed).

### 9.3 docs/language/lang-typescript.md
[x] [DOC] Update default mode to `--mode all` (no lang-typescript doc present; no update needed).

---

## 10) New docs (docs/new_docs)

### 10.1 docs/new_docs/graph-caps.md
[x] [DECISION] Promote to `docs/specs/graph-caps.md` (align with current plans).

### 10.2 docs/new_docs/symbol-artifacts-and-pipeline.md
[x] [DECISION] Merge into `docs/specs/symbol-artifacts-and-pipeline.md`.

---

## 11) Specs subsystem (docs/specs)

### 11.1 docs/specs/analysis-schemas.md
[x] [DOC] Create or update to current schema (graph context, impact, api contracts, architecture, suggest-tests).
    - Touchpoints:
      - `src/contracts/schemas/analysis.js` ~L505 (`GRAPH_CONTEXT_PACK_SCHEMA`)
      - `src/contracts/schemas/analysis.js` ~L684 (`API_CONTRACTS_SCHEMA`)
      - `src/contracts/schemas/analysis.js` ~L774 (`SUGGEST_TESTS_SCHEMA`)

### 11.2 docs/specs/artifact-schemas.md
[x] [DOC] Create or update to current schema; add missing artifacts and jsonl-sharded schema.
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L317, ~L810
[x] [DECISION] `api_contracts_meta`: add schema or remove from docs.

### 11.3 docs/specs/graph-caps.md
  [x] [DOC] Replace placeholder with actual schema + defaults.
    - Touchpoints:
      - `src/retrieval/pipeline/graph-ranking.js`

### 11.4 docs/specs/graph-product-surfaces.md
[x] [DECISION] Keep as authoritative and update (still referenced).

### 11.5 Risk specs (all five files)
[x] [DOC] Align required fields with schema (`mode`, `callSiteSampling`, `timingMs.io`, etc).
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js`
    - Schema entries to cross-check:
      - `risk_summaries`, `risk_flows`, `risk_interprocedural_stats`, `call_sites`
[x] [DOC] Fix `call_sites` spec subset:
    - Required fields: include `languageId`, `start`, `end` (byte offsets).
    - Optionality: `snippetHash` is optional in schema.
    - Sampling: document that writer currently emits all call details (no per-edge sampling).
    - Touchpoints:
      - `src/contracts/schemas/artifacts.js` ~L502 (callSiteEntry required fields)
      - `src/index/build/artifacts/writers/call-sites.js` ~L146 (writer emits all call details)
[x] [DECISION] Enforce deterministic trimming/ordering in code or update spec to current behavior.
    - Touchpoints:
      - `src/index/build/artifacts/writers/*`
[x] [DOC] Document row-size trimming + dropped-row accounting for risk artifacts (or add missing stats in code).
    - Touchpoints:
      - `src/index/build/artifacts/writers/call-sites.js` ~L68 (trim/drop)
      - `src/index/build/artifacts/writers/risk-interprocedural.js` ~L33 (no trimming)

### 11.6 docs/specs/runtime-envelope.md
[x] [DOC] Update env precedence + envelope fields.
    - Touchpoints:
      - `src/shared/runtime-envelope.js`
      - `src/shared/env.js`

### 11.7 docs/specs/safe-regex-hardening.md
[x] [DOC] Add RE2JS fallback + input/program caps; reference `compileSafeRegex`.
    - Touchpoints:
      - `src/shared/safe-regex.js`
      - `src/shared/safe-regex/backends/*`

### 11.8 SCM specs
[x] [DOC] Expand provider contract (head/dirty semantics, path normalization, precedence, error signaling).
[x] [DOC] Add JJ operationId to schema.
    - Touchpoints:
      - `src/index/scm/providers/git.js`
      - `src/index/scm/providers/jj.js`
    - Concrete behaviors to document:
      - `listTrackedFiles` return shape (paths POSIX + repo‑relative)
      - provenance `head` (hash + operationId for jj) + `dirty` semantics
      - error handling: fall back to `provider=none` vs hard error

### 11.9 docs/specs/segmentation-perf.md
  [x] [DOC] Update caps/targets to current maxBytes and fallback logic.

### 11.10 docs/specs/signature.md
  [x] [DOC] Update signature inputs (include repo provenance/provider head, index compat key).
    - Touchpoints:
      - `src/index/build/indexer/signatures.js`

### 11.11 docs/specs/symbol-artifacts-and-pipeline.md
  [x] [DOC] Align with current symbol artifact schema or mark as draft.
    - Touchpoints:
      - `src/index/build/artifacts/writers/*`

### 11.12 docs/specs/test-strategy-and-conformance-matrix.md
  [x] [DOC] Update lane list and descriptions (ci-lite, ci-long, api, mcp).

### 11.13 docs/specs/tooling-and-api-contract.md
  [x] [DOC] Update MCP tool list and defaults; include schemaVersion in responses.
    - Touchpoints:
      - `src/integrations/mcp/defs.js`
      - `tools/mcp/server-config.js`

### 11.14 docs/specs/tooling-doctor-and-reporting.md
[x] [DOC] Align report schema with `src/index/tooling/doctor.js` output.

### 11.15 docs/specs/tooling-io.md
[x] [DECISION] Implement `fileTextByFile` caching in tooling or update spec to VFS approach.
    - Touchpoints:
      - `src/index/tooling/*`
      - `src/index/tooling/vfs.js`

### 11.16 docs/specs/tooling-provider-registry.md
[x] [DOC] Update names/fields to match `src/index/tooling/provider-registry.js` + `orchestrator.js`.

### 11.17 docs/specs/typescript-provider-js-parity.md
[x] [DECISION] Remove no-ad-hoc-ID rule or change implementation to avoid heuristic SymbolRef IDs.
    - Touchpoints:
      - `src/index/tooling/typescript-provider.js`

### 11.18 docs/specs/vfs-manifest-artifact.md
[x] [DECISION] Enforce deterministic trimming before dropping oversized rows or update spec.
    - Touchpoints:
      - `src/index/tooling/vfs.js`

### 11.19 docs/specs/watch-atomicity.md
  [x] [DOC] Update attempt root / promotion barrier names and defaults.
    - Touchpoints:
      - `src/index/build/watch/*`

### 11.20 Workspace specs
[x] [DOC] Sync workspace config keys with `docs/config/schema.json` (include `indexing.scm.*`).
[x] [DOC] Revalidate workspace manifest fields and manifestHash rules vs current federation plan.

---

## 12) Archived docs (docs/archived)

[x] [DOC] Confirm archived docs are not referenced as canonical anywhere.
[x] [DOC] Where referenced for historical context, ensure they are labeled DEPRECATED and point to replacements.

---

## 13) Deliverables and validation

[x] [DOC] Update `COSMIC_DOCS_LEDGER.md` with resolution status tags (doc fix vs code fix) per task above.
[x] [DOC] Ensure all references in guides/contracts/specs point to correct paths.
[x] [DOC] Run any existing doc validation (if present) or add a minimal consistency check.

---

## 14) Optional automation (quality-of-life)

[x] [CODE] Add a doc drift checker that compares:
    - CLI flags vs docs
    - Schema lists vs docs
    - Test lanes vs docs
    - Output fields vs docs (initially `scoreBreakdown` keys)
    - Touchpoints:
      - `tools/docs/contract-drift.js`
      - `docs/testing/` for policy
    - Note:
      - Entry point vs docs remains covered by `tests/indexing/policy/script-surface-policy.test.js`.
[x] [CODE] Define comparison inputs/outputs:
    - Inputs:
      - CLI flags from `src/retrieval/cli-args.js`
      - Artifact list from `src/contracts/schemas/artifacts.js` (`ARTIFACT_SCHEMA_DEFS`)
      - Lanes from `tests/run.rules.jsonc` (`knownLanes`)
      - Score breakdown keys from `src/retrieval/pipeline.js`
    - Docs to verify:
      - `docs/contracts/search-cli.md`, `docs/contracts/search-contract.md`
      - `docs/contracts/artifact-schemas.md`
      - `docs/testing/test-runner-interface.md`, `docs/testing/test-decomposition-regrouping.md`
    - Outputs:
      - `docs/tooling/doc-contract-drift.json` (machine readable)
      - `docs/tooling/doc-contract-drift.md` (short summary for CI)
[x] [CODE] Wire doc drift checker into CI (fail on drift, print diff summary).
    - Touchpoints:
      - `tools/ci/run-suite.js`

---

## Notes for triage (missing functionality vs outdated docs)

- If a doc is a contract/spec referenced by validation or build code, treat it as authoritative and fix code unless the contract is obsolete.
- If a guide/bench doc is inconsistent with current CLI/tools, fix the doc unless you intend to support the documented behavior.
- If both doc and code are ambiguous, record a decision first and then update both.

---

# Findings 1-4

---

## Confirmed correctness bugs

### 1) Stateful global RegExp breaks filter parsing across multiple calls
- **Severity:** High
- **File:** `src/retrieval/filters.js`
- **Where:** `FILTER_TOKEN_RE` (~L63) + `splitFilterTokens()` loop (~L74–82)
- **Problem:** `FILTER_TOKEN_RE` is declared with the global (`g`) flag and reused across calls. Using `.exec()` advances `lastIndex`, so subsequent calls can start scanning mid-string or immediately return `null`, producing empty/partial token lists.
- **Impact:** In long-running processes (API server / MCP), filters can silently stop working after a previous query.
- **Fix:** Reset `FILTER_TOKEN_RE.lastIndex = 0` at the start of `splitFilterTokens()`, or instantiate a fresh regex inside the function.

---

### 2) CLI wrapper mis-parses `--repo` (ignores `--repo=...` and can misread query text)
- **Severity:** Medium
- **File:** `bin/pairofcleats.js`
- **Where:** `extractRepoArg()` (~L661–665)
- **Problems:**
  1. Only supports `--repo <path>`, not `--repo=<path>`.
  2. Does not respect the `--` end-of-options sentinel. If a user searches for the literal token `--repo` after `--`, the wrapper can incorrectly treat it as a flag and grab the next token as the repo path.
- **Impact:** Wrong repo root selection → wrong config/runtime envelope and confusing failures.
- **Fix:** Only scan args before `--`, and support both `--repo value` and `--repo=value`.

---

### 3) API server breaks for IPv6 hosts (e.g. `--host ::1`)
- **Severity:** Medium
- **Files:**
  - `tools/api/router.js`
  - `tools/api/server.js`
- **Where:**
  - `tools/api/router.js`: `new URL(req.url..., \`http://${host}\`)` (~L63)
  - `tools/api/server.js`: `baseUrl = \`http://${host}:${actualPort}\`` (~L94)
- **Problem:** IPv6 literals must be bracketed in URLs (`http://[::1]:7345`). As written, `http://::1` is invalid.
- **Impact:** API becomes unusable under IPv6 host settings (invalid URL / 500s).
- **Fix:** Bracket IPv6 in URL contexts or avoid interpolating host into the parsing base (use a fixed base like `http://localhost` for request URL parsing).

---

## Major performance / scalability issues

### 4) Per-chunk duplication of file-level lint/complexity bloats memory & artifacts
- **Severity:** Medium–High
- **Files:**
  - `src/index/build/file-processor/process-chunks/index.js` (~L381–420)
  - `src/index/build/file-processor/assemble.js` (~L96–130)
- **Problem:** `processChunks()` computes `fileComplexity` / `fileLint` once per file, but attaches them to **every chunk**. `buildChunkPayload()` stores them verbatim (`complexity`, `lint`).
- **Impact:** Larger in-memory `chunks[]`, larger serialized artifacts / SQLite rows, slower IO and load/search on large repos.
- **Fix options:**
  1. Store lint/complexity once per file (e.g., `file_meta`) and reference by file id.
  2. If chunk-level details are needed, filter lint/complexity down to the chunk’s line range.
  3. Gate behind a config flag (default off).

---

### 5) Index cache validation always recomputes a full signature (expensive with sharded artifacts)
- **Severity:** High (latency)
- **File:** `src/retrieval/index-cache.js`
- **Where:**
  - `buildIndexSignature()` (~L128–142)
  - `loadIndexWithCache()` (~L200–213), signature computed at ~L205 even on cache hits
- **Problem:** Every `loadIndexWithCache()` call computes a signature requiring `readdirSync()` + `statSync()` on *many* shard files.
- **Impact:** Even warm cache searches can do lots of synchronous filesystem work, blocking the Node event loop and dominating request latency on large builds.
- **Fix options:**
  1. Use a single build marker / build id file for validation (e.g., `index_state.json` build id).
  2. Cache signatures with a TTL.
  3. Avoid per-shard stats if the `.meta.json` reliably changes whenever shards change.

---

### 6) File discovery materializes and sorts full candidate lists; then per-file `lstat` (heavy on huge repos)
- **Severity:** Medium
- **Files:** `src/index/build/file-scan.js`, `src/index/build/discover.js`
- **Problem:** Candidate paths are collected into memory, sorted, then `fs.lstat()` is called per candidate.
- **Impact:** Big repos → high peak memory, lots of metadata IO, long wall time.
- **Potential improvements:** Use fdir’s stats mode if possible, apply max-files earlier, and stream candidates rather than fully materializing.

---

### 7) Watch-mode fallback can run unbounded async work (`Promise.all`) if IO queue missing
- **Severity:** Medium
- **File:** `src/index/build/watch.js` (~L170–190)
- **Problem:** If `runtimeRef.queues?.io` is absent, it does `Promise.all(absPaths.map(handleUpdate))`.
- **Impact:** Large change bursts can spawn thousands of concurrent operations (CPU + IO contention, process instability).
- **Fix:** Ensure an IO queue always exists in watch mode, or cap concurrency in the fallback.

---

## Reliability / maintainability issues

### 8) Queue lock can become permanently blocking after crashes (no stale-lock recovery)
- **Severity:** Medium
- **File:** `tools/service/queue.js`
- **Where:** `withLock()` (~L9–41)
- **Problem:** Lock is a simple file created with `open(...,'wx')`. If a process dies while holding it, the lock file remains; others wait 5s then throw `Queue lock timeout`. There is no stale lock cleanup.
- **Impact:** Queue can deadlock until manual deletion.
- **Fix:** Add PID/timestamp + stale-lock detection (a similar pattern exists in `src/index/build/lock.js`).

---

### 9) Redundant AbortController + duplicated listeners in API routes
- **Severity:** Low
- **File:** `tools/api/router.js`
- **Where:**
  - `/search/stream`: unused `abortController` (~L159–164) then separate `controller` used later
  - `/search`: similar pattern (~L254–258 then ~L305+)
- **Impact:** Unnecessary complexity/overhead; makes abort logic harder to reason about.
- **Fix:** Keep one controller per request and wire its `signal` consistently.

---

### 10) SCM annotate timeout wrapper doesn’t cancel underlying work
- **Severity:** Medium
- **File:** `src/index/build/file-processor/cpu.js`
- **Where:** `annotateWithTimeout()` (~L321–339)
- **Problem:** Uses `Promise.race()`; when the timer wins, underlying annotate work may continue unless the provider truly enforces timeouts.
- **Impact:** Potential background work continuing past timeouts.
- **Fix:** Ensure underlying annotate supports cancellation / kill; don’t rely solely on `Promise.race()`.

---

### 11) Sync filesystem usage on request-time paths can block the event loop
- **Severity:** Medium
- **Examples:** `src/retrieval/index-cache.js` signature logic; some API server path checks that use sync fs.
- **Impact:** Head-of-line blocking under concurrent requests.
- **Fix:** Use async FS on hot paths or move heavy work to workers / background processes.

---

### 12) Streaming JSON-RPC parser does `Buffer.concat()` on every chunk (potential O(n²) copying)
- **Severity:** Medium
- **File:** `src/shared/jsonrpc.js`
- **Where:** `createFramedJsonRpcParser().push()` (~L161–172), esp. ~L170
- **Problem:** `Buffer.concat([buffer, incoming])` repeatedly copies as payload grows.
- **Impact:** Lower throughput for many small incoming chunks (stdio pipes/LSP/MCP).
- **Fix:** Use chunk arrays + offsets (buffer list) and only concatenate when needed.

---

## Additional findings from extended pass

### 13) Index lock can be “stolen” from a still-running build after 30 minutes
- **Severity:** High
- **File:** `src/index/build/lock.js` (~L141–L151)
- **Problem:** If a lock exists and is “stale” by mtime (>30 min), the code can delete it *before* verifying whether the owning PID is still alive. A legitimate long-running build can lose its lock.
- **Impact:** Two builds can run concurrently against the same output/cache directories → race conditions and inconsistent artifacts.
- **Fix:** If lock is stale, also check PID liveness before deleting; or have the owner periodically refresh (touch) the lock.

---

### 14) Index lock `release()` can mark “released” even if deletion failed
- **Severity:** Medium
- **File:** `src/index/build/lock.js` (~L127–L137)
- **Problem:** `released = true` is set even if `fs.rm(lockPath)` fails; cleanup handlers are detached.
- **Impact:** Lock file can remain behind and block future builds until stale cleanup kicks in or manual deletion occurs.
- **Fix:** Only set `released = true` after successful deletion; keep cleanup active/log hard on failure.

---

### 15) `createJsonWriteStream(maxBytes)` enforces size limit **after** committing the file atomically
- **Severity:** High
- **File:** `src/shared/json-stream/streams.js` (~L67–L86)
- **Problem:** Byte counter sets `overLimit`, but the stream isn’t aborted. `replaceFile(tempPath, finalPath)` is called and then `done()` throws if overLimit.
- **Impact:** Oversized artifact may already be promoted to its final location even though the function throws (callers may assume nothing was written).
- **Fix:** Abort the pipeline immediately when maxBytes is exceeded; or at minimum check `overLimit` before `replaceFile()`.

---

### 16) Atomic replace waits for `'finish'`, not `'close'` — rename race risk on Windows
- **Severity:** Medium
- **File:** `src/shared/json-stream/streams.js` (`waitForFinish` ~L10–L13)
- **Problem:** `'finish'` can fire before the fd is closed on `fs.WriteStream`. Renames can fail if the file is still open.
- **Impact:** Intermittent failures on Windows (`EPERM`/`EBUSY`).
- **Fix:** Await `'close'` on the write stream (or ensure fd closure) before renaming.

---

### 17) Temp-file cleanup gaps on abort/error paths during JSON streaming writes
- **Severity:** Low–Medium
- **File:** `src/shared/json-stream/streams.js`
- **Problem:** Temp files may be left behind on errors prior to `replaceFile()`.
- **Impact:** Disk clutter and confusing artifacts over time.
- **Fix:** Ensure tempPath cleanup in `catch/finally` unless promoted to final.

---

### 18) Zstd stream buffering uses repeated `Buffer.concat()` in hot path
- **Severity:** Medium (performance)
- **File:** `src/shared/json-stream/compress.js` (~L88–L124, esp. ~L99)
- **Problem:** Repeated concatenations can be costly with many small input chunks.
- **Impact:** Unnecessary CPU/memory churn while compressing.
- **Fix:** Use a buffer list strategy and concatenate only when flushing.

---

### 19) Zip extraction can still be vulnerable to zip-bomb style memory spikes
- **Severity:** Medium–High (resource exhaustion)
- **File:** `tools/download/extensions.js` (~L266–L296)
- **Problem:** `entry.getData()` decompresses entries fully into memory. Declared-size limit checks don’t prevent decompression allocation spikes.
- **Impact:** Potential OOM / severe slowdown if extension zips are untrusted or compromised.
- **Fix:** Use a streaming zip reader and enforce decompressed-byte limits while streaming (plus compression ratio heuristics).

---

### 20) Git SCM annotate ignores `timeoutMs`; outer timeout wrapper can leave `git blame` running
- **Severity:** Medium–High
- **File:** `src/index/scm/providers/git.js` (~L112–L119)
- **Related:** `src/index/build/file-processor/cpu.js` (`annotateWithTimeout`)
- **Problem:** `timeoutMs` is accepted but not used by the git provider. `Promise.race` timeout doesn’t cancel the underlying blame work.
- **Impact:** Many concurrent long-running `git blame` processes can keep running after timeouts, causing CPU/disk contention and long tail latency.
- **Fix:** Use a subprocess runner with timeout + abort support; ensure process-tree kill.

---

### 21) Path-prefix checks using `.startsWith()` without boundary checks can misclassify paths
- **Severity:** Low–Medium (hardening)
- **Files:**
  - `src/index/git.js` (`filePathResolved.startsWith(baseDir)`)
  - `src/index/build/import-resolution.js` (`dir.startsWith(rootAbs)`)
- **Problem:** String prefix checks can treat `/repo2` as within `/repo`.
- **Impact:** Usually limited by call-site constraints, but can lead to incorrect relpaths/caches if a weird path enters.
- **Fix:** Use `path.relative()` and ensure it doesn’t start with `..` and isn’t absolute.

---

### 22) Incremental caching trusts `(size, mtimeMs)` too much — can miss edits on coarse timestamp FS
- **Severity:** Medium
- **File:** `src/index/build/incremental.js` (~L200–L320 range)
- **Problem:** Unchanged detection often relies on “same size and same `mtimeMs`”.
- **Impact:** On coarse timestamp filesystems or tooling that preserves timestamps, edits can be missed → cached results reused → stale index.
- **Fix:** Add content hash checks in more cases; or sample hashes when `(size,mtime)` matches; or detect coarse FS and adjust.

---

### 23) Bundle reads have no max size; corrupted/huge bundle files can OOM
- **Severity:** Medium
- **File:** `src/shared/bundle-io.js` (`readBundleFile` ~L80–L124)
- **Used by:** `src/index/build/incremental.js`, `src/storage/sqlite/build/*`
- **Problem:** Reads whole bundle into memory (`readFile`) then parses (JSON.parse/msgpack) without size checks.
- **Impact:** A huge or corrupted bundle can crash the process or cause very high memory usage.
- **Fix:** `stat()` first; enforce max bundle size; consider streaming parse for JSON if large bundles are expected.

---

### 24) Exclude-filtering builds per-chunk Sets (avoidable allocations/GC)
- **Severity:** Low
- **File:** `src/retrieval/output/filters.js` (~L140–L190)
- **Problem:** For each chunk, builds `Set`s of normalized tokens/ngrams when exclude filters are present.
- **Impact:** Higher GC pressure for large result sets.
- **Fix:** Prefer linear scan or cache normalized representations per chunk when reused.

---

## Critical / high-severity issues

### 1) Zstd decompression fallback can OOM the process (output limit is not enforced during execution)

- **Files / locations**
  - `src/shared/artifact-io/json.js`
    - `readJsonFile()` calls `decompressBuffer(...)` during JSON reads (L16–74; call at L35–39).
    - `readJsonLinesArray()` falls back to `decompressBuffer(...)` for `.jsonl.zst` if streaming zstd isn’t available (L185–204; fallback at L199–203).
    - `readJsonLinesArraySync()` also uses `decompressBuffer(...)` for compressed candidates (L279–299).
  - `src/shared/artifact-io/compression.js`
    - `zstdDecompressSync()` buffers stdin and decompresses in a child process (L17–58).
  - `src/shared/subprocess.js`
    - `spawnSubprocessSync()` uses `spawnSync()` and only trims output *after* completion (L320–395).

- **Root cause**
  - `.zst` decoding ultimately uses `zstdDecompressSync()`, which runs a child Node process and returns decompressed data via stdout.
  - In the parent, `spawnSubprocessSync()` relies on `child_process.spawnSync()`, which buffers stdout in memory without a true max-buffer cap.
  - `maxOutputBytes` is applied after-the-fact via `trimOutput()`, which cannot prevent OOM if stdout was huge.

- **Impact**
  - A malicious or accidental “decompression bomb” `.zst` artifact can crash the process (or the child) with OOM.
  - The current safety checks mostly examine **compressed size**, which does not bound decompressed size.

- **Why this is tricky**
  - The code *looks* like it enforces limits (`MAX_JSON_BYTES`, `maxOutputBytes`), but the limit is not effective for `spawnSync()`-captured output.

- **Recommended fixes**
  1) Prefer in-process streaming zstd (`createZstdDecompress`) with an inflated-bytes counter that aborts at `maxBytes` (similar to the gzip streaming path).
  2) If subprocess fallback is required, avoid `spawnSync()`; use the async `spawnSubprocess()` collector so memory is bounded while reading.
  3) In the child, avoid buffering full stdin/output; stream and enforce an output byte cap in the child too.

---

### 2) `expectedExitCodes` normalization is incorrect (string exit codes never match numeric exit codes)

- **File:** `src/shared/subprocess.js`
- **Location:** `resolveExpectedExitCodes()` (L45–56), used by `spawnSubprocess()` (L174+) and `spawnSubprocessSync()` (L331+).

- **Problem**
  - The function filters by `Number.isFinite(Number(entry))` but returns the original entries (potentially strings).
  - Later comparisons use `expectedExitCodes.includes(exitCode)` where `exitCode` is numeric, so `'0'` will not match `0`.

- **Impact**
  - Callers that pass exit codes as strings (common if values flow from CLI/env/JSON) will see false failures.

- **Fix**
  - Normalize to numbers:
    - `return value.map((v) => Math.trunc(Number(v))).filter(Number.isFinite)`

---

### 3) `spawnSubprocessSync()` drops the real cause for spawn failures (ENOENT, EACCES, etc.)

- **File:** `src/shared/subprocess.js`
- **Location:** `spawnSubprocessSync()` (L320–395).

- **Problem**
  - `spawnSync()` sets `result.error` when the process cannot be spawned.
  - The code does not check `result.error`, and instead throws a generic “exited with code unknown” `SubprocessError`.

- **Impact**
  - “Missing binary” failures become unnecessarily hard to diagnose (especially in CI).

- **Fix**
  - If `result.error` exists, throw a `SubprocessError` that wraps it (or rethrow with context), rather than reporting an “unknown exit code”.

---

## Medium-severity correctness / cross-platform reliability issues

### 4) Atomic JSON writes may rename the temp file before the file descriptor is closed (Windows/AV/FS edge cases)

- **File:** `src/shared/json-stream/streams.js`
- **Locations:**
  - `waitForFinish()` listens to `finish` (L15–18).
  - `createJsonWriteStream().done` waits for `finish` then calls `replaceFile()` (L62–69, L85–92, L106–113).

- **Problem**
  - `finish` means all data has been flushed to the writable stream, but **does not guarantee** the fd is closed.
  - Renaming an open file is unreliable on Windows and can fail intermittently with `EPERM`/`EBUSY`.

- **Fix**
  - For the final `fs.createWriteStream(...)`, await `close` (or use `pipeline()` and await its callback), then rename.

---

### 5) `replaceSqliteDatabase()` deletes WAL/SHM sidecars unconditionally (risky if WAL still contains needed pages)

- **File:** `src/storage/sqlite/utils.js`
- **Location:** `replaceSqliteDatabase()` (L146–206); sidecar cleanup at L166–168.

- **Risk**
  - If WAL contains committed-but-not-checkpointed data (or another process has an open connection), deleting WAL/SHM can corrupt or lose data.

- **Mitigation / fix ideas**
  - Ensure all writers checkpoint and close before replacement.
  - Consider moving sidecar cleanup until after successful replacement (or skipping it unless explicitly requested).

---

## Performance / memory issues that become big in real workloads

### 6) `createFflateGzipStream()` needlessly copies every incoming Buffer chunk

- **File:** `src/shared/json-stream/compress.js`
- **Location:** `createFflateGzipStream()` transform (L28–55); `Buffer.from(chunk)` copy at L34–35.

- **Impact**
  - For large JSON streams, this doubles memory traffic and increases GC pressure.

- **Fix**
  - Use `Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk, encoding)`.

---

### 7) `createZstdStream()` repeatedly `Buffer.concat()`s pending data (can approach quadratic copying with many small writes)

- **File:** `src/shared/json-stream/compress.js`
- **Location:** `pending = Buffer.concat([pending, buffer])` (L99).

- **Impact**
  - Many small writes → repeated copies of the pending buffer.

- **Fix**
  - Accumulate chunks in an array and concat only when you have ≥ `chunkSize` (or use a small ring buffer).

---

### 8) JSONL sync reader cache never hits when only the compressed form exists

- **File:** `src/shared/artifact-io/json.js`
- **Location:** `readJsonLinesArraySync()` (L262–349)
  - Cache lookup uses `readCache(filePath)` (L266–270).
  - Cache write uses `writeCache(targetPath, parsed)` (L296–297).

- **Problem**
  - If `filePath` doesn’t exist and only `filePath.gz` / `filePath.zst` exists, `readCache(filePath)` always misses because it stats `filePath`.
  - The parsed result is cached under the candidate path, but never consulted on subsequent calls.

- **Fix**
  - Cache using the resolved candidate path (or cache under both keys).

---

### 9) SQLite compaction disk-space estimate is likely too low for `VACUUM` in worst cases

- **File:** `tools/build/compact-sqlite-index.js`
- **Locations:**
  - required bytes computation (L87–93)
  - `outDb.exec('VACUUM')` (L444)

- **Risk**
  - `VACUUM` often needs temporary space roughly comparable to the DB size (sometimes more), depending on SQLite and temp-store configuration.

- **Fix**
  - Increase the estimate (often ~2× DB size worst-case), or make it configurable and document the requirement.

---


## Key findings (technical / tricky)

### 1) Validator recompiles schema on every call (can be slow + can leak memory via Ajv schema cache)
**Severity:** Medium → High (depends on call frequency)  
**Where:** `validateConfig()` lines **72–79**

- `validateConfig()` does:
  - `structuredClone(schema)` (line 73)
  - `ajv.compile(normalizedSchema)` (line 75) **every call**
- If `validateConfig()` is called repeatedly (e.g., in a long-running server process, or per-request), this is unnecessary work and can become a latency hotspot.
- Depending on Ajv internals and `$id` usage, repeatedly compiling “equivalent” schemas can also grow internal caches over time (more likely if schemas differ or are dynamically generated).

**Recommendation**
- Cache compiled validators keyed by schema identity or stable hash:
  - simplest: `WeakMap<object, ValidateFunction>`
  - stronger: compute a stable signature for schema content (only if schema objects are not referentially stable).
- For the canonical config schema (`docs/config/schema.json`), compile once at startup and reuse.

---

### 2) `ensureRequiredProperties()` silently “fixes” unsatisfiable schemas by injecting `{}` property schemas (can hide schema bugs and weaken validation)
**Severity:** Medium  
**Where:** `ensureRequiredProperties()` lines **17–31**

When `additionalProperties === false` and `required` contains keys missing from `properties`, the schema is unsatisfiable in vanilla JSON Schema. The code “repairs” that by creating `schema.properties[key] = {}`.

That makes the schema satisfiable, but it also means:
- the missing property gets an **“always true”** schema (`{}`) → it accepts any value type/shape
- typos or omissions in the schema (e.g., forgetting to specify `port: {type:"number"}`) are no longer caught early; they become permissive instead of failing fast.

**Recommendation**
- Consider tightening the behavior:
  1. Add a **warning** path (dev log) when you have to inject `{}` due to an underspecified schema.
  2. Prefer injecting a **conservative schema** if possible, or require schema authors to define the property explicitly (and remove this workaround once schemas are cleaned up).
  3. At minimum, guard with an opt-in flag for “lenient schema repair”.

---

### 3) Prototype pollution / object-shape corruption risk via required keys like `__proto__`
**Severity:** Low in current usage, but **High** if schema becomes user-controlled  
**Where:** `ensureRequiredProperties()` lines **27–30**

If `schema.required` contains strings such as `__proto__`, `constructor`, or `prototype`, this line:

```js
schema.properties[key] = {};
```

can mutate the prototype of `schema.properties` (because `__proto__` is a special setter on plain objects), leading to hard-to-debug behavior and possible security issues.

Even if your current schemas are trusted, this is the kind of “lurking” issue that bites later when schemas become extensible (plugins/extensions/custom schemas).

**Recommendation**
- When copying required keys into `properties`, explicitly block or sanitize:
  - `__proto__`, `prototype`, `constructor`
- Safer approach: build `properties` as an object with a null prototype:
  - `schema.properties = Object.create(null)`
  - (and similarly for other maps if you want a consistent hardening posture)

---

### 4) No cycle detection in schema traversal (possible infinite recursion on cyclic schema graphs)
**Severity:** Low (most JSON schemas are acyclic), but tricky if schemas are programmatically composed  
**Where:** `ensureRequiredProperties()` recursive traversal (lines **11–56**)

`ensureRequiredProperties()` assumes the schema is a tree. If the schema object graph contains cycles (possible in JS-built schemas), recursion can become infinite.

**Recommendation**
- Add a `WeakSet` of visited nodes:
  - early return when already visited.

---

### 5) Validation strictness is intentionally lowered (`strict:false`) and formats aren’t registered
**Severity:** Medium (validation strength / correctness)  
**Where:** Ajv initialization lines **3–7**

- `strict:false` means Ajv will not enforce many schema correctness checks and may ignore unknown keywords; schema typos can slip through.
- No format plugin (`ajv-formats`) is registered. If schemas use `"format"` in the future, behavior may be “unknown format ignored” under non-strict modes.

**Recommendation**
- Prefer `strict: true` in dev/test (or at least CI) so schema mistakes are caught early.
- If you ever introduce `format` usage, explicitly register formats via `ajv-formats`.

---

## Small cleanup / maintainability nits

### 6) Redundant `schema.items` traversal
**Severity:** Low  
**Where:** lines **47–48**

Line 47 already handles arrays (`ensureRequiredProperties()` handles arrays at the top), so line 48 is redundant.

---

## Suggested “hard to find” regression tests

1. **Ajv compile caching**: call `validateConfig(sameSchema, config)` in a tight loop and ensure compile count doesn’t grow once caching is added.
2. **Schema repair warning**: schema with `additionalProperties:false` + `required:["port"]` but missing `properties.port` should emit a warning (or fail, depending on desired policy).
3. **Prototype pollution hardening**: schema with `required:["__proto__"]` should not mutate prototypes or crash; validate should behave deterministically.
4. **Cycle detection**: construct a cyclic schema object in JS and ensure `validateConfig()` doesn’t hang.

---

## Proposed patch sketch (non-binding)

- Add:

```js
const validatorCache = new WeakMap();
```

- In `validateConfig()`:

```js
let validate = validatorCache.get(schema);
if (!validate) {
  const normalizedSchema = structuredClone(schema);
  ensureRequiredProperties(normalizedSchema);
  validate = ajv.compile(normalizedSchema);
  validatorCache.set(schema, validate);
}
```

- In `ensureRequiredProperties()`:
  - add `visited` (`WeakSet`)
  - sanitize required keys and/or use `Object.create(null)` for maps

---

## Findings (prioritized)

### I1) LSP client shutdown timer can kill a *new* LSP process (cross-generation kill)
- **Severity:** High (correctness, intermittent)
- **File:** `src/integrations/tooling/lsp/client.js` — `shutdownAndExit()` (~L292–303)
- **What’s happening:** `shutdownAndExit()` schedules `setTimeout(() => { if (proc) kill(); }, 2500)`.  
  If the client is reused and `start()` creates a new LSP process before the timeout fires, the timeout will call `kill()` on the **new** process (because it reads the current `proc` variable at firing time).
- **Why it’s hard to find:** Only manifests when callers reuse a client after shutdown or when teardown overlaps with reconnection/backoff flows.
- **Fix:** Capture the current process or generation when scheduling:
  - `const current = proc; setTimeout(() => { if (proc === current) kill(); }, 2500)`
  - or capture `childGen` and check it’s unchanged.

### I2) LSP stderr handler ignores generation checks (noise + potential confusion during restarts)
- **Severity:** Low–Medium
- **File:** `src/integrations/tooling/lsp/client.js` — stderr handler (~L213–216)
- **What’s happening:** Unlike stdout handlers, stderr logging has no `(proc !== child || childGen !== generation)` guard. After restarts, logs from an old process can appear “current”.
- **Fix:** Add the same guard used elsewhere.

### I3) LSP VFS write path can escape the VFS root if `virtualPath` is absolute
- **Severity:** High (security / correctness hardening)
- **File:** `src/integrations/tooling/providers/lsp.js` — `ensureVirtualFile()` (~L87–91)
- **What’s happening:** `ensureVirtualFile()` writes to disk using `resolveVfsDiskPath({ baseDir, virtualPath })`.  
  If a caller supplies a document with `virtualPath` that begins with `/` (POSIX absolute), the derived “relative” path can become absolute and `path.join(baseDir, absolute)` will ignore `baseDir` → writing outside the intended sandbox.
- **Why it’s tricky:** In normal flows, virtual paths are generated internally and are safe; this appears only if documents are accepted from external callers.
- **Fix (in integrations):** Validate `doc.virtualPath` before writing:
  - reject if `path.isAbsolute(doc.virtualPath)` or it starts with `/` / `\\`
  - optionally also reject `..` segments even if later-encoded.

### I4) LSP position conversion doesn’t clamp negative values
- **Severity:** Low–Medium (hardening)
- **File:** `src/integrations/tooling/lsp/positions.js` — `positionToOffset()` (~L9–16)
- **What’s happening:** `col = Number(position.character) || 0` preserves negative values (because `-1 || 0` yields `-1`).
- **Impact:** If a server ever emits a negative `character`/`line` (buggy server / malformed diagnostics), offsets can go negative and break range matching.
- **Fix:** Clamp: `Math.max(0, Number(position.character) || 0)` and `Math.max(0, Number(position.line) || 0)`.

---

### I5) MCP error formatting mislabels non-numeric `error.code` as an “exitCode”
- **Severity:** Medium (client compatibility)
- **File:** `src/integrations/mcp/protocol.js` — `formatToolError()` (~L102–116), especially (~L108–110)
- **What’s happening:** If `error.code` exists but is not a known MCP error code, it is emitted as `payload.exitCode = error.code`.  
  For many Node/system errors, `error.code` is a **string** like `"ENOENT"` or `"EACCES"`, not a numeric exit code.
- **Impact:** Clients expecting `exitCode:number` may mis-handle failures.
- **Fix:** Emit separate fields:
  - `nativeCode` for string codes (`ENOENT`, etc.)
  - `exitCode` only when it’s a finite integer.

### I6) MCP remediation hint builder can do large lowercasing/joins of stdout+stderr
- **Severity:** Medium (performance/memory)
- **File:** `src/integrations/mcp/protocol.js` — `getRemediationHint()` (~L60–92)
- **What’s happening:** Concatenates `message`, `stderr`, and `stdout`, then lowercases the entire result. If stdout/stderr are large, this is expensive and memory-hungry.
- **Fix:** Truncate inputs before joining/lowercasing (e.g., first 8–32KB of each), or scan in a streaming/capped way.

---

### I7) `updateEnrichmentState()` is non-atomic, racy, and swallows all IO errors
- **Severity:** Medium (reliability)
- **File:** `src/integrations/core/enrichment-state.js` (~L6–21)
- **What’s happening:**
  - read/parse errors are ignored → state silently resets to `{}`.
  - updates are read-modify-write without a lock → concurrent writers lose fields.
  - writes are not atomic → partial/corrupted JSON possible on crash/interruption.
  - write errors are swallowed → callers assume state updated when it may not be.
- **Fix:** Use an atomic write (temp + rename) and a lock (or a single-writer discipline). At least log errors.

### I8) Records indexing uses `startsWith()` for directory containment checks (prefix bug)
- **Severity:** Medium (correctness hardening)
- **File:** `src/integrations/triage/index-records.js` (~L85–88)
- **What’s happening:** `absPath.startsWith(recordsDir)` is used to decide whether a record is under the triage directory.
- **Why it’s tricky:** String prefixes can misclassify paths (e.g., `/repo/triage` vs `/repo/triage-old`).
- **Fix:** Use `path.relative(recordsDir, absPath)` and validate it doesn’t start with `..` and isn’t absolute (pattern used elsewhere in the codebase).

### I9) Triage `ensureRecordId()` fallback can be huge and can throw
- **Severity:** Medium (robustness)
- **File:** `src/integrations/triage/normalize/helpers.js` (~L98–107), especially (~L101–104)
- **What’s happening:** If no stable key exists, it uses `JSON.stringify(raw)` as the “key” input.
- **Impact:**
  - Very large payloads → large allocations and slow hashing.
  - Cyclic structures → `JSON.stringify` throws.
- **Fix:** Use a capped stable stringify/hashing approach:
  - stable stringify with key ordering + size cap, or
  - hash a selected stable subset of fields, or
  - compute a content hash of the input file/record id.

### I10) Generic triage normalizer can undo routing meta and produce non-ISO timestamps
- **Severity:** Medium (data integrity)
- **File:** `src/integrations/triage/normalize/generic.js` (~L17–83), especially `Object.assign(record, raw)` (~L33)
- **What’s happening:**
  - `buildBaseRecord()` applies meta routing and default timestamps, then `Object.assign(record, raw)` allows the incoming payload to overwrite `service/env/team/owner/repo`, timestamps, `source`, etc.
  - `createdAt` / `updatedAt` are accepted as-is (not normalized to ISO), which can fail downstream schema expectations.
- **Fix:** Merge in the opposite direction (raw into a sanitized scaffold) or whitelist the fields that raw is allowed to override. Normalize timestamps via `toIso()`.

---

### I11) Tooling CLIs frequently compute `buildIndexSignature()` (can be very slow on large sharded indexes)
- **Severity:** Medium–High (performance)
- **Files:** `src/integrations/tooling/*` (api-contracts, architecture-check, context-pack, graph-context, impact, suggest-tests)
- **What’s happening:** These commands call `buildIndexSignature(indexDir)` even though they also read `compatibilityKey`.  
  In this repo, signature building is implemented as lots of synchronous directory listing + `stat` calls across shard files (see earlier findings).
- **Impact:** “Tooling” commands can become unexpectedly slow on large repos/indexes.
- **Fix:** Prefer the compatibility key/build id for provenance, or cache signatures, or avoid sharded-per-file stats.

### I12) Some `run*Cli()` functions call `process.exit()` internally
- **Severity:** Low–Medium (reusability/testing)
- **Files:** `context-pack.js`, `graph-context.js`, `impact.js`, `suggest-tests.js` (and to a lesser extent the others)
- **What’s happening:** Errors inside the exported `run*Cli()` functions terminate the process directly.
- **Impact:** Harder to import and test these as library functions.
- **Fix:** Return `{ok:false,...}` or throw and let the “bin” wrapper decide the exit code.

### I13) `status()` size computation is purely recursive and sequential
- **Severity:** Medium (performance on large caches)
- **File:** `src/integrations/core/status.js` — `sizeOfPath()` (~L17–33)
- **Impact:** Large cache roots → very slow status calls; also recursion depth could become a problem on pathological trees.
- **Fix:** Use iterative traversal (stack/queue) and/or bounded concurrency; consider sampling or skipping known-large trees unless requested.

### I14) Embeddings line parsing uses string concatenation on Buffer chunks (UTF-8 boundary edge case)
- **Severity:** Low–Medium (edge correctness)
- **File:** `src/integrations/core/embeddings.js` — `createLineEmitter.handleChunk()` (~L11–16)
- **What’s happening:** `buffer += chunk` coerces Buffers to strings; if multibyte UTF-8 characters are split across chunks, you can get replacement characters or corrupted lines.
- **Fix:** Use `StringDecoder('utf8')` from `node:string_decoder` to decode chunk boundaries safely.

### I15) Compatibility computation copies the entire runtime object per mode
- **Severity:** Low (perf/clarity)
- **File:** `src/integrations/core/build-index/compatibility.js` (~L6–18)
- **What’s happening:** `const runtimeSnapshot = { ...runtime, dictConfig: adaptedDictConfig }` for each mode.  
  If runtime carries large structures, this is extra overhead and can make debugging confusing.
- **Fix:** Pass only the minimal config subset needed by `buildTokenizationKey()`.

---

## Findings (bugs, reliability hazards, performance traps)

### 1) **Non-zero exit codes are treated as “OK” whenever `stdout` is non-empty** (can silently accept corrupted / partial output)
**Severity:** High (silent correctness failures)  
**File:** `src/experimental/structural/runner.js`  
**Where:** lines **22–25**, **40–43**, **67–70**

Pattern:

```js
if (result.status !== 0 && !result.stdout) throw ...
return parseX(result.stdout || '', ...)
```

**Why this is tricky**
- Many tools write *something* to stdout even on partial failure (or write “best effort” output and then exit non-zero).
- The current logic treats **any** non-empty `stdout` as a green light, even if the exit code indicates an error.
- Result: you can ingest incomplete data, miss matches, or misreport findings while losing the real error signal.

**Recommendation**
- Treat exit codes explicitly per engine:
  - **semgrep**: exit code 1 often means “findings found”; codes ≥2 are typically errors (exact semantics depend on semgrep version).
  - **ast-grep / comby**: decide what exit codes mean “findings vs error”; do not assume non-empty stdout implies success.
- At minimum: if `status !== 0`, still surface stderr (and optionally attach parsed results as “partial”).

---

### 2) **Windows `shell: true` for `.cmd/.bat` can introduce quoting / parsing edge cases** (esp. paths with spaces, special characters)
**Severity:** Medium (platform-specific correctness, hard to reproduce)  
**File:** `src/experimental/structural/binaries.js`  
**Where:** lines **8–13**, esp. **11–12**

```js
const useShell = isWindows && /\.(cmd|bat)$/i.test(command);
spawnSync(command, args, { shell: useShell })
```

**What can go wrong**
- When `shell:true`, Node routes execution through `cmd.exe` and must stringify/quote the command+args.
- Edge cases can appear with:
  - paths containing `&`, `^`, `|`, parentheses, `!` (delayed expansion),
  - odd quoting when args include JSON or regex-like strings,
  - command path resolution differences vs non-shell execution.

**Recommendation**
- Prefer executing `.cmd/.bat` via `cmd.exe /d /s /c` with carefully controlled quoting *or* avoid shell execution by resolving to an `.exe` where possible.
- If you keep `shell:true`, add regression tests for:
  - rule paths with spaces,
  - repo roots with parentheses,
  - patterns containing `&` or `|`.

---

### 3) **Resolver cache can become stale if PATH changes** (surprising behavior in long-running sessions)
**Severity:** Low–Medium  
**File:** `src/experimental/structural/binaries.js`  
**Where:** line **6** (global `binaryCache`), usage at **59**

- `resolveBinary(engine)` memoizes the resolution forever for the process lifetime.
- If a user installs `semgrep`/`sg` after the process starts (or PATH is modified), the resolver can remain stuck pointing to “missing” or an old path.

**Recommendation**
- Either:
  - include `process.env.PATH` (or a hash of it) in the cache key, or
  - allow an explicit “refresh” option.

---

### 4) **JSON-lines parsing silently drops bad lines and can drop valid falsy JSON values**
**Severity:** Medium (silent data loss)  
**File:** `src/experimental/structural/parsers.js`  
**Where:** `parseJsonLines()` lines **4–15**

Issues:
- Parse errors return `null` and are then filtered out with `.filter(Boolean)` → parse failures are *silent*.
- `.filter(Boolean)` also drops valid JSON values like `0`, `false`, and `""` (less likely here, but it’s a lurking footgun).

**Why this is tricky**
- If tool output changes format, includes prelude logs, or prints a single malformed line, you can end up with “empty results” and no error.

**Recommendation**
- Track parse failures:
  - return `{items, parseErrors}` and decide policy (warn/fail-fast).
- Use a filter that only removes `null/undefined` rather than Boolean coercion:
  - e.g., `.filter((x) => x != null)`.

---

### 5) **`parseAstGrep()` format assumptions are brittle** (likely to misparse some valid output shapes)
**Severity:** Medium (silent missed matches)  
**File:** `src/experimental/structural/parsers.js`  
**Where:** `parseAstGrep()` lines **61–97**

- It assumes entries look like `{ matches: [...] }`.
- If `sg scan --json` emits JSON Lines of *match objects* (or a different schema version), the loop will see `entry.matches` as undefined and produce no results (silently).

**Recommendation**
- Detect and normalize multiple possible output shapes:
  - array of `{matches:[...]}`,
  - JSONL of `{range, text, ...}` matches,
  - single object with `{matches:[...]}`.
- Fail loudly if output parses but doesn’t match expected schema (optional strict mode).

---

### 6) **`readCombyRule()` has no validation and uses permissive defaults** (can lead to “do nothing” searches)
**Severity:** Low–Medium (correctness)  
**File:** `src/experimental/structural/parsers.js`  
**Where:** lines **129–137**

- Missing / invalid rule fields are defaulted:
  - `language: '.'`, `pattern: ''`
- That can yield confusing behavior:
  - empty pattern, broad matcher, or tool errors depending on comby semantics.

**Recommendation**
- Validate required fields:
  - require `pattern` non-empty,
  - require `language` to be a known matcher,
  - surface a clear error pointing to the rule file.

---

### 7) **`writeJsonl()` builds a full in-memory string and writes synchronously** (scales poorly on large outputs)
**Severity:** Low–Medium (performance/memory)  
**File:** `src/experimental/structural/io.js`  
**Where:** lines **4–11**

- `items.map(JSON.stringify).join('\n')` builds one big string.
- `fs.writeFileSync()` blocks the event loop.
- For large result sets, this can be a noticeable memory spike.

**Recommendation**
- Stream JSONL output:
  - write line-by-line to a write stream
  - handle backpressure
- If remaining synchronous, at least document that it’s intended for small result sets.

---

### 8) Minor CLI-arg edge cases in model comparison helper
**Severity:** Low  
**File:** `src/experimental/compare/config.js`  
**Where:** lines **23–28**, **52–56**

- `resolveCompareModels()` dedupes but does not `trim()` config-provided entries (only CLI list gets trim) → `["gpt-4", " gpt-4"]` can survive as distinct until later.
- `resolveAnnSetting()` only detects `--ann` / `--no-ann` *as exact tokens* (raw string match). Variants like `--ann=false` or `--no-ann=true` could be misclassified depending on the arg parser used upstream.

**Recommendation**
- Normalize config model IDs with `.trim()`.
- Detect arg presence in a parser-aware way, or expand detection to include `--ann=` patterns if needed.

---

## “Hard-to-find” regression tests worth adding (if this graduates from experimental)

1. **Non-zero exit + stdout**: simulate a tool that prints partial JSON then exits 2; ensure you don’t silently accept results without reporting error.
2. **Windows quoting**: run with repo root containing parentheses + rules path containing spaces; ensure the invoked command sees correct argv.
3. **ast-grep schema variants**: feed JSONL match objects and array-of-results formats; ensure parser returns expected normalized results.
4. **JSONL parse error visibility**: include one malformed JSONL line; ensure you surface the parse error count and/or fail-fast in strict mode.
5. **Large output streaming**: 100k results JSONL should not allocate a single huge string or block for long.

---

## Patch sketches (non-binding)

- Make exit-code handling explicit per engine in `runner.js`, e.g.:

```js
const assertOk = ({ engine, status, stdout, stderr }) => {
  if (engine === 'semgrep') {
    if (status === 0 || status === 1) return; // (example semantics)
    throw new Error(stderr || `semgrep failed (status ${status})`);
  }
  if (status !== 0) throw new Error(stderr || `${engine} failed (status ${status})`);
};
```

- Improve `parseJsonLines()`:

```js
const parseJsonLines = (text) => {
  const items = [];
  const errors = [];
  for (const [i, raw] of text.split(/\r?\n/).entries()) {
    const line = raw.trim();
    if (!line) continue;
    try { items.push(JSON.parse(line)); }
    catch (e) { errors.push({ line: i + 1, error: String(e) }); }
  }
  return { items, errors };
};
```

- Switch `writeJsonl()` to streaming for large result sets.

---

### 1) **Prototype pollution / global object corruption** via plain-object “maps” keyed by code identifiers

**Severity:** Critical  
**Location:** `src/lang/javascript/relations.js` (around L240–L320)

This file uses plain objects as dictionaries keyed by *identifier names from parsed code*:

- `const functionMeta = {};`
- `const classMeta = {};`
- later: `const existing = functionMeta[name]; if (!existing) ... else ...`

This is extremely dangerous in JavaScript because names like `__proto__`, `constructor`, `toString`, etc. have special meaning on objects with `Object.prototype` in their prototype chain.

#### Why this is a real exploit path (not theoretical)

If a repo being indexed contains a function named `__proto__` (valid identifier):

```js
function __proto__() {}
```
Then:

- `functionMeta["__proto__"]` **does not return** a stored entry.
- It returns `Object.prototype` (because `__proto__` is an accessor).
- `existing` becomes `Object.prototype`, which is truthy.
- The `else` branch mutates `existing.*` → **mutates `Object.prototype` globally**.

That means a single adversarial identifier can:

- corrupt global prototypes (`Object.prototype.params`, etc.),
- create unpredictable behavior across the entire process,
- potentially become a security primitive depending on downstream assumptions.

This is a classic “hard-to-find” bug because normal repos rarely define `__proto__`-named functions/classes.

**Suggestion (strong)**
- Replace these dictionaries with `Map`, **or** with `Object.create(null)` and strict own-property checks.
- In particular: never use `if (!existing)` on dictionary lookups; always use an own-key check.

**Example patch shape**
- `const functionMeta = new Map();`
- `if (!functionMeta.has(name)) functionMeta.set(name, {...}); else { merge... }`

Or:

- `const functionMeta = Object.create(null);`
- `if (!Object.prototype.hasOwnProperty.call(functionMeta, name)) { ... }`

---

### 2) Generic AST traversal walks `tokens` (and other heavy fields) → big avoidable CPU cost

**Severity:** Medium (perf)  
**Locations:**
- `src/lang/javascript/imports.js` (around L45–L99)
- `src/lang/javascript/relations.js` (around L660–L820)
- `src/lang/typescript/relations.js` (generic AST walk)

These modules implement a generic recursive walker that iterates `Object.keys(node)` / `Object.values(node)` and recurses into every object/array field, only skipping `loc`, `start`, `end`.

When Babel parsing is configured to include tokens, the AST includes a large `tokens` array. The generic walkers will recursively traverse **every token object** even though token objects are irrelevant for import/call extraction.

This can become a large runtime tax:
- O(#tokens) additional traversal work per file
- extra allocations and GC pressure
- duplicates work in `relations.js`, which separately processes tokens later

**Suggestion**
- Explicitly skip well-known non-AST fields: `tokens`, `comments`, `leadingComments`, `trailingComments`, `extra`, etc.
- Or use a structured AST walker that only follows known AST child fields.
- Consider an iterative stack to avoid recursion overhead (see next finding).

---

### 3) Recursive AST walking risks call stack overflow on adversarially deep syntax

**Severity:** Medium (stability)  
**Locations:** same as Finding #2

The walkers are recursive. A deeply nested AST (intentional or accidental) can exceed the JS call stack and crash the indexing run.

This is rare in normal code, but it’s common in “fuzzer / adversarial repo” scenarios and can happen with:
- very deeply nested expressions / arrays / chained calls
- huge generated code blobs

**Suggestion**
- Rewrite walkers to iterative form (explicit stack).
- Or use a traversal library that is iterative.

---

### 4) TypeScript signature param parsing is regex-based and breaks on nested parentheses (function types, defaults)

**Severity:** Medium (correctness)  
**Location:** `src/lang/typescript/signature.js` (around L13–L16 and L33–L37)

These helpers extract params using:

- `signature.match(/\(([^)]*)\)/)`
- and split on commas

This fails when parameter types contain parentheses, e.g.:

```ts
foo(cb: (x: number) => string, y: string)
```

The regex stops at the first `)` (end of `(x: number)`), producing truncated parameter lists and wrong type extraction.

**Suggestion**
- Reuse the more robust delimiter-aware scanning approach used elsewhere (you already have complex parsing logic in `src/integrations/tooling/api-contracts.js`).
- Or implement a simple parenthesis-depth scanner here as well.

---

### 5) Tree-sitter async chunking treats “no chunks” as a worker failure → double parsing

**Severity:** Low–Medium (perf)  
**Location:** `src/lang/tree-sitter/chunking.js` (around L501–L513)

In `buildTreeSitterChunksAsync()`:

- If the worker returns an empty array (valid “no chunks” result), the code treats it as failure and falls back to main-thread parsing.

This can cause redundant work (parse twice) on files that legitimately have no chunkable declarations.

**Suggestion**
- Distinguish “failure” from “valid empty result”:
  - Worker returns `null` on failure, `[]` on success/no-chunks.
  - Accept `[]` as a valid result.
- Or return a `{ok:boolean, chunks:Array}` envelope.

---

### 6) Python executable discovery has no timeout → potential indefinite hang

**Severity:** Low–Medium (stability)  
**Location:** `src/lang/python/executable.js` (around L25–L73)

`checkPythonCandidate()` spawns a candidate python with `-c` and waits for it to exit, but does not enforce a timeout.

In most environments this is fine, but it becomes a risk if:
- a “python” candidate is actually a wrapper that blocks,
- environment hooks cause the process to hang.

**Suggestion**
- Add a timeout (e.g., 2–5 seconds) and kill the process if it doesn’t exit.

---

### 7) Python AST pool size guard can be bypassed by using `path` instead of inline `text`

**Severity:** Medium (perf/stability)  
**Location:** `src/lang/python/pool.js` (around L330–L356)

When `text` exceeds `maxTextBytes` **and** `path` is provided, the pool sets `text = null` and sends only `path` to the worker:

- This avoids transferring large text over stdin (good),
- but it means the *file size* is no longer bounded by `maxTextBytes`.
- A huge file at `path` can still be read and parsed by the worker, potentially crashing it or triggering repeated pool backoff.

**Suggestion**
- If `path` is used, add a file-size check (`fs.stat`) and enforce a maximum file size too.
- Optionally validate that `path` is inside the repo root / expected sandbox.

---


---

## Findings

### 1) Potential arbitrary file read / path traversal via `chunk.file`

**Severity:** High  
**Location:** `src/context-pack/assemble.js` (around L157–L160)

`buildPrimaryExcerpt()` constructs a filesystem path as:

- `filePath = path.resolve(repoRoot, chunk.file)`

There is **no explicit check** that `chunk.file` is:
- a safe repo-relative path, and
- still inside `repoRoot` after resolution.

If `chunkMeta` (or anything upstream producing `chunk.file`) is tampered with, a crafted value like `../../../../etc/passwd` (or an absolute path) will resolve outside the repo and the code will attempt to read it.

Even if your current pipeline “should never” produce such values, this is the kind of bug that appears later when:
- context-pack assembly is used with external indexes/caches,
- indexes are copied between machines,
- multi-tenant environments share caches.

**Suggestion**
- Enforce a containment check before reading:
  - Resolve the path
  - Ensure `path.relative(repoRoot, filePath)` does not start with `..` and is not absolute.
- Consider rejecting absolute `chunk.file` entirely.

---

### 2) Synchronous full-file reads even when only a bounded excerpt is needed

**Severity:** Medium (perf / memory)  
**Location:** `src/context-pack/assemble.js` (around L152–L173)

`buildPrimaryExcerpt()` does:

- `fs.readFileSync(filePath, 'utf8')`
- then conditionally truncates with `sliceExcerpt(excerpt, maxBytes, ...)`

For large files, this forces a **full read into memory** even if the final excerpt is capped to (say) 10–50KB.

**Suggestion**
- When `maxBytes` is set, consider:
  - reading only the needed region (range reads), or
  - reading a bounded prefix (streaming) and truncating early.

---

### 3) Byte truncation can cut a multibyte UTF-8 codepoint

**Severity:** Low (correctness)  
**Location:** `src/context-pack/assemble.js` (around L18–L33)

`sliceExcerpt()` truncates by bytes using:

- `Buffer.from(excerpt, 'utf8').subarray(0, maxBytes).toString('utf8')`

This can split a multi-byte character, producing the replacement character (�) at boundaries.

**Suggestion**
- If the output is user-visible or diffed, consider truncating on codepoint boundaries (or accept the replacement char as acceptable tradeoff).

---

### 4) Avoidable memory duplication when `maxBytes` is enabled

**Severity:** Low (perf)  
**Location:** `src/context-pack/assemble.js` (around L18–L33)

`Buffer.from(excerpt, 'utf8')` duplicates memory proportional to excerpt size.

In typical use this is fine, but in worst-case scenarios (many large chunks; high parallelism) it can increase peak RSS.

**Suggestion**
- Prefer early truncation strategies (see Finding #2), which naturally reduce or eliminate this duplication.

---

## Suggested hardening patch (shape)

- Validate `chunk.file` stays inside repoRoot before reading.
- If `maxBytes` is set, read only what you need.
- Treat chunkMeta/index artifacts as semi-trustworthy inputs (because caches can drift/tamper).

---


## Findings

### [HIGH] G-1 — BFS uses `Array.shift()` causing O(n²) traversal cost on large neighborhoods

**Location:** `src/graph/neighborhood.js:457`

The neighborhood builder performs a breadth-first exploration using an array as a queue.
It dequeues via `queue.shift()` (line 457), which is O(n) per pop because it must reindex the entire array.
For graphs/neighborhoods with many enqueued nodes, this turns the traversal into O(n²) behavior and can dominate runtime.

This is particularly tricky because everything else in the algorithm looks linear-ish, so performance regressions only show up on larger repos or higher `depth` values.

**Recommendation:**

Replace `shift()` with a queue index pointer (the project already uses this pattern elsewhere, e.g. `src/graph/suggest-tests.js` uses `queueIndex`).
Example pattern:
- Keep `let qi = 0;`
- Use `const current = queue[qi++];`
- Stop when `qi >= queue.length`.

This change is mechanically safe and typically yields large speedups for big traversals.

### [HIGH] G-2 — Unresolved symbol-reference candidate ordering can make edge de-duplication and ordering non-deterministic

**Location:** `src/graph/neighborhood.js:109-158`, `src/graph/ordering.js:53-64`

Edges are de-duplicated using an `edgeKey()` that ultimately depends on `edgeEndpointKey()`.
For symbol-edge endpoints that are *reference envelopes* (unresolved/ambiguous), `referenceEnvelopeKey()` uses:

- `envelope.resolved` if present, else
- the **first** element of `envelope.candidates` (ordering.js:53-64).

However, when building normalized symbol envelopes, `normalizeSymbolRef()` copies candidates but **does not sort or canonicalize them** (neighborhood.js:109-158).

If upstream generation of candidates is not strictly deterministic (or changes between versions), the “first candidate” can vary even when the underlying set is the same.
That makes edge keys (and therefore edge de-duplication, ordering, and even path/witness outputs) **unstable across runs**.

Symptoms you may see:
- duplicate edges appearing/disappearing across builds
- unstable ordering of edges/nodes for the same inputs
- confusing diffs in generated reports/artifacts

**Recommendation:**

Canonicalize unresolved envelopes before they participate in edge keys:
- Sort `candidates` deterministically (e.g., by a stable key such as `symbolId|chunkUid|path`).
- Or, when unresolved, have `referenceEnvelopeKey()` hash **all** candidate keys (stable sorted) rather than using only the first.

If you want to preserve ranking semantics, you can keep the original candidate order for UX, but compute a separate canonical key used only for identity/dedup.

### [MEDIUM] G-3 — Import-graph expansion can silently fail due to inconsistent file-path normalization

**Location:** `src/graph/neighborhood.js:67-75`, `src/graph/neighborhood.js:447-452`

The import graph is indexed by raw `node.id` strings (`buildGraphIndex`, neighborhood.js:67-75).
When the traversal is currently on a chunk node, it attempts to join into the import graph via:

- `resolveImportSourceId(ref)` → `chunkInfo.get(ref.chunkUid)?.file` (neighborhood.js:447-452).

If `chunkInfo.file` is in a different format than `importGraph.node.id` (e.g., Windows `\` vs POSIX `/`, absolute vs relative, or different casing), `resolveGraphNeighbors()` will return no neighbors and the import expansion just… stops (no warning).

This is a classic “looks fine, but some repos have mysteriously empty import neighborhoods” type of bug.

**Recommendation:**

Normalize file paths consistently before indexing and before lookup:
- Apply a shared normalization function (at minimum: `toPosix()`, trim leading `./`).
- Ideally allow `buildGraphNeighborhood()` to accept `repoRoot` and normalize to repo-relative paths (like other parts of the codebase do).
- Consider emitting a warning if an importGraph lookup is attempted and the resolved ID is not found in the importGraph index.

### [MEDIUM] G-4 — `GraphStore.loadOnce()` caches rejected promises, preventing retries after transient failures

**Location:** `src/graph/store.js:35-41`

`loadOnce()` memoizes the promise returned by the loader and stores it in `artifactCache`.
If the loader rejects (e.g., transient read error, partial file, momentary FS hiccup), the rejected promise stays cached and every subsequent call returns the same rejection.

This is subtle because it only matters when failures are transient or recoverable (e.g., CI artifact restore races).

**Recommendation:**

Evict cache entries on rejection to allow retry:

```js
const promise = Promise.resolve().then(loader).catch(err => {
  artifactCache.delete(name);
  throw err;
});
```

If you *do* want sticky failures, consider recording the error explicitly and surfacing it via `getArtifactsUsed()` or a diagnostic API.

### [MEDIUM] M-1 — `scope=dir` filter uses `startsWith()` without a directory boundary check

**Location:** `src/map/build-map/filters.js:104-115`

Directory scoping uses:

- `node.path.startsWith(normalizedFocus)` (filters.js:106).

If the user passes `focus="src"` (no trailing slash), this will also match paths like `src-old/...` or `src2/...`.
That yields confusing “why did this file show up?” results and makes scoped maps unreliable in monorepos with similarly-prefixed directories.

**Recommendation:**

Use a boundary-aware check:
- `node.path === normalizedFocus || node.path.startsWith(normalizedFocus + '/')`

You can also normalize `focus` by stripping any trailing slashes and then applying the boundary check above.

### [MEDIUM] M-2 — Potential symbol ID collisions for same-name symbols in the same file, plus “first metadata wins” merge semantics

**Location:** `src/map/build-map/symbols.js:6-18`, `src/map/build-map/symbols.js:54-69`

When `symbolId` and `chunkUid` are absent, `buildSymbolId()` falls back to `${file}::${name}` (symbols.js:6-18).
If multiple symbols share the same name in the same file (common with overloads, re-exports, or certain languages), this can collide.

Additionally, `upsertMember()` only overwrites fields when the existing member is missing that field (symbols.js:54-69).
If a low-fidelity source (e.g., legacy repo_map) creates a member first, then a higher-fidelity source (e.g., chunk_meta v2) arrives later, the better metadata may be ignored forever.

These are ‘soft correctness’ problems that are hard to notice unless you compare the map output against ground truth.

**Recommendation:**

Collision mitigation options:
- Incorporate range (startLine/endLine) into the fallback ID when available.
- Or incorporate `kind` + startLine even when `name` is present (if uniqueness is more important than readability).

Merge precedence options:
- Track a `source` / `confidence` field and allow later higher-priority sources to overwrite.
- Or add a `prefer` flag when calling `upsertMember` from chunk_meta vs repo_map.

### [MEDIUM] M-3 — `buildImportEdges()` does not normalize paths, risking missing/misaligned import edges on Windows or mixed formats

**Location:** `src/map/build-map/edges.js:190-209`

`buildImportEdges()` uses `entry.file` and `target` verbatim when creating edges (edges.js:193-206).
Elsewhere in map building, file paths are normalized (POSIX slashes) via `normalizePath()`.

If `file_relations` ever contains Windows-style separators or absolute paths, the import edges may not match the normalized file nodes and will be filtered out later (or render as dangling).

**Recommendation:**

Normalize both endpoints:
- `const from = normalizePath(entry.file);`
- `const to = normalizePath(target);`

Also normalize before applying `fileSet` checks, otherwise the filter will behave inconsistently.

### [MEDIUM] M-4 — HTML export injects raw SVG without sanitization (XSS risk if SVG is untrusted)

**Location:** `src/map/html-writer.js:42`

`renderSvgHtml()` inserts `${svg || ''}` directly into the HTML output (html-writer.js:42).
If the SVG content is ever derived from untrusted input (or if a malicious repo can influence the SVG), this can allow script execution when the HTML file is opened.

This is easy to miss because other strings are escaped via `escapeHtml()`.

**Recommendation:**

If the SVG is always generated locally and never from untrusted sources, document that assumption clearly.
Otherwise consider:
- Sanitizing SVG (remove `<script>`, event handlers, foreignObject, etc.).
- Or embedding the SVG as an `<img src="data:image/svg+xml;base64,...">` so it isn’t executed as DOM (still has caveats).
- Or serving it in a sandboxed iframe.

### [MEDIUM] M-5 — Isometric viewer can navigate to arbitrary URIs via template; includes an unencoded `{fileRaw}` placeholder

**Location:** `src/map/isometric/client/selection.js:567-597`

`buildOpenUri()` builds a URL from `state.config.openUriTemplate` and then navigates via `window.location.href` (selection.js:592-597).
It provides both an encoded `{file}` and an unencoded `{fileRaw}` replacement (selection.js:580-588).

If the template uses `{fileRaw}` and the underlying file path contains unexpected characters, it can produce malformed URIs or enable injection-like behavior depending on the consumer.

This may be acceptable for a trusted, local-only viewer, but it’s a sharp edge if the viewer is ever hosted/shared.

**Recommendation:**

Prefer an all-encoded template surface:
- Deprecate or remove `{fileRaw}` (or encode it as well).
- Consider whitelisting allowed URI schemes (e.g., `vscode://`, `file://`) before navigation.
- Alternatively, open in a new tab with `noopener` to reduce risk when navigating off-site.

### [LOW] G-5 — `createWorkBudget().consume()` accepts negative/float units, allowing limit bypass if misused

**Location:** `src/graph/work-budget.js:33-37`

`consume()` uses `Number.isFinite(units) ? units : 1` and then adds it to `used` (work-budget.js:35-37).
If any caller ever passes a negative value, `used` decreases and caps can be bypassed.

Today, callers appear to pass `1`, so this is mainly a future-proofing correctness guard.

**Recommendation:**

Clamp `units` to a positive integer:
- `const increment = Math.max(1, Math.floor(Number(units) || 1));`
Or if you really want fractional work units, at least enforce `increment > 0`.

### [LOW] G-6 — Edge case: path normalization can retain absolute paths when `path.relative()` returns an empty string

**Location:** `src/graph/architecture.js:12-25`

In `normalizePath()`, the code checks `if (rel && !rel.startsWith('..') ...)` (architecture.js:18).
If `raw === repoRoot`, `path.relative(repoRoot, raw)` returns `''` (empty string), which is falsy, so the absolute path is retained.

This is a niche edge case (likely only triggered if a rule/event incorrectly provides the repo root itself as a “file path”), but it can cause absolute-path leakage into reports.

**Recommendation:**

Treat `rel === ''` as `'.'` or explicitly handle this case:
- `const rel = path.relative(repoRoot, raw) || '.';`
Then strip `./` as you already do.

### [LOW] G-7 — Test discovery uses synchronous FS traversal without per-directory error handling

**Location:** `src/graph/suggest-tests.js:99-133`

`discoverCandidateTests()` walks the repo using `fs.readdirSync()` (line 109).
Two implications:

- **Robustness:** if it encounters a directory it cannot read (permissions, transient IO errors), it will throw and abort the entire suggestion run.
- **Performance:** synchronous recursive walks can be slow on huge repos or networked filesystems, and this is done before the rest of the test-suggestion logic.

**Recommendation:**

Wrap the `readdirSync()` call in a try/catch and skip unreadable directories.
Optionally add an async version or allow callers to provide a precomputed file list.

### [LOW] M-6 — Viewer loads modules via dynamic `import()` from configurable URLs (supply-chain / XSS footgun if config is untrusted)

**Location:** `src/map/isometric/client/three-loader.js:58-89`

`loadThreeModules(threeUrl)` does `await import(threeUrl)` (three-loader.js:58-60).
`loadRgbeLoader(url)` similarly imports from `url` if provided (three-loader.js:77-85).

If these URLs can be influenced by an untrusted party, this is equivalent to arbitrary script execution in the viewer context.
In a local developer tool this may be fine; in a hosted scenario, it’s dangerous.

**Recommendation:**

If the viewer is meant to be local-only, document that clearly.
If it can be hosted, restrict imports to a safe allowlist (or bundle dependencies rather than importing arbitrary URLs).

### [LOW] M-7 — Isometric layout ordering is O(n²) and may stall for very large file counts

**Location:** `src/map/isometric/client/layout-utils.js:149-190`

`orderByAdjacency()` selects the next item by scoring every remaining item against all already-placed items.
That is inherently O(n²) (and can approach O(n³) if adjacency scoring is dense).

This is acceptable for small/medium maps, but for maps near the default max files (200) it can become noticeable in the browser.

**Recommendation:**

If large interactive maps are a goal:
- Add a fast-path: skip adjacency ordering past a threshold.
- Or use a heuristic that doesn’t rescore against all placed items (e.g., greedy from the last placed, or a limited-window scoring).

---

# PERFPLAN

A focused performance plan to audit and optimize index build stages, improve search CLI startup time, harden VFS performance, reduce tree-sitter WASM churn, optimize retrieval/graph/map pipelines, strengthen shared IO/serialization, and implement a compressed global embeddings cache. This follows the repo roadmap format: objective, goals, non-goals, files, docs/specs, tasks, tests, acceptance.

---

## Status legend
- [x] Implemented and appears complete/correct based on code inspection and existing test coverage
- [@] In Progress, this work has been started
- [.] Work has been completed but has Not been tested
- [?] There is a correctness gap **or** there is missing/insufficient test proving behavior
- [ ] Not complete

---

## Phase 0 — Shared Component Audit + Dedupe (Foundations)

### Objective
Perform a cross-codebase audit for duplicate utility implementations, consolidate them into shared modules, and add tests so later phases rely on one canonical implementation.

### Goals
- Identify duplicate helpers (provenance resolution, truncation recording, limit normalization, etc.).
- Promote shared implementations and update all callers.
- Add tests that lock shared behavior and prevent regression.

### Non-goals
- Algorithmic changes to graph/retrieval/indexing behavior.
- New features or schema changes.

### Files to modify (exhaustive for this phase)
- `src/shared/provenance.js` (new)
- `src/shared/truncation.js` (new)
- `src/shared/limits.js` (new)
- `src/graph/impact.js`
- `src/graph/suggest-tests.js`
- `src/graph/architecture.js`
- `src/graph/context-pack.js`
- `src/context-pack/assemble.js`
- `src/integrations/tooling/api-contracts.js`
- `src/retrieval/context-expansion.js`
- `tools/perf/scan-duplicate-utilities.js` (new)
- `docs/perf/shared-component-audit.md` (new)
- `docs/guides/shared-components.md` (new)
- `tests/shared/provenance.test.js` (new)
- `tests/shared/truncation.test.js` (new)
- `tests/shared/limits-normalization.test.js` (new)
- `tests/perf/shared-component-audit.test.js` (new)

### Docs/specs to add or update
- `docs/perf/shared-component-audit.md` (new)
- `docs/guides/shared-components.md` (new)

### Tasks
- [x] Inventory duplicate helper patterns across graph/context-pack/retrieval tooling.
- [x] Implement shared helpers for provenance resolution, truncation recording, and limit normalization.
- [x] Update all call sites to use shared helpers.
- [x] Document shared component expectations and examples.

### Acceptance
- [x] Duplicate helper implementations removed and replaced by shared modules.

---

## Phase 1 — Stage Audit Instrumentation + Report

### Objective
Add consistent timing/memory checkpoints across the 4 indexing stages to identify memory hotspots and slow paths, then produce an audit report with prioritized optimization candidates.

### Goals
- Produce per-stage memory/timing checkpoints (heap, rss, external, arrayBuffers).
- Surface a repeatable audit report per mode and per stage.

### Non-goals
- Implementing stage optimizations.
- Changing artifact schemas or query behavior.

### Files to modify (exhaustive for this phase)
- `src/index/build/indexer/pipeline.js`
- `src/index/build/perf-profile.js`
- `src/index/build/build-state.js`
- `src/index/build/state.js`
- `src/index/build/stage-checkpoints.js` (new)
- `src/index/build/indexer/steps/discover.js`
- `src/index/build/indexer/steps/process-files.js`
- `src/index/build/indexer/steps/relations.js`
- `src/index/build/indexer/steps/postings.js`
- `src/index/build/indexer/steps/write.js`
- `tools/build/embeddings/runner.js`
- `tools/build/sqlite/runner.js`
- `docs/perf/indexing-stage-audit.md` (new)
- `tests/indexing/runtime/stage-memory-checkpoints.test.js` (new)
- `tests/indexing/runtime/stage-timing-checkpoints.test.js` (new)

### Docs/specs to add or update
- `docs/perf/indexing-stage-audit.md` (new)

### Tasks
- [x] Add per-stage checkpoints (time + heapUsed + rss + external + arrayBuffers).
- [x] Record checkpoints in build state or perf profile (schema versioned).
- [x] Emit a concise audit summary per mode and per stage.
- [x] Capture high-watermarks for postings maps, chunk arrays, relations, and embeddings buffers.
- [x] Document the audit output format and interpretation guide.

### Tests
- [x] `tests/indexing/runtime/stage-memory-checkpoints.test.js`
- [x] `tests/indexing/runtime/stage-timing-checkpoints.test.js`

### Acceptance
- [x] Each stage records timing and memory checkpoints.
- [x] Audit report is produced and documented.

---

## Phase 2 — Shared IO + Serialization Performance

### Objective
Optimize shared JSON streaming, artifact IO, and compression paths used across indexing and retrieval.

### Goals
- Reduce memory overhead during large JSON loads/writes.
- Improve throughput for artifact reads and writes.

### Non-goals
- Changing artifact schemas or file formats.
- Removing safety limits (MAX_JSON_BYTES).

### Files to modify (exhaustive for this phase)
- `src/shared/json-stream.js`
- `src/shared/json-stream/encode.js`
- `src/shared/json-stream/streams.js`
- `src/shared/json-stream/compress.js`
- `src/shared/json-stream/atomic.js`
- `src/shared/json-stream/runtime.js`
- `src/shared/artifact-io.js`
- `src/shared/artifact-io/constants.js`
- `src/shared/artifact-io/limits.js`
- `src/shared/artifact-io/manifest.js`
- `src/shared/artifact-io/loaders.js`
- `src/shared/artifact-io/json.js`
- `src/shared/artifact-io/jsonl.js`
- `src/shared/artifact-io/graph.js`
- `src/shared/artifact-io/compression.js`
- `src/shared/artifact-io/cache.js`
- `src/shared/artifact-io/fs.js`
- `src/shared/bundle-io.js`
- `src/shared/encoding.js`
- `src/shared/files.js`
- `src/shared/file-stats.js`
- `src/shared/lines.js`
- `docs/perf/shared-io-serialization.md` (new)
- `tests/shared/json-stream/large-array-stream.test.js` (new)
- `tests/shared/artifact-io/manifest-streaming.test.js` (new)
- `tests/shared/artifact-io/jsonl-stream-roundtrip.test.js` (new)

### Docs/specs to add or update
- `docs/perf/shared-io-serialization.md` (new)

### Tasks
- [x] Enforce streaming decode/encode paths for large arrays and JSONL.
- [x] Tune chunk sizes and backpressure handling in json-stream.
- [x] Use bounded buffers for atomic writes and compression.
- [x] Add shared IO telemetry hooks for large artifact reads.

### Tests
- [x] `tests/shared/json-stream/large-array-stream.test.js`
- [x] `tests/shared/artifact-io/manifest-streaming.test.js`
- [x] `tests/shared/artifact-io/jsonl-stream-roundtrip.test.js`

### Acceptance
- [ ] Large artifact loads stay within memory bounds.
- [ ] Shared IO paths demonstrate improved throughput.

---

## Cross-cutting Tests to Run
- [x] `node tests/run.js --lane ci-lite`
- [x] `node tests/run.js --lane ci`

---

## Acceptance (overall)
- [x] Stage audit report exists and highlights memory/perf hotspots.
- [ ] Global embeddings cache reduces recomputation and passes tests.
- [ ] Search CLI startup time improved without functional regressions.
- [ ] VFS correctness/perf improvements land before tree-sitter load changes.
- [ ] Retrieval, graph/context-pack, map, and shared IO perf improvements landed with tests.
- [ ] No artifact schema regressions.
- [x] Documentation and JSDoc standards met.

## Phase 3 — Stage1 (Discovery + Chunking + Token Postings) Optimizations

### Objective
Reduce memory pressure in postings and chunk retention while preserving deterministic output.

### Goals
- Lower peak heap during postings construction and chunk retention.
- Maintain deterministic output and existing artifact schemas.

### Non-goals
- SPIMI spill-to-disk work (tracked separately in `spimi_spec.md`).
- Changes to search ranking or tokenization semantics.

### Files to modify (exhaustive for this phase)
- `src/index/build/state.js`
- `src/index/build/postings.js`
- `src/index/build/file-processor.js`
- `src/index/build/indexer/steps/process-files.js`
- `src/index/build/indexer/steps/postings.js`
- `src/index/build/tokenization.js`
- `src/index/build/file-processor/process-chunks/index.js`
- `src/shared/cache.js`
- `docs/perf/indexing-stage-audit.md`
- `docs/specs/segmentation-perf.md`
- `docs/specs/large-file-caps-strategy.md`
- `tests/indexing/postings/postings-heap-plateau.test.js` (new)
- `tests/indexing/runtime/chunk-retention-sampling.test.js` (new)

### Docs/specs to add or update
- `docs/perf/indexing-stage-audit.md` (update Stage1 findings)
- `docs/specs/segmentation-perf.md` (update perf guidance)
- `docs/specs/large-file-caps-strategy.md` (update if caps change)

### Tasks
- [x] Identify large allocations in postings construction (token/phrase/chargram maps).
- [x] Reduce duplicate string retention (file text reuse + token arrays).
- [x] Evaluate flat postings buffers for token postings (optional if safe).
- [x] Review token retention defaults for chunk metadata.
- [x] Ensure early release of intermediate arrays once written.

### Tests
- [x] `tests/indexing/postings/postings-heap-plateau.test.js`
- [x] `tests/indexing/runtime/chunk-retention-sampling.test.js`

### Acceptance
- [x] Stage1 peak heap reduced on large fixtures without regressions.

---

## Phase 4 — Stage2 (Relations + Repo Map + Filter Index) Optimizations

### Objective
Reduce memory spikes caused by relations graphs and large filter indexes.

### Goals
- Bound memory usage for relations processing and filter index creation.
- Preserve artifact schemas and deterministic ordering.

### Non-goals
- Changes to relation semantics or schema versions.
- Search ranking changes.

### Files to modify (exhaustive for this phase)
- `src/index/build/indexer/steps/relations.js`
- `src/index/build/artifacts/writers/file-relations.js`
- `src/index/build/artifacts/writers/repo-map.js`
- `src/index/build/artifacts/filter-index.js`
- `src/index/build/artifacts.js`
- `src/index/build/state.js`
- `docs/perf/indexing-stage-audit.md`
- `tests/indexing/relations/relations-memory-release.test.js` (new)
- `tests/indexing/filter-index/filter-index-sharding.test.js` (new)

### Docs/specs to add or update
- `docs/perf/indexing-stage-audit.md` (update Stage2 findings)

### Tasks
- [x] Identify oversized in-memory relation structures and their lifetimes.
- [x] Stream or shard relations/filters where feasible.
- [x] Ensure early release of relation maps after artifact write.
- [x] Verify stable ordering and deterministic output after streaming/sharding.

### Tests
- [x] `tests/indexing/relations/relations-memory-release.test.js`
- [ ] `tests/indexing/filter-index/filter-index-sharding.test.js`

### Acceptance
- [x] Stage2 peak heap reduced; no changes to artifact schemas.

---

## Phase 5 — Stage3 (Embeddings + ANN + LanceDB) Optimizations

### Objective
Avoid re-computation of embeddings across runs and reduce in-memory vector retention.

### Goals
- Implement global compressed embeddings cache with deterministic invalidation.
- Reduce memory retained during embedding generation.

### Non-goals
- Changing embedding models or ANN semantics.
- Changing artifacts formats beyond cache sidecars.

### Files to modify (exhaustive for this phase)
- `tools/build/embeddings/runner.js`
- `tools/build/embeddings/cache.js`
- `tools/build/embeddings/manifest.js`
- `src/shared/embedding-identity.js`
- `src/shared/embedding-utils.js`
- `src/shared/env.js`
- `src/shared/hash.js`
- `src/shared/cache-roots.js` (new; OS cache path helper)
- `docs/specs/embeddings-cache.md` (new)
- `docs/contracts/indexing.md`
- `docs/contracts/artifact-contract.md`
- `docs/config/schema.json`
- `docs/config/contract.md`
- `docs/config/inventory.md`
- `docs/config/inventory.json`
- `docs/guides/commands.md`
- `tests/indexing/embeddings/cache-binary-roundtrip.test.js` (new)
- `tests/indexing/embeddings/cache-identity-invalidation.test.js` (new)
- `tests/indexing/embeddings/cache-compression-zstd.test.js` (new)
- `tests/indexing/embeddings/cache-pruning.test.js` (new)
- `tests/indexing/embeddings/cache-cross-repo-reuse.test.js` (new)

### Docs/specs to add or update
- `docs/specs/embeddings-cache.md` (new)
- `docs/contracts/indexing.md` (update Stage3 cache mention)
- `docs/contracts/artifact-contract.md` (note cache is out-of-band)
- `docs/config/schema.json` + `docs/config/contract.md` + `docs/config/inventory.*`
- `docs/guides/commands.md`

### Tasks
- [x] Implement a global, compressed embeddings cache in OS cache root.
- [x] Cache format: binary + zstd, store quantized vectors and metadata.
- [x] Cache keys include file hash, chunkSignature, identityKey.
- [x] Add pruning by size and age with a stable policy.
- [x] Ensure cache identity mismatch invalidates entries deterministically.

### Tests
- [x] `tests/indexing/embeddings/cache-binary-roundtrip.test.js`
- [ ] `tests/indexing/embeddings/cache-identity-invalidation.test.js`
- [x] `tests/indexing/embeddings/cache-compression-zstd.test.js`
- [x] `tests/indexing/embeddings/cache-pruning.test.js`
- [x] `tests/indexing/embeddings/cache-cross-repo-reuse.test.js`

### Acceptance
- [ ] Cache hits prevent recomputation for unchanged files.
- [ ] Cache invalidation works for identity/hash/signature changes.

---

## Phase 6 — Stage4 (SQLite Build) Optimizations

### Objective
Reduce memory and time during SQLite builds and incremental updates.

### Goals
- Reduce peak memory and improve throughput for SQLite builds.
- Preserve schema and data correctness.
- Stream compressed JSONL ingestion without full in-memory buffers.
- Bound WAL/temp file growth and avoid runaway disk usage.
- Add build telemetry for batch sizing and throughput.

### Non-goals
- Changing SQLite schema versions.
- Changing query semantics.
- Introducing new SQLite dependencies or native extensions.
- Disabling integrity checks beyond existing build pragmas.
- Changing artifact formats (JSON/JSONL) for inputs.

### Files to modify (exhaustive for this phase)
- `tools/build/sqlite/runner.js`
- `src/storage/sqlite/build/from-artifacts.js`
- `src/storage/sqlite/build/from-bundles.js`
- `src/storage/sqlite/build/incremental-update.js`
- `src/storage/sqlite/incremental.js`
- `src/storage/sqlite/utils.js`
- `src/storage/sqlite/build/pragmas.js`
- `src/storage/sqlite/build/validate.js`
- `src/storage/sqlite/build/manifest.js`
- `docs/perf/sqlite-build.md` (new)
- `tools/bench/sqlite/build-from-artifacts.js` (new)
- `tools/bench/sqlite/build-from-bundles.js` (new)
- `tools/bench/sqlite/incremental-update.js` (new)
- `tools/bench/sqlite/jsonl-streaming.js` (new)
- `docs/perf/indexing-stage-audit.md`
- `tests/storage/sqlite/sqlite-build-memory-guard.test.js` (new)
- `tests/storage/sqlite/sqlite-incremental-memory-profile.test.js` (new)
- `tests/storage/sqlite/sqlite-build-pragmas-restore.test.js` (new)
- `tests/storage/sqlite/sqlite-build-pragmas-dynamic.test.js` (new)
- `tests/storage/sqlite/sqlite-jsonl-streaming-gzip.test.js` (new)
- `tests/storage/sqlite/sqlite-jsonl-streaming-zstd.test.js` (new)
- `tests/storage/sqlite/sqlite-batch-size-adaptive.test.js` (new)
- `tests/storage/sqlite/sqlite-wal-size-limit.test.js` (new)
- `tests/storage/sqlite/sqlite-incremental-transaction-boundary.test.js` (new)

### Docs/specs to add or update
- `docs/perf/indexing-stage-audit.md` (update Stage4 findings)
- `docs/perf/sqlite-build.md` (new)

### Tasks
- [x] **6.A Build pragmas + transaction strategy**
- [x] Task 6.A.1: Make build pragmas adaptive based on input size + available memory (cache_size, mmap_size).
- [x] Task 6.A.2: Set `wal_autocheckpoint` and `journal_size_limit` during builds; restore after.
- [x] Task 6.A.3: Use `locking_mode=EXCLUSIVE` for build database temp files; restore after finalize.
- [x] Task 6.A.4: Add explicit `BEGIN/COMMIT` wrapping per-table inserts to reduce transaction churn.
- [x] Task 6.A.5: Run `PRAGMA optimize` (and optional `ANALYZE`) after indexes are created.
- [x] Task 6.A.6: Record applied pragmas + batch sizes in build telemetry.

- [x] **6.B Streaming JSONL ingestion**
- [x] Task 6.B.1: Replace `.gz/.zst` JSONL reads that load into memory with streaming decompress + parse.
- [x] Task 6.B.2: Ensure `readJsonLinesFile` handles compressed files without `readJsonLinesArray`.
- [x] Task 6.B.3: Add guardrails for max JSON bytes during streaming parse.

- [x] **6.C Batch sizing + throughput**
- [x] Task 6.C.1: Tune `resolveSqliteBatchSize` using inputBytes + row counts; add min/max clamps.
- [x] Task 6.C.2: Record batch counts per table (token/postings/chargram/minhash).
- [x] Task 6.C.3: Add per-table throughput metrics (rows/sec).

- [x] **6.D Incremental update improvements**
- [x] Task 6.D.1: Add transaction boundaries around delete + insert phases to avoid partial WAL growth.
- [x] Task 6.D.2: Cap incremental updates by change ratio (already) and log skip reasons to build state.
- [x] Task 6.D.3: Add explicit `wal_checkpoint(TRUNCATE)` after incremental updates.

- [x] **6.E Validation + compaction hooks**
- [x] Task 6.E.1: Ensure compact/validate paths use the same adaptive pragma set.
- [x] Task 6.E.2: Emit validation timing + row counts to Stage4 audit.

- [x] **6.F Benchmarks**
- [x] Task 6.F.1: Add `tools/bench/sqlite/build-from-artifacts.js` with baseline vs optimized runs.
- [x] Task 6.F.2: Add `tools/bench/sqlite/build-from-bundles.js`.
- [x] Task 6.F.3: Add `tools/bench/sqlite/incremental-update.js`.
- [x] Task 6.F.4: Add `tools/bench/sqlite/jsonl-streaming.js` to compare compressed streaming vs array load.
- [x] Task 6.F.5: Document benchmark setup + expected deltas in `docs/perf/sqlite-build.md`.

### Tests
- [x] `tests/storage/sqlite/sqlite-build-memory-guard.test.js`
- [x] `tests/storage/sqlite/sqlite-incremental-memory-profile.test.js`
- [x] `tests/storage/sqlite/sqlite-build-pragmas-restore.test.js`
  - Success: pragmas are restored to safe defaults after build.
- [x] `tests/storage/sqlite/sqlite-build-pragmas-dynamic.test.js`
  - Success: adaptive pragma values scale with input size.
- [x] `tests/storage/sqlite/sqlite-jsonl-streaming-gzip.test.js`
  - Success: gzip JSONL is streamed without loading full file.
- [x] `tests/storage/sqlite/sqlite-jsonl-streaming-zstd.test.js`
  - Success: zstd JSONL is streamed without loading full file.
- [x] `tests/storage/sqlite/sqlite-batch-size-adaptive.test.js`
  - Success: batch size scales with inputBytes and stays within bounds.
- [x] `tests/storage/sqlite/sqlite-wal-size-limit.test.js`
  - Success: WAL is checkpointed/truncated and remains bounded.
- [x] `tests/storage/sqlite/sqlite-incremental-transaction-boundary.test.js`
  - Success: delete+insert phases execute inside explicit transactions.

### Acceptance
- [x] Stage4 peak memory reduced for large indexes.
- [x] WAL/SHM sidecars stay bounded after builds and incremental updates.
- [x] Compressed JSONL ingestion is streaming and does not allocate large arrays.
- [x] Build telemetry captures pragmas, batch sizes, and throughput.

---

## Phase 7 — VFS Correctness + Performance

### Objective
Ensure VFS manifests are correct, deterministic, and efficient, and leverage VFS routing to reduce remaining WASM/tooling issues.

### Goals
- Ensure deterministic virtual paths and manifest rows.
- Reduce VFS manifest memory usage via streaming/sharding.
- Enable VFS routing to reduce tree-sitter grammar churn.

### Non-goals
- Changing provider feature sets beyond VFS routing correctness.
- Introducing new VFS schema versions.

### Files to modify (exhaustive for this phase)
- `src/index/tooling/vfs.js`
- `src/index/build/file-processor/process-chunks/ids.js`
- `src/index/build/file-processor/process-chunks/index.js`
- `src/index/build/artifacts/writers/vfs-manifest.js`
- `src/index/build/artifacts/file-lists.js`
- `src/index/build/state.js`
- `src/index/validate/manifest.js`
- `src/shared/artifact-io/fs.js`
- `src/shared/artifact-io/cache.js`
- `src/shared/fs/ignore.js`
- `src/index/tooling/lsp-provider.js`
- `src/index/tooling/provider-registry.js`
- `src/index/tooling/provider-contract.js`
- `src/index/tooling/providers/index.js`
- `src/index/tooling/orchestrator.js`
- `src/index/tooling/doctor.js`
- `src/index/tooling/typescript-provider.js`
- `src/index/tooling/typescript/host.js`
- `src/index/tooling/clangd-provider.js`
- `src/index/tooling/sourcekit-provider.js`
- `src/index/tooling/pyright-provider.js`
- `src/index/tooling/signature-parse/clike.js`
- `src/index/tooling/signature-parse/python.js`
- `src/index/tooling/signature-parse/swift.js`
- `src/integrations/tooling/providers/lsp.js`
- `src/integrations/tooling/providers/shared.js`
- `src/integrations/tooling/lsp/client.js`
- `src/integrations/tooling/lsp/positions.js`
- `src/integrations/tooling/lsp/symbols.js`
- `docs/specs/vfs-manifest-artifact.md`
- `docs/specs/tooling-vfs-and-segment-routing.md`
- `docs/specs/lsp-provider-hardening.md`
- `docs/specs/tooling-provider-registry.md`
- `tests/tooling/vfs/vfs-virtualpath-deterministic.test.js`
- `tests/tooling/vfs/vfs-maps-segment-offsets.test.js`
- `tests/tooling/vfs/vfs-routing-by-effective-language.test.js`
- `tests/tooling/vfs/vfs-manifest-streaming.test.js` (new)
- `tests/tooling/vfs/vfs-row-size-trim.test.js` (new)

### Docs/specs to add or update
- `docs/specs/vfs-manifest-artifact.md`
- `docs/specs/tooling-vfs-and-segment-routing.md`
- `docs/specs/lsp-provider-hardening.md`
- `docs/specs/tooling-provider-registry.md`

### Tasks
- [x] Validate VFS virtualPath determinism and path normalization across platforms.
- [x] Stream or shard VFS manifest rows to avoid large in-memory arrays.
- [x] Enforce row size caps and deterministic trimming rules.
- [x] Ensure VFS routing always uses `.poc-vfs/` paths for segment docs.
- [x] Use VFS segment language routing to minimize unnecessary tree-sitter loads.
- [x] Provide stable mapping from virtualPath → disk path (for LSP file scheme fallback).

### Tests
- [x] `tests/tooling/vfs/vfs-virtualpath-deterministic.test.js`
- [x] `tests/tooling/vfs/vfs-maps-segment-offsets.test.js`
- [x] `tests/tooling/vfs/vfs-routing-by-effective-language.test.js`
- [x] `tests/tooling/vfs/vfs-manifest-streaming.test.js`
- [x] `tests/tooling/vfs/vfs-row-size-trim.test.js`

### Acceptance
- [x] VFS manifest rows are deterministic and schema-valid.
- [x] VFS manifest generation remains bounded in memory.
- [x] Tooling providers work with `.poc-vfs` paths and fall back safely when needed.

---

## Phase 8 — Tree-sitter WASM Handling + Load Strategy

### Objective
Reduce tree-sitter WASM churn, improve load determinism, and avoid unnecessary grammar loads while keeping parsing quality.

### Goals
- Bound loaded WASM grammars deterministically.
- Reduce grammar swaps by batching and VFS language routing.

### Non-goals
- Adding new grammars or changing parser semantics.
- Changing token classification rules beyond performance improvements.

### Files to modify (exhaustive for this phase)
- `src/lang/tree-sitter.js`
- `src/lang/tree-sitter/runtime.js`
- `src/lang/tree-sitter/worker.js`
- `src/lang/tree-sitter/state.js`
- `src/lang/tree-sitter/config.js`
- `src/lang/tree-sitter/options.js`
- `src/lang/tree-sitter/chunking.js`
- `src/lang/tree-sitter/ast.js`
- `src/lang/workers/tree-sitter-worker.js`
- `src/index/build/runtime/runtime.js`
- `src/index/build/runtime/tree-sitter.js`
- `src/index/build/file-processor/cpu/chunking.js`
- `src/index/build/file-processor/cpu/analyze.js`
- `src/index/build/file-processor/tree-sitter.js`
- `src/index/chunking/tree-sitter.js`
- `src/index/build/indexer/steps/process-files/tree-sitter.js`
- `src/index/build/tokenization.js`
- `docs/specs/segmentation-perf.md`
- `tests/indexing/tree-sitter/tree-sitter-preload-limited.test.js`
- `tests/indexing/tree-sitter/tree-sitter-eviction-determinism.test.js`
- `tests/indexing/tree-sitter/tree-sitter-batch-by-language.test.js`
- `tests/indexing/tree-sitter/tree-sitter-fallback-missing-wasm.test.js`

### Docs/specs to add or update
- `docs/specs/segmentation-perf.md`

### Tasks
- [x] Ensure tree-sitter runtime is initialized lazily and only when needed.
- [x] Restrict preloading to languages discovered in the repo (not full registry).
- [x] Improve LRU eviction rules for WASM grammar cache (deterministic + bounded).
- [x] Batch tree-sitter parses by language to minimize grammar swaps.
- [x] Use VFS segment language routing to avoid loading grammars for unused embedded languages.
- [x] Add a clear fallback path when wasm is missing or load fails (no crash, deterministic logs).

### Tests
- [x] `tests/indexing/tree-sitter/tree-sitter-preload-limited.test.js`
- [x] `tests/indexing/tree-sitter/tree-sitter-eviction-determinism.test.js`
- [x] `tests/indexing/tree-sitter/tree-sitter-batch-by-language.test.js`
- [x] `tests/indexing/tree-sitter/tree-sitter-fallback-missing-wasm.test.js`

### Acceptance
- [x] WASM grammar count stays within configured bounds.
- [x] Tree-sitter load failures do not crash indexing.
- [x] Language preloading is limited to observed repo languages.

---

## Phase 9 — Retrieval Pipeline Performance (Query → Candidates → Rank → Output)

### Objective
Reduce query latency and memory use by minimizing repeated parsing, avoiding unnecessary artifact loads, and optimizing candidate/filter/ranking stages.

### Goals
- Improve cold and warm query latency by reducing repeated work.
- Reduce per-query memory spikes for large result sets.

### Non-goals
- Changing query semantics or ranking behavior.
- Changing output schema or CLI flags.

### Files to modify (exhaustive for this phase)
- `src/retrieval/pipeline.js`
- `src/retrieval/pipeline/query-ast.js`
- `src/retrieval/pipeline/candidates.js`
- `src/retrieval/pipeline/fusion.js`
- `src/retrieval/pipeline/graph-ranking.js`
- `src/retrieval/pipeline/ann-backends.js`
- `src/retrieval/query.js`
- `src/retrieval/query-parse.js`
- `src/retrieval/query-intent.js`
- `src/retrieval/query-cache.js`
- `src/retrieval/index-cache.js`
- `src/retrieval/sqlite-cache.js`
- `src/retrieval/sqlite-helpers.js`
- `src/retrieval/lmdb-helpers.js`
- `src/retrieval/filters.js`
- `src/retrieval/filter-index.js`
- `src/retrieval/bitmap.js`
- `src/retrieval/rankers.js`
- `src/retrieval/embedding.js`
- `src/retrieval/fts.js`
- `src/retrieval/context-expansion.js`
- `src/retrieval/output/format.js`
- `src/retrieval/output/filters.js`
- `src/retrieval/output/filters/candidates.js`
- `src/retrieval/output/filters/file-prefilter.js`
- `src/retrieval/output/filters/file.js`
- `src/retrieval/output/filters/meta.js`
- `src/retrieval/output/filters/predicates.js`
- `src/retrieval/output/filters/structural.js`
- `src/retrieval/output/context.js`
- `src/retrieval/output/summary.js`
- `src/retrieval/output/explain.js`
- `src/retrieval/output/risk-explain.js`
- `src/retrieval/output/graph-impact.js`
- `src/retrieval/output/graph-context-pack.js`
- `src/retrieval/output/suggest-tests.js`
- `src/retrieval/output/architecture.js`
- `src/retrieval/output/cache.js`
- `src/retrieval/ann/types.js`
- `src/retrieval/ann/providers/dense.js`
- `src/retrieval/ann/providers/hnsw.js`
- `src/retrieval/ann/providers/lancedb.js`
- `src/retrieval/ann/providers/sqlite-vec.js`
- `src/retrieval/sparse/types.js`
- `src/retrieval/sparse/providers/js-bm25.js`
- `src/retrieval/sparse/providers/sqlite-fts.js`
- `src/retrieval/sparse/providers/tantivy.js`
- `docs/perf/retrieval-pipeline.md` (new)
- `tests/retrieval/pipeline/query-cache-hit.test.js` (new)
- `tests/retrieval/pipeline/filter-bitmap-shortcircuit.test.js` (new)
- `tests/retrieval/pipeline/candidates-memory-plateau.test.js` (new)
- `tests/retrieval/pipeline/ranking-fastpath.test.js` (new)

### Docs/specs to add or update
- `docs/perf/retrieval-pipeline.md` (new)

### Tasks
- [x] Add query parse + plan cache keyed by query + index signature.
- [x] Avoid loading heavy artifacts when query does not need them.
- [x] Use bitmap/bitset short-circuit for filters and structural predicates.
- [x] Reduce candidate retention by streaming and early cutoff.
- [x] Track per-stage retrieval timing and memory checkpoints.

### Tests
- [x] `tests/retrieval/pipeline/query-cache-hit.test.js`
- [x] `tests/retrieval/pipeline/filter-bitmap-shortcircuit.test.js`
- [x] `tests/retrieval/pipeline/candidates-memory-plateau.test.js`
- [x] `tests/retrieval/pipeline/ranking-fastpath.test.js`

### Acceptance
- [x] Query latency reduced on cold and warm runs.
- [x] Retrieval memory spikes reduced for large result sets.

---

## Phase 10 — Graph + Context Pack Performance

### Objective
Reduce graph traversal overhead and context pack assembly cost while preserving deterministic results.

### Goals
- Lower memory use during graph neighborhood expansion and context pack assembly.
- Avoid redundant sorts and repeated artifact parsing.

### Non-goals
- Changing graph semantics or output schema.
- Changing provenance or truncation behavior.

### Files to modify (exhaustive for this phase)
- `src/graph/store.js`
- `src/graph/neighborhood.js`
- `src/graph/ordering.js`
- `src/graph/impact.js`
- `src/graph/architecture.js`
- `src/graph/context-pack.js`
- `src/graph/suggest-tests.js`
- `src/context-pack/assemble.js`
- `src/retrieval/output/graph-impact.js`
- `src/retrieval/output/graph-context-pack.js`
- `src/retrieval/output/architecture.js`
- `src/retrieval/output/suggest-tests.js`
- `src/integrations/tooling/context-pack.js`
- `src/integrations/tooling/impact.js`
- `src/integrations/tooling/architecture-check.js`
- `src/integrations/tooling/api-contracts.js`
- `docs/perf/graph-context-pack.md` (new)
- `tests/graph/graph-neighborhood-cache.test.js` (new)
- `tests/graph/graph-index-cache-reuse.test.js` (new)
- `tests/graph/graph-adjacency-deterministic.test.js` (new)
- `tests/graph/graph-truncation-deterministic.test.js` (new)
- `tests/context-pack/context-pack-excerpt-range.test.js` (new)
- `tests/context-pack/context-pack-range-reads.test.js` (new)
- `tests/context-pack/context-pack-excerpt-cache.test.js` (new)
- `tests/context-pack/context-pack-assembly-memory.test.js` (new)

### Docs/specs to add or update
- `docs/perf/graph-context-pack.md` (new)

### Tasks
- [x] Build a shared `GraphIndex` in `src/graph/store.js` that precomputes node/edge maps and sort keys.
- [x] Add compact integer ID remapping for graph nodes/edges with reversible string tables.
- [x] Replace per-edge string keys with numeric IDs or pre-hashed keys in the graph index.
- [x] Normalize import/file paths once in the graph index; avoid per-edge normalization.
- [x] Make adjacency lists unique + pre-sorted at index build time; skip per-node neighbor sorting.
- [x] Precompute adjacency partitions (by from/to/type) to avoid per-request sorting and repeated scans.
- [x] Add prefix-compressed path tables for file path references to reduce memory.
- [x] Add an opt-in columnar/offsets representation for `graph_relations` to cut parse + memory cost.
- [x] Store graph relations in memory-mapped or buffer-backed typed arrays for large graphs.
- [x] Bound graph artifact caches by index signature (LRU eviction) to prevent unbounded growth.
- [x] Cache the `GraphIndex` by index signature + options; reuse across graph/context-pack calls in a session.
- [x] Add lazy edge-type loading so call/usage/import graphs are only loaded when requested.
- [x] Gate graph artifact loads in tooling CLIs based on include flags and edge filters.
- [x] Parallelize graph artifact loads (`graph_relations`, `symbol_edges`, `call_sites`) with `Promise.all`.
- [x] Task 10.X.3.a: Resolve required artifacts from CLI flags (`graphs`, `edgeTypes`, include toggles).
- [x] Task 10.X.3.b: Load only required artifacts; emit warning when required artifact missing.
- [x] Task 10.X.3.c: Use `Promise.all` for required loads.
- [x] Task 10.X.3.d: Add tests verifying unused artifacts are not loaded.
- [x] Add shared chunk lookup index for context-pack to avoid per-call map rebuilds.
- [x] Task 10.X.8.a: Build shared `ChunkIndex` in context-pack path.
- [x] Task 10.X.8.b: Thread `ChunkIndex` through impact/context-pack callers.
- [x] Task 10.X.8.c: Add test that repeated calls reuse index.
- [x] Add multi-seed BFS for impact/context-pack to avoid repeated graph traversal.
- [x] Task 10.X.7.a: Implement multi-seed traversal with deterministic merge order.
- [x] Task 10.X.7.b: Add deterministic test comparing multi-seed vs single-seed union output.
- [x] Reduce intermediate array churn in neighborhood traversal with streaming + budgeted iterators.
- [x] Add windowed spill/merge for large neighborhood assembly to cap heap usage.
- [x] Add parallel neighborhood expansion per edge type with deterministic merge ordering.
- [x] Precompute deterministic edge buckets for truncation (priority + stable sort keys) to avoid per-call sort.
- [x] Add lazy witness-path construction; avoid building paths unless requested and within caps.
- [x] Add fast edge-filter predicate compiled once per request.
- [x] Ensure budget/truncation ordering is deterministic across runs.
- [x] Track graph/context-pack timings and memory checkpoints.
- [x] Track graph/context-pack peak memory and excerpt bytes in stats payload.
- [x] Use range reads for excerpts instead of full file loads; avoid `fs.readFileSync` for slices.
- [x] Add `readFileRange` helper; prefer when `start/end` valid.
- [x] Add a small excerpt LRU cache keyed by `(path,start,end,maxBytes,maxTokens)` to avoid repeated reads.
- [x] Add file-level excerpt cache keyed by `(filePath, byteRange)` before token slicing.
- [x] Add excerpt prefetch batching to reduce per-chunk IO latency in context packs.
- [x] Add excerpt hash de-duplication to avoid emitting duplicate slices.
- [x] Normalize chunk/file paths once for seed resolution in context-pack assembly.
- [x] Task 10.X.5.c: Normalize seed paths before lookup; use shared chunk index.
- [x] Task 10.X.5.d: Add tests for range reads + cache hits + path normalization.
- [x] Add deterministic output ordering for graph/architecture/suggest-tests renderers and include warnings/truncation sections.
- [x] Task 10.X.1.a: Sort impact outputs by distance then ref key; include truncation + warnings sections.
- [x] Task 10.X.1.b: Sort architecture outputs by rule id + edge key; include truncation + warnings sections.
- [x] Task 10.X.1.c: Sort suggest-tests outputs by score desc then path; include truncation + warnings sections.
- [x] Task 10.X.1.d: Add renderer tests for deterministic ordering and diagnostics visibility.
- [x] Add optional skip-resort flag in graph-context-pack renderer when upstream already sorted.
- [x] Task 10.X.2.a: Thread a `sorted` flag through context-pack payload (stats or top-level).
- [x] Task 10.X.2.b: Skip `compareGraphNodes/Edges` sorts when `sorted` is true.
- [x] Task 10.X.2.c: Add test that asserts no resort occurs when `sorted` is set.
- [x] Cache compiled architecture rules + ordered node lists by rules payload hash.
- [x] Cache test discovery + compiled matchers in suggest-tests (keyed by repo + patterns).
- [x] Add signature arity cache + call-site grouping optimizations in api-contracts.
- [x] Task 10.X.4.a: Add arity cache keyed by signature string.
- [x] Task 10.X.4.b: Build `callSitesByTarget` once and reuse.
- [x] Task 10.X.4.c: Skip per-symbol call sorting when `maxCallsPerSymbol` unset.
- [x] Task 10.X.4.d: Add large-call-site test to validate identical output with cache.
- [x] Warn when `impact` CLI receives both seed and changed inputs (changed ignored).
- [x] Task 10.X.6.a: Emit warning in payload/stderr when both seed and changed provided.
- [x] Task 10.X.6.b: Add test asserting warning and unchanged behavior.
- [x] Add microbench harness for graph/context-pack latency + memory.
- [x] Add neighborhood cache benchmark (graphIndex vs rebuild).
- [x] Add graph store lazy-load benchmark (subset vs full graphs).
- [x] Add graph renderer sorted-skip benchmark.
- [x] Update `docs/perf/graph-context-pack.md` with new graph index, caching, and excerpt strategies.
- [x] Add JSDoc on tricky components (GraphIndex, ChunkIndex, adjacency builders, spill/merge, excerpt caches).
- [x] Deduplicate seed candidates in context-pack assembly to avoid repeated lookups.
- [x] Add seed normalization tests (posix/windows mix) for context-pack and impact outputs.
- [x] Add streaming load path for api-contracts symbols/call-sites to avoid full array materialization.
- [x] Validate api-contracts call-site grouping keys against symbol ids/chunkUids (add fallback).
- [x] Validate `edgeFilters.graphs` values and warn on unknown graphs or all-filtered runs.
- [x] Validate `edgeFilters.edgeTypes` values (normalize aliases or warn on no-match).
- [x] Make graph selection ignore `edgeTypes` filter when deciding whether to include a graph.
- [x] Detect `graphIndex`/`graphRelations` mismatch (signature or identity) and warn or bypass cached index.
- [x] Warn when `repoRoot` differs between `graphIndex` and request; ensure consistent normalization.
- [x] Add fallback or warning when import graph expansion lacks file mapping for chunk seeds.
- [x] Define edge de-dupe policy for confidence/evidence and implement deterministic winner selection.
- [x] Clarify `symbolEdges` direction semantics (document or adjust traversal) and add tests.
- [x] Validate `nodeCount`/`edgeCount` vs actual nodes/edges with warnings in strict mode.
- [x] Reconcile include flags vs `edgeFilters` (warn when a graph is filtered out by flags).
- [x] Add tests for unknown `edgeFilters.graphs`/`edgeTypes` warnings and no-match behavior.
- [x] Add tests asserting `edgeTypes` does not suppress graph inclusion.
- [x] Add tests for graphIndex/graphRelations mismatch and repoRoot mismatch warnings.
- [x] Add tests for import-graph expansion missing file mapping (warn or fallback path).
- [x] Add tests for edge de-dupe policy (confidence/evidence determinism).
- [x] Add tests for symbolEdges direction semantics (`in`/`out`/`both`).
- [x] Add tests for nodeCount/edgeCount mismatch warnings in strict mode.
- [x] Update `docs/perf/graph-context-pack.md` with filter validation + dedupe policy + warning behaviors.

### Tests
- [x] `tests/graph/graph-neighborhood-cache.test.js`
- [x] `tests/graph/graph-index-cache-reuse.test.js`
- [x] `tests/graph/graph-adjacency-deterministic.test.js`
- [x] `tests/graph/graph-truncation-deterministic.test.js`
- [x] `tests/context-pack/context-pack-excerpt-range.test.js`
- [x] `tests/context-pack/context-pack-range-reads.test.js`
- [x] `tests/context-pack/context-pack-excerpt-cache.test.js`
- [x] `tests/context-pack/context-pack-assembly-memory.test.js`
- [x] `tests/context-pack/context-pack-seed-normalization.test.js`
- [x] `tests/graph/graph-id-remap-roundtrip.test.js`
- [x] `tests/graph/graph-edge-bucket-determinism.test.js`
- [x] `tests/graph/graph-lazy-edge-load.test.js`
- [x] `tests/graph/graph-spill-merge-deterministic.test.js`
- [x] `tests/context-pack/context-pack-excerpt-dedupe.test.js`
- [x] `tests/graph/graph-multiseed-bfs-deterministic.test.js`
- [x] `tests/graph/graph-adjacency-presorted.test.js`
- [x] `tests/graph/graph-store-cache-eviction.test.js`
- [x] `tests/graph/architecture-rules-cache.test.js`
- [x] `tests/graph/suggest-tests-cache.test.js`
- [x] `tests/context-pack/context-pack-shared-index.test.js`
- [x] `tests/context-pack/context-pack-range-reads.test.js`
- [x] `tests/context-pack/context-pack-excerpt-cache.test.js`
- [x] `tests/graph/graph-output-deterministic.test.js`
- [x] `tests/graph/architecture-output-deterministic.test.js`
- [x] `tests/graph/suggest-tests-output-deterministic.test.js`
- [x] `tests/graph/graph-context-pack-skip-resort.test.js`
- [x] `tests/tooling/api-contracts/api-contracts-large-call-sites.test.js`
- [x] `tests/tooling/impact/impact-changed-and-seed-warning.test.js`
- [x] `tests/tooling/impact/impact-seed-normalization.test.js`
- [x] `tests/graph/graph-witness-path-lazy.test.js`
- [x] `tests/graph/graph-filter-predicate-deterministic.test.js`
- [x] `tests/context-pack/context-pack-excerpt-file-cache.test.js`
- [x] `tests/graph/graph-truncation-order-deterministic.test.js`
- [x] `tests/graph/graph-filter-warnings.test.js` (new)
- [x] `tests/graph/graph-edge-type-graph-inclusion.test.js` (new)
- [x] `tests/graph/graph-index-mismatch-warning.test.js` (new)
- [x] `tests/graph/graph-reporoot-warning.test.js` (new)
- [x] `tests/graph/graph-import-missing-file-warning.test.js` (new)
- [x] `tests/graph/graph-edge-dedupe-policy.test.js` (new)
- [x] `tests/graph/graph-symbol-direction.test.js` (new)
- [x] `tests/graph/graph-count-mismatch-warning.test.js` (new)
- [x] `tools/bench/graph/context-pack-latency.js` (new)

### Acceptance
- [x] Graph and context pack generation uses less memory on large graphs.
- [x] Deterministic outputs remain unchanged.

---

## Phase 11 — Search CLI Startup Time + UX Fast Paths

### Objective
Reduce search CLI startup time by eliminating unnecessary work on cold start and lazy-loading heavy dependencies.

### Goals
- Improve cold-start time for `pairofcleats search` and `search.js`.
- Ensure `--help`/`--version` are fast paths with minimal initialization.

### Non-goals
- Changing search output schema or ranking behavior.
- Adding new CLI flags beyond profiling hooks.

### Files to modify (exhaustive for this phase)
- `bin/pairofcleats.js`
- `search.js`
- `src/integrations/core/search.js`
- `src/integrations/core/embeddings.js`
- `src/retrieval/cli.js`
- `src/retrieval/cli-args.js`
- `src/retrieval/cli-index.js`
- `src/retrieval/cli-sqlite.js`
- `src/retrieval/cli-lmdb.js`
- `src/retrieval/cli-dictionary.js`
- `src/retrieval/cli/ansi.js`
- `src/retrieval/cli/auto-sqlite.js`
- `src/retrieval/cli/backend-context.js`
- `src/retrieval/cli/branch-filter.js`
- `src/retrieval/cli/highlight.js`
- `src/retrieval/cli/index-loader.js`
- `src/retrieval/cli/index-state.js`
- `src/retrieval/cli/load-indexes.js`
- `src/retrieval/cli/model-ids.js`
- `src/retrieval/cli/normalize-options.js`
- `src/retrieval/cli/options.js`
- `src/retrieval/cli/persist.js`
- `src/retrieval/cli/policy.js`
- `src/retrieval/cli/query-plan.js`
- `src/retrieval/cli/render-output.js`
- `src/retrieval/cli/render.js`
- `src/retrieval/cli/resolve-run-config.js`
- `src/retrieval/cli/run-search-session.js`
- `src/retrieval/cli/runner.js`
- `src/retrieval/cli/search-runner.js`
- `src/retrieval/cli/telemetry.js`
- `src/shared/cli.js`
- `src/shared/cli-options.js`
- `src/shared/cli/ansi-utils.js`
- `src/shared/cli/progress-events.js`
- `src/shared/cli/display.js`
- `src/shared/cli/display/bar.js`
- `src/shared/cli/display/colors.js`
- `src/shared/cli/display/progress.js`
- `src/shared/cli/display/render.js`
- `src/shared/cli/display/terminal.js`
- `src/shared/cli/display/text.js`
- `src/shared/runtime-envelope.js`
- `src/shared/env.js`
- `tools/shared/dict-utils.js`
- `docs/contracts/search-cli.md`
- `docs/guides/commands.md`
- `tests/cli/search/search-help-fastpath.test.js` (new)
- `tests/cli/search/search-startup-profiler.test.js` (new)
- `tests/cli/search/search-lazy-imports.test.js` (new)

### Docs/specs to add or update
- `docs/contracts/search-cli.md`
- `docs/guides/commands.md`

### Tasks
- [x] Add a startup profiler (checkpoint timing) for CLI commands.
- [x] Ensure `--help` and `--version` avoid loading heavy modules.
- [x] Lazy-load search pipeline and config only after command resolution.
- [x] Avoid loading indexing/runtime configuration for search-only invocations.
- [x] Add a fast-path for `search --help` and `search --backend` validation without full config load.

### Tests
- [x] `tests/cli/search/search-help-fastpath.test.js`
- [x] `tests/cli/search/search-startup-profiler.test.js`
- [x] `tests/cli/search/search-lazy-imports.test.js`

### Acceptance
- [ ] Search CLI startup time improves measurably on cold start.
- [x] `--help` and `--version` do not initialize heavy subsystems.

---

## Phase 12 — Map Build + Viewer Performance

### Objective
Reduce map build memory usage and improve isometric viewer runtime performance on large repos.

### Goals
- Stream map build outputs to avoid large in-memory graph payloads.
- Reduce viewer frame drops via instancing, culling, and LOD.
- Keep build output deterministic and schema-compatible with existing consumers.
- Maintain responsive interaction (selection, hover, pan/zoom) on large graphs.
- Add measurable performance telemetry (build time, peak heap, FPS, dropped frames).

### Non-goals
- Changing map output schema or UI layout semantics.
- Replacing the renderer or UI framework.
- Changing graph/repo map semantics or ranking.
- Introducing new runtime dependencies outside existing map stack.
- Breaking the existing saved map viewer format.

### Files to modify (exhaustive for this phase)
- `src/map/build-map.js`
- `src/map/build-map/normalize.js`
- `src/map/build-map/nodes.js`
- `src/map/build-map/edges.js`
- `src/map/build-map/symbols.js`
- `src/map/build-map/filters.js`
- `src/map/build-map/io.js`
- `src/map/utils.js`
- `src/map/constants.js`
- `src/map/isometric-viewer.js`
- `src/map/isometric/client/viewer.js`
- `src/map/isometric/client/viewer-app.js`
- `src/map/isometric/client/scene.js`
- `src/map/isometric/client/scene-utils.js`
- `src/map/isometric/client/layout.js`
- `src/map/isometric/client/layout-utils.js`
- `src/map/isometric/client/meshes.js`
- `src/map/isometric/client/materials.js`
- `src/map/isometric/client/edges.js`
- `src/map/isometric/client/edges/aggregate.js`
- `src/map/isometric/client/edges/endpoints.js`
- `src/map/isometric/client/edges/resolvers.js`
- `src/map/isometric/client/edges/routing.js`
- `src/map/isometric/client/edges/style.js`
- `src/map/isometric/client/controls.js`
- `src/map/isometric/client/state.js`
- `src/map/isometric/client/selection.js`
- `src/map/isometric/client/rebuild.js`
- `src/map/isometric/client/map-data.js`
- `src/map/isometric/client/three-loader.js`
- `src/map/isometric/client/dom.js`
- `src/map/isometric/client/defaults.js`
- `src/map/isometric/client/utils.js`
- `src/map/isometric/client/ui.js`
- `src/map/isometric/client/perf.js` (new)
- `src/map/isometric/client/telemetry.js` (new)
- `tools/bench/map/build-map-streaming.js` (new)
- `tools/bench/map/build-map-memory.js` (new)
- `tools/bench/map/viewer-fps.js` (new)
- `tools/bench/map/viewer-lod-stress.js` (new)
- `docs/perf/map-pipeline.md` (new)
- `docs/specs/map-artifact.md` (new)
- `tests/map/map-build-streaming.test.js` (new)
- `tests/map/map-build-determinism.test.js` (new)
- `tests/map/map-build-heap-guard.test.js` (new)
- `tests/map/map-edge-aggregate-stability.test.js` (new)
- `tests/map/map-viewer-display-limits.test.js` (new)
- `tests/map/map-viewer-instancing-count.test.js` (new)
- `tests/map/map-viewer-culling-correctness.test.js` (new)
- `tests/map/map-viewer-lod-switch.test.js` (new)
- `tests/map/map-viewer-selection-stability.test.js` (new)
- `tests/map/map-viewer-telemetry.test.js` (new)

### Docs/specs to add or update
- `docs/perf/map-pipeline.md` (new)
- `docs/specs/map-artifact.md` (new; schema + determinism rules)

### Tasks
- [ ] **12.A Map build streaming + memory bounds**
- [x] Task 12.A.1: Define streaming writer in `src/map/build-map/io.js` that accepts async iterables and writes JSON in chunks without buffering full arrays.
- [x] Task 12.A.2: Refactor `build-map.js` pipeline to emit node/edge/symbol iterables and avoid materializing full graph arrays simultaneously.
- [x] Task 12.A.3: Add a build “spill” path for large graphs that writes partial node/edge sets to temp files, then merges deterministically.
- [x] Task 12.A.4: Add explicit max-bytes guardrails per section (nodes/edges/symbols) with actionable error messages.
- [x] Task 12.A.5: Preserve current output schema (same keys/ordering), but stream in a deterministic stable order.
- [x] Task 12.A.6: Add per-stage build telemetry (time, peak heap, row counts) and export into `docs/perf/map-pipeline.md`.
- [ ] **12.B Map build determinism + aggregation**
- [x] Task 12.B.1: Define canonical ordering rules for nodes, edges, and symbols (sort keys + tie-breakers).
- [x] Task 12.B.2: Precompute and serialize edge aggregates (counts, weights, min/max) so viewer doesn’t recompute per frame.
- [x] Task 12.B.3: Avoid duplicate string retention by interning common labels/paths in `normalize.js`.
- [x] Task 12.B.4: Ensure `build-map/filters.js` uses shared filters and avoids per-node allocations.
- [x] Task 12.B.5: Add deterministic hashing of map sections to detect mismatches between runs.
- [x] **12.C Viewer instancing + culling**
- [x] Task 12.C.1: Replace per-node mesh creation with instanced meshes in `meshes.js` and `scene.js`.
- [x] Task 12.C.2: Add frustum culling of node and edge instances with spatial buckets (grid or quadtree).
- [x] Task 12.C.3: Batch edge geometry updates and reuse buffers across frames.
- [x] Task 12.C.4: Add configurable max draw counts for nodes/edges/labels under load.
- [x] Task 12.C.5: Ensure selection/hover works with instanced IDs (stable mapping).
- [x] **12.D LOD + load shedding**
- [x] Task 12.D.1: Introduce LOD tiers for edges and labels (full, simplified, hidden).
- [x] Task 12.D.2: Switch LOD based on zoom level + frame budget + visible count.
- [x] Task 12.D.3: Throttle layout updates during high load and defer non-critical UI.
- [x] Task 12.D.4: Keep semantic selection (selected node/edge always visible).
- [x] **12.E Telemetry + profiling hooks**
- [x] Task 12.E.1: Add viewer FPS + dropped frame counters (`performance.now` + RAF deltas).
- [x] Task 12.E.2: Emit memory usage and active instance counts in `viewer-app.js`.
- [x] Task 12.E.3: Add a “perf HUD” toggle for debugging (dev only).
- [x] Task 12.E.4: Persist build metrics in map artifact metadata (non-breaking optional field).
- [x] **12.F Benchmarks + acceptance harness**
- [x] Task 12.F.1: Add `tools/bench/map/build-map-streaming.js` (baseline vs streaming).
- [x] Task 12.F.2: Add `tools/bench/map/build-map-memory.js` (peak heap, duration).
- [x] Task 12.F.3: Add `tools/bench/map/viewer-fps.js` (FPS under fixed scenario).
- [x] Task 12.F.4: Add `tools/bench/map/viewer-lod-stress.js` (LOD tiers, draw counts).
- [x] Task 12.F.5: Document how to run benchmarks and expected deltas in `docs/perf/map-pipeline.md`.
- [x] **12.G Sub-agent work packets**
- [x] Task 12.G.1: Sub-agent Packet A — Map build streaming + memory guards (Tasks 12.A.1–12.A.6).
- [x] Task 12.G.2: Sub-agent Packet B — Viewer instancing + culling (Tasks 12.C.1–12.C.5).
- [x] Task 12.G.3: Sub-agent Packet C — LOD + load shedding + telemetry (Tasks 12.D.1–12.E.4).
- [x] Task 12.G.4: Sub-agent Packet D — Benchmarks + docs (Tasks 12.F.1–12.F.5).

### Tests
- [x] `tests/map/map-build-streaming.test.js`
  - Success: stream writer emits identical JSON to prior build for small graphs.
- [x] `tests/map/map-build-determinism.test.js`
  - Success: identical input yields identical map output hashes across runs.
- [x] `tests/map/map-build-heap-guard.test.js`
  - Success: peak heap stays under threshold for medium fixture.
- [x] `tests/map/map-edge-aggregate-stability.test.js`
  - Success: aggregate counts/weights match pre-aggregate baseline.
- [x] `tests/map/map-viewer-display-limits.test.js`
  - Success: draw count caps engaged and UI remains responsive.
- [x] `tests/map/map-viewer-instancing-count.test.js`
  - Success: instanced meshes used; instance count matches node count.
- [x] `tests/map/map-viewer-culling-correctness.test.js`
  - Success: off-screen elements are culled; visible set is correct.
- [x] `tests/map/map-viewer-lod-switch.test.js`
  - Success: LOD tiers switch deterministically under zoom/load.
- [x] `tests/map/map-viewer-selection-stability.test.js`
  - Success: selected node remains visible and highlighted across LOD transitions.
- [x] `tests/map/map-viewer-telemetry.test.js`
  - Success: FPS/memory metrics emitted and within expected ranges.

---

## Phase 13 — Documentation + JSDoc

### Objective
Document the audit outputs and embeddings cache with clear JSDoc requirements.

### Goals
- Ensure docs and config inventories reflect new behavior.
- Require consistent JSDoc for new/shared modules.
- Comprehensively explain any "tricky" or complicated behaviors.
- Make docs discoverable and consistent with code contracts.
- Add explicit examples and invariants for sub-agent execution.

### Non-goals
- Writing new features beyond documentation and JSDoc standards.
- Rewriting unrelated legacy specs.
- Changing runtime behavior or schema just to align docs.

### Files to modify (exhaustive for this phase)
- `docs/perf/indexing-stage-audit.md`
- `docs/specs/embeddings-cache.md`
- `docs/contracts/indexing.md`
- `docs/contracts/artifact-contract.md`
- `docs/config/schema.json`
- `docs/config/contract.md`
- `docs/config/inventory.md`
- `docs/config/inventory.json`
- `docs/guides/commands.md`
- `docs/guides/jsdoc-standards.md` (new)
- `docs/guides/perfplan-execution.md` (new)
- `docs/guides/roadmap-checklists.md` (new)
- `docs/perf/map-pipeline.md`
- `docs/specs/map-artifact.md`
- `docs/specs/vfs-manifest-artifact.md`
- `docs/specs/vfs-index.md`
- `docs/specs/vfs-hash-routing.md`
- `docs/specs/vfs-token-uris.md`
- `docs/specs/vfs-io-batching.md`
- `docs/specs/vfs-segment-hash-cache.md`
- `docs/specs/vfs-cdc-segmentation.md`
- `docs/specs/vfs-cold-start-cache.md`
- `docs/specs/lsp-provider-hardening.md`
- `docs/specs/tooling-provider-registry.md`
- `docs/specs/tooling-vfs-and-segment-routing.md`
- `tests/tooling/docs/embeddings-cache-docs-sync.test.js` (new)

### Docs/specs to add or update
- `docs/perf/indexing-stage-audit.md`
- `docs/specs/embeddings-cache.md`
- `docs/contracts/indexing.md`
- `docs/contracts/artifact-contract.md`
- `docs/config/schema.json` + `docs/config/contract.md` + `docs/config/inventory.*`
- `docs/guides/commands.md`
- `docs/guides/jsdoc-standards.md` (new)
- `docs/guides/perfplan-execution.md` (new)
- `docs/guides/roadmap-checklists.md` (new)

### Doc inventory (Phase 13)
| Doc path | Purpose | Required sections | Code touchpoints | Tests | Gaps |
| --- | --- | --- | --- | --- | --- |
| `docs/perf/indexing-stage-audit.md` | Describe stage audit output + interpretation | Output locations, schema, stage list, counters, interpretation | `src/index/build/stage-checkpoints.js`, `src/index/build/perf-profile.js` | `tests/indexing/runtime/stage-memory-checkpoints.test.js`, `tests/indexing/runtime/stage-timing-checkpoints.test.js` | None |
| `docs/specs/embeddings-cache.md` | Global embeddings cache contract | Layout, keys, invalidation, compression, pruning, examples | `tools/build/embeddings/cache.js`, `src/shared/embeddings-cache/*`, `src/shared/embedding-identity.js` | `tests/indexing/embeddings/cache-*.test.js` | None |
| `docs/perf/map-pipeline.md` | Map build pipeline + perf guardrails | Inputs, pipeline steps, cache, outputs, determinism | `src/map/build-map.js`, `tools/reports/report-code-map.js` | `tests/indexing/map/*` | None |
| `docs/specs/map-artifact.md` | Map model schema + ordering | Schema, node/edge shapes, summary, truncation, determinism | `src/map/build-map.js`, `src/map/constants.js` | `tests/indexing/map/*` | None |
| `docs/specs/tooling-vfs-and-segment-routing.md` | VFS routing + path rules | Path format, offset mapping, disk-path safety, routing | `src/index/tooling/vfs*.js`, `src/index/build/artifacts/writers/vfs-manifest.js` | `tests/tooling/vfs/*` | None |
| `docs/specs/vfs-manifest-artifact.md` | VFS manifest artifact schema | Row schema, trim rules, sort order, meta fields | `src/index/build/artifacts/writers/vfs-manifest.js` | `tests/tooling/vfs/vfs-manifest*.test.js` | None |
| `docs/specs/tooling-provider-registry.md` | Provider registry keys + selection | Provider IDs, selection order, gating | `src/tooling/providers/*` | `tests/tooling/providers/*` | None |
| `docs/contracts/indexing.md` | Indexing contracts + artifacts | Build state, provenance, artifact list | `src/contracts/schemas/*` | `tests/indexing/contracts/*` | None |
| `docs/config/contract.md` + `docs/config/inventory.*` | Config surface + invariants | Keys, defaults, env/cli precedence | `src/shared/config.js`, `src/shared/env.js` | `tests/tooling/docs/config-inventory-sync.test.js` | None |
| `docs/guides/jsdoc-standards.md` | JSDoc requirements | Required tags, examples, determinism rules | `tests/tooling/docs/jsdoc-standards-sync.test.js` | `tests/tooling/docs/jsdoc-standards-sync.test.js` | None |
| `docs/guides/perfplan-execution.md` | How to execute PERFPLAN | Phase order, gating, test steps | `tests/tooling/docs/perfplan-docs-sync.test.js` | `tests/tooling/docs/perfplan-docs-sync.test.js` | None |
| `docs/guides/roadmap-checklists.md` | Checklist policy | Checkbox rules, timestamps, test logging | `tests/tooling/docs/roadmap-checklist-consistency.test.js` | `tests/tooling/docs/roadmap-checklist-consistency.test.js` | None |

### JSDoc requirements
- New/shared modules must document:
  - purpose + performance characteristics
  - input/output types and invariants
  - error behavior + side effects
  - determinism constraints and edge cases
  - cross-platform path handling expectations
  - cache invalidation rules (when applicable)
  - concurrency assumptions and thread-pool interactions

### Tests
- [x] `tests/tooling/docs/embeddings-cache-docs-sync.test.js`
- [x] `tests/tooling/docs/perfplan-docs-sync.test.js` (new)
- [x] `tests/tooling/docs/jsdoc-standards-sync.test.js` (new)
- [x] `tests/tooling/docs/config-inventory-sync.test.js` (new; verifies doc updates when CLI flags change)
- [x] `tests/tooling/docs/spec-links-valid.test.js` (new; ensures spec references resolve)
- [x] `tests/tooling/docs/roadmap-checklist-consistency.test.js` (new)

### Acceptance
- [x] Docs updated and referenced in commands/config inventories.
- [x] JSDoc standards documented and enforced for new modules.
- [x] Perfplan execution guide allows a sub-agent to execute phases without ambiguity.
- [x] Spec links and references are valid and consistent.

### Tasks
- [x] **13.A Inventory + gap analysis**
- [x] Task 13.A.1: Inventory all docs touched by Phases 0–12 and list missing sections (schemas, invariants, examples).
- [x] Task 13.A.2: Identify config/CLI changes that require inventory updates (schema, contract, commands).
- [x] Task 13.A.3: Audit for out-of-date references (renamed files, removed flags, new artifacts).
- [x] Task 13.A.4: Create a doc update checklist with explicit owners and completion criteria.

- [x] **13.B Embeddings cache spec hardening**
- [x] Task 13.B.1: Document cache layout (directory hierarchy, shard naming, metadata).
- [x] Task 13.B.2: Define cache key and invalidation rules (provider/model/dims/quantization/hash).
- [x] Task 13.B.3: Describe compression format, headers, and compatibility guarantees.
- [x] Task 13.B.4: Add examples for cache hits, partial reuse, and invalidation paths.

- [x] **13.C VFS + tooling spec alignment**
- [x] Task 13.C.1: Ensure VFS manifest specs match actual row trimming and sorting order.
- [x] Task 13.C.2: Add precise virtualPath encoding rules and disk-path safety constraints.
- [x] Task 13.C.3: Align token URI and hash routing docs with current code paths.
- [x] Task 13.C.4: Document cold-start cache and segment hash cache invariants.

- [x] **13.D CLI + contracts + inventories**
- [x] Task 13.D.1: Update `docs/contracts/indexing.md` and `docs/contracts/artifact-contract.md` for new artifacts/sidecars.
- [x] Task 13.D.2: Update `docs/guides/commands.md` to reflect new CLI flags or behaviors.
- [x] Task 13.D.3: Regenerate/update config inventories and explain any new fields in `docs/config/contract.md`.

- [x] **13.E JSDoc standards + enforcement**
- [x] Task 13.E.1: Write `docs/guides/jsdoc-standards.md` with mandatory tags and examples.
- [x] Task 13.E.2: Add rules for tricky behaviors (streaming, caching, determinism, path handling).
- [x] Task 13.E.3: Update touched modules with missing JSDoc blocks.

- [x] **13.F Execution guides**
- [x] Task 13.F.1: Add `docs/guides/perfplan-execution.md` describing how to execute phases in order.
- [x] Task 13.F.2: Add `docs/guides/roadmap-checklists.md` explaining checkbox rules and test logging.

- [x] **13.G Docs validation tests**
- [x] Task 13.G.1: Implement `tests/tooling/docs/embeddings-cache-docs-sync.test.js`.
- [x] Task 13.G.2: Add tests for spec link validation and checklist consistency.
- [x] Task 13.G.3: Add docs/config inventory sync test.

### Task details (decision-complete)
#### 13.A Inventory + gap analysis
- [x] Build a doc inventory table in Phase 13 with columns: doc path, purpose, required sections, code touchpoints, tests, gaps.
- [x] List docs touched by Phases 0-12 (use git history and PERFPLAN checklists as source of truth).
- [x] Enumerate missing sections for each doc: schema, invariants, examples, determinism, error behavior, compatibility.
- [x] Capture renamed files/flags/artifacts and link to the code that superseded them.
- [x] Output a checklist of required doc edits with explicit owners and completion criteria.

Doc update checklist (Phase 13.A.4):
- [x] `docs/specs/vfs-hash-routing.md` - Owner: tooling docs - Completion: hash routing path uses docHash with prefix and matches code.
- [x] `docs/specs/vfs-token-uris.md` - Owner: tooling docs - Completion: token derivation and URI format match LSP URI code.
- [x] `docs/specs/vfs-cold-start-cache.md` - Owner: tooling docs - Completion: cache validation, defaults, and testing behavior match code.
- [x] `docs/specs/vfs-segment-hash-cache.md` - Owner: tooling docs - Completion: in-memory LRU behavior and caps match code.
- [x] `docs/perf/map-pipeline.md` - Owner: perf docs - Completion: stage2 map pipeline steps documented.
- [x] `docs/specs/map-artifact.md` - Owner: perf docs - Completion: map schema matches current artifact writer.
- [x] `docs/perf/indexing-stage-audit.md` - Owner: perf docs - Completion: determinism guidance included.
- [x] `docs/contracts/indexing.md` - Owner: contracts docs - Completion: VFS artifacts and sidecars listed.
- [x] `docs/contracts/artifact-contract.md` - Owner: contracts docs - Completion: VFS artifacts and sidecars listed.
- [x] `docs/guides/commands.md` - Owner: docs - Completion: no Phase 13 flag changes; no update required.
- [x] `docs/config/contract.md` + `docs/config/inventory.*` - Owner: docs - Completion: VFS config surface already covered; no update required.

#### 13.B Embeddings cache spec hardening
- [x] Add a cache layout section with full directory tree, shard naming rules, and sidecars.
- [x] Document cache keys and invalidation rules (provider/model/dims/quantization/index signature/schema version).
- [x] Specify compression format(s), headers, and forward/backward compatibility rules.
- [x] Add examples for: cache hit, partial reuse, invalidation after config change.
- [ ] Touchpoints to review:
  - `src/shared/embeddings-cache/*`
  - `tools/build/embeddings/*`
  - `src/index/build/*` (cache reuse/write paths)

#### 13.C VFS + tooling spec alignment
- [x] Align VFS manifest trimming and sorting order with actual implementation (row trim, spill/merge order).
- [x] Document virtualPath encoding and disk-path safety constraints (including Windows specifics).
- [x] Align token URI and hash routing docs with current code.
- [x] Document cold-start cache and segment hash cache invariants (inputs, invalidation, fallbacks).
- [ ] Touchpoints to review:
  - `src/index/build/vfs-*`
  - `src/index/tooling/vfs*`
  - `src/index/segments/*` (CDC segmentation)

#### 13.D CLI + contracts + inventories
- [x] Update `docs/contracts/indexing.md` and `docs/contracts/artifact-contract.md` for new artifacts and sidecars.
- [x] Update `docs/guides/commands.md` for new flags or behavior (no Phase 13 deltas found).
- [x] Regenerate config inventories and add explanations for new fields in `docs/config/contract.md` (no Phase 13 deltas found).
- [x] Touchpoints to review:
  - `src/retrieval/cli*`
  - `src/index/build/*`
  - `tools/*` CLI entrypoints

#### 13.E JSDoc standards + enforcement
- [x] Write `docs/guides/jsdoc-standards.md` with required tags and examples.
- [x] Require sections for streaming behavior, caching/invalidation, determinism, path normalization, concurrency.
- [ ] JSDoc targets (Phase 13 + Quantum spindle work):
  - `src/shared/limits.js`
  - `src/shared/provenance.js`
  - `src/shared/truncation.js`
  - `src/shared/path-normalize.js`
  - `src/shared/time-format.js`
  - `src/shared/seed-ref.js`
  - `src/shared/bloom.js`
  - `src/shared/cache-roots.js`
  - `src/shared/metrics.js`
  - `src/shared/embeddings-cache/layout.js`
  - `src/shared/embeddings-cache/lru.js`
  - `src/shared/embedding-utils.js`
  - `src/shared/embedding-identity.js`
  - `tools/build/embeddings/cache.js`
  - `tools/build/embeddings/manifest.js`
  - `src/index/build/stage-checkpoints.js`
  - `src/retrieval/pipeline/stage-checkpoints.js`
  - `src/retrieval/query-plan-cache.js`
  - `src/retrieval/query-plan-schema.js`
  - `src/index/build/vfs-manifest-collector.js`
  - `src/index/build/vfs-segment-hash-cache.js`
  - `src/index/tooling/vfs-hash-routing.js`
  - `src/index/tooling/vfs-index.js`
  - `src/index/tooling/vfs.js`
  - `src/index/segments/cdc.js`

#### 13.F Execution guides
- [x] `docs/guides/perfplan-execution.md`: how to run phases, gating criteria, expected artifacts, failure triage.
- [x] `docs/guides/roadmap-checklists.md`: checkbox rules, test logging, ISO-8601 timestamp policy.

#### 13.G Docs validation tests
- [x] Add tests under `tests/tooling/docs/`:
  - `embeddings-cache-docs-sync`: ensure required sections and examples exist.
  - `perfplan-docs-sync`: ensure Phase 13 doc inventory table exists and references required docs.
  - `jsdoc-standards-sync`: ensure standards doc exists and includes required tags.
  - `spec-links-valid`: ensure spec references resolve.
  - `roadmap-checklist-consistency`: ensure checklist formatting/requirements.
  - `config-inventory-sync`: ensure config docs match schema.

---

## Phase 14 — Index Artifact Pipelines (State, Imports, Symbols, Postings, Relations, Chunk Meta)

### Objective
Reduce memory and IO overhead for index state writing, import resolution graphs, symbol artifacts, chargram postings, graph relations, and chunk metadata without changing schemas.

### Goals
- Minimize build_state read/modify/write overhead and avoid redundant writes.
- Reduce peak memory for import-resolution graphs and relation aggregation.
- Stream symbol occurrences/edges and chunk metadata without full-array materialization.
- Bound chargram postings growth and prevent unbounded memory spikes.
- Preserve deterministic output and schema compatibility for all artifacts.
- Add targeted microbenchmarks and guards for high‑volume artifacts.

### Non-goals
- Changing artifact schemas or output formats.
- Replacing the tokenizer or changing ranking semantics.
- Introducing new dependencies or native modules.
- Implementing SPIMI (tracked separately in `spimi_spec.md`).

### Files to modify (exhaustive for this phase)
- `src/index/build/build-state.js`
- `src/index/build/stage-checkpoints.js`
- `src/index/build/import-resolution.js`
- `src/index/build/indexer/steps/relations.js`
- `src/index/build/file-processor/relations.js`
- `src/index/build/graphs.js`
- `src/index/build/postings.js`
- `src/index/build/tokenization.js`
- `src/index/build/artifacts/helpers.js`
- `src/index/build/artifacts/graph-relations.js`
- `src/index/build/artifacts/writers/chunk-meta.js`
- `src/index/build/artifacts/writers/symbol-occurrences.js`
- `src/index/build/artifacts/writers/symbol-edges.js`
- `src/index/build/artifacts.js`
- `src/index/build/piece-assembly/merge.js`
- `src/index/validate.js`
- `docs/perf/index-artifact-pipelines.md` (new)
- `docs/specs/build-state.md` (new or update if exists)
- `docs/specs/import-resolution.md` (new)
- `docs/specs/symbol-occurrences.md` (new)
- `docs/specs/symbol-edges.md` (new)
- `docs/specs/chargram-postings.md` (new)
- `docs/specs/graph-relations.md` (new)
- `docs/specs/chunk-meta.md` (new)
- `tools/bench/index/build-state-write.js` (new)
- `tools/bench/index/import-resolution-graph.js` (new)
- `tools/bench/index/symbol-artifacts.js` (new)
- `tools/bench/index/chargram-postings.js` (new)
- `tools/bench/index/graph-relations.js` (new)
- `tools/bench/index/chunk-meta-stream.js` (new)
- `tools/bench/index/jsonl-offset-index.js` (new)
- `tools/bench/index/postings-packed.js` (new)
- `tools/bench/index/jsonl-compression-pipeline.js` (new)
- `tools/bench/index/import-graph-incremental.js` (new)
- `tests/indexing/build-state/build-state-debounce.test.js` (new)
- `tests/indexing/build-state/build-state-merge-consistency.test.js` (new)
- `tests/indexing/imports/import-resolution-cache.test.js` (new)
- `tests/indexing/imports/import-resolution-determinism.test.js` (new)
- `tests/indexing/imports/import-resolution-graph-cap.test.js` (new)
- `tests/indexing/symbols/symbol-occurrences-streaming.test.js` (new)
- `tests/indexing/symbols/symbol-edges-streaming.test.js` (new)
- `tests/indexing/symbols/symbol-artifacts-determinism.test.js` (new)
- `tests/indexing/postings/chargram-postings-memory-guard.test.js` (new)
- `tests/indexing/postings/chargram-postings-spill-merge.test.js` (new)
- `tests/indexing/relations/graph-relations-streaming.test.js` (new)
- `tests/indexing/relations/graph-relations-determinism.test.js` (new)
- `tests/indexing/chunk-meta/chunk-meta-streaming.test.js` (new)
- `tests/indexing/chunk-meta/chunk-meta-trim-order.test.js` (new)
- [x] `tests/indexing/chunk-meta/chunk-meta-ordering.test.js` (new)
- [x] `tests/indexing/artifacts/symbols/symbol-by-file-index.test.js` (new)

### Docs/specs to add or update
- `docs/perf/index-artifact-pipelines.md` (new)
- `docs/specs/build-state.md`
- `docs/specs/import-resolution.md`
- `docs/specs/import-graph-incremental.md` (new)
- `docs/specs/symbol-occurrences.md`
- `docs/specs/symbol-edges.md`
- `docs/specs/symbol-by-file-index.md` (new)
- `docs/specs/chargram-postings.md`
- `docs/specs/postings-packed.md` (new)
- `docs/specs/graph-relations.md`
- `docs/specs/chunk-meta.md`
- `docs/specs/artifact-offset-index.md` (new)
- `docs/specs/artifact-compression-pipeline.md` (new)

### Tasks
- [x] **14.A Foundations: shared streaming + determinism helpers**
- [x] Task 14.A.1: Add shared spill/merge helpers (K‑way heap + JSONL run writer) in `src/index/build/artifacts/helpers.js`.
- [x] Task 14.A.1.a: Reuse the VFS merge‑runs heap for row comparison and deterministic merge order.
- [x] Task 14.A.2: Add shared byte‑tracking helper to avoid repeated JSON.stringify for guards/telemetry.
- [x] Task 14.A.2.a: Provide `trackBytesForRow(row)` that accepts pre‑stringified rows to avoid double work.
- [x] Task 14.A.3: Centralize deterministic comparators for symbol rows, chunk meta rows, and graph relation rows.
- [x] Task 14.A.4: Add shared “trim stats” accumulator for artifact writers (rows dropped, bytes trimmed, max row bytes).
- [x] Task 14.A.5: Add a shared “artifact telemetry” helper that writes counts/bytes to stage checkpoints.

- [x] **14.B Build state writing + streaming**
- [x] Task 14.B.1: Add an in‑memory state cache with version checks to avoid re-reading `build_state.json` on every update.
- [x] Task 14.B.1.a: Cache last‑read state with `mtimeMs` + size fingerprint; invalidate on mismatch.
- [x] Task 14.B.1.b: Keep a per‑buildRoot cache object keyed by resolved path.
- [x] Task 14.B.2: Add a write debounce/merge window (e.g. 250–500ms) to coalesce bursts of updates.
- [x] Task 14.B.2.a: Make debounce window adaptive (short for CLI, longer for batch builds).
- [x] Task 14.B.2.b: Expose an explicit “flush now” hook for shutdown paths.
- [x] Task 14.B.3: Split large subtrees (e.g. stage checkpoints) into separate optional sidecar JSON files to reduce write volume.
- [x] Task 14.B.3.a: Add `build_state.stage-checkpoints.json` (per‑mode) and `build_state.progress.json`.
- [x] Task 14.B.3.b: Keep `build_state.json` minimal with references and updatedAt.
- [x] Task 14.B.4: Add per‑field “dirty” tracking so unchanged sections are not re‑serialized.
- [x] Task 14.B.4.a: Track dirty flags for `phases`, `progress`, `counts`, `signatures`, `stageCheckpoints`.
- [x] Task 14.B.4.b: Skip serialization for sections without dirty flag.
- [x] Task 14.B.5: Add a best‑effort append‑only event log (`build_state.events.jsonl`) for debugging without expanding the main file.
- [x] Task 14.B.5.a: Log `phase` transitions and checkpoint writes only.
- [x] Task 14.B.5.b: Cap log size and rotate by date/build id.
- [x] Task 14.B.6: Ensure `updateBuildState` remains atomic and safe across concurrent callers.
- [x] Task 14.B.6.a: Use the existing queue but ensure coalesced writes apply in order.
- [x] Task 14.B.6.b: Validate merged state includes schema + signature versions.
- [x] Task 14.B.7: Add a last‑write snapshot hash to skip no‑op writes.
- [x] Task 14.B.8: Add explicit shutdown flush in `startBuildHeartbeat` stop handler.
- [x] Task 14.B.9: Add append-only delta records for build_state writes with periodic compaction.
- [x] Task 14.B.9.a: Write `{op, path, value, ts}` deltas to `build_state.deltas.jsonl`.
- [x] Task 14.B.9.b: Add compaction job to rewrite a full snapshot when delta log exceeds a size threshold.
- [x] Task 14.B.9.c: Ensure compaction is atomic and never blocks primary writes.
- [x] Task 14.B.10: Add write-through cache for serialized checkpoint blocks to avoid re-stringify.
- [x] Task 14.B.10.a: Cache JSON strings per section keyed by snapshot hash + size.
- [x] Task 14.B.10.b: Invalidate on dirty flags or schema/version changes.

- [x] **14.C Import resolution graph performance**
- [x] Task 14.C.1: Cache resolved specifiers per importer + tsconfig hash to avoid repeated resolution.
- [x] Task 14.C.1.a: Cache negative lookups for specifiers that do not resolve.
- [x] Task 14.C.1.b: Include `paths`/`baseUrl` fingerprint in cache key.
- [x] Task 14.C.2: Add a fast path when `paths`/`baseUrl` are absent (skip tsconfig traversal).
- [x] Task 14.C.2.a: Detect “no tsconfig in root” once and reuse.
- [x] Task 14.C.3: Replace repeated `fs.existsSync` calls with a directory cache + file lookup map.
- [x] Task 14.C.3.a: Build a `Set` of repo‑relative paths from scan to avoid syscalls.
- [x] Task 14.C.4: Precompute extension candidates and normalize only once per specifier.
- [x] Task 14.C.4.a: Normalize specifiers at parse time and reuse (trim/query/hash removed once).
- [x] Task 14.C.5: Keep graph node/edge caps deterministic; record when caps drop edges.
- [x] Task 14.C.5.a: Record capped count by edge type (imports/usage/calls).
- [x] Task 14.C.6: Emit import‑graph telemetry (nodes, edges, capped count, warnings).
- [x] Task 14.C.6.a: Add telemetry into stage checkpoints for stage2.
- [x] Task 14.C.7: Add a path-segment trie cache for rapid “exists” prefix checks.
- [x] Task 14.C.7.a: Reuse trie to short-circuit repeated path joins under common roots.
- [x] Task 14.C.8: Add negative cache TTL so new files are eventually re-checked.
- [x] Task 14.C.8.a: Evict negative entries after a short window (e.g. 30–60s).
- [x] Task 14.C.9: Precompile `paths`/`baseUrl` matchers into regexes for faster specifier resolution.
- [x] Task 14.C.9.a: Cache compiled matchers per tsconfig fingerprint.

- [x] **14.D Chunk meta streaming**
- [x] Task 14.D.1: Move chunk meta emission to a streaming writer fed from the file processor.
- [x] Task 14.D.1.a: Emit JSONL rows as chunks are finalized.
- [x] Task 14.D.2: Apply `compactChunkMetaEntry` on the fly; avoid holding full `metaV2` in memory.
- [x] Task 14.D.2.a: Track trimmed fields in a per‑artifact stats block.
- [x] Task 14.D.3: Preserve canonical docId ordering even when processing order changes.
- [x] Task 14.D.3.a: Add `canonicalOrderIndex` from discovery order and keep processing reorder separate.
- [x] Task 14.D.3.b: Ensure `orderedAppender` uses canonical order for docId assignment.
- [x] Task 14.D.3.c: Add optional windowed batching to cap pending buffers when processing order diverges.
- [x] Task 14.D.3.d: Detect out‑of‑order chunk_meta stream; only enable external sort when needed.
- [x] Task 14.D.3.e: External sort by numeric `id` only to preserve docId alignment.
- [x] Task 14.D.3.f: Stream JSONL directly when already ordered (skip spill collector).
- [x] Task 14.D.3.g: Emit chunk_meta ordering telemetry in stage checkpoints.
- [x] Task 14.D.3.h: Add docId alignment guardrails and verification in tests.
- [x] Task 14.D.3.i: Add bucketed external sort by `id` range to avoid full compare sort.
- [x] Task 14.D.3.j: Log the first out‑of‑order pair (prevId/nextId) for diagnostics.
- [x] Task 14.D.3.k: Add ID‑only spill index to re‑order without re‑serializing rows.
- [x] Task 14.D.3.l: Cache JSONL row strings when measuring to avoid double stringify in sorting paths.
- [x] Touchpoints 14.D.3: `src/index/build/indexer/steps/discover.js`, `src/index/build/indexer/steps/process-files/tree-sitter.js`, `src/index/build/indexer/steps/process-files/ordered.js`, `src/index/build/artifacts/writers/chunk-meta.js`, `src/index/build/artifacts/helpers.js`, `src/index/validate/checks.js`.
- [x] Task 14.D.4: Track trimming stats (what fields were dropped) in build state.
- [x] Task 14.D.5: Add strict mode test to ensure no trimming occurs on small fixtures.
- [x] Task 14.D.6: Add optional columnar chunk_meta format with boundary conversion to row objects.
- [x] Task 14.D.6.a: Keep compatibility loader that inflates columnar arrays to row objects on demand.
- [x] Task 14.D.6.b: Add config switch + manifest flag for columnar chunk_meta.

- [x] **14.E Symbol occurrences + edges streaming**
- [x] Task 14.E.1: Replace `buildRows` full arrays with streaming iterators over chunks.
- [x] Task 14.E.1.a: Emit rows per chunk; avoid storing all rows in memory.
- [x] Task 14.E.2: Preserve deterministic ordering by sorting per‑chunk and emitting in chunk order.
- [x] Task 14.E.2.a: If chunk order is unstable, add external merge sort by `(file, chunkUid, role/type, targetName)`.
- [x] Task 14.E.3: Add optional spill files for large symbol artifact sets; merge via heap.
- [x] Task 14.E.3.a: Reuse shared spill/merge helper from 14.A.1.
- [x] Task 14.E.4: Track trimming stats (rows dropped/trimmed, max bytes) in stage checkpoints.
- [x] Task 14.E.4.a: Add per‑artifact meta extension with trim counts.
- [x] Task 14.E.5: Ensure trimming preserves required fields (`host`, `role`, `ref`).
- [x] Task 14.E.6: Skip trim work when row byte size is below threshold (avoid repeated JSON.stringify).
- [x] Task 14.E.7: Add optional columnar JSONL format for symbol occurrences/edges.
- [x] Task 14.E.7.a: Convert to row objects at boundaries only (loaders + CLI).
- [x] Task 14.E.8: Add canonical string tables for symbol names/roles/kinds to reduce repetition.
- [x] Task 14.E.8.a: Store string tables in meta and reference by index in rows.

- [x] **14.F Graph relations streaming + measurement**
- [x] Task 14.F.1: Avoid full `graphRelations` materialization for large graphs; stream into JSONL shards.
- [x] Task 14.F.1.a: Build iterator directly from `relations` inputs in `graphs.js`.
- [x] Task 14.F.2: Replace JSON stringify measurement with incremental byte tracking per edge/node.
- [x] Task 14.F.2.a: Track bytes as rows are emitted (no re‑stringify).
- [x] Task 14.F.3: Add deterministic ordering for graph sections and keys.
- [x] Task 14.F.3.a: Define stable graph name ordering + edge ordering rules.
- [x] Task 14.F.4: Record relation counts and caps in `graph_relations.meta.json` extensions.
- [x] Task 14.F.4.a: Include dropped edge counts and cap reasons.
- [x] Task 14.F.5: Add CSR-style adjacency format for graph relations (offsets + edge list).
- [x] Task 14.F.5.a: Keep JSONL output for compatibility and emit CSR as optional artifact.
- [x] Task 14.F.6: Add byte-budgeted streaming caps for graph_relations to avoid runaway growth.
- [x] Task 14.F.6.a: Record precise drop counts and cap thresholds per graph.

- [x] **14.G Chargram postings memory bounds**
- [x] Task 14.G.1: Reuse per‑chunk chargram buffers/sets to avoid allocations.
- [x] Task 14.G.1.a: Maintain a reusable Set and clear it per chunk.
- [x] Task 14.G.2: Add a spill/merge path for chargram postings when `triPost` exceeds a memory threshold.
- [x] Task 14.G.2.a: Spill vocab fragments to sorted JSONL shards, merge via K‑way heap.
- [x] Task 14.G.2.b: Keep deterministic vocab ordering across spills.
- [x] Task 14.G.3: Keep output ordering stable (sorted vocab, deterministic postings order).
- [x] Task 14.G.4: Add instrumentation: max unique chargrams, dropped tokens, spill count.
- [x] Task 14.G.4.a: Emit guard counters into stage checkpoints.
- [x] Task 14.G.5: Add guardrails for `chargramMaxTokenLength` and `chargramMaxN` to avoid runaway growth.
- [x] Task 14.G.6: Add “no‑chargram” short‑circuit for files with empty field tokens.
- [x] Task 14.G.7: Add rolling hash/sliding window chargram generator to reduce allocations.
- [x] Task 14.G.7.a: Implement a reusable buffer to avoid substring allocations per token.
- [x] Task 14.G.8: Add df-based cutoff for high-frequency chargrams to bound postings growth.
- [x] Task 14.G.8.a: Track dropped high-df chargrams in stage checkpoints.

- [x] **14.H Benchmarks + acceptance harness**
- [x] Task 14.H.1: Implement `tools/bench/index/build-state-write.js` comparing baseline vs debounced writes.
- [x] Task 14.H.1.a: Emit JSON summary with p50/p95 latency and write counts + delta.
- [x] Task 14.H.2: Implement `tools/bench/index/import-resolution-graph.js` for nodes/edges throughput.
- [x] Task 14.H.2.a: Report node/edge counts and cap triggers; include seed and baseline delta.
- [x] Task 14.H.3: Implement `tools/bench/index/symbol-artifacts.js` to compare streaming vs baseline.
- [x] Task 14.H.3.a: Include memory watermark and output hash compare.
- [x] Task 14.H.4: Implement `tools/bench/index/chargram-postings.js` to measure memory + throughput.
- [x] Task 14.H.4.a: Include spill count and vocab size metrics + baseline delta.
- [x] Task 14.H.5: Implement `tools/bench/index/graph-relations.js` for JSONL shard throughput.
- [x] Task 14.H.5.a: Report bytes/sec and shard counts + baseline delta.
- [x] Task 14.H.6: Implement `tools/bench/index/chunk-meta-stream.js` for chunk_meta memory.
- [x] Task 14.H.6.a: Include trim stats and output hash + baseline delta.
- [x] Task 14.H.7: Document how to run benchmarks and expected deltas in `docs/perf/index-artifact-pipelines.md`.
- [x] Task 14.H.8: Implement `tools/bench/index/jsonl-offset-index.js` for random-access lookups.
- [x] Task 14.H.8.a: Compare baseline scan vs offset index (p50/p95 row fetch latency).
- [x] Task 14.H.9: Implement `tools/bench/index/postings-packed.js` to compare JSON vs packed postings.
- [x] Task 14.H.9.a: Report size ratio + load time delta for token/phrase/chargram postings.
- [x] Task 14.H.10: Implement `tools/bench/index/jsonl-compression-pipeline.js` for write throughput.
- [x] Task 14.H.10.a: Compare sync write vs worker compression (wall time + CPU).
- [x] Task 14.H.11: Implement `tools/bench/index/import-graph-incremental.js` for incremental rebuilds.
- [x] Task 14.H.11.a: Report reuse ratio (cached vs recomputed) + total time delta.

- [x] **14.I Artifact access + write acceleration**
- [x] Task 14.I.1: Add byte‑offset indexes for JSONL artifacts (chunk_meta, symbols, symbol_occurrences, symbol_edges, graph_relations, call_sites).
- [x] Task 14.I.1.a: Emit offsets during JSONL write (no second pass); store `offsets.bin` (uint64 LE) + `offsets.meta.json`.
- [x] Task 14.I.1.b: For compressed shards, either keep raw JSONL alongside compressed or use seekable zstd frames; document fallback (offsets require uncompressed output).
- [x] Task 14.I.1.c: Add loader utilities for fast row fetch by index (single read + JSON.parse).
- [x] Task 14.I.1.d: Keep offsets in monotonically increasing order; validate last offset + row length against file size.
- [x] Task 14.I.2: Add per‑file symbol row indexes for `symbol_occurrences`/`symbol_edges`.
- [x] Task 14.I.2.a: Resolve `fileId` while streaming (via host chunkUid -> chunk_meta -> fileId); accumulate row offsets per file.
- [x] Task 14.I.2.b: Store per‑file offset lists in packed varint arrays with a small JSON meta.
- [x] Task 14.I.2.c: Add fast path in tooling to load per‑file rows without scanning all parts.
- [x] Task 14.I.2.d: Keep per‑file offset lists sorted by row index to preserve deterministic output.
- [x] Task 14.I.3: Add write batching + worker thread compression for JSONL artifacts.
- [x] Task 14.I.3.a: Buffer rows into fixed-size byte blocks (e.g., 1–4MB) before writing.
- [x] Task 14.I.3.b: Compress blocks in a bounded worker pool; preserve output ordering.
- [x] Task 14.I.3.c: Backpressure when compression lags to avoid unbounded memory.
- [x] Task 14.I.3.d: Prefer zstd (seekable frames) for large shards; fall back to gzip where required.
- [x] Task 14.I.4: Add packed postings format (delta+varint) for docId lists.
- [x] Task 14.I.4.a: Encode docId deltas + tf counts in a binary blob with offsets per token.
- [x] Task 14.I.4.b: Keep JSON as fallback; loader prefers packed when present.
- [x] Task 14.I.4.c: Use block-encoded varints (e.g., 128/256 doc blocks) to balance decode speed + compression.
- [x] Task 14.I.5: Add incremental import‑graph refresh.
- [x] Task 14.I.5.a: Persist per‑file resolution results keyed by file hash + tsconfig fingerprint.
- [x] Task 14.I.5.b: Invalidate cache on tsconfig/package.json/paths changes; reuse for unchanged files.
- [x] Task 14.I.5.c: Track reuse ratio + invalidations in stage checkpoints for tuning.
- [x] Touchpoints 14.I: `src/index/build/artifacts/writers/*.js`, `src/shared/artifact-io/*.js`, `src/index/build/import-resolution-graph.js`, `src/index/build/indexer/steps/discover.js`, `src/index/build/indexer/steps/process-files/ordered.js`, `src/retrieval/*` loaders.

### Tests
- [ ] `tests/indexing/build-state/build-state-debounce.test.js`
  - Success: multiple rapid updates coalesce into a single write.
- [ ] `tests/indexing/build-state/build-state-sidecars.test.js` (new)
  - Success: stage checkpoint sidecars are written and referenced without expanding main build_state.
- [ ] `tests/indexing/build-state/build-state-event-log-rotation.test.js` (new)
  - Success: events JSONL rotates/caps as configured and never blocks build_state writes.
- [ ] `tests/indexing/build-state/build-state-noop-write.test.js` (new)
  - Success: no-op updates skip disk writes (mtime unchanged).
- [ ] `tests/indexing/build-state/build-state-merge-consistency.test.js`
  - Success: concurrent updates do not lose fields or corrupt state.
- [ ] `tests/indexing/build-state/build-state-delta-compaction.test.js` (new)
  - Success: delta logs compact into identical snapshots.
- [ ] `tests/indexing/build-state/build-state-cache-reuse.test.js` (new)
  - Success: cached sections avoid repeat serialization unless dirty.
- [ ] `tests/indexing/imports/import-resolution-cache.test.js`
  - Success: cached resolutions match baseline outputs.
- [ ] `tests/indexing/imports/import-resolution-negative-cache.test.js` (new)
  - Success: negative cache avoids repeated fs checks while preserving output.
- [ ] `tests/indexing/imports/import-resolution-no-tsconfig-fastpath.test.js` (new)
  - Success: fast path used when no tsconfig exists (same graph, fewer stats).
- [ ] `tests/indexing/imports/import-resolution-determinism.test.js`
  - Success: identical inputs produce identical import graphs.
- [ ] `tests/indexing/imports/import-resolution-graph-cap.test.js`
  - Success: cap enforcement is deterministic and logged.
- [ ] `tests/indexing/imports/import-resolution-trie-cache.test.js` (new)
  - Success: trie cache reduces fs hits without changing graph output.
- [ ] `tests/indexing/imports/import-resolution-negative-ttl.test.js` (new)
  - Success: negative cache expires and detects new files.
- [ ] `tests/indexing/imports/import-resolution-regex-cache.test.js` (new)
  - Success: precompiled matchers produce identical resolutions.
- [x] `tests/indexing/imports/import-graph-incremental-reuse.test.js` (new)
  - Success: unchanged files reuse cached resolutions; graph output identical.
- [ ] `tests/indexing/symbols/symbol-occurrences-streaming.test.js`
  - Success: streaming output matches baseline JSONL content.
- [ ] `tests/indexing/symbols/symbol-edges-streaming.test.js`
  - Success: streaming output matches baseline JSONL content.
- [ ] `tests/indexing/symbols/symbol-artifacts-determinism.test.js`
  - Success: stable ordering and identical hashes across runs.
- [ ] `tests/indexing/symbols/symbol-occurrences-spill-merge.test.js` (new)
  - Success: spill+merge output equals baseline order + hash.
- [ ] `tests/indexing/symbols/symbol-edges-spill-merge.test.js` (new)
  - Success: spill+merge output equals baseline order + hash.
- [ ] `tests/indexing/symbols/symbol-columnar-roundtrip.test.js` (new)
  - Success: columnar symbol rows inflate to baseline row objects.
- [ ] `tests/indexing/symbols/symbol-string-table.test.js` (new)
  - Success: string table indices resolve to original values.
- [ ] `tests/indexing/symbols/symbol-by-file-index.test.js` (new)
  - Success: per-file offset index returns the same rows as full scan.
- [ ] `tests/indexing/postings/chargram-postings-memory-guard.test.js`
  - Success: memory guard triggers spill without changing output.
- [ ] `tests/indexing/postings/chargram-postings-spill-merge.test.js`
  - Success: spill+merge output equals baseline in deterministic order.
- [ ] `tests/indexing/postings/chargram-postings-determinism.test.js` (new)
  - Success: vocab ordering + postings are stable across runs.
- [ ] `tests/indexing/postings/chargram-rolling-hash.test.js` (new)
  - Success: rolling chargram generator matches baseline tokens.
- [ ] `tests/indexing/postings/chargram-df-cutoff.test.js` (new)
  - Success: high‑df chargrams are dropped and reported without corrupting postings.
- [x] `tests/indexing/postings/postings-packed-roundtrip.test.js` (new)
  - Success: packed postings decode to the same JSON postings.
- [ ] `tests/indexing/postings/postings-packed-size.test.js` (new)
  - Success: packed size is smaller than JSON for large vocab.
- [ ] `tests/indexing/relations/graph-relations-streaming.test.js`
  - Success: streaming JSONL output matches baseline graph_relations.
- [ ] `tests/indexing/relations/graph-relations-determinism.test.js`
  - Success: deterministic ordering and stable metadata.
- [ ] `tests/indexing/relations/graph-relations-bytes-tracking.test.js` (new)
  - Success: byte counters match JSONL size without re-stringify.
- [ ] `tests/indexing/relations/graph-relations-csr-roundtrip.test.js` (new)
  - Success: CSR adjacency loads to equivalent node/edge sets.
- [ ] `tests/indexing/relations/graph-relations-byte-budget.test.js` (new)
  - Success: caps drop edges deterministically and report counts.
- [ ] `tests/indexing/relations/jsonl-offset-index.test.js` (new)
  - Success: row fetch via offsets matches baseline scan.
- [ ] `tests/indexing/chunk-meta/chunk-meta-streaming.test.js`
  - Success: JSONL output matches baseline for medium fixture.
- [ ] `tests/indexing/chunk-meta/chunk-meta-trim-order.test.js`
  - Success: trimming preserves required fields and order.
- [ ] `tests/indexing/chunk-meta/chunk-meta-external-sort.test.js` (new)
  - Success: external sort restores deterministic order when chunk IDs are shuffled.
- [ ] `tests/indexing/chunk-meta/chunk-meta-canonical-order.test.js` (new)
  - Success: docId alignment holds even when processing order changes.
- [ ] `tests/indexing/chunk-meta/chunk-meta-out-of-order-detection.test.js` (new)
  - Success: ordered streams skip sort; shuffled streams enable id‑sort.
- [ ] `tests/indexing/chunk-meta/chunk-meta-jsonl-shard-order.test.js` (new)
  - Success: sharded JSONL preserves id order across parts.
- [ ] `tests/indexing/chunk-meta/chunk-meta-bucketed-sort.test.js` (new)
  - Success: bucketed id sort matches full sort output with fewer allocations.
- [ ] `tests/indexing/chunk-meta/chunk-meta-id-index-reorder.test.js` (new)
  - Success: ID‑only spill index produces identical output without re‑stringify.
- [ ] `tests/indexing/chunk-meta/chunk-meta-columnar-roundtrip.test.js` (new)
  - Success: columnar format inflates to row objects equivalent to baseline.
- [ ] `tests/indexing/chunk-meta/chunk-meta-offset-index.test.js` (new)
  - Success: chunk_meta row fetch via offsets matches baseline scan.
- [ ] `tests/indexing/artifacts/jsonl-compression-pipeline-order.test.js` (new)
  - Success: worker compression preserves row order and checksums.

### Acceptance
- [ ] Build state writes are coalesced and deterministic.
- [ ] Build state delta logs compact cleanly without blocking writes.
- [ ] Import resolution graphs are faster and use less memory with the same output.
- [ ] Import resolution caches (trie + regex + negative TTL) reduce syscalls without changing results.
- [ ] Incremental import-graph refresh reuses cached resolutions for unchanged files.
- [ ] Symbol occurrences/edges and chunk meta stream without large intermediate arrays.
- [ ] Symbol artifacts optionally support columnar output + string tables with identical semantics.
- [ ] Chunk meta ordering preserves docId alignment regardless of processing order.
- [ ] Chargram postings are bounded by memory guards and retain deterministic output.
- [ ] Chargram postings drop high‑df entries deterministically when configured.
- [ ] Graph relations write paths scale to large repos with sharded JSONL.
- [ ] Graph relations CSR format round‑trips to the same node/edge sets.
- [ ] JSONL offset indexes enable fast random access without full scans.
- [ ] Packed postings are smaller and load faster than JSON in benchmarks.
- [ ] Worker compression preserves row order and checksums while reducing wall time.
- [ ] Benchmarks show measurable gains (baseline vs current deltas captured) and are documented.

### Commit Review (21-40)
- 0f4f4b5c Track chunk_meta trim stats and symbol trim metadata: Regression risk: `resolveChunkMetaOrder` is no longer used, so non-JSONL `chunk_meta` output can become non-deterministic when chunk order is unstable.
- 7e3bfe8e Optimize import resolution graph: Potential regression: skips tsconfig lookup entirely when `tsconfig.json` is not present in the scanned entries; if tsconfig exists but is excluded from entries, `paths`/`baseUrl` resolution is silently disabled.
- 9c1b2d07 Artifacts: fallback chunk_meta + pragma threshold: Potential perf regression if `inputBytes` is missing/0; build pragmas/optimize default to off, even for large builds.
- 3708b325 Stabilize test runner output and tooling fixtures: Potential regression: Swift signatures without explicit return types no longer default to `Void`, which may drop return types in type inference.
- 05e2c83c Fix LSP param type enrichment for clangd: Gap: `mergeSignatureInfo` only adopts `paramTypes` when none exist, so hover results cannot fill missing parameter types for partial signatures.

### Commit Review (41-60)
- 421cc4d9 Implement VFS tokens, coalescing, and CDC segmentation: Gap: token cache in `src/integrations/tooling/lsp/uris.js` is unbounded and never evicted, so long-running sessions can grow memory with many unique virtual paths.
- 75d70209 docs: absorb lexicon drafts into LEXI: Gap: lexicon draft specs were deleted from `future/lexi/*` instead of archived under `docs/archived` per the spec deprecation process.
- 7d3d3f4b Groan improvement (#46): Potential regression: tool script paths were renamed without compatibility shims (e.g. `tools/download-dicts.js` -> `tools/download/dicts.js`), so external automation using old paths will break.

---

### Commit Review (Last 20 commits on QUANTUM-SPINDLE)
- a3644d3d Add columnar chunk_meta support — New `columnar` artifact format is not documented in `docs/contracts/*` or artifact schema allowlists; update artifact contract/schemas and docs to include `.columnar.json` and format enum.
- 602ef1bd Add columnar symbol artifacts — New `symbolArtifactsFormat` config and `.columnar.json` outputs are not reflected in `docs/config/schema.json` / inventory or artifact contract docs; add config surface + contract updates.
- 9567fe0c Optimize chargram generation and drop high-df terms — Added `chargramMaxDf` config without docs/config schema + inventory updates; decide whether public (document) or internal (hide/rename).

---

## Phase 15 — Index State + File Meta + JSON Artifact Perf

### Objective
Reduce serialization/IO cost for index_state, file_meta, minhash_signatures, and other JSON artifacts while preserving determinism and schema compatibility.

### Goals
- Skip redundant writes and reduce JSON stringify overhead.
- Stream or pack large artifacts to keep peak memory bounded.
- Provide benchmarks proving size/throughput improvements.

### Non-goals
- Changing query semantics or public API behavior.
- Removing existing artifacts without a documented fallback.

### Files to modify (exhaustive for this phase)
- `src/index/build/artifacts.js`
- `src/index/build/artifacts/file-meta.js`
- `src/index/build/postings.js`
- `src/index/build/build-state.js`
- `src/index/build/artifacts/writer.js`
- `src/shared/json-stream.js`
- `src/shared/artifact-io/loaders.js`
- `src/shared/artifact-io/compression.js`
- `src/storage/sqlite/build/from-artifacts.js`
- `docs/perf/index-state-file-meta.md` (new)
- `tools/bench/index/index-state-write.js` (new)
- `tools/bench/index/file-meta-compare.js` (new)
- `tools/bench/index/minhash-packed.js` (new)

### Docs/specs to add or update
- `docs/perf/index-state-file-meta.md` (new)

### Tasks
- [x] **15.4 JSON artifact streaming + compression**
- [x] Task 15.4.a: Use size‑based sharding in `createArtifactWriter` (byte budgets, not row counts).
- [x] Task 15.4.b: Extend per‑artifact compression config and default zstd for large artifacts.
- [x] Task 15.4.c: Add write‑path metrics (bytes, rows, wall time) per artifact.
Details: Touchpoints `src/index/build/artifacts/writer.js`, `src/index/build/artifacts/helpers.js`, `src/shared/json-stream.js`, `src/shared/artifact-io/compression.js`. Implementation notes: enforce byte budgets before allocating buffers; record artifact sizes in build state or perf profile; keep compression opt-in per artifact to avoid regressions.

- [x] **15.6 Discovery + file list reuse**
- [x] Task 15.6.a: Emit a stable discovery file list with file hashes to power file_meta and avoid per‑chunk scans.
- [x] Task 15.6.b: Persist discovery list hash for incremental reuse.
Details: Touchpoints `src/index/build/indexer/steps/discover.js`, `src/index/build/state.js`.

- [x] **15.7 Chunk-to-file metadata reuse**
- [x] Task 15.7.a: Maintain chunkUid -> fileId map during chunk creation instead of rescan in artifacts.
- [x] Task 15.7.b: Record per-file aggregate metadata once per file rather than per chunk.
Details: Touchpoints `src/index/build/indexer/steps/process-files.js`, `src/index/build/artifacts.js`.

- [x] **15.1 Index state write optimization**
- [x] Task 15.1.a: Skip index_state writes when a comparable hash is unchanged (cache last hash by buildRoot).
- [x] Task 15.1.b: Split stable vs volatile sections and only re‑serialize volatile on incremental updates.
- [x] Task 15.1.c: Add size instrumentation and warn when index_state grows beyond a soft threshold.
- [x] Task 15.1.d: Allow compression for index_state when over threshold (zstd preferred).
Details: Touchpoints `src/index/build/indexer/steps/write.js`, `src/index/build/artifacts.js`, `src/shared/json-stream.js`. Implementation notes: compute a comparable hash that ignores `generatedAt` and other volatile fields; write a sidecar cache to skip redundant writes; keep schema compatibility by storing stable+volatile sections under existing top-level keys.

- [x] **15.2 File meta construction + storage**
- [x] Task 15.2.a: Build file_meta from fileInfoByPath (or file list) without per‑chunk scans when available.
- [x] Task 15.2.b: Add string‑table/columnar option for file_meta to reduce repeated file strings.
- [x] Task 15.2.c: Switch to JSONL + sharding for large file_meta outputs (size‑based).
- [x] Task 15.2.d: Cache file_meta across incremental builds when file hash list is unchanged.
Details: Touchpoints `src/index/build/artifacts/file-meta.js`, `src/index/build/artifacts.js`, `src/shared/artifact-io/loaders.js`, `src/storage/sqlite/build/from-artifacts.js`. Implementation notes: prefer `state.fileInfoByPath` + discovery file list; keep stable fileId ordering by sorted path list; emit `file_meta` columnar format only when size exceeds threshold; add a metadata hash to allow incremental reuse.

- [x] **15.3 Minhash signatures packing**
- [x] Task 15.3.a: Write packed binary minhash signatures (uint32 deltas or fixed‑width) with offsets + meta JSON.
- [x] Task 15.3.b: Prefer packed load path; keep JSON fallback for compatibility.
- [x] Task 15.3.c: Stream minhash rows during build to avoid full in‑memory arrays.
- [x] Task 15.3.d: Add a max‑docs guard to skip minhash when the corpus is too large (configurable).
Details: Touchpoints `src/index/build/postings.js`, `src/index/build/artifacts.js`, `src/shared/artifact-io/loaders.js`, `src/storage/sqlite/build/from-artifacts.js`, `src/retrieval/cli-index.js`. Implementation notes: keep JSON artifact for back-compat; packed format should include endian flag + width metadata; use streaming writer for minhash rows during build; document the guard behavior in perf doc.

- [x] **15.5 Build state sidecar tuning**
- [x] Task 15.5.a: Coalesce build_state sidecar writes using a size‑aware debounce.
- [x] Task 15.5.b: Optionally compress event/delta JSONL logs when they exceed a cap.
Details: Touchpoints `src/index/build/build-state.js`, `src/shared/json-stream.js`. Implementation notes: base debounce on serialized byte size; rotate logs before compression; keep logs readable in small builds.

### Touchpoints (indexing process review)
- `src/index/build/indexer/steps/discover.js`
- `src/index/build/indexer/steps/process-files.js`
- `src/index/build/indexer/steps/relations.js`
- `src/index/build/indexer/steps/postings.js`
- `src/index/build/indexer/steps/write.js`
- `src/index/build/state.js`
- `src/index/build/artifacts.js`
- `src/index/build/artifacts/file-meta.js`
- `src/index/build/postings.js`
- `src/shared/artifact-io/loaders.js`
- `src/shared/json-stream.js`

### Additional Tasks (indexing pipeline opportunities)
- [x] **15.8 Postings memory guards**
- [x] Task 15.8.a: Skip minhash emission when `minhashMaxDocs` is exceeded and record a guard event.
- [x] Task 15.8.b: Ensure chargram/phrase spill thresholds are enforced by bytes, not only counts.
Details: Touchpoints `src/index/build/postings.js`, `src/index/build/state.js`.

### Benchmarks
- [x] `tools/bench/index/index-state-write.js`
  - Baseline: always write; Current: skip unchanged hash.
  - Report: total time, write count, delta %, bytes written.
- [x] `tools/bench/index/file-meta-compare.js`
  - Baseline: current JSON array; Current: string‑table/JSONL or columnar.
  - Report: file count, bytes, parse time, delta %.
- [x] `tools/bench/index/minhash-packed.js`
  - Baseline: JSON signatures; Current: packed binary.
  - Report: size ratio, load time, delta %.

### Tests
- [x] `tests/indexing/artifacts/index-state-skip-write.test.js` (new)
  - Success: unchanged index_state does not update mtime.
- [x] `tests/indexing/artifacts/file-meta-stable-ids.test.js` (new)
  - Success: file_id mapping is stable across incremental builds.
- [x] `tests/indexing/artifacts/file-meta-columnar-roundtrip.test.js` (new)
  - Success: columnar/string‑table inflates to baseline rows.
- [x] `tests/indexing/artifacts/minhash-packed-roundtrip.test.js` (new)
  - Success: packed signatures decode to baseline JSON arrays.
- [x] `tests/indexing/artifacts/minhash-max-docs-guard.test.js` (new)
  - Success: minhash is skipped when size guard triggers, without breaking validation.

### Acceptance
- [x] index_state writes are skipped when unchanged and instrumented.
- [x] file_meta writes are smaller and bounded (string‑table/JSONL for large repos).
- [x] minhash signatures use packed format by default, with JSON fallback.
- [x] JSON artifact writer uses byte‑based sharding and per‑artifact compression.
- [x] Benchmarks show measurable improvements and are documented.

---

# WOODROADMAP - Native-Only Tree-sitter Scheduler

## Snapshot
- Last rewritten: 2026-02-09T14:19:26.9703540-05:00
- Branch intent: remove WASM tree-sitter entirely and standardize indexing on native tree-sitter grammars only.
- Current branch state: native grammar support is implemented for all target scheduler languages.

## State Assessment

### What is already done (committed)
- Native runtime exists and is integrated into chunking on Windows for mapped grammars.
- Native grammar loading/parsing has been validated for these 17 languages:
  `javascript`, `typescript`/`tsx`, `python`, `json`, `yaml`, `toml`, `markdown`, `kotlin`, `csharp`, `c`, `cpp`, `objc`, `go`, `rust`, `java`, `css`, `html`.
- Native grammar dependency set is present in `package.json`.

### What is already done (currently uncommitted)
- Scheduler execution isolation via subprocess is implemented (`src/index/build/tree-sitter-scheduler/runner.js`, `src/index/build/tree-sitter-scheduler/subprocess-exec.js`).
- Scheduler planner hardening is in place for symlink/minified/unreadable/skip handling (`src/index/build/tree-sitter-scheduler/plan.js`).
- Executor memory/load logging and scheduler strictness work is in place (`src/index/build/tree-sitter-scheduler/executor.js`).
- Strict worker behavior improvements for tree-sitter parsing are in place (`src/lang/workers/tree-sitter-worker.js`).
- Added scheduler subprocess regression test for Swift (`tests/indexing/tree-sitter/tree-sitter-scheduler-swift-subprocess.test.js`).

### Key gaps vs native-only target
- Scheduler data model still uses `wasmKey` naming and grouping.
- Planner/executor still contain WASM preload/prune assumptions.
- Runtime exports and options still carry WASM lifecycle paths that should be removed from indexing path.
- Tests/docs still describe or permit WASM behavior.

## Strategic Direction
Adopt a native-only scheduling model:
- Batch key becomes `grammarKey` in format `native:<languageId>`.
- Every scheduled tree-sitter job uses native runtime only.
- No WASM runtime init, preload, prune, unload, or fallback paths in indexing.
- Stage1 remains strict: tree-sitter work must come from scheduler artifacts; missing scheduler outputs are fatal.

## Scope
- In:
  - Tree-sitter scheduler planning/execution/lookup.
  - Native runtime routing and strictness.
  - Removal of WASM indexing paths, tests, and docs.
- Out:
  - New language onboarding beyond the current native set.
  - Rework of non-tree-sitter chunkers/tokenizers.

## Phase Status Summary
| Phase | Status | Notes |
| --- | --- | --- |
| N0 Baseline + Decisions | completed | Decisions locked at 2026-02-09T18:31:41.0670000Z |
| N1 Schema + Naming Migration | completed | `grammarKey` migration landed in scheduler plan/runner/executor/lookup |
| N2 Planner Native-Only Routing | completed | Planner now resolves native targets + native preflight gating |
| N3 Executor Native-Only Batching | completed | Scheduler executor now runs native-only parse activation/chunking |
| N4 Stage1 Contract Tightening | completed | Stage1 enforces scheduler contract and logs artifact violations |
| N5 Native Coverage + Regression Tests | completed | Native scheduler tests added and passing as of 2026-02-09T18:53:21.1939237Z |
| N6 WASM Removal + Docs Archive | completed | Native-only runtime/docs cutover completed as of 2026-02-09T19:00:36.4243426Z |
| N7 Native Runtime Simplification | completed | Removed `maxLoadedLanguages`/prune semantics and re-baselined tests as of 2026-02-09T14:19:26.9703540-05:00 |

## Phase N0 - Baseline + Decisions
Objective: lock architecture so implementation proceeds without mixed-runtime ambiguity.

Tasks:
- [x] Confirm canonical batch key: `grammarKey = native:<languageId>`.
- [x] Confirm hard cutover strategy for artifact fields (`wasmKey` removed, not dual-written).
- [x] Confirm native runtime requirement policy in indexing mode (missing native grammar = hard error).
- [x] Confirm scheduler subprocess policy (always-on in indexing mode).

Decisions (locked):
- `grammarKey` is the only batch identity in scheduler artifacts and filenames.
- `wasmKey` is removed from scheduler plan/jobs/results/index schema (no dual-write transition).
- In indexing mode with tree-sitter enabled, unresolved native grammar support is a hard error.
- Scheduler execution runs in subprocess mode by default for all native grammar batches.

## Phase N1 - Schema + Naming Migration
Objective: remove WASM-centric naming and artifacts.

Touchpoints:
- `src/index/build/tree-sitter-scheduler/paths.js`
- `src/index/build/tree-sitter-scheduler/plan.js`
- `src/index/build/tree-sitter-scheduler/executor.js`
- `src/index/build/tree-sitter-scheduler/lookup.js`

Tasks:
- [x] Replace `wasmKey` fields and filenames with `grammarKey`.
- [x] Update plan/jobs/results/index schemas to native-only metadata.
- [x] Keep deterministic ordering and hashing rules unchanged after migration.
- [x] Update lookup loading and stats reporting for `grammarKey`.

## Phase N2 - Planner Native-Only Routing
Objective: planner resolves only native execution targets.

Touchpoints:
- `src/index/build/tree-sitter-scheduler/plan.js`
- `src/lang/tree-sitter/native-runtime.js`

Tasks:
- [x] Add scheduler resolver: `resolveNativeTreeSitterTarget(languageId, ext)`.
- [x] Route all eligible tree-sitter segments through native target resolution.
- [x] Add native preflight for module resolution/parser activation.
- [x] Fail hard when a scheduled language lacks native grammar support in strict mode.

## Phase N3 - Executor Native-Only Batching
Objective: execute by native grammar key only; remove WASM lifecycle assumptions.

Touchpoints:
- `src/index/build/tree-sitter-scheduler/executor.js`
- `src/index/build/tree-sitter-scheduler/subprocess-exec.js`
- `src/index/build/tree-sitter-scheduler/runner.js`

Tasks:
- [x] Remove `preloadTreeSitterLanguages` and `pruneTreeSitterLanguages` usage from scheduler executor.
- [x] Activate parser via native runtime only.
- [x] Preserve subprocess isolation and memory diagnostics.
- [x] Keep strict failure behavior for missing/empty scheduler output.

## Phase N4 - Stage1 Contract Tightening
Objective: ensure indexing tree-sitter path is scheduler-only and native-only.

Touchpoints:
- `src/index/build/indexer/steps/process-files.js`
- `src/index/build/file-processor/cpu.js`
- `src/index/build/context-window.js`

Tasks:
- [x] Enforce scheduler as authoritative tree-sitter source for eligible code segments.
- [x] Remove any remaining WASM fallback assumptions in Stage1 integration.
- [x] Keep context-window estimation tree-sitter disabled.
- [x] Add explicit telemetry/errors for scheduler artifact contract violations.

## Phase N5 - Native Coverage + Regression Tests
Objective: prove native-only scheduler correctness and determinism.

Touchpoints:
- `tests/indexing/tree-sitter/tree-sitter-scheduler-swift-subprocess.test.js`
- `tests/indexing/tree-sitter/*` (new native-only scheduler tests)

Tasks:
- [x] Add scheduler-native smoke test covering all 17 languages.
- [x] Add planner contract test for native target resolution and preflight failures.
- [x] Add determinism test for native scheduler outputs across repeated runs.
- [x] Add regression test proving Stage1 does not perform non-scheduler tree-sitter parsing when enabled.
- [x] Run targeted scheduler suite with `PAIROFCLEATS_TESTING=1` and record outcomes.

Validation (2026-02-09T18:53:21.1939237Z):
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-swift-subprocess.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-native-smoke.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-native-plan-contract.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-native-determinism.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-stage1-contract.test.js` (pass)
- `node tests/run.js --lane all --match tree-sitter-scheduler` (pass)

## Phase N6 - WASM Removal + Docs Archive
Objective: remove WASM indexing code paths and align docs/specs.

Touchpoints:
- `src/lang/tree-sitter/runtime.js`
- `src/lang/tree-sitter/config.js`
- `src/lang/tree-sitter/chunking.js`
- `docs/specs/vfs-tree-sitter-scheduler.md`
- `docs/language/parser-backbone.md`
- `docs/archived/*`

Tasks:
- [x] Remove WASM runtime usage from indexing path (init/load/preload/prune/reset integration points).
- [x] Remove scheduler references to WASM keys/files.
- [x] Update specs/docs to native-only architecture.
- [x] Archive superseded WASM scheduler guidance with deprecation headers (replacement + reason + date/commit).

Validation (2026-02-09T19:00:36.4243426Z):
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-swift-subprocess.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-native-smoke.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-native-plan-contract.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-native-determinism.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-stage1-contract.test.js` (pass)
- `node tests/indexing/tree-sitter/tree-sitter-chunks.test.js` (pass)
- `node tests/run.js --lane all --match tree-sitter-scheduler` (pass)

## Phase N7 - Native Runtime Simplification
Objective: remove native-runtime cap/eviction semantics that were only needed for WASM-era lifecycle management.

Touchpoints:
- `src/lang/tree-sitter/runtime.js`
- `src/lang/tree-sitter/chunking.js`
- `src/index/build/runtime/tree-sitter.js`
- `src/index/build/runtime/runtime.js`
- `src/index/build/indexer/steps/process-files/tree-sitter.js`
- `src/index/build/workers/pool.js`
- `src/lang/tree-sitter/worker.js`
- `tools/bench/index/tree-sitter-load.js`
- `tests/indexing/tree-sitter/*`

Tasks:
- [x] Remove `maxLoadedLanguages` plumbing from runtime/worker/indexing tree-sitter options.
- [x] Make `pruneTreeSitterLanguages` non-evicting for native runtime.
- [x] Keep parser memory safety guardrails (parse timeout, traversal budgets, parser/tree cleanup).
- [x] Rebaseline cache/query/bench tests to native semantics and remove WASM-named tests.
- [x] Validate full tree-sitter suite (`node tests/run.js --lane all --match tree-sitter`).

Validation (2026-02-09T14:19:26.9703540-05:00):
- `node tests/run.js --lane all --match tree-sitter` (pass: 26/26)

## Validation Commands (to run as phases land)
- `node tests/indexing/tree-sitter/tree-sitter-scheduler-swift-subprocess.test.js`
- `node tests/indexing/tree-sitter/tree-sitter-chunks.test.js`
- `node tests/run.js --match tree-sitter-scheduler`

## Exit Criteria
- Scheduler artifacts and execution are native-only (`grammarKey=native:*`).
- No WASM preload/prune/load paths are used by indexing tree-sitter flow.
- Stage1 tree-sitter path is scheduler-driven and strict.
- Native scheduler smoke coverage exists and passes for all 17 languages.
- Docs/specs no longer describe WASM scheduler behavior for indexing.

---

# DUPEMAP — Duplication Consolidation Execution Plan

Last updated: 2026-02-10T05:51:01.7514959-05:00

Purpose: remove all confirmed duplication clusters comprehensively, efficiently, and permanently.

Primary inputs:
- `duplication_consolidation_report.md`
- `duplication_report.md`
- `duplication_report.json`

Completed phases are appended to: `COMPLETED_PHASES.md`

---

## Status legend

- [x] Implemented and validated
- [@] In progress
- [.] Implemented but not yet tested
- [?] Correctness gap or insufficient tests
- [ ] Not started

---

## Operating rules

1. Hard cutovers only.
- No compatibility aliases/shims for duplicated helpers.
- Old helper implementations are deleted in the same phase as migration.

2. Canonical ownership.
- Cross-cutting shared runtime: `src/shared/**`
- Index/build orchestration: `src/index/**`
- Storage shared internals: `src/storage/**`
- Tools must consume canonical helpers, not fork them.

3. Exhaustive migration proof.
- Every phase must add/extend duplicate-ban entries in `docs/tooling/dupemap-migration-manifest.json`.
- Every phase must run the legacy usage audit and fail on any hit.

4. Test integrity.
- Merged/refactored tests must preserve distinct scenario assertions.
- Test helpers can be shared; scenario-specific expectations cannot be collapsed away.

5. Docs/contracts alignment.
- Any changed API surface or behavior must update docs/contracts in the same phase.

6. Change sizing and merge safety.
- Execute work in small vertical slices within each subphase (single module family + linked tests).
- Do not batch unrelated subsystem rewrites in the same commit.

7. Measure-before-merge rule.
- Any phase touching hot paths must include before/after metrics in its completion notes.
- Regressions above budget require either remediation in-phase or explicit time-bound waiver.

---

## Phase summary

| Phase | Status | Scope |
| --- | --- | --- |
| D0 | [x] | Baseline mapping + execution kickoff (no new scanner tooling) |
| D1 | [x] | Shared primitive consolidation |
| D2 | [x] | JSONL merge + artifact writer scaffolding |
| D4 | [x] | ANN + API/MCP + search request normalization |
| D5 | [x] | Tooling + language parser/extractor consolidation |
| D3 | [x] | SQLite/LMDB/quantization/vocab consolidation |
| D6 | [x] | Chunking + risk + import resolution + map consolidation |
| D7 | [x] | Test/bench dedupe and harness consolidation |
| D8 | [x] | AJV/fetch consolidation + CI hardening + closeout |
| F0 | [x] | Findings phase mapping + ownership (no new audit tooling) |
| F1 | [x] | Build/runtime lifecycle correctness remediation |
| F2 | [x] | Language/chunking/import correctness remediation |
| F3 | [x] | Artifact/storage I/O correctness + crash-safety |
| F4 | [x] | Retrieval/ANN/embeddings correctness + boundedness |
| F5 | [x] | Tooling/LSP/service resilience + diagnostics hygiene |
| F6 | [x] | Map/graph/context-pack correctness + cleanup safety |
| F7 | [x] | Security/path/input hardening across surfaces |
| F8 | [x] | Contract-test expansion + `src/**` coverage inventory |

---

## Frontloaded execution order (mandatory)

This roadmap is intentionally ordered to frontload highest-leverage, cross-cutting foundations first, while pairing dedupe and findings remediation in the same touchpoints to avoid rework.

### Wave U0 — Governance/control plane (must complete first)
1. `D0` Migration manifest + execution kickoff.
2. `F0` Findings mapping + ownership alignment.

### Wave U1 — Foundational primitives and invariants
3. `D1` Shared primitives consolidation.
4. `F7` Security/path/input hardening foundations (shared containment/validation helpers).
5. `F1` Lifecycle/teardown foundations that depend on `D1` primitives.

### Wave U2 — Core I/O, artifacts, storage semantics
6. `D2` JSONL merge + writer scaffolding.
7. `F3` Artifact/storage crash-safety and bounds checks.
8. `D3` Storage internals consolidation (SQLite/LMDB/quantization/vocab).

### Wave U3 — Cross-surface runtime, retrieval, tooling
9. `D4` ANN + API/MCP normalization.
10. `F4` Retrieval/ANN/embeddings reliability.
11. `D5` Tooling/language helper consolidation.
12. `F5` Tooling/LSP/service resilience.

### Wave U4 — Domain helpers and feature correctness
13. `D6` Chunking/risk/import/map helper consolidation.
14. `F2` Language/chunking/import correctness remediation.
15. `F6` Map/graph/context-pack correctness.

### Wave U5 — Consolidation, testing closeout
16. `D7` Test/bench dedupe.
17. `F8` Contract-test expansion + `src/**` coverage inventory.
18. `D8` Final dedupe hardening/closeout.

Rationale:
- The largest cross-cutting foundations (`D0`, `F0`, `D1`) are executed first.
- I/O and persistence contracts are handled before domain-level migrations to prevent rework.
- Cross-surface runtime/retrieval/tooling are grouped so API/MCP/retrieval/tooling changes land together.
- Contract and CI lock phases happen last, after implementation churn stabilizes.
- Section order in this document remains numeric, but execution must follow this unified wave order.

---

## Phase dependencies and gates

| Phase | Hard dependencies | Why |
| --- | --- | --- |
| D0 | None | Captures baseline mapping and execution ordering |
| D1 | D0 | Primitive helper migration follows established baseline mapping |
| D2 | D1 | JSONL/writer scaffolding depends on shared primitives |
| D4 | D1 | API/MCP/retrieval normalization requires canonical shared baseline |
| D5 | D1 | Tooling/language helper extraction depends on shared primitives |
| D3 | D1, D2 | Storage migrations depend on shared primitive + JSONL foundation work |
| D6 | D1, D5 | Domain helper consolidation depends on language/tooling shared helper extraction |
| D7 | D1, D2, D3, D4, D5, D6 | Test dedupe should happen after production codepaths stabilize |
| D8 | All prior phases | Final hardening and CI lock-in only after full migration |
| F0 | D0 | Findings mapping aligns to baseline phase ordering |
| F1 | F0, D1, D2 | Lifecycle fixes depend on foundational helpers and normalized build plumbing |
| F2 | F0, D5, D6 | Language correctness depends on consolidated language/chunking helpers |
| F3 | F0, D1, D2, D3 | Crash-safe persistence depends on shared atomic I/O + storage consolidation |
| F4 | F0, D3, D4 | Retrieval/ANN fixes depend on storage contracts and ANN/request normalization |
| F5 | F0, D4, D5 | Tooling/service parity depends on shared API/MCP/tooling helpers |
| F6 | F0, D6 | Map/graph/context-pack correctness depends on consolidated domain helpers |
| F7 | F0, D1 | Security hardening depends on shared path/input primitives |
| F8 | F0, F1, F2, F3, F4, F5, F6, F7, D7 | Contract lock is meaningful only after implementations settle |

Gate rule:
- Do not start a phase until hard dependencies are completed and committed.
- Exceptions require explicit note in this file with reason and rollback plan.
- Touch-once rule: when a phase touches a mapped module family, apply both dedupe and findings remediations for that family in the same change series; avoid deferred second-pass rewrites.
- No correctness debt carry-forward: a known high/critical finding in touched files cannot be deferred to a later phase unless explicitly accepted with expiry.

---

## Class-level remediation coverage (from `All_Findings.md` Part 4)

| Class-level remediation | Coverage status | Implementation phases | Verification gates |
| --- | --- | --- | --- |
| 1. Mandatory shared utility policy | [ ] Planned | D1, D8 | utility-import contract tests + closeout review sweep |
| 2. Atomic write by default | [ ] Planned | D1, D2, D3, D4, D8 | atomic-write contract tests + non-atomic write ban checks |
| 3. Standardized cache lifecycle contracts | [ ] Planned | D1, D3, D4, D5, D8 | cache-policy contract tests + boundedness/lifecycle assertions |
| 4. Explicit process lifecycle and shutdown contracts | [ ] Planned | D1, D5, D8 | shutdown/drain contract tests for workers/services/watchers |
| 5. Cross-surface contract tests | [ ] Planned | D2, D4, D7, D8 | parity suites for CLI/API/MCP, artifact strictness, ANN contract, stage progression |
| 6. Regression guardrails for known bug classes | [ ] Planned | D1, D8, F8 | targeted regression suites + CI lane gating |

Implementation note:
- These six remediations are mandatory completion criteria for this roadmap.
- Subphase additions below explicitly wire each remediation to concrete tasks and tests.

---

## Findings remediation program (mandatory, `All_Findings.md` Parts 1-5)

### Objective
Execute a complete remediation program for every finding recorded in `All_Findings.md`, with explicit implementation phases, test evidence, and CI gating.

### Scope statement
- In scope: all findings from baseline Sections `A`..`O`, additional findings in Parts `2A/2B/2C`, conversation addendum findings, and Part 5 `src/**` expansion findings.
- Out of scope: deferral without explicit written acceptance (owner, rationale, risk, expiry phase).

### Findings-to-phase coverage matrix

| Findings domain | Remediation phase(s) | Primary touchpoints |
| --- | --- | --- |
| A Entry points + command surfaces | F5 | `bin/**`, `tools/**`, CLI command routing, guardrails |
| B Config/policy/runtime envelope | F7 | `src/shared/config/**`, env allowlists, budget checks |
| C Build orchestration/lifecycle | F1, F3 | `src/index/build/**`, stage/promotion/lock flows |
| D Discovery/preprocess/incremental/watch | F1, F2, F3 | `src/index/build/file-scan.js`, watch/discovery helpers |
| E Language frontends/chunking/imports | F2, F8 | `src/lang/**`, `src/index/chunking/**`, import resolution |
| F Tokenization/postings/filter indexes | F2, F3 | token ids/postings/chunk metadata paths |
| G Enrichment/tooling/type/risk | F5, F7, F8 | `src/index/tooling/**`, risk/type inference/vfs |
| H Artifact I/O/schema/contracts | F3, F8 | `src/index/build/artifacts/**`, `src/contracts/**` |
| I Storage backends/maintenance | F3, F4 | `src/storage/**`, sqlite/lmdb lifecycle |
| J Retrieval engine/query pipeline | F4, F8 | `src/retrieval/**`, query cache/provider lifecycle |
| K Embeddings + ANN infra | F4, F8 | embeddings/ANN providers/cache format |
| L Graph analyses | F6, F8 | `src/graph/**`, graph artifact readers |
| M Context pack assembly | F6, F8 | `src/context-pack/**`, artifact assembly invariants |
| N Service layer HTTP/MCP/indexer service | F5, F7 | `tools/api/**`, `tools/mcp/**`, `tools/service/**` |
| O Tooling/bench/tests harness | F5, F8 | test runner, logs, script-coverage, CI guards |
| Part 5 `src/**` expansion findings | F1, F2, F3, F5, F6, F7 | explicit path-level fixes listed in phases below |

### Part 5 `src/**` finding integration map

| Finding group | Resolution phase | Primary fix touchpoints |
| --- | --- | --- |
| P5-01 token-postings shard-size NaN | F3 | `src/index/build/artifacts/token-postings.js` |
| P5-02 repo-map delta disable semantics | F1 | `src/index/build/artifacts/repo-map.js` |
| P5-03 file-meta O(n²) membership | F3 | `src/index/build/artifacts/file-meta.js` |
| P5-04 watch stability off-by-one | F1 | `src/index/build/watch/stability.js` |
| P5-05 vfs manifest collector shared cleanup | F1 | `src/index/build/vfs-manifest-collector.js` |
| P5-06 scheduler miss cache unbounded | F1 | `src/index/build/tree-sitter-scheduler/lookup.js` |
| P5-07 simple language relations contract mismatch | F2 | `src/index/language-registry/registry-data.js` |
| P5-08 callsite id rejects zero-based positions | F2 | `src/index/callsite-id.js` |
| P5-09 vfs sort key lexical numeric drift | F2 | `src/index/tooling/vfs-index.js` |
| P5-10 pyright runnable false positive | F5 | `src/index/tooling/pyright-provider.js` |
| P5-11 json encode cycle overflow risk | F3 | `src/shared/json-stream/encode.js` |
| P5-12 embeddings cache decode bounds | F3 | `src/shared/embeddings-cache/format.js` |
| P5-13 bloom decode payload length mismatch | F3 | `src/shared/bloom.js` |
| P5-14 html chunking fallback null-on-parse-error | F2 | `src/lang/html.js` |
| P5-15 unguarded URI decode throw path | F5/F7 | `src/integrations/tooling/lsp/uris.js` |
| P5-16 sqlite pragmas restore completeness | F3 | `src/storage/sqlite/build/pragmas.js` |
| P5-17 map member id zero handling | F6 | `src/map/isometric/client/map-data.js` |
| P5-18 map temp cleanup on failure | F6 | `src/map/build-map.js` |

### Execution order (mandatory)

Wave F-A:
1. `F0` Findings mapping + ownership gates
2. `F1` Build/runtime lifecycle correctness
3. `F2` Language/chunking/import correctness

Wave F-B:
4. `F3` Artifact/storage I/O crash-safety
5. `F4` Retrieval/ANN/embeddings reliability
6. `F5` Tooling/LSP/service resilience

Wave F-C:
7. `F6` Map/graph/context-pack correctness
8. `F7` Security/path/input hardening
9. `F8` Contract-test expansion + coverage inventory

### D/F coupling map (mandatory touch-once execution)

| Primary phase | Must co-execute with | Shared touchpoints | Coupling intent |
| --- | --- | --- | --- |
| D0 | F0 | manifests, phase mappings, ownership tables | one governance control plane for dedupe + findings |
| D1 | F7, F1 (foundation subset) | shared path/cache/lock/io primitives | eliminate duplicate helpers while hardening safety/lifecycle contracts |
| D2 | F3 | JSONL merge/writer scaffolding + artifact writes | ship atomic/bounded writer semantics with helper consolidation |
| D3 | F3, F4 (storage subset) | sqlite/lmdb/quantization/vocab internals | align storage correctness, bounds, and retrieval contracts once |
| D4 | F4, F5 (API/MCP subset) | ANN + API/MCP request/filter/cache normalization | prevent repeated parity rewrites across retrieval + service surfaces |
| D5 | F2, F5 | tooling providers + language parser/extractor helpers | pair helper consolidation with correctness/resilience fixes |
| D6 | F2, F6 | chunking/risk/import/map helpers | converge helper APIs and domain correctness in same migrations |
| D7 | F8 | test harness + contract suite structure | build stable reusable tests before final CI lock |

Dependency rule:
- `F0` must complete before any `F1`..`F8` completion.
- No finding can be marked resolved without test evidence linked in this roadmap.

### Performance acceleration refinements (mandatory)

P1. Hot-path complexity elimination first:
- [x] Prioritize known O(n²) and repeated scan hotspots before feature-level rewrites.
- [x] Add static checks for accidental list-membership-in-loop patterns in hot files.
- [x] Track resolved hotspots in roadmap manifest with benchmark evidence.

P2. Bounded-memory-by-default enforcement:
- [x] Require explicit caps/eviction for module-level maps/sets/caches.
- [x] Add explicit boundedness assertions in targeted tests for cache-heavy modules in `src/**`.
- [x] Add cache metrics in tests: entry count, eviction count, peak estimate.

P3. Concurrency and backpressure contracts:
- [x] Define per-subsystem concurrency knobs and safe defaults.
- [x] Require queue/drain semantics for long-lived workers/providers.
- [x] Add timeout and cancellation behavior contracts for tooling/service subprocesses.

P4. I/O amplification reduction:
- [x] Coalesce multi-write artifact paths where safe.
- [x] Ensure streaming readers/writers enforce max-bytes early.
- [x] Measure and track bytes written/read in representative tests.

Performance refinement evidence update (2026-02-10T03:31:25-05:00):
- P1 resolved hotspots are locked by static guard `tests/indexing/policy/hotpath-membership-guard.test.js`, with hotspot benchmark evidence in `docs/worklogs/perf-accel-refinements-2026-02-10.json`.
- P2 boundedness enforcement covers cache-heavy modules via `tests/indexing/policy/module-cache-boundedness-contract.test.js`, with runtime eviction/peak metrics asserted in `tests/graph/graph-store-cache-eviction.test.js` and caps in `src/index/build/build-state.js`.
- P3 concurrency/backpressure contracts remain explicit in `src/shared/concurrency.js` queue/scheduler defaults, `tests/indexing/lifecycle/shutdown-drain-contract.test.js` drain semantics, and subprocess timeout/cancel contracts in `tests/tooling/service/subprocess-buffer-bounds.test.js` and `tests/tooling/service/subprocess-cancellation-contract.test.js`.
- P4 I/O amplification controls use streaming/coalesced artifact paths (validated by existing streaming artifact perf contracts), early max-byte enforcement plus read metrics in `src/shared/artifact-io/offsets.js` and `tests/shared/jsonl/read-row-max-bytes-enforced.test.js`, and write-byte accounting in `tools/service/subprocess-log.js` and `tests/tooling/logging/output-byte-accounting.test.js`.
- P3/P4 follow-up (2026-02-10T04:06:37.6084824-05:00): batched stage3 embeddings execution in `src/integrations/core/build-index/stages.js` now collapses per-mode subprocess launches into a single `--mode all` invocation when modes share one build root. Measured against recent file-caps index logs (`.testLogs/run-1770676140923-r1dj8d/indexing_file-caps_file-size-guard.attempt-1.log` at 29s baseline), the post-change verification run of `tests/indexing/file-caps/file-size-guard.test.js` completed in 25s.
- P3/P4 follow-up (2026-02-10T04:12:21.1889601-05:00): `tools/build/embeddings/runner.js` now skips expensive `validateIndexArtifacts` calls for zero-chunk modes, preserving validation for non-empty modes. Against recent baseline logs (`.testLogs/run-1770713620356-arfuvr/indexing_file-caps_file-size-guard.attempt-1.log` and `.testLogs/run-1770713620356-arfuvr/indexing_map_code-map-basic.attempt-1.log`, both 29s), targeted TTY reruns of `tests/indexing/file-caps/file-size-guard.test.js` and `tests/indexing/map/code-map-basic.test.js` each completed in 25s.
- P1/P2 follow-up (2026-02-10T05:51:01.7514959-05:00): removed parse5 from the HTML import pre-scan hot path by switching `collectHtmlImports` in `src/lang/html.js` to linear tag/attribute scanning, and added Swift no-import/no-declaration guards in `src/lang/swift.js` to skip split-line and declaration regex scans when hints are absent. Bench evidence in `docs/worklogs/indexing-hotpath-bench-2026-02-10.json` on `benchmarks/repos/swift/alamofire__alamofire/docs/Classes.html` (104,354 bytes) and a 441KB no-import Swift payload: HTML import scan improved from 14.548ms to 0.133ms per iteration (109.38x), Swift import collection improved from 2.798ms to 0.122ms per iteration (22.93x), and Swift relation scan improved from 2.23ms to 1.93ms per iteration (1.16x).
- P1 follow-up (2026-02-10T06:39:24-05:00): completed a full `src/lang/**` regex-iterator sweep removing `String.prototype.matchAll` loops from hot collectors/flow analyzers in favor of explicit `RegExp.exec` loops with safe `lastIndex` resets (`src/lang/swift.js`, `src/lang/typescript/flow.js`, `src/lang/rust.js`, `src/lang/css.js`, plus language flow modules in `csharp/go/java/kotlin/perl/php/ruby/shell/sql/clike`). Benchmark evidence in `docs/worklogs/lang-regex-exec-loop-bench-2026-02-10.json`: CSS import scan 1.38x faster, Swift declaration scan 1.07x faster, Rust attribute scan 1.15x faster, and TypeScript throw/await flow scan 1.04x faster.

### Phase F0 — Findings manifest and ownership

Objective:
Create a direct execution source of truth for every finding without introducing new scanner/audit tooling.

Touchpoints:
- `All_Findings.md`
- `DUPEMAP.md`
- phase status notes in roadmap updates

Subphase F0.1 — Findings mapping baseline:
- [x] Ensure all findings families are mapped to phases in `DUPEMAP.md`.
- [x] Ensure each mapped finding family has explicit touchpoints and tests.
- [x] Keep consistent finding ID references (`A-*`, ..., `P5-*`) in planning notes.

F0.1 mapping confirmation:
- Findings families `A`..`O`, addendum (`2A/2B/2C`), and `P5-*` are mapped in `Findings-to-phase coverage matrix`.
- Path-level `P5-*` ownership is mapped in `Part 5 src/** finding integration map`.
- Phase-level tests are anchored in each phase section (`F1`..`F8`) and in D/F coupling checkpoints.

Subphase F0.2 — Ownership and closure criteria:
- [x] Assign owner responsibility by phase (not by separate tooling artifact).
- [x] Define what evidence closes a finding (code path + test coverage + commit ref).
- [x] Require severity-first burn-down ordering inside each phase.

F0.2 owner matrix (phase-scoped):
| Phase | Primary owner group |
| --- | --- |
| F1 | Build/runtime lifecycle |
| F2 | Language/chunking/import |
| F3 | Artifact/storage I/O and persistence |
| F4 | Retrieval/ANN/embeddings |
| F5 | Tooling/LSP/service surfaces |
| F6 | Map/graph/context-pack |
| F7 | Security/path/input hardening |
| F8 | Contract tests and coverage inventory |

F0.2 closure evidence standard:
- A finding closes only with `code path` + `test evidence` + `commit reference` recorded in phase notes.
- `Code path` must list concrete changed files/functions and the invariant they enforce.
- `Test evidence` must name exact test files/commands and pass outcome.
- `Commit reference` must include at least one commit hash that contains the fix and tests.
- Burn-down order is severity-first inside each phase: `critical` then `high` then remaining severities, unless dependency constraints are explicitly documented.

Subphase F0.3 — Execution discipline:
- [x] Require phase updates to include resolved/remaining findings summary.
- [x] Block phase closeout when high/critical mapped findings for that phase are unresolved unless explicitly accepted with expiry.

F0.3 required phase findings update block:
- `resolved`: finding IDs closed in the phase (with commit refs and tests).
- `remaining`: finding IDs still open in phase scope.
- `severity snapshot`: count by severity (`critical/high/medium/low`) at phase start and phase end.
- `exceptions`: accepted deferrals with owner, reason, risk, and explicit expiry phase.

F0.3 closeout gate:
- A phase cannot be marked complete while any mapped `critical` or `high` finding remains unresolved unless an exception entry is recorded with expiry and owner.
- Exception records must be explicit, time-bound, and reviewed in the next dependent phase before additional scope expansion.

Tests:
- [x] no new tooling tests required in F0; enforce through phase-level remediation tests in F1-F8

Exit criteria:
- [x] Every finding family from `All_Findings.md` is mapped to at least one execution phase.
- [x] No standalone scanner/audit tooling work remains in F0.

### Phase F1 — Build/runtime lifecycle correctness

Objective:
Fix lifecycle, stage, lock, and runtime invariants in the indexing pipeline.

Touchpoints:
- `src/index/build/indexer/**`
- `src/index/build/runtime/**`
- `src/index/build/watch/**`
- `src/index/build/tree-sitter-scheduler/**`
- `src/index/build/vfs-manifest-collector.js`
- `src/index/build/artifacts/repo-map.js`

Subphase F1.1 — Stage progression and promotion correctness:
- [x] Fix stage/promotion ordering findings from C/addendum (including partial promotion and stage-state visibility).
- [x] Enforce per-stage fail-closed semantics; no silent stage failure.
- [x] Ensure `build_state/current` progression reflects stage4 sqlite work when enabled.

Subphase F1.2 — Lock/process teardown correctness:
- [x] Guarantee lock handler detachment and teardown execution even when release paths fail.
- [x] Ensure subprocess timeout-kill logic is cancellation-safe and reports deterministic outcomes.
- [x] Enforce deterministic shutdown ordering for runtime teardown on both success and failure.

Subphase F1.3 — Watch/scheduler/runtime hot-path issues:
- [x] Fix `checks=1` off-by-one in `src/index/build/watch/stability.js:18`.
- [x] Bound scheduler miss cache in `src/index/build/tree-sitter-scheduler/lookup.js:27`.
- [x] Isolate collector run directories and cleanup ownership in `src/index/build/vfs-manifest-collector.js:124`.
- [x] Fix delta-disable behavior in `src/index/build/artifacts/repo-map.js:60`.

Tests:
- [x] `tests/indexing/build/stage-progression-contract.test.js` (new)
- [x] `tests/indexing/build/promotion-timing-contract.test.js` (new)
- [x] `tests/indexing/watch/watch-stability-checks.test.js` (new)
- [x] `tests/indexing/tree-sitter/scheduler-miss-cache-bounded.test.js` (new)
- [x] `tests/indexing/vfs/vfs-manifest-collector-isolation.test.js` (new)
- [x] `tests/indexing/artifacts/repo-map-delta-eligibility.test.js` (new)

Exit criteria:
- [x] No known stage lifecycle findings remain open.
- [x] Long-running watch/scheduler paths are bounded and test-proven.

F1.DOC no-doc-change rationale (2026-02-10T01:47:42.3681173-05:00):
- Runtime/promotion behavior changed in implementation details only; no user-facing command, config, or schema contract text changed.

### Phase F2 — Language/chunking/import correctness

Objective:
Eliminate correctness drift in chunking, relations, offsets, and import extraction.

Touchpoints:
- `src/lang/**`
- `src/index/language-registry/**`
- `src/index/chunking/**`
- `src/index/callsite-id.js`
- `src/index/tooling/vfs-index.js`

Subphase F2.1 — Relations and import extraction:
- [x] Fix simple-language relation importer contract mismatch in `src/index/language-registry/registry-data.js:419`.
- [x] Complete Python relative import extraction and case-collision deterministic handling findings.
- [x] Eliminate import candidate/path normalization divergence (shared helper path).

Subphase F2.2 — Chunking and parser fallback behavior:
- [x] Fix HTML fallback behavior in `src/lang/html.js:408` to retain chunks on `parse5` failure.
- [x] Standardize end-offset semantics (exclusive vs inclusive) across Python/TS and chunk boundaries.
- [x] Remove duplicate/heuristic divergence in language chunk builders through shared contracts.

Subphase F2.3 — Callsite and ordering correctness:
- [x] Allow `0`-based positions in `src/index/callsite-id.js:4`.
- [x] Fix numeric ordering key in `src/index/tooling/vfs-index.js:12`.
- [x] Verify callsite IDs and segment ordering parity across providers.

Tests:
- [x] `tests/lang/contracts/simple-language-relations-contract.test.js` (new)
- [x] `tests/lang/contracts/html-chunking-fallback.test.js` (new)
- [x] `tests/lang/contracts/end-offset-normalization.test.js` (new)
- [x] `tests/indexing/callsite-id/callsite-id-zero-based.test.js` (new)
- [x] `tests/indexing/tooling/vfs-sort-key-numeric-order.test.js` (new)
- [x] existing per-language metadata/relations suites expanded to contract assertions

Exit criteria:
- [x] All language/import/chunking correctness findings mapped to resolved tests.
- [x] Per-language relation and chunk contracts pass across supported languages.

F2.DOC no-doc-change rationale (2026-02-10T01:56:44.3735295-05:00):
- F2 changes were internal parser/normalization correctness fixes with test-only coverage expansion; no user-facing doc/config/schema text changed.

### Phase F3 — Artifact/storage I/O crash-safety

Objective:
Enforce fail-closed, bounded, and atomic behavior for artifacts, manifests, and storage I/O.

Touchpoints:
- `src/index/build/artifacts/**`
- `src/shared/json-stream/**`
- `src/storage/sqlite/**`
- `src/storage/lmdb/**`
- `src/shared/io/**` (atomic write helpers)

Subphase F3.1 — Atomic persistence enforcement:
- [x] Migrate manifest/cache/queue/pointer writes to shared atomic-write APIs.
- [x] Ban direct non-atomic writes for stateful files via targeted sweeps and regression tests.
- [x] Fix non-atomic persistence findings in incremental/cache/query-plan/tooling caches.

Subphase F3.2 — Bounds/safety checks in readers/decoders:
- [x] Add cycle detection in `src/shared/json-stream/encode.js:20`.
- [x] Enforce vector-section bounds in `src/shared/embeddings-cache/format.js:85`.
- [x] Validate bloom payload length in `src/shared/bloom.js:102`.
- [x] Resolve FD guard and varint/read-bound findings in artifact readers.

Subphase F3.3 — Storage lifecycle correctness:
- [x] Restore captured pragmas in `src/storage/sqlite/build/pragmas.js:95`.
- [x] Fix token posting shard-size NaN hazard in `src/index/build/artifacts/token-postings.js:29`.
- [x] Remove O(n²) artifact merge hotspots such as `file-meta` membership checks.

Tests:
- [x] `tests/shared/io/atomic-write-contract.test.js` (from D1)
- [x] `tests/shared/json-stream/json-encode-cycle-guard.test.js` (new)
- [x] `tests/shared/embeddings-cache/decode-vector-bounds.test.js` (new)
- [x] `tests/shared/bloom/bloom-decode-length-contract.test.js` (new)
- [x] `tests/storage/sqlite/pragmas-restore-contract.test.js` (new)
- [x] `tests/indexing/artifacts/token-postings-shard-size-guard.test.js` (new)
- [x] `tests/indexing/artifacts/file-meta-membership-performance.test.js` (new)
- [x] `tests/shared/artifact-io/varint-safe-bounds.test.js` (new)
- [x] `tests/shared/files/read-file-range-fd-zero-guard.test.js` (new)

Exit criteria:
- [x] No unbounded/corrupting reader-writer paths remain in artifact/storage hot paths.
- [x] Atomic-write-by-default gate passes in CI.

F3.DOC no-doc-change rationale (2026-02-10T02:10:55.2019640-05:00):
- F3 changes were internal atomic-write and bounds-safety corrections with contract-test additions; no user-facing schema/config/doc behavior changed.

### Phase F4 — Retrieval/ANN/embeddings reliability

Objective:
Resolve retrieval/ANN/provider/cache correctness drift and ensure bounded resource behavior.

Touchpoints:
- `src/retrieval/**`
- `src/storage/sqlite/quantization.js`
- `src/storage/sqlite/vocab.js`
- embeddings provider/cache initialization modules

Subphase F4.1 — Provider lifecycle and fallback behavior:
- [x] Remove sticky-disable-once behavior for providers; add retry/backoff/reset semantics.
- [x] Resolve ONNX/transformer initialization poison-cache issues.
- [x] Close connection/table lifecycle gaps for ANN backends.

Subphase F4.2 — Scoring/contract semantics:
- [x] Normalize ANN similarity semantics by metric/backend contract.
- [x] Correct `annType`/`annSource` semantics.
- [x] Resolve query negation/exclude semantics drift and stale signature cache behavior.

Subphase F4.3 — Cache boundedness:
- [x] Enforce bounded query-plan/index signature/provider caches with TTL + capacity.
- [x] Validate cache invalidation on configuration/signature drift.

Tests:
- [x] `tests/retrieval/ann/ann-candidate-set-contract.test.js` (from D4)
- [x] `tests/retrieval/ann/similarity-metric-contract.test.js` (new)
- [x] `tests/retrieval/providers/provider-retry-reset-contract.test.js` (new)
- [x] `tests/retrieval/cache/query-plan-cache-bounds.test.js` (new)
- [x] `tests/retrieval/cache/index-signature-cache-bounds.test.js` (new)
- [x] `tests/indexing/embeddings/provider-init-retry-contract.test.js` (new)

Exit criteria:
- [x] Retrieval and ANN behavior are contract-tested and backend-consistent.
- [x] Provider/cache paths are bounded and recover from transient failures.

F4.DOC no-doc-change rationale (2026-02-10T02:24:47.9337385-05:00):
- F4 changes were internal retrieval/provider/cache correctness hardening with contract-test additions; no user-facing command/config/schema docs changed.

### Phase F5 — Tooling/LSP/service resilience

Objective:
Stabilize tooling provider behavior, diagnostics flow, and service resource usage.

Touchpoints:
- `src/index/tooling/**`
- `src/integrations/tooling/**`
- `tools/api/**`
- `tools/mcp/**`
- `tools/service/**`

Subphase F5.1 — LSP provider hardening:
- [x] Guard URI decode in `src/integrations/tooling/lsp/uris.js:21`.
- [x] Replace executable-existence shortcuts with runnable checks in `src/index/tooling/pyright-provider.js:37`.
- [x] Ensure timeout/circuit-breaker behavior degrades gracefully with actionable diagnostics.

Subphase F5.2 — Diagnostics/logging boundedness:
- [x] Bound tooling diagnostics buffers and dedupe queues.
- [x] Ensure byte-accurate logging/output accounting and timeout termination reporting.
- [x] Remove silent-failure paths in service subprocess logging.

Subphase F5.3 — API/MCP/service parity contracts:
- [x] Complete request/filter/cache config parity from D4 plus service runtime checks.
- [x] Add service-level lifecycle tests for worker shutdown and queue drain.

Tests:
- [x] `tests/integrations/lsp/uri-decode-malformed-input.test.js` (new)
- [x] `tests/indexing/tooling/pyright-runnable-detection.test.js` (new)
- [x] `tests/tooling/logging/output-byte-accounting.test.js` (new)
- [x] `tests/tooling/service/subprocess-buffer-bounds.test.js` (new)
- [x] `tests/tooling/api-mcp/search-request-parity.test.js` (from D4)
- [x] `tests/indexing/lifecycle/shutdown-drain-contract.test.js` (new)

Exit criteria:
- [x] Tooling and service failure modes are bounded, recoverable, and test-covered.

F5 status update (2026-02-10T02:37:19.0577276-05:00):
- resolved: guarded malformed URI decode paths in `src/integrations/tooling/lsp/uris.js` so malformed percent-encoding fails closed and token fallback mapping remains safe.
- resolved: replaced pyright executable existence shortcut with runnable probe checks and added explicit runnable-detection contract coverage.
- resolved: hardened LSP failure handling with bounded diagnostics buffers (`per-uri`, `uri-map`, and `per-chunk` caps), dedupe keys, and actionable circuit-breaker/timeout checks propagated through provider diagnostics.
- resolved: extracted service subprocess logging helper `tools/service/subprocess-log.js` with byte-accurate stdout/stderr accounting, bounded capture policy, explicit timeout logging, and write-failure reporting; wired `tools/service/indexer-service.js` to use it.
- resolved: fixed lifecycle shutdown semantics in `src/shared/lifecycle/registry.js` so `close()` now executes resource `drain` hooks and waits pending work.
- remaining: none (F5 subphases complete).
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this phase.
- exceptions: none.
- sweep results:
  - `rg --line-number "decodeURIComponent\\(|catch \\{\\s*return null;\\s*\\}" src/integrations/tooling/lsp/uris.js`
  - `rg --line-number "existsSync\\(cmd\\)|__canRunPyrightForTests|exitCode === 0" src/index/tooling/pyright-provider.js`
  - `rg --line-number "maxDiagnosticUris|maxDiagnosticsPerUri|maxDiagnosticsPerChunk|tooling_circuit_open|tooling_hover_timeout|tooling_diagnostics" src/integrations/tooling/providers/lsp.js src/index/tooling/lsp-provider.js src/index/tooling/clangd-provider.js src/index/tooling/pyright-provider.js src/index/tooling/sourcekit-provider.js`
  - `rg --line-number "runLoggedSubprocess|output bytes stdout|job timeout|PAIROFCLEATS_SERVICE_SUBPROCESS" tools/service/indexer-service.js tools/service/subprocess-log.js`

F5.DOC no-doc-change rationale (2026-02-10T02:37:19.0577276-05:00):
- F5 updates were internal resilience and diagnostics hardening for tooling/service execution paths with contract tests; no user-facing commands/config schema behavior required doc edits.

### Phase F6 — Map/graph/context-pack correctness

Objective:
Resolve functional correctness and cleanup/lifecycle gaps in map/graph/context-pack paths.

Touchpoints:
- `src/map/**`
- `src/graph/**`
- `src/context-pack/**`

Subphase F6.1 — Map correctness and cleanup:
- [x] Fix member-id zero handling in `src/map/isometric/client/map-data.js:28`.
- [x] Ensure cleanup in `src/map/build-map.js:365` always executes via `finally`.
- [x] Verify filter/collapse/escape semantics after D6 helper consolidation.

Subphase F6.2 — Graph/context-pack contracts:
- [x] Validate graph artifact assembly contracts for ordering/edge consistency.
- [x] Validate context-pack assembly deterministic ordering and bound checks.

Tests:
- [x] `tests/map/isometric/member-id-zero-contract.test.js` (new)
- [x] `tests/map/build-map/temp-cleanup-on-failure.test.js` (new)
- [x] `tests/graph/contracts/graph-artifact-ordering-contract.test.js` (new)
- [x] `tests/context-pack/contracts/context-pack-determinism.test.js` (new)

Exit criteria:
- [x] Map/graph/context-pack findings are closed with deterministic contract tests.

F6 status update (2026-02-10T02:46:07.7902373-05:00):
- resolved: fixed map isometric member-id handling so id `0` is indexed in `memberById` and `fileByMember`.
- resolved: reworked `buildCodeMap` spill/temp lifecycle so sorter cleanup and temp-dir cleanup execute in `finally`, including error paths.
- resolved: added explicit map/graph/context-pack contracts for member-id zero behavior, temp cleanup on failure, graph ordering determinism, and composite context-pack determinism.
- resolved: verified map filter/collapse and HTML escape behavior contracts remain intact after D6 helper consolidation.
- remaining: none (F6 subphases complete).
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this phase.
- exceptions: none.
- sweep results:
  - `rg --line-number "hasMemberId|memberById\\.set|fileByMember\\.set" src/map/isometric/client/map-data.js`
  - `rg --line-number "createTempDir|finally|cleanupTempDir|nodeSorter\\.cleanup|edgeSorter\\.cleanup" src/map/build-map.js`
  - `rg --line-number "member-id-zero-contract|temp-cleanup-on-failure|graph-artifact-ordering-contract|context-pack-determinism" tests/map tests/graph tests/context-pack tests/retrieval/graph -g "*.test.js"`

F6.DOC no-doc-change rationale (2026-02-10T02:46:07.7902373-05:00):
- F6 changes were internal correctness and deterministic-contract updates for map/graph/context-pack internals; no user-facing command/config/schema docs required updates.

### Phase F7 — Security/path/input hardening

Objective:
Close cross-cutting security and unsafe-input findings with shared hardened utilities.

Touchpoints:
- path normalization and containment helpers
- VFS disk-path resolution and URI decode paths
- artifact/schema/manifest parsing boundaries

Subphase F7.1 — Path traversal and containment:
- [x] Resolve VFS/baseDir escape findings and enforce canonical containment checks.
- [x] Remove platform separator ambiguity in path validation.
- [x] Add hard fail behavior for out-of-root resolutions.

Subphase F7.2 — Input validation and fail-closed behavior:
- [x] Enforce strict type validation for manifest/config max-byte settings.
- [x] Enforce reader bounds across JSONL/varint/file-descriptor flows.
- [x] Add malformed URI and malformed payload tests for all public decode entry points.

Tests:
- [x] `tests/shared/path-normalize/path-containment-contract.test.js` (from D1)
- [x] `tests/indexing/vfs/vfs-path-traversal-deny.test.js` (new)
- [x] `tests/shared/jsonl/read-row-max-bytes-enforced.test.js` (new)
- [x] `tests/contracts/manifest-max-bytes-validation.test.js` (new)

Exit criteria:
- [x] Security-relevant findings are fixed with explicit deny-path tests.

F7 status update (2026-02-10T02:53:04.7758141-05:00):
- resolved: hardened `resolveVfsDiskPath` in `src/index/tooling/vfs.js` with canonical root resolution, absolute-path rejection, separator normalization, deny-list traversal handling, and containment checks via `isPathUnderDir`.
- resolved: enforced strict numeric validation for VFS cold-start settings (`maxBytes`, `maxAgeDays`) and manifest max-byte handling with explicit `ERR_MANIFEST_MAX_BYTES` failures in strict mode.
- resolved: enforced JSONL row read bounds in `readJsonlRowAt` with finite-positive `maxBytes` validation (`ERR_INVALID_MAX_BYTES`) and pre-allocation size checks mapped to `ERR_JSON_TOO_LARGE`.
- resolved: added/updated deny-path and malformed-input tests for traversal denial, manifest max-byte validation, JSONL row size enforcement, VFS disk-path safety, and malformed URI decode guard.
- remaining: none (F7 subphases complete).
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this phase.
- exceptions: none.
- sweep results:
  - `rg --line-number "resolveVfsDiskPath|isAbsolutePathAny|isPathUnderDir|VFS virtualPath" src/index/tooling/vfs.js`
  - `rg --line-number "resolveManifestMaxBytes|ERR_MANIFEST_MAX_BYTES|strict" src/shared/artifact-io/manifest.js`
  - `rg --line-number "readJsonlRowAt|maxBytes|ERR_INVALID_MAX_BYTES|toJsonTooLargeError" src/shared/artifact-io/offsets.js`
  - `rg --line-number "vfs path traversal deny|read row max-bytes enforcement|manifest max-bytes validation|LSP URI malformed decode guard" tests -g "*.test.js"`

F7.DOC no-doc-change rationale (2026-02-10T02:53:04.7758141-05:00):
- F7 changes hardened internal path/input validation and error handling contracts without introducing new user-facing commands/config knobs; existing docs remain accurate.

### Phase F8 — Contract-test expansion + coverage inventory

Objective:
Turn one-off bug fixes into enduring contract coverage and keep full `src/**` coverage current.

Touchpoints:
- `tests/**` contract suites
- roadmap manifest and script-coverage tooling

Subphase F8.1 — Contract suite expansion:
- [x] Add/upgrade contract suites across build, language, retrieval, storage, map, and tooling domains.
- [x] Ensure each resolved finding references a corresponding contract or regression test.
- [x] Ensure all new tests use shared env helper (`PAIROFCLEATS_TESTING` setup).

Subphase F8.2 — findings-era coverage tooling removal:
- [x] Remove findings-era `src/**` review coverage script/tooling.
- [x] Remove generated findings-era coverage artifacts.
- [x] Keep CI focused on concrete policy/contract tests only.

Tests:
- [x] `tests/indexing/policy/hotpath-membership-guard.test.js` (new)
- [x] `tests/indexing/policy/module-cache-boundedness-contract.test.js` (new)
- [x] `tests/tooling/service/subprocess-cancellation-contract.test.js` (new)
- [x] existing tooling/docs/tests updated to reflect current intended state

Exit criteria:
- [x] Every resolved finding is test-backed.
- [x] No findings-era coverage tooling remains in tests/scripts/tools.

F8 status update (2026-02-10T03:56:24-05:00):
- resolved: removed findings-era coverage tooling artifacts (`tools/docs/src-review-coverage.js`, `docs/tooling/src-review-coverage.json`, `docs/tooling/src-review-unreviewed-batches-2026-02-10.md`).
- resolved: removed findings-specific contract tests and replaced enforcement with phase-scoped policy contracts (`hotpath-membership-guard`, `module-cache-boundedness-contract`, and subprocess cancellation contract), all using shared test env setup.
- resolved: integrated the replacement policy/contract tests into CI lane order manifests (`tests/ci-lite/ci-lite.order.txt`, `tests/ci/ci.order.txt`) so coverage/test-evidence regressions fail lane execution.
- remaining: none (F8 subphases complete).
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this phase.
- exceptions: none.
- sweep results:
  - `rg --line-number "src-review-coverage|src-review-unreviewed-batches-2026-02-10" tools docs tests -g "!node_modules/**"` (no hits expected for active tooling/tests)
  - `rg --line-number "hotpath membership guard|module cache boundedness contract|subprocess cancellation contract" tests/indexing/policy tests/tooling/service -g "*.test.js"`
  - `rg --line-number "indexing/policy/hotpath-membership-guard|indexing/policy/module-cache-boundedness-contract|tooling/service/subprocess-cancellation-contract" tests/ci-lite/ci-lite.order.txt tests/ci/ci.order.txt`

F8.DOC update (2026-02-10T03:03:53.9305408-05:00):
- Removed findings-era coverage documentation artifacts and references; retained contract-test documentation only.

## Cluster mapping

| Cluster | Phase |
| --- | --- |
| 1 JSONL merge/spill helpers | D2 |
| 2 JSONL writer scaffolding + extension resolution | D2 |
| 3 SQLite build pipeline duplication | D3 |
| 4 SQLite src/tools duplicate helpers | D3 |
| 5 Embedding quantization normalization | D3 |
| 6 SQLite vocab lookup + stmt cache | D3 |
| 7 LMDB codec/presence/meta validation | D3 |
| 8 ANN readiness + backend normalization | D4 |
| 9 API/MCP request mapping drift | D4 |
| 10 Path normalization + containment | D1 |
| 11 Find-upwards logic | D1 |
| 12 Map-based LRU duplicates | D1 |
| 13 Bytes/size formatting + traversal | D1 |
| 14 warn-once variants | D1 |
| 15 Minified-file detection | D1 |
| 16 Root normalization duplicates | D1 |
| 17 File locking variants | D1 |
| 18 Chunking helper duplication | D6 |
| 19 Risk utility duplication | D6 |
| 20 Relative import resolution duplication | D6 |
| 21 Binary discovery helper duplication | D5 |
| 22 TypeScript loader duplication | D5 |
| 23 Signature parsing/readSignatureLines duplication | D5 |
| 24 JS/TS relations duplication | D5 |
| 25 Map filter/escape/config merge duplication | D6 |
| 26 AJV validation scaffolding duplication | D8 |
| 27 Misc helper duplicates | D1/D4/D8 |
| Additional: duplicate `resolveJsonlExtension` within `src/shared/json-stream.js` | D2 |
| Additional: duplicate `normalizeMetaFilters` in API/MCP | D4 |
| Additional: map bench wiring duplication | D7 |
| Additional: repo cache default duplication | D4 |

---

## Documentation update matrix (mandatory per phase)

Rules:
- Complete the phase-specific documentation task in the same commit series as the phase implementation.
- If behavior/contracts/config/scripting changed, update the listed docs before phase completion.
- If no listed doc requires changes, record a one-line `no-doc-change` rationale in phase notes with timestamp.

Phase documentation tasks:

- [x] Task D0.DOC: Update migration and guardrail docs.
Documents: `docs/tooling/dupemap-migration-manifest.json`, `DUPEMAP.md`, `All_Findings.md`, `docs/guides/commands.md`, `docs/config/inventory.json`, `docs/config/inventory.md`.

- [x] Task D1.DOC: Update shared primitive and lifecycle contract docs.
Documents: `docs/specs/*` (shared primitive usage specs touched by migration), `docs/contracts/*` (shared runtime contract docs touched by helper changes), `docs/config/inventory.json`, `docs/config/inventory.md`.

- [x] Task D2.DOC: Update artifact/JSONL streaming and writer docs.
Documents: `docs/contracts/schemas/*` (artifact schemas touched), `docs/specs/*` (artifact writer behavior docs touched), `docs/sqlite/incremental-updates.md`, `docs/tooling/script-inventory.json`.

- [x] Task D3.DOC: Update SQLite/LMDB/quantization/vocab docs.
Documents: `docs/sqlite/*`, `docs/contracts/schemas/*` (storage/index schemas touched), `docs/specs/*` (storage behavior docs touched), `docs/config/inventory.json`.

- [x] Task D4.DOC: Update ANN/API/MCP/search normalization docs.
Documents: `docs/api/mcp-server.md`, `docs/contracts/mcp-tools.schema.json`, `docs/specs/tooling-and-api-contract.md`, `docs/guides/commands.md`, `docs/benchmarks/*` (if query/ann behavior or defaults changed).

- [x] Task D5.DOC: Update tooling and language parser/extractor docs.
Documents: `docs/language/*`, `docs/testing/*` (if test harness/expectation changed), `docs/specs/*` (tooling behavior docs touched), `docs/guides/commands.md`.

- [x] Task D6.DOC: Update chunking/risk/import/map behavior docs.
Documents: `docs/language/*`, `docs/specs/*` (chunking/risk/import/map behavior docs touched), `docs/contracts/*` (if output contracts changed), `docs/testing/*`.

- [x] Task D7.DOC: Update test/bench harness and script coverage docs.
Documents: `docs/testing/*`, `docs/benchmarks/*`, `docs/tooling/script-inventory.json`, `docs/guides/commands.md`.

- [x] Task D8.DOC: Final dedupe docs/contracts/config sync.
Documents: `docs/guides/commands.md`, `docs/config/inventory.json`, `docs/config/inventory.md`, `docs/contracts/*`, `docs/schemas/*`, `docs/tooling/script-inventory.json`.

- [x] Task F0.DOC: Findings program control-plane docs.
Documents: `All_Findings.md`, `DUPEMAP.md`, `docs/guides/commands.md`.

- [x] Task F1.DOC: Build/runtime lifecycle findings docs.
Documents: `docs/contracts/schemas/build-state.js` (and related contract docs in `docs/contracts/*`), `docs/sqlite/incremental-updates.md`, `docs/specs/*` (build/stage lifecycle docs touched).

- [x] Task F2.DOC: Language/chunking/import correctness docs.
Documents: `docs/language/*`, `docs/contracts/*` (language output contracts touched), `docs/testing/*` (new contract-test expectations).

- [x] Task F3.DOC: Artifact/storage crash-safety docs.
Documents: `docs/contracts/schemas/*` (artifact/storage schema docs touched), `docs/sqlite/*`, `docs/specs/*` (I/O safety behavior docs touched), `docs/testing/*`.

- [x] Task F4.DOC: Retrieval/ANN/embeddings reliability docs.
Documents: `docs/benchmarks/*`, `docs/specs/tooling-and-api-contract.md` (if retrieval contract changes), `docs/contracts/*` (retrieval/ANN contracts touched), `docs/perf/*`.

- [x] Task F5.DOC: Tooling/LSP/service resilience docs.
Documents: `docs/api/*`, `docs/specs/*` (tooling/service behavior docs touched), `docs/guides/commands.md`, `docs/testing/*`.

- [x] Task F6.DOC: Map/graph/context-pack correctness docs.
Documents: `docs/specs/*` (map/graph/context-pack behavior docs touched), `docs/testing/*`, `docs/benchmarks/*` (if perf-sensitive map/graph behavior changed).

- [x] Task F7.DOC: Security/path/input hardening docs.
Documents: `docs/contracts/*` (validation constraints touched), `docs/config/*` (new knobs/limits), `docs/specs/*` (security constraints), `docs/guides/*` (user-facing behavior changes).

- [x] Task F8.DOC: Contract-test expansion and coverage-lock docs.
Documents: `docs/testing/*`, `docs/tooling/script-inventory.json`, `docs/guides/commands.md`.

Subphase ordering rule (applies to D1-D8):
1. Foundation extraction: create/lock canonical helper API.
2. Migration pass: move all consumers to canonical API.
3. Deletion pass: remove duplicate bodies and dead exports.
4. Enforcement pass: run sweeps to verify no legacy callsites remain in touched scope.
5. Validation pass: run targeted tests, then lane subset.

---

## Phase D0 — Baseline and migration guardrails

### Objective
Freeze baseline mapping and move immediately into direct remediation work (no new scanner tooling).

### Files
- `docs/tooling/dupemap-migration-manifest.json` (new)
- `DUPEMAP.md`
- `All_Findings.md`
- `docs/guides/commands.md` (update)

### Subphase D0.1 — Manifest and schema
Tasks:
- [x] Task D0.1.a: Create manifest schema sections: `clusters`, `migrations`, `banPatterns`, `exceptions`.
Details: Each migration entry must include `phase`, `oldPathOrSymbol`, `newPathOrSymbol`, `status`.
- [x] Task D0.1.b: Populate initial entries for all 27 clusters plus 4 additional verified clusters.
Details: No placeholder entries; every cluster must have concrete symbols/files.
- [x] Task D0.1.c: Add explicit exception semantics.
Details: Exception entry requires reason + expiry phase; no permanent exceptions.

### Subphase D0.2 — Fix-first execution sequencing
Tasks:
- [x] Task D0.2.a: Convert D0 plan from tooling-build to direct-fix execution.
Details: No additional scanner or audit tools are added in D0.
- [x] Task D0.2.b: Keep remediation slices small and touchpoint-coupled.
Details: Prioritize high-severity and cross-cutting fixes first.
- [x] Task D0.2.c: Confirm each upcoming phase has concrete code/test/doc tasks before implementation.
Details: Avoid generic “infra-first” work that does not fix findings directly.

Execution directives (D0.2 lock-in):
- No new scanner/audit script deliverables are allowed in D0, F0, or as prerequisites for D1+ phase starts.
- Every phase kickoff must name concrete code touchpoints, concrete tests, and concrete docs/contracts updates in the phase body.
- Subphase commits must remain small and touchpoint-coupled: one module family + linked tests + linked docs/contracts updates.
- Within each phase, execute highest-severity and highest-fanout findings first unless an explicit dependency blocks them.

### Subphase D0.3 — Existing-lane enforcement only
Tasks:
- [x] Task D0.3.a: Use existing lane and targeted-test workflow as enforcement.
Details: Fixes are validated through phase tests and existing CI lanes.
- [x] Task D0.3.b: Do not add new scanner/audit scripts as D0 deliverables.
Details: Keep momentum on direct remediation.

Enforcement constraints (D0.3 lock-in):
- Validation for all follow-on phases uses targeted test files plus existing lane subsets (`ci-lite` minimum), not new D0 scanner deliverables.
- Sweep enforcement is done through documented `rg` checks in each phase body and CI lane assertions already present in the repository.
- Any proposal to add scanner/audit tooling must be tied to a later phase objective and cannot block active remediation.

### Tests
- [x] no new D0-specific tooling tests required

### Exit criteria
- [x] Manifest exists and covers all known clusters.
- [x] D0 is explicitly configured for fix-first execution with no new scanner/audit tooling tasks.
- [x] D0.DOC note (2026-02-09T20:54:16-05:00): no additional docs beyond `DUPEMAP.md` and `docs/tooling/dupemap-migration-manifest.json` required for this subphase conversion.

---

## Phase D1 — Shared primitive consolidation

### Objective
Consolidate high fan-out primitives and remove drift-prone helper forks.

### Scope
Clusters: 10, 11, 12, 13, 14, 15, 16, 17 and `escapeRegex`/`pickMinLimit` from 27.

### Canonical targets
- `src/shared/path-normalize.js`
- `src/shared/fs/find-upwards.js` (new)
- `src/shared/cache.js`
- `src/shared/disk-space.js`
- `src/shared/logging/warn-once.js` (new)
- `src/index/build/watch/shared.js` (new)
- `src/shared/locks/file-lock.js` (new)
- `src/shared/text/escape-regex.js` (new)
- `src/index/build/runtime/limits.js` (new)

### Subphase D1.1 — Path and find-upwards utilities
Tasks:
- [x] Task D1.1.a: Add `findUpwards(startDir, predicate, stopDir)`.
Details: Must support deterministic stop condition and symlink-safe behavior.
- [x] Task D1.1.b: Migrate `findGitRoot`, `findJjRoot`, tsconfig search, and repo-root walkups.
Details: Preserve existing stop behavior via predicate wrappers.
- [x] Task D1.1.c: Consolidate path containment checks.
Details: Replace `isInside`/`isPathUnderDir` variants with shared helper.

D1.1 status update (2026-02-09T21:10:22.3605834-05:00):
- resolved: D1.1 dedupe slice for upward walkups and path containment (`findUpwards`, `isPathUnderDir`) with migrated callsites in scm/tooling/repo-path helpers.
- remaining: D1.2–D1.5 tasks and all associated shared primitive migrations.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg "findGitRoot|findJjRoot|resolveNearestTsconfig|find-up" src tools` and `rg "const isInside|function isInside|const isPathUnderDir|function isPathUnderDir" src tools`.

### Subphase D1.2 — Cache/LRU and logging primitives
Tasks:
- [x] Task D1.2.a: Add shared warn-once API supporting keyed and unkeyed usage.
Details: Support logger injection and deterministic key formatting.
- [x] Task D1.2.b: Replace custom Map-LRU implementations with shared cache APIs.
Details: Preserve eviction semantics where externally observable.

D1.2 status update (2026-02-09T21:21:47.5908780-05:00):
- resolved: shared `warn-once` primitive added and migrated in scm/retrieval/json-stream/tooling vector-extension callsites.
- resolved: retrieval cache wrappers (`index`, `sqlite`, `query-plan`) and bounded VFS/scheduler LRU maps now use shared cache APIs.
- remaining: D1.3–D1.5 tasks and additional cache policy/lifecycle contracts.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.

### Subphase D1.3 — Bytes/size/minified/root normalization
Tasks:
- [x] Task D1.3.a: Standardize `formatBytes` usage on `src/shared/disk-space.js`.
Details: Pick one output format and update docs/tests accordingly.
- [x] Task D1.3.b: Standardize directory size traversal helper.
Details: Ensure same skip/exclude policy across tool and runtime.
- [x] Task D1.3.c: Move minified-name/root-normalization to watch shared helper.
Details: Delete local regex/function copies in discover/watch modules.
- [x] Task D1.3.d: Resolve `watch.js` `normalizeRoot` inconsistency during migration.
Details: Ensure watch uses imported helper only.

D1.3 status update (2026-02-09T21:32:49.8741942-05:00):
- resolved: centralized byte formatting and traversal on `src/shared/disk-space.js` via canonical `formatBytes` and `sizeOfPath`.
- resolved: migrated `src/integrations/core/status.js`, `tools/index/cache-gc.js`, `tools/index/report-artifacts.js`, and merge bench scripts to the shared disk-space helper APIs.
- resolved: extracted watch minified/root primitives to `src/index/build/watch/shared.js` and migrated discover/file-scan/watch/guardrails/records callsites.
- remaining: D1.4–D1.5 locking, atomic-write, cache-policy, and lifecycle primitives.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg "const normalizeRoot =|MINIFIED_NAME_REGEX" src/index/build` and `rg "formatBytes\(|sizeOfPath\(" src tools`.

### Subphase D1.4 — Locking and misc primitive helpers
Tasks:
- [x] Task D1.4.a: Implement shared file-lock primitive with stale detection + process-alive checks.
Details: Support configurable lock wait/poll/stale thresholds.
- [x] Task D1.4.b: Migrate index lock, embeddings cache lock, and service queue lock.
Details: Preserve lock scope names and signal handling semantics.
- [x] Task D1.4.c: Add shared `escapeRegex` and `pickMinLimit` helpers; migrate all variants.
Details: Remove duplicate helper bodies after migration.

D1.4 status update (2026-02-09T21:44:53.3841764-05:00):
- resolved: added canonical file locking primitive in `src/shared/locks/file-lock.js` with configurable wait/poll/stale behavior, stale-owner cleanup, and owner-safe release.
- resolved: migrated index/build lock path, embeddings cache lock path, service queue lock path, and sourcekit host lock gating to shared locking.
- resolved: added `src/shared/text/escape-regex.js` and `src/index/build/runtime/limits.js` then migrated duplicate `escapeRegex` and `pickMinLimit` implementations.
- remaining: D1.5 atomic-write, cache-policy, and lifecycle primitives plus associated migrations.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg "escapeRegex\(|pickMinLimit\(" src tools` and `rg "index\.lock|queue\.lock|staleMs|tasklist" src tools`.

### Subphase D1.5 — Atomic write + cache/process lifecycle primitives
Tasks:
- [x] Task D1.5.a: Implement shared `atomicWriteJson` and `atomicWriteText` helpers.
Details: Require temp-file + fsync + rename semantics with Windows-safe behavior and deterministic error surfaces.
- [x] Task D1.5.b: Implement shared cache policy contract helper.
Details: Every cache declares max entries/bytes, TTL, invalidation trigger, and shutdown cleanup hook.
- [x] Task D1.5.c: Implement shared lifecycle registry for timers/workers/promises.
Details: Support explicit `register` + `drain` + `close` flow for deterministic shutdown.
- [x] Task D1.5.d: Migrate high-fanout state/cache writes and lifecycle users to shared helpers.
Details: Prioritize queue/cache/manifest/pointer writers and long-lived service/watch/tooling modules.

D1.5 status update (2026-02-09T22:03:59.5825755-05:00):
- resolved: added `src/shared/io/atomic-write.js` with `atomicWriteJson` and `atomicWriteText` (temp-write + fsync + rename + deterministic error wrapping).
- resolved: added `src/shared/cache/policy.js` with explicit cache policy contract (`maxEntries`, `maxBytes`, `ttlMs`, invalidation trigger, shutdown hook).
- resolved: added `src/shared/lifecycle/registry.js` with `register`, `registerTimer`, `registerWorker`, `registerPromise`, `drain`, and `close`.
- resolved: migrated priority state/cache/manifest/pointer writers to atomic write helper (`src/index/build/import-resolution-cache.js`, `src/index/build/incremental.js`, `tools/service/queue.js`, `src/retrieval/cli/run-search-session.js`, `src/index/build/build-state.js`, `src/index/build/promotion.js`).
- resolved: migrated long-lived timer/promise flows to lifecycle registry in `src/index/build/build-state.js` and `tools/service/indexer-service.js`.
- remaining: D2+ phase work remains (JSONL merge/writer scaffolding and later phases).
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg "writeFileSync\(|writeFile\(|appendFile\(" src tools | rg -v "atomic-write|tests/"` and `rg "new Map\(|new Set\(" src | rg "cache|memo|seen|warn" | rg -v "max|ttl|limit|capacity|tests/"`.

### Exhaustive sweeps
- [x] `rg "const normalizeRoot =|MINIFIED_NAME_REGEX" src/index/build`
- [x] `rg "findGitRoot|findJjRoot|resolveNearestTsconfig|find-up" src tools`
- [x] `rg "warned = new Set|warnOnce" src tools`
- [x] `rg "formatBytes\(|sizeOfPath\(" src tools`
- [x] `rg "escapeRegex\(|pickMinLimit\(" src tools`
- [x] `rg "index\.lock|queue\.lock|staleMs|tasklist" src tools`
- [x] `rg "writeFileSync\(|writeFile\(|appendFile\(" src tools | rg -v "atomic-write|tests/"`
- [x] `rg "new Map\(|new Set\(" src | rg "cache|memo|seen|warn" | rg -v "max|ttl|limit|capacity|tests/"`

### Tests
- [x] `tests/shared/fs/find-upwards-contract.test.js` (new)
- [x] `tests/shared/path-normalize/path-containment-contract.test.js` (new)
- [x] `tests/shared/logging/warn-once.test.js` (new)
- [x] `tests/shared/cache/lru-parity.test.js` (new)
- [x] `tests/shared/disk-space/format-bytes-contract.test.js` (new)
- [x] `tests/shared/locks/file-lock-contract.test.js` (new)
- [x] `tests/indexing/watch/watch-root-normalization.test.js` (new)
- [x] `tests/shared/io/atomic-write-contract.test.js` (new)
- [x] `tests/shared/cache/cache-policy-contract.test.js` (new)
- [x] `tests/shared/lifecycle/lifecycle-registry-contract.test.js` (new)

### Exit criteria
- [x] No D1 duplicate helper bodies remain.
- [x] Ban patterns catch reintroduction of old primitives.

---

## Phase D2 — JSONL merge and artifact writer scaffolding

### Objective
Unify run-merge and artifact writer plumbing to one canonical path.

### Scope
Clusters: 1, 2, plus duplicate `resolveJsonlExtension` inside `src/shared/json-stream.js`.

### Canonical targets
- `src/shared/merge.js`
- `src/shared/json-stream.js`
- `src/index/build/artifacts/writers/_common.js` (new)

### Subphase D2.1 — Merge helper unification
Tasks:
- [x] Task D2.1.a: Expand shared merge API to cover local variant requirements.
Details: Include compare/readRun overrides and parse/error hooks.
- [x] Task D2.1.b: Migrate `src/index/build/artifacts/helpers.js` to shared merge APIs.
Details: Delete local `MinHeap`, `readJsonlRows`, `mergeSortedRuns`.
- [x] Task D2.1.c: Migrate `src/map/build-map/io.js` merge helpers.
Details: Preserve map-specific call semantics with adapter wrapper only.
- [x] Task D2.1.d: Evaluate and migrate local `readJsonlRows` variants in VFS-related modules.
Details: Keep only shared version unless strict functional difference is required.

D2.1 status update (2026-02-09T22:12:23.3819463-05:00):
- resolved: removed local merge helper bodies from `src/index/build/artifacts/helpers.js` and migrated remaining write path to `src/shared/merge.js::writeJsonlRunFile`.
- resolved: removed `MinHeap`/`readJsonlRows`/`mergeSortedRuns` duplicates from `src/map/build-map/io.js` and switched spill merge to `mergeSortedRuns(runs, { compare })`.
- resolved: migrated VFS-local JSONL row readers to shared `readJsonlRows` in `src/index/build/artifacts/writers/vfs-manifest.js` and `src/index/tooling/vfs.js`.
- resolved: migrated downstream read callsites in `src/integrations/tooling/api-contracts.js` and `tools/bench/merge/merge-core-throughput.js` to canonical shared merge exports.
- remaining: D2.2 writer scaffolding/extension resolver consolidation.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg "class MinHeap|function\* readJsonlRows|mergeSortedRuns\(" src`, `rg "resolveJsonlExtension\(" src/index/build/artifacts/writers src/shared/json-stream.js`, `rg "\.parts|\.meta\.json|jsonl\.zst|jsonl\.gz" src/index/build/artifacts/writers`.

### Subphase D2.2 — Writer scaffolding commonization
Tasks:
- [x] Task D2.2.a: Create `_common.js` helpers for extension resolution, cleanup, sizing, and shard/meta output.
Details: API must support all artifact writer combinations.
- [x] Task D2.2.b: Migrate all artifact writers to `_common.js`.
Details: Cover call-sites, chunk-meta, chunk-uid-map, file-relations, risk-interprocedural, symbol-edges, symbol-occurrences, symbols, vfs-manifest.
- [x] Task D2.2.c: Remove writer-local extension resolver and duplicate cleanup logic.
Details: Ensure all writers call canonical helpers.
- [x] Task D2.2.d: Remove duplicate `resolveJsonlExtension` body in `src/shared/json-stream.js`.
Details: Keep one implementation and one export path.

D2.2 status update (2026-02-09T22:25:47.8177996-05:00):
- resolved: added canonical writer scaffolding helper module `src/index/build/artifacts/writers/_common.js` (extension resolution, cleanup path builders, JSONL size measurement, sharded-part/meta construction).
- resolved: migrated writer callsites (`call-sites`, `chunk-meta`, `chunk-uid-map`, `file-relations`, `risk-interprocedural`, `symbol-edges`, `symbol-occurrences`, `symbols`, `vfs-manifest`) to shared writer scaffolding APIs.
- resolved: removed writer-local `resolveJsonlExtension` helper bodies and replaced duplicate cleanup/meta-part mapping blocks with shared helpers.
- resolved: consolidated `resolveJsonlExtension` in `src/shared/json-stream.js` to one exported implementation used by both sharded sync/async write paths.
- remaining: D4+ phase work remains (retrieval/API/MCP/ANN and later phases).
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg "class MinHeap|function\* readJsonlRows|mergeSortedRuns\(" src`, `rg "resolveJsonlExtension\(" src/index/build/artifacts/writers src/shared/json-stream.js`, `rg "\.parts|\.meta\.json|jsonl\.zst|jsonl\.gz" src/index/build/artifacts/writers`.

### Exhaustive sweeps
- [x] `rg "class MinHeap|function\* readJsonlRows|mergeSortedRuns\(" src`
- [x] `rg "resolveJsonlExtension\(" src/index/build/artifacts/writers src/shared/json-stream.js`
- [x] `rg "\.parts|\.meta\.json|jsonl\.zst|jsonl\.gz" src/index/build/artifacts/writers`

### Tests
- [x] `tests/shared/merge/merge-contract.test.js` (new)
- [x] `tests/shared/merge/merge-determinism.test.js` (new)
- [x] `tests/indexing/artifacts/writers/writer-common-contract.test.js` (new)
- [x] `tests/indexing/artifacts/resolution-strictness-parity.test.js` (new)
- [x] `tests/indexing/vfs/vfs-manifest-streaming.test.js` (update)
- [x] `tests/tooling/vfs/vfs-manifest-streaming.test.js` (update; merge plan in D7)

### Exit criteria
- [x] Exactly one merge/read stack and one writer scaffolding stack remain.

---

## Phase D4 — Retrieval/API/MCP/ANN consolidation

### Objective
Unify request/filters/cache config/ANN behavior across API, MCP, and retrieval.

### Scope
Clusters: 8, 9, additional `normalizeMetaFilters` and repo cache defaults duplication, and repo cache manager split from 27.

### Canonical targets
- `src/retrieval/ann/utils.js` (new)
- `src/retrieval/ann/normalize-backend.js` (new)
- `tools/shared/search-request.js` (new)
- `tools/shared/repo-cache-config.js` (new)

### Subphase D4.1 — ANN provider and backend normalization
Tasks:
- [x] Task D4.1.a: Define canonical ANN readiness/gating helper API.
Details: Must encapsulate signal/config/index/candidate-set checks.
- [x] Task D4.1.b: Migrate ANN providers to canonical gating helper.
Details: Remove local gating branches in provider modules.
- [x] Task D4.1.c: Define canonical backend normalization and migrate CLI/pipeline callsites.
Details: Remove divergent backend alias behavior.

D4.1 status update (2026-02-09T22:35:42.9880685-05:00):
- resolved: added canonical ANN gating helpers in `src/retrieval/ann/utils.js` (`isEmbeddingReady`, `isCandidateSetEmpty`, `isAnnProviderAvailable`, `canRunAnnQuery`).
- resolved: added canonical ANN backend normalization in `src/retrieval/ann/normalize-backend.js` and removed `src/retrieval/pipeline/ann-backends.js` shim.
- resolved: migrated ANN providers (`dense`, `hnsw`, `lancedb`, `sqlite-vec`) to shared gating semantics and removed provider-local readiness duplicates.
- resolved: migrated CLI and pipeline backend interpretation to canonical normalizer (`src/retrieval/cli/normalize-options.js`, `src/retrieval/pipeline.js`).
- remaining: D4.2 request/filter normalization and D4.3 repo cache config parity.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg "normalizeAnnBackend|ann-backends|annBackend" src/retrieval`.

### Subphase D4.2 — Search request and filter normalization
Tasks:
- [x] Task D4.2.a: Implement shared request normalizer + argv builder.
Details: API and MCP must call same core function.
- [x] Task D4.2.b: Consolidate `normalizeMetaFilters` into one shared helper.
Details: Remove local duplicates in API/MCP/validation.
- [x] Task D4.2.c: Fix API schema drift.
Details: Resolve `path` vs `paths`, add `filter` support, keep validation strict.

D4.2 status update (2026-02-09T22:50:52.2093313-05:00):
- resolved: added canonical request normalization/argv building in `tools/shared/search-request.js` and migrated API/MCP builders to call this shared core.
- resolved: removed duplicate `normalizeMetaFilters` from API validation and MCP helper stacks; canonical helper now lives in `tools/shared/search-request.js`.
- resolved: fixed API schema/request drift by supporting `paths` alias + `filter` in strict validation and routing both `path`/`paths` through shared normalization.
- remaining: D4.3 repo cache config parity.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `git grep -n -F "normalizeMetaFilters(" -- tools/api tools/mcp tools/shared`, `git grep -n -E "payload\.paths|payload\.path|payload\.filter" -- tools/api`.

### Subphase D4.3 — Repo cache config parity
Tasks:
- [x] Task D4.3.a: Consolidate default cache config values.
Details: API and MCP read from same source.
- [x] Task D4.3.b: Consolidate cache manager behavior and normalization.
Details: Keep explicit override behavior consistent.

D4.3 status update (2026-02-09T22:52:39.1297429-05:00):
- resolved: added canonical repo cache policy defaults/normalization + manager in `tools/shared/repo-cache-config.js`.
- resolved: migrated API cache manager wrapper to shared manager (`tools/api/router/cache.js`).
- resolved: migrated MCP repo cache manager behavior to shared manager (`tools/mcp/repo.js`) while preserving public MCP cache API (`getRepoCaches`, `refreshRepoCaches`, `clearRepoCaches`).
- remaining: phase D4 complete.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `git grep -n -E "DEFAULT_CACHE|cacheConfig|normalizeCacheConfig" -- tools/api tools/mcp tools/shared`.

### Exhaustive sweeps
- [x] `rg "normalizeAnnBackend|ann-backends|annBackend" src/retrieval`
- [x] `rg "normalizeMetaFilters\(" tools/api tools/mcp`
- [x] `rg "payload\.paths|payload\.path|payload\.filter" tools/api`
- [x] `rg "DEFAULT_CACHE|cacheConfig|normalizeCacheConfig" tools/api tools/mcp`

### Tests
- [x] `tests/retrieval/ann/ann-provider-gating-parity.test.js` (new)
- [x] `tests/retrieval/ann/ann-backend-normalization-parity.test.js` (new)
- [x] `tests/retrieval/ann/ann-candidate-set-contract.test.js` (new)
- [x] `tests/tooling/api-mcp/search-request-parity.test.js` (new)
- [x] `tests/tooling/api-mcp/meta-filter-normalization.test.js` (new)
- [x] `tests/tooling/api-mcp/repo-cache-config-parity.test.js` (new)
- [x] existing API/MCP/ANN suites updated for canonical path

### Exit criteria
- [x] API and MCP normalize requests identically.
- [x] ANN providers share one gating + backend interpretation path.

---

## Phase D5 — Tooling and language front-end consolidation

### Objective
Consolidate duplicated tooling utilities and shared language parsing/extraction logic.

### Scope
Clusters: 21, 22, 23, 24.

### Canonical targets
- `src/index/tooling/binary-utils.js` (new)
- `src/index/tooling/typescript/load.js` (new)
- `src/index/tooling/signature-parse/shared.js` (new)
- `src/lang/shared/signature-lines.js` (new)
- `src/lang/js-ts/relations-shared.js` (new)

### Subphase D5.1 — Tooling utility consolidation
Tasks:
- [x] Task D5.1.a: Extract shared binary discovery helper from doctor/pyright/tools.
Details: Preserve Windows suffix/path search behavior.
- [x] Task D5.1.b: Extract shared TypeScript loader helper.
Details: Preserve lookup order and fallback semantics.
- [x] Task D5.1.c: Migrate all callsites and delete local implementations.
Details: No duplicate copies remain.

D5.1 status update (2026-02-09T22:58:09.6974883-05:00):
- resolved: added canonical binary discovery helpers in `src/index/tooling/binary-utils.js` and migrated `doctor`, `pyright-provider`, and `tools/tooling/utils.js` callsites.
- resolved: added canonical TypeScript loader helpers in `src/index/tooling/typescript/load.js` and migrated `src/index/tooling/doctor.js`, `src/index/tooling/typescript-provider.js`, and `src/lang/typescript/parser.js`.
- resolved: removed duplicated local helper bodies (`candidateNames`, `findBinaryInDirs`, local async/sync TypeScript loader copies) from migrated modules.
- remaining: D5.2 signature parsing primitives and D5.3 JS/TS relations shared core.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `git grep -n -E "findBinaryInDirs|candidateNames|resolveTypeScript|loadTypeScript" -- src tools`.

### Subphase D5.2 — Signature parsing primitives
Tasks:
- [x] Task D5.2.a: Add shared signature splitting primitives for clike/python/swift.
Details: Handle nesting/quotes consistently.
- [x] Task D5.2.b: Add shared `readSignatureLines` helper and migrate language modules.
Details: Keep language-specific post-processing local.
- [x] Task D5.2.c: Remove duplicate helper bodies.
Details: Ban legacy helper names.

D5.2 status update (2026-02-09T23:09:10.7677920-05:00):
- resolved: added shared signature split primitives in `src/index/tooling/signature-parse/shared.js` and migrated clike/python/swift signature parsers to consume them.
- resolved: added shared signature line reader in `src/lang/shared/signature-lines.js` and migrated C-like/TS/perl/php/rust/shell language modules to shared `readSignatureLines`.
- resolved: removed duplicated `split*Params`, `findTopLevelIndex`, and `readSignatureLines` helper bodies from migrated modules while preserving parser/language-specific post-processing behavior.
- remaining: D5.3 JS/TS relations shared core.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `git grep -n -E "split.*Params|readSignatureLines" -- src/lang src/index/tooling/signature-parse`.

### Subphase D5.3 — JS/TS relations shared core
Tasks:
- [x] Task D5.3.a: Extract shared AST walk/callee/call-location logic.
Details: Keep parser setup and syntax-specific exceptions in per-language files.
- [x] Task D5.3.b: Migrate JS and TS relation builders to shared core.
Details: Preserve existing relation output contract.

D5.3 status update (2026-02-09T23:15:49.7166137-05:00):
- resolved: added shared JS/TS relation helpers in `src/lang/js-ts/relations-shared.js` for call-location normalization and callee decomposition.
- resolved: migrated both `src/lang/javascript/relations.js` and `src/lang/typescript/relations.js` to shared callee/call-location helpers while keeping parser/walk-specific behavior local.
- resolved: added explicit JS and TS relation contract tests to lock `callDetails` output semantics (`calleeRaw`, `calleeNormalized`, `receiver`, location fields).
- remaining: phase D5 complete.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `git grep -n -E "resolveCalleeParts|resolveCallLocation" -- src/lang/javascript src/lang/typescript src/lang/js-ts`.

### Exhaustive sweeps
- [x] `rg "findBinaryInDirs|candidateNames|resolveTypeScript|loadTypeScript" src tools`
- [x] `rg "split.*Params|readSignatureLines" src/lang src/index/tooling/signature-parse`
- [x] `rg "resolveCalleeParts|resolveCallLocation" src/lang/javascript src/lang/typescript`

### Tests
- [x] `tests/tooling/binary-utils-parity.test.js` (new)
- [x] `tests/tooling/typescript-loader-parity.test.js` (new)
- [x] `tests/tooling/signature-parse/shared-splitter.test.js` (new)
- [x] language signature/metadata tests updated
- [x] `tests/lang/contracts/javascript-relations-contract.test.js` (new)
- [x] `tests/lang/contracts/typescript-relations-contract.test.js` (new)

### Exit criteria
- [x] All tooling and language helper duplicates in scope are centralized.

---

## Phase D3 — Storage consolidation (SQLite/LMDB/quantization/vocab)

### Objective
Eliminate storage correctness drift by consolidating duplicated storage logic.

### Scope
Clusters: 3, 4, 5, 6, 7.

### Canonical targets
- `src/storage/sqlite/build/core.js` (new)
- `src/storage/sqlite/build/output-paths.js`
- `src/storage/sqlite/build/index-state.js`
- `src/storage/sqlite/quantization.js` (new)
- `src/storage/sqlite/vocab.js` (new)
- `src/storage/lmdb/utils.js` (new)

### Subphase D3.1 — SQLite build core
Tasks:
- [x] Task D3.1.a: Extract shared DB open/pragmas/schema/setup/insert pipeline core.
Details: Keep source enumeration in adapter modules.
- [x] Task D3.1.b: Refactor `from-artifacts` to adapter usage.
Details: Remove shared logic duplicates after migration.
- [x] Task D3.1.c: Refactor `from-bundles` to adapter usage.
Details: Preserve bundle-specific buffering/vector insertion.

D3.1 status update (2026-02-09T23:35:24.4525105-05:00):
- resolved: added canonical sqlite build core helper module `src/storage/sqlite/build/core.js` for shared batch/stat normalization, DB open/pragmas/schema setup, multi-row inserter setup, transaction accounting, post-commit validation/optimization, and cleanup.
- resolved: refactored `src/storage/sqlite/build/from-artifacts.js` to consume shared core helpers while preserving artifact-specific source enumeration/staging ingestion behavior.
- resolved: refactored `src/storage/sqlite/build/from-bundles.js` to consume shared core helpers while preserving bundle loader, progress logging, embedding/vector-ann insertion, and failure fallback contract.
- remaining: D3.2 completed previously; D3.3 quantization/vocab parity and D3.4 LMDB utility consolidation remain.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg --line-number 'createInsertStatements|createMultiRowInserter|applyBuildPragmas|restoreBuildPragmas|validateSqliteDatabase|resolveSqliteBatchSize|bumpSqliteBatchStat' src/storage/sqlite/build/from-artifacts.js src/storage/sqlite/build/from-bundles.js`; `rg --line-number 'createBuildExecutionContext|openSqliteBuildDatabase|createSqliteBuildInsertContext|runSqliteBuildPostCommit|closeSqliteBuildDatabase' src/storage/sqlite/build/from-artifacts.js src/storage/sqlite/build/from-bundles.js src/storage/sqlite/build/core.js`.

### Subphase D3.2 — src/tools SQLite helper unification
Tasks:
- [x] Task D3.2.a: Remove duplicate `tools/build/sqlite/output-paths.js`.
Details: Update tool imports to canonical source module.
- [x] Task D3.2.b: Consolidate index-state helper implementation.
Details: Keep one module and remove duplicate.
- [x] Task D3.2.c: Remove duplicate no-op task factories where shared utility exists.
Details: Ensure runner and tools use one task-factory source.

D3.2 status update (2026-02-09T23:25:58.0431998-05:00):
- resolved: removed duplicate `tools/build/sqlite/output-paths.js` and migrated all callsites/tests to canonical `src/storage/sqlite/build/output-paths.js`.
- resolved: removed duplicate `tools/build/sqlite/index-state.js`; `compact-sqlite-index` now imports canonical `src/storage/sqlite/build/index-state.js`.
- resolved: centralized no-op task helper in `src/shared/cli/noop-task.js` and migrated sqlite runner/tool display task-factory fallback to shared helper.
- remaining: D3.1 sqlite build core extraction, D3.3 quantization/vocab parity, D3.4 LMDB utilities.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg --line-number --glob '*.js' 'tools/build/sqlite/output-paths\\.js|tools/build/sqlite/index-state\\.js' src tools tests`; `rg --line-number --glob '*.js' 'function createNoopTask\\(|const createNoopTask\\s*=|resolveTaskFactory\\s*=\\s*\\(' src tools tests`; `rg --line-number 'output-paths\\.js|index-state\\.js|createNoopTask' src tools/build/sqlite tools/shared tests`.

### Subphase D3.3 — Quantization and vocab parity
Tasks:
- [x] Task D3.3.a: Extract canonical quantization metadata resolver.
Details: Retrieval and ranking must consume this resolver directly.
- [x] Task D3.3.b: Replace retrieval-side levels/scale derivation duplicates.
Details: Remove manual derivation branches.
- [x] Task D3.3.c: Extract canonical vocab fetch + statement cache helper.
Details: Build/retrieval call the same API.

D3.3 status update (2026-02-09T23:42:32.5534052-05:00):
- resolved: added canonical quantization resolver module `src/storage/sqlite/quantization.js` and migrated storage/runtime/tooling callsites from vector-local imports to canonical quantization imports.
- resolved: replaced retrieval dense-meta manual levels/scale derivation with `resolveDenseMetaRecord` in `src/retrieval/sqlite-helpers.js`.
- resolved: added canonical vocab module `src/storage/sqlite/vocab.js`, migrated incremental build + retrieval callsites, and removed legacy duplicate `src/storage/sqlite/build/vocab.js`.
- remaining: D3.4 LMDB utility consolidation.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg --line-number \"resolveQuantizationParams|levels\\s*\\?|scale\\s*=\\s*\\(\" src/retrieval src/storage`; `rg --line-number \"fetchVocabRows\\(\" src/storage src/retrieval`.

### Subphase D3.4 — LMDB utils consolidation
Tasks:
- [x] Task D3.4.a: Add shared LMDB presence checker and codec factory.
Details: Include `data.mdb` checks and decode behavior.
- [x] Task D3.4.b: Add shared LMDB meta/schema validation helpers.
Details: Centralize required-key checks.
- [x] Task D3.4.c: Migrate retrieval/validate/status callsites and delete local variants.
Details: No duplicate `new Unpackr` helpers remain outside shared module.

D3.4 status update (2026-02-09T23:50:33.7948359-05:00):
- resolved: added canonical LMDB utility module `src/storage/lmdb/utils.js` with shared presence check (`hasLmdbStore`), codec factory (`createLmdbCodec`), decode helper (`decodeLmdbValue`), schema/mode validation (`validateLmdbSchemaAndMode`), and required-artifact validation (`validateLmdbArtifactKeys`).
- resolved: migrated retrieval callsites (`src/retrieval/cli-lmdb.js`, `src/retrieval/lmdb-helpers.js`, `src/retrieval/cli/index-loader.js`) and validation/status callsites (`src/index/validate/lmdb.js`, `src/index/validate/lmdb-report.js`, `src/integrations/core/status.js`) to canonical LMDB utilities.
- resolved: removed local `Unpackr` decode and `data.mdb` presence helper variants from retrieval/validate/status paths in scope.
- remaining: phase D3 complete.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg --line-number \"new Unpackr|data\\.mdb|hasLmdb|isLmdb\" src/retrieval src/index/validate src/integrations/core src/storage/lmdb`.

### Exhaustive sweeps
- [x] `rg "resolveQuantizationParams|levels\s*\?|scale\s*=\s*\(" src/retrieval src/storage`
- [x] `rg "fetchVocabRows\(" src/storage src/retrieval`
- [x] `rg "new Unpackr|data\.mdb|hasLmdb|isLmdb" src`
- [x] `rg "output-paths\.js|index-state\.js|createNoopTask" src tools/build/sqlite tools/shared`

### Tests
- [x] `tests/storage/sqlite/build/sqlite-build-core-contract.test.js` (new)
- [x] `tests/storage/sqlite/quantization/quantization-parity.test.js` (new)
- [x] `tests/storage/sqlite/vocab/vocab-fetch-parity.test.js` (new)
- [x] `tests/storage/lmdb/lmdb-utils-contract.test.js` (new)
- [x] existing SQLite/LMDB suites updated for canonical paths

### Exit criteria
- [x] Build/retrieval storage paths share single quantization/vocab semantics.
- [x] LMDB presence/decode/validation logic is centralized.

---

## Phase D6 — Chunking, risk, import resolution, and map consolidation

### Objective
Consolidate remaining duplicated domain helpers and map subsystem duplicates.

### Scope
Clusters: 18, 19, 20, 25.

### Canonical targets
- `src/index/chunking/helpers.js` (new)
- `src/index/risk/shared.js` (new)
- `src/index/shared/import-candidates.js` (new)
- `src/map/shared/escape-html.js` (new)
- `src/map/build-map/filters.js` (single API)

### Subphase D6.1 — Chunking helper extraction
Tasks:
- [x] Task D6.1.a: Extract `buildChunksFromLineHeadings` into shared chunking helper module.
Details: Include identical heading/title transform behavior.
- [x] Task D6.1.b: Extract `buildChunksFromMatches` helper.
Details: Keep match regex definitions in format modules.
- [x] Task D6.1.c: Migrate ini-toml/yaml/rst-asciidoc/markdown modules and delete local copies.
Details: No duplicate helper bodies remain.

D6.1 status update (2026-02-09T23:56:14.0203598-05:00):
- resolved: added canonical chunking helper module `src/index/chunking/helpers.js` with shared `buildChunksFromLineHeadings` and `buildChunksFromMatches`.
- resolved: migrated `src/index/chunking/formats/ini-toml.js`, `src/index/chunking/formats/yaml.js`, `src/index/chunking/formats/rst-asciidoc.js`, and `src/index/chunking/formats/markdown.js` to canonical helpers and removed local helper bodies.
- resolved: migrated `src/index/chunking/dispatch.js` to import shared `buildChunksFromLineHeadings` to keep one helper source for chunking line-heading segmentation.
- remaining: D6.2 risk utility extraction and D6.3 import candidate/map cleanup.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg --line-number "buildChunksFromLineHeadings|buildChunksFromMatches" src/index/chunking`.

### Subphase D6.2 — Risk utility extraction
Tasks:
- [x] Task D6.2.a: Extract shared severity rank and identifier boundary logic.
Details: Single-file and interprocedural engines import from one module.
- [x] Task D6.2.b: Extract shared rule pattern match helper.
Details: Preserve existing match semantics.
- [x] Task D6.2.c: Remove duplicate constants/functions in risk modules.
Details: ban duplicate symbols via manifest.

D6.2 status update (2026-02-09T23:59:07.3289697-05:00):
- resolved: added canonical risk utility module `src/index/risk/shared.js` with shared `SEVERITY_RANK`, identifier boundary matching (`containsIdentifier`), and rule pattern matcher (`matchRulePatterns`).
- resolved: migrated `src/index/risk.js` to shared severity rank, identifier boundary checks, and pattern matching helper while preserving rule language/required-regex gating behavior.
- resolved: migrated `src/index/risk-interprocedural/engine.js` to shared severity rank, identifier matching, and rule pattern matcher for arg-aware taint checks.
- remaining: D6.3 import candidate and map helper consolidation.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg --line-number "SEVERITY_RANK|identifier.*boundary|rule.*match" src/index/risk.js src/index/risk-interprocedural/engine.js src/index/risk/shared.js`.

### Subphase D6.3 — Import candidate and map cleanup
Tasks:
- [x] Task D6.3.a: Extract shared import candidate generation function for build/crossfile paths.
Details: Parameterize extensions and existence checks.
- [x] Task D6.3.b: Remove duplicate map filter APIs (`applyScopeFilter`, `applyCollapse`) after consumer migration.
Details: retain only canonical create-transform APIs.
- [x] Task D6.3.c: Add shared HTML escape helper and migrate dot/html writers.
Details: one escape implementation.
- [x] Task D6.3.d: Standardize config merge usage in map client and shared config.
Details: Decide array merge semantics and document explicitly.

D6.3 status update (2026-02-10T00:04:55.9378494-05:00):
- resolved: added canonical import candidate module `src/index/shared/import-candidates.js` and migrated `src/index/type-inference-crossfile/resolve-relative-import.js` plus `src/index/build/import-resolution.js` to shared candidate resolution.
- resolved: removed duplicate map filter APIs `applyScopeFilter`/`applyCollapse` from `src/map/build-map/filters.js`, retaining canonical `createScopeFilters` and `createCollapseTransform` API usage.
- resolved: added shared HTML escape helper `src/map/shared/escape-html.js` and migrated `src/map/html-writer.js` and `src/map/dot-writer.js` to canonical escaping.
- resolved: standardized map client config merge on `src/shared/config.js::mergeConfig` by migrating `src/map/isometric/client/dom.js` and documenting array override semantics in shared config.
- remaining: phase D6 complete.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this dedupe-only subphase.
- exceptions: none.
- sweep results: `rg --line-number "resolve-relative-import|import-resolution" src/index`; `rg --line-number "applyScopeFilter|applyCollapse|escapeHtml|mergeConfig" src/map src/shared`.

### Exhaustive sweeps
- [x] `rg "buildChunksFromLineHeadings|buildChunksFromMatches" src/index/chunking`
- [x] `rg "SEVERITY_RANK|identifier.*boundary|rule.*match" src/index/risk.js src/index/risk-interprocedural/engine.js src/index/risk/shared.js`
- [x] `rg "resolve-relative-import|import-resolution" src/index`
- [x] `rg "applyScopeFilter|applyCollapse|escapeHtml|mergeConfig" src/map src/shared`

### Tests
- [x] `tests/indexing/chunking/chunking-helper-parity.test.js` (new)
- [x] `tests/indexing/risk/risk-shared-utils-parity.test.js` (new)
- [x] `tests/indexing/type-inference/import-candidates-parity.test.js` (new)
- [x] `tests/map/map-filter-api-contract.test.js` (new)
- [x] `tests/map/html-escape-contract.test.js` (new)
- [x] map config merge behavior test (new)

### Exit criteria
- [x] No duplicated chunking/risk/import/map helper stacks remain in scope.

---

## Phase D7 — Test and benchmark dedupe with scenario-preserving merges

### Objective
Reduce duplicated tests and bench wiring while preserving scenario coverage and readability.

### Subphase D7.1 — Retrieval ANN pipeline tests
Tasks:
- [x] Task D7.1.a: Extract shared ANN pipeline fixture/setup helper.
Details: Create `tests/retrieval/pipeline/helpers/ann-scenarios.js`.
- [x] Task D7.1.b: Keep separate scenario assertions.
Details: Missing-provider and provider-failure remain distinct tests.
- [x] Task D7.1.c: Update test names to reflect scenario matrix clearly.

D7.1 status update (2026-02-10T00:08:55.4192957-05:00):
- resolved: added shared ANN pipeline test fixture helper `tests/retrieval/pipeline/helpers/ann-scenarios.js` for common retrieval pipeline context/index setup.
- resolved: migrated `tests/retrieval/pipeline/ann-optional-skip.test.js` and `tests/retrieval/pipeline/ann-preflight.test.js` to shared helper with scenario-specific assertions preserved.
- resolved: standardized scenario naming in test output (`ann-missing-provider-fallback`, `ann-provider-preflight-failure-fallback`) while keeping missing-provider and provider-preflight-failure as separate tests.
- remaining: D7.2-D7.6 pending.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this test-dedupe subphase.
- exceptions: none.
- sweep results: `rg --line-number "ann-scenarios|ann-missing-provider-fallback|ann-provider-preflight-failure-fallback" tests/retrieval/pipeline`.

### Subphase D7.2 — Interprocedural flow cap tests
Tasks:
- [x] Task D7.2.a: Build parameterized flow-cap matrix helper.
Details: Inputs: conservative/max/overflow edge cases.
- [x] Task D7.2.b: Convert duplicated flow tests to matrix-driven assertions.
Details: Maintain current expected counts and failure messages.

D7.2 status update (2026-02-10T00:11:52.8315093-05:00):
- resolved: added shared flow-cap matrix helper `tests/indexing/risk/interprocedural/helpers/flow-cap-matrix.js` for reusable interprocedural risk chunks/runtime assembly and scenario execution.
- resolved: replaced duplicated standalone cap tests (`flows-conservative`, `flows-max-total-flows`, `flows-timeout`) with matrix-driven assertions in `tests/indexing/risk/interprocedural/flows-cap-matrix.test.js`.
- resolved: preserved scenario-specific assertions/messages for conservative flow emission, `maxTotalFlows=0` cap handling, and timeout overflow behavior.
- remaining: D7.3-D7.6 pending.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this test-dedupe subphase.
- exceptions: none.
- sweep results: `rg --line-number "flows-conservative|flows-max-total-flows|flows-timeout|runFlowCapScenario" tests/indexing/risk/interprocedural`.

### Subphase D7.3 — VFS and SQLite streaming tests
Tasks:
- [x] Task D7.3.a: Create shared VFS streaming fixture/assert helper.
Details: Keep indexing and tooling entrypoint assertions separate.
- [x] Task D7.3.b: Build compression matrix harness for chunk-meta/gzip/zstd streaming tests.
Details: Codec-specific assertions remain explicit.

D7.3 status update (2026-02-10T00:26:11.5424736-05:00):
- resolved: added shared VFS streaming fixture helper `tests/helpers/vfs-streaming-fixture.js` and migrated `tests/indexing/vfs/vfs-manifest-streaming.test.js` and `tests/tooling/vfs/vfs-manifest-streaming.test.js` to it with separate entrypoint assertions preserved.
- resolved: added shared SQLite JSONL streaming compression matrix helper `tests/storage/sqlite/helpers/jsonl-streaming-matrix.js` and migrated `tests/storage/sqlite/sqlite-jsonl-streaming-gzip.test.js` and `tests/storage/sqlite/sqlite-jsonl-streaming-zstd.test.js` with codec-specific assertions preserved.
- resolved: applied shared env setup via `applyTestEnv()` at helper entrypoints for both new helper modules.
- remaining: D7.4-D7.6 pending.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this test-dedupe subphase.
- exceptions: none.
- sweep results: `rg --line-number "createVfsStreamingFixture|runSqliteJsonlStreamingCompressionCase" tests/helpers tests/indexing/vfs tests/tooling/vfs tests/storage/sqlite`.

### Subphase D7.4 — Graph/symbol/sqlite build test harness cleanup
Tasks:
- [x] Task D7.4.a: Extract shared graph perf contract bench helper.
Details: Keep context-pack vs neighborhood assertions distinct.
- [x] Task D7.4.b: Extract shared symbol artifact setup helper.
Details: Keep smoke vs by-file-index assertions distinct.
- [x] Task D7.4.c: Extract shared sqlite build fixture setup helper.
Details: Keep rowcount and fast-path validator assertions distinct.

D7.4 status update (2026-02-10T00:34:21.5068780-05:00):
- resolved: added shared graph bench fixture helper `tests/perf/helpers/graph-bench-fixture.js` and migrated graph bench contract tests while preserving distinct context-pack and neighborhood assertions.
- resolved: added shared symbol artifact setup helper `tests/indexing/artifacts/symbols/helpers/symbol-artifact-fixture.js` and migrated smoke/by-file index suites while preserving scenario-specific assertions.
- resolved: added shared sqlite build fixture helper `tests/storage/sqlite/helpers/build-fixture.js` and migrated rowcount + validate-auto fast-path suites with distinct assertion paths preserved.
- remaining: D7.5-D7.6 pending.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this test-dedupe subphase.
- exceptions: none.
- sweep results: `rg --line-number "createGraphBenchFixture|runGraphBenchCompare|createSymbolArtifactChunks|runSymbolArtifactWriters|setupSqliteBuildFixture" tests/perf tests/indexing/artifacts tests/storage/sqlite`.

### Subphase D7.5 — Bench script dedupe
Tasks:
- [x] Task D7.5.a: Extract shared static server/wiring helper for map viewer benches.
Details: Migrate `viewer-fps` and `viewer-lod-stress`.
- [x] Task D7.5.b: Extract shared map bench build options helper.
Details: Migrate `build-map-memory` and `build-map-streaming`.

D7.5 status update (2026-02-10T00:39:18.2797819-05:00):
- resolved: added shared map bench helper module `tools/bench/map/shared.js` with `startMapViewerStaticServer` and migrated `viewer-fps` + `viewer-lod-stress` to shared static server/wiring.
- resolved: added shared build option/input resolver in `tools/bench/map/shared.js` and migrated `build-map-memory` + `build-map-streaming` to shared map bench option handling.
- resolved: normalized run-count parsing into shared helper for map build benches.
- remaining: none.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this bench-dedupe subphase.
- exceptions: none.
- sweep results: `rg --line-number "startMapViewerStaticServer|resolveMapBenchInputs|resolveRuns" tools/bench/map`.

D7 completion status update (2026-02-10T03:50:51.6797683-05:00):
- resolved: validated merged suites individually with scenario assertions preserved for ANN pipeline, flow-cap matrix, VFS streaming, SQLite JSONL streaming, graph bench contracts, symbol artifacts, and sqlite build rowcount/validate-auto tests.
- resolved: validated script-coverage suite wiring and benchmark coverage (`tests/tooling/script-coverage/wiring.test.js`, `tests/tooling/script-coverage/script-coverage-core.test.js`, `tests/tooling/script-coverage/script-coverage-benchmarks.test.js`).
- resolved: no additional D7 work remains.
- remaining: none.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for D7 closeout.
- exceptions: none.
- no-doc-change rationale (2026-02-10T03:50:51.6797683-05:00): D7 touched tests/bench harness internals only; existing docs remained accurate.

### Tests
- [x] merged suites run individually and preserve scenario assertions
- [x] script-coverage suites updated for new helper locations

### Exit criteria
- [x] Duplicate test/bench setup blocks moved into shared helpers.
- [x] Scenario coverage matrix is unchanged or improved.

---

## Phase D8 — Final hardening and closeout

### Objective
Consolidate remaining validation/fetch duplicates, lock CI rules, and close the roadmap.

### Scope
Cluster 26 and remaining cluster 27 items.

### Canonical targets
- `src/shared/validation/ajv-factory.js` (new)
- `tools/download/shared-fetch.js` (new)

### Subphase D8.1 — Validation scaffolding consolidation
Tasks:
- [x] Task D8.1.a: Implement shared Ajv factory for config/contracts/API validators.
Details: Support schema flavor/options required by each caller.
- [x] Task D8.1.b: Migrate validators to factory.
Details: Keep existing error message contract unless intentionally revised.
- [x] Task D8.1.c: Remove duplicated Ajv bootstrap logic.

D8.1 status update (2026-02-10T00:47:01.2399605-05:00):
- resolved: implemented shared Ajv factory module `src/shared/validation/ajv-factory.js` with dialect selection, schema cloning helper, and guarded compile helper.
- resolved: migrated validator callsites in `src/config/validate.js`, `tools/api/validation.js`, `src/contracts/validators/{build-state,artifacts,analysis}.js`, and `src/index/build/failure-taxonomy.js` to use shared factory helpers while preserving caller option sets and error formatting behavior.
- resolved: added `tests/shared/validation/ajv-factory-contract.test.js` with `applyTestEnv()` bootstrap and contract assertions for dialect selection, clone semantics, and compile guard behavior.
- remaining: D8.2-D8.3 pending.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this validation-dedupe subphase.
- exceptions: none.
- sweep results: `rg --line-number "new Ajv|ajv/dist/2020\\.js|cloneSchema|createAjv|compileSchema" src/config/validate.js tools/api/validation.js src/contracts/validators src/index/build/failure-taxonomy.js src/shared/validation/ajv-factory.js`.

### Subphase D8.2 — Download fetch helper consolidation
Tasks:
- [x] Task D8.2.a: Implement shared redirect-aware fetch helper.
Details: Include redirect limit, timeout, and deterministic error formatting.
- [x] Task D8.2.b: Migrate dict and extension download tooling.
Details: Preserve existing auth/env behavior.
- [x] Task D8.2.c: Remove local duplicated fetch/redirect loops.

D8.2 status update (2026-02-10T00:51:56.5012142-05:00):
- resolved: added shared download fetch helper `tools/download/shared-fetch.js` with redirect handling, timeout support, bounded response-size checks, and deterministic request error formatting.
- resolved: migrated `tools/download/dicts.js` and `tools/download/extensions.js` to use shared `fetchDownloadUrl` with existing caller headers/size behavior preserved and per-script policy passthrough.
- resolved: extended shared download policy normalization in `tools/shared/download-utils.js` to include optional `timeoutMs` and `maxRedirects` inputs for download callsites.
- resolved: added `tests/tooling/download/shared-fetch-contract.test.js` with `applyTestEnv()` and contract assertions for redirect follow, stream/buffer modes, maxBytes, missing redirect location, redirect loops, and timeout failures.
- remaining: D8.3 pending.
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this download-dedupe subphase.
- exceptions: none.
- sweep results: `rg --line-number "function requestUrl\\(|fetchDownloadUrl|shared-fetch" tools/download`.

### Subphase D8.3 — Final migration lock and docs sync
Tasks:
- [x] Task D8.3.a: Run final legacy-usage sweeps for all migrated symbols/modules.
Details: Record sweep commands and results in phase notes.
- [x] Task D8.3.b: Run full docs/contracts/config command docs sync.
Details: `docs/guides/commands.md`, config schema/inventory, relevant contracts.
- [x] Task D8.3.c: Ensure CI includes representative lanes for touched domains.
Details: include ci-lite and ci-long execution points.

D8.3 status update (2026-02-10T00:57:03.8919931-05:00):
- resolved: executed final legacy-usage sweeps for D8 migrations and verified no residual local implementations remained in migrated surfaces.
- resolved: sweep commands/results:
  - `rg --line-number "new Ajv|ajv/dist/2020\\.js|cloneSchema\\s*=\\s*\\(" src/config/validate.js tools/api/validation.js src/contracts/validators/build-state.js src/contracts/validators/artifacts.js src/contracts/validators/analysis.js src/index/build/failure-taxonomy.js` -> no matches.
  - `rg --line-number "function requestUrl\\(" tools/download` -> no matches.
  - `rg --line-number "fetchDownloadUrl\\(" tools/download/dicts.js tools/download/extensions.js` -> both callsites present.
- resolved: ran docs/contracts/config sync commands:
  - `node tools/docs/script-inventory.js`
  - `node tools/config/inventory.js`
  - `node tools/config/contract-doc.js`
- resolved: validated docs/contracts/config sync and script surface with tests:
  - `node tests/indexing/policy/script-surface-policy.test.js` (pass)
  - `node tests/tooling/docs/config-inventory-sync.test.js` (pass)
  - `node tests/tooling/docs/config-contract-doc.test.js` (pass)
  - `node tests/ci/npm-script-targets.test.js` (pass)
- resolved: hardened CI lane coverage for touched D8 domains by adding `shared/validation/ajv-factory-contract` and `tooling/download/shared-fetch-contract` to `tests/ci-lite/ci-lite.order.txt` and `tests/ci-long/ci-long.order.txt`, and replacing stale D7 flow-cap IDs with `indexing/risk/interprocedural/flows-cap-matrix`.
- resolved: verified lane manifests: `node tests/run.js --lane ci-lite --list --json` and `node tests/run.js --lane ci-long --list --json` both pass.
- remaining: none (D8 subphases complete).
- severity snapshot: critical=0, high=0, medium=n/a, low=n/a for this migration-lock/docs subphase.
- exceptions: none.

### Tests
- [x] `tests/shared/validation/ajv-factory-contract.test.js` (new)
- [x] `tests/tooling/download/shared-fetch-contract.test.js` (new)
- [x] tooling docs tests updated and passing

---

# Sweet16 Roadmap

## Status legend

Checkboxes represent the state of the work, update them to reflect the state of work as its being done:
- [x] Implemented and appears complete/correct based on code inspection and existing test coverage
- [@] In Progress, this work has been started
- [.] Work has been completed but has Not been tested
- [?] There is a correctness gap **or** there is missing/insufficient test proving behavior
- [ ] Not complete

Completed Phases: `COMPLETED_PHASES.md`

### Phase status summary (update as you go)
| Phase | Status | Notes |
| --- | --- | --- |
| 16.0 | [@] | Specs drafted; tests pending |
| 16.1 | [x] | Scheduler core + stage wiring + embeddings integration + tests/bench complete |
| 16.2 | [@] | Core pipeline complete; loader hardening + contract/fuzz gaps tracked in 16.16 |
| 16.3 | [@] | Cache key schema/helpers in progress |
| 16.4 | [ ] |  |
| 16.5 | [ ] |  |
| 16.13 | [x] |  |
| 16.14 | [x] |  |
| 16.6 | [x] |  |
| 16.7 | [x] | Stage2 relations/filter-index hardening + tests/bench complete |
| 16.8 | [x] |  |
| 16.9 | [x] |  |
| 16.10 | [x] |  |
| 16.11 | [x] |  |
| 16.12 | [x] |  |
| 16.15 | [@] | Bench harness delivered; acceptance/coverage remediations tracked in 16.16 |
| 16.16 | [x] | SWEETREPORT remediation and acceptance closeout completed |

### Source-of-truth hierarchy (when specs disagree)
When a document/spec conflicts with the running code, follow this order:

1) **`src/contracts/**` and validators** are authoritative for artifact shapes and required keys.
2) **Current implementation** is authoritative for runtime behavior *when it is already validated by contracts/tests*.
3) **Docs** (`docs/contracts/**`, `docs/specs/**`) must be updated to match (never the other way around) unless we have a deliberate migration plan.

If you discover a conflict:
- **Prefer "fix docs to match code"** when the code is already contract-validated and has tests.
- **Prefer "fix code to match docs/contracts"** only when the contract/validator is explicit and the code violates it.

### Touchpoints + line ranges (important: line ranges are approximate)
This document includes file touchpoints with **approximate** line ranges like:

- `src/foo/bar.js` **(~L120-L240)**  -  anchor: `someFunctionName`

Line numbers drift as the repo changes. Treat them as a **starting hint**, not a hard reference.
Always use the **anchor string** (function name / constant / error message) as the primary locator.

### Tests: lanes + name filters (use them aggressively)
The repo has a first-class test runner with lanes + filters:

- Runner: `npm test` (alias for `node tests/run.js`)
- List lanes/tags: `npm test -- --list-lanes` / `npm test -- --list-tags`
- Run a lane: `npm run test:unit`, `npm run test:integration`, `npm run test:services`, etc.
- Filter by name/path (selectors):
  - `npm test -- --match risk_interprocedural`
  - `npm run test:unit -- --match chunk-uid`
  - `npm run test:integration -- --match crossfile`

**Lane rules are defined in:** `tests/run.rules.jsonc` (keep new tests named/placed so they land in the intended lane).

- All new tests introduced by this roadmap must be placed in the perf lane (name + location per rules).
- All benchmarks must support running against this repo (`--repo-root .`) or its built index (`--index-dir <path>`).

### Deprecating spec documents: archive policy (MANDATORY)
When a spec/doc is replaced (e.g., a reconciled spec supersedes an older one):

- **Move the deprecated doc to:** `docs/archived/` (create this folder if missing).
- Keep a short header in the moved file indicating:
  - what replaced it,
  - why it was deprecated,
  - the date/PR.
- Add/update the repository process in **`AGENTS.md`** so future agents follow the same archival convention.

---

## Parallelism Guide
- Phase 16.0: Subphases 16.0.1–16.0.7 can run in parallel with a shared glossary/terminology pass at the end.
- Phase 16.1: 16.1.1 first; then 16.1.2 and 16.1.3 in parallel; 16.1.4 last.
- Phase 16.2: 16.2.1 and 16.2.2 can run in parallel; 16.2.3 and 16.2.4 after core readers; 16.2.5 last.
- Phase 16.3: 16.3.1 first; then 16.3.2 and 16.3.3 in parallel; 16.3.4 after schema; 16.3.5 last.
- Phase 16.4: 16.4.1 and 16.4.2 in parallel; 16.4.3 after both; 16.4.4 next; 16.4.5 last.
- Phase 16.5: 16.5.1 first; 16.5.4 can run in parallel with 16.5.1; 16.5.2 and 16.5.3 after merge core; 16.5.5 last.
- Phase 16.6: 16.6.1 before 16.6.2; 16.6.3 last.
- Phase 16.7: 16.7.1 and 16.7.2 can run in parallel if file ownership is split; 16.7.3 last.
- Phase 16.8: 16.8.1 and 16.8.2 can run in parallel with clear file ownership; 16.8.3 last.
- Phase 16.9: 16.9.1 before 16.9.2; 16.9.3 last.
- Phase 16.10: 16.10.1 and 16.10.2 can run in parallel; 16.10.3 last.
- Phase 16.11: 16.11.1 and 16.11.2 can run in parallel with clear file ownership; 16.11.3 last.
- Phase 16.12: 16.12.1 and 16.12.2 can run in parallel with clear module ownership; 16.12.3 last.
- Phase 16.13: 16.13.1 and 16.13.2 can run in parallel; 16.13.3 then 16.13.4.
- Phase 16.14: 16.14.1, 16.14.2, and 16.14.3 can run in parallel; 16.14.4 then 16.14.5.
- Phase 16.15: 16.15.1 can run in parallel with 16.15.2/16.15.3; ensure bench harness exists before validating outputs.
- Phase 16.16: Execute missing work in order: contract/fuzz coverage, correctness/spec fixes, runtime hardening, then bench/acceptance closure.

## Roadmap Table of Contents
- Phase 16.0 -- Cross-cutting Spec Foundations (Subphases: 16.0.1 Build Scheduler Spec; 16.0.2 Artifact IO Spec; 16.0.3 Cache Key Spec; 16.0.4 Build Truth Ledger Spec; 16.0.5 Spill/Merge Spec; 16.0.6 Byte Budget Spec; 16.0.7 Deterministic Ordering Spec)
- Phase 16.1 -- Unified Build Scheduler + Backpressure Implementation (Subphases: 16.1.1 Core Scheduler; 16.1.2 Stage Wiring; 16.1.3 Embeddings/IO Integration; 16.1.4 Scheduler Tests + Bench)
- Phase 16.2 -- Shared Artifact IO Pipeline (Subphases: 16.2.1 Core Readers; 16.2.2 Compression/Offsets; 16.2.3 Writer Migration; 16.2.4 Loader Migration; 16.2.5 Validation + Bench)
- Phase 16.3 -- Global Cache Key + Invalidation (Subphases: 16.3.1 Schema + Helpers; 16.3.2 Embeddings Cache; 16.3.3 File Meta/Import/VFS; 16.3.4 Cache Reset + Cleanup; 16.3.5 Tests + Bench)
- Phase 16.4 -- Build Truth Ledger + Deterministic Ordering (Subphases: 16.4.1 Ledger Core; 16.4.2 Ordering Library; 16.4.3 Wiring; 16.4.4 Validation; 16.4.5 Tests + Bench)
- Phase 16.5 -- Unified Spill/Merge + Byte Budget (Subphases: 16.5.1 Merge Core; 16.5.2 Postings Adoption; 16.5.3 VFS/Relations/Artifacts Adoption; 16.5.4 Byte Budget Policy; 16.5.5 Tests + Bench)
- Phase 16.13 -- Artifact Pipeline Optimization (Subphases: 16.13.1 Offsets + Shards; 16.13.2 Loader Parallelism; 16.13.3 Tests + Bench; 16.13.4 Full Streaming Loaders + Minimal-Impl Hardening)
- Phase 16.14 -- Index State + File Meta + Minhash (Subphases: 16.14.1 Index State; 16.14.2 File Meta; 16.14.3 Minhash; 16.14.4 Tests + Bench; 16.14.5 Full Streaming File Meta + Minimal-Impl Hardening)
- Phase 16.6 -- Stage1 Postings Throughput (Subphases: 16.6.1 Token/Postings Core; 16.6.2 Backpressure + Concurrency; 16.6.3 Tests + Bench)
- Phase 16.7 -- Stage2 Relations + Filter Index (Subphases: 16.7.1 Relations Core; 16.7.2 Filter Index + Repo Map; 16.7.3 Tests + Bench)
- Phase 16.8 -- Embeddings Pipeline Throughput (Subphases: 16.8.1 Cache + Keys; 16.8.2 IO + Batching; 16.8.3 Tests + Bench)
- Phase 16.9 -- SQLite Build Throughput (Subphases: 16.9.1 Bulk Load Core; 16.9.2 FTS/Index Build; 16.9.3 Tests + Bench)
- Phase 16.10 -- VFS Manifest Throughput (Subphases: 16.10.1 Segment IO; 16.10.2 Merge/Compaction; 16.10.3 Tests + Bench)
- Phase 16.11 -- Tree-sitter Throughput (Subphases: 16.11.1 Grammar/Parser Caching; 16.11.2 Parse Scheduling; 16.11.3 Tests + Bench)
- Phase 16.12 -- Graph + Context Pack Throughput (Subphases: 16.12.1 Graph Store; 16.12.2 Traversal + Filtering; 16.12.3 Tests + Bench)
- Phase 16.15 -- Usage Verification + Cross-Phase Bench Coverage (Subphases: 16.15.1 Usage Checklist; 16.15.2 Bench Harness; 16.15.3 Bench Output Contracts)
- Phase 16.16 -- SWEETREPORT Missing Work Execution
---

## Phase 16.0 -- Cross-cutting Spec Foundations

### Objective
Define authoritative specs for systemwide behaviors before implementation to avoid inconsistent semantics.
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Touchpoints: `docs/specs/build-scheduler.md` (anchor: Goals), `docs/specs/artifact-io-pipeline.md` (anchor: Overview), `docs/specs/cache-key-invalidation.md` (anchor: Key Schema), `docs/specs/build-truth-ledger.md` (anchor: Schema), `docs/specs/spill-merge-framework.md` (anchor: API), `docs/specs/byte-budget-policy.md` (anchor: Budgets), `docs/specs/deterministic-ordering.md` (anchor: Ordering Rules)

### Docs/specs to add or update
- `docs/specs/build-scheduler.md` (new)
- `docs/specs/artifact-io-pipeline.md` (new)
- `docs/specs/cache-key-invalidation.md` (new)
- `docs/specs/build-truth-ledger.md` (new)
- `docs/specs/spill-merge-framework.md` (new)
- `docs/specs/byte-budget-policy.md` (new)
- `docs/specs/deterministic-ordering.md` (new)
Touchpoints: `docs/specs/build-scheduler.md` (anchor: Goals), `docs/specs/artifact-io-pipeline.md` (anchor: Overview), `docs/specs/cache-key-invalidation.md` (anchor: Key Schema), `docs/specs/build-truth-ledger.md` (anchor: Schema), `docs/specs/spill-merge-framework.md` (anchor: API), `docs/specs/byte-budget-policy.md` (anchor: Budgets), `docs/specs/deterministic-ordering.md` (anchor: Ordering Rules)

### Subphase 16.0.1 -- Build Scheduler Spec
Parallel: Can run alongside 16.0.2–16.0.7; reconcile glossary/terms at end of Phase 16.0.
Touchpoints: `docs/specs/*` (anchor: section headers in the spec for this subphase)
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Tasks:
- [x] Task 16.0.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.0.1.a: Draft `docs/specs/build-scheduler.md` with goals, non-goals, and scope.
Details: Include explicit definitions of CPU/IO/memory tokens, what “backpressure” means in this system, and what is explicitly out-of-scope for v1.
- [x] Task 16.0.1.b: Define resource model (CPU, IO, memory tokens) and backpressure algorithm.
Details: Specify token acquisition/release rules, fairness guarantees, starvation limits, and how memory pressure is measured.
- [x] Task 16.0.1.c: Define scheduler API surface and config schema (env + CLI + config file).
Details: Document config keys, defaults, precedence rules (env vs CLI vs config), and example configurations.
- [x] Task 16.0.1.d: Define priority/queue classes for Stage1/2/4 and embeddings.
Details: List queue names, priority ordering, and which stage operations map to each queue.
- [x] Task 16.0.1.e: Define failure/abort semantics and retry policy.
Details: Specify how cancellations propagate, when retries occur, and which failures are terminal vs recoverable.
- [x] Task 16.0.1.f: Define telemetry fields and required logs.
Details: Enumerate counters/metrics and required log lines for diagnosing starvation or backlog.
Notes: Include diagrams for scheduling flow and queue ownership.

Tests:
- [x] `tests/shared/concurrency/scheduler-contract.test.js` (perf lane) (new)
- [x] `tests/shared/concurrency/scheduler-config-parse.test.js` (perf lane) (new)

### Subphase 16.0.2 -- Artifact IO Pipeline Spec
Parallel: Can run alongside 16.0.1 and 16.0.3–16.0.7; reconcile glossary/terms at end of Phase 16.0.
Touchpoints: `docs/specs/*` (anchor: section headers in the spec for this subphase)
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Tasks:
- [x] Task 16.0.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.0.2.a: Draft `docs/specs/artifact-io-pipeline.md` with reader/writer lifecycle.
Details: Define lifecycle steps, expected inputs/outputs, and invariants shared across readers and writers.
- [x] Task 16.0.2.b: Specify sharding rules (bytes), offsets format, and compression negotiation.
Details: Include the exact offsets schema, shard naming, and compression fallback behavior.
- [x] Task 16.0.2.c: Define streaming parser behavior and validation modes.
Details: Define strict vs fast-path validation and which modes are used in CI vs runtime.
- [x] Task 16.0.2.d: Define telemetry and sampling rules for large reads.
Details: Specify sampling rates, thresholds, and required telemetry fields.
- [x] Task 16.0.2.e: Define atomic write/rename rules and failure handling.
Details: Document temp file naming, swap rules, cleanup behavior, and partial-write detection.
Notes: Breaking changes are allowed; no backward compatibility required.

Tests:
- [x] `tests/shared/artifact-io/artifact-io-spec-contract.test.js` (perf lane) (new)

### Subphase 16.0.3 -- Cache Key + Invalidation Spec
Parallel: Can run alongside 16.0.1–16.0.2 and 16.0.4–16.0.7; reconcile glossary/terms at end of Phase 16.0.
Touchpoints: `docs/specs/*` (anchor: section headers in the spec for this subphase)
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Tasks:
- [x] Task 16.0.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.0.3.a: Draft `docs/specs/cache-key-invalidation.md` with key schema.
Details: Provide the full key schema with all fields and required hashes.
- [x] Task 16.0.3.b: Define repo hash, build config hash, mode, and schema version inputs.
Details: Specify how each hash is computed and which files/configs are included.
- [x] Task 16.0.3.c: Define invalidation triggers for embeddings/file_meta/import/VFS caches.
Details: List explicit invalidation triggers and how they are detected.
- [x] Task 16.0.3.d: Define migration rules for older cache entries.
Details: Specify version checks and force-rebuild rules (breaking changes allowed).
- [x] Task 16.0.3.e: Define explicit TTL/expiry rules where needed.
Details: Identify which caches can expire by time and the default TTLs.
Notes: Provide a table mapping cache types to required key components.

Tests:
- [x] `tests/shared/cache/cache-key-schema.test.js` (perf lane) (new)

### Subphase 16.0.4 -- Build Truth Ledger Spec
Parallel: Can run alongside 16.0.1–16.0.3 and 16.0.5–16.0.7; reconcile glossary/terms at end of Phase 16.0.
Touchpoints: `docs/specs/*` (anchor: section headers in the spec for this subphase)
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Tasks:
- [x] Task 16.0.4.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.0.4.a: Draft `docs/specs/build-truth-ledger.md` with schema and purpose.
Details: Include schema fields, storage location, and example ledger entries per stage.
- [x] Task 16.0.4.b: Define ordering hash rules for chunk_meta, relations, graph outputs.
Details: Specify ordering inputs and hash algorithm requirements.
- [x] Task 16.0.4.c: Define write cadence and storage location (build_state sidecar).
Details: Define when ledger entries are appended vs replaced and file naming.
- [x] Task 16.0.4.d: Define validation rules and mismatch behaviors.
Details: Specify warn vs error behavior, and when to trigger rebuilds.
- [x] Task 16.0.4.e: Define integration with contracts and validators.
Details: Document how ledger validation integrates with `index-validate`.
Notes: Include examples of ledger entries for each stage.

### Subphase 16.0.5 -- Spill/Merge Framework Spec
Parallel: Can run alongside 16.0.1–16.0.4 and 16.0.6–16.0.7; reconcile glossary/terms at end of Phase 16.0.
Touchpoints: `docs/specs/*` (anchor: section headers in the spec for this subphase)
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Tasks:
- [x] Task 16.0.5.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.0.5.a: Draft `docs/specs/spill-merge-framework.md` with API and lifecycle.
Details: Define API surface, expected inputs/outputs, and lifecycle states.
- [x] Task 16.0.5.b: Define k-way merge semantics, heap bounds, and ordering guarantees.
Details: Specify merge ordering, tie-breakers, and deterministic guarantees.
- [x] Task 16.0.5.c: Define spill triggers (bytes/rows) and retention strategy.
Details: Include thresholds, how to measure size, and cleanup rules.
- [x] Task 16.0.5.d: Define file naming, cleanup, and crash recovery.
Details: Specify temp naming, recovery heuristics, and cleanup lifecycle.
- [x] Task 16.0.5.e: Define telemetry fields and performance counters.
Details: Enumerate required metrics (spill count, bytes, merge duration, peak heap).
Notes: Include determinism guarantees and merge stability rules.

Tests:
- [x] `tests/shared/merge/spill-merge-contract.test.js` (perf lane) (new)

### Subphase 16.0.6 -- Byte Budget Policy Spec
Parallel: Can run alongside 16.0.1–16.0.5 and 16.0.7; reconcile glossary/terms at end of Phase 16.0.
Touchpoints: `docs/specs/*` (anchor: section headers in the spec for this subphase)
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Tasks:
- [x] Task 16.0.6.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.0.6.a: Draft `docs/specs/byte-budget-policy.md` with global thresholds.
Details: Specify default budgets, units, and how they scale with repo size.
- [x] Task 16.0.6.b: Define per-artifact budget allocation and enforcement strategy.
Details: Provide allocation table and how budgets are derived per artifact type.
- [x] Task 16.0.6.c: Define guard behavior (skip, spill, warn, abort).
Details: Specify behavior by severity and artifact category.
- [x] Task 16.0.6.d: Define telemetry fields for budget usage.
Details: List counters, gauges, and log outputs for budget tracking.
- [x] Task 16.0.6.e: Define how budgets affect sharding, compression, and spill.
Details: Specify decision flow and precedence rules.
Notes: Include a mapping table from artifact type to default budgets.

Tests:
- [x] `tests/indexing/runtime/byte-budget-policy-contract.test.js` (perf lane) (new)

### Subphase 16.0.7 -- Deterministic Ordering Spec
Parallel: Can run alongside 16.0.1–16.0.6; reconcile glossary/terms at end of Phase 16.0.
Touchpoints: `docs/specs/*` (anchor: section headers in the spec for this subphase)
Docs/specs to update: `docs/specs/build-scheduler.md`, `docs/specs/artifact-io-pipeline.md`, `docs/specs/cache-key-invalidation.md`, `docs/specs/build-truth-ledger.md`, `docs/specs/spill-merge-framework.md`, `docs/specs/byte-budget-policy.md`, `docs/specs/deterministic-ordering.md`
Tasks:
- [x] Task 16.0.7.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.0.7.a: Draft `docs/specs/deterministic-ordering.md` with ordering rules.
Details: Include ordering rules per artifact and any required stable sorts.
- [x] Task 16.0.7.b: Define tie-breakers for chunk_meta, relations, and graph edges.
Details: Specify tie-breaker fields and their precedence.
- [x] Task 16.0.7.c: Define ordering helpers and API surface.
Details: Document helper functions, inputs, and expected outputs.
- [x] Task 16.0.7.d: Define determinism verification strategy and hashes.
Details: Specify how hashes are computed and when they are validated.
Details: Document breaking-change behavior and how ordering updates are handled.
Notes: Include a table of ordering keys per artifact.

Tests:
- [x] `tests/shared/order/deterministic-ordering-contract.test.js` (perf lane) (new)

---

## Phase 16.1 -- Unified Build Scheduler + Backpressure Implementation

### Objective
Implement a shared scheduler that coordinates CPU/IO/memory across stages to avoid saturation.
Docs/specs to update: `docs/specs/concurrency-abort-runwithqueue.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`, `docs/perf/shared-component-audit.md`
Touchpoints: `src/shared/concurrency.js (anchor: runWithQueue)`, `src/shared/runtime/thread-limits.js (anchor: resolveThreadLimits)`, `src/index/build/indexer/pipeline.js (anchor: runPipeline)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `tools/build/embeddings/runner.js (anchor: runEmbeddings)`

### Subphase 16.1.1 -- Core Scheduler
Parallel: Must land before 16.1.2 and 16.1.3.
Docs/specs to update: `docs/specs/concurrency-abort-runwithqueue.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`, `docs/perf/shared-component-audit.md`
Touchpoints: `src/shared/concurrency.js (anchor: runWithQueue)`, `src/shared/runtime/thread-limits.js (anchor: resolveThreadLimits)`, `src/index/build/indexer/pipeline.js (anchor: runPipeline)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `tools/build/embeddings/runner.js (anchor: runEmbeddings)`
Tasks:
- [x] Task 16.1.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.1.1.a: Implement scheduler core and resource tokens in `src/shared/concurrency.js`.
- [x] Task 16.1.1.b: Add queue classes with priorities and fairness.
- [x] Task 16.1.1.c: Add config loader for scheduler limits (env/CLI/config).
- [x] Task 16.1.1.d: Expose hooks for stage registration and lifecycle.
- [x] Task 16.1.1.e: Add telemetry counters and diagnostics export.
- [x] Task 16.1.1.f: Add admission-control caps per queue (max backlog) to prevent unbounded memory growth.
- [x] Task 16.1.1.g: Add starvation detection metrics (max wait time, token debt) with a fairness override.
- [x] Task 16.1.1.h: Add a CPU-only “low-resource mode” fallback for small repos to avoid scheduler overhead.
Notes: Ensure scheduler can be disabled for baseline comparisons.

Tests:
- [x] `tests/perf/scheduler-core.test.js` (perf lane) (new)
- [x] `tests/perf/scheduler-fairness.test.js` (perf lane) (new)
- [x] `tests/perf/scheduler-starvation-detection.test.js` (perf lane) (new)

### Subphase 16.1.2 -- Stage Wiring
Parallel: Can run alongside 16.1.3 after 16.1.1; coordinate file ownership.
Docs/specs to update: `docs/specs/concurrency-abort-runwithqueue.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`, `docs/perf/shared-component-audit.md`
Touchpoints: `src/shared/concurrency.js (anchor: runWithQueue)`, `src/shared/runtime/thread-limits.js (anchor: resolveThreadLimits)`, `src/index/build/indexer/pipeline.js (anchor: runPipeline)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `tools/build/embeddings/runner.js (anchor: runEmbeddings)`
Tasks:
- [x] Task 16.1.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.1.2.a: Wire Stage1 file processing through scheduler queues.
- [x] Task 16.1.2.b: Wire Stage2 relations tasks through scheduler queues.
- [x] Task 16.1.2.c: Wire Stage4 sqlite build through scheduler queues.
- [x] Task 16.1.2.d: Replace per-stage IO caps with scheduler hooks.
- [x] Task 16.1.2.e: Ensure per-stage progress reporting uses scheduler metrics.
Notes: Keep a fallback mode to compare old behavior.

Tests:
- [x] `tests/perf/indexing/runtime/scheduler-stage-wiring.test.js` (perf lane) (new)

### Subphase 16.1.3 -- Embeddings + IO Integration
Parallel: Can run alongside 16.1.2 after 16.1.1; coordinate file ownership.
Docs/specs to update: `docs/specs/concurrency-abort-runwithqueue.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`, `docs/perf/shared-component-audit.md`
Touchpoints: `src/shared/concurrency.js (anchor: runWithQueue)`, `src/shared/runtime/thread-limits.js (anchor: resolveThreadLimits)`, `src/index/build/indexer/pipeline.js (anchor: runPipeline)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `tools/build/embeddings/runner.js (anchor: runEmbeddings)`
Tasks:
- [x] Task 16.1.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.1.3.a: Gate embeddings compute concurrency via scheduler CPU tokens.
- [x] Task 16.1.3.b: Gate embeddings write queue via scheduler IO tokens.
- [x] Task 16.1.3.c: Coordinate artifact IO loads with scheduler IO pool.
- [x] Task 16.1.3.d: Add scheduler-aware backpressure to embedding runner.
- [x] Task 16.1.3.e: Add logging for token starvation events.
Notes: Ensure scheduler defaults do not regress small repos.

Tests:
- [x] `tests/perf/indexing/embeddings/scheduler-backpressure.test.js` (perf lane) (new)

### Subphase 16.1.4 -- Scheduler Tests + Bench
Parallel: Run after 16.1.1–16.1.3.
Docs/specs to update: `docs/specs/concurrency-abort-runwithqueue.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`, `docs/perf/shared-component-audit.md`
Touchpoints: `src/shared/concurrency.js (anchor: runWithQueue)`, `src/shared/runtime/thread-limits.js (anchor: resolveThreadLimits)`, `src/index/build/indexer/pipeline.js (anchor: runPipeline)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `tools/build/embeddings/runner.js (anchor: runEmbeddings)`
Tasks:
- [x] Task 16.1.4.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.1.4.a: Add benchmark comparing scheduler on/off for large builds.
- [x] Task 16.1.4.b: Add benchmark for IO starvation avoidance.
- [x] Task 16.1.4.c: Add regression test ensuring scheduler does not change outputs.
- [x] Task 16.1.4.d: Add telemetry assertions in tests.
- [x] Task 16.1.4.e: Add docs update to reference scheduler config.
- [x] Task 16.1.4.f: Add deterministic scheduling tests with synthetic CPU-only workloads.

Tests:
- [x] `tests/perf/indexing/runtime/scheduler-no-output-regression.test.js` (perf lane) (new)
- [x] `tests/perf/indexing/runtime/scheduler-telemetry.test.js` (perf lane) (new)
- [x] `tests/perf/indexing/runtime/scheduler-deterministic.test.js` (perf lane) (new)

---

## Phase 16.2 -- Shared Artifact IO Pipeline

### Objective
Standardize artifact IO (streaming, sharding, offsets, compression) across all writers and loaders.
Docs/specs to update: `docs/specs/json-stream-atomic-replace.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`

### Subphase 16.2.1 -- Core Readers
Parallel: Can run alongside 16.2.2; complete before 16.2.3/16.2.4.
Docs/specs to update: `docs/specs/json-stream-atomic-replace.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`
Tasks:
- [x] Task 16.2.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.2.1.a: Implement buffer-scanner JSONL reader (replace readline).
- [x] Task 16.2.1.b: Add adaptive highWaterMark based on file size.
- [x] Task 16.2.1.c: Add shard read concurrency with deterministic ordering.
- [x] Task 16.2.1.d: Add telemetry sampling for large reads.
- [x] Task 16.2.1.e: Add decompression offload for large shards.
- [x] Task 16.2.1.f: Add small-file fast path to avoid overhead on tiny artifacts.

Tests:
- [x] `tests/shared/artifact-io/jsonl-buffer-scan.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/jsonl-concurrency-order.test.js` (perf lane) (new)

### Subphase 16.2.2 -- Compression + Offsets
Parallel: Can run alongside 16.2.1; complete before 16.2.3/16.2.4.
Docs/specs to update: `docs/specs/json-stream-atomic-replace.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`
Tasks:
- [x] Task 16.2.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.2.2.a: Define unified offsets format and shared writer.
- [x] Task 16.2.2.b: Generate offsets during write (no second pass).
- [x] Task 16.2.2.c: Standardize byte-based sharding thresholds.
- [x] Task 16.2.2.d: Ensure compression suffix matches per-artifact mode.
- [x] Task 16.2.2.e: Add offset index validation in loaders.
- [x] Task 16.2.2.f: Add explicit offsets version + compression mode to shard metadata.

Tests:
- [x] `tests/shared/artifact-io/offsets-unified.test.js` (perf lane) (new)

### Subphase 16.2.3 -- Writer Migration
Parallel: Start after 16.2.1/16.2.2; can run alongside 16.2.4 with clear file ownership.
Docs/specs to update: `docs/specs/json-stream-atomic-replace.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`
Tasks:
  - [x] Task 16.2.3.doc: Update docs/specs and touchpoints listed for this subphase.
  - [x] Task 16.2.3.a: Migrate chunk_meta writer to unified pipeline.
  - [x] Task 16.2.3.b: Migrate symbol artifacts writers to unified pipeline.
  - [x] Task 16.2.3.c: Migrate relations/map writers to unified pipeline.
  - [x] Task 16.2.3.d: Enforce atomic swap for all artifact sets.
  - [x] Task 16.2.3.e: Add writer-side byte-budget guards.

Tests:
  - [x] `tests/perf/writer-unified-pipeline.test.js` (perf lane) (new)

### Subphase 16.2.4 -- Loader Migration
Parallel: Start after 16.2.1/16.2.2; can run alongside 16.2.3 with clear file ownership.
Docs/specs to update: `docs/specs/json-stream-atomic-replace.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`
  Tasks:
    - [x] Task 16.2.4.doc: Update docs/specs and touchpoints listed for this subphase.
    - [x] Task 16.2.4.a: Migrate loader paths to unified pipeline (chunk_meta, symbols).
    - [x] Task 16.2.4.b: Add hot parse cache for manifest + meta files.
  - [x] Task 16.2.4.c: Add bounded parallel artifact loads.
  - [x] Task 16.2.4.d: Add fallback to full scan when per-file index is invalid.
- [x] Task 16.2.4.e: Add missing-artifact detection for partial shards.
- [x] Task 16.2.4.f: Add JSONL reader fuzz tests for malformed/corrupt shards.

Tests:
- [x] `tests/shared/artifact-io/loader-fallbacks.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/jsonl-fuzz.test.js` (perf lane) (new)

### Subphase 16.2.5 -- Validation + Bench
Parallel: Run after 16.2.3/16.2.4.
Docs/specs to update: `docs/specs/json-stream-atomic-replace.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`
  Tasks:
    - [x] Task 16.2.5.doc: Update docs/specs and touchpoints listed for this subphase.
    - [x] Task 16.2.5.a: Add trusted fast-path validation mode for hot paths.
    - [x] Task 16.2.5.b: Add strict validation mode for CI/validation flows.
  - [x] Task 16.2.5.c: Add `artifact-io-read` benchmark baseline/current.
  - [x] Task 16.2.5.d: Add `jsonl-offset-index` benchmark on real index.
- [x] Task 16.2.5.e: Add docs update referencing the unified pipeline.

Tests:
- [x] `tests/shared/artifact-io/validation-fastpath.test.js` (perf lane) (new)

---

## Phase 16.3 -- Global Cache Key + Invalidation

### Objective
Apply a unified cache key schema and invalidation rules across caches.
Docs/specs to update: `docs/specs/embeddings-cache.md`, `docs/specs/import-resolution.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-hash-routing.md`
Touchpoints:
- `src/shared/cache-key.js` (anchor: buildCacheKey)
- `src/shared/cache-roots.js` (anchor: getCacheRoot)
- `src/shared/cache.js` (anchor: createCache)
- `src/shared/artifact-io/cache.js` (anchor: buildCacheKey)
- `src/context-pack/assemble.js` (anchor: EXCERPT_CACHE_MAX)
- `src/config/validate.js` (anchor: validatorCache)
- `src/index/tooling/vfs.js` (anchor: VFS_DISK_CACHE)
- `src/index/build/vfs-segment-hash-cache.js` (anchor: buildSegmentHashCacheKey)
- `src/index/build/import-resolution.js` (anchor: cacheKeyFor)
- `src/index/build/tokenization.js` (anchor: cacheKey)
- `src/index/build/file-processor/process-chunks/index.js` (anchor: complexityCache)
- `src/index/build/file-processor/cpu.js` (anchor: treeSitterCacheKey)
- `src/index/git.js` (anchor: gitMetaCache)
- `src/index/tooling/orchestrator.js` (anchor: computeCacheKey)
- `src/retrieval/cli/run-search-session.js` (anchor: buildQueryCacheKey)
- `src/retrieval/query-plan-cache.js` (anchor: buildQueryCacheKey)
- `src/shared/onnx-embeddings.js` (anchor: onnxCache)
- `src/lang/tree-sitter/chunking.js` (anchor: resolveChunkCacheKey)
- `src/graph/store.js` (anchor: buildGraphIndexCacheKey)
- `src/graph/suggest-tests.js` (anchor: TEST_MATCHER_CACHE_MAX)
- `src/retrieval/output/summary.js` (anchor: summaryCache)
- `src/retrieval/output/format.js` (anchor: formatCache)
- `src/retrieval/cli-sqlite.js` (anchor: sqliteChunkCountCache)
- `src/retrieval/cli-index.js` (anchor: buildQueryCacheKey)
- `src/retrieval/cli/run-search-session.js` (anchor: embeddingCache)
- `src/retrieval/query-plan-cache.js` (anchor: buildQueryPlanCacheKey)
- `src/retrieval/index-cache.js` (anchor: indexSignatureCache)
- `src/context-pack/assemble.js` (anchor: excerptCache)
- `src/graph/suggest-tests.js` (anchor: testMatcherCache)
- `src/graph/store.js` (anchor: buildGraphIndexCacheKey)
- `src/map/build-map.js` (anchor: buildMapCacheKey)
- `src/index/git.js` (anchor: gitMetaCache)
- `src/shared/artifact-io/cache.js` (anchor: pieceCache)
- `src/shared/embedding-adapter.js` (anchor: pipelineCache)
- `tools/build/embeddings/cache.js` (anchor: buildCacheKey)
- `tools/build/embeddings/runner.js` (anchor: buildCacheIdentity)
- `tools/cache/clear-cache.js` (anchor: clear-cache)
- `tools/reports/report-code-map.js` (anchor: buildMapCacheKey)
- `tools/sqlite/vector-extension.js` (anchor: getLoadCacheKey)

### Subphase 16.3.1 -- Schema + Helpers
Parallel: Must land before 16.3.2/16.3.3/16.3.4.
Docs/specs to update: `docs/specs/cache-key-invalidation.md`, `docs/specs/embeddings-cache.md`, `docs/specs/import-resolution.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-hash-routing.md`
Touchpoints: see Phase 16.3 list (primary anchors: `src/shared/cache-key.js`, `src/shared/cache.js`, `tools/build/embeddings/cache.js`).
Tasks:
- [x] Task 16.3.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.3.1.a: Implement cache key builder with repo hash + build config.
- [x] Task 16.3.1.b: Include mode + schema version tags in keys.
- [x] Task 16.3.1.c: Add helpers for key serialization and hashing.
- [x] Task 16.3.1.d: Add config-based overrides for cache namespace.
- [x] Task 16.3.1.e: Add migration note in spec and docs.
- [x] Task 16.3.1.f: Include normalized path policy and feature flags in cache keys.
- [x] Task 16.3.1.g: Add local cache key helper and migrate in-memory cache keys (graph/query/map/git/context-pack/sqlite/artifact-io).

Tests:
- [x] `tests/perf/cache-key-builder.test.js` (perf lane) (new)

### Subphase 16.3.2 -- Embeddings Cache
Parallel: Can run alongside 16.3.3 after 16.3.1; coordinate file ownership.
Docs/specs to update: `docs/specs/embeddings-cache.md`, `docs/specs/import-resolution.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-hash-routing.md`
Touchpoints: see Phase 16.3 list (primary anchors: `tools/build/embeddings/cache.js`, `tools/build/embeddings/runner.js`, `src/shared/cache-key.js`).
Tasks:
- [x] Task 16.3.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.3.2.a: Apply new key schema to embeddings cache.
- [x] Task 16.3.2.b: Add cache validation fast-path (bitset + checksum).
- [x] Task 16.3.2.c: Ensure cross-mode reuse is keyed consistently.
- [x] Task 16.3.2.d: Add invalidation when model/quant changes.
- [x] Task 16.3.2.e: Record cache hit stats in build telemetry.

Tests:
- [x] `tests/perf/embeddings-cache-key-schema.test.js` (perf lane) (new)

### Subphase 16.3.3 -- File Meta, Import, VFS
Parallel: Can run alongside 16.3.2 after 16.3.1; coordinate file ownership.
Docs/specs to update: `docs/specs/import-resolution.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-hash-routing.md`, `docs/specs/file-meta.md`
Touchpoints: see Phase 16.3 list (primary anchors: `src/index/build/import-resolution.js`, `src/index/tooling/vfs.js`, `src/index/build/vfs-segment-hash-cache.js`, `src/index/build/artifacts/file-meta.js`).
Tasks:
- [x] Task 16.3.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.3.3.a: Apply key schema to file_meta cache reuse.
- [x] Task 16.3.3.b: Apply key schema to import-resolution cache.
- [x] Task 16.3.3.c: Apply key schema to VFS routing/index caches.
- [x] Task 16.3.3.d: Add invalidation on file set changes.
- [x] Task 16.3.3.e: Add logs for cache eviction reason.
- [x] Task 16.3.3.f: Invalidate resolved imports on file-set change (not just unresolved).

Tests:
- [x] `tests/indexing/imports/cache-invalidation.test.js` (perf lane) (new)

### Subphase 16.3.4 -- Cache Reset + Cleanup
Parallel: Run after 16.3.1; can overlap with 16.3.2/16.3.3 if isolated to tooling.
Docs/specs to update: `docs/specs/cache-key-invalidation.md`, `docs/specs/embeddings-cache.md`, `docs/specs/import-resolution.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-hash-routing.md`
Touchpoints: see Phase 16.3 list (primary anchors: `src/shared/cache-key.js`, `tools/build/embeddings/cache.js`, `src/index/tooling/orchestrator.js`).
Tasks:
- [x] Task 16.3.4.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.3.4.a: Introduce a versioned cache root (breaking change).
- [x] Task 16.3.4.b: Purge all legacy cache layouts unconditionally on upgrade.
- [x] Task 16.3.4.c: Add CLI/env flag to force cache rebuild.
- [x] Task 16.3.4.d: Add cache size cap + eviction for on-disk caches.
- [x] Task 16.3.4.e: Add clear-cache tooling command with safety prompt.

Tests:
- [x] `tests/shared/cache/cache-migration.test.js` (perf lane) (new)

### Subphase 16.3.5 -- Tests + Bench
Parallel: Run after 16.3.2–16.3.4.
Docs/specs to update: `docs/specs/cache-key-invalidation.md`, `docs/specs/embeddings-cache.md`, `docs/specs/import-resolution.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-hash-routing.md`
Touchpoints: see Phase 16.3 list (primary anchors: `tools/bench/*`, `tests/perf/*`).
Tasks:
- [x] Task 16.3.5.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.3.5.a: Add cache hit/miss benchmark to `cache-hit-rate`.
- [x] Task 16.3.5.b: Add determinism tests for cache reuse.
- [x] Task 16.3.5.c: Add regression test for missing-file invalidation.
- [x] Task 16.3.5.d: Add docs update for cache key schema.
- [x] Task 16.3.5.e: Add telemetry sampling for cache performance.

Tests:
- [x] `tests/shared/cache/cache-hit-rate-contract.test.js` (perf lane) (new)

---

## Phase 16.4 -- Build Truth Ledger + Deterministic Ordering

### Objective
Guarantee determinism via a shared ordering library and ledger validation.
Docs/specs to update: `docs/specs/build-state-integrity.md`, `docs/specs/deterministic-ordering.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/graph-filtering-and-dedupe.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeBuildState)`, `src/shared/order.js (anchor: stableOrder)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/graph/store.js (anchor: buildAdjacencyCsr)`, `src/index/validate/index-validate.js (anchor: validateIndex)`

### Subphase 16.4.1 -- Ledger Core
Parallel: Can run alongside 16.4.2; both must land before 16.4.3.
Docs/specs to update: `docs/specs/build-state-integrity.md`, `docs/specs/deterministic-ordering.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/graph-filtering-and-dedupe.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeBuildState)`, `src/shared/order.js (anchor: stableOrder)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/graph/store.js (anchor: buildAdjacencyCsr)`, `src/index/validate/index-validate.js (anchor: validateIndex)`
Tasks:
- [x] Task 16.4.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.4.1.a: Implement ledger schema writer in build_state.
- [x] Task 16.4.1.b: Record per-stage ordering hashes.
- [x] Task 16.4.1.c: Add schema versioning and upgrade rules.
- [x] Task 16.4.1.d: Add ledger read/validate helpers.
- [x] Task 16.4.1.e: Add ledger export for tooling.
- [x] Task 16.4.1.f: Record ordering seed inputs (discovery/file list hashes) for diagnosis.

Tests:
- [x] `tests/indexing/build-state/ledger-roundtrip.test.js` (perf lane) (new)

### Subphase 16.4.2 -- Ordering Library
Parallel: Can run alongside 16.4.1; both must land before 16.4.3.
Docs/specs to update: `docs/specs/build-state-integrity.md`, `docs/specs/deterministic-ordering.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/graph-filtering-and-dedupe.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeBuildState)`, `src/shared/order.js (anchor: stableOrder)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/graph/store.js (anchor: buildAdjacencyCsr)`, `src/index/validate/index-validate.js (anchor: validateIndex)`
Tasks:
- [x] Task 16.4.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.4.2.a: Implement shared ordering helpers in `src/shared/order.js`.
- [x] Task 16.4.2.b: Define stable bucket ordering and tie-breakers.
- [x] Task 16.4.2.c: Add helpers for deterministic map/repo-map ordering.
- [x] Task 16.4.2.d: Add tests for ordering stability.
- [x] Task 16.4.2.e: Add docs for ordering rules.

Tests:
- [x] `tests/shared/order/order-stability.test.js` (perf lane) (new)

### Subphase 16.4.3 -- Wiring
Parallel: Run after 16.4.1/16.4.2.
Docs/specs to update: `docs/specs/build-state-integrity.md`, `docs/specs/deterministic-ordering.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/graph-filtering-and-dedupe.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeBuildState)`, `src/shared/order.js (anchor: stableOrder)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/graph/store.js (anchor: buildAdjacencyCsr)`, `src/index/validate/index-validate.js (anchor: validateIndex)`
Tasks:
- [x] Task 16.4.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.4.3.a: Apply ordering helpers to chunk_meta emission.
- [x] Task 16.4.3.b: Apply ordering helpers to relations emission.
- [x] Task 16.4.3.c: Apply ordering helpers to graph outputs.
- [x] Task 16.4.3.d: Apply ordering helpers to repo map outputs.
- [x] Task 16.4.3.e: Record ordering hashes in ledger for each artifact.

Tests:
- [x] `tests/indexing/determinism/ordering-ledger-integration.test.js` (perf lane) (new)

### Subphase 16.4.4 -- Validation
Parallel: Run after 16.4.3.
Docs/specs to update: `docs/specs/build-state-integrity.md`, `docs/specs/deterministic-ordering.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/graph-filtering-and-dedupe.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeBuildState)`, `src/shared/order.js (anchor: stableOrder)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/graph/store.js (anchor: buildAdjacencyCsr)`, `src/index/validate/index-validate.js (anchor: validateIndex)`
Tasks:
- [x] Task 16.4.4.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.4.4.a: Add validator to check ledger hashes on load.
- [x] Task 16.4.4.b: Add warning vs error policy for mismatches.
- [x] Task 16.4.4.c: Add reporting for mismatch source.
- [x] Task 16.4.4.d: Add fallback path to rebuild ordering.
- [x] Task 16.4.4.e: Add CLI flag to force validation.
- [x] Task 16.4.4.f: Add determinism drift report with artifact + rule attribution.

Tests:
- [x] `tests/indexing/validate/ledger-validation.test.js` (perf lane) (new)

### Subphase 16.4.5 -- Tests + Bench
Parallel: Run after 16.4.1–16.4.4.
Docs/specs to update: `docs/specs/build-state-integrity.md`, `docs/specs/deterministic-ordering.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/graph-filtering-and-dedupe.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeBuildState)`, `src/shared/order.js (anchor: stableOrder)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`, `src/graph/store.js (anchor: buildAdjacencyCsr)`, `src/index/validate/index-validate.js (anchor: validateIndex)`
Tasks:
- [x] Task 16.4.5.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.4.5.a: Add determinism bench on large repo.
- [x] Task 16.4.5.b: Add unit tests for ledger hash computation.
- [x] Task 16.4.5.c: Add regression test for chunk_meta ordering drift.
- [x] Task 16.4.5.d: Add docs update for ledger usage.
- [x] Task 16.4.5.e: Add benchmark flag for ledger on/off.

Tests:
- [x] `tests/shared/order/order-hash.test.js` (perf lane) (new)
- [x] `tests/indexing/determinism/chunk-meta-ordering-drift.test.js` (perf lane) (new)

---

## Phase 16.5 -- Unified Spill/Merge + Byte Budget

### Objective
Provide shared spill/merge and consistent byte-budget enforcement across artifacts.
Docs/specs to update: `docs/specs/spimi-spill.md`, `docs/specs/segmentation-perf.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/byte-budget-policy.md`
Touchpoints: `src/shared/merge.js (anchor: mergeSortedRuns)`, `src/index/build/postings.js (anchor: buildPostings)`, `src/index/vfs/merge.js (anchor: mergeRuns)`, `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/build-state.js (anchor: byteBudgets)`, `src/index/build/byte-budget.js (anchor: resolveByteBudgetMap)`

### Subphase 16.5.1 -- Merge Core
Parallel: Must land before 16.5.2/16.5.3.
Docs/specs to update: `docs/specs/spimi-spill.md`, `docs/specs/segmentation-perf.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/byte-budget-policy.md`
Touchpoints: `src/shared/merge.js (anchor: mergeSortedRuns)`, `src/index/build/postings.js (anchor: buildPostings)`, `src/index/vfs/merge.js (anchor: mergeRuns)`, `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/build-state.js (anchor: byteBudgets)`, `src/index/build/byte-budget.js (anchor: resolveByteBudgetMap)`
Tasks:
- [x] Task 16.5.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.5.1.a: Implement shared k-way merge core in `src/shared/merge.js`.
- [x] Task 16.5.1.b: Add bounded heap and chunked write support.
- [x] Task 16.5.1.c: Add stable ordering guarantees for merges.
- [x] Task 16.5.1.d: Add cleanup hooks for spill files.
- [x] Task 16.5.1.e: Add telemetry counters for merge throughput.
- [x] Task 16.5.1.f: Add resumable merge checkpoints for large merges.
- [x] Task 16.5.1.g: Define merge core API contract (inputs/outputs, comparator contract, serialization hooks).
- [x] Task 16.5.1.h: Add comparator total-order validation guard for debug builds.
- [x] Task 16.5.1.i: Define spill run manifest schema + naming conventions.
- [x] Task 16.5.1.j: Add standardized spill recovery + cleanup path.

Tests:
- [x] `tests/shared/merge/merge-core.test.js` (perf lane) (new)

### Subphase 16.5.2 -- Postings Adoption
Parallel: Can run alongside 16.5.3 after 16.5.1; coordinate file ownership.
Docs/specs to update: `docs/specs/spimi-spill.md`, `docs/specs/segmentation-perf.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/byte-budget-policy.md`
Touchpoints: `src/shared/merge.js (anchor: mergeSortedRuns)`, `src/index/build/postings.js (anchor: buildPostings)`, `src/index/vfs/merge.js (anchor: mergeRuns)`, `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/state.js (anchor: byteBudgets)`
Tasks:
- [x] Task 16.5.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.5.2.a: Replace postings spill/merge with shared merge core.
- [x] Task 16.5.2.b: Add byte-based spill threshold for postings.
- [x] Task 16.5.2.c: Add deterministic merge ordering for postings.
- [x] Task 16.5.2.d: Add merge stats to build_state.
- [x] Task 16.5.2.e: Add tests for spill/merge determinism.
- [x] Task 16.5.2.f: Define postings merge comparator + tie-break rules in code/docs.
- [x] Task 16.5.2.g: Add baseline compatibility check against legacy postings output.

Tests:
- [x] `tests/indexing/postings/spill-merge-unified.test.js` (perf lane) (new)
- [x] `tests/indexing/postings/spill-merge-compat.test.js` (perf lane) (new)

### Subphase 16.5.3 -- VFS/Relations/Artifacts Adoption
Parallel: Can run alongside 16.5.2 after 16.5.1; coordinate file ownership.
Docs/specs to update: `docs/specs/spimi-spill.md`, `docs/specs/segmentation-perf.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/byte-budget-policy.md`
Touchpoints: `src/shared/merge.js (anchor: mergeSortedRuns)`, `src/index/build/postings.js (anchor: buildPostings)`, `src/index/vfs/merge.js (anchor: mergeRuns)`, `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/state.js (anchor: byteBudgets)`
Tasks:
- [x] Task 16.5.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.5.3.a: Replace VFS merge with shared merge core.
- [x] Task 16.5.3.b: Replace relations spill/merge with shared merge core.
- [x] Task 16.5.3.c: Replace artifact shard merge with shared merge core.
- [x] Task 16.5.3.d: Ensure byte thresholds are used consistently.
- [x] Task 16.5.3.e: Add unified cleanup for spill artifacts.
- [x] Task 16.5.3.f: Define per-adopter comparator + serializer contracts for VFS/relations/artifacts.
- [x] Task 16.5.3.g: Add byte-budget policy mapping for VFS/relations/artifacts (fail vs truncate).
- [x] Task 16.5.3.h: Add spill cleanup regression test for VFS/relations/artifacts.

Tests:
- [x] `tests/indexing/vfs/merge-core-integration.test.js` (perf lane) (new)
- [x] `tests/indexing/relations/merge-core-integration.test.js` (perf lane) (new)

### Subphase 16.5.4 -- Byte Budget Policy
Parallel: Can run alongside 16.5.1; must land before 16.5.5.
Docs/specs to update: `docs/specs/spimi-spill.md`, `docs/specs/segmentation-perf.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/byte-budget-policy.md`
Touchpoints: `src/shared/merge.js (anchor: mergeSortedRuns)`, `src/index/build/postings.js (anchor: buildPostings)`, `src/index/vfs/merge.js (anchor: mergeRuns)`, `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/state.js (anchor: byteBudgets)`
Tasks:
- [x] Task 16.5.4.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.5.4.a: Implement global byte budget map in build_state.
- [x] Task 16.5.4.b: Add per-artifact budget caps and defaults.
- [x] Task 16.5.4.c: Add enforcement hooks to writers.
- [x] Task 16.5.4.d: Add warnings/abort policy for overages.
- [x] Task 16.5.4.e: Add telemetry outputs for budget usage.
- [x] Task 16.5.4.f: Define byte-budget policy table (artifact -> cap -> overflow behavior).
- [x] Task 16.5.4.g: Add strict perf-lane budget enforcement policy.
- [x] Task 16.5.4.h: Add shared `resolveByteBudget(artifactName, config)` helper.

Tests:
- [x] `tests/indexing/runtime/byte-budget-enforcement.test.js` (perf lane) (new)

### Subphase 16.5.5 -- Tests + Bench
Parallel: Run after 16.5.1–16.5.4.
Docs/specs to update: `docs/specs/spimi-spill.md`, `docs/specs/segmentation-perf.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/byte-budget-policy.md`
Touchpoints: `src/shared/merge.js (anchor: mergeRunsWithPlanner)`, `src/index/build/postings.js (anchor: buildPostings)`, `src/index/build/artifacts/helpers.js (anchor: createRowSpillCollector)`, `src/index/build/artifacts/writers/symbol-edges.js (anchor: writeSymbolEdges)`, `src/index/build/artifacts/writers/symbol-occurrences.js (anchor: writeSymbolOccurrences)`, `src/index/build/build-state.js (anchor: byteBudgets)`, `tools/bench/merge/merge-core-throughput.js`, `tools/bench/merge/spill-merge-compare.js`, `tools/bench/merge/missing-run-file.js`
Tasks:
- [x] Task 16.5.5.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.5.5.a: Add merge throughput benchmark for large runs.
- [x] Task 16.5.5.b: Add byte budget regression test.
- [x] Task 16.5.5.c: Add benchmark comparing old/new spill merges.
- [x] Task 16.5.5.d: Add documentation updates for budgets and merges.
- [x] Task 16.5.5.e: Add build_state counters for spill/merge.
- [x] Task 16.5.5.f: Add merge cleanup/compaction regression test.
- [x] Task 16.5.5.g: Add benchmark metrics for throughput + heap + spill bytes.
- [x] Task 16.5.5.h: Add baseline/current delta line (amount, throughput, percent, duration).
- [x] Task 16.5.5.i: Add failure simulation bench for missing run file handling.

Tests:
- [x] `tests/indexing/runtime/byte-budget-enforcement.test.js` (perf lane) (new)
- [x] `tests/shared/merge/merge-cleanup-regression.test.js` (perf lane) (new)
- [x] `tests/shared/merge/merge-benchmark-contract.test.js` (perf lane) (new)

---

## Phase 16.13 -- Artifact Pipeline Optimization

### Subphase 16.13.1 -- Offsets + Shards
Parallel: Can run alongside 16.13.2 with clear file ownership.
Docs/specs to update: `docs/specs/artifact-schemas.md`, `docs/specs/json-stream-atomic-replace.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/artifact-io/offsets.js (anchor: readOffsetsIndex)`, `src/shared/artifact-io/manifest.js (anchor: readPiecesManifest)`, `src/index/build/artifacts/*.js (anchor: writeArtifacts)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`
Tasks:
- [x] Task 16.13.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.13.1.doc.1: Audit existing offsets/manifest formats and enumerate legacy readers/writers.
- [x] Task 16.13.1.doc.2: Define versioned offsets schema and migration notes in specs.
- [x] Task 16.13.1.a: Implement unified offsets format across JSONL artifacts.
- [x] Task 16.13.1.a.1: Standardize offsets header fields (version, rows, bytes, shardCount, compression).
- [x] Task 16.13.1.a.2: Add offsets writer helper that emits per-shard offset tables.
- [x] Task 16.13.1.a.3: Update manifest/pieces metadata to reference offsets file names.
- [x] Task 16.13.1.b: Generate offsets during write (no second pass).
- [x] Task 16.13.1.b.1: Extend JSONL writer to capture byte positions during streaming writes.
- [x] Task 16.13.1.b.2: Ensure offsets match post-compression byte positions.
- [x] Task 16.13.1.b.3: Add guard for empty shard creation at max-byte boundary.
- [x] Task 16.13.1.c: Enforce byte-based sharding for all artifacts.
- [x] Task 16.13.1.c.1: Normalize shard thresholds via shared helper (maxBytes and minRows).
- [x] Task 16.13.1.c.2: Add per-artifact override mapping in writeArtifacts.
- [x] Task 16.13.1.c.3: Emit shard byte counts in sharded meta for validators.
- [x] Task 16.13.1.d: Add atomic swap for artifact sets.
- [x] Task 16.13.1.d.1: Write into temp dir and rename into place on success.
- [x] Task 16.13.1.d.2: Ensure manifest update is atomic with shard set.
- [x] Task 16.13.1.d.3: Add cleanup on failure and ensure partial shards are removed.
- [x] Task 16.13.1.e: Add lazy validation mode for hot paths.
- [x] Task 16.13.1.e.1: Add load flag to skip full JSON validation when offsets are trusted.
- [x] Task 16.13.1.e.2: Add sampling-based validation to detect drift.
- [x] Task 16.13.1.e.3: Force strict validation in perf lane and during schema upgrades.

Tests:
- [x] `tests/indexing/artifacts/offsets-unified-roundtrip.test.js` (perf lane) (new)

### Subphase 16.13.2 -- Loader Parallelism
Parallel: Can run alongside 16.13.1 with clear file ownership.
Docs/specs to update: `docs/specs/artifact-schemas.md`, `docs/specs/json-stream-atomic-replace.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/artifact-io/jsonl.js (anchor: readJsonlRows)`, `src/shared/artifact-io/manifest.js (anchor: readPiecesManifest)`, `src/shared/artifact-io/offsets.js (anchor: readOffsetsIndex)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`
Tasks:
- [x] Task 16.13.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.13.2.doc.1: Document loader concurrency caps + default values.
- [x] Task 16.13.2.doc.2: Document fallback/strict error behavior for missing parts.
- [x] Task 16.13.2.a: Add bounded parallel artifact loads.
- [x] Task 16.13.2.a.1: Implement queue with max concurrency and max pending.
- [x] Task 16.13.2.a.2: Separate IO vs CPU parsing limits for loaders.
- [x] Task 16.13.2.a.3: Add scheduler tokens for large artifact loads.
- [x] Task 16.13.2.b: Add hot parse cache for manifest/meta files.
- [x] Task 16.13.2.b.1: Add LRU keyed by path+mtime+size hash.
- [x] Task 16.13.2.b.2: Cache parse errors briefly to avoid retry storms.
- [x] Task 16.13.2.b.3: Track cache hit rate in telemetry.
- [x] Task 16.13.2.c: Add fallback to full scan when per-file index invalid.
- [x] Task 16.13.2.c.1: Detect missing offsets/data shards and mark index unusable.
- [x] Task 16.13.2.c.2: Fall back to full JSONL scan with warning.
- [x] Task 16.13.2.c.3: Add guard to prevent partial results when index invalid.
- [x] Task 16.13.2.d: Add missing-part detection and failure mode.
- [x] Task 16.13.2.d.1: Fail fast when manifest lists missing shards.
- [x] Task 16.13.2.d.2: Include artifact name + shard id in error.
- [x] Task 16.13.2.d.3: Add optional strict/lenient toggle in loader options.
- [x] Task 16.13.2.e: Add loader telemetry sampling.
- [x] Task 16.13.2.e.1: Record bytes read, rows parsed, time per artifact.
- [x] Task 16.13.2.e.2: Emit sampling rate and skipped samples.
- [x] Task 16.13.2.f: Add loader determinism stress test under parallel loads.
- [x] Task 16.13.2.f.1: Run repeated parallel loads and compare hashes.
- [x] Task 16.13.2.f.2: Inject randomized ordering to ensure stability.

Tests:
- [x] `tests/shared/artifact-io/loader-parallelism.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/broken-offsets-fallback.test.js` (perf lane) (new)

### Subphase 16.13.3 -- Tests + Bench
Parallel: Run after 16.13.1/16.13.2.
Docs/specs to update: `docs/specs/artifact-schemas.md`, `docs/specs/json-stream-atomic-replace.md`, `docs/perf/index-artifact-pipelines.md`, `docs/perf/shared-io-serialization.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/artifact-io/offsets.js (anchor: readOffsetsIndex)`, `src/shared/artifact-io/manifest.js (anchor: readPiecesManifest)`, `src/shared/json-stream.js (anchor: writeJsonLinesShardedAsync)`
Tasks:
- [x] Task 16.13.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.13.3.doc.1: Define benchmark CLI flags and expected output schema.
- [x] Task 16.13.3.doc.2: Document perf lane coverage for artifact pipeline tests.
- [x] Task 16.13.3.a: Implement `jsonl-offset-index` benchmark on real index.
- [x] Task 16.13.3.a.1: Baseline uses full scan loader; current uses offsets.
- [x] Task 16.13.3.a.2: Output delta line (duration, throughput, percent).
- [x] Task 16.13.3.b: Add artifact IO throughput benchmark baseline/current.
- [x] Task 16.13.3.b.1: Compare sharded vs unsharded for same artifact.
- [x] Task 16.13.3.b.2: Record heap delta and bytes read.
- [x] Task 16.13.3.c: Add regression test for loader determinism.
- [x] Task 16.13.3.c.1: Repeat load with parallelism and compare hash of rows.
- [x] Task 16.13.3.d: Add docs update for artifact pipeline.
- [x] Task 16.13.3.d.1: Include failure modes for missing shards and offsets.
- [x] Task 16.13.3.e: Add validation fast-path regression test.
- [x] Task 16.13.3.e.1: Ensure fast-path rejects invalid schema.
- [x] Task 16.13.3.f: Add broken-offsets fallback regression test (full scan).
- [x] Task 16.13.3.f.1: Simulate missing offsets and ensure fallback loads rows.

Tests:
- [x] `tests/shared/artifact-io/artifact-io-bench-contract.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/validation-fastpath.test.js` (perf lane) (new)

### Subphase 16.13.4 -- Full Streaming Loaders + Minimal-Impl Hardening
Parallel: Run after 16.13.3; depends on offsets + loader parallelism.
Docs/specs to update: `docs/specs/artifact-io-pipeline.md`, `docs/perf/shared-io-serialization.md`, `docs/perf/index-artifact-pipelines.md`
Touchpoints: `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/shared/artifact-io/offsets.js (anchor: readOffsetsIndex)`, `src/shared/json-stream.js (anchor: readJsonlRows)`, `src/index/build/artifacts/helpers.js (anchor: mergeSortedRuns)`
Tasks:
- [x] Task 16.13.4.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.13.4.a: Add streaming row iterator API that never materializes arrays by default.
- [x] Task 16.13.4.a.1: Support offsets index to jump to shard ranges and stream rows in order.
- [x] Task 16.13.4.a.2: Add max in-flight row cap + backpressure hooks.
- [x] Task 16.13.4.b: Switch loader fast-paths to streaming when offsets exist; require explicit opt-in to materialize.
- [x] Task 16.13.4.b.1: Add `materialize` option to load helpers and update call sites.
- [x] Task 16.13.4.c: Convert artifact consumers that read large JSONL arrays to use iterators (graph, relations, file_meta, symbol artifacts).
- [x] Task 16.13.4.d: Enforce strict missing-part checks for streaming loaders (no partial results).
- [x] Task 16.13.4.e: Add streaming vs materialized benchmark and output delta line (duration, throughput, percent, heap).
- [x] Task 16.13.4.f: Add regression test for streaming correctness vs full scan (row hash match).
- [x] Task 16.13.4.g: Add regression test for streaming memory cap under large artifacts.
- [x] Task 16.13.4.h: Add determinism stress test under streaming + parallel loads.

Tests:
- [x] `tests/perf/artifact-io/streaming-vs-full.test.js` (perf lane) (new)
- [x] `tests/perf/artifact-io/streaming-memory-cap.test.js` (perf lane) (new)
- [x] `tests/perf/artifact-io/streaming-determinism.test.js` (perf lane) (new)

---

## Phase 16.14 -- Index State + File Meta + Minhash

### Subphase 16.14.1 -- Index State
Parallel: Can run alongside 16.14.2/16.14.3 with clear ownership.
Docs/specs to update: `docs/perf/index-state-file-meta.md`, `docs/specs/metadata-schema-v2.md`, `docs/specs/symbol-artifacts-and-pipeline.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeIndexState)`, `src/index/build/artifacts/file-meta.js (anchor: buildFileMeta)`, `src/index/build/postings.js (anchor: buildMinhash)`, `src/shared/artifact-io/loaders.js (anchor: loadMinhashSignatures)`
Tasks:
- [x] Task 16.14.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.14.1.doc.1: Enumerate current index_state fields and delta log format.
- [x] Task 16.14.1.doc.2: Define compatibility rules for compressed vs plain state.
- [x] Task 16.14.1.a: Implement index_state delta compression.
- [x] Task 16.14.1.a.1: Define delta encoding (patch list + binary diff) with schema version.
- [x] Task 16.14.1.a.2: Add reader that replays deltas into a snapshot.
- [x] Task 16.14.1.a.3: Add corruption detection and fallback to last full snapshot.
- [x] Task 16.14.1.b: Add comparable-hash skip logic for unchanged writes.
- [x] Task 16.14.1.b.1: Track lastComparableHash only after successful write.
- [x] Task 16.14.1.b.2: Add guard to reset hash on error.
- [x] Task 16.14.1.c: Add size instrumentation with thresholds.
- [x] Task 16.14.1.c.1: Emit size stats in build_state and stage audit.
- [x] Task 16.14.1.c.2: Define warning/abort thresholds in policy.
- [x] Task 16.14.1.d: Add compressed write path for large state.
- [x] Task 16.14.1.d.1: Use jsonl + zstd for large state snapshots.
- [x] Task 16.14.1.d.2: Ensure loader auto-detects compression by extension.
- [x] Task 16.14.1.e: Add ledger integration for index_state.
- [x] Task 16.14.1.e.1: Store ordering ledger hash in index_state metadata.
- [x] Task 16.14.1.f: Add full snapshot after N deltas to cap chain length.
- [x] Task 16.14.1.f.1: Add rolling snapshot cadence (configurable N).

Tests:
- [x] `tests/indexing/artifacts/index-state-skip-write.test.js` (perf lane)

### Subphase 16.14.2 -- File Meta
Parallel: Can run alongside 16.14.1/16.14.3 with clear ownership.
Docs/specs to update: `docs/perf/index-state-file-meta.md`, `docs/specs/metadata-schema-v2.md`, `docs/specs/symbol-artifacts-and-pipeline.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeIndexState)`, `src/index/build/artifacts/file-meta.js (anchor: buildFileMeta)`, `src/index/build/postings.js (anchor: buildMinhash)`, `src/shared/artifact-io/loaders.js (anchor: loadMinhashSignatures)`
Tasks:
- [x] Task 16.14.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.14.2.doc.1: Define columnar schema fields and binary layout.
- [x] Task 16.14.2.doc.2: Document fallback behavior and max-bytes thresholds.
- [x] Task 16.14.2.a: Default to binary columnar for large repos.
- [x] Task 16.14.2.a.1: Add size estimator to choose columnar vs JSONL.
- [x] Task 16.14.2.a.2: Emit columnar meta with row counts and checksums.
- [x] Task 16.14.2.b: Add JSONL fallback when columnar exceeds cap.
- [x] Task 16.14.2.b.1: Detect oversize columnar output and re-run JSONL path.
- [x] Task 16.14.2.b.2: Ensure fallback removes columnar outputs to avoid stale reads.
- [x] Task 16.14.2.c: Stream file_meta into sqlite build.
- [x] Task 16.14.2.c.1: Allow sqlite builder to accept async iterator of rows.
- [x] Task 16.14.2.c.2: Add batch insert size config for file_meta ingest.
- [x] Task 16.14.2.d: Add reuse cache based on file hash list.
- [x] Task 16.14.2.d.1: Persist fingerprint (hash list) in meta extensions.
- [x] Task 16.14.2.d.2: Validate fingerprint before reuse and log reuse reason.
- [x] Task 16.14.2.e: Add file_meta validity checks.
- [x] Task 16.14.2.e.1: Validate required fields + row count parity.
- [x] Task 16.14.2.e.2: Detect stale columnar payload and fall back to JSONL.
- [x] Task 16.14.2.f: Add MAX_JSON_BYTES guard to force sharding for large columnar outputs.
- [x] Task 16.14.2.f.1: Ensure loader uses JSONL when columnar exceeds cap.

Tests:
- [x] `tests/indexing/artifacts/file-meta-columnar-roundtrip.test.js` (perf lane)
- [x] `tests/indexing/artifacts/file-meta-bench-contract.test.js` (perf lane) (new)

### Subphase 16.14.3 -- Minhash
Parallel: Can run alongside 16.14.1/16.14.2 with clear ownership.
Docs/specs to update: `docs/perf/index-state-file-meta.md`, `docs/specs/metadata-schema-v2.md`, `docs/specs/symbol-artifacts-and-pipeline.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeIndexState)`, `src/index/build/artifacts/file-meta.js (anchor: buildFileMeta)`, `src/index/build/postings.js (anchor: buildMinhash)`, `src/shared/artifact-io/loaders.js (anchor: loadMinhashSignatures)`
Tasks:
- [x] Task 16.14.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.14.3.doc.1: Document packed layout (endianness, alignment, row order).
- [x] Task 16.14.3.doc.2: Define skip behavior and cache invalidation rules.
- [x] Task 16.14.3.a: Implement SIMD-friendly packed minhash layout.
- [x] Task 16.14.3.a.1: Define fixed-width row structure with SIMD alignment.
- [x] Task 16.14.3.a.2: Add packer/unpacker utilities with schema version.
- [x] Task 16.14.3.b: Add packed consistency checks (checksum + count).
- [x] Task 16.14.3.b.1: Store checksum + row count in packed meta file.
- [x] Task 16.14.3.b.2: Reject packed reads on mismatch and fall back to JSONL.
- [x] Task 16.14.3.c: Add streaming minhash emission to avoid full arrays.
- [x] Task 16.14.3.c.1: Emit minhash rows during postings build.
- [x] Task 16.14.3.c.2: Allow packer to stream from iterator.
- [x] Task 16.14.3.d: Add cleanup of stale packed artifacts when skipped.
- [x] Task 16.14.3.d.1: Remove packed files when minhash is intentionally skipped.
- [x] Task 16.14.3.e: Add skip guard for large corpora with telemetry.
- [x] Task 16.14.3.e.1: Add threshold config and stage audit output.
- [x] Task 16.14.3.f: Ensure packed minhash always invalidates when skipped in a build.
- [x] Task 16.14.3.f.1: Gate packed loads on manifest or current build signature.

Tests:
- [x] `tests/indexing/artifacts/minhash-packed-roundtrip.test.js` (perf lane)
- [x] `tests/indexing/artifacts/minhash-packed-bench-contract.test.js` (perf lane) (new)

### Subphase 16.14.4 -- Tests + Bench
Parallel: Run after 16.14.1–16.14.3.
Docs/specs to update: `docs/perf/index-state-file-meta.md`, `docs/specs/metadata-schema-v2.md`, `docs/specs/symbol-artifacts-and-pipeline.md`
Touchpoints: `src/index/build/build-state.js (anchor: writeIndexState)`, `src/index/build/artifacts/file-meta.js (anchor: buildFileMeta)`, `src/index/build/postings.js (anchor: buildMinhash)`, `src/shared/artifact-io/loaders.js (anchor: loadMinhashSignatures)`
Tasks:
- [x] Task 16.14.4.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.14.4.a: Add `file-meta-compare` benchmark baseline/current.
- [x] Task 16.14.4.b: Add `minhash-packed` benchmark baseline/current.
- [x] Task 16.14.4.c: Add regression test for file_meta reuse.
- [x] Task 16.14.4.d: Add docs update for index_state/file_meta/minhash.
- [x] Task 16.14.4.e: Add load-time benchmark for sqlite file_meta ingestion.

Tests:
- [x] `tests/indexing/artifacts/file-meta-bench-contract.test.js` (perf lane) (new)
- [x] `tests/indexing/artifacts/minhash-packed-bench-contract.test.js` (perf lane) (new)

### Subphase 16.14.5 -- Full Streaming File Meta + Minimal-Impl Hardening
Parallel: Run after 16.14.4; depends on 16.13.4 streaming loader work.
Docs/specs to update: `docs/perf/index-state-file-meta.md`, `docs/specs/metadata-schema-v2.md`, `docs/specs/artifact-io-pipeline.md`
Touchpoints: `src/index/build/artifacts/file-meta.js (anchor: buildFileMeta)`, `src/shared/artifact-io/loaders.js (anchor: loadJsonArrayArtifact)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`, `src/storage/sqlite/utils.js (anchor: loadIndex)`
Tasks:
- [x] Task 16.14.5.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.14.5.a: Implement full streaming file_meta loader that yields rows without materializing arrays.
- [x] Task 16.14.5.a.1: Use offsets index when available and fall back to JSONL streaming when columnar is too large.
- [x] Task 16.14.5.a.2: Add row-level validation during streaming and abort on invalid rows.
- [x] Task 16.14.5.b: Update sqlite build to accept streaming file_meta iterator with backpressure.
- [x] Task 16.14.5.b.1: Add batch sizing by bytes + rows to keep steady memory usage.
- [x] Task 16.14.5.c: Remove minimal optional-array fallback in loadIndex; default to streaming unless explicitly materialized.
- [x] Task 16.14.5.d: Stream file_meta + minhash ingest in sqlite builder (no Promise handoff).
- [x] Task 16.14.5.e: Add benchmark comparing streaming vs materialized file_meta load with delta line.
- [x] Task 16.14.5.f: Add regression test for streaming correctness vs materialized load.
- [x] Task 16.14.5.g: Add regression test for streaming memory cap under large file_meta.
- [x] Task 16.14.5.h: Add regression test for MAX_JSON_BYTES behavior with streaming columnar fallback.

Tests:
- [x] `tests/perf/indexing/artifacts/file-meta-streaming-roundtrip.test.js` (perf lane) (new)
- [x] `tests/perf/indexing/artifacts/file-meta-streaming-memory.test.js` (perf lane) (new)
- [x] `tests/perf/indexing/artifacts/file-meta-streaming-reuse.test.js` (perf lane) (new)

---

## Phase 16.6 -- Stage1 Postings Throughput

### Subphase 16.6.1 -- Token/Postings Core
Parallel: Must land before 16.6.2.
Docs/specs to update: `docs/specs/segmentation-perf.md`, `docs/specs/large-file-caps-strategy.md`, `docs/specs/spimi-spill.md`, `docs/perf/indexing-stage-audit.md`
Touchpoints: `src/index/build/postings.js (anchor: buildPostings)`, `src/index/build/tokenization.js (anchor: tokenizeFile)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `src/index/build/indexer/steps/postings.js (anchor: buildPostingsStep)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`
Tasks:
- [x] Task 16.6.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.6.1.a: Implement token ID canonicalization at tokenize time.
- [x] Task 16.6.1.a.1: Define deterministic token ID assignment (order-independent) and persist `token_vocab` mapping.
- [x] Task 16.6.1.a.2: Plumb token IDs through `chunk_meta` + postings (retain legacy string tokens as optional fallback).
- [x] Task 16.6.1.b: Replace substring chargrams with rolling hash generation.
- [x] Task 16.6.1.b.1: Use a 64-bit rolling hash for chargrams (no substring allocations) with fixed seed/salt.
- [x] Task 16.6.1.b.2: Record hash parameters in artifacts and update retrieval/SQLite to consume hashed chargrams.
- [x] Task 16.6.1.b.3: Provide compatibility fallback for legacy string-chargram artifacts.
- [x] Task 16.6.1.c: Implement compact chunk token representation.
- [x] Task 16.6.1.c.1: Add packed/varint token ID encoding for chunk tokens and update readers/validators.
- [x] Task 16.6.1.d: Add pooling for hot arrays in postings.
- [x] Task 16.6.1.d.1: Pool per-chunk frequency maps/arrays and reuse buffers across chunks.
- [x] Task 16.6.1.e: Validate determinism across new token pipelines.
- [x] Task 16.6.1.e.1: Add ordering hash for token/chargram vocab outputs and enforce via validation.
- [x] Task 16.6.1.f: Enforce stable vocab ordering artifact to prevent nondeterminism.
- [x] Task 16.6.1.f.1: Emit a dedicated vocab-order artifact with stable hash (token/phrase/chargram).
- [x] Task 16.6.1.g: Add max token length guard in rolling chargram flow.
- [x] Task 16.6.1.g.1: Apply max token-length guard even when precomputed chargrams are supplied.

Tests:
- [x] `tests/indexing/postings/token-id-canonicalization.test.js` (perf lane) (new)
- [x] `tests/indexing/postings/chargram-rolling-hash.test.js` (perf lane) (new)
- [x] `tests/indexing/postings/compact-token-roundtrip.test.js` (perf lane) (new)
- [x] `tests/indexing/postings/vocab-order-determinism.test.js` (perf lane) (new)

### Subphase 16.6.2 -- Backpressure + Concurrency
Parallel: Run after 16.6.1.
Docs/specs to update: `docs/specs/segmentation-perf.md`, `docs/specs/large-file-caps-strategy.md`, `docs/specs/spimi-spill.md`, `docs/perf/indexing-stage-audit.md`
Touchpoints: `src/index/build/postings.js (anchor: buildPostings)`, `src/index/build/tokenization.js (anchor: tokenizeFile)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `src/index/build/indexer/steps/postings.js (anchor: buildPostingsStep)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`
Tasks:
- [x] Task 16.6.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.6.2.a: Add bounded queue between tokenization and postings.
- [x] Task 16.6.2.a.1: Define chunk-queue limits (rows + bytes) and enforce ordering during async postings apply.
- [x] Task 16.6.2.a.2: Emit backpressure when postings queue reaches maxPending and surface wait time.
- [x] Task 16.6.2.b: Split CPU vs IO concurrency knobs for Stage1.
- [x] Task 16.6.2.b.1: Add Stage1 postings concurrency + pending limit config keys.
- [x] Task 16.6.2.b.2: Add Stage1 tokenize concurrency + pending limit config keys (worker pool or CPU queue).
- [x] Task 16.6.2.c: Add scheduler integration hooks for Stage1.
- [x] Task 16.6.2.c.1: Add scheduler queue for postings apply with CPU+memory tokens.
- [x] Task 16.6.2.c.2: Route tokenization worker jobs through scheduler/proc queue.
- [x] Task 16.6.2.d: Add memory-based throttling in postings build.
- [x] Task 16.6.2.d.1: Implement heap-pressure throttling that reduces postings concurrency and queue depth.
- [x] Task 16.6.2.e: Add metrics for queue depth and backpressure events.
- [x] Task 16.6.2.e.1: Record queue depth high-water + backpressure wait in build_state/metrics.

Tests:
- [x] `tests/indexing/postings/backpressure-queue.test.js` (perf lane) (new)
- [x] `tests/indexing/postings/postings-queue-metrics.test.js` (perf lane) (new)

### Subphase 16.6.3 -- Tests + Bench
Parallel: Run after 16.6.1/16.6.2.
Docs/specs to update: `docs/specs/segmentation-perf.md`, `docs/specs/large-file-caps-strategy.md`, `docs/specs/spimi-spill.md`, `docs/perf/indexing-stage-audit.md`
Touchpoints: `src/index/build/postings.js (anchor: buildPostings)`, `src/index/build/tokenization.js (anchor: tokenizeFile)`, `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `src/index/build/indexer/steps/postings.js (anchor: buildPostingsStep)`, `src/index/build/artifacts/chunk-meta.js (anchor: writeChunkMeta)`
Tasks:
- [x] Task 16.6.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.6.3.a: Implement `postings-real` benchmark baseline/current.
- [x] Task 16.6.3.a.1: Define a fixed fixture corpus for `postings-real` (size + source documented).
- [x] Task 16.6.3.a.2: Add `tools/bench/index/postings-real.js` with stable baseline/current schema + Stage1 config.
- [x] Task 16.6.3.b: Add chargram throughput benchmark.
- [x] Task 16.6.3.b.1: Extend `tools/bench/index/chargram-postings.js` to cover rolling-hash path + baseline/current compare.
- [x] Task 16.6.3.b.2: Add contract test for chargram benchmark output format.
- [x] Task 16.6.3.c: Add heap plateau regression test.
- [x] Task 16.6.3.c.1: Promote `postings-heap-plateau` to perf lane and cover Stage1 end-to-end.
- [x] Task 16.6.3.c.2: Assert plateau after postings build completes + pool cleanup.
- [x] Task 16.6.3.d: Add determinism regression test for chunk_meta.
- [x] Task 16.6.3.d.1: Run Stage1 twice with different concurrency and compare `chunk_meta.json`.
- [x] Task 16.6.3.d.2: Compare stable vocab ordering artifact (from 16.6.1.f) between runs.
- [x] Task 16.6.3.e: Add documentation update for Stage1 changes.
- [x] Task 16.6.3.e.1: Document bench usage + perf lane coverage for Stage1 changes.
- [x] Task 16.6.3.f: Add memory budget enforcement regression test for Stage1.
- [x] Task 16.6.3.f.1: Use tiny memory budget to trigger backpressure/spill and assert metrics from 16.6.2.

Tests:
- [x] `tests/indexing/postings/postings-real-bench-contract.test.js` (perf lane) (new)
- [x] `tests/indexing/postings/chargram-bench-contract.test.js` (perf lane) (new)
- [x] `tests/perf/indexing/postings/postings-heap-plateau.test.js` (perf lane) (existing)
- [x] `tests/indexing/postings/chunk-meta-determinism.test.js` (perf lane) (new)
- [x] `tests/perf/indexing/postings/stage1-memory-budget.test.js` (perf lane) (new)

---

## Phase 16.7 -- Stage2 Relations + Filter Index

### Subphase 16.7.1 -- Relations Core
Parallel: Can run alongside 16.7.2 with clear file ownership.
Docs/specs to update: `docs/specs/symbol-artifacts-and-pipeline.md`, `docs/specs/map-artifact.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/deterministic-ordering.md`
Touchpoints: `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/artifacts/filter-index.js (anchor: writeFilterIndex)`, `src/index/build/artifacts/writers/repo-map.js (anchor: writeRepoMap)`, `src/shared/hash.js (anchor: hash64)`
Tasks:
- [x] Task 16.7.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.7.1.a: Implement typed edge storage during build.
- [x] Task 16.7.1.a.1: Define edge schema version + canonical field ordering in spec.
- [x] Task 16.7.1.b: Implement two-phase streaming relations build.
- [x] Task 16.7.1.b.1: Define spill file format + merge contract (ordering + dedupe).
- [x] Task 16.7.1.b.2: Add staging directory for spill outputs and atomic finalization.
- [x] Task 16.7.1.b.3: Eliminate in-memory Graphology relation graphs; build `graph_relations` from streamed edges during write phase.
- [x] Task 16.7.1.b.4: Preserve `graph_relations` ordering hash compatibility with `src/index/validate.js` (row serialization must match).
- [x] Task 16.7.1.c: Add deterministic ordering without global sort.
- [x] Task 16.7.1.c.1: Deterministic ordering for spill merge without global sort.
- [x] Task 16.7.1.c.2: Preserve stable JSON key ordering for `graph_relations` rows and node fields to prevent ordering hash drift.
- [x] Task 16.7.1.d: Add edge dedupe via compact hashes.
- [x] Task 16.7.1.d.1: Add collision strategy (hash + fingerprint or secondary compare).
- [x] Task 16.7.1.d.2: Add max edges per file/repo guardrails.
- [x] Task 16.7.1.d.3: Ensure dedupe/collision handling works on a streamed edge merge (no full materialization).
- [x] Task 16.7.1.e: Add spill thresholds by bytes.
- [x] Task 16.7.1.e.1: Add memory budget enforcement + backpressure integration for Stage2.
- [x] Task 16.7.1.f: Add fast reject filter for excluded files before edge creation.
- [x] Task 16.7.1.g: Add scheduler queue integration for relations IO/CPU.

Tests:
- [x] `tests/perf/indexing/relations/relations-streaming-build.test.js` (perf lane) (new)

### Subphase 16.7.2 -- Filter Index + Repo Map
Parallel: Can run alongside 16.7.1 with clear file ownership.
Docs/specs to update: `docs/specs/symbol-artifacts-and-pipeline.md`, `docs/specs/map-artifact.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/deterministic-ordering.md`
Touchpoints: `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/artifacts/filter-index.js (anchor: writeFilterIndex)`, `src/index/build/artifacts/writers/repo-map.js (anchor: writeRepoMap)`, `src/shared/hash.js (anchor: hash64)`
Tasks:
- [x] Task 16.7.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.7.2.a: Add per-file bitmaps in filter index.
- [x] Task 16.7.2.a.1: Specify bitmap format (sparse/dense) + versioning.
- [x] Task 16.7.2.b: Add repo map batching + safer writes (defer delta compression).
- [x] Task 16.7.2.b.1: Define delta compression header/version and fallback handling.
- [x] Task 16.7.2.c: Add concurrency split for relations IO.
- [x] Task 16.7.2.c.1: Tie IO split to scheduler queues + memory budget.
- [x] Task 16.7.2.d: Add filter index size telemetry.
- [x] Task 16.7.2.d.1: Record size + compression ratio in build_state/metrics.
- [x] Task 16.7.2.e: Add fallback to previous filter index on failure.
- [x] Task 16.7.2.e.1: Validate new filter index before swap; keep previous on validation failure.
- [x] Task 16.7.2.f: Add atomic staging + swap for filter index and repo map outputs.
- [x] Task 16.7.2.f.1: Update piece manifest only after successful swap; retain previous pieces on failure.

Tests:
- [x] `tests/perf/indexing/filter-index/bitmap-roundtrip.test.js` (perf lane) (new)

### Subphase 16.7.3 -- Tests + Bench
Parallel: Run after 16.7.1/16.7.2.
Docs/specs to update: `docs/specs/symbol-artifacts-and-pipeline.md`, `docs/specs/map-artifact.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/deterministic-ordering.md`
Touchpoints: `src/index/build/indexer/steps/relations.js (anchor: buildRelations)`, `src/index/build/artifacts/filter-index.js (anchor: writeFilterIndex)`, `src/index/build/artifacts/writers/repo-map.js (anchor: writeRepoMap)`, `src/shared/hash.js (anchor: hash64)`
Tasks:
- [x] Task 16.7.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.7.3.a: Add `filter-index-build` benchmark baseline/current.
- [x] Task 16.7.3.a.1: Add `relations-build` benchmark baseline/current.
- [x] Task 16.7.3.a.2: Add `repo-map-compress` benchmark baseline/current.
- [x] Task 16.7.3.b: Add relations memory regression test.
- [x] Task 16.7.3.b.1: Assert memory budget throttling + metrics for relations build.
- [x] Task 16.7.3.c: Add determinism test for relations output.
- [x] Task 16.7.3.c.1: Run with differing concurrency and compare outputs byte-for-byte.
- [x] Task 16.7.3.d: Add repo map sharded roundtrip test (meta + loader).
- [x] Task 16.7.3.d.1: Roundtrip sharded repo_map with versioned meta header.
- [x] Task 16.7.3.e: Add docs update for Stage2 changes.
- [x] Task 16.7.3.e.1: Document staging/atomic swap + fallback behavior.
- [x] Task 16.7.3.f: Add relations atomicity regression test for partial output rollback.
- [x] Task 16.7.3.g: Add collision regression test for hash dedupe.
- [x] Task 16.7.3.h: Update commands docs for new bench scripts (bench scripts run directly; npm script inventory remains package.json-only).
- [x] Task 16.7.3.i: Update any tests that directly read `graph_relations.json`/filter index files to load via artifact loaders (shards/legacy compatible).

Tests:
- [x] `tests/indexing/relations/relations-determinism-bench-contract.test.js` (perf lane) (new)
- [x] `tests/indexing/relations/relations-collision-guard.test.js` (perf lane) (new)
- [x] `tests/indexing/relations/relations-memory-budget.test.js` (perf lane) (new)
- [x] `tests/indexing/relations/relations-atomicity-rollback.test.js` (perf lane) (new)
- [x] `tests/indexing/filter-index/filter-index-atomic-swap.test.js` (perf lane) (new)
- [x] `tests/indexing/filter-index/filter-index-metrics.test.js` (perf lane) (new)
- [x] `tests/indexing/repo-map/repo-map-roundtrip.test.js` (perf lane) (new)

---

## Phase 16.8 -- Embeddings Pipeline Throughput

Implementation note: Stage3 embeddings pipeline currently lives under `tools/build/embeddings/*`; avoid introducing a parallel pipeline under `src/index/build/embeddings/*`.

### Subphase 16.8.1 -- Cache + Keys
Parallel: Can run alongside 16.8.2 with clear file ownership.
Docs/specs to update: `docs/specs/embeddings-cache.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`
Touchpoints: `tools/build/embeddings/runner.js (anchor: runBuildEmbeddingsWithConfig)`, `tools/build/embeddings/cache.js (anchor: buildCacheKey)`, `src/shared/embedding-identity.js (anchor: buildEmbeddingIdentity)`, `src/shared/cache-key.js (anchor: buildCacheKey)`, `tools/build/embeddings/scheduler.js (anchor: createEmbeddingsScheduler)`
Tasks:
- [x] Task 16.8.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.8.1.a: Cache identity must be derived from `src/shared/embedding-identity.js` only; audit coverage for provider/modelId/dims/normalize/quantization/pooling/truncation/stub.
- [x] Task 16.8.1.b: Keep cache fast-reject O(1) via `cache.index.json` metadata (identityKey/hash/chunkSignature) without reading shard payloads; add telemetry + regression test.
- [x] Task 16.8.1.c: Enforce per-mode cache isolation (mode always in key); add regression test for cross-mode collision prevention.
- [x] Task 16.8.1.d: Fail-closed cache validity: reject on dims/normalize mismatch, incomplete vectors, or signature/hash mismatch; never partially apply an invalid entry.
- [x] Task 16.8.1.e: Telemetry: standardize cacheStats fields and ensure they land in `index_state.embeddings.cacheStats` + metrics output.
- [x] Task 16.8.1.f: Pruning safety: verify prune plan is safe under concurrent builds (append-only shards, atomic index updates); update docs and tests.

Tests:
- [x] `tests/indexing/embeddings/embeddings-cache-identity.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embeddings-cache-invalidation.test.js` (perf lane)
- [x] `tests/indexing/embeddings/cache-index-append-only.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embeddings-cache-fast-reject.test.js` (perf lane) (new)

### Subphase 16.8.2 -- IO + Batching
Parallel: Can run alongside 16.8.1 with clear file ownership.
Docs/specs to update: `docs/specs/embeddings-cache.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`
Touchpoints: `tools/build/embeddings/runner.js (anchor: runBuildEmbeddingsWithConfig)`, `tools/build/embeddings/pipeline.js (anchor: createFileEmbeddingsProcessor)`, `tools/build/embeddings/batch.js (anchor: flushEmbeddingsBatch)`, `tools/build/embeddings/scheduler.js (anchor: createEmbeddingsScheduler)`, `src/shared/embedding-batch.js (anchor: resolveAutoEmbeddingBatchSize)`
Tasks:
- [x] Task 16.8.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.8.2.a: Implement writer pipeline as a bounded queue (all writes go through the IO scheduler; no bypass paths).
- [x] Task 16.8.2.b: Add IO backpressure to compute path (when writer queue is saturated, compute awaits).
- [x] Task 16.8.2.c: Batch-size auto-tuning: centralize in `src/shared/embedding-batch.js`, plumb to Stage3, and document provider limits.
- [x] Task 16.8.2.d: Vector pre-allocation + pooling for hot paths (typed arrays); add guardrails against cross-file mutation.
- [x] Task 16.8.2.e: Enforce chunk-stable batching (deterministic chunk ordering independent of concurrency and batch size).
- [x] Task 16.8.2.f: Add CPU-only batch sizing tuned by available threads (stub/onnx paths).

Tests:
- [x] `tests/indexing/embeddings/embedding-queue.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embedding-batch-autotune.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embedding-batcher-flush-reentrancy.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embeddings-writer-backpressure.test.js` (perf lane) (new)

### Subphase 16.8.3 -- Tests + Bench
Parallel: Run after 16.8.1/16.8.2.
Docs/specs to update: `docs/specs/embeddings-cache.md`, `docs/specs/runtime-envelope.md`, `docs/perf/indexing-stage-audit.md`
Touchpoints: `tools/build/embeddings/runner.js (anchor: runBuildEmbeddingsWithConfig)`, `tools/build/embeddings/batch.js (anchor: flushEmbeddingsBatch)`, `tools/bench/cache-hit-rate.js`, `src/shared/embedding-utils.js (anchor: mergeEmbeddingVectors)`, `src/shared/concurrency.js (anchor: runWithQueue)`
Tasks:
- [x] Task 16.8.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.8.3.a: Extend `cache-hit-rate` bench to include writer queue + backpressure.
- [x] Task 16.8.3.b: Add throughput benchmark for batch-size tuning across providers (stub/onnx/openai).
- [x] Task 16.8.3.c: Add regression test for embedding output determinism (same inputs produce identical vectors + manifests).
- [x] Task 16.8.3.d: Add docs update for embeddings pipeline (include queue/backpressure knobs + telemetry fields).
- [x] Task 16.8.3.e: Add memory regression test for embeddings (heap plateau under backlog).

Tests:
- [x] `tests/shared/cache/cache-hit-rate-contract.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embedding-batch-throughput.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embedding-normalization-consistency.test.js` (perf lane)
- [x] `tests/indexing/embeddings/embeddings-determinism.test.js` (perf lane) (new)
- [x] `tests/indexing/embeddings/embeddings-memory-plateau.test.js` (perf lane) (new)

---

## Phase 16.9 -- SQLite Build Throughput

Implementation note: SQLite build code lives under `src/storage/sqlite/build/*` and is invoked by Stage4 via `src/storage/sqlite/build/runner.js`. Keep build behavior atomic and deterministic (build to temp, validate, then swap), and avoid introducing a second competing build path.

### Subphase 16.9.1 -- Bulk Load Core
Parallel: Must land before 16.9.2.
Docs/specs to update: `docs/perf/sqlite-build.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`
Touchpoints: `src/storage/sqlite/build/runner.js (anchor: runBuildSqliteIndexWithConfig)`, `src/storage/sqlite/build/output-paths.js (anchor: resolveOutputPaths)`, `src/storage/sqlite/build/from-artifacts.js (anchor: buildDatabaseFromArtifacts)`, `src/storage/sqlite/build/from-bundles.js (anchor: buildDatabaseFromBundles)`, `src/storage/sqlite/build/statements.js (anchor: createInsertStatements)`, `src/storage/sqlite/build/pragmas.js (anchor: applyBuildPragmas)`, `src/storage/sqlite/utils.js (anchor: resolveSqliteBatchSize)`, `src/storage/sqlite/schema.js (anchor: CREATE_TABLES_BASE_SQL)`
Tasks:
- [x] Task 16.9.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.9.1.a: Ensure BOTH artifact builds and bundle builds use a consistent load-first flow (schema base, ingest, then indexes/optimize) and share common ingestion helpers where possible.
- [x] Task 16.9.1.b: Add a top-level transaction boundary for full builds (one `BEGIN`/`COMMIT` spanning all table loads + index creation); ensure no accidental autocommit islands (including `db.exec()` multi-statement inserts).
- [x] Task 16.9.1.c: Split statements for full rebuild vs incremental update: full rebuild must prefer `INSERT` (fail-fast on duplicates) while incremental update may use `INSERT OR REPLACE` where needed.
- [x] Task 16.9.1.d: Reduce prepare/parse overhead: prepare insert statements once per DB handle and reuse across all artifact shards (no per-shard `db.prepare` churn).
- [x] Task 16.9.1.e: Batch sizing: make batch size decisions observable in telemetry (input bytes, chosen batch size, rows/sec per table) and ensure overrides are consistently plumbed through Stage4 runner.
- [x] Task 16.9.1.f: Evaluate multi-row INSERT vs statement loops for heavy tables (token/phrase/chargram postings); pick the faster path per benchmark and document the decision in `docs/perf/sqlite-build.md`.

Tests:
- [x] `tests/storage/sqlite/sqlite-build-pragmas-dynamic.test.js` (perf lane)
- [x] `tests/storage/sqlite/sqlite-build-pragmas-restore.test.js` (perf lane)
- [x] `tests/storage/sqlite/sqlite-build-full-transaction.test.js` (perf lane) (new)

### Subphase 16.9.2 -- FTS/Index Build
Parallel: Run after 16.9.1.
Docs/specs to update: `docs/perf/sqlite-build.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`
Touchpoints: `src/storage/sqlite/schema.js (anchor: CREATE_INDEXES_SQL)`, `src/storage/sqlite/schema.js (anchor: CREATE_TABLES_BASE_SQL)`, `src/storage/sqlite/build/pragmas.js (anchor: optimizeBuildDatabase)`, `src/storage/sqlite/build/validate.js (anchor: validateSqliteDatabase)`, `src/retrieval/sqlite-helpers.js (anchor: rankSqliteFts)`
Tasks:
- [x] Task 16.9.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.9.2.a: FTS strategy: make `chunks_fts` contentless (`content=''`) to avoid duplicating chunk text; confirm runtime does not depend on reading FTS-stored content (ranking-only is OK).
- [x] Task 16.9.2.b: Add explicit FTS post-load optimization (`INSERT INTO chunks_fts(chunks_fts) VALUES('optimize')`) and include it in Stage4 telemetry.
- [x] Task 16.9.2.c: Index plan: audit `CREATE_INDEXES_SQL` for redundant indexes (especially those subsumed by PRIMARY KEY ordering); remove/adjust indexes based on query plans + benchmarks and update tests accordingly.
- [x] Task 16.9.2.d: Row-shape optimizations: evaluate `WITHOUT ROWID` for postings/vocab tables with composite PRIMARY KEYs; document which tables change and why (size vs build time vs query plan effects).
- [x] Task 16.9.2.e: Artifact read pipeline: keep reads streaming and bounded (no full materialization of large JSONL shards); add guardrails for maxBytes enforcement on all artifact readers used by Stage4.
- [x] Task 16.9.2.f: Post-build sequencing: run index creation, then `PRAGMA optimize`, then `ANALYZE` (gated by size), and finish with an explicit WAL checkpoint/cleanup step when building a new DB.

Tests:
- [x] `tests/storage/sqlite/sqlite-build-indexes.test.js` (perf lane)
- [x] `tests/storage/sqlite/sqlite-fts-contentless-schema.test.js` (perf lane) (new)

### Subphase 16.9.3 -- Tests + Bench
Parallel: Run after 16.9.1/16.9.2.
Docs/specs to update: `docs/perf/sqlite-build.md`, `docs/specs/artifact-schemas.md`, `docs/perf/index-artifact-pipelines.md`
Touchpoints: `tools/bench/sqlite/build-from-artifacts.js (anchors: parseArgs, runBuild)`, `src/storage/sqlite/build/from-artifacts.js (anchors: loadIndexPieces, buildDatabaseFromArtifacts)`, `src/storage/sqlite/build/statements.js (anchor: createInsertStatements)`, `src/storage/sqlite/build/pragmas.js (anchors: applyBuildPragmas, optimizeBuildDatabase)`, `src/storage/sqlite/build/validate.js (anchor: validateSqliteDatabase)`, `src/storage/sqlite/schema.js (anchors: CREATE_TABLES_BASE_SQL, CREATE_INDEXES_SQL)`
Tasks:
- [x] Task 16.9.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.9.3.a: Extend `tools/bench/sqlite/build-from-artifacts.js` with `--index-dir <dir>` so the bench can run against a real Stage2/Stage3 index output (when absent, keep the synthetic artifact generator path).
- [x] Task 16.9.3.b: Add a bench switch for statement strategy (prepared reuse vs prepare-per-shard vs multi-row exec) and report per-table ingestion stats (rows, rows/sec, prepare counts) so 16.9.1 decisions stay measurable.
- [x] Task 16.9.3.c: Add a row-count contract test that derives expected counts from artifacts (chunk_meta totals, postings meta, dense/minhash presence) and asserts per-mode table counts match (including FTS).
- [x] Task 16.9.3.d: Add regression test enforcing prepared statement reuse (no `db.prepare()` churn per shard) using ingestion stats or explicit instrumentation.
- [x] Task 16.9.3.e: Add post-build validation "fast path" test for `validateMode=auto` (quick_check for large DBs; integrity_check for small DBs) while still enforcing expected row-count guards.
- [x] Task 16.9.3.f: Add docs update for the Stage4 build/validate flow (transaction boundary, validate modes, per-table stats, and bench commands).

Tests:
- [x] `tests/storage/sqlite/sqlite-build-bench-contract.test.js` (perf lane) (new)
- [x] `tests/storage/sqlite/sqlite-build-rowcount-contract.test.js` (perf lane) (new)
- [x] `tests/storage/sqlite/sqlite-build-prepared-statement-reuse.test.js` (perf lane) (new)
- [x] `tests/storage/sqlite/sqlite-build-validate-auto-fast-path.test.js` (perf lane) (new)

---

## Phase 16.10 -- VFS Manifest Throughput

### Subphase 16.10.1 -- Segment IO
Parallel: Can run alongside 16.10.2 with clear file ownership.
Docs/specs to update: `docs/specs/vfs-manifest-artifact.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-segment-hash-cache.md`
Touchpoints: `src/index/tooling/vfs.js (anchors: buildToolingVirtualDocuments, loadVfsManifestRowByPath, loadVfsManifestBloomFilter, loadVfsManifestIndex, readVfsManifestRowAtOffset)`, `src/index/build/artifacts/writers/vfs-manifest.js (anchor: enqueueVfsManifestArtifacts)`, `src/index/tooling/vfs-hash-routing.js (anchor: buildVfsRoutingToken)`, `src/integrations/tooling/providers/lsp.js (anchor: ensureVirtualFilesBatch)`, `src/index/segments/jsx.js (anchor: segmentJsx)`, `src/index/segments.js (anchor: chunkSegments)`
Tasks:
- [x] Task 16.10.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.10.1.a: Harden the VFS manifest lookup fast-path (bloom -> vfsidx -> offset read); add telemetry for scan fallbacks and negative-cache hit rates.
- [x] Task 16.10.1.b: Add batched row loads that reuse a single file handle and pooled buffers for offset reads (critical for per-language tooling batching without N open/close churn).
- [x] Task 16.10.1.c: Fix `[tooling] Invalid virtualRange ...; skipping target.` by making chunk-to-virtual range mapping segment-safe (no full-container AST reuse for sliced segments), and add a degraded fallback target (whole-container) so we never silently drop work.
- [x] Task 16.10.1.d: Ensure VFS routing supports per-language batching deterministically (stable `languageId`/`effectiveExt` on rows, stable `virtualPath` and routing token composition across runs).
- [x] Task 16.10.1.e: Decide and document whether extracted-prose participates in VFS routing/manifests; if yes, add coverage and ensure per-language bucketing remains deterministic.

Tests:
- [x] `tests/tooling/vfs/vfs-bloom-negative-lookup.test.js` (perf lane)
- [x] `tests/tooling/vfs/vfs-index-lookup.test.js` (perf lane)
- [x] `tests/tooling/vfs/vfs-io-batch-consistency.test.js` (perf lane)
- [x] `tests/tooling/vfs/vfs-maps-segment-offsets.test.js` (perf lane)
- [x] `tests/tooling/vfs/vfs-invalid-virtual-range-regression.test.js` (perf lane) (new)

### Subphase 16.10.2 -- Merge/Compaction
Parallel: Can run alongside 16.10.1 with clear file ownership.
Docs/specs to update: `docs/specs/vfs-manifest-artifact.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-segment-hash-cache.md`
Touchpoints: `src/index/build/vfs-manifest-collector.js (anchor: createVfsManifestCollector)`, `src/index/build/artifacts/writers/vfs-manifest.js (anchor: enqueueVfsManifestArtifacts)`, `src/shared/merge.js (anchor: mergeSortedRuns)`, `src/index/tooling/vfs-index.js (anchor: buildVfsManifestSortKey)`
Tasks:
- [x] Task 16.10.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.10.2.a: Audit spill and compaction thresholds (bytes and record-count) and ensure they remain bounded-memory under worst-case VFS density.
- [x] Task 16.10.2.b: Ensure merge/compaction is deterministic under concurrency (stable compare keys, stable trim/drop policy); add telemetry for merge fan-in and spill frequency.
- [x] Task 16.10.2.c: Ensure manifest + vfsidx + bloom are swapped atomically as a unit; on failure keep the previous artifact set and clean partial outputs.
- [x] Task 16.10.2.d: Define and implement an incremental rebuild story (when allowed) keyed by CDC/segmentUid/docHash so rebuilds avoid full rewrites and reduce IO churn.

Tests:
- [x] `tests/tooling/vfs/vfs-collector-cleanup-on-error.test.js` (perf lane)
- [x] `tests/tooling/vfs/vfs-merge-heap-deterministic.test.js` (perf lane)
- [x] `tests/indexing/vfs/merge-core-integration.test.js` (perf lane)
- [x] `tests/indexing/vfs/vfs-manifest-row-trimming.test.js` (perf lane)
- [x] `tests/indexing/vfs/vfs-compaction-atomic-swap.test.js` (perf lane) (new)

### Subphase 16.10.3 -- Tests + Bench
Parallel: Run after 16.10.1/16.10.2.
Docs/specs to update: `docs/specs/vfs-manifest-artifact.md`, `docs/specs/vfs-io-batching.md`, `docs/specs/vfs-index.md`, `docs/specs/vfs-segment-hash-cache.md`
Touchpoints: `tools/bench/vfs/parallel-manifest-build.js`, `tools/bench/vfs/merge-runs-heap.js`, `tools/bench/vfs/vfsidx-lookup.js`, `tools/bench/vfs/hash-routing-lookup.js`, `tools/bench/vfs/bloom-negative-lookup.js`, `tools/bench/micro/utils.js (anchors: summarizeDurations, formatStats)`, `src/index/tooling/vfs.js (anchors: buildVfsManifestRowsForFile, createVfsColdStartCache, loadVfsManifestRowByPath, loadVfsManifestIndex)`, `src/index/build/artifacts/writers/vfs-manifest.js (anchor: enqueueVfsManifestArtifacts)`
Tasks:
- [x] Task 16.10.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.10.3.a: Add VFS bench contract coverage for manifest build + merge paths using relative invariants (e.g., concurrency scaling in `parallel-manifest-build`, heap merge dominating linear merge at high run-count) rather than hard machine-specific thresholds.
- [x] Task 16.10.3.b: Add VFS lookup bench contract coverage validating fast-path behavior (bloom/vfsidx negative lookups must avoid full scans; hash-routing lookups must match vfs manifest routing; surface fallbacks explicitly in JSON output).
- [x] Task 16.10.3.c: Add memory regression test for cold-start cache + index load (repeat load/lookup loops must plateau; caches must honor maxBytes/maxAge and not grow unbounded under repeated queries).
- [x] Task 16.10.3.d: Add docs update for VFS manifest and per-language batching expectations (include "invalid virtualRange" behavior and how it is surfaced/guarded).

Tests:
- [x] `tests/indexing/vfs/vfs-manifest-streaming.test.js` (perf lane) (existing)
- [x] `tests/tooling/vfs/vfs-cold-start-cache.test.js` (perf lane) (existing)
- [x] `tests/tooling/vfs/vfs-parallel-manifest-deterministic.test.js` (perf lane) (existing)
- [x] `tests/perf/vfs-bench-contract.test.js` (perf lane) (new)
- [x] `tests/perf/vfs-memory-plateau.test.js` (perf lane) (new)

---

## Phase 16.11 -- Tree-sitter Throughput

### Subphase 16.11.1 -- Grammar/Parser Caching
Parallel: Can run alongside 16.11.2 with clear file ownership.
Docs/specs to update: `docs/specs/segmentation-perf.md`, `docs/specs/large-file-caps-strategy.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/tree-sitter-runtime.md` (new)
Touchpoints: `src/lang/tree-sitter/runtime.js (anchors: initTreeSitterWasm, preloadTreeSitterLanguages, pruneTreeSitterLanguages, getTreeSitterParser)`, `src/lang/tree-sitter/state.js (anchor: treeSitterState)`, `src/lang/tree-sitter/chunking.js (anchors: buildTreeSitterChunks, buildTreeSitterChunksAsync, resolveChunkCacheKey)`, `src/lang/tree-sitter/worker.js (anchors: getTreeSitterWorkerPool, sanitizeTreeSitterOptions)`, `src/index/build/indexer/steps/process-files/tree-sitter.js (anchor: resolveTreeSitterPreloadPlan)`
Tasks:
- [x] Task 16.11.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.11.1.a: Audit and harden WASM grammar caching (alias dedupe, in-flight load dedupe, LRU eviction) and ensure `maxLoadedLanguages` caps behave predictably on main thread vs worker threads.
- [x] Task 16.11.1.b: Document and lock in the single shared `Parser` strategy (avoid per-language parser pools by default due to memory/Windows OOM risk); if we ever add pooling it must be explicitly opt-in with guardrails.
- [x] Task 16.11.1.c: Ensure preload planning stays deterministic and bounded (stable order, stable caps) and avoid redundant preloads across shards/batches.
- [x] Task 16.11.1.d: Harden grammar load fallback (path load vs bytes load) and add telemetry for load mode + failures.
- [x] Task 16.11.1.e: Expose tree-sitter cache metrics in the stage audit (wasm loads/evictions, parser activations, query cache hits, chunk cache hits, worker fallbacks).

Tests:
- [x] `tests/indexing/tree-sitter/tree-sitter-runtime.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-wasm-path-cache.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-preload-limited.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-preload-order-deterministic.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-eviction-determinism.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-query-precompile-cache.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-worker-prune-bounds.test.js` (perf lane)

### Subphase 16.11.2 -- Parse Scheduling
Parallel: Can run alongside 16.11.1 with clear file ownership.
Docs/specs to update: `docs/specs/segmentation-perf.md`, `docs/specs/large-file-caps-strategy.md`, `docs/perf/indexing-stage-audit.md`, `docs/specs/concurrency-abort-runwithqueue.md`
Touchpoints: `src/index/build/indexer/steps/process-files.js (anchor: processFiles)`, `src/index/build/indexer/steps/process-files/tree-sitter.js (anchors: applyTreeSitterBatching, buildTreeSitterEntryBatches, preloadTreeSitterBatch, sortEntriesByTreeSitterBatchKey)`, `src/index/build/file-processor/cpu/chunking.js (anchor: chunkSegmentsWithTreeSitterPasses)`, `src/lang/tree-sitter/chunking.js (anchors: buildTreeSitterChunksAsync, ensureChunkCache)`, `src/lang/tree-sitter/worker.js (anchor: getTreeSitterWorkerPool)`
Tasks:
- [x] Task 16.11.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.11.2.a: Make batch-by-language scheduling explicitly deadlock-safe with ordered output/backpressure (no uncontrolled reordering that can pin queue reservations); document the invariants.
- [x] Task 16.11.2.b: Strengthen batch execution: reset/prune/preload strategy per batch, metrics for batch sizes, deferrals, and parser activation churn.
- [x] Task 16.11.2.c: Tighten incremental reuse via chunk cache (cache key, option invalidation, max entries) so unchanged files do not re-parse, while bounding memory.
- [x] Task 16.11.2.d: Ensure parse tree memory stays bounded (explicit `Tree.delete()`, `Parser.reset()`, worker timeouts/disable logic, per-language budgets) and add telemetry for budget abort reasons.
- [x] Task 16.11.2.e: Validate deterministic chunk outputs across scheduling strategies (language passes within file + batch-by-language across files) and ensure final chunk ordering is stable.

Tests:
- [x] `tests/indexing/tree-sitter/tree-sitter-batch-by-language.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-timeout-disable.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-adaptive-budget.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-streaming-chunking.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/tree-sitter-fallback-missing-wasm.test.js` (perf lane)
- [x] `tests/indexing/tree-sitter/js-tree-sitter-maxbytes.test.js` (perf lane)

### Subphase 16.11.3 -- Tests + Bench
Parallel: Run after 16.11.1/16.11.2.
Docs/specs to update: `docs/specs/segmentation-perf.md`, `docs/specs/large-file-caps-strategy.md`, `docs/perf/indexing-stage-audit.md`
Touchpoints: `src/lang/tree-sitter/runtime.js (anchors: preloadTreeSitterLanguages, getTreeSitterStats)`, `src/lang/tree-sitter/chunking.js (anchors: buildTreeSitterChunks, buildTreeSitterChunksAsync, resolveChunkCacheKey)`, `src/index/build/indexer/steps/process-files/tree-sitter.js (anchors: applyTreeSitterBatching, resolveTreeSitterPreloadPlan)`, `tools/bench/index/tree-sitter-load.js` (new), `tests/indexing/tree-sitter/*`
Tasks:
- [x] Task 16.11.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.11.3.a: Implement `tree-sitter-load` benchmark (place under `tools/bench/index/tree-sitter-load.js`) to measure parse/chunk throughput per language and per batching policy (file-order vs batch-by-language), emitting JSON with `getTreeSitterStats()` counters.
- [x] Task 16.11.3.b: Add cold vs warm cache modes in the benchmark (clear caches vs reuse) and add contract coverage asserting warm is faster than cold and that batch-by-language reduces redundant WASM loads under mixed-language inputs.
- [x] Task 16.11.3.c: Add regression test for parse determinism (same inputs must yield identical chunk boundaries/names/kinds across runs and across worker vs main thread where applicable).
- [x] Task 16.11.3.d: Add regression test for parse reuse on unchanged files (chunk cache hits and query cache reuse must be observable via stats; no re-parse when content hash unchanged).
- [x] Task 16.11.3.e: Add memory regression test for parse trees/caches (repeat parse loops must plateau; `maxLoadedLanguages` must cap growth on both main and worker pools).
- [x] Task 16.11.3.f: Add docs update for tree-sitter load strategy (batching, cache knobs, determinism invariants, telemetry fields surfaced in stage audit).

Tests:
- [x] `tests/indexing/tree-sitter/tree-sitter-load-bench-contract.test.js` (perf lane) (new)
- [x] `tests/indexing/tree-sitter/tree-sitter-parse-determinism.test.js` (perf lane) (new)
- [x] `tests/indexing/tree-sitter/tree-sitter-chunk-cache-reuse.test.js` (perf lane) (new)
- [x] `tests/indexing/tree-sitter/tree-sitter-memory-plateau.test.js` (perf lane) (new)

---

## Phase 16.12 -- Graph + Context Pack Throughput

### Subphase 16.12.1 -- Graph Store
Parallel: Can run alongside 16.12.2 with clear module ownership.
Docs/specs to update: `docs/specs/graph-filtering-and-dedupe.md`, `docs/specs/context-packs.md`, `docs/specs/impact-analysis.md`, `docs/perf/graph-context-pack.md`, `docs/perf/retrieval-pipeline.md`
Touchpoints: `src/graph/store.js (anchors: createGraphStore, buildGraphIndex, buildGraphIndexCacheKey)`, `src/graph/indexes.js (anchors: buildAdjacencyIndex, buildAdjacencyCsr, buildIdTable)`, `src/shared/artifact-io/loaders.js (anchor: loadGraphRelations)`
Tasks:
- [x] Task 16.12.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.12.1.a: Teach `GraphStore` to load the `graph_relations_csr` artifact from the pieces manifest (add `loadGraphRelationsCsr` to artifact-io).
- [x] Task 16.12.1.b: Plumb CSR into `GraphIndex` (`graphRelationsCsr`) and ensure `buildGraphIndexCacheKey` segments caches on CSR presence and graph selection.
- [x] Task 16.12.1.c: Add strict validation + fallback behavior for CSR payloads (offset monotonicity, edge bounds, stable node ordering); fall back to `graph_relations` on invalid CSR.
- [x] Task 16.12.1.d: Reduce redundant in-memory structures when CSR is available (avoid building per-node `both` adjacency lists; keep legacy path as fallback).
- [x] Task 16.12.1.e: Add graph store cache telemetry (hit/miss, build time, eviction) and basic memory accounting for loaded graph artifacts/indexes.

Tests:
- [x] `tests/graph/graph-store-cache-eviction.test.js` (existing)
- [x] `tests/graph/graph-index-cache-reuse.test.js` (existing)
- [x] `tests/graph/graph-id-remap-roundtrip.test.js` (existing)
- [x] `tests/graph/graph-store-csr-artifact-load.test.js` (perf lane) (new)

### Subphase 16.12.2 -- Traversal + Filtering
Parallel: Can run alongside 16.12.1 with clear module ownership.
Docs/specs to update: `docs/specs/graph-filtering-and-dedupe.md`, `docs/specs/context-packs.md`, `docs/specs/impact-analysis.md`, `docs/perf/graph-context-pack.md`, `docs/perf/retrieval-pipeline.md`
Touchpoints: `src/graph/neighborhood.js (anchor: buildGraphNeighborhood)`, `src/graph/impact.js (anchor: buildImpactAnalysis)`, `src/graph/context-pack.js (anchor: buildGraphContextPack)`, `src/context-pack/assemble.js (anchors: buildChunkIndex, assembleCompositeContextPack)`, `src/retrieval/output/graph-impact.js (anchor: renderGraphImpact)`
Tasks:
- [x] Task 16.12.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.12.2.a: Use CSR-backed neighbor resolution in `buildGraphNeighborhood` when `graphIndex.graphRelationsCsr` is available (preserve determinism + cap enforcement).
- [x] Task 16.12.2.b: Add a reverse-edge index strategy for `direction=in|both` without materializing full `in`/`both` adjacency lists (build once per graphIndex and cache).
- [x] Task 16.12.2.c: Add traversal-result caching keyed by query signature (seed(s), graphs/edgeTypes, depth, direction, caps, includePaths, indexSignature) with telemetry and strict invalidation.
- [x] Task 16.12.2.d: Define "streaming context-pack assembly" precisely and add an assembly path that does not require a full in-memory `chunkMeta` array or `chunkIndex` (provider-based lookup for required chunks/excerpts).
- [x] Task 16.12.2.e: Lock determinism across legacy vs CSR paths and across caching (explicit invariants + regression tests).
- [x] Task 16.12.2.f: Expand traversal stats to include cap trigger counts + import graph lookup misses, and ensure they are surfaced consistently in outputs.

Tests:
- [x] `tests/graph/graph-output-deterministic.test.js` (existing)
- [x] `tests/graph/graph-filter-predicate-deterministic.test.js` (existing)
- [x] `tests/graph/graph-truncation-deterministic.test.js` (existing)
- [x] `tests/retrieval/graph/context-pack-determinism.test.js` (existing)
- [x] `tests/graph/graph-csr-neighbors-deterministic.test.js` (perf lane) (new)

### Subphase 16.12.3 -- Tests + Bench
Parallel: Run after 16.12.1/16.12.2.
Docs/specs to update: `docs/specs/graph-filtering-and-dedupe.md`, `docs/specs/context-packs.md`, `docs/specs/impact-analysis.md`, `docs/perf/graph-context-pack.md`, `docs/perf/retrieval-pipeline.md`
Touchpoints: `tools/bench/graph/context-pack-latency.js (anchors: runContextPackLatencyBench, runContextPackLatencyBenchCli)`, `tools/bench/graph/neighborhood-cache.js (anchors: runNeighborhoodBench, runNeighborhoodBenchCli)`, `tools/bench/graph/neighborhood-index-dir.js` (new), `tools/bench/graph/store-lazy-load.js`, `src/graph/store.js (anchors: createGraphStore, buildGraphIndexCacheKey)`, `src/graph/neighborhood.js (anchor: buildGraphNeighborhood)`, `src/graph/impact.js (anchor: buildImpactAnalysis)`, `src/context-pack/assemble.js (anchors: buildChunkIndex, assembleCompositeContextPack)`
Tasks:
- [x] Task 16.12.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.12.3.a: Extend `context-pack-latency` bench to report cache effectiveness and artifact load costs (GraphStore cache hits/misses, CSR vs legacy path when both are available) and keep output schema stable for contract tests.
- [x] Task 16.12.3.b: Add a real-index traversal bench (new: `tools/bench/graph/neighborhood-index-dir.js`) that loads graph artifacts via `GraphStore` and measures traversal/impact throughput (baseline vs current, warm vs cold caches, includePaths on/off).
- [x] Task 16.12.3.c: Add perf contract coverage for graph/context-pack benches using relative invariants (current must outperform baseline in the same run; CSR must not regress determinism/caps; warm must outperform cold).
- [x] Task 16.12.3.d: Add determinism regression coverage specific to cache boundaries (GraphStore cache reuse must not change output ordering; CSR vs legacy output equality where applicable).
- [x] Task 16.12.3.e: Add memory regression test for graph traversal/output (repeat expansions must plateau; spill/merge windows must cap edge buffering; caps must bound work).
- [x] Task 16.12.3.f: Add streaming context-pack integration test once 16.12.2.d exists (provider-based assembly must not require full `chunkMeta` materialization).
- [x] Task 16.12.3.g: Add docs update for graph/context-pack changes (bench commands, determinism invariants, caching boundaries, and how to interpret stats/memory fields).

Tests:
- [x] `tests/perf/graph-context-pack-latency-bench-contract.test.js` (perf lane) (new)
- [x] `tests/perf/graph-neighborhood-bench-contract.test.js` (perf lane) (new)
- [x] `tests/graph/graph-output-deterministic.test.js` (existing)
- [x] `tests/retrieval/graph/context-pack-determinism.test.js` (existing)
- [x] `tests/graph/graph-memory-plateau.test.js` (perf lane) (new)
- [x] `tests/retrieval/graph/context-pack-streaming-assembly.test.js` (perf lane) (new)

---

## Phase 16.15 -- Usage Verification + Cross-Phase Bench Coverage

### Subphase 16.15.1 -- Usage Checklist
Parallel: Can run alongside 16.15.2/16.15.3.
Docs/specs to update: `docs/perf/indexing-stage-audit.md`, `docs/perf/retrieval-pipeline.md`, `docs/perf/map-pipeline.md`, `docs/perf/shared-component-audit.md`, `docs/specs/test-strategy-and-conformance-matrix.md`
Touchpoints: `tools/bench/* (anchor: benchRunner)`, `tests/tooling/bench/* (anchor: bench output schema)`, `src/index/build/indexer/* (anchor: runPipeline)`, `src/retrieval/* (anchor: runSearch)`
Tasks:
- [x] Task 16.15.1.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.15.1.a: Verify Phase 0 usage (shared components in graph/context-pack).
- [x] Task 16.15.1.b: Verify Phase 1 usage (stage checkpoints in build_state).
- [x] Task 16.15.1.c: Verify Phase 2 usage (shared IO paths in build/search).
- [x] Task 16.15.1.d: Verify Phase 3 usage (postings guards in Stage1).
- [x] Task 16.15.1.e: Verify Phase 4 usage (relations/filter index in Stage2).
- [x] Task 16.15.1.f: Verify Phase 5 usage (embeddings cache in Stage3).
- [x] Task 16.15.1.g: Verify Phase 6 usage (sqlite optimizations in Stage4).
- [x] Task 16.15.1.h: Verify Phase 7 usage (VFS pipeline in build/tooling).
- [x] Task 16.15.1.i: Verify Phase 8 usage (tree-sitter load strategy).
- [x] Task 16.15.1.j: Verify Phase 9 usage (retrieval pipeline in search).
- [x] Task 16.15.1.k: Verify Phase 10 usage (graph/context-pack in search).
- [x] Task 16.15.1.l: Verify Phase 11 usage (CLI startup fast paths).
- [x] Task 16.15.1.m: Verify Phase 12 usage (map build/viewer).
- [x] Task 16.15.1.n: Verify Phase 13 usage (doc/JSDoc guardrails).
- [x] Task 16.15.1.o: Verify Phase 14 usage (artifact pipeline optimizations).
- [x] Task 16.15.1.p: Verify Phase 15 usage (index_state/file_meta/minhash paths).

Tests:
- [x] `tests/perf/indexing/validate/phase-usage-checklist.test.js` (perf lane) (new)

### Subphase 16.15.2 -- Bench Harness
Parallel: Can run alongside 16.15.1; ensure bench harness exists before validating outputs.
Docs/specs to update: `docs/perf/indexing-stage-audit.md`, `docs/perf/retrieval-pipeline.md`, `docs/perf/map-pipeline.md`, `docs/perf/shared-component-audit.md`, `docs/specs/test-strategy-and-conformance-matrix.md`
Touchpoints: `tools/bench/* (anchor: benchRunner)`, `tests/tooling/bench/* (anchor: bench output schema)`, `src/index/build/indexer/* (anchor: runPipeline)`, `src/retrieval/* (anchor: runSearch)`
Tasks:
- [x] Task 16.15.2.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.15.2.a: Ensure each phase has a baseline/current benchmark.
- [x] Task 16.15.2.b: Enforce delta reporting (amount, throughput, percentage, duration).
- [x] Task 16.15.2.c: Add real-index inputs for all benchmarks where applicable.
- [x] Task 16.15.2.d: Add bench runner that batches all phase benches.
- [x] Task 16.15.2.e: Add bench output summary report in CI artifacts.

Tests:
- [x] `tests/perf/tooling/bench/bench-runner-contract.test.js` (perf lane) (new)

### Subphase 16.15.3 -- Bench Output Contracts
Parallel: Run after 16.15.2; can overlap with 16.15.1.
Docs/specs to update: `docs/perf/indexing-stage-audit.md`, `docs/perf/retrieval-pipeline.md`, `docs/perf/map-pipeline.md`, `docs/perf/shared-component-audit.md`, `docs/specs/test-strategy-and-conformance-matrix.md`
Touchpoints: `tools/bench/* (anchor: benchRunner)`, `tests/tooling/bench/* (anchor: bench output schema)`, `src/index/build/indexer/* (anchor: runPipeline)`, `src/retrieval/* (anchor: runSearch)`
Tasks:
- [x] Task 16.15.3.doc: Update docs/specs and touchpoints listed for this subphase.
- [x] Task 16.15.3.a: Add schema for bench output JSON.
- [x] Task 16.15.3.b: Enforce schema in bench scripts.
- [x] Task 16.15.3.c: Add regression test for bench output format.
- [x] Task 16.15.3.d: Add docs for bench output semantics.
- [x] Task 16.15.3.e: Add tool to diff bench results between commits.

Tests:
- [x] `tests/perf/tooling/bench/bench-output-schema.test.js` (perf lane) (new)

---

## Phase 16.16 -- SWEETREPORT Missing Work Execution

### Objective
Finish the missing implementation, tests, and docs called out in `SWEETREPORT.md`.

### Execution Order (Mandatory)
1. Build shared invariant helpers before per-feature fixes.
2. Build reusable artifact-integrity helpers before minhash-specific checksum wiring.
3. Build malformed/corrupt/partial artifact corpora before expanding fuzz and fallback coverage.
4. Add measured queue/IO telemetry before backpressure and throughput tuning.
5. Land correctness remediations for determinism, collisions, filter-index language handling, and stale-plan handling.
6. Land throughput remediations for Stage4 streaming/materialization and context-pack seed indexing.
7. Prefer parameterized/metamorphic tests for paired behaviors before adding narrow single-case tests.
8. Run baseline/current benchmarks in the same controlled pass with warm/cold splits and variance guards.
9. Mark acceptance only after green tests and benchmark deltas are recorded.

### Tasks
- [x] Add shared invariant helpers for determinism rules.
- [x] Add shared invariant helpers for token-collision policy.
- [x] Add shared invariant helpers for comparator-contract enforcement.
- [x] Route Stage1 token-id collision handling through shared invariant helpers.
- [x] Route merge comparator validation through shared invariant helpers.
- [x] Route determinism validation through shared invariant helpers.
- [x] Add reusable packed-artifact checksum helpers in artifact IO.
- [x] Route minhash packed checksum write path through reusable checksum helpers.
- [x] Route minhash packed checksum load path through reusable checksum helpers.
- [x] Add malformed artifact corpus fixtures for loader hardening.
- [x] Add corrupt artifact corpus fixtures for loader hardening.
- [x] Add partial artifact corpus fixtures for loader hardening.
- [x] Add `tests/shared/concurrency/scheduler-contract.test.js`.
- [x] Add `tests/shared/concurrency/scheduler-config-parse.test.js`.
- [x] Add `tests/shared/artifact-io/artifact-io-spec-contract.test.js`.
- [x] Add `tests/shared/cache/cache-key-schema.test.js`.
- [x] Add `tests/shared/merge/spill-merge-contract.test.js`.
- [x] Add `tests/indexing/runtime/byte-budget-policy-contract.test.js`.
- [x] Add `tests/shared/order/deterministic-ordering-contract.test.js`.
- [x] Detect missing sibling artifacts for partial shards in loader paths.
- [x] Fail deterministically on partial shard detection.
- [x] Add malformed shard coverage in `tests/shared/artifact-io/jsonl-fuzz.test.js`.
- [x] Add corrupt shard coverage in `tests/shared/artifact-io/jsonl-fuzz.test.js`.
- [x] Add `tests/shared/artifact-io/loader-fallbacks.test.js`.
- [x] Update unified artifact-io docs for current loader behavior.
- [x] Implement runtime cache-root versioning in `src/shared/cache-roots.js`.
- [x] Align build-truth-ledger schema between runtime and docs.
- [x] Align build-truth-ledger hash input definition between runtime and docs.
- [x] Hash emitted ordering lines directly in determinism validation.
- [x] Align byte-budget default overflow behavior with docs.
- [x] Enforce comparator validation in all merge adopters.
- [x] Fail fast on comparator contract violations.
- [x] Enforce Stage1 token-id collision policy.
- [x] Surface token-id collision failures in validation output.
- [x] Handle missing `effectiveLang` in filter-index generation.
- [x] Handle invalid `effectiveLang` in filter-index generation.
- [x] Add measured postings-queue byte metrics.
- [x] Add postings-queue gauge telemetry.
- [x] Replace heuristic postings-queue byte accounting with measured byte accounting.
- [x] Enforce backpressure bounds from measured postings-queue bytes.
- [x] Stamp tree-sitter scheduler plans with per-file version signatures.
- [x] Reject stale tree-sitter scheduler plans when source signatures change.
- [x] Emit VFS fast-path telemetry for bloom/vfsidx/scan paths.
- [x] Implement batched VFS row-load behavior from docs.
- [x] Validate batched VFS row-load behavior against docs.
- [x] Consolidate Stage4 chunk_meta streaming + token-text skip changes into one measured pass.
- [x] Stream `chunk_meta` in Stage4 where supported.
- [x] Skip unnecessary token-text materialization in Stage4.
- [x] Replace linear seed-resolution scans with indexed lookup in context-pack assembly.
- [x] Convert paired behavior tests to parameterized coverage.
- [x] Convert paired behavior tests to metamorphic coverage.
- [x] Add per-bench JSON output schema contracts.
- [x] Strengthen phase-usage checklist assertions with explicit phase signals.
- [x] Run benchmarks with warm/cold splits in one controlled pass.
- [x] Enforce benchmark variance guards for recorded deltas.
- [x] Run baseline benchmarks for affected phases.
- [x] Run current benchmarks for affected phases.
- [x] Record benchmark deltas in roadmap notes.
- [x] Mark acceptance items only after all required tests are green.
- [x] Mark acceptance items only after required benchmark evidence is present.

### Benchmark Evidence
- 2026-02-10T17:14:55.694Z controlled suite pass: `node tools/bench/bench-runner.js --suite sweet16-ci --json .testLogs/sweet16/sweet16-ci-controlled.json --quiet` -> summary `ok=14 error=0 timeout=0`.
- 2026-02-10T17:14:42.053Z variance guard pass: compared `.testLogs/sweet16/sweet16-ci-controlled.json` vs `.testLogs/sweet16/sweet16-ci-controlled-2.json`; guard file `.testLogs/sweet16/sweet16-variance-guard.json`; threshold `150%`; `ok=true` for 12/12 delta rows.
- 2026-02-10T17:14:55.694Z warm/cold split evidence: `tools/bench/index/tree-sitter-load.js` file-order scenario `coldFilesPerSec=1988.88`, `warmFilesPerSec=3867.89`, delta `+94.48%` (source: `.testLogs/sweet16/sweet16-bench-summary.json`).
- 2026-02-10T17:14:55.694Z baseline/current+delta evidence for compare benches recorded in `.testLogs/sweet16/sweet16-bench-summary.json` (`compare` array from the controlled suite report).

### Tests
- [x] `tests/shared/concurrency/scheduler-contract.test.js` (perf lane) (new)
- [x] `tests/shared/concurrency/scheduler-config-parse.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/artifact-io-spec-contract.test.js` (perf lane) (new)
- [x] `tests/shared/cache/cache-key-schema.test.js` (perf lane) (new)
- [x] `tests/shared/merge/spill-merge-contract.test.js` (perf lane) (new)
- [x] `tests/indexing/runtime/byte-budget-policy-contract.test.js` (perf lane) (new)
- [x] `tests/shared/order/deterministic-ordering-contract.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/loader-fallbacks.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/jsonl-fuzz.test.js` (perf lane) (new)
- [x] `tests/shared/cache/cache-root-versioning.test.js` (perf lane) (new)
- [x] `tests/indexing/build-state/build-truth-ledger-hash-alignment.test.js` (perf lane) (new)
- [x] `tests/indexing/validate/determinism-line-hash.test.js` (perf lane) (new)
- [x] `tests/indexing/runtime/byte-budget-default-policy.test.js` (perf lane) (new)
- [x] `tests/shared/merge/merge-comparator-adopters.test.js` (perf lane) (new)
- [x] `tests/indexing/stage1/token-id-collision-policy.test.js` (perf lane) (new)
- [x] `tests/retrieval/filter-index/effective-lang-fallback.test.js` (perf lane) (new)
- [x] `tests/indexing/stage1/postings-queue-byte-accounting.test.js` (perf lane) (new)
- [x] `tests/indexing/tree-sitter/tree-sitter-plan-stale-file-resilience.test.js` (perf lane) (new)
- [x] `tests/shared/artifact-io/minhash-checksum-validation.test.js` (perf lane) (new)
- [x] `tests/tooling/vfs/vfs-fastpath-telemetry-contract.test.js` (perf lane) (new)
- [x] `tests/storage/sqlite/sqlite-chunk-meta-streaming.test.js` (perf lane) (new)
- [x] `tests/retrieval/graph/context-pack-seed-indexing.test.js` (perf lane) (new)
- [x] `tests/perf/tooling/bench/per-bench-output-schema.test.js` (perf lane) (new)
- [x] `tests/perf/indexing/validate/phase-usage-checklist.test.js` (perf lane) (update)

---

## Acceptance (overall)
- [x] All Phase 16 specs exist and align with contracts.
- [x] Cross-stage scheduler + artifact IO pipeline are in active use.
- [x] Cache keys are unified and invalidation is correct across caches.
- [x] Determinism is enforced via ledger + ordering helpers.
- [x] All phases have baseline/current benchmarks with deltas.
- [x] Usage checklist is complete and verified.

---

## Post-Phase Tasks (For the next Roadmap)
- Unify shard threshold normalization across writer/loader paths (ensure a single shared helper is used everywhere).
- We need to evaluate the performance of indexing and searching on the repo itself to determine correct limits/safeguards/values
- evaluate context window sizing
- we need a 'merged' c8 coverage generation ci job

---

# FAST.md

Comprehensive optimization sweep for indexing/build, tree-sitter scheduling, artifact I/O, embeddings, and vector/sqlite paths.

Format:
- `Area` — subsystem
- `Files` — primary touchpoints
- `Opportunity` — optimization idea
- `Impact` — expected benefit
- `Risk` — rollout/correctness caveat

---

## Sweep 1: Core hotspots (high-confidence wins)

1. [x] Area: Chunk-to-call detail matching
- Files: `src/index/build/file-processor/process-chunks/dedupe.js`
- Opportunity: Replace O(chunks * callDetails) containment scans with interval/binary-search or sweep structure.
- Impact: Large CPU reduction on files with many call details.
- Risk: Must preserve “smallest containing span” semantics.

2. [x] Area: Per-chunk lint filtering
- Files: `src/index/build/file-processor/process-chunks/index.js`
- Opportunity: Replace per-chunk full `filter()` scans with pre-bucketed/sorted lint ranges.
- Impact: Avoid O(chunks * lintEntries) behavior.
- Risk: Maintain exact range inclusion behavior.

3. [x] Area: Repeated chunk text slicing
- Files: `src/index/build/file-processor/process-chunks/index.js`, `src/index/build/file-processor/process-chunks/enrichment.js`
- Opportunity: Pass already-sliced chunk text into enrichment/type/risk steps.
- Impact: Lower allocation and CPU in hot loops.
- Risk: None if chunk boundaries are unchanged.

4. [x] Area: Byte-bound chunk splitting
- Files: `src/index/chunking/limits.js`
- Opportunity: Replace repeated `Buffer.byteLength(text.slice(...))` in binary-search loops with precomputed byte-offset tables.
- Impact: Major speedup on large prose/text files.
- Risk: Must preserve UTF-8 boundary correctness.

5. [x] Area: Repeated line splitting/scanning
- Files: `src/index/chunking/dispatch.js`, `src/index/chunking/formats/*.js`
- Opportunity: Share line index/splits across format chunkers instead of repeated `split('\n')`.
- Impact: Lower memory churn and parsing CPU.
- Risk: Keep line-number semantics stable.

6. [x] Area: Duplicate tree-sitter work
- Files: `src/index/language-registry/registry-data.js`, `src/index/build/file-processor/cpu.js`
- Opportunity: Prevent duplicate parse/chunk work between language prepare paths and scheduler paths.
- Impact: Material CPU reduction on JS/TS-heavy repos.
- Risk: Must keep identical chunk identities.

7. [x] Area: Duplicate segment discovery
- Files: `src/index/build/tree-sitter-scheduler/plan.js`, `src/index/build/file-processor/cpu.js`
- Opportunity: Reuse plan segment metadata in processing instead of recomputing.
- Impact: Less parsing/scanning overhead.
- Risk: Ensure metadata freshness and signature checks.

8. [x] Area: Sync I/O in import resolution
- Files: `src/index/build/import-resolution.js`
- Opportunity: Replace frequent sync fs operations with async + memoized caches.
- Impact: Better throughput and less event-loop blocking.
- Risk: Cache invalidation (mtime/size) correctness.

9. [x] Area: VFS manifest collector serialization
- Files: `src/index/build/vfs-manifest-collector.js`
- Opportunity: Cache serialized rows during append/spill to avoid double stringify.
- Impact: Lower CPU in large manifest generation.
- Risk: Slight memory increase if cached strings are retained too long.

10. [x] Area: Global build lock scope
- Files: `src/index/build/lock.js`, `src/index/build/watch/lock.js`
- Opportunity: Narrow lock duration to write/finalization phases.
- Impact: Better parallelism and less watch contention.
- Risk: Need strict atomicity and promotion invariants.

11. [x] Area: Chunk meta multiple serializations
- Files: `src/index/build/artifacts/writers/chunk-meta.js`, `src/shared/json-stream.js`
- Opportunity: Single-pass scan+write or reuse cached JSONL lines.
- Impact: Lower CPU and temp allocations.
- Risk: Preserve ordering hash and metrics behavior.

12. [x] Area: Double-atomic shard writing
- Files: `src/shared/json-stream.js`, `src/index/build/artifacts/writers/chunk-meta.js`, `src/index/build/artifacts/token-postings.js`
- Opportunity: Avoid per-part atomic writes when parent temp-dir rename is already atomic.
- Impact: Fewer temp files/renames.
- Risk: Keep crash safety guarantees.

13. [x] Area: Post-write `stat()` fanout
- Files: `src/shared/json-stream.js`, `src/shared/json-stream/jsonl-batch.js`
- Opportunity: Use known bytes-written counters instead of per-part `stat`.
- Impact: Fewer syscalls.
- Risk: Ensure writer byte accounting is exact.

14. [x] Area: Token postings shard copies
- Files: `src/index/build/artifacts/token-postings.js`
- Opportunity: Use generators/ranges instead of per-shard array slices.
- Impact: Lower peak memory.
- Risk: Must keep deterministic shard boundaries.

15. [x] Area: Redundant size estimation
- Files: `src/index/build/artifacts/writer.js`, `src/index/build/artifacts.js`
- Opportunity: Plumb precomputed JSON byte estimates to avoid duplicate traversals.
- Impact: Lower CPU on large arrays.
- Risk: None if estimates are consistent.

16. [x] Area: Typed-array JSON encoding
- Files: `src/shared/json-stream/encode.js`
- Opportunity: Batch numeric array writes into larger chunks (not per-element writes).
- Impact: Lower write overhead for dense vectors/postings.
- Risk: Ensure valid JSON output and memory bounds.

17. [x] Area: Cached JSONL line reuse
- Files: `src/index/build/artifacts/writers/chunk-meta.js`
- Opportunity: Reuse `__jsonl` lines when already computed during spill paths.
- Impact: Lower serialization work.
- Risk: Must ensure line reflects final row content.

18. [x] Area: Manifest meta read cost
- Files: `src/shared/artifact-io/manifest.js`
- Opportunity: Cache parsed meta JSON.
- Impact: Faster repeated artifact resolution.
- Risk: Invalidation on file changes.

19. [x] Area: Embeddings cache index durability
- Files: `tools/build/embeddings/runner.js`, `tools/build/embeddings/cache-flush.js`
- Opportunity: Periodic index flush during long runs instead of only end-of-mode flush.
- Impact: Better crash resilience and lower flush spikes.
- Risk: More lock/I/O contention if too frequent.

20. [x] Area: Unindexed fallback cache entries
- Files: `tools/build/embeddings/cache.js`, `tools/build/embeddings/runner.js`
- Opportunity: Ensure lock-contention fallback entries are indexed/prunable.
- Impact: Lower long-term cache bloat and faster lookup hygiene.
- Risk: Migration of existing orphan entries.

21. [x] Area: HNSW pending vector accumulation
- Files: `tools/build/embeddings/hnsw.js`
- Opportunity: Incremental insertion instead of keeping full `pending` vectors.
- Impact: Lower peak RSS and earlier failure detection.
- Risk: Must preserve deterministic insertion order.

22. [x] Area: Full JSON vector loads in isolate paths
- Files: `tools/build/embeddings/hnsw.js`, `tools/build/embeddings/lancedb.js`
- Opportunity: Stream vectors instead of loading full JSON artifacts.
- Impact: Avoid OOM and reduce GC pressure.
- Risk: More complex streaming parser path.

23. [x] Area: Full rewrite of SQLite dense tables
- Files: `tools/build/embeddings/sqlite-dense.js`
- Opportunity: Incremental upsert/update path for changed doc_ids.
- Impact: Large write-time reduction for partial rebuilds.
- Risk: Requires reliable change tracking and consistency checks.

24. [x] Area: Per-vector clamp logging
- Files: `src/storage/sqlite/vector.js`, `src/storage/sqlite/build/from-artifacts.js`, `src/storage/sqlite/build/incremental-update.js`, `src/storage/sqlite/build/from-bundles.js`
- Opportunity: Aggregate clamp warnings instead of per-vector logs.
- Impact: Lower log overhead in large ingestion runs.
- Risk: Slightly less granular diagnostics.

25. [x] Area: SQLite artifact ingestion memory spikes
- Files: `src/storage/sqlite/build/from-artifacts.js`, `src/storage/sqlite/utils.js`
- Opportunity: Stream token postings and dense vectors by default.
- Impact: Lower RSS and improved stability on large indexes.
- Risk: More complex error handling/recovery.

26. [x] Area: SQLite ANN candidate limit fallback
- Files: `tools/sqlite/vector-extension.js`
- Opportunity: Replace `topN * 5` fallback with stronger candidate pushdown strategy.
- Impact: Better recall and less wasted work for large candidate sets.
- Risk: Query complexity and temp structure management.

---

## Sweep 2: Additional non-overlapping opportunities

1. [x] Area: Line-based chunker architecture
- Files: `src/index/chunking/dispatch.js`, `src/index/chunking/formats/yaml.js`, `src/index/chunking/formats/json.js`, `src/index/chunking/formats/markdown.js`
- Opportunity: Shared streaming line iterator + shared line index.
- Impact: Better memory locality and fewer repeated full-text scans.
- Risk: Keep exact heading/range behavior.

2. [x] Area: Markdown heading detection allocations
- Files: `src/index/chunking/formats/markdown.js`
- Opportunity: Avoid materializing full `[...matchAll()]` arrays.
- Impact: Reduced intermediate object retention.
- Risk: None if iteration order preserved.

3. [x] Area: JSON chunk parsing allocations
- Files: `src/index/chunking/formats/json.js`
- Opportunity: Avoid repeated substring/search allocations in per-key loops.
- Impact: Lower CPU/GC in large JSON files.
- Risk: Must preserve parser correctness around escapes.

4. [x] Area: Per-chunk lookup reuse
- Files: `src/index/build/file-processor/process-chunks/index.js`
- Opportunity: Cache language + dictionary resolution per file/effective ext.
- Impact: Lower hot-loop overhead.
- Risk: None with file-local cache lifetime.

5. [x] Area: Span grouping key overhead
- Files: `src/index/build/file-processor/process-chunks/ids.js`
- Opportunity: Avoid repeated key-array creation/join and eager array promotion.
- Impact: Lower allocation pressure.
- Risk: Keep deterministic dedupe/grouping behavior.

6. [x] Area: Scheduler subprocess startup overhead
- Files: `src/index/build/tree-sitter-scheduler/runner.js`, `src/index/build/tree-sitter-scheduler/subprocess-exec.js`
- Opportunity: Reuse long-lived worker process(es) instead of one fresh process per grammar key.
- Impact: Lower startup/module-load overhead.
- Risk: Worker lifecycle and isolation complexity.

7. [x] Area: Parser language switch churn
- Files: `src/index/build/tree-sitter-scheduler/plan.js`, `src/index/build/tree-sitter-scheduler/executor.js`, `src/lang/tree-sitter/native-runtime.js`
- Opportunity: Batch executor jobs to reduce `setLanguage` churn for mixed-language groups.
- Impact: Better parser throughput.
- Risk: Output order changes must remain deterministic.

8. [x] Area: Duplicate plan/executor file reads
- Files: `src/index/build/tree-sitter-scheduler/plan.js`, `src/index/build/tree-sitter-scheduler/executor.js`
- Opportunity: Share cached text/hash across phases or skip re-hash on unchanged signatures.
- Impact: Reduced disk/hash cost.
- Risk: Stale-read prevention logic required.

9. [x] Area: Scheduler result metadata repetition
- Files: `src/index/build/tree-sitter-scheduler/executor.js`, `src/index/build/file-processor/cpu.js`
- Opportunity: Segment metadata table + references instead of per-chunk duplication.
- Impact: Smaller artifacts and lower parse cost.
- Risk: Contract/schema changes.

10. [x] Area: Piscina backpressure/cancellation
- Files: `src/lang/tree-sitter/chunking.js`, `src/lang/tree-sitter/worker.js`, `src/lang/workers/tree-sitter-worker.js`
- Opportunity: Add abort propagation + bounded queue controls.
- Impact: Better tail latency and cancellation behavior.
- Risk: Must not regress throughput defaults.

11. [x] Area: Scheduler cancellation gaps
- Files: `src/index/build/tree-sitter-scheduler/runner.js`, `src/index/build/tree-sitter-scheduler/subprocess-exec.js`
- Opportunity: Add abort checks in index loading and child cleanup paths.
- Impact: Less wasted work on canceled builds.
- Risk: Partial-output cleanup must stay safe.

12. [x] Area: Manifest piece-index rebuilds
- Files: `src/shared/artifact-io/manifest.js`
- Opportunity: Cache `name -> entries` index per manifest object.
- Impact: Faster repeated artifact lookups.
- Risk: Must not cache across stale manifest objects.

13. [x] Area: Small-file JSONL read fast path
- Files: `src/shared/artifact-io/json.js`
- Opportunity: For small files, use buffered parse path instead of stream setup.
- Impact: Lower overhead on frequent small artifact reads.
- Risk: Need strict size threshold.

14. [x] Area: Small gzip buffered parse path
- Files: `src/shared/artifact-io/json.js`
- Opportunity: Buffered decompress+parse for tiny gzip files.
- Impact: Less stream overhead.
- Risk: Cap memory usage.

15. [x] Area: Offsets validation memoization
- Files: `src/shared/artifact-io/offsets.js`, `src/shared/artifact-io/loaders.js`
- Opportunity: Persist validation cache keyed by size/mtime signatures.
- Impact: Faster repeated startup/load paths.
- Risk: Robust invalidation required.

16. [x] Area: File descriptor reuse for row reads
- Files: `src/shared/artifact-io/offsets.js`, `src/shared/artifact-io/loaders.js`
- Opportunity: Keep handles open and reuse buffers for repeated `readOffsetAt`/`readJsonlRowAt`.
- Impact: Fewer syscalls and lower latency.
- Risk: FD lifecycle/leak management.

17. [x] Area: Coalesced row read batches
- Files: `src/shared/artifact-io/loaders.js`
- Opportunity: Group sorted offsets and read contiguous spans.
- Impact: Better I/O locality for symbol/chunk reads.
- Risk: Complexity in mapping responses back to original order.

18. [x] Area: Index signature fanout
- Files: `src/retrieval/cli-index.js`
- Opportunity: Use manifest-level stats/signature caching instead of per-part stat scans.
- Impact: Faster repeated index signature computation.
- Risk: Avoid stale cache when parts mutate.

19. [x] Area: VFS index map cache
- Files: `src/index/tooling/vfs.js`
- Opportunity: Cache parsed `.vfsidx` map by path+mtime.
- Impact: Lower repeated load cost.
- Risk: Small memory overhead.

20. [x] Area: VFS offset reader coalescing
- Files: `src/index/tooling/vfs.js`
- Opportunity: Coalesce offset reads and use shared buffers.
- Impact: Less random I/O.
- Risk: Maintain ordering guarantees.

21. [x] Area: Chunk meta hot/cold split
- Files: `src/shared/artifact-io/loaders.js`, `src/index/build/artifacts.js`
- Opportunity: Separate frequently used chunk fields from cold metadata.
- Impact: Smaller read footprint for common retrieval paths.
- Risk: Schema/migration complexity.

22. [x] Area: Windowed packed-postings reads
- Files: `src/shared/artifact-io/loaders.js`
- Opportunity: Avoid full `.bin` loads by windowed reads.
- Impact: Lower memory spikes.
- Risk: More complex random-access logic.

23. [x] Area: ANN candidate fallback type mismatch
- Files: `src/retrieval/pipeline.js`, `tools/sqlite/vector-extension.js`, `src/retrieval/bitmap.js`
- Opportunity: Normalize candidate set types (`Set` vs bitmap) before ANN query pushdown.
- Impact: Prevent unnecessary full scans and truncation artifacts.
- Risk: Must preserve existing candidate semantics.

24. [x] Area: ANN provider preflight unused
- Files: `src/retrieval/pipeline.js`, `src/retrieval/ann/providers/*.js`
- Opportunity: Implement provider `preflight` hooks to avoid repeated expensive failures.
- Impact: Lower cold/misconfigured query cost.
- Risk: Preflight must be cheap and deterministic.

25. [x] Area: Dims mismatch policy inconsistency
- Files: `src/retrieval/rankers.js`, `src/retrieval/lancedb.js`, `tools/sqlite/vector-extension.js`
- Opportunity: Standardize mismatch behavior across providers (reject/clip policy).
- Impact: Predictable results and fewer surprise fallbacks.
- Risk: Behavior change needs explicit contract update.

26. [x] Area: Search-side SQLite pragmas
- Files: `src/retrieval/cli-sqlite.js`, `src/storage/sqlite/build/pragmas.js`
- Opportunity: Apply read-optimized runtime pragmas (`cache_size`, `mmap_size`, `temp_store`, `busy_timeout`).
- Impact: Better query latency on larger DBs.
- Risk: Platform tuning variance.

27. [x] Area: WAL checkpoint/journal tuning for embedding updates
- Files: `tools/build/embeddings/sqlite-dense.js`, `src/storage/sqlite/build/pragmas.js`
- Opportunity: Tune `wal_autocheckpoint`/`journal_size_limit` for heavy vector writes.
- Impact: Smoother write latency and less WAL burst behavior.
- Risk: Must avoid excessive checkpoint frequency.

28. [x] Area: Cache-hit path overhead
- Files: `src/retrieval/query-cache.js`, `src/retrieval/sqlite-cache.js`, `src/retrieval/index-cache.js`, `src/retrieval/cli/run-search-session.js`
- Opportunity: Avoid full query-cache JSON parse and frequent sync stats on hit paths.
- Impact: Lower P95 for repeated queries.
- Risk: Need safe cache format migration.

---

## Sweep 3: Expert/tricky opportunities (high complexity, high payoff)

Implementation policy for Sweep 3:
- Every change ships behind an explicit flag, with legacy path fallback.
- Every binary/storage contract change is dual-read before dual-write, then default-flip.
- Every step must include deterministic parity tests and benchmark deltas.

1. [x] Area: Binary columnar core artifacts
- Files: `src/index/build/artifacts/writers/chunk-meta.js`, `src/index/build/postings.js`, `src/shared/artifact-io/loaders.js`, `src/storage/sqlite/build/from-artifacts.js`
- Decision: Add `binary-columnar` artifact mode for `chunk_meta` and postings with varint lengths, offsets, and string tables; keep packed postings as baseline.
- Rollout: `artifacts.binaryColumnar=true`; dual-write with ordering hash/checksum parity; reader preference flipped only after parity soak.
- Target: 2x+ load speedup and 40%+ lower load RSS.

2. [x] Area: Streaming chunk lifecycle
- Files: `src/index/build/indexer/steps/process-files.js`, `src/index/build/state.js`, `src/index/build/postings.js`
- Decision: Stream `chunk_meta` writes during processing and retain only minimal per-chunk stats needed by postings and quality signals.
- Rollout: `indexer.streamingChunks=true`; compare counts/hashes against legacy path before default enablement.
- Target: 40-70% lower peak heap on large builds.

3. [x] Area: File-level token stream reuse
- Files: `src/index/build/file-processor/process-chunks/index.js`, `src/index/build/tokenization.js`
- Decision: Build one per-file token stream plus offsets, then map chunk ranges into it when token text is semantically identical to per-chunk tokenization.
- Rollout: `tokenization.fileStream=true` gated by safe mode checks; fallback to per-chunk path.
- Target: 30%+ tokenization CPU reduction on high-chunk files.

4. [x] Area: Typed-array postings hash structures
- Files: `src/shared/token-id.js`, `src/index/build/state.js`, `src/index/build/postings.js`
- Decision: Move postings internals to typed-array/open-addressed structures keyed by token ids; preserve external artifact compatibility until contract flip.
- Rollout: `postings.typed=true`; dual-build parity with current postings writer.
- Target: 40%+ postings memory reduction.

5. [x] Area: Persistent tree-sitter chunk cache
- Files: `src/lang/tree-sitter/chunking.js`, `src/lang/tree-sitter/state.js`
- Decision: Persist chunk outputs keyed by `{contentHash, grammarKey, optionsSignature}` with strict invalidation and determinism checks.
- Rollout: `treeSitter.cachePersistent=true`; reuse only when signature + hash match.
- Target: 2-5x faster incremental tree-sitter stage for unchanged files.

6. [x] Area: Phrase n-gram rolling hashes
- Files: `src/index/build/state.js`, `src/index/build/postings.js`
- Decision: Replace phrase string concatenation with rolling token-id hash windows, with collision fallback checks.
- Rollout: `postings.phraseHash=true`; dual-write phrase strings + hashes until collision telemetry stays clean.
- Target: 20%+ phrase build CPU reduction and lower phrase memory.

7. [x] Area: Ordered appender bucketed-watermark scheduler
- Files: `src/index/build/indexer/steps/process-files/ordered.js`, `src/index/build/indexer/steps/process-files.js`
- Decision: Add deterministic bucketed watermark flush policy to reduce long-tail stalls while preserving exact global order.
- Rollout: `indexer.orderedBuckets=true`; enforce strict order assertions in tests.
- Target: 50% lower pending buffer spikes and materially fewer stall warnings.

8. [x] Area: Shared-memory scheduler transport
- Files: `src/index/build/tree-sitter-scheduler/runner.js`, `src/index/build/tree-sitter-scheduler/executor.js`, `src/index/build/tree-sitter-scheduler/lookup.js`
- Decision: Defer until paged scheduler store is implemented and benchmarked; keep as optional backend only.
- Rollout: `treeSitter.scheduler.transport=shm` experimental fallback to disk.
- Target: Pursue only if disk handoff remains dominant after items 9 and 12.

9. [x] Area: Binary scheduler row encoding
- Files: `src/index/build/tree-sitter-scheduler/executor.js`, `src/index/build/tree-sitter-scheduler/lookup.js`, `src/index/tooling/vfs.js`
- Decision: Implement binary row pages with stable schema/versioning and checksums.
- Rollout: `treeSitter.scheduler.format=binary-v1`; dual-read with JSONL/page-json fallback.
- Target: Lower scheduler lookup parse CPU and reduce artifact bytes.

10. [x] Area: Parser pool / persistent grammar workers
- Files: `src/index/build/tree-sitter-scheduler/runner.js`, `src/lang/tree-sitter/native-runtime.js`
- Decision: Keep single-process parser caching as default; defer daemonized persistent worker pool until measured need.
- Rollout: optional tuning first (`MAX_PARSER_CACHE_SIZE`, warmup list) before long-lived pool.
- Target: lower startup churn without introducing lifecycle fragility.

11. [x] Area: Cross-process scheduler row cache
- Files: `src/index/build/tree-sitter-scheduler/lookup.js`, `src/index/build/indexer/steps/process-files.js`
- Decision: Defer until paged store lands; evaluate shared page cache design only after in-process page cache metrics plateau.
- Rollout: optional `treeSitter.scheduler.sharedCache=true` after correctness soak.
- Target: only pursue if multi-process repeated lookup is a proven bottleneck.

12. [x] Area: Compressed result pages + 2-level index
- Files: `src/index/build/tree-sitter-scheduler/executor.js`, `src/index/build/tree-sitter-scheduler/lookup.js`
- Decision: Introduce page store first (JSON rows in pages + page index), then add compression per-page.
- Rollout: `treeSitter.scheduler.store=paged-json`; add `codec` metadata and checksum verification.
- Target: lower random I/O and faster lookup tail latency.

13. [x] Area: Zero-copy dense vector artifacts
- Files: `tools/build/embeddings/runner.js`, `src/storage/sqlite/build/from-artifacts.js`, `src/storage/sqlite/utils.js`, `src/retrieval/rankers.js`
- Decision: Add `dense_vectors_uint8.bin` plus meta describing dims/count/quantization; use direct typed-array views.
- Rollout: `embeddings.binaryDenseVectors=true`; dual-read with current JSON artifacts.
- Target: materially lower vector load time and startup RSS.

14. [x] Area: Quantized sqlite-vec ingestion path
- Files: `tools/sqlite/vector-extension.js`, `tools/build/embeddings/sqlite-dense.js`, `src/storage/sqlite/quantization.js`
- Decision: Ingest quantized data directly when backend capability advertises support; fallback to float32 path.
- Rollout: `sqliteVec.ingestEncoding=auto`; strict capability gating.
- Target: reduce stage3/4 CPU and memory overhead.

15. [x] Area: On-demand dense vector materialization at query time
- Files: `src/retrieval/sqlite-helpers.js`, `src/retrieval/ann/providers/dense.js`, `src/retrieval/cli/load-indexes.js`
- Decision: Load vectors lazily for candidate/topK windows with bounded LRU cache.
- Rollout: `retrieval.dense.lazyLoad=true`; keep eager mode fallback.
- Target: lower index load RSS and startup latency for large repos.

16. [x] Area: Candidate pushdown via temp tables/CTEs
- Files: `tools/sqlite/vector-extension.js`, `src/retrieval/cli-sqlite.js`
- Decision: Standardize temp-table candidate pushdown as primary large-set strategy, with explicit telemetry for fallback modes.
- Rollout: `sqliteVec.candidatePushdown=temp-table`.
- Target: stable recall and predictable latency for large candidate sets.

17. [x] Area: Adaptive ANN provider orchestration
- Files: `src/retrieval/pipeline.js`, `src/retrieval/ann/normalize-backend.js`, `src/shared/metrics.js`
- Decision: Use bounded adaptive ordering from rolling latency/failure telemetry with stable session ordering guarantees.
- Rollout: `retrieval.ann.adaptiveProviders=true`; strict deterministic guardrails.
- Target: improve p95 ANN latency without destabilizing result quality.

18. [x] Area: Background ANN maintenance/compaction
- Files: `tools/build/embeddings/runner.js`, `tools/build/compact-sqlite-index.js`, `src/retrieval/lancedb.js`
- Decision: Add threshold-triggered background maintenance with atomic artifact swap.
- Rollout: `embeddings.maintenance.background=true`; explicit thresholds for WAL growth, fragmentation, and drift.
- Target: stabilize long-run ANN throughput and tail latency.

19. [x] Area: Strict load-time embedding identity gating
- Files: `src/retrieval/cli/load-indexes.js`, `src/storage/sqlite/quantization.js`, `src/index/validate.js`
- Decision: Enforce strict identity and quantization compatibility across dense/hnsw/sqlite artifacts at load time.
- Rollout: default strict; non-strict mode warns but never mixes incompatible providers in one run.
- Target: eliminate subtle stale-artifact correctness/perf regressions.

---

## Refined Sweep 3 execution waves

1. Wave A (lowest risk, immediate wins): 7, 12, 13, 16, 19.
2. Wave B (medium risk, major throughput): 2, 3, 5, 6, 14, 15, 17.
3. Wave C (high complexity/core format): 1, 4, 9.
4. Wave D (only if proven needed): 8, 10, 11, 18.

---


## Phase 15 — Federation & Multi-Repo (Workspaces, Manifests, Federated Search)

### Objective

Enable first-class **workspace** workflows: index and query across **multiple repositories** in a single operation (CLI/API/MCP), with:

- explicit and deterministic repo identity (`repoId`, `repoRootCanonical`, `repoSetId`)
- deterministic selection, cohort gating, and merge semantics; stable JSON output for reproducibility
- correct cache keying and invalidation for both per-repo caches and federation-level query caches
- safe-by-default compatibility gating (cohorts) with explicit overrides and loud diagnostics
- clear cache layering with an eventual content-addressed store (CAS) and manifest-driven garbage collection (GC)

### Phase 15 Acceptance (explicit)
- [x] Workspace config + manifest schemas are enforced and validated.
- [x] Federated search works across repo sets with deterministic ordering.
- [x] Cohort gating prevents unsafe mixed‑version query plans.
- [x] Federated query cache is keyed and invalidated deterministically.

### Phase 15 Implementation Order (must follow)
1. 15.1 Workspace configuration, repo identity, and `repoSetId`.
2. 15.2 Workspace manifest generation and workspace-aware build orchestration.
3. 15.4 Compatibility gating and cohort policies.
4. 15.3 Federated search orchestration (CLI/API/MCP).
5. 15.5 Federated query caching and cache-key correctness.
6. 15.7 Index stats reporter surfaces.
7. 15.6 Shared caches, CAS, and GC (design gate first; implement last).

### Phase 15 Non-negotiable invariants
- [x] Canonicalization must be centralized:
  - [x] Workspace loader, API router, MCP resolver, and cache keys all use one canonical repo identity pipeline.
- [x] Invalid build pointers are treated as missing pointers:
  - [x] Never preserve stale values from malformed `builds/current.json`.
- [x] Federated execution must be deterministic under partial failures:
  - [x] Keep successful repos, surface per-repo errors, and apply deterministic ordering to diagnostics and merged outputs.
- [x] Federated cache keys must reflect actual runtime behavior:
  - [x] Include requested knobs and effective backend/runtime selections to avoid cache pollution.

### Canonical specs and required updates

Phase 15 MUST align with these authoritative docs:
- `docs/specs/workspace-config.md`
- `docs/specs/workspace-manifest.md`
- `docs/specs/federated-search.md`
- `docs/contracts/compatibility-key.md`
- `docs/specs/federation-cohorts.md`
- `docs/specs/federated-query-cache.md`
- `docs/specs/cache-cas-gc.md`
- `docs/specs/index-stats.md`
- `docs/specs/http-api.md`
- `docs/specs/config-defaults.md`

Spec updates required in Phase 15:
- Update `docs/specs/federated-search.md` to:
  - accept `workspaceId` (preferred) and allowlisted `workspacePath`
  - default to redacting absolute paths (only include when debug.includePaths=true)
  - record cohort choices without leaking paths

Additional docs that MUST be updated if Phase 15 adds new behavior or config:
- `docs/config/schema.json` + `docs/config/contract.md` (if new config flags are added)
- `docs/guides/commands.md` (workspace/federation CLI flags)

### 15.1 Workspace configuration, repo identity, and repo-set IDs

> **Authoritative spec:** `docs/specs/workspace-config.md`

- [x] Implement a strict workspace configuration loader (JSONC-first).
  - [x] Recommended convention: `.pairofcleats-workspace.jsonc`.
  - [x] Parsing MUST use `src/shared/jsonc.js` (`readJsoncFile` / `parseJsoncText`).
  - [x] Root MUST be an object; unknown keys MUST hard-fail at all object levels.
  - [x] Loader errors must be structured and actionable (`path`, `field`, `reason`, `hint`).

- [x] Resolve and canonicalize every repo entry deterministically.
  - [x] Resolve `root`:
    - [x] absolute paths allowed
    - [x] relative paths resolved from `workspaceDir`
    - [x] schemaVersion=1: do not accept registry/catalog ids
  - [x] Resolve to a repo root (not a subdir): `repoRootResolved = resolveRepoRoot(rootAbs)`.
  - [x] Canonicalize identity root: `repoRootCanonical = toRealPath(repoRootResolved)`; normalize win32 casing.
  - [x] Compute `repoId = getRepoId(repoRootCanonical)`.

- [x] Normalize metadata deterministically.
  - [x] `alias`: trim; empty -> null; uniqueness is case-insensitive.
  - [x] `tags`: trim -> lowercase -> drop empties -> dedupe -> sort.
  - [x] `enabled`: boolean (default from `defaults.enabled`, else true).
  - [x] `priority`: integer (default from `defaults.priority`, else 0).

- [x] Enforce uniqueness constraints (fail fast, actionable errors).
  - [x] No duplicate `repoRootCanonical`.
  - [x] No duplicate `repoId`.
  - [x] No duplicate alias (case-insensitive).

- [x] Introduce stable workspace membership identity: `repoSetId`.
  - [x] Compute per spec (order-independent, excludes display fields):
    - [x] sorted list of `{ repoId, repoRootCanonical }`
    - [x] `repoSetId = "ws1-" + sha1(stableStringify({ v:1, schemaVersion:1, repos:[...] }))`
  - [x] `repoSetId` is used for:
    - [x] workspace manifest pathing (15.2)
    - [x] federated query cache directory naming (15.5)

- [x] Centralize identity/canonicalization helpers across all callers.
  - [x] Any cache key that includes a repo path MUST use `repoRootCanonical`.
  - [x] API server routing (`tools/api/router.js`), MCP repo resolution (`tools/mcp/repo.js`), CLI, and workspace loader MUST share the same canonicalization semantics.
  - [x] Add one integration-level helper entrypoint and ban local reimplementation of repo canonicalization in callers.
  - [x] Add win32-only canonicalization tests for mixed-case paths pointing to same repo root.

**Touchpoints:**
- `tools/dict-utils/paths/repo.js` (canonicalization, `getRepoId`, build pointer helpers)
- `tools/shared/dict-utils.js` (shared exports for CLI/API/MCP)
- `src/shared/jsonc.js`, `src/shared/stable-json.js`, `src/shared/hash.js`
- New (preferred): `src/workspace/config.js`

**Tests**
- [x] `tests/workspace/config-parsing.test.js`
- [x] `tests/workspace/repo-set-id-determinism.test.js`
- [x] `tests/workspace/repo-canonicalization-dedup.test.js`
- [x] `tests/workspace/alias-uniqueness-and-tags-normalization.test.js`

---

### 15.2 Workspace manifest (index discovery) + workspace-aware build orchestration

> **Authoritative spec:** `docs/specs/workspace-manifest.md`

- [x] Implement deterministic workspace manifest generation (schemaVersion = 1).
  - [x] Resolve `federationCacheRoot` per spec:
    - workspace `cacheRoot` (resolved absolute or relative to `workspaceDir`) else `getCacheRoot()`.
  - [x] Write atomically to:
    - `<federationCacheRoot>/federation/<repoSetId>/workspace_manifest.json`.
  - [x] Serialize with `stableStringify` so the file is byte-stable for unchanged state.

- [x] Populate manifest entries per repo (sorted by `repoId`).
  - [x] Resolve per-repo config and compute `repoCacheRoot`.
  - [x] Read build pointer: `<repoCacheRoot>/builds/current.json`.
    - [x] invalid/unreadable JSON MUST be treated as missing pointer (do not preserve stale values).
  - [x] For each mode in `{code, prose, extracted-prose, records}`:
    - [x] derive `indexDir` from the build roots
    - [x] compute `indexSignatureHash` as `is1-` + sha1(buildIndexSignature(indexDir))
    - [x] read `cohortKey` (preferred) and `compatibilityKey` (fallback) from `<indexDir>/index_state.json` (warn if both missing)
  - [x] Resolve sqlite artifacts and compute file signatures (`size:mtimeMs`) per spec.
  - [x] Persist per-mode availability reason codes:
    - [x] `present`
    - [x] `missing-index-dir`
    - [x] `missing-required-artifacts`
    - [x] `invalid-pointer`
    - [x] `compat-key-missing`

- [x] Compute and persist `manifestHash` (`wm1-...`) exactly per spec.
  - [x] MUST change for search-relevant state changes (build pointer, index signature, sqlite changes, compatibilityKey/cohortKey).
  - [x] MUST NOT change for display-only edits (alias/tags/enabled/priority/name).

- [x] CLI ergonomics: add explicit manifest commands.
  - [x] `pairofcleats workspace manifest --workspace <path>` (generate/refresh and print path + hashes)
  - [x] `pairofcleats workspace status --workspace <path>` (human-readable per-repo/mode availability)

- [x] Workspace-aware build orchestration (multi-repo indexing).
  - [x] Add a workspace build entrypoint:
    - [x] either `pairofcleats index build --workspace <path> ...`
    - [x] or `pairofcleats workspace build ...`
  - [x] Requirements:
    - [x] each repo’s `.pairofcleats.json` is applied (repo-local cache roots, ignore rules, etc.)
    - [x] workspace config v1 supplies no per-repo build overrides
    - [x] concurrency-limited repo builds (avoid “N repos × M threads” explosion)
  - [x] Post-step: regenerate workspace manifest and emit `repoSetId` + `manifestHash`.
  - [x] Build fanout failure policy is deterministic:
    - [x] Continue other repos when one repo build fails unless strict mode is enabled.
    - [x] Persist structured build diagnostics in manifest generation output.

- [x] Optional debug tooling: cache inspection (“catalog”) commands.
  - [x] If implemented, treat as debug tooling only; do not make federation correctness depend on scanning `<cacheRoot>/repos/*`.

**Touchpoints:**
- `tools/shared/dict-utils.js` (cache roots, build pointer resolution, sqlite path helpers)
- `src/retrieval/index-cache.js` (`buildIndexSignature`)
- New (preferred): `src/workspace/manifest.js`

**Tests**
- [x] `tests/workspace/manifest-determinism.test.js`
- [x] `tests/workspace/manifest-hash-invalidation.test.js`
- [x] `tests/workspace/build-pointer-invalid-treated-missing.test.js`
- [x] `tests/workspace/index-signature-sharded-variants.test.js`

---

### 15.3 Federated search orchestration (CLI, API server, MCP)

> **Authoritative spec:** `docs/specs/federated-search.md`

- [x] CLI: implement federated mode for search.
  - [x] `pairofcleats search --workspace <workspaceFile> "<query>" [searchFlags...] [workspaceFlags...]`
  - [x] Workspace flags (per spec): `--select`, `--tag`, `--repo-filter`, `--include-disabled`, `--merge`, `--top-per-repo`, `--concurrency`
  - [x] Forbidden combinations (per spec): if `--workspace` is present, `--repo` MUST error (`ERR_FEDERATED_REPO_FLAG_NOT_ALLOWED`).

- [x] Implement a single federation coordinator used by CLI/API/MCP.
  - [x] Load workspace config (15.1) and manifest (15.2).
  - [x] Apply deterministic selection rules.
  - [x] Apply cohort gating hook (15.4).
  - [x] Derive `perRepoTop` and rewrite per-repo args.
  - [x] Fanout per-repo searches with bounded concurrency; reuse `indexCache` and `sqliteCache`.
  - [x] Merge per-mode results with RRF and deterministic tie-breakers.
  - [x] Emit federated response with stable serialization (`stableStringify`) and required meta fields.
  - [x] Define and implement partial-failure policy:
    - [x] Default: return successful repos + diagnostics for failed repos.
    - [x] Strict: fail request if any selected repo fails.
    - [x] Deterministic diagnostics ordering by `repoId`.

- [x] Output invariants (multi-repo unambiguity).
  - [x] Every hit MUST include `repoId`, `repoAlias`, and `globalId = "${repoId}:${hit.id}"`.
  - [x] Results must remain unambiguous even when `relPath` collides across repos.

- [x] API server: add `POST /search/federated` (recommended by spec).
  - [x] Enforce repo-root allowlist checks for every repo in the request.
  - [x] Apply workspacePath allowlisting and prefer workspaceId mapping.
  - [x] Default to redacting absolute paths unless `debug.includePaths=true`.

- [x] MCP: add federated tool(s).
  - [x] Implement `search_workspace` tool with inputs matching the API request.
  - [x] Ensure output includes repo attribution and is stable JSON.

**Touchpoints:**
- `bin/pairofcleats.js` (CLI)
- `src/retrieval/cli.js`, `src/retrieval/cli-args.js`
- `src/integrations/core/index.js`
- `tools/api/router.js`
- `tools/mcp/server.js` / `tools/mcp/repo.js`
- New (per spec): `src/retrieval/federation/coordinator.js`
- New (per spec): `src/retrieval/federation/select.js`
- New (per spec): `src/retrieval/federation/merge.js`
- New (per spec): `src/retrieval/federation/args.js`

**Tests**
- [x] `tests/retrieval/federation/search-multi-repo-basic.test.js`
- [x] `tests/retrieval/federation/search-determinism.test.js` (byte-identical JSON)
- [x] `tests/retrieval/federation/repo-selection.test.js`
- [x] `tests/services/api/federated-search-workspace-allowlist.test.js`
- [x] `tests/services/api/federated-search-redacts-paths.test.js`

---

### 15.4 Compatibility gating (cohorts) + safe federation defaults

> **Authoritative contract:** `docs/contracts/compatibility-key.md`
> **Authoritative spec:** `docs/specs/federation-cohorts.md`

- [x] Do not duplicate compatibility key computation.
  - [x] Continue computing `compatibilityKey` at index time via `buildCompatibilityKey`.
  - [x] Ensure it is persisted to `index_state.json` (and `pieces/manifest.json` where relevant).

- [x] Add a federation-specific `cohortKey` (mode-scoped) and persist it.
  - [x] Compute `cohortKey` per mode from the same input family as `compatibilityKey`, but scoped so it does not change merely because other modes were built.
  - [x] Persist `cohortKey` into `<indexDir>/index_state.json` alongside `compatibilityKey`.
  - [x] Back-compat: if `cohortKey` is absent, federation uses `compatibilityKey`.
  - [x] Update workspace manifest generation (15.2) to read `cohortKey` and include it per mode.

- [x] Implement cohort partitioning in the federation coordinator (per mode).
  - [x] Partition repos by `effectiveKey = cohortKey ?? compatibilityKey ?? null`.
  - [x] Default policy: choose highest-ranked cohort, exclude others, emit `WARN_FEDERATED_MULTI_COHORT`.
  - [x] Ranking must be deterministic and documented:
    - [x] prefer cohort with most repos
    - [x] tie-break by highest total priority
    - [x] final tie-break by lexical cohort key
  - [x] Strict policy: error on multi-cohort (`ERR_FEDERATED_MULTI_COHORT`).
  - [x] Explicit selection: `--cohort <key>` or `--cohort <mode>:<key>`.
  - [x] Unsafe mixing: `--allow-unsafe-mix` with loud warning `WARN_FEDERATED_UNSAFE_MIXING`.

- [x] Update `docs/specs/workspace-manifest.md` and `docs/specs/federated-search.md` to reflect cohortKey (fallback to compatibilityKey).

**Touchpoints:**
- `src/contracts/compatibility.js`
- `src/integrations/core/build-index/compatibility.js`
- `src/index/build/indexer/steps/write.js` (index_state write)
- `src/retrieval/federation/coordinator.js`
- `src/workspace/manifest.js`

**Tests**
- [x] `tests/retrieval/federation/compat-cohort-defaults.test.js`
- [x] `tests/retrieval/federation/compat-cohort-determinism.test.js`
- [x] `tests/retrieval/federation/compat-cohort-explicit-selection.test.js`

---

### 15.5 Federated query caching + cache-key correctness + multi-repo bug fixes

> **Authoritative spec:** `docs/specs/federated-query-cache.md`

- [x] Introduce federated query cache storage under `federationCacheRoot`.
  - [x] Location MUST be: `<federationCacheRoot>/federation/<repoSetId>/queryCache.json`.
  - [x] Writes MUST be atomic; tolerate concurrent readers and avoid file corruption.
  - [x] Eviction MUST be deterministic.

- [x] Cache keying MUST be complete and stable.
  - [x] Cache key MUST include (directly or via `manifestHash`):
    - [x] `repoSetId`
    - [x] `manifestHash` (primary invalidator)
    - [x] normalized selection (selected repo ids, includeDisabled, tags, repoFilter, explicit selects)
    - [x] cohort decision inputs/outputs
    - [x] normalized search request knobs that affect output (query, modes, filters, backend choices, ranking knobs)
    - [x] effective runtime choices that affect output (resolved ANN backend, fallback backend, compatibility gating outcome, per-mode backend overrides)
    - [x] merge strategy and limits (`top`, `perRepoTop`, `rrfK`, concurrency)
  - [x] Key payload serialization MUST use `stableStringify`.

- [x] Stop duplicating or weakening index signature logic.
  - [x] For federation invalidation, prefer `manifestHash` rather than ad hoc per-repo signatures.
  - [x] For per-repo cache invalidation, use `buildIndexSignature` (not bespoke partial signatures).

- [x] Canonicalize repo-path keyed caches everywhere federation touches.
  - [x] API server repo cache keys MUST use `repoRootCanonical`.
  - [x] MCP repo cache keys MUST canonicalize subdir inputs to the repo root.
  - [x] If `builds/current.json` is invalid JSON, clear build id and caches rather than keeping stale state.

**Touchpoints:**
- `src/retrieval/index-cache.js`
- `src/shared/artifact-io.js`
- `src/retrieval/query-cache.js`
- `tools/api/router.js`
- `tools/mcp/repo.js`
- `tools/shared/dict-utils.js`

**Tests**
- [x] `tests/retrieval/federation/query-cache-key-stability.test.js`
- [x] `tests/retrieval/federation/query-cache-invalidation-via-manifesthash.test.js`
- [x] `tests/retrieval/federation/mcp-repo-canonicalization.test.js`
- [x] `tests/retrieval/federation/build-pointer-invalid-clears-cache.test.js`

---

### 15.6 Shared caches, CAS, GC, and scale-out ergonomics

> **Authoritative spec:** `docs/specs/cache-cas-gc.md`

- [x] Make cache layers explicit and document them.
  - [x] Global caches (models, tooling assets, dictionaries/wordlists)
  - [x] Repo-scoped caches (index builds, sqlite artifacts)
  - [x] Workspace-scoped caches (workspace manifest, federated query cache)

- [x] (Design first) Introduce content-addressed storage (CAS) for expensive derived artifacts.
  - [x] Define object identity (hashing), layout, and reference tracking.
  - [x] Ensure deterministic, safe reuse across repos and workspaces.
  - [x] Define and implement a design gate before rollout:
    - [x] lease model for in-use objects
    - [x] mark-and-sweep reachability rules
    - [x] deletion safety conditions under concurrent index/search workloads
    - [x] recovery plan when GC is interrupted mid-run

- [x] Implement a manifest-driven GC tool.
  - [x] `pairofcleats cache gc --dry-run`
  - [x] Preserve any objects reachable from active manifests/snapshots; delete unreferenced objects deterministically.
  - [x] Be safe under concurrency (do not delete objects currently in use).

- [x] Scale-out controls.
  - [x] Concurrency limits for multi-repo indexing and federated fanout search.
  - [x] Memory remains bounded under “N repos × large query” workloads.

**Touchpoints:**
- `src/shared/cache.js`
- `tools/index/cache-gc.js`
- `tools/shared/dict-utils.js`
- `docs/guides/commands.md`

**Tests**
- [x] `tests/indexing/cache/workspace-global-cache-reuse.test.js`
- [x] `tests/indexing/cache/cas-reuse-across-repos.test.js`
- [x] `tests/tooling/cache/cache-gc-preserves-manifest-referenced.test.js`
- [x] `tests/indexing/cache/workspace-concurrency-limits.test.js`

---

### 15.7 Index stats reporter (single-shot + JSON)

> **Authoritative spec:** `docs/specs/index-stats.md`

- [x] Add a dedicated index stats reporter tool.
  - [x] CLI entrypoint: `pairofcleats index stats` (or `node tools/index/stats.js`).
  - [x] Input: `--repo <path>` or `--index-dir <path>`, optional `--mode`.
  - [x] Output: human summary + `--json` for structured output.
  - [x] Must use `pieces/manifest.json` as the source of truth (manifest-first).
  - [x] Prefer extending `tools/index/report-artifacts.js` when feasible; create `tools/index/stats.js` only if dedicated UX/contract separation is required.

- [x] Report per-mode artifact stats with counts + bytes.
  - [x] `chunk_meta` total rows, parts count, bytes per part.
  - [x] `token_postings`, `phrase_ngrams`, `chargram_postings` counts + bytes.
  - [x] `symbols`, `symbol_occurrences`, `symbol_edges` counts + bytes.
  - [x] `graph_relations` rows + bytes; `call_sites` rows + bytes.
  - [x] embeddings (dense vectors, hnsw, lancedb): count + bytes where present.

- [x] Report index-level summary.
  - [x] Total chunk count (per mode + aggregate).
  - [x] Total file count (from `file_meta` or manifest counts).
  - [x] Manifest compatibility key + build id + artifact surface version.
  - [x] Size totals by artifact family (chunks, postings, symbols, relations, embeddings).

- [x] Add a lightweight “missing/invalid” validator mode.
  - [x] `--verify` checks required artifacts exist and sizes match manifest.
  - [x] Warn on missing or mismatched checksum/bytes.

**Touchpoints:**
- `tools/index/report-artifacts.js` (extend existing artifact reporting surface)
- `tools/index/stats.js` (new, optional if split command is chosen)
- `tools/shared/dict-utils.js` (index root resolution)
- `src/shared/artifact-io/manifest.js` (manifest parsing helpers)
- `src/integrations/core/status.js` (optional reuse)

**Tests**
- [x] `tests/tooling/index-stats/index-stats-json.test.js`
- [x] `tests/tooling/index-stats/index-stats-missing-artifact.test.js`
- [x] `tests/tooling/index-stats/index-stats-aggregate.test.js`

### Phase 14 + 15 cross-cutting hardening tests (mandatory)
- [x] `tests/services/snapshots/concurrent-registry-writers.test.js`
  - [x] Two writers contend on snapshot/diff manifests; verify lock behavior and readable artifacts after forced interruption.
- [x] `tests/shared/json-stream/atomic-stale-backup-protection.test.js`
  - [x] Stale backup/temp-missing scenarios must fail safely (no false success, no stale artifact acceptance).
  - 2026-02-11T23:27:26.9329303-05:00 attempt 1: merged stale-backup and restore scenarios reused one backup path and failed cleanup assertion.
  - 2026-02-11T23:27:26.9329303-05:00 attempt 2: isolated second scenario onto a dedicated final/backup path; test passed.
- [x] `tests/services/embeddings/mode-root-divergence-maintenance.test.js`
  - [x] Per-mode root divergence updates build-state and sqlite maintenance against the correct mode roots.
  - 2026-02-11T23:27:26.9329303-05:00 attempt 1: strict callsite regex mismatched multiline argument formatting.
  - 2026-02-11T23:27:26.9329303-05:00 attempt 2: relaxed multiline regex to assert required fields irrespective of intermediate formatting; test passed.
- [x] `tests/services/indexing/compressed-artifact-presence.test.js`
  - [x] Presence checks accept valid compressed shard and compressed JSONL artifact forms.
- [x] `tests/workspace/windows-path-canonicalization-contract.test.js`
  - [x] Mixed-case path variants resolve to a single canonical repo identity and stable cache keys.
  - 2026-02-11T23:27:26.9329303-05:00 attempt 1: duplicate-path assertion expected outdated error text.
  - 2026-02-11T23:27:26.9329303-05:00 attempt 2: updated assertion to `Duplicate canonical repo root`; test passed.
- [x] `tests/retrieval/federation/explicit-root-no-fallback.test.js`
  - [x] Explicit refs fail fast when artifacts are missing; no fallback to current/latest.
  - 2026-02-11T23:27:26.9329303-05:00 attempt 1: fixture-driven federated CLI variant exceeded 30s (cancelled per test policy).
  - 2026-02-11T23:27:26.9329303-05:00 attempt 2: switched to fast `resolveIndexRef` explicit snapshot-root contract plus latest fallback check; test passed.

---

### Wave 2: Retrieval correctness and profile specialization
14. Phase 16.1
15. Phase 16.2
16. Phase 16.3
17. Phase 16.4
18. Phase 16.5
19. Phase 16.6
20. Phase 16.7
21. Phase 16.8
22. Phase 17.1
23. Phase 17.2
24. Phase 17.3
25. Phase 17.4 (optional stretch)

Why this order:
- Phase 16 provides correctness and routing behavior that Phase 17 depends on.
- Phase 17 then codifies strict vector-only behavior on top of stable retrieval/build contracts.

### Wave 3: Lexicon enrichment before UI orchestration
26. Phase 19.0
27. Phase 19.1
28. Phase 19.2
29. Phase 19.4
30. Phase 19.3
31. Phase 19.5

Why before Phase 20:
- If TUI/explain surfaces include lexicon signals, Phase 19 should stabilize output contracts first.

### Wave 4: Supervisor and TUI
32. Phase 20.0.2 + 20.1.1 + 20.1.2 + 20.1.3 + 20.0.7
33. Phase 20.0.3 + 20.0.4 + 20.0.5 + 20.0.6
34. Phase 20.2.1
35. Phase 20.2.2
36. Phase 20.2.3
37. Phase 20.2.4
38. Phase 20.3.1
39. Phase 20.3.2
40. Phase 20.3.3
41. Phase 20.4.1-20.4.3
42. Phase 20.5.1
43. Phase 20.5.2

Why:
- This follows the built-in dependency matrix in Phase 20 and avoids rework from protocol/dispatcher drift.

### Wave 5: Distribution hardening and release closure
44. Phase 18.1
45. Phase 18.2
46. Phase 18.3
47. Phase 18.4
48. Phase 18.5
49. Phase 18.6

Why at the end:
- Phase 18 should package and harden the final integrated system, including any TUI binaries and finalized behavior.

### Wave 6: Intelligence and operational excellence
50. Track IQ.1 query-intent policy engine (routing/ranking policy by intent class)
51. Track IQ.2 multi-hop graph expansion with bounded novelty-aware reranking
52. Track IQ.3 task-pack assembly mode (entrypoint + call chain + tests + config/docs)
53. Track IQ.4 trust/confidence scoring and explain confidence surfaces
54. Track IQ.5 retrieval quality replay suite from real-world query logs
55. Track OP.1 search/index SLO contracts (latency, success rate, determinism, cache hit-rate)
56. Track OP.2 failure-aware degradation policy and backend failover contracts
57. Track OP.3 fault injection and chaos tests for index/search/service/supervisor paths
58. Track OP.4 adaptive provider orchestration and auto-tuning with hard safety bounds
59. Track OP.5 release gates that block on quality/perf/reliability budgets

Why this wave:
- It turns the platform from “feature-complete index/search tooling” into a durable codebase intelligence engine with measurable quality and reliability guarantees.

